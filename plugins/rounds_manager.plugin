from base_plugin import BasePlugin, MethodHook, MethodReplacement
from android_utils import log, run_on_ui_thread, R
from java import jclass, jint
from java.lang import Long, Boolean, Integer, String as JString
from hook_utils import *
from android_utils import log
from ui.settings import Header, Input, Divider, Switch, Selector, Text
from ui.bulletin import BulletinHelper
from client_utils import get_last_fragment
import debugpy

#debugpy.wait_for_client()
__id__ = "rounds_manager"
__name__ = "Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¾Ñ€ ĞºÑ€ÑƒĞ¶ĞºĞ¾Ğ²"
__description__ = "ĞŸĞ¾Ğ·Ğ²Ğ¾Ğ»ÑĞµÑ‚ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ĞºÑ€ÑƒĞ¶Ğ¾Ğº Ğ¿ĞµÑ€ĞµĞ´ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¾Ğ¹, Ñ‚Ğ°ĞºĞ¶Ğµ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµÑ‚ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ğ¿Ğ¾ Ñ‚Ğ¸Ğ¿Ñƒ Ğ¾Ñ‚ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğ±Ğ»ÑÑ€Ğ° Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸"
__author__ = "@timofey776"
__version__ = "2.4.0"
__min_version__ = "11.11.0"
__icon__ = "Mithay/117"


timing = 650
pause = False
afterEdit = False
class StopRecordingHook(MethodHook): #MethodHook        #MethodReplacement
    
    def __init__(self, plugin_instance):
        super().__init__()
        self.plugin = plugin_instance
    
    def before_hooked_method(self, param):  #replace_hooked_method
        global saved_photo_layout
        global timing
        global pause
        global afterEdit
        #log(param.args)
        if not pause and self.plugin.get_setting("Pause",False):
            log("not paused, skip")
            return
        pause = False
        if not self.plugin.get_setting("Editor",True):
            log("2")
            return

        if not param.args[0].videoEditedInfo.roundVideo or afterEdit:   # param.args[0].videoEditedInfo.notReadyYet
            log("1")
            afterEdit = False
            return
        #----------------------------------------------------------------
        #                   Ğ·Ğ°Ğ¿ÑƒÑĞº Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¾Ñ€Ğ°
        def openVd():
            chatAct = find_class("org.telegram.ui.ChatActivity")
            method = chatAct.getClass().getDeclaredMethod("openVideoEditor",JString,JString)
            method.setAccessible(True)
            method.invoke(get_last_fragment(),param.args[0].path, None)
        def CloseAnim():
            chatAct = find_class("org.telegram.ui.ChatActivity")
            method = chatAct.getClass().getDeclaredMethod("runCloseInstantCameraAnimation")
            method.setAccessible(True)
            method.invoke(get_last_fragment())
        
        
        try:
            runnbl = R(openVd)
            closeR = R(CloseAnim)
            log(timing)
            run_on_ui_thread(runnbl, timing)
            run_on_ui_thread(closeR,10)
            #x = method.invoke(get_last_fragment(),param.args[0].path, None) #ğŸ‘ˆ "" - ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ´ Ğ²Ğ¸Ğ´ĞµĞ¾ Ğ² Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¾Ñ€Ğµ
            #log("barebuh")
        except Exception as e:
            log(f"âŒ: {e}")
    
        #log(param.args[0])
        param.setResult(None)
        
#â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
class BlurOff(MethodHook):
    def __init__(self, plugin_instance):
        super().__init__()
        self.plugin = plugin_instance
    
    def before_hooked_method(self, param):
        #log(param)
        try:
            run_on_ui_thread(lambda:set_private_field(param.thisObject,"drawBlur",not self.plugin.get_setting("Blur",True)))
        except Exception as e:
            self.plugin.log(f"be: {e}")
    def after_hooked_method(self, param):
        try:
            run_on_ui_thread(lambda:set_private_field(param.thisObject,"drawBlur",not self.plugin.get_setting("Blur",True)))
            
        except Exception as e:
            self.plugin.log(f"be: {e}")
#â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
class sendMediaHook(MethodHook):
    
    def __init__(self, plugin_instance):
        super().__init__()
        self.plugin = plugin_instance
    
    def before_hooked_method(self, param):
        
        try:
            global afterEdit
            log("PHOTO ENTRY")
            #log(param.args[0])
            #log("VIDEO EDITED INFO")
            #log(param.args[1])
            #instCamObj = get_private_field(param.thisObject,"instantCameraView")
            #isPause = not get_private_field(instCamObj, "recording")
            #log(isPause)
            #pause = False
            #ğŸ‘† Ğ¸Ğ·Ğ·Ğ° Ğ»Ğ¾Ğ³Ğ¾Ğ² Ñ‚Ğ³ ĞºÑ€Ğ°ÑˆĞ¸Ñ‚ÑÑ Ğ¿Ñ€Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞµ Ğ²Ğ¸Ğ´ĞµĞ¾ ÑĞ¾ ÑÑ‚Ğ¸ĞºĞµÑ€Ğ°Ğ¼Ğ¸
            log(f"sendMedia, afteredit: {afterEdit}")
            if not param.args[1].roundVideo and not self.plugin.get_setting("rndVideo",False) and not afterEdit:      
                afterEdit = True
                param.args[1].roundVideo = True
                param.args[0].editedInfo.roundVideo = True
            else:
                afterEdit = False
        except Exception as e:
            self.plugin.log(f"be: {e}")
 #â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

class togglePaus(MethodHook):
    def __init__(self, plugin_instance):
        super().__init__()
        self.plugin = plugin_instance
    def before_hooked_method(self, param):
        global pause
        pause = get_private_field(param.thisObject, "recording")
        log(f"isPause: {pause}")


#â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
#                                   ĞŸĞ›ĞĞ“Ğ˜Ğ
class Plugin(BasePlugin):
    
    def __init__(self):
        super().__init__()
        self.hook_handler = None

    #---------------------------------------------------------------------------------
    #                              ĞĞĞ¡Ğ¢Ğ ĞĞ™ĞšĞ˜

    def create_settings(self):
        def changeTiming(t: str):
            global timing
            timing = int(t)
            self.on_plugin_load()
        return [
            Header(text="ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸"),
            Switch(text="ĞÑ‚ĞºÑ€Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¾Ñ€ Ğ¿Ğ¾ÑĞ»Ğµ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸",key="Editor",default=True,icon="media_button_restore"),
            Switch(text="ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑÑ‚ÑŒ ĞºÑ€ÑƒĞ¶Ğ¾Ğº ĞºĞ°Ğº Ğ²Ğ¸Ğ´ĞµĞ¾",key="rndVideo",default=False,icon="msg_photos"),
            Switch(text="ĞÑ‚ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ Ğ±Ğ»ÑÑ€ Ñ„Ğ¾Ğ½Ğ°",key="Blur",default=True,icon="msg_spoiler"),
            Switch(text="ĞÑ‚ĞºÑ€Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¾Ñ€ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾",subtext="Ğ¿Ñ€Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞµ Ğ¸Ğ· Ğ¿Ğ°ÑƒĞ·Ñ‹",key="Pause",default=False,icon="ic_pauseinline"),
            Input(key="timing",text="Ñ‡ĞµÑ€ĞµĞ· ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¼Ñ Ğ¾Ñ‚ĞºÑ€Ğ¾ĞµÑ‚ÑÑ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¾Ñ€",default="650",icon="menu_views_recent",subtext="Ğ½Ğ¸Ğ·ĞºĞ¸Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ Ğ¼Ğ¾Ğ³ÑƒÑ‚ Ğ¿Ñ€Ğ¸Ğ²ĞµÑÑ‚Ğ¸ Ğº Ğ¾ÑˆĞ¸Ğ±ĞºĞ°Ğ¼",on_change=changeTiming),
            Divider()
        ]


    def on_plugin_load(self):
        global timing
        timing = int(self.get_setting("timing","650"))
        #debugpy.listen(("127.0.0.1", 5678))
        #
        #debugpy.wait_for_client()
        chatAct = find_class("org.telegram.ui.ChatActivity")   
        SendMessagesHelper = find_class("org.telegram.messenger.SendMessagesHelper")
        SendMessagesHelperParams = find_class("org.telegram.messenger.SendMessagesHelper$SendMessageParams")
        sendMessage = SendMessagesHelper.getClass().getDeclaredMethod("sendMessage",SendMessagesHelperParams) 
        self.hook_method(sendMessage, StopRecordingHook(self))

        #---------------------------------------------------------------------------------
        #                          Ğ¥Ğ£Ğš SendMedia Ğ¿Ğ¾ÑĞ»Ğµ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¾Ñ€Ğ°
        PhotoEntry = find_class("org.telegram.messenger.MediaController$PhotoEntry")
        VideoEditedInfo = find_class("org.telegram.messenger.VideoEditedInfo")
        sendMedia = chatAct.getClass().getDeclaredMethod("sendMedia",PhotoEntry,VideoEditedInfo,Boolean.TYPE,Integer.TYPE,Boolean.TYPE,Long.TYPE)
        self.hook_method(sendMedia, sendMediaHook(self))

        Context = find_class("android.content.Context")
        Delegate = find_class("org.telegram.ui.Components.InstantCameraView$Delegate")
        ResourcesProvider = find_class("org.telegram.ui.ActionBar.Theme$ResourcesProvider")
        try:
            inst = find_class("org.telegram.ui.Components.InstantCameraView").getClass()
            instanCamConstr = inst.getDeclaredConstructor(Context,Delegate,ResourcesProvider)
            instanCamConstr.setAccessible(True)
            self.hook_method(instanCamConstr,BlurOff(self))

            isPaused = inst.getDeclaredMethod("togglePause")
            self.hook_method(isPaused,togglePaus(self))
            
        except Exception as e:
          log(f"nfo: {e}")



        
    
#â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

    def on_plugin_unload(self):
        try:
            self.hook_handler = None
        except Exception as e:
            self.log(f"âŒ: {e}")
    

    def log(self, message):
        log(f"[RoundEditor] {message}")
