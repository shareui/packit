"""     
                        ИНФОРМАЦИЯ:

Привет! Если хочешь взять решения из моего плагина, пожалуйста, отметь меня @mr_Vestr.



            ⣿⣿⣿⣿⣯⣿⣿⠄⢠⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡟⠈⣿⣿⣿⣿⣿⣿⣆⠄
            ⢻⣿⣿⣿⣾⣿⢿⣢⣞⣿⣿⣿⣿⣷⣶⣿⣯⣟⣿⢿⡇⢃⢻⣿⣿⣿⣿⣿⢿⡄
            ⠄⢿⣿⣯⣏⣿⣿⣿⡟⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣷⣧⣾⢿⣮⣿⣿⣿⣿⣾⣷
            ⠄⣈⣽⢾⣿⣿⣿⣟⣄⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣷⣝⣯⢿⣿⣿⣿⣿
            ⣿⠟⣫⢸⣿⢿⣿⣾⣿⢿⣿⣿⢻⣿⣿⣿⢿⣿⣿⣿⢸⣿⣼⣿⣿⣿⣿⣿⣿⣿
            ⡟⢸⣟⢸⣿⠸⣷⣝⢻⠘⣿⣿⢸⢿⣿⣿⠄⣿⣿⣿⡆⢿⣿⣼⣿⣿⣿⣿⢹⣿
            ⡇⣿⡿⣿⣿⢟⠛⠛⠿⡢⢻⣿⣾⣞⣿⡏⠖⢸⣿⢣⣷⡸⣇⣿⣿⣿⢼⡿⣿⣿
            ⣡⢿⡷⣿⣿⣾⣿⣷⣶⣮⣄⣿⣏⣸⣻⣃⠭⠄⠛⠙⠛⠳⠋⣿⣿⣇⠙⣿⢸⣿
            ⠫⣿⣧⣿⣿⣿⣿⣿⣿⣿⣿⣿⠻⣿⣾⣿⣿⣿⣿⣿⣿⣿⣷⣿⣿⣹⢷⣿⡼⠋
            ⠄⠸⣿⣿⣿⣿⣿⣿⣿⣿⣿⣷⣦⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡟⣿⣿⣿⠄⠄
            ⠄⠄⢻⢹⣿⠸⣿⣿⣿⣿⣿⣷⣿⣿⣿⣿⣿⣿⣿⣿⣿⡿⣼⣿⣿⣿⣿⡟⠄⠄
            ⠄⠄⠈⢸⣿⠄⠙⢿⣿⣿⣹⣿⣿⣿⣿⣟⡃⣽⣿⣿⡟⠁⣿⣿⢻⣿⣿⢿⠄⠄
            ⠄⠄⠄⠘⣿⡄⠄⠄⠙⢿⣿⣿⣾⣿⣷⣿⣿⣿⠟⠁⠄⠄⣿⣿⣾⣿⡟⣿⠄⠄
            ⠄⠄⠄⠄⢻⡇⠸⣆⠄⠄⠈⠻⣿⡿⠿⠛⠉⠄⠄⠄⠄⢸⣿⣇⣿⣿⢿⣿⠄⠄



                        INFORMATION:

Hi! If you want to borrow something from my plugin, please tag me @mr_Vestr.



"""

from base_plugin import BasePlugin, MenuItemData, MenuItemType, HookResult, HookStrategy, MethodHook
from ui.settings import Divider, Header, Input, Switch, Text
from android_utils import run_on_ui_thread
from client_utils import get_last_fragment, run_on_queue, get_send_messages_helper
from hook_utils import find_class, get_private_field, set_private_field
import urllib.parse
import urllib.request
import locale, os, re, json, threading, time, base64, weakref, copy, traceback
from markdown_utils import parse_markdown
from org.telegram.ui import DialogsActivity, LaunchActivity
from android.os import Bundle
from java import dynamic_proxy, cast, jclass
from java.util import ArrayList
from java.lang import Integer
from ui.bulletin import BulletinHelper
from org.telegram.messenger import ApplicationLoader, Utilities, AndroidUtilities, MediaDataController, ImageLocation, MessageObject
from org.telegram.ui import ChatActivity
from org.telegram.ui.ActionBar import BottomSheet, Theme, SimpleTextView
from android.view import HapticFeedbackConstants, Gravity
from org.telegram.ui.Components import BackupImageView, LayoutHelper
from android.util import TypedValue
from java.io import File
from com.exteragram.messenger.plugins.models import HeaderSetting

try:
    from android_utils import Callback
except ImportError:
    from java import dynamic_proxy
    from org.telegram.messenger import Utilities
    class Callback(dynamic_proxy(Utilities.Callback)):
        def __init__(self, fn):
            super().__init__()
            self._fn = fn
        def run(self, arg):
            self._fn(arg)

try:
    from android_utils import OnClickListener
except ImportError:
    from java import dynamic_proxy
    from android.view import View
    class OnClickListener(dynamic_proxy(View.OnClickListener)):
        def __init__(self, fn):
            super().__init__()
            self._fn = fn
        def onClick(self, v):
            self._fn(v)


__id__ = "templates"
__name__ = "Templates | Шаблоны"
__description__ = """A plugin for creating, editing, and quickly sending message templates.

Плагин для создания, редактирования и быстрой отправки шаблонов сообщений."""
__author__ = "@mr_Vestr"
__version__ = "4.0"
__min_version__ = "12.1.1"
__icon__ = "mr_vestr/7"


TEMPLATE_COUNT = 30

LANG = {
    'ru': {
        'name': 'Имя шаблона',
        'text': 'Текст шаблона',
        'edit': 'Изменить',
        'clear': 'Очистить',
        'open_settings_error': 'Не удалось открыть настройки: {error}',
        'templates': 'Шаблоны',
        'link_open_error': 'Ошибка при открытии ссылки: {error}',
        'how_it_works': 'Как это работает?',
        'how_it_works_text': '''Шаблоны — заготовленные сообщения, которые можно быстро отправлять.

Чтобы создать шаблон нужно:
1. Открыть настройки плагина Templates;
2. Включить шаблон;
3. Настроить его название и отправляемое сообщение.

Отправить шаблон можно:
1. В настройках плагина, нажав кнопку «Отправить шаблон» и выбрав нужный чат;
2. Через поле ввода сообщения в уже открытом нужном чате, прописав команду и название шаблона. Пример: «// Название»;
3. Нажав кнопку "Шаблоны" в меню чата или меню плагинов в чате.

Также вы можете использовать режим форматирования: **жирный**, __подчёркнутый__, ~~зачёркнутый~~, `моноширинный`, --курсив--, ||спойлер||.

Экспортируйте шаблоны, нажав «Экспорт шаблонов» в настройках и выбрав чат. Импортируйте через файл в чате, нажав на него и потом «Импортировать шаблоны».

Если вы хотите предложить идею для улучшения плагина, сообщить об ошибке или что-то другое, то пишите в сообщения к каналу @I_am_Vestr или мне в личные сообщения @mr_Vestr.''',
        'channel': 'Мой канал',
        'personal': 'Моя личка',
        'close': 'Закрыть',
        'delete_button': 'Удалить',
        'yes': 'Да',
        'no': 'Нет',
        'settings': 'Настройки',
        'drawer_menu': 'Кнопка в боковом меню',
        'drawer_menu_sub': 'Добавляет кнопку настроек шаблонов в боковое меню.',
        'chat_menu': 'Кнопка в меню чата',
        'chat_menu_sub': 'Добавляет кнопку настроек шаблонов в обычное меню чата.',
        'chat_plugins_menu': 'Кнопка в плагинах в чате',
        'chat_plugins_menu_sub': 'Добавляет кнопку настроек шаблонов в меню плагинов в чате.',
        'send_cmd': 'Команда отправки шаблона',
        'send_cmd_sub': 'Введите команду для отправки шаблонов.',
        'template_n': 'Шаблон №{n}',
        'template_name': 'Название шаблона',
        'template_name_sub': 'Придумайте название шаблона.',
        'template_text': 'Текст шаблона',
        'template_text_sub': 'Придумайте текст шаблона.',
        'send_template': 'Отправить шаблон',
        'delete_template': 'Удалить шаблон',
        'create_template': 'Создать шаблон',
        'contacts': 'Мои контакты',
        'channel_1': 'Мой канал — @I_am_Vestr',
        'personal_1': 'Моя личка — @mr_Vestr',
        'other': 'Другое',
        'plugin_version': 'Версия плагина — 4.0',
        'updates': 'Обновления',
        'current_version': 'Текущая версия: {version}',
        'updates_info': 'Нажмите на кнопку ниже чтобы проверить обновления. Или проверьте мой канал @I_am_Vestr.',
        'check_updates': 'Проверить',
        'edit_template': 'Редактировать шаблон {n}',
        'save': 'Сохранить',
        'cancel': 'Отмена',
        'enter_template_name': 'Чтобы отправить шаблон, напишите его название.',
        'template_sent': 'Шаблон «{name}» отправлен.',
        'template_not_found': 'Шаблон не найден! Шаблоны добавляются в настройках плагина.',
        'fill_all_fields': 'Заполните все данные, для отправки шаблона.',
        'close_menu_question': 'Хотите закрыть меню?',
        'templates_title': 'Шаблоны',
        'error_occurred': 'Произошла ошибка!',
        'support_me': 'Поддержать меня',
        'support_me_text': 'Если вы хотите меня поддержать, вы можете отправить мне подарок в Telegram или подарить Telegram Premium :)',
        'check_updates': 'Проверить обновление',
        'my_account': 'Мой аккаунт',
        'restart_error': 'Ошибка перезапуска: {error}',
        'download_error': 'Ошибка загрузки: {error}',
        'error_occurred_with_reason': 'Ошибка: {error}',
        'select_template': 'Выберите шаблон',
        'no_templates_available': 'Нет доступных шаблонов',
        'export_templates': 'Экспорт шаблонов',
        'export_question': 'Какие шаблоны экспортировать?',
        'export_sent': 'Экспорт отправлен',
        'export_error': 'Ошибка экспорта: {error}',
        'export_success': 'Успешный экспорт.',
        'import_question': 'Импортировать шаблоны из файла?',
        'import_success': 'Шаблоны импортированы.',
        'import_error': 'Ошибка импорта: {error}',
        'selected_templates': 'Выбрано',
        'select_templates': 'Выбор шаблонов',
        'select': 'Выбрать',
        'export': 'Экспортировать',
        'import': 'Импортировать',
        'apply': 'Применить',
        'template_deleted': 'Шаблон удалён.',
        'template_deleted_n': 'Удалён шаблон №{n}.',
        'template_name_cleared': 'Очищено имя шаблона №{n}.',
        'template_text_cleared': 'Очищен текст шаблона №{n}.',
        'template_created_n': 'Создан шаблон №{n}.',
        'delete_template_title': 'Удаление шаблона',
        'delete_template_confirm': 'Точно удалить шаблон №{n}?',
        'undo': 'Вернуть',
        'template_n_sent': 'Шаблон №{n} отправлен.',
        'open': 'Открыть',
        'templates_exported': 'Шаблоны экспортированы.',
        'export_file_caption': 'Экспорт шаблонов',
        'import_dialog_title': 'Импорт шаблонов',
        'fill_prev_template': 'Заполните все поля предыдущего шаблона, чтобы создать другой.',
        'clear_field_title': 'Очистка поля',
        'clear_field_name_confirm': 'Точно очистить имя шаблона №{n}?',
        'clear_field_text_confirm': 'Точно очистить текст шаблона №{n}?',
        'copy': 'Копировать',
        'link_copied': 'Ссылка скопирована',
        'copied_to_clipboard': 'Скопировано в буфер обмена',
        'error_prefix': 'Ошибка:',
        'clear_all_templates': 'Очистить все шаблоны',
        'templates_limit_exceeded': 'Количество шаблонов не может превышать 30 шт.',
        'checking_updates': 'Проверка обновления Templates...',
        'no_updates_available': 'У вас последняя версия плагина.',
        'update_check_error': 'Ошибка проверки обновлений: {error}',
        'template_name_exists': 'Такое имя шаблона уже есть. Переименуйте или он будет деактивирован.',
        'refresh_templates': 'Обновление шаблонов...',
    },
    'en': {
        'name': 'Template name',
        'text': 'Template text',
        'edit': 'Edit',
        'clear': 'Clear',
        'open_settings_error': 'Failed to open settings: {error}',
        'templates': 'Templates',
        'link_open_error': 'Error opening link: {error}',
        'how_it_works': 'How does it work?',
        'how_it_works_text': '''Templates are pre-made messages you can quickly send.

To create a template:
1. Open Templates plugin settings;
2. Enable a template;
3. Set its name and message text.

To send a template:
1. In plugin settings, press "Send template" and choose a chat;
2. In the chat input, type the command and template name. Example: "// Name";
3. By clicking the "Templates" button in the chat menu or the plugins menu in the chat.

You can also use Parse mode: **bold**, __underlined__, ~~strikethrough~~, `monotype`, --italic--, ||spoiler||.

Export templates by clicking "Export Templates" in the settings and selecting a chat. Import via a file in the chat by clicking on it and then "Import Templates".

If you want to suggest an idea, report a bug, or anything else, write to the @I_am_Vestr channel or DM @mr_Vestr.''',
        'channel': 'My channel',
        'personal': 'My DM',
        'close': 'Close',
        'delete_button': 'Delete',
        'yes': 'Yes',
        'no': 'No',
        'settings': 'Settings',
        'drawer_menu': 'Button in drawer menu',
        'drawer_menu_sub': 'Adds a template settings button to the drawer menu.',
        'chat_menu': 'Button in chat menu',
        'chat_menu_sub': 'Adds a template settings button to the regular chat menu.',
        'chat_plugins_menu': 'Button in plugins chat menu',
        'chat_plugins_menu_sub': 'Adds a template settings button to the plugins menu in chat.',
        'send_cmd': 'Template send command',
        'send_cmd_sub': 'Enter the command to send templates.',
        'template_n': 'Template #{n}',
        'template_name': 'Template name',
        'template_name_sub': 'Come up with a template name.',
        'template_text': 'Template text',
        'template_text_sub': 'Come up with template text.',
        'send_template': 'Send template',
        'delete_template': 'Delete template',
        'create_template': 'Create template',
        'contacts': 'My contacts',
        'channel_1': 'My channel — @I_am_Vestr',
        'personal_1': 'My DM — @mr_Vestr',
        'other': 'Other',
        'plugin_version': 'Plugin version — 4.0',
        'updates': 'Updates',
        'current_version': 'Current version: {version}',
        'updates_info': 'Click on the button below to check for updates. Or check out my channel @I_am_Vestr.',
        'check_updates': 'Check updates',
        'checking_updates': 'Checking updates for Templates...',
        'no_updates_available': 'You have the latest version of the plugin.',
        'update_check_error': 'Update check error: {error}',
        'edit_template': 'Edit template {n}',
        'save': 'Save',
        'cancel': 'Cancel',
        'enter_template_name': 'To send a template, enter its name.',
        'template_sent': 'Template "{name}" sent.',
        'template_not_found': 'Template not found! Add templates in plugin settings.',
        'fill_all_fields': 'Fill in all fields to send a template.',
        'close_menu_question': 'Do you want to close the menu?',
        'error_occurred': 'An error occurred!',
        'templates_title': 'Templates',
        'support_me': 'Support me',
        'support_me_text': 'If you want to support me, you can send me a gift in Telegram or gift me Telegram Premium :)',
        'check_updates': 'Check updates',
        'my_account': 'My account',
        'restart_error': 'Restart error: {error}',
        'download_error': 'Download error: {error}',
        'error_occurred_with_reason': 'Error: {error}',
        'select_template': 'Select template',
        'no_templates_available': 'No templates available',
        'export_templates': 'Export Templates',
        'export_question': 'Which templates to export?',
        'export_sent': 'Export sent',
        'export_error': 'Export error: {error}',
        'export_success': 'Export successful.',
        'import_question': 'Import templates from file?',
        'import_success': 'Templates imported.',
        'import_error': 'Import error: {error}',
        'selected_templates': 'Selected',
        'select_templates': 'Select Templates',
        'select': 'Select',
        'export': 'Export',
        'import': 'Import',
        'apply': 'Apply',
        'template_deleted': 'Template deleted.',
        'template_deleted_n': 'Template #{n} deleted.',
        'template_name_cleared': 'Template name #{n} cleared.',
        'template_text_cleared': 'Template text #{n} cleared.',
        'template_created_n': 'Template #{n} created.',
        'delete_template_title': 'Deleting template',
        'delete_template_confirm': 'Are you sure you want to delete template #{n}?',
        'undo': 'Undo',
        'template_n_sent': 'Template #{n} sent.',
        'open': 'Open',
        'templates_exported': 'Templates exported.',
        'export_file_caption': 'Export templates',
        'import_dialog_title': 'Import templates',
        'fill_prev_template': 'Fill in all fields of the previous template to create another.',
        'clear_field_title': 'Clear field',
        'clear_field_name_confirm': 'Are you sure you want to clear template name #{n}?',
        'clear_field_text_confirm': 'Are you sure you want to clear template text #{n}?',
        'copy': 'Copy',
        'link_copied': 'Link copied',
        'copied_to_clipboard': 'Copied to clipboard',
        'error_prefix': 'Error:',
        'clear_all_templates': 'Clear all templates',
        'templates_limit_exceeded': 'The number of templates cannot exceed 30.',
        'template_name_exists': 'Template name already exists. Rename it or it will be deactivated.',
        'refresh_templates': 'Refresh templates...',
    }
}

def t(key, lang='ru', **kwargs):
    return LANG[lang][key].format(**kwargs)

def preprocess_template_markdown(text):
    import re
    text = re.sub(r'--(.*?)--', r'_\1_', text)
    text = re.sub(r'~~(.*?)~~', r'~\1~', text)
    text = re.sub(r'\*\*(.*?)\*\*', r'*\1*', text)
    return text

class _LocalFileSystem:
    @classmethod
    def tempdir(cls):
        base = ApplicationLoader.applicationContext.getExternalCacheDir()
        _dir = File(base, "templates_temp_files")
        if not _dir.exists():
            _dir.mkdirs()
        return _dir

    @classmethod
    def write_temp_file(cls, filename: str, content: bytes, mode: str = "wb", delete_after: int = 0):
        import os, threading
        path = File(cls.tempdir(), filename).getAbsolutePath()
        with open(path, mode) as f:
            f.write(content)
        if delete_after > 0:
            try:
                threading.Timer(delete_after, lambda: os.path.exists(path) and os.remove(path)).start()
            except Exception:
                pass
        return path

class TemplatesPlugin(BasePlugin):
    def __init__(self):
        super().__init__()
        self.hook_refs = []
        self.update_info_cache = None
        self.last_update_check = 0
        self.menu_shown = False
        self.templates_menu_id = 880032
        self._templates_view_class_cache = {}
        self.templates_view_hook_constructor_ref = None
        self.templates_view_current_enter_view_ref = None
        self.templates_view_settings_cache = None
        self.templates_view_attached_views = set()
        self.templates_view_custom_container = None
        self.templates_view_current_settings = {}
        try:
            from org.telegram.messenger import LocaleController
            lang_code = LocaleController.getInstance().getCurrentLocale().getLanguage()
        except Exception:
            lang_code = ''
        if lang_code.lower().startswith('ru'):
            self.lang = 'ru'
        else:
            self.lang = 'en'
        if not hasattr(self, '_settings') or not self._settings:
            self.set_setting('show_chat_menu', self.get_setting('show_chat_menu', True), reload_settings=False)
            self.set_setting('show_chat_plugins_menu', self.get_setting('show_chat_plugins_menu', False), reload_settings=False)
        templates = self.get_setting("templates", None)
        self.templates = []
        for i in range(TEMPLATE_COUNT):
            tpl = templates[i] if templates and i < len(templates) else {}
            tpl = dict(tpl) if tpl else {}
            if 'enabled' not in tpl:
                tpl['enabled'] = True if i == 0 else False
            if 'name' not in tpl:
                tpl['name'] = ''
            if 'text' not in tpl:
                tpl['text'] = ''
            self.templates.append(tpl)

    def try_load_sticker(self, img, sticker_name, sticker_index=0, size="72_72"):
        try:
            if isinstance(sticker_name, str) and "/" in sticker_name:
                icon_parts = sticker_name.split("/")
                if len(icon_parts) == 2:
                    sticker_set_name = icon_parts[0]
                    sticker_index = int(icon_parts[1])
            else:
                sticker_set_name = sticker_name
            ss = MediaDataController.getInstance(0).getStickerSetByName(sticker_set_name) or MediaDataController.getInstance(0).getStickerSetByEmojiOrName(sticker_set_name)
            if ss and ss.documents and ss.documents.size() > sticker_index:
                img.setImage(ImageLocation.getForDocument(ss.documents.get(sticker_index)), size, None, None, 0, 1)
                return True
        except:
            pass
        return False

    def load_sticker_with_fallback(self, img, sticker_name, sticker_index=0, size="72_72", delay=1500):
        if not self.try_load_sticker(img, sticker_name, sticker_index, size):
            try:
                if isinstance(sticker_name, str) and "/" in sticker_name:
                    sticker_set_name = sticker_name.split("/")[0]
                else:
                    sticker_set_name = sticker_name
                    
                MediaDataController.getInstance(0).loadStickersByEmojiOrName(sticker_set_name, False, False)
                run_on_ui_thread(lambda: self.try_load_sticker(img, sticker_name, sticker_index, size), delay)
            except:
                pass

    def on_plugin_load(self):
        self.update_info_cache = None
        self.last_update_check = 0
        self.update_available = False
        self._check_for_updates_on_load_with_timeout()
        self.latest_version = None
        self.changelog = None
        self.download_url = None
        self.checking_update = False
        self.sticker_pack = None
        self.sticker_index = None
        try:
            from org.telegram.messenger import LocaleController
            lang_code = LocaleController.getInstance().getCurrentLocale().getLanguage()
        except Exception:
            lang_code = ''
        if lang_code.lower().startswith('ru'):
            self.lang = 'ru'
        else:
            self.lang = 'en'
        if not hasattr(self, '_settings') or not self._settings:
            self.set_setting('show_chat_menu', self.get_setting('show_chat_menu', True), reload_settings=False)
            self.set_setting('show_chat_plugins_menu', self.get_setting('show_chat_plugins_menu', False), reload_settings=False)
            self.set_setting('templates_visible', self.get_setting('templates_visible', True), reload_settings=False)
        self._update_drawer_menu()
        self._update_chat_menu()
        self._update_chat_plugins_menu()
        try:
            from android_utils import run_on_ui_thread
            from org.telegram.messenger import AndroidUtilities
            def update_chat_menu():
                if self.get_setting('show_chat_menu', True):
                    self._add_templates_item_to_current_chat_header()
            AndroidUtilities.runOnUIThread(lambda: run_on_ui_thread(update_chat_menu), 500)
        except Exception:
            pass
        self.add_on_send_message_hook()
        self._add_url_hook()
        self._add_input_hook()
        self._add_document_hook()
        self._hook_chat_activity_resume()
        self._force_load_stickers()
        self._setup_templates_view_search()

    def set_setting(self, key, value, reload_settings=False):
        try:
            return super().set_setting(key, value, reload_settings=reload_settings)
        except TypeError:
            try:
                return super().set_setting(key, value)
            finally:
                if reload_settings:
                    try:
                        from client_utils import get_last_fragment
                        frag = get_last_fragment()
                        try:
                            frag.rebuildAllFragments(True)
                        except Exception:
                            pass
                    except Exception:
                        pass

    def open_plugin_settings(self):
        from client_utils import get_last_fragment
        from com.exteragram.messenger.plugins import PluginsController
        from com.exteragram.messenger.plugins.ui import PluginSettingsActivity
        def _open_settings():
            try:
                fragment = get_last_fragment()
                plugin = PluginsController.getInstance().plugins.get(self.id)
                if plugin:
                    settings_activity = PluginSettingsActivity(plugin)
                    fragment.presentFragment(settings_activity)
                    self._force_load_stickers()
            except Exception as e:
                from ui.bulletin import BulletinHelper
                BulletinHelper.show_error(t('open_settings_error', lang=self.lang, error=str(e)))
        run_on_ui_thread(_open_settings)

    def _force_load_stickers(self):
        try:
            from client_utils import get_last_fragment
            from org.telegram.messenger import MediaDataController
            from org.telegram.tgnet import TLRPC
            def load_stickers():
                try:
                    fragment = get_last_fragment()
                    if fragment:
                        current_account = fragment.getCurrentAccount()
                        media_controller = MediaDataController.getInstance(current_account)
                        if media_controller:
                            input_set = TLRPC.TL_inputStickerSetShortName()
                            input_set.short_name = "mr_vestr"
                            media_controller.getStickerSet(input_set, None, False, None)
                except Exception:
                    pass
            from android_utils import run_on_ui_thread
            from org.telegram.messenger import AndroidUtilities
            AndroidUtilities.runOnUIThread(lambda: run_on_ui_thread(load_stickers), 1000)
        except Exception:
            pass

    def _apply_press_scale(self, view):
        try:
            from android.view import View, MotionEvent
            from java import dynamic_proxy
            class _TouchListener(dynamic_proxy(View.OnTouchListener)):
                def __init__(self, fn):
                    super().__init__()
                    self._fn = fn
                def onTouch(self, v, event):
                    return self._fn(v, event)
            def _on_touch(v, event):
                try:
                    action = event.getActionMasked()
                    if action == MotionEvent.ACTION_DOWN:
                        v.animate().scaleX(0.94).scaleY(0.94).setDuration(100).start()
                    elif action in (MotionEvent.ACTION_UP, MotionEvent.ACTION_CANCEL):
                        v.animate().scaleX(1.0).scaleY(1.0).setDuration(200).start()
                except Exception:
                    pass
                return False
            view.setOnTouchListener(_TouchListener(_on_touch))
        except Exception:
            pass

    def _update_drawer_menu(self):
        show_drawer = self.get_setting('show_drawer_menu', False)
        self.remove_menu_item('templates_drawer')
        if show_drawer:
            self.add_menu_item(MenuItemData(
                menu_type=MenuItemType.DRAWER_MENU,
                text=t('templates', lang=self.lang),
                icon='msg_info',
                item_id='templates_drawer',
                on_click=lambda ctx: (self.open_plugin_settings(), self._force_load_stickers())
            ))

    def _update_chat_menu(self):
        show_chat = self.get_setting('show_chat_menu', True)
        if show_chat:
            try:
                from android_utils import run_on_ui_thread
                run_on_ui_thread(self._add_templates_item_to_current_chat_header)
            except Exception:
                pass

    def _update_chat_plugins_menu(self):
        show_chat_plugins = self.get_setting('show_chat_plugins_menu', False)
        self.remove_menu_item('templates_chat_plugins')
        if show_chat_plugins:
            try:
                menu_type = MenuItemType.CHAT_ACTION_MENU
            except Exception:
                menu_type = None
            if menu_type:
                self.add_menu_item(MenuItemData(
                    menu_type=menu_type,
                    text=t('templates', lang=self.lang),
                    icon='msg_info',
                    item_id='templates_chat_plugins',
                    on_click=lambda ctx: self._show_template_popup_menu(None)
                ))

    def _get_private_field(self, obj, name):
        try:
            cls = obj.getClass()
        except Exception:
            return None
        while cls is not None:
            try:
                field = cls.getDeclaredField(name)
                field.setAccessible(True)
                return field.get(obj)
            except Exception:
                try:
                    cls = cls.getSuperclass()
                except Exception:
                    break
        return None

    def _add_templates_item_to_current_chat_header(self):
        try:
            from client_utils import get_last_fragment
            from org.telegram.ui import ChatActivity
            frag = get_last_fragment()
            if not frag or not isinstance(frag, ChatActivity):
                return
            chat_activity = frag
            headerItem = self._get_private_field(chat_activity, "headerItem")
            if headerItem is None:
                return
            from hook_utils import find_class
            R = find_class("org.telegram.messenger.R")
            try:
                icon_id = getattr(R.drawable, 'msg_info')
            except Exception:
                try:
                    icon_id = getattr(R.drawable, 'msg_settings_14')
                except Exception:
                    icon_id = 0
            lazy_list = self._get_private_field(headerItem, "lazyList")
            lazy_map = self._get_private_field(headerItem, "lazyMap")
            try:
                if lazy_map is not None and lazy_map.get(self.templates_menu_id) is not None:
                    self._hook_chat_action_bar_callback(chat_activity)
                    return
                if lazy_list is not None:
                    for i in range(lazy_list.size()):
                        item = lazy_list.get(i)
                        try:
                            item_id = self._get_private_field(item, "id")
                            if item_id == self.templates_menu_id:
                                self._hook_chat_action_bar_callback(chat_activity)
                                return
                        except Exception:
                            continue
            except Exception:
                pass
            insert_position = -1
            try:
                if lazy_list is not None:
                    insert_position = lazy_list.size()
                    admin_gap = self._get_private_field(chat_activity, "adminItemsGap")
                    if admin_gap is not None and lazy_map is not None:
                        for i in range(lazy_list.size()):
                            item = lazy_list.get(i)
                            if item == admin_gap:
                                insert_position = i
                                break
            except Exception:
                pass
            from java import jclass
            try:
                ItemClass = jclass("org.telegram.ui.ActionBar.ActionBarMenuItem$Item")
                item_java_class = ItemClass.getClass()
                Integer = jclass("java.lang.Integer")
                Boolean = jclass("java.lang.Boolean")
                asSubItemMethod = item_java_class.getDeclaredMethod(
                    "asSubItem",
                    Integer.TYPE,
                    Integer.TYPE,
                    jclass("android.graphics.drawable.Drawable"),
                    jclass("java.lang.CharSequence"),
                    Boolean.TYPE,
                    Boolean.TYPE
                )
                asSubItemMethod.setAccessible(True)
                our_item = asSubItemMethod.invoke(None,
                    Integer(self.templates_menu_id),
                    Integer(icon_id),
                    None,
                    t('templates', lang=self.lang),
                    Boolean(True),
                    Boolean(False)
                )
                if lazy_list is not None and insert_position >= 0:
                    lazy_list.add(insert_position, our_item)
                    if lazy_map is not None:
                        lazy_map.put(self.templates_menu_id, our_item)
                else:
                    try:
                        headerItem.lazilyAddSubItem(self.templates_menu_id, icon_id, t('templates', lang=self.lang))
                    except Exception:
                        pass
                self._hook_chat_action_bar_callback(chat_activity)
            except Exception:
                pass
        except Exception:
            pass

    def _hook_chat_action_bar_callback(self, chat_activity):
        try:
            from base_plugin import MethodHook
            action_bar = self._get_private_field(chat_activity, "actionBar")
            if action_bar is None:
                return
            current_callback = self._get_private_field(action_bar, "actionBarMenuOnItemClick")
            if current_callback is None:
                return
            callback_class = current_callback.getClass()
            from java import jclass
            jint = jclass("java.lang.Integer").TYPE
            onItemClickMethod = callback_class.getDeclaredMethod("onItemClick", jint)
            onItemClickMethod.setAccessible(True)
            plugin = self
            class TemplatesActionBarMenuItemClickHook(MethodHook):
                def __init__(self, plugin_ref, activity_ref):
                    self.plugin_ref = plugin_ref
                    self.activity_ref = activity_ref
                def before_hooked_method(self, param):
                    try:
                        item_id = int(param.args[0])
                        if item_id == self.plugin_ref.templates_menu_id:
                            from android_utils import run_on_ui_thread
                            run_on_ui_thread(lambda: self.plugin_ref._show_template_popup_menu(None))
                            param.setResult(None)
                    except Exception:
                        pass
            self.hook_method(onItemClickMethod, TemplatesActionBarMenuItemClickHook(self, chat_activity))
        except Exception:
            pass

    def _hook_chat_activity_resume(self):
        try:
            from hook_utils import find_class
            from base_plugin import MethodHook
            ChatActivity = find_class("org.telegram.ui.ChatActivity")
            if ChatActivity is None:
                return
            target_method = None
            for m in ChatActivity.getClass().getDeclaredMethods():
                try:
                    name = m.getName()
                    if name == "onResume":
                        target_method = m
                        break
                except Exception:
                    pass
            if target_method is None:
                for m in ChatActivity.getClass().getDeclaredMethods():
                    try:
                        if m.getName() == "onFragmentCreate":
                            target_method = m
                            break
                    except Exception:
                        pass
            if target_method is None:
                return
            plugin = self
            class ChatResumeHook(MethodHook):
                def __init__(self, p):
                    self.p = p
                def after_hooked_method(self, param):
                    try:
                        if self.p.get_setting('show_chat_menu', True):
                            from android_utils import run_on_ui_thread
                            run_on_ui_thread(self.p._add_templates_item_to_current_chat_header)
                    except Exception:
                        pass
            self.hook_method(target_method, ChatResumeHook(self))
        except Exception:
            pass

    def _open_channel_link(self, _):
        from client_utils import get_last_fragment
        from android_utils import run_on_ui_thread
        from client_utils import get_messages_controller
        run_on_ui_thread(lambda: get_messages_controller().openByUserName("I_am_Vestr", get_last_fragment(), 1))

    def _copy_channel_link(self, _):
        try:
            from android_utils import run_on_ui_thread
            from client_utils import get_last_fragment
            run_on_ui_thread(lambda: self._copy_link_to_clipboard("https://t.me/I_am_Vestr"))
        except Exception:
            pass

    def _copy_personal_link(self, _):
        try:
            from android_utils import run_on_ui_thread
            from client_utils import get_last_fragment
            run_on_ui_thread(lambda: self._copy_link_to_clipboard("https://t.me/mr_Vestr"))
        except Exception:
            pass

    def _copy_link_to_clipboard(self, url):
        try:
            from client_utils import get_last_fragment
            fragment = get_last_fragment()
            if not fragment:
                return
            context = fragment.getParentActivity()
            if not context:
                return
            from android.content import ClipboardManager, ClipData
            clipboard = context.getSystemService(context.CLIPBOARD_SERVICE)
            clipboard.setPrimaryClip(ClipData.newPlainText("link", url))
            from ui.bulletin import BulletinHelper
            try:
                from org.telegram.messenger import R as R_tg
                icon_attr = getattr(R_tg.raw, 'copy', None)
            except Exception:
                icon_attr = None
            BulletinHelper.show_with_button(t('link_copied', lang=self.lang), icon_attr if icon_attr else 0, t('close', lang=self.lang), lambda: None, None)
        except Exception:
            pass

    def _open_personal_link(self, _):
        from client_utils import get_last_fragment
        from org.telegram.messenger.browser import Browser
        from android.net import Uri
        frag = get_last_fragment()
        act = frag.getParentActivity() if frag else None
        if act:
            try:
                if self.lang == 'en':
                    text = 'Hello%21+I%27m+writing+regarding+the+%22Templates%22+plugin%3A%0D%0A'
                else:
                    text = '%D0%9F%D1%80%D0%B8%D0%B2%D0%B5%D1%82%21+%D0%9F%D0%B8%D1%88%D1%83+%D0%BF%D0%BE+%D0%BF%D0%BE%D0%B2%D0%BE%D0%B4%D1%83+%D0%BF%D0%BB%D0%B0%D0%B3%D0%B8%D0%BD%D0%B0+%C2%ABTemplates%C2%BB%3A%0D%0A'
                uri = Uri.parse(f"https://t.me/mr_vestr/?text={text}")
                Browser.openUrl(act, uri, True, True, True, None, None, False, False, False)
            except Exception as e:
                from ui.bulletin import BulletinHelper
                BulletinHelper.show_error(t('link_open_error', lang=self.lang, error=str(e)))

    def _add_url_hook(self):
        from hook_utils import find_class
        from base_plugin import MethodHook
        class UrlHandler(MethodHook):
            def __init__(self, plugin):
                self.plugin = plugin
            def before_hooked_method(self, param):
                try:
                    uri = str(param.args[1].toString())
                    if "t.me/I_am_Vestr" in uri or "t.me/mr_vestr" in uri:
                        pass
                except Exception as e:
                    pass
        try:
            browser_class = find_class("org.telegram.messenger.browser.Browser")
            open_url_method = None
            for method in browser_class.getClass().getDeclaredMethods():
                if (method.getName() == "openUrl" and 
                    "android.net.Uri" in str(method.getParameterTypes()[1])):
                    open_url_method = method
                    break
            if open_url_method:
                self.hook_method(open_url_method, UrlHandler(self), 0)
            else:
                pass
        except Exception as e:
            pass

    def _add_input_hook(self):
        from hook_utils import find_class
        from base_plugin import MethodHook
        from android_utils import run_on_ui_thread
        
        class InputHandler(MethodHook):
            def __init__(self, plugin):
                self.plugin = plugin
                self.last_text = ""
                self.menu_shown = False
                
            def before_hooked_method(self, param):
                try:
                    text_view = param.thisObject
                    if hasattr(text_view, 'getText'):
                        current_text = str(text_view.getText())
                        send_cmd = self.plugin.get_setting('send_cmd', '//').strip()
                        if not send_cmd:
                            send_cmd = '//'
                        if (current_text.strip().lower().startswith(send_cmd.lower()) and 
                            not self.menu_shown and 
                            current_text.strip() == send_cmd):
                            self.menu_shown = True
                            run_on_ui_thread(lambda: self.plugin._show_template_popup_menu(text_view))
                        if current_text != self.last_text:
                            self.last_text = current_text
                            if not current_text.strip().startswith(send_cmd):
                                self.menu_shown = False
                except Exception:
                    pass
        try:
            edit_text_class = find_class("org.telegram.ui.Components.EditTextCaption")
            if edit_text_class:
                for method in edit_text_class.getClass().getDeclaredMethods():
                    if method.getName() == "setText":
                        self.hook_method(method, InputHandler(self), 0)
                        break
        except Exception:
            pass

    def _add_document_hook(self):
        from hook_utils import find_class
        from base_plugin import MethodHook
        class DocumentHandler(MethodHook):
            def __init__(self, plugin):
                self.plugin = plugin
            def before_hooked_method(self, param):
                try:
                    f = param.args[0]
                    filename = param.args[1]
                    if str(filename).split(".")[-1].lower() == "templates":
                        with open(f.getAbsolutePath(), "rb") as fh:
                            content = fh.read()
                        if not content:
                            return
                        try:
                            import json
                            data = json.loads(content.decode("utf-8"))
                        except Exception:
                            return
                        param.setResult(False)
                        self.plugin._show_import_bottom_sheet(data, act=param.args[3])
                except Exception:
                    pass
        try:
            android_utils = find_class("org.telegram.messenger.AndroidUtilities")
            target = None
            for method in android_utils.getClass().getDeclaredMethods():
                if repr(method) == (
                    "<java.lang.reflect.Method 'public static boolean org.telegram.messenger.AndroidUtilities.openForView"
                    "(java.io.File,java.lang.String,java.lang.String,android.app.Activity,org.telegram.ui.ActionBar.Theme$ResourcesProvider,boolean)'>"
                ):
                    target = method
                    break
            if target is not None:
                self.hook_method(target, DocumentHandler(self), 2147483647)
        except Exception:
            pass

    def _full_reload_plugin(self):
        from client_utils import get_last_fragment
        from com.exteragram.messenger.plugins import PluginsController
        from ui.bulletin import BulletinHelper
        frag = get_last_fragment()
        act = frag.getParentActivity() if frag else None
        if frag and hasattr(frag, 'finish'):
            try:
                frag.finish()
            except Exception:
                pass
        self.update_info_cache = None
        self.last_update_check = 0
        try:
            PluginsController.getInstance().reloadPlugin(self.id)
        except Exception as e:
            BulletinHelper.show_error(t('restart_error', lang=self.lang, error=str(e)))

    def _show_how_it_works(self, _):
        from org.telegram.ui.ActionBar import BottomSheet, Theme
        from android.widget import LinearLayout, TextView, ScrollView, FrameLayout
        from android.view import Gravity, View
        from android.util import TypedValue
        from org.telegram.ui.Components import LayoutHelper
        from org.telegram.messenger import AndroidUtilities
        from android.graphics.drawable import GradientDrawable
        from android.graphics import Color
        from android_utils import OnClickListener
        from client_utils import get_last_fragment
        frag = get_last_fragment()
        act = frag.getParentActivity() if frag else None
        if not act:
            return
        sheet = BottomSheet(act, False)
        root_layout = LinearLayout(act)
        root_layout.setOrientation(LinearLayout.VERTICAL)
        root_layout.setPadding(AndroidUtilities.dp(20), AndroidUtilities.dp(16), AndroidUtilities.dp(20), AndroidUtilities.dp(8))
        try:
            root_layout.setAlpha(0.0)
            root_layout.setScaleX(0.3)
            root_layout.setScaleY(0.3)
            root_layout.setTranslationY(AndroidUtilities.dp(100))
        except Exception:
            pass
        try:
            root_layout.setBackgroundColor(Theme.getColor(Theme.key_dialogBackground))
        except Exception:
            pass
        title_view = TextView(act)
        title_view.setTypeface(AndroidUtilities.bold())
        title_view.setGravity(Gravity.CENTER)
        title_view.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 24)
        title_view.setText(t('how_it_works', lang=self.lang))
        try:
            title_view.setTextColor(Theme.getColor(Theme.key_dialogTextBlack))
        except Exception:
            pass
        try:
            title_view.setAlpha(0.0)
            title_view.setTranslationY(AndroidUtilities.dp(50))
            title_view.setScaleX(0.8)
            title_view.setScaleY(0.8)
        except Exception:
            pass
        root_layout.addView(title_view, LayoutHelper.createLinear(-1, -2, Gravity.CENTER, 0, 0, 0, 12))
        body_scroll = ScrollView(act)
        body_scroll.setVerticalScrollBarEnabled(False)
        body_scroll.setPadding(AndroidUtilities.dp(4), 0, AndroidUtilities.dp(4), 0)
        try:
            body_scroll.setNestedScrollingEnabled(True)
        except Exception:
            pass
        try:
            body_scroll.setAlpha(0.0)
            body_scroll.setTranslationY(AndroidUtilities.dp(30))
            body_scroll.setScaleX(0.8)
            body_scroll.setScaleY(0.8)
        except Exception:
            pass
        body_tv = TextView(act)
        body_tv.setText(t('how_it_works_text', lang=self.lang))
        body_tv.setTextIsSelectable(True)
        body_tv.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 15)
        try:
            body_tv.setTextColor(Theme.getColor(Theme.key_dialogTextBlack))
        except Exception:
            pass
        try:
            body_tv.setLineSpacing(AndroidUtilities.dp(4), 1.15)
        except Exception:
            pass
        body_scroll.addView(body_tv)
        root_layout.addView(body_scroll, LayoutHelper.createLinear(-1, 0, 1.0))
        divider = View(act)
        try:
            divider_color = Theme.getColor(Theme.key_divider)
        except Exception:
            divider_color = Color.parseColor("#E0E0E0")
        divider.setBackgroundColor(divider_color)
        root_layout.addView(divider, LayoutHelper.createLinear(-1, 1, 0, 16, 0, 12))
        
        def create_link_button(text: str, icon_res: str, on_click):
            from android.widget import ImageView
            btn_frame = FrameLayout(act)
            btn_bg = GradientDrawable()
            btn_bg.setCornerRadius(AndroidUtilities.dp(18))
            try:
                bg_color = Theme.getColor(Theme.key_chat_inLoader) & 0x20FFFFFF | 0x10000000
            except Exception:
                bg_color = Color.parseColor("#F0F0F0")
            btn_bg.setColor(bg_color)
            try:
                from android.graphics.drawable import RippleDrawable
                from android.content.res import ColorStateList
                ripple_color = ColorStateList.valueOf(Color.parseColor("#40000000"))
                ripple_drawable = RippleDrawable(ripple_color, btn_bg, None)
                btn_frame.setBackground(ripple_drawable)
            except Exception:
                btn_frame.setBackground(btn_bg)
            btn_frame.setPadding(AndroidUtilities.dp(12), AndroidUtilities.dp(8), AndroidUtilities.dp(12), AndroidUtilities.dp(8))
            icon_view = ImageView(act)
            try:
                from org.telegram.messenger import R as R_tg
                icon_view.setImageResource(getattr(R_tg.drawable, icon_res))
            except Exception:
                pass
            icon_view.setScaleType(ImageView.ScaleType.CENTER)
            icon_view.setColorFilter(Theme.getColor(Theme.key_dialogTextBlue))
            text_view = TextView(act)
            text_view.setText(text)
            text_view.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 14)
            text_view.setTextColor(Theme.getColor(Theme.key_dialogTextBlue))
            text_view.setGravity(Gravity.CENTER_VERTICAL)
            btn_frame.addView(icon_view, LayoutHelper.createFrame(20, 20, Gravity.LEFT | Gravity.CENTER_VERTICAL, 0, 0, 8, 0))
            btn_frame.addView(text_view, LayoutHelper.createFrame(-2, -2, Gravity.LEFT | Gravity.CENTER_VERTICAL, 28, 0, 0, 0))
            btn_frame.setClickable(True)
            btn_frame.setFocusable(True)
            self._apply_press_scale(btn_frame)
            btn_frame.setOnClickListener(OnClickListener(lambda *_: on_click(btn_frame)))
            return btn_frame
        actions_row = LinearLayout(act)
        actions_row.setOrientation(LinearLayout.HORIZONTAL)
        actions_row.setGravity(Gravity.CENTER)
        try:
            actions_row.setAlpha(0.0)
            actions_row.setTranslationY(AndroidUtilities.dp(40))
            actions_row.setScaleX(0.8)
            actions_row.setScaleY(0.8)
        except Exception:
            pass
        
        def on_channel(v):
            try:
                sheet.dismiss()
                self._open_channel_link(None)
            except Exception:
                pass
        
        def on_personal(v):
            try:
                sheet.dismiss()
                self._open_personal_link(None)
            except Exception:
                pass

        def on_open_doc(v):
            try:
                from org.telegram.messenger.browser import Browser
                from android.net import Uri
                if self.lang == 'ru':
                    doc_url = 'https://github.com/mr-Vestr/plugins/blob/main/Templates/TEMPLATES_RU.md'
                else:
                    doc_url = 'https://github.com/mr-Vestr/plugins/blob/main/Templates/TEMPLATES_EN.md'
                uri = Uri.parse(doc_url)
                Browser.openUrl(act, uri, True, True, True, None, None, True, True, True)
            except Exception:
                pass

        channel_btn = create_link_button(t('channel', lang=self.lang), 'msg_channel', on_channel)
        personal_btn = create_link_button(t('personal', lang=self.lang), 'msg_contacts', on_personal)
        channel_btn.setMinimumWidth(AndroidUtilities.dp(100))
        personal_btn.setMinimumWidth(AndroidUtilities.dp(100))
        open_btn = FrameLayout(act)
        open_bg = GradientDrawable()
        open_bg.setCornerRadius(AndroidUtilities.dp(18))
        try:
            bg_color = Theme.getColor(Theme.key_chat_inLoader) & 0x20FFFFFF | 0x10000000
        except Exception:
            bg_color = Color.parseColor("#F0F0F0")
        open_bg.setColor(bg_color)
        try:
            from android.graphics.drawable import RippleDrawable
            from android.content.res import ColorStateList
            ripple_color = ColorStateList.valueOf(Color.parseColor("#40000000"))
            ripple_drawable = RippleDrawable(ripple_color, open_bg, None)
            open_btn.setBackground(ripple_drawable)
        except Exception:
            open_btn.setBackground(open_bg)
        open_btn.setPadding(AndroidUtilities.dp(12), AndroidUtilities.dp(8), AndroidUtilities.dp(12), AndroidUtilities.dp(8))
        from android.widget import ImageView
        icon_view = ImageView(act)
        try:
            from org.telegram.messenger import R as R_tg
            icon_view.setImageResource(getattr(R_tg.drawable, 'msg_openin', getattr(R_tg.drawable, 'msg_open', 0)))
        except Exception:
            pass
        icon_view.setScaleType(ImageView.ScaleType.CENTER)
        icon_view.setColorFilter(Theme.getColor(Theme.key_dialogTextBlue))
        open_btn.addView(icon_view, LayoutHelper.createFrame(20, 20, Gravity.CENTER, 0, 0, 0, 0))
        open_btn.setClickable(True)
        open_btn.setFocusable(True)
        self._apply_press_scale(open_btn)
        open_btn.setOnClickListener(OnClickListener(lambda *_: on_open_doc(open_btn)))
        actions_row.addView(channel_btn, LayoutHelper.createLinear(-2, -2, Gravity.CENTER_VERTICAL, 0, 0, 6, 0))
        actions_row.addView(personal_btn, LayoutHelper.createLinear(-2, -2, Gravity.CENTER_VERTICAL, 0, 0, 6, 0))
        actions_row.addView(open_btn, LayoutHelper.createLinear(-2, -2, Gravity.CENTER_VERTICAL, 0, 0, 0, 0))
        root_layout.addView(actions_row, LayoutHelper.createLinear(-1, -2, 0, 0, 0, 12))
        close_btn_frame = FrameLayout(act)
        try:
            base_color = Theme.getColor(Theme.key_featuredStickers_addButton)
        except Exception:
            base_color = Theme.getColor(Theme.key_dialogTextBlue)
        try:
            pressed_color = Theme.getColor(Theme.key_featuredStickers_addButtonPressed)
        except Exception:
            pressed_color = base_color
        close_btn_frame.setBackground(Theme.createSimpleSelectorRoundRectDrawable(
            AndroidUtilities.dp(28),
            base_color,
            pressed_color
        ))
        close_btn_frame.setPadding(0, AndroidUtilities.dp(14), 0, AndroidUtilities.dp(14))
        close_btn_frame.setClickable(True)
        close_btn_frame.setFocusable(True)
        close_btn_text = TextView(act)
        close_btn_text.setText(t('close', lang=self.lang))
        close_btn_text.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 16)
        close_btn_text.setTypeface(AndroidUtilities.bold())
        close_btn_text.setGravity(Gravity.CENTER)
        close_btn_text.setTextColor(Theme.getColor(Theme.key_featuredStickers_buttonText))
        close_btn_frame.addView(close_btn_text, FrameLayout.LayoutParams(-1, -2))
        close_btn_frame.setOnClickListener(OnClickListener(lambda *_: sheet.dismiss()))
        self._apply_press_scale(close_btn_frame)
        try:
            close_btn_frame.setAlpha(0.0)
            close_btn_frame.setTranslationY(AndroidUtilities.dp(50))
            close_btn_frame.setScaleX(0.8)
            close_btn_frame.setScaleY(0.8)
        except Exception:
            pass
        root_layout.addView(close_btn_frame, LayoutHelper.createLinear(-1, -2, 0, 8, 0, 0))
        sheet.setCustomView(root_layout)
        sheet.setCanDismissWithSwipe(False)
        sheet.show()
        def animate_elements():
            try:
                try:
                    root_layout.animate().alpha(0.8).scaleX(0.4).scaleY(0.4).translationY(AndroidUtilities.dp(50)).setDuration(200).start()
                except Exception:
                    pass
                def scale_up_menu():
                    try:
                        root_layout.animate().alpha(1.0).scaleX(1.0).scaleY(1.0).translationY(0).setDuration(400).start()
                    except Exception:
                        pass
                    def show_elements():
                        try:
                            title_view.animate().alpha(1.0).translationY(0).scaleX(1.0).scaleY(1.0).setDuration(350).start()
                        except Exception:
                            pass
                        try:
                            body_scroll.animate().alpha(1.0).translationY(0).scaleX(1.0).scaleY(1.0).setDuration(350).setStartDelay(50).start()
                        except Exception:
                            pass
                        try:
                            actions_row.animate().alpha(1.0).translationY(0).scaleX(1.0).scaleY(1.0).setDuration(350).setStartDelay(100).start()
                        except Exception:
                            pass
                        try:
                            close_btn_frame.animate().alpha(1.0).translationY(0).scaleX(1.0).scaleY(1.0).setDuration(350).setStartDelay(150).start()
                        except Exception:
                            pass
                    try:
                        run_on_ui_thread(show_elements)
                    except Exception:
                        pass
                try:
                    from org.telegram.messenger import AndroidUtilities
                    from java import dynamic_proxy
                    from java.lang import Runnable
                    class ScaleUpRunnable(dynamic_proxy(Runnable)):
                        def __init__(self, func):
                            super().__init__()
                            self.func = func
                        def run(self):
                            self.func()
                    AndroidUtilities.runOnUIThread(ScaleUpRunnable(lambda: run_on_ui_thread(scale_up_menu)), 200)
                except Exception:
                    try:
                        run_on_ui_thread(scale_up_menu)
                    except Exception:
                        pass
            except Exception:
                pass
        try:
            run_on_ui_thread(animate_elements)
        except Exception:
            pass

    def _check_for_updates_on_load_with_timeout(self):
        try:
            last_check_time = self.get_setting('last_update_check_time', 0)
            current_time = int(time.time())
            ten_minutes_ago = current_time - 600
            
            if last_check_time < ten_minutes_ago:
                def delayed_check():
                    time.sleep(3)
                    self._check_for_updates(show_on_load=True)
                    self.set_setting('last_update_check_time', current_time, reload_settings=False)
                thread = threading.Thread(target=delayed_check)
                thread.daemon = True
                thread.start()
            else:
                pass
        except Exception:
            pass

    def _check_for_updates_on_load(self):
        def delayed_check():
            time.sleep(3)
            self._check_for_updates(show_on_load=True)
        thread = threading.Thread(target=delayed_check)
        thread.daemon = True
        thread.start()
    
    def _check_for_updates(self, show_on_load=False, show_loading=True):
        if self.checking_update:
            return
        self.update_available = False
        self.checking_update = True
        timeout_reached = [False]
        
        def check_thread():
            try:
                if show_loading and not show_on_load:
                    run_on_ui_thread(lambda: self._show_checking_bulletin())
                api_url = "https://api.github.com/repos/mr-Vestr/plugins/contents/Templates/config.json?ref=main"
                timestamp = int(time.time() * 1000)
                api_url_with_timestamp = f"{api_url}&t={timestamp}"
                request = urllib.request.Request(api_url_with_timestamp)
                request.add_header('Cache-Control', 'no-cache, no-store, must-revalidate')
                request.add_header('Pragma', 'no-cache')
                request.add_header('Expires', '0')
                request.add_header('Accept', 'application/vnd.github.v3+json')
                if show_loading and not show_on_load:
                    check_started = time.time()
                    def check_timeout():
                        time.sleep(10)
                        if self.checking_update and not timeout_reached[0]:
                            timeout_reached[0] = True
                            self.checking_update = False
                            run_on_ui_thread(lambda: self._show_timeout_bulletin())
                    timeout_thread = threading.Thread(target=check_timeout, daemon=True)
                    timeout_thread.start()
                with urllib.request.urlopen(request, timeout=10) as response:
                    if timeout_reached[0]:
                        return
                    if response.getcode() != 200:
                        raise Exception(f"HTTP {response.getcode()}")
                    api_response = json.loads(response.read().decode('utf-8'))
                    if api_response.get("encoding") != "base64":
                        raise Exception("Unexpected encoding format")
                    content_base64 = api_response.get("content", "")
                    if not content_base64:
                        raise Exception("No content in API response")
                    content_base64 = content_base64.replace('\n', '').replace('\r', '')
                    content_decoded = base64.b64decode(content_base64).decode('utf-8')
                    config_data = json.loads(content_decoded)
                    if timeout_reached[0]:
                        return
                    latest_version_from_config = config_data.get("version", "0.0.0")
                    if self.lang == 'ru':
                        changelog_from_config = config_data.get("changelog_ru", config_data.get("changelog", "Нет информации об изменениях"))
                    else:
                        changelog_from_config = config_data.get("changelog_en", config_data.get("changelog", "No changelog available"))
                    sticker_info = config_data.get("sticker", "")
                    download_url_from_config = config_data.get("link", "")
                    sticker_pack_from_config = None
                    sticker_index_from_config = 0
                    if sticker_info and "/" in sticker_info:
                        parts = sticker_info.split("/")
                        sticker_pack_from_config = parts[0]
                        try:
                            sticker_index_from_config = int(parts[1]) if len(parts) > 1 else 0
                        except:
                            sticker_index_from_config = 0
                    else:
                        sticker_pack_from_config = "mr_vestr"
                        sticker_index_from_config = 1
                    current_version = __version__.strip()
                    latest_version_clean = latest_version_from_config.strip()
                    current_base = current_version.split(" (")[0].strip() if " (" in current_version else current_version.strip()
                    latest_base = latest_version_clean.split(" (")[0].strip() if " (" in latest_version_clean else latest_version_clean.strip()
                    if current_base != latest_base:
                        self.update_available = True
                        self.latest_version = latest_version_from_config
                        self.changelog = changelog_from_config
                        self.download_url = download_url_from_config
                        self.sticker_pack = sticker_pack_from_config
                        self.sticker_index = sticker_index_from_config
                        if show_on_load and not timeout_reached[0]:
                            run_on_ui_thread(lambda: self._show_update_bottom_sheet())
                        elif show_loading and not timeout_reached[0]:
                            run_on_ui_thread(lambda: self._show_update_bottom_sheet())
                    else:
                        self.update_available = False
                        self.latest_version = latest_version_from_config
                        self.changelog = changelog_from_config
                        self.download_url = download_url_from_config
                        self.sticker_pack = sticker_pack_from_config
                        self.sticker_index = sticker_index_from_config
                        if show_loading and not show_on_load and not timeout_reached[0]:
                            run_on_ui_thread(lambda: self._show_no_update_bulletin())
            except Exception as e:
                if show_loading and not timeout_reached[0] and not show_on_load:
                    error_message = str(e)
                    run_on_ui_thread(lambda: self._show_error_bulletin(error_message))
            finally:
                if not timeout_reached[0]:
                    self.checking_update = False
                    if not show_on_load:
                        current_time = int(time.time())
                        self.set_setting('last_update_check_time', current_time, reload_settings=False)
        threading.Thread(target=check_thread, daemon=True).start()
    
    def _show_checking_bulletin(self):
        try:
            from org.telegram.messenger import R as R_tg
            BulletinHelper.show_with_button(
                t('checking_updates', lang=self.lang) if hasattr(self, 'lang') and self.lang == 'ru' else "Checking updates...",
                R_tg.raw.camera_flip,
                t('close', lang=self.lang) if hasattr(self, 'lang') and self.lang == 'ru' else "Close",
                lambda: None,
                None
            )
        except Exception as e:
            pass
    
    def _show_no_update_bulletin(self):
        try:
            from org.telegram.messenger import R as R_tg
            BulletinHelper.show_with_button(
                t('no_updates_available', lang=self.lang) if hasattr(self, 'lang') and self.lang == 'ru' else "You have the latest version of the plugin.",
                R_tg.raw.done,
                t('close', lang=self.lang) if hasattr(self, 'lang') and self.lang == 'ru' else "Close",
                lambda: None,
                None
            )
        except Exception as e:
            pass
    
    def _show_error_bulletin(self, error_msg):
        try:
            from org.telegram.messenger import R as R_tg
            BulletinHelper.show_with_button(
                t('update_check_error', lang=self.lang, error=error_msg) if hasattr(self, 'lang') and self.lang == 'ru' else f"Update check error: {error_msg}",
                R_tg.raw.error,
                t('close', lang=self.lang) if hasattr(self, 'lang') and self.lang == 'ru' else "Close",
                lambda: None,
                None
            )
        except Exception as e:
            pass
    
    def _show_timeout_bulletin(self):
        try:
            from org.telegram.messenger import R as R_tg
            BulletinHelper.show_with_button(
                "Не удалось проверить обновления. Проверьте подключение к интернету." if self.lang == 'ru' else "Failed to check for updates. Check your internet connection.",
                R_tg.raw.error,
                t('close', lang=self.lang) if hasattr(self, 'lang') and self.lang == 'ru' else "Close",
                lambda: None,
                None
            )
        except Exception as e:
            pass
    
    def _show_update_bottom_sheet(self):
        try:
            from client_utils import get_last_fragment
            from org.telegram.ui.ActionBar import BottomSheet, Theme
            from org.telegram.ui.Components import LayoutHelper, BackupImageView
            from org.telegram.messenger import AndroidUtilities, MediaDataController, ImageLocation
            from android.widget import LinearLayout, TextView, ScrollView, FrameLayout
            from android.view import Gravity, View
            from android.util import TypedValue
            from android.graphics import Color
            from android.text import SpannableString, SpannableStringBuilder
            from android.text.style import StrikethroughSpan, ForegroundColorSpan
            from android_utils import OnClickListener, run_on_ui_thread
            from org.telegram.messenger.browser import Browser
            from android.net import Uri
            from androidx.core.widget import NestedScrollView
            fragment = get_last_fragment()
            if not fragment:
                return
            act = fragment.getParentActivity()
            if not act:
                return
            sheet = BottomSheet(act, False, fragment.getResourceProvider())
            sheet.setApplyBottomPadding(False)
            sheet.setApplyTopPadding(False)
            sheet.fixNavigationBar(Theme.getColor(Theme.key_windowBackgroundWhite))
            scroll_view = NestedScrollView(act)
            scroll_content = LinearLayout(act)
            scroll_content.setOrientation(LinearLayout.VERTICAL)
            scroll_content.setPadding(AndroidUtilities.dp(20), AndroidUtilities.dp(16), AndroidUtilities.dp(20), AndroidUtilities.dp(8))
            root_layout = LinearLayout(act)
            root_layout.setOrientation(LinearLayout.VERTICAL)
            try:
                scroll_content.setAlpha(0.0)
                scroll_content.setScaleX(0.3)
                scroll_content.setScaleY(0.3)
                scroll_content.setTranslationY(AndroidUtilities.dp(100))
            except Exception:
                pass
            try:
                from android.graphics.drawable import GradientDrawable
                bg_drawable = GradientDrawable()
                bg_drawable.setShape(GradientDrawable.RECTANGLE)
                bg_drawable.setCornerRadii([AndroidUtilities.dp(20), AndroidUtilities.dp(20), AndroidUtilities.dp(20), AndroidUtilities.dp(20), 0, 0, 0, 0])
                bg_drawable.setColor(Theme.getColor(Theme.key_dialogBackground))
                root_layout.setBackground(bg_drawable)
            except Exception:
                try:
                    root_layout.setBackgroundColor(Theme.getColor(Theme.key_dialogBackground))
                except Exception:
                    pass
            avatar_view = BackupImageView(act)
            avatar_view.setRoundRadius(AndroidUtilities.dp(45))
            root_layout.addView(avatar_view, LayoutHelper.createLinear(130, 130, Gravity.CENTER_HORIZONTAL, 0, 0, 0, 12))
            if self.sticker_pack:
                sticker_name = f"{self.sticker_pack}/{self.sticker_index}" if self.sticker_index > 0 else self.sticker_pack
                self.load_sticker_with_fallback(avatar_view, sticker_name, self.sticker_index, "130_130")
            title_view = TextView(act)
            title_view.setTypeface(AndroidUtilities.bold())
            title_view.setGravity(Gravity.CENTER)
            title_view.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 24)
            title_view.setText("Templates | Шаблоны")
            try:
                title_view.setTextColor(Theme.getColor(Theme.key_dialogTextBlack))
            except Exception:
                pass
            try:
                title_view.setAlpha(0.0)
                title_view.setTranslationY(AndroidUtilities.dp(50))
                title_view.setScaleX(0.8)
                title_view.setScaleY(0.8)
            except Exception:
                pass
            root_layout.addView(title_view, LayoutHelper.createLinear(-1, -2, Gravity.CENTER, 0, 0, 0, 8))
            version_view = TextView(act)
            version_view.setGravity(Gravity.CENTER)
            version_view.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 16)
            version_view.setTextColor(Theme.getColor(Theme.key_dialogTextGray))
            current_version_clean = __version__.split(" (")[0].strip()
            version_text = f"{current_version_clean} → {self.latest_version}"
            spannable = SpannableString(version_text)
            spannable.setSpan(StrikethroughSpan(), 0, len(current_version_clean), SpannableString.SPAN_EXCLUSIVE_EXCLUSIVE)
            version_view.setText(spannable)
            root_layout.addView(version_view, LayoutHelper.createLinear(-1, -2, Gravity.CENTER, 0, 0, 0, 16))
            changes_title = TextView(act)
            changes_title.setTypeface(AndroidUtilities.bold())
            changes_title.setGravity(Gravity.LEFT)
            changes_title.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 18)
            changes_title.setText("Изменения:" if self.lang == 'ru' else "Changes:")
            changes_title.setTextColor(Theme.getColor(Theme.key_dialogTextBlack))
            root_layout.addView(changes_title, LayoutHelper.createLinear(-1, -2, Gravity.LEFT, 0, 0, 0, 8))
            changelog_container = FrameLayout(act)
            try:
                from android.graphics.drawable import GradientDrawable
                border_drawable = GradientDrawable()
                border_drawable.setShape(GradientDrawable.RECTANGLE)
                border_drawable.setCornerRadius(AndroidUtilities.dp(8))
                border_color = Theme.getColor(Theme.key_featuredStickers_addButton)
                border_drawable.setStroke(AndroidUtilities.dp(2), border_color)
                border_drawable.setColor(Theme.getColor(Theme.key_dialogBackground))
                changelog_container.setBackground(border_drawable)
            except Exception:
                pass
            changelog_container.setPadding(AndroidUtilities.dp(12), AndroidUtilities.dp(12), AndroidUtilities.dp(12), AndroidUtilities.dp(12))
            changelog_view = TextView(act)
            changelog_view.setGravity(Gravity.LEFT)
            changelog_view.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 15)
            changelog_view.setText(self.changelog or "No changelog available")
            changelog_view.setTextColor(Theme.getColor(Theme.key_dialogTextBlack))
            changelog_view.setLineSpacing(AndroidUtilities.dp(4), 1.15)
            changelog_container.addView(changelog_view, FrameLayout.LayoutParams(-1, -2))
            root_layout.addView(changelog_container, LayoutHelper.createLinear(-1, -2, Gravity.LEFT, 0, 0, 0, 12))
            changelog_link_btn = TextView(act)
            changelog_link_btn.setText("Полный список изменений" if self.lang == 'ru' else "Full changelog")
            changelog_link_btn.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 14)
            changelog_link_btn.setGravity(Gravity.CENTER)
            try:
                changelog_link_btn.setTextColor(Theme.getColor(Theme.key_featuredStickers_addButton))
            except Exception:
                changelog_link_btn.setTextColor(Color.BLUE)
            changelog_link_btn.setClickable(True)
            changelog_link_btn.setFocusable(True)
            def on_changelog_link_click(v):
                try:
                    sheet.dismiss()
                    Browser.openUrl(act, Uri.parse("https://t.me/I_am_Vestr"))
                except Exception:
                    pass
            changelog_link_btn.setOnClickListener(OnClickListener(lambda *_: on_changelog_link_click(changelog_link_btn)))
            self._apply_press_scale(changelog_link_btn)
            try:
                changelog_link_btn.setAlpha(0.0)
                changelog_link_btn.setTranslationY(AndroidUtilities.dp(50))
                changelog_link_btn.setScaleX(0.8)
                changelog_link_btn.setScaleY(0.8)
            except Exception:
                pass
            root_layout.addView(changelog_link_btn, LayoutHelper.createLinear(-1, -2, Gravity.CENTER, 0, 0, 0, 16))
            update_btn_frame = FrameLayout(act)
            base_color = Theme.getColor(Theme.key_featuredStickers_addButton)
            pressed_color = Theme.getColor(Theme.key_featuredStickers_addButtonPressed)
            update_btn_frame.setBackground(Theme.createSimpleSelectorRoundRectDrawable(
                AndroidUtilities.dp(28),
                base_color,
                pressed_color
            ))
            update_btn_frame.setPadding(0, AndroidUtilities.dp(14), 0, AndroidUtilities.dp(14))
            update_btn_frame.setClickable(True)
            update_btn_frame.setFocusable(True)
            update_btn_text = TextView(act)
            update_btn_text.setText("Обновить" if self.lang == 'ru' else "Update")
            update_btn_text.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 16)
            update_btn_text.setTypeface(AndroidUtilities.bold())
            update_btn_text.setGravity(Gravity.CENTER)
            update_btn_text.setTextColor(Theme.getColor(Theme.key_featuredStickers_buttonText))
            update_btn_frame.addView(update_btn_text, FrameLayout.LayoutParams(-1, -2))
            def on_update_click(v):
                try:
                    sheet.dismiss()
                    self._download_and_install_update()
                except Exception:
                    pass
            update_btn_frame.setOnClickListener(OnClickListener(lambda *_: on_update_click(update_btn_frame)))
            self._apply_press_scale(update_btn_frame)
            try:
                update_btn_frame.setAlpha(0.0)
                update_btn_frame.setTranslationY(AndroidUtilities.dp(50))
                update_btn_frame.setScaleX(0.8)
                update_btn_frame.setScaleY(0.8)
            except Exception:
                pass
            root_layout.addView(update_btn_frame, LayoutHelper.createLinear(-1, -2, 0, 8, 0, 0))
            scroll_content.addView(root_layout)
            scroll_view.addView(scroll_content)
            sheet.setCustomView(scroll_view)
            sheet.show()
            def animate_elements():
                try:
                    try:
                        scroll_content.animate().alpha(0.8).scaleX(0.4).scaleY(0.4).translationY(AndroidUtilities.dp(50)).setDuration(200).start()
                    except Exception:
                        pass
                    def scale_up_menu():
                        try:
                            scroll_content.animate().alpha(1.0).scaleX(1.0).scaleY(1.0).translationY(0).setDuration(400).start()
                        except Exception:
                            pass
                        def show_elements():
                            try:
                                title_view.animate().alpha(1.0).translationY(0).scaleX(1.0).scaleY(1.0).setDuration(350).start()
                            except Exception:
                                pass
                            try:
                                changelog_container.animate().alpha(1.0).translationY(0).scaleX(1.0).scaleY(1.0).setDuration(350).setStartDelay(50).start()
                            except Exception:
                                pass
                            try:
                                changelog_link_btn.animate().alpha(1.0).translationY(0).scaleX(1.0).scaleY(1.0).setDuration(350).setStartDelay(75).start()
                            except Exception:
                                pass
                            try:
                                update_btn_frame.animate().alpha(1.0).translationY(0).scaleX(1.0).scaleY(1.0).setDuration(350).setStartDelay(100).start()
                            except Exception:
                                pass
                        try:
                            run_on_ui_thread(show_elements)
                        except Exception:
                            pass
                    try:
                        from org.telegram.messenger import AndroidUtilities
                        from java import dynamic_proxy
                        from java.lang import Runnable
                        class ScaleUpRunnable(dynamic_proxy(Runnable)):
                            def __init__(self, func):
                                super().__init__()
                                self.func = func
                            def run(self):
                                self.func()
                        AndroidUtilities.runOnUIThread(ScaleUpRunnable(lambda: run_on_ui_thread(scale_up_menu)), 200)
                    except Exception:
                        try:
                            run_on_ui_thread(scale_up_menu)
                        except Exception:
                            pass
                except Exception:
                    pass
            try:
                run_on_ui_thread(animate_elements)
            except Exception:
                pass
        except Exception as e:
            pass
    
    def _download_and_install_update(self):
        try:
            from org.telegram.messenger import R as R_tg
            from ui.bulletin import BulletinHelper
            from com.exteragram.messenger.plugins import PluginsController, PluginsConstants
            from org.telegram.messenger import ApplicationLoader, Utilities
            from java import dynamic_proxy, jclass
            loading_bulletin = [None]
            def show_loading():
                loading_bulletin[0] = BulletinHelper.show_with_button(
                    "Обновление плагина Templates..." if self.lang == 'ru' else "Updating Templates plugin...",
                    R_tg.raw.download_progress,
                    "Закрыть" if self.lang == 'ru' else "Close",
                    lambda: None,
                    None
                )
            run_on_ui_thread(show_loading)
            callback_shown = [False]
            def download_thread():
                try:
                    if not self.download_url:
                        raise Exception("Download URL not available")
                    with urllib.request.urlopen(self.download_url, timeout=30) as response:
                        plugin_content = response.read()
                    plugins_dir = os.path.join(str(ApplicationLoader.applicationContext.getFilesDir()), "plugins")
                    temp_file = os.path.join(plugins_dir, "templates_update.tmp")
                    with open(temp_file, 'wb') as f:
                        f.write(plugin_content)
                    version = self.latest_version
                    class Callback(dynamic_proxy(Utilities.Callback)):
                        def run(self_cb, error):
                            if callback_shown[0]:
                                return
                            callback_shown[0] = True
                            try:
                                os.remove(temp_file)
                            except:
                                pass
                            if error:
                                run_on_ui_thread(lambda: BulletinHelper.show_with_button(
                                    "Плагин Templates не удалось обновить." if self.lang == 'ru' else "Failed to update Templates plugin.",
                                    R_tg.raw.error,
                                    "Закрыть" if self.lang == 'ru' else "Close",
                                    lambda: None,
                                    None
                                ))
                            else:
                                run_on_ui_thread(lambda: BulletinHelper.show_with_button(
                                    "Плагин Templates успешно обновлён!" if self.lang == 'ru' else "Templates plugin updated successfully!",
                                    R_tg.raw.done,
                                    "Закрыть" if self.lang == 'ru' else "Close",
                                    lambda: None,
                                    None
                                ))
                    class Runnable(dynamic_proxy(jclass("java.lang.Runnable"))):
                        def run(self_r):
                            PluginsController.engines.get(PluginsConstants.PYTHON).loadPluginFromFile(temp_file, None, Callback())
                    Utilities.pluginsQueue.postRunnable(Runnable())
                except Exception as e:
                    if not callback_shown[0]:
                        callback_shown[0] = True
                        run_on_ui_thread(lambda: BulletinHelper.show_with_button(
                            "Плагин Templates не удалось обновить." if self.lang == 'ru' else "Failed to update Templates plugin.",
                            R_tg.raw.error,
                            "Закрыть" if self.lang == 'ru' else "Close",
                            lambda: None,
                            None
                        ))
            threading.Thread(target=download_thread, daemon=True).start()
            threading.Thread(target=download_thread, daemon=True).start()
        except Exception as e:
            pass

    def _show_version_dialog(self, _):
        self._force_load_stickers()
        from org.telegram.ui.ActionBar import BottomSheet, Theme
        from android.widget import LinearLayout, TextView, ScrollView, FrameLayout
        from android.view import Gravity, View
        from android.util import TypedValue
        from org.telegram.ui.Components import LayoutHelper, BackupImageView
        from org.telegram.messenger import AndroidUtilities, MediaDataController, ImageLocation
        from android.graphics.drawable import GradientDrawable
        from android.graphics import Color
        from android_utils import OnClickListener, run_on_ui_thread
        from client_utils import get_last_fragment
        from org.telegram.messenger.browser import Browser
        from android.net import Uri
        frag = get_last_fragment()
        act = frag.getParentActivity() if frag else None
        if not act:
            return
        sheet = BottomSheet(act, False)
        root_layout = LinearLayout(act)
        root_layout.setOrientation(LinearLayout.VERTICAL)
        root_layout.setPadding(AndroidUtilities.dp(20), AndroidUtilities.dp(16), AndroidUtilities.dp(20), AndroidUtilities.dp(8))
        try:
            root_layout.setAlpha(0.0)
            root_layout.setScaleX(0.3)
            root_layout.setScaleY(0.3)
            root_layout.setTranslationY(AndroidUtilities.dp(100))
        except Exception:
            pass
        try:
            root_layout.setBackgroundColor(Theme.getColor(Theme.key_dialogBackground))
        except Exception:
            pass
        try:
            avatar_view = BackupImageView(act)
            avatar_view.setRoundRadius(AndroidUtilities.dp(45))
            root_layout.addView(avatar_view, LayoutHelper.createLinear(130, 130, Gravity.CENTER_HORIZONTAL, 0, 0, 0, 12))
            self.load_sticker_with_fallback(avatar_view, "mr_vestr/1", 1, "90_90")
        except Exception:
            pass
        title_view = TextView(act)
        title_view.setTypeface(AndroidUtilities.bold())
        title_view.setGravity(Gravity.CENTER)
        title_view.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 24)
        title_view.setText(t('current_version', lang=self.lang, version=__version__))
        try:
            title_view.setTextColor(Theme.getColor(Theme.key_dialogTextBlack))
        except Exception:
            pass
        try:
            title_view.setAlpha(0.0)
            title_view.setTranslationY(AndroidUtilities.dp(50))
            title_view.setScaleX(0.8)
            title_view.setScaleY(0.8)
        except Exception:
            pass
        root_layout.addView(title_view, LayoutHelper.createLinear(-1, -2, Gravity.CENTER, 0, 0, 0, 12))
        body_scroll = ScrollView(act)
        body_scroll.setVerticalScrollBarEnabled(False)
        body_scroll.setPadding(AndroidUtilities.dp(4), 0, AndroidUtilities.dp(4), 0)
        try:
            body_scroll.setNestedScrollingEnabled(True)
        except Exception:
            pass
        try:
            body_scroll.setAlpha(0.0)
            body_scroll.setTranslationY(AndroidUtilities.dp(30))
            body_scroll.setScaleX(0.8)
            body_scroll.setScaleY(0.8)
        except Exception:
            pass
        body_tv = TextView(act)
        body_tv.setText(t('updates_info', lang=self.lang))
        body_tv.setTextIsSelectable(True)
        body_tv.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 15)
        body_tv.setGravity(Gravity.CENTER)
        try:
            body_tv.setTextColor(Theme.getColor(Theme.key_dialogTextBlack))
        except Exception:
            pass
        try:
            body_tv.setLineSpacing(AndroidUtilities.dp(4), 1.15)
        except Exception:
            pass
        body_scroll.addView(body_tv)
        root_layout.addView(body_scroll, LayoutHelper.createLinear(-1, 0, 1.0))
        divider = View(act)
        try:
            divider_color = Theme.getColor(Theme.key_divider)
        except Exception:
            divider_color = Color.parseColor("#E0E0E0")
        divider.setBackgroundColor(divider_color)
        root_layout.addView(divider, LayoutHelper.createLinear(-1, 1, 0, 16, 0, 12))
        check_btn_frame = FrameLayout(act)
        try:
            base_color = Theme.getColor(Theme.key_featuredStickers_addButton)
        except Exception:
            base_color = Theme.getColor(Theme.key_dialogTextBlue)
        try:
            pressed_color = Theme.getColor(Theme.key_featuredStickers_addButtonPressed)
        except Exception:
            pressed_color = base_color
        check_btn_frame.setBackground(Theme.createSimpleSelectorRoundRectDrawable(
            AndroidUtilities.dp(28),
            base_color,
            pressed_color
        ))
        check_btn_frame.setPadding(0, AndroidUtilities.dp(14), 0, AndroidUtilities.dp(14))
        check_btn_frame.setClickable(True)
        check_btn_frame.setFocusable(True)
        check_btn_text = TextView(act)
        check_btn_text.setText(t('check_updates', lang=self.lang))
        check_btn_text.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 16)
        check_btn_text.setTypeface(AndroidUtilities.bold())
        check_btn_text.setGravity(Gravity.CENTER)
        check_btn_text.setTextColor(Theme.getColor(Theme.key_featuredStickers_buttonText))
        check_btn_frame.addView(check_btn_text, FrameLayout.LayoutParams(-1, -2))
        def on_check(v):
            try:
                sheet.dismiss()
                self._check_for_updates(show_loading=True)
            except Exception:
                pass
        check_btn_frame.setOnClickListener(OnClickListener(lambda *_: on_check(check_btn_frame)))
        self._apply_press_scale(check_btn_frame)
        try:
            check_btn_frame.setAlpha(0.0)
            check_btn_frame.setTranslationY(AndroidUtilities.dp(50))
            check_btn_frame.setScaleX(0.8)
            check_btn_frame.setScaleY(0.8)
        except Exception:
            pass
        root_layout.addView(check_btn_frame, LayoutHelper.createLinear(-1, -2, 0, 8, 0, 0))
        sheet.setCustomView(root_layout)
        sheet.show()
        def animate_elements():
            try:
                try:
                    root_layout.animate().alpha(0.8).scaleX(0.4).scaleY(0.4).translationY(AndroidUtilities.dp(50)).setDuration(200).start()
                except Exception:
                    pass
                def scale_up_menu():
                    try:
                        root_layout.animate().alpha(1.0).scaleX(1.0).scaleY(1.0).translationY(0).setDuration(400).start()
                    except Exception:
                        pass
                    def show_elements():
                        try:
                            title_view.animate().alpha(1.0).translationY(0).scaleX(1.0).scaleY(1.0).setDuration(350).start()
                        except Exception:
                            pass
                        try:
                            body_scroll.animate().alpha(1.0).translationY(0).scaleX(1.0).scaleY(1.0).setDuration(350).setStartDelay(50).start()
                        except Exception:
                            pass
                        try:
                            check_btn_frame.animate().alpha(1.0).translationY(0).scaleX(1.0).scaleY(1.0).setDuration(350).setStartDelay(100).start()
                        except Exception:
                            pass
                    try:
                        run_on_ui_thread(show_elements)
                    except Exception:
                        pass
                try:
                    from org.telegram.messenger import AndroidUtilities
                    from java import dynamic_proxy
                    from java.lang import Runnable
                    class ScaleUpRunnable(dynamic_proxy(Runnable)):
                        def __init__(self, func):
                            super().__init__()
                            self.func = func
                        def run(self):
                            self.func()
                    AndroidUtilities.runOnUIThread(ScaleUpRunnable(lambda: run_on_ui_thread(scale_up_menu)), 200)
                except Exception:
                    try:
                        run_on_ui_thread(scale_up_menu)
                    except Exception:
                        pass
            except Exception:
                pass
        try:
            run_on_ui_thread(animate_elements)
        except Exception:
            pass

    def _show_reset_templates_dialog(self, _):
        pass

    def _reset_templates(self):
        pass

    def create_settings(self):
        self.templates = []
        for i in range(TEMPLATE_COUNT):
            name = self.get_setting(f"template_name_{i}", "")
            text = self.get_setting(f"template_text_{i}", "")
            self.templates.append({
                "name": name,
                "text": text,
                "enabled": True if i == 0 else bool(name and text)
            })
        settings = []
        settings.append(Header(text=t('settings', lang=self.lang)))
        settings.append(Switch(
            key='show_chat_menu',
            text=t('chat_menu', lang=self.lang),
            default=self.get_setting('show_chat_menu', True),
            subtext=t('chat_menu_sub', lang=self.lang),
            on_change=self._on_chat_switch,
            link_alias='show_chat_menu'
        ))
        settings.append(Switch(
            key='show_drawer_menu',
            text=t('drawer_menu', lang=self.lang),
            default=self.get_setting('show_drawer_menu', False),
            subtext=t('drawer_menu_sub', lang=self.lang),
            on_change=self._on_drawer_switch,
            link_alias='show_drawer_menu'
        ))
        settings.append(Switch(
            key='show_chat_plugins_menu',
            text=t('chat_plugins_menu', lang=self.lang),
            default=self.get_setting('show_chat_plugins_menu', False),
            subtext=t('chat_plugins_menu_sub', lang=self.lang),
            on_change=self._on_chat_plugins_switch,
            link_alias='show_chat_plugins_menu'
        ))
        settings.append(Input(
            key='send_cmd',
            text=t('send_cmd', lang=self.lang),
            default=self.get_setting('send_cmd', '//'),
            subtext=t('send_cmd_sub', lang=self.lang),
            link_alias='send_cmd'
        ))
        settings.append(Divider())
        settings.append(Header(text=t('templates_title', lang=self.lang)))
        settings.append(Text(
            text=t('create_template', lang=self.lang),
            icon='msg_addbot',
            accent=True,
            on_click=lambda ctx: self._create_new_template()
        ))
        settings.append(Text(
            text=t('export_templates', lang=self.lang),
            icon='msg_unarchive',
            accent=False,
            on_click=lambda ctx: self._show_export_bottom_sheet()
        ))
        if not self.get_setting('templates_visible', True):
            settings.append(Divider())
            settings.append(Text(
                text=t('refresh_templates', lang=self.lang),
                icon='msg_retry',
                accent=True
            ))
        settings.append(Divider())
        created_count = self._get_created_count()
        show_templates = created_count > 0 and self.get_setting('templates_visible', True)
        if show_templates:
            for i in range(created_count):
                tpl = self.templates[i] if i < len(self.templates) else {}
                name = tpl.get("name", "")
                text = tpl.get("text", "")
                settings.append(Header(text=t('template_n', lang=self.lang, n=i+1)))
                settings.append(Input(
                    key=f"template_name_{i}",
                    text=t('name', lang=self.lang),
                    default=name,
                    subtext=t('template_name_sub', lang=self.lang),
                    icon="msg_edit",
                    on_change=self._make_onchange(i, 'name'),
                    on_long_click=(lambda idx=i: (lambda v: self._on_input_long_click(idx, 'name', v)))()
                ))
                settings.append(Input(
                    key=f"template_text_{i}",
                    text=t('text', lang=self.lang),
                    default=text,
                    subtext=t('template_text_sub', lang=self.lang),
                    icon="msg_edit",
                    on_change=self._make_onchange(i, 'text'),
                    on_long_click=(lambda idx=i: (lambda v: self._on_input_long_click(idx, 'text', v)))()
                ))
                settings.append(Text(
                    text=t('send_template', lang=self.lang),
                    icon='msg_send',
                    accent=True,
                    on_click=lambda ctx, idx=i: self._send_template_by_index(idx)
                ))
                if created_count > 1:
                    settings.append(Text(
                        text=t('delete_template', lang=self.lang),
                        icon='msg_delete',
                        red=True,
                        on_click=(lambda idx=i: (lambda ctx: self._delete_template(idx)))()
                    ))
                settings.append(Divider())
        settings.append(Header(text=t('contacts', lang=self.lang)))
        settings.append(Text(
            text=t('support_me', lang=self.lang),
            icon='menu_feature_reactions',
            accent=True,
            on_click=self._show_support_me_menu,
            link_alias='support_me'
        ))
        settings.append(Text(
            text=t('channel_1', lang=self.lang),
            icon='msg_channel',
            accent=False,
            on_click=self._open_channel_link,
            on_long_click=self._copy_channel_link
        ))
        settings.append(Text(
            text=t('personal_1', lang=self.lang),
            icon='msg_contacts',
            on_click=self._open_personal_link,
            on_long_click=self._copy_personal_link
        ))
        settings.append(Divider())
        settings.append(Header(text=t('other', lang=self.lang)))
        settings.append(Text(
            text=t('how_it_works', lang=self.lang),
            icon='msg_info',
            on_click=self._show_how_it_works,
            link_alias='how_it_works'
        ))
        settings.append(Text(
            text=t('plugin_version', lang=self.lang),
            icon='msg_settings_14',
            accent=True,
            on_click=self._show_version_dialog,
            link_alias='plugin_version'
        ))
        settings.append(Divider())
        settings.append(Divider())
        return settings

    def _on_drawer_switch(self, val):
        self.set_setting('show_drawer_menu', bool(val), reload_settings=True)
        run_on_ui_thread(self._update_drawer_menu)

    def _on_chat_switch(self, val):
        self.set_setting('show_chat_menu', bool(val), reload_settings=True)
        run_on_ui_thread(self._update_chat_menu)

    def _on_chat_plugins_switch(self, val):
        self.set_setting('show_chat_plugins_menu', bool(val), reload_settings=True)
        run_on_ui_thread(self._update_chat_plugins_menu)

    def _make_enabled_onchange(self, idx):
        return lambda val: None

    def _make_onchange(self, idx, field):
        def handler(val):
            val = val.strip()
            tpl = self.templates[idx] if idx < len(self.templates) else {}
            tpl = tpl.copy()
            tpl[field] = val
            if field == 'name' and val:
                for i, other_tpl in enumerate(self.templates):
                    if i != idx and other_tpl.get('name', '').strip() == val:
                        from ui.bulletin import BulletinHelper
                        from android_utils import run_on_ui_thread
                        from org.telegram.messenger import R as R_tg
                        run_on_ui_thread(lambda: BulletinHelper.show_with_button(
                            t('template_name_exists', lang=self.lang),
                            R_tg.raw.error,
                            t('close', lang=self.lang),
                            lambda: None,
                            None
                        ))
                        tpl['enabled'] = False
                        self.templates[idx] = tpl
                        self.set_setting("templates", self.templates, reload_settings=True)
                        return
            if field == 'name' or field == 'text':
                tpl['enabled'] = bool(tpl.get('name', '') and tpl.get('text', ''))
            self.templates[idx] = tpl
            self.set_setting("templates", self.templates, reload_settings=True)
        return handler

    def _on_input_long_click(self, idx, field, view):
        try:
            from client_utils import get_last_fragment
            from android_utils import run_on_ui_thread
            run_on_ui_thread(lambda: self._show_long_click_popup(idx, field, view))
        except Exception:
            pass
    
    def _show_long_click_popup(self, idx, field, anchor_view):
        try:
            from client_utils import get_last_fragment
            from org.telegram.ui.ActionBar import ActionBarPopupWindow, Theme
            from org.telegram.ui.Components import LayoutHelper
            from org.telegram.messenger import AndroidUtilities, R
            from android.view import View, Gravity
            from android.widget import FrameLayout, LinearLayout, TextView, ImageView
            from androidx.core.content import ContextCompat
            fragment = get_last_fragment()
            if not fragment:
                return
            context = fragment.getParentActivity()
            if not context:
                return
            popup_layout = ActionBarPopupWindow.ActionBarPopupWindowLayout(context)
            popup_layout.setBackgroundColor(Theme.getColor(Theme.key_actionBarDefaultSubmenuBackground))
            popup_layout.setFitItems(True)
            def create_menu_item(icon_res: int, title: str, on_click_action, is_clear=False):
                from android.graphics.drawable import GradientDrawable
                from android.graphics import Color, PorterDuff
                from android.content.res import ColorStateList
                from android.graphics.drawable import RippleDrawable
                item_frame = FrameLayout(context)
                item_frame.setMinimumWidth(AndroidUtilities.dp(160))
                item_frame.setClickable(True)
                item_frame.setFocusable(True)
                try:
                    try:
                        try:
                            bg_color = Theme.getColor(Theme.key_dialogBackgroundGray) & 0x20FFFFFF | 0x10000000
                        except Exception:
                            try:
                                bg_color = Theme.getColor(Theme.key_windowBackgroundGray) & 0x20FFFFFF | 0x10000000
                            except Exception:
                                bg_color = Color.parseColor("#F0F0F0")
                    except Exception:
                        bg_color = Color.parseColor("#F0F0F0")
                    try:
                        pressed_color = Theme.getColor(Theme.key_listSelector) & 0x40FFFFFF | 0x30000000
                    except Exception:
                        pressed_color = Color.parseColor("#D0D0D0")
                    btn_bg = GradientDrawable()
                    btn_bg.setCornerRadius(AndroidUtilities.dp(10))
                    btn_bg.setColor(bg_color)
                    try:
                        ripple_color = ColorStateList.valueOf(Color.parseColor("#40000000"))
                        pressed_bg = GradientDrawable()
                        pressed_bg.setCornerRadius(AndroidUtilities.dp(10))
                        pressed_bg.setColor(pressed_color)
                        ripple_drawable = RippleDrawable(ripple_color, btn_bg, pressed_bg)
                        item_frame.setBackground(ripple_drawable)
                    except Exception:
                        try:
                            item_frame.setBackground(Theme.createSimpleSelectorRoundRectDrawable(
                                AndroidUtilities.dp(10),
                                bg_color,
                                pressed_color
                            ))
                        except Exception:
                            item_frame.setBackground(btn_bg)
                except Exception:
                    item_frame.setBackground(Theme.createSelectorDrawable(Theme.getColor(Theme.key_listSelector), 2))
                item_content = LinearLayout(context)
                item_content.setOrientation(LinearLayout.HORIZONTAL)
                item_content.setGravity(Gravity.CENTER_VERTICAL)
                item_content.setPadding(AndroidUtilities.dp(16), AndroidUtilities.dp(12), AndroidUtilities.dp(16), AndroidUtilities.dp(12))
                icon = ImageView(context)
                icon.setScaleType(ImageView.ScaleType.CENTER)
                try:
                    icon_drawable = ContextCompat.getDrawable(context, icon_res)
                    if is_clear:
                        try:
                            red_color = Theme.getColor(Theme.key_text_RedRegular)
                        except Exception:
                            red_color = Color.parseColor("#FF3B30")
                        icon_drawable.setColorFilter(red_color, PorterDuff.Mode.SRC_IN)
                    else:
                        try:
                            gray_color = Theme.getColor(Theme.key_dialogTextGray)
                        except Exception:
                            gray_color = Color.parseColor("#808080")
                        icon_drawable.setColorFilter(gray_color, PorterDuff.Mode.SRC_IN)
                    icon.setImageDrawable(icon_drawable)
                except Exception:
                    icon.setImageResource(icon_res)
                item_content.addView(icon, LayoutHelper.createLinear(24, 24, Gravity.CENTER_VERTICAL, 0, 0, 12, 0))
                title_tv = TextView(context)
                title_tv.setText(title)
                title_tv.setTextSize(14)
                try:
                    if is_clear:
                        try:
                            red_color = Theme.getColor(Theme.key_text_RedRegular)
                        except Exception:
                            red_color = Color.parseColor("#FF3B30")
                        title_tv.setTextColor(red_color)
                    else:
                        title_tv.setTextColor(Theme.getColor(Theme.key_actionBarDefaultSubmenuItem))
                except Exception:
                    pass
                item_content.addView(title_tv, LayoutHelper.createLinear(-1, -2, 1.0, Gravity.CENTER_VERTICAL))
                item_frame.addView(item_content)
                return item_frame, on_click_action
            
            def do_copy():
                try:
                    from android.content import ClipboardManager, ClipData
                    clipboard = context.getSystemService(context.CLIPBOARD_SERVICE)
                    tpl = self.templates[idx] if idx < len(self.templates) else {}
                    field_content = tpl.get(field, '')
                    clipboard.setPrimaryClip(ClipData.newPlainText("template", field_content))
                    
                    from ui.bulletin import BulletinHelper
                    try:
                        from org.telegram.messenger import R as R_tg
                        icon_attr = getattr(R_tg.raw, 'copy', None)
                    except Exception:
                        icon_attr = None
                    BulletinHelper.show_with_button(t('copied_to_clipboard', lang=self.lang), icon_attr if icon_attr else 0, t('close', lang=self.lang), lambda: None, None)
                except Exception:
                    pass
            
            def do_clear():
                try:
                    from ui.alert import AlertDialogBuilder
                    from client_utils import get_last_fragment
                    frag = get_last_fragment()
                    act = frag.getParentActivity() if frag else None
                    if not act:
                        return
                    builder = AlertDialogBuilder(act)
                    builder.set_title(t('clear_field_title', lang=self.lang))
                    if field == 'name':
                        builder.set_message(t('clear_field_name_confirm', lang=self.lang, n=idx+1))
                    else:
                        builder.set_message(t('clear_field_text_confirm', lang=self.lang, n=idx+1))
                    def on_yes(b, w):
                        try:
                            tpl = self.templates[idx] if idx < len(self.templates) else {}
                            tpl = tpl.copy()
                            tpl[field] = ''
                            self.set_setting(f"template_{field}_{idx}", '', reload_settings=True)
                            tpl['enabled'] = bool(tpl.get('name', '') and tpl.get('text', ''))
                            self.templates[idx] = tpl
                            self.set_setting("templates", self.templates, reload_settings=True)
                            try:
                                from ui.bulletin import BulletinHelper
                                from org.telegram.messenger import R as R_tg
                                icon_attr = getattr(R_tg.raw, 'done', None)
                                if field == 'name':
                                    message = t('template_name_cleared', lang=self.lang, n=idx+1)
                                else:
                                    message = t('template_text_cleared', lang=self.lang, n=idx+1)
                                BulletinHelper.show_success(message)
                            except Exception:
                                pass
                        finally:
                            b.dismiss()
                    builder.set_positive_button(t('clear', lang=self.lang), on_yes)
                    builder.set_negative_button(t('close', lang=self.lang), lambda b, w: b.dismiss())
                    try:
                        builder.make_button_red(AlertDialogBuilder.BUTTON_POSITIVE)
                    except Exception:
                        pass
                    builder.show()
                except Exception:
                    pass
            menu_items = [
                (R.drawable.msg_copy, t('copy', lang=self.lang), do_copy, False),
                (R.drawable.msg_delete, t('clear', lang=self.lang), do_clear, True),
            ]
            popup_window_ref = [None]
            for icon_res, title, action, is_clear in menu_items:
                item_view, on_click_action = create_menu_item(icon_res, title, action, is_clear)
                item_view.setOnClickListener(OnClickListener(lambda *_args, act=on_click_action, pw_ref=popup_window_ref: (
                    pw_ref[0].dismiss() if pw_ref[0] else None,
                    act()
                )))
                popup_layout.addView(item_view, LayoutHelper.createLinear(-1, -2))
            popup_window = ActionBarPopupWindow(
                popup_layout,
                -2,
                -2
            )
            popup_window_ref[0] = popup_window
            popup_window.setOutsideTouchable(True)
            popup_window.setClippingEnabled(True)
            popup_window.setAnimationStyle(R.style.PopupContextAnimation)
            popup_window.setFocusable(True)
            popup_layout.measure(
                View.MeasureSpec.makeMeasureSpec(AndroidUtilities.dp(1000), View.MeasureSpec.AT_MOST),
                View.MeasureSpec.makeMeasureSpec(AndroidUtilities.dp(1000), View.MeasureSpec.AT_MOST)
            )
            if anchor_view:
                location = [0, 0]
                anchor_view.getLocationInWindow(location)
                fragment_view = fragment.getFragmentView()
                root_view = anchor_view.getRootView()
                if fragment_view:
                    popup_width = popup_layout.getMeasuredWidth()
                    popup_height = popup_layout.getMeasuredHeight()
                    fragment_width = fragment_view.getWidth()
                    fragment_height = fragment_view.getHeight()
                    if AndroidUtilities.isTablet():
                        popup_x = location[0] + anchor_view.getWidth() + AndroidUtilities.dp(8)
                        if popup_x + popup_width > location[0] + fragment_width:
                            popup_x = location[0] - popup_width - AndroidUtilities.dp(8)
                    else:
                        popup_x = location[0] + anchor_view.getWidth() - popup_width
                    popup_y = location[1] + anchor_view.getHeight()
                    window_width = root_view.getWidth()
                    window_height = root_view.getHeight()
                    if popup_x < 0:
                        popup_x = AndroidUtilities.dp(8)
                    elif popup_x + popup_width > window_width:
                        popup_x = window_width - popup_width - AndroidUtilities.dp(8)
                    if popup_y + popup_height > window_height:
                        popup_y = location[1] - popup_height
                else:
                    popup_x = location[0] + anchor_view.getWidth() - popup_layout.getMeasuredWidth()
                    popup_y = location[1] + anchor_view.getHeight()
                popup_window.showAtLocation(
                    root_view,
                    Gravity.TOP | Gravity.LEFT,
                    popup_x,
                    popup_y
                )
                popup_window.dimBehind()
        except Exception:
            pass

    def _make_link_onclick(self):
        return lambda ctx: run_on_ui_thread(self.open_mr_vestr_link)

    def save_template(self, idx, val):
        val = val.strip()
        if ":" in val:
            name, text = map(str.strip, val.split(":", 1))
        else:
            name, text = val, ""
        self.templates[idx] = {"name": name, "text": text, "enabled": bool(name and text)}
        self.set_setting("templates", self.templates, reload_settings=True)

    def _create_new_template(self):
        try:
            last_idx = self._get_created_count() - 1
            last_tpl = self.templates[last_idx] if last_idx < len(self.templates) else {}
            if not last_tpl.get("name") or not last_tpl.get("text"):
                from ui.bulletin import BulletinHelper
                from android_utils import run_on_ui_thread
                run_on_ui_thread(lambda: BulletinHelper.show_error(t('fill_prev_template', lang=self.lang)))
                return
            new_count = min(self._get_created_count() + 1, TEMPLATE_COUNT)
            self.set_setting("templates_created_count", new_count, reload_settings=True)
            from ui.bulletin import BulletinHelper
            from android_utils import run_on_ui_thread
            run_on_ui_thread(lambda: BulletinHelper.show_success(t('template_created_n', lang=self.lang, n=new_count)))
        except Exception as e:
            from ui.bulletin import BulletinHelper
            BulletinHelper.show_error(t('error_occurred_with_reason', lang=self.lang, error=str(e)))

    def _templates_count(self):
        cnt = 0
        for tpl in self.templates:
            if tpl.get("name") or tpl.get("text"):
                cnt += 1
        return cnt

    def _get_created_count(self):
        count = self.get_setting("templates_created_count", 1)
        if not isinstance(count, int) or count < 1:
            count = 1
        return min(count, TEMPLATE_COUNT)

    def _delete_template(self, idx):
        try:
            from ui.alert import AlertDialogBuilder
            from client_utils import get_last_fragment
            frag = get_last_fragment()
            act = frag.getParentActivity() if frag else None
            if not act:
                return
            builder = AlertDialogBuilder(act)
            builder.set_title(t('delete_template_title', lang=self.lang))
            builder.set_message(t('delete_template_confirm', lang=self.lang, n=idx+1))
            def on_yes(b, w):
                try:
                    old_count = self._get_created_count()
                    old_templates = [dict(t) for t in self.templates]
                    current_count = self._get_created_count()
                    if current_count <= 1:
                        self.templates[0] = {"name": "", "text": "", "enabled": False}
                        self.set_setting("template_name_0", "")
                        self.set_setting("template_text_0", "")
                        self.set_setting("templates_created_count", 1)
                    else:
                        if idx < current_count - 1:
                            for i in range(idx, current_count - 1):
                                self.templates[i] = dict(self.templates[i + 1])
                                self.templates[i]['enabled'] = bool(self.templates[i].get('name', '') and self.templates[i].get('text', ''))
                                self.set_setting(f"template_name_{i}", self.templates[i].get("name", ""))
                                self.set_setting(f"template_text_{i}", self.templates[i].get("text", ""))
                        last_created = current_count - 1
                        self.templates[last_created] = {"name": "", "text": "", "enabled": False}
                        self.set_setting(f"template_name_{last_created}", "")
                        self.set_setting(f"template_text_{last_created}", "")
                        self.set_setting("templates_created_count", current_count - 1)
                    self.set_setting("templates", self.templates, reload_settings=False)
                    self.set_setting('templates_visible', False, reload_settings=True)
                    from android_utils import run_on_ui_thread
                    from ui.bulletin import BulletinHelper
                    deleted_number = idx + 1
                    def on_undo():
                        try:
                            self.templates = [dict(t) for t in old_templates]
                            self.set_setting("templates_created_count", old_count)
                            for i in range(min(old_count, TEMPLATE_COUNT)):
                                tpl = self.templates[i] if i < len(self.templates) else {}
                                self.set_setting(f"template_name_{i}", tpl.get("name", ""))
                                self.set_setting(f"template_text_{i}", tpl.get("text", ""))
                            self.set_setting("templates", self.templates, reload_settings=False)
                            self.set_setting('templates_visible', True, reload_settings=True)
                        except Exception:
                            pass
                    try:
                        from org.telegram.messenger import R as R_tg
                        icon_attr = getattr(R_tg.raw, 'done', None)
                    except Exception:
                        icon_attr = None
                    try:
                        run_on_ui_thread(lambda: BulletinHelper.show_success(t('template_deleted_n', lang=self.lang, n=deleted_number)))
                    except Exception:
                        pass
                    def restore_ui():
                        try:
                            self.set_setting('templates_visible', True, reload_settings=True)
                            try:
                                from client_utils import get_last_fragment
                                frag = get_last_fragment()
                                if frag:
                                    frag.rebuildAllFragments(True)
                            except Exception:
                                pass
                        except Exception:
                            pass
                    run_on_ui_thread(lambda: run_on_ui_thread(restore_ui, 1000))
                finally:
                    b.dismiss()
            builder.set_positive_button(t('delete_button', lang=self.lang), on_yes)
            builder.set_negative_button(t('close', lang=self.lang), lambda b, w: b.dismiss())
            try:
                builder.make_button_red(AlertDialogBuilder.BUTTON_POSITIVE)
            except Exception:
                pass
            builder.show()
        except Exception as e:
            from ui.bulletin import BulletinHelper
            BulletinHelper.show_error(t('error_occurred_with_reason', lang=self.lang, error=str(e)))

    def _refresh_templates_ui(self):
        try:
            self.set_setting('templates_visible', True, reload_settings=True)
            from ui.bulletin import BulletinHelper
            from android_utils import run_on_ui_thread
            run_on_ui_thread(lambda: BulletinHelper.show_success(t('templates_updated', lang=self.lang) if 'templates_updated' in LANG[self.lang] else "Templates updated"))
        except Exception as e:
            from ui.bulletin import BulletinHelper
            BulletinHelper.show_error(f"Error: {str(e)}")

    def open_mr_vestr_link(self):
        from client_utils import get_last_fragment
        from android.content import Intent, Uri
        fragment = get_last_fragment()
        activity = fragment and fragment.getParentActivity()
        if not activity:
            return
        intent = Intent(Intent.ACTION_VIEW)
        intent.setData(Uri.parse("https://t.me/mr_vestr"))
        activity.startActivity(intent)

    def edit_template_dialog(self, idx):
        from ui.alert import AlertDialogBuilder
        from client_utils import get_last_fragment
        fragment = get_last_fragment()
        activity = fragment and fragment.getParentActivity()
        if not activity:
            return
        builder = AlertDialogBuilder(activity)
        builder.set_title(t('edit_template', lang=self.lang, n=idx+1))
        from android.widget import LinearLayout, EditText
        nameEdit = EditText(activity)
        nameEdit.setText(self.templates[idx].get("name", ""))
        nameEdit.setHint(t('template_name', lang=self.lang))
        textEdit = EditText(activity)
        textEdit.setText(self.templates[idx].get("text", ""))
        textEdit.setHint(t('template_text', lang=self.lang))
        layout = LinearLayout(activity)
        layout.setOrientation(LinearLayout.VERTICAL)
        layout.addView(nameEdit)
        layout.addView(textEdit)
        builder.set_view(layout)
        def on_done(b, w):
            name = str(nameEdit.getText()).strip()
            text = str(textEdit.getText()).strip()
            self.templates[idx] = {"name": name, "text": text, "enabled": bool(name and text)}
            self.set_setting("templates", self.templates, reload_settings=True)
            b.dismiss()
        builder.set_positive_button(t('save', lang=self.lang), on_done)
        builder.set_negative_button(t('cancel', lang=self.lang), lambda b, w: b.dismiss())
        builder.show()

    def send_template(self, idx):
        pass

    def _open_share_link(self, url):
        from client_utils import get_last_fragment
        from android.content import Intent
        from android.net import Uri
        frag = get_last_fragment()
        act = frag.getParentActivity() if frag else None
        if act:
            act.startActivity(Intent(Intent.ACTION_VIEW, Uri.parse(url)))

    def _open_chat_by_dialog_id(self, dialog_id):
        try:
            from client_utils import get_last_fragment, get_messages_controller
            from android_utils import run_on_ui_thread
            try:
                did = int(dialog_id)
            except Exception:
                did = dialog_id
            fragment = get_last_fragment()
            if not fragment:
                return
            def _open():
                try:
                    get_messages_controller().openByChatId(did, fragment, 1)
                except Exception:
                    try:
                        from org.telegram.messenger.browser import Browser
                        mc = get_messages_controller()
                        username = None
                        if isinstance(did, int):
                            if did > 0:
                                try:
                                    user = mc.getUser(did)
                                except Exception:
                                    user = None
                                if user is not None and getattr(user, "username", None):
                                    username = user.username
                            else:
                                try:
                                    chat = mc.getChat(-did)
                                except Exception:
                                    chat = None
                                if chat is not None and getattr(chat, "username", None):
                                    username = chat.username
                        else:
                            if isinstance(did, str) and did:
                                username = did
                        if username:
                            Browser.openUrl(
                                fragment.getParentActivity(),
                                f"tg://resolve?domain={username}"
                            )
                        elif isinstance(did, int) and did > 0:
                            Browser.openUrl(
                                fragment.getParentActivity(),
                                f"tg://user?id={did}"
                            )
                        else:
                            if isinstance(did, int):
                                Browser.openUrl(
                                    fragment.getParentActivity(),
                                    f"tg://resolve?domain={abs(did)}"
                                )
                            else:
                                Browser.openUrl(
                                    fragment.getParentActivity(),
                                    f"tg://resolve?domain={did}"
                                )
                    except Exception:
                        pass
            run_on_ui_thread(_open)
        except Exception:
            pass

    def on_send_message_hook(self, account, params):
        if not hasattr(params, "message") or not isinstance(params.message, str):
            return HookResult(strategy=HookStrategy.NONE)
        msg = params.message.strip()
        send_cmd = self.get_setting('send_cmd', '//').strip()
        if not send_cmd:
            send_cmd = '//'
        if msg.lower().startswith(send_cmd.lower()):
            from ui.bulletin import BulletinHelper
            from android_utils import run_on_ui_thread
            msg_parts = msg.split(' ', 1)
            if len(msg_parts) == 1:
                run_on_ui_thread(lambda: self._show_template_popup_menu(None))
                return HookResult(strategy=HookStrategy.CANCEL)
            query = msg_parts[1].strip().lower()
            if not query:
                run_on_ui_thread(lambda: self._show_template_popup_menu(None))
                return HookResult(strategy=HookStrategy.CANCEL)
            for i, tpl in enumerate(self.templates):
                if tpl.get('enabled', False):
                    name = self.get_setting(f"template_name_{i}", "").strip()
                    text = self.get_setting(f"template_text_{i}", "").strip()
                    if name.lower() == query and text:
                        preprocessed = preprocess_template_markdown(text)
                        parsed = parse_markdown(preprocessed)
                        params.message = parsed.text
                        if hasattr(params, 'entities') and params.entities is not None:
                            params.entities.clear()
                        else:
                            from java.util import ArrayList
                            params.entities = ArrayList()
                        for ent in parsed.entities:
                            params.entities.add(ent.to_tlrpc_object())
                        try:
                            from org.telegram.messenger import R as R_tg
                            icon_attr = getattr(R_tg.raw, 'done', None)
                        except Exception:
                            icon_attr = None
                        dialog_id = None
                        try:
                            from client_utils import get_last_fragment
                            from org.telegram.ui import ChatActivity
                            frag = get_last_fragment()
                            if isinstance(frag, ChatActivity):
                                try:
                                    dialog_id = frag.getDialogId()
                                except Exception:
                                    dialog_id = None
                        except Exception:
                            dialog_id = None
                        def _open():
                            try:
                                if dialog_id:
                                    self._open_chat_by_dialog_id(dialog_id)
                            except Exception:
                                pass
                        run_on_ui_thread(lambda: BulletinHelper.show_success(t('template_n_sent', lang=self.lang, n=i+1)))
                        return HookResult(strategy=HookStrategy.MODIFY, params=params)
            matching_templates = []
            for i, tpl in enumerate(self.templates):
                if tpl.get('enabled', False):
                    name = self.get_setting(f"template_name_{i}", "").strip()
                    text = self.get_setting(f"template_text_{i}", "").strip()
                    if name.lower().startswith(query) and text:
                        matching_templates.append({
                            'index': i,
                            'name': name,
                            'text': text
                        })
            if matching_templates:
                run_on_ui_thread(lambda: self._show_filtered_template_menu(matching_templates))
                return HookResult(strategy=HookStrategy.CANCEL)
            else:
                run_on_ui_thread(lambda: self._show_template_popup_menu(None))
                return HookResult(strategy=HookStrategy.CANCEL)
        return HookResult(strategy=HookStrategy.NONE)

    def _send_template_by_index(self, idx):
        name = self.get_setting(f"template_name_{idx}", "").strip()
        text = self.get_setting(f"template_text_{idx}", "").strip()
        if not name or not text:
            from ui.bulletin import BulletinHelper
            from android_utils import run_on_ui_thread
            run_on_ui_thread(lambda: BulletinHelper.show_error(t('fill_all_fields', lang=self.lang)))
            return
        self._showDialogsActivity_for_template(idx, name, text)

    def _showDialogsActivity_for_template(self, idx, name, text):
        args = Bundle()
        args.putBoolean("onlySelect", True)
        args.putBoolean("checkCanWrite", True)
        args.putInt("dialogsType", 0)
        args.putBoolean("allowGlobalSearch", True)
        activity = DialogsActivity(args)
        def after_select(fragment, dids, message, param, notify, scheduleDate, topicsFragment):
            activity.finishFragment()
            if dids.isEmpty():
                return
            selected_id = dids.get(0).dialogId
            peer_id = int(str(selected_id))
            preprocessed = preprocess_template_markdown(text)
            parsed = parse_markdown(preprocessed)
            from client_utils import send_message
            send_message({
                "peer": peer_id,
                "message": parsed.text,
                "entities": [ent.to_tlrpc_object() for ent in parsed.entities]
            })
            from android_utils import run_on_ui_thread
            try:
                from org.telegram.messenger import R as R_tg
                icon_attr = getattr(R_tg.raw, 'done', None)
            except Exception:
                icon_attr = None
            def _open():
                try:
                    self._open_chat_by_dialog_id(peer_id)
                except Exception:
                    pass
            run_on_ui_thread(lambda: BulletinHelper.show_with_button(t('template_n_sent', lang=self.lang, n=idx+1), icon_attr if icon_attr else 0, t('open', lang=self.lang), _open, None))
        delegate = TemplateDialogsDelegate(after_select)
        activity.setDelegate(delegate)
        last_fragment = LaunchActivity.getLastFragment()
        if last_fragment:
            last_fragment.presentFragment(activity)

    def _show_support_me_menu(self, _):
        self._force_load_stickers()
        from org.telegram.ui.ActionBar import BottomSheet, Theme
        from android.widget import LinearLayout, TextView, ScrollView, FrameLayout, ImageView
        from android.view import Gravity, View
        from android.util import TypedValue
        from org.telegram.ui.Components import LayoutHelper, BackupImageView
        from org.telegram.messenger import AndroidUtilities, MediaDataController, ImageLocation
        from android.graphics.drawable import GradientDrawable
        from android.graphics import Color
        from android_utils import OnClickListener
        from client_utils import get_last_fragment
        frag = get_last_fragment()
        act = frag.getParentActivity() if frag else None
        if not act:
            return
        sheet = BottomSheet(act, False)
        root_layout = LinearLayout(act)
        root_layout.setOrientation(LinearLayout.VERTICAL)
        root_layout.setPadding(AndroidUtilities.dp(20), AndroidUtilities.dp(16), AndroidUtilities.dp(20), AndroidUtilities.dp(8))
        try:
            root_layout.setAlpha(0.0)
            root_layout.setScaleX(0.3)
            root_layout.setScaleY(0.3)
            root_layout.setTranslationY(AndroidUtilities.dp(100))
        except Exception:
            pass
        try:
            root_layout.setBackgroundColor(Theme.getColor(Theme.key_dialogBackground))
        except Exception:
            pass
        try:
            avatar_view = BackupImageView(act)
            avatar_view.setRoundRadius(AndroidUtilities.dp(45))
            root_layout.addView(avatar_view, LayoutHelper.createLinear(130, 130, Gravity.CENTER_HORIZONTAL, 0, 0, 0, 12))
            self.load_sticker_with_fallback(avatar_view, "mr_vestr/9", 9, "90_90")
        except Exception:
            pass
        title_view = TextView(act)
        title_view.setTypeface(AndroidUtilities.bold())
        title_view.setGravity(Gravity.CENTER)
        title_view.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 24)
        title_view.setText(t('support_me', lang=self.lang))
        try:
            title_view.setTextColor(Theme.getColor(Theme.key_dialogTextBlack))
        except Exception:
            pass
        try:
            title_view.setAlpha(0.0)
            title_view.setTranslationY(AndroidUtilities.dp(50))
            title_view.setScaleX(0.8)
            title_view.setScaleY(0.8)
        except Exception:
            pass
        root_layout.addView(title_view, LayoutHelper.createLinear(-1, -2, Gravity.CENTER, 0, 0, 0, 12))
        body_scroll = ScrollView(act)
        body_scroll.setVerticalScrollBarEnabled(False)
        body_scroll.setPadding(AndroidUtilities.dp(4), 0, AndroidUtilities.dp(4), 0)
        try:
            body_scroll.setNestedScrollingEnabled(True)
        except Exception:
            pass
        try:
            body_scroll.setAlpha(0.0)
            body_scroll.setTranslationY(AndroidUtilities.dp(30))
            body_scroll.setScaleX(0.8)
            body_scroll.setScaleY(0.8)
        except Exception:
            pass
        body_tv = TextView(act)
        body_tv.setText(t('support_me_text', lang=self.lang))
        body_tv.setTextIsSelectable(True)
        body_tv.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 15)
        body_tv.setGravity(Gravity.CENTER)
        try:
            body_tv.setTextColor(Theme.getColor(Theme.key_dialogTextBlack))
        except Exception:
            pass
        try:
            body_tv.setLineSpacing(AndroidUtilities.dp(4), 1.15)
        except Exception:
            pass
        body_scroll.addView(body_tv)
        root_layout.addView(body_scroll, LayoutHelper.createLinear(-1, 0, 1.0))
        divider = View(act)
        try:
            divider_color = Theme.getColor(Theme.key_divider)
        except Exception:
            divider_color = Color.parseColor("#E0E0E0")
        divider.setBackgroundColor(divider_color)
        root_layout.addView(divider, LayoutHelper.createLinear(-1, 1, 0, 16, 0, 12))
        support_btn_frame = FrameLayout(act)
        try:
            base_color = Theme.getColor(Theme.key_featuredStickers_addButton)
        except Exception:
            base_color = Theme.getColor(Theme.key_dialogTextBlue)
        try:
            pressed_color = Theme.getColor(Theme.key_featuredStickers_addButtonPressed)
        except Exception:
            pressed_color = base_color
        support_btn_frame.setBackground(Theme.createSimpleSelectorRoundRectDrawable(
            AndroidUtilities.dp(28),
            base_color,
            pressed_color
        ))
        support_btn_frame.setPadding(0, AndroidUtilities.dp(14), 0, AndroidUtilities.dp(14))
        support_btn_frame.setClickable(True)
        support_btn_frame.setFocusable(True)
        try:
            support_btn_frame.setAlpha(0.0)
            support_btn_frame.setTranslationY(AndroidUtilities.dp(50))
            support_btn_frame.setScaleX(0.8)
            support_btn_frame.setScaleY(0.8)
        except Exception:
            pass
        support_btn_text = TextView(act)
        support_btn_text.setText(t('support_me', lang=self.lang))
        support_btn_text.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 16)
        support_btn_text.setTypeface(AndroidUtilities.bold())
        support_btn_text.setGravity(Gravity.CENTER)
        support_btn_text.setTextColor(Theme.getColor(Theme.key_featuredStickers_buttonText))
        support_btn_frame.addView(support_btn_text, FrameLayout.LayoutParams(-1, -2))
        def on_support(v):
            try:
                sheet.dismiss()
                from org.telegram.ui import LaunchActivity
                from org.telegram.messenger import UserConfig
                from java.lang import Integer
                if not hasattr(LaunchActivity, 'instance') or LaunchActivity.instance is None:
                    return
                launch_activity = LaunchActivity.instance
                getSafeLastFragment_method = launch_activity.getClass().getDeclaredMethod("getSafeLastFragment")
                getSafeLastFragment_method.setAccessible(True)
                last_fragment = getSafeLastFragment_method.invoke(launch_activity)
                if last_fragment is None or last_fragment.getContext() is None:
                    return
                target_user_id = 2037728749
                current_account = UserConfig.selectedAccount
                from org.telegram.ui.Gifts import GiftSheet
                gift_sheet = GiftSheet(
                    last_fragment.getContext(),
                    current_account,
                    target_user_id,
                    None,
                    None
                )
                gift_sheet.show()
            except Exception:
                pass
        support_btn_frame.setOnClickListener(OnClickListener(lambda *_: on_support(support_btn_frame)))
        self._apply_press_scale(support_btn_frame)
        root_layout.addView(support_btn_frame, LayoutHelper.createLinear(-1, -2, 0, 8, 0, 0))
        sheet.setCustomView(root_layout)
        sheet.show()
        def animate_elements():
            try:
                try:
                    root_layout.animate().alpha(0.8).scaleX(0.4).scaleY(0.4).translationY(AndroidUtilities.dp(50)).setDuration(200).start()
                except Exception:
                    pass
                def scale_up_menu():
                    try:
                        root_layout.animate().alpha(1.0).scaleX(1.0).scaleY(1.0).translationY(0).setDuration(400).start()
                    except Exception:
                        pass
                    def show_elements():
                        try:
                            title_view.animate().alpha(1.0).translationY(0).scaleX(1.0).scaleY(1.0).setDuration(350).start()
                        except Exception:
                            pass
                        try:
                            body_scroll.animate().alpha(1.0).translationY(0).scaleX(1.0).scaleY(1.0).setDuration(350).setStartDelay(50).start()
                        except Exception:
                            pass
                        try:
                            support_btn_frame.animate().alpha(1.0).translationY(0).scaleX(1.0).scaleY(1.0).setDuration(350).setStartDelay(100).start()
                        except Exception:
                            pass
                    try:
                        run_on_ui_thread(show_elements)
                    except Exception:
                        pass
                try:
                    from org.telegram.messenger import AndroidUtilities
                    from java import dynamic_proxy
                    from java.lang import Runnable
                    class ScaleUpRunnable(dynamic_proxy(Runnable)):
                        def __init__(self, func):
                            super().__init__()
                            self.func = func
                        def run(self):
                            self.func()
                    AndroidUtilities.runOnUIThread(ScaleUpRunnable(lambda: run_on_ui_thread(scale_up_menu)), 200)
                except Exception:
                    try:
                        run_on_ui_thread(scale_up_menu)
                    except Exception:
                        pass
            except Exception:
                pass
        try:
            run_on_ui_thread(animate_elements)
        except Exception:
            pass 

    def _show_template_popup_menu(self, input_field):
        from org.telegram.ui.ActionBar import BottomSheet
        from org.telegram.ui.Components import LayoutHelper
        from android.widget import LinearLayout, TextView, ScrollView, FrameLayout
        from android.view import Gravity, View
        from android.util import TypedValue
        from org.telegram.ui.ActionBar import Theme
        from org.telegram.messenger import AndroidUtilities
        from android_utils import OnClickListener
        from client_utils import get_last_fragment
        from android.graphics.drawable import GradientDrawable
        from android.graphics import Color
        frag = get_last_fragment()
        act = frag.getParentActivity() if frag else None
        if not act:
            return
        active_templates = []
        for i, tpl in enumerate(self.templates):
            if tpl.get('enabled', False):
                name = self.get_setting(f"template_name_{i}", "").strip()
                text = self.get_setting(f"template_text_{i}", "").strip()
                if name and text:
                    active_templates.append({
                        'index': i,
                        'name': name,
                        'text': text
                    })
        self.menu_shown = True
        builder = BottomSheet.Builder(act)
        builder.setApplyTopPadding(False)
        builder.setApplyBottomPadding(False)
        linearLayout = LinearLayout(act)
        builder.setCustomView(linearLayout)
        linearLayout.setOrientation(LinearLayout.VERTICAL)
        try:
            linearLayout.setAlpha(0.0)
            linearLayout.setScaleX(0.3)
            linearLayout.setScaleY(0.3)
            linearLayout.setTranslationY(AndroidUtilities.dp(100))
        except Exception:
            pass
        titleTextView = TextView(act)
        titleTextView.setTextColor(Theme.getColor(Theme.key_dialogTextBlack))
        titleTextView.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 24)
        titleTextView.setGravity(Gravity.CENTER)
        titleTextView.setTypeface(AndroidUtilities.getTypeface("fonts/rmedium.ttf"))
        if active_templates:
            titleTextView.setText(t('select_template', lang=self.lang))
        else:
            titleTextView.setText(t('no_templates_available', lang=self.lang))
        try:
            titleTextView.setAlpha(0.0)
            titleTextView.setTranslationY(AndroidUtilities.dp(50))
            titleTextView.setScaleX(0.8)
            titleTextView.setScaleY(0.8)
        except Exception:
            pass
        linearLayout.addView(titleTextView, LayoutHelper.createFrame(-1, -2, Gravity.TOP, 0, 16, 0, 8))
        contentFrame = FrameLayout(act)
        try:
            contentFrame.setAlpha(0.0)
            contentFrame.setTranslationY(AndroidUtilities.dp(30))
            contentFrame.setScaleX(0.8)
            contentFrame.setScaleY(0.8)
        except Exception:
            pass
        linearLayout.addView(contentFrame, LayoutHelper.createLinear(-1, 0, 1.0))
        if active_templates:
            scrollView = ScrollView(act)
            scrollView.setFillViewport(True)
            try:
                scrollView.setNestedScrollingEnabled(True)
            except Exception:
                pass
            buttonsLayout = LinearLayout(act)
            buttonsLayout.setOrientation(LinearLayout.VERTICAL)
            try:
                buttonsLayout.setAlpha(0.0)
                buttonsLayout.setTranslationY(AndroidUtilities.dp(40))
                buttonsLayout.setScaleX(0.8)
                buttonsLayout.setScaleY(0.8)
            except Exception:
                pass
            def create_template_button(template):
                def send_template(v=None):
                    try:
                        builder.getDismissRunnable().run()
                        self.menu_shown = False
                        self._send_template_to_current_chat(template['index'], template['name'], template['text'])
                    except Exception as e:
                        from ui.bulletin import BulletinHelper
                        BulletinHelper.show_error(t('error_occurred_with_reason', lang=self.lang, error=str(e)))
                from android.widget import LinearLayout
                buttonContainer = LinearLayout(act)
                buttonContainer.setOrientation(LinearLayout.VERTICAL)
                buttonContainer.setPadding(AndroidUtilities.dp(16), AndroidUtilities.dp(12), AndroidUtilities.dp(16), AndroidUtilities.dp(12))
                buttonContainer.setBackground(Theme.createSimpleSelectorRoundRectDrawable(
                    AndroidUtilities.dp(8),
                    Theme.getColor(Theme.key_dialogBackground),
                    Theme.getColor(Theme.key_dialogBackgroundGray)
                ))
                buttonContainer.setClickable(True)
                buttonContainer.setOnClickListener(OnClickListener(send_template))
                nameTextView = TextView(act)
                name = template['name']
                maxNameLength = 30
                name_lines = name.split('\n')
                if len(name_lines) > 3:
                    name = '\n'.join(name_lines[:3]) + "\n..."
                elif len(name) > maxNameLength:
                    name = name[:maxNameLength] + "..."
                nameTextView.setText(name)
                nameTextView.setTextColor(Theme.getColor(Theme.key_dialogTextBlack))
                nameTextView.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 16)
                nameTextView.setTypeface(AndroidUtilities.getTypeface("fonts/rmedium.ttf"))
                nameTextView.setGravity(Gravity.LEFT)
                nameTextView.setMaxLines(3)
                buttonContainer.addView(nameTextView)
                text = template['text']
                maxLength = 50
                text_lines = text.split('\n')
                if len(text_lines) > 3:
                    text = '\n'.join(text_lines[:3]) + "\n..."
                elif len(text) > maxLength:
                    text = text[:maxLength] + "..."
                textTextView = TextView(act)
                textTextView.setText(text)
                textTextView.setTextColor(Theme.getColor(Theme.key_dialogTextGray))
                textTextView.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 14)
                textTextView.setGravity(Gravity.LEFT)
                textTextView.setPadding(0, AndroidUtilities.dp(4), 0, 0)
                textTextView.setMaxLines(3)
                buttonContainer.addView(textTextView)
                return buttonContainer
            for i, template in enumerate(active_templates):
                btn = create_template_button(template)
                buttonsLayout.addView(btn, LayoutHelper.createFrame(-1, -2, Gravity.TOP, 16, 4, 16, 4))
                if i < len(active_templates) - 1:
                    from android.view import View
                    divider = View(act)
                    try:
                        divider.setBackgroundColor(Theme.getColor(Theme.key_divider))
                    except Exception:
                        divider.setBackgroundColor(0x33000000)
                    buttonsLayout.addView(divider, LayoutHelper.createFrame(-1, 1, Gravity.TOP, 16, 0, 16, 0))
            scrollView.addView(buttonsLayout)
            contentFrame.addView(scrollView, FrameLayout.LayoutParams(-1, -1))
        settingsBtnContainer = LinearLayout(act)
        settingsBtnContainer.setOrientation(LinearLayout.HORIZONTAL)
        settingsBtnContainer.setGravity(Gravity.CENTER_HORIZONTAL)
        try:
            settingsBtnContainer.setAlpha(0.0)
            settingsBtnContainer.setTranslationY(AndroidUtilities.dp(60))
            settingsBtnContainer.setScaleX(0.8)
            settingsBtnContainer.setScaleY(0.8)
        except Exception:
            pass
        settingsBtn = FrameLayout(act)
        try:
            base_color = Theme.getColor(Theme.key_featuredStickers_addButton)
        except Exception:
            base_color = Theme.getColor(Theme.key_dialogTextBlue)
        try:
            pressed_color = Theme.getColor(Theme.key_featuredStickers_addButtonPressed)
        except Exception:
            pressed_color = base_color
        settingsBtn.setBackground(Theme.createSimpleSelectorRoundRectDrawable(
            AndroidUtilities.dp(28),
            base_color,
            pressed_color
        ))
        settingsBtn.setPadding(0, AndroidUtilities.dp(14), 0, AndroidUtilities.dp(14))
        settingsBtn.setClickable(True)
        settingsBtn.setFocusable(True)
        settingsBtnText = TextView(act)
        settingsBtnText.setText(t('settings', lang=self.lang))
        settingsBtnText.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 16)
        settingsBtnText.setTypeface(AndroidUtilities.bold())
        settingsBtnText.setGravity(Gravity.CENTER)
        settingsBtnText.setTextColor(Theme.getColor(Theme.key_featuredStickers_buttonText))
        settingsBtn.addView(settingsBtnText, FrameLayout.LayoutParams(-1, -2))
        def on_settings(v=None):
            builder.getDismissRunnable().run()
            self.menu_shown = False
            self.open_plugin_settings()
        settingsBtn.setOnClickListener(OnClickListener(on_settings))
        self._apply_press_scale(settingsBtn)
        settingsBtnContainer.addView(settingsBtn, LayoutHelper.createLinear(-1, -2, Gravity.CENTER_HORIZONTAL, 24, 0, 24, 0))
        linearLayout.addView(settingsBtnContainer, LayoutHelper.createLinear(-1, -2, 0, 8, 0, 16))
        sheet = builder.show()
        sheet.setCanDismissWithSwipe(False)
        def on_dismiss():
            self.menu_shown = False
        try:
            sheet.setOnDismissListener(dynamic_proxy(android.content.DialogInterface.OnDismissListener)(on_dismiss))
        except Exception:
            pass
        def animate_elements():
            try:
                try:
                    linearLayout.animate().alpha(0.8).scaleX(0.4).scaleY(0.4).translationY(AndroidUtilities.dp(50)).setDuration(200).start()
                except Exception:
                    pass
                def scale_up_menu():
                    try:
                        linearLayout.animate().alpha(1.0).scaleX(1.0).scaleY(1.0).translationY(0).setDuration(400).start()
                    except Exception:
                        pass
                    def show_elements():
                        try:
                            titleTextView.animate().alpha(1.0).translationY(0).scaleX(1.0).scaleY(1.0).setDuration(350).start()
                        except Exception:
                            pass
                        try:
                            contentFrame.animate().alpha(1.0).translationY(0).scaleX(1.0).scaleY(1.0).setDuration(350).setStartDelay(50).start()
                        except Exception:
                            pass
                        try:
                            if active_templates:
                                buttonsLayout.animate().alpha(1.0).translationY(0).scaleX(1.0).scaleY(1.0).setDuration(350).setStartDelay(100).start()
                        except Exception:
                            pass
                        try:
                            settingsBtnContainer.animate().alpha(1.0).translationY(0).scaleX(1.0).scaleY(1.0).setDuration(350).setStartDelay(150).start()
                        except Exception:
                            pass
                    try:
                        run_on_ui_thread(show_elements)
                    except Exception:
                        pass
                try:
                    from org.telegram.messenger import AndroidUtilities
                    from java import dynamic_proxy
                    from java.lang import Runnable
                    class ScaleUpRunnable(dynamic_proxy(Runnable)):
                        def __init__(self, func):
                            super().__init__()
                            self.func = func
                        def run(self):
                            self.func()
                    AndroidUtilities.runOnUIThread(ScaleUpRunnable(lambda: run_on_ui_thread(scale_up_menu)), 200)
                except Exception:
                    try:
                        run_on_ui_thread(scale_up_menu)
                    except Exception:
                        pass
            except Exception:
                pass
        try:
            from org.telegram.messenger import AndroidUtilities
            from java import dynamic_proxy
            from java.lang import Runnable
            class AnimationRunnable(dynamic_proxy(Runnable)):
                def __init__(self, func):
                    super().__init__()
                    self.func = func
                def run(self):
                    self.func()
            AndroidUtilities.runOnUIThread(AnimationRunnable(lambda: run_on_ui_thread(animate_elements)), 0)
        except Exception:
            try:
                run_on_ui_thread(animate_elements)
            except Exception:
                pass
        return sheet

    def _show_export_bottom_sheet(self):
        self._force_load_stickers()
        try:
            from client_utils import get_last_fragment
            from org.telegram.ui.ActionBar import BottomSheet, Theme
            from org.telegram.ui.Components import LayoutHelper
            from org.telegram.messenger import AndroidUtilities
            from android.widget import LinearLayout, TextView, FrameLayout
            from android.view import View, Gravity
            from android.util import TypedValue
            from androidx.core.widget import NestedScrollView
            from android.graphics import Color
            from android_utils import run_on_ui_thread, OnClickListener
            from hook_utils import find_class
            from java import dynamic_proxy
            fragment = get_last_fragment()
            if not fragment:
                return
            act = fragment.getParentActivity()
            if not act:
                return
            templates = []
            for i in range(TEMPLATE_COUNT):
                name = self.get_setting(f"template_name_{i}", "").strip()
                text = self.get_setting(f"template_text_{i}", "").strip()
                if name or text:
                    templates.append({
                        "index": i,
                        "name": name or f"Template {i+1}",
                        "text": text
                    })
            if not templates:
                from ui.bulletin import BulletinHelper
                BulletinHelper.show_error(t('no_templates_available', lang=self.lang))
                return
            max_templates = min(len(templates), 30)
            selected_indices = list(range(max_templates))
            OnClickInterface = find_class("android.view.View$OnClickListener")
            OnClick = dynamic_proxy(OnClickInterface)
            sheet = BottomSheet(act, False)
            root_layout = LinearLayout(act)
            root_layout.setOrientation(LinearLayout.VERTICAL)
            root_layout.setPadding(AndroidUtilities.dp(20), AndroidUtilities.dp(16), AndroidUtilities.dp(20), AndroidUtilities.dp(8))
            try:
                root_layout.setAlpha(0.0)
                root_layout.setScaleX(0.3)
                root_layout.setScaleY(0.3)
                root_layout.setTranslationY(AndroidUtilities.dp(100))
            except Exception:
                pass
            try:
                root_layout.setBackgroundColor(Theme.getColor(Theme.key_dialogBackground))
            except Exception:
                root_layout.setBackgroundColor(Color.WHITE)
            try:
                from org.telegram.ui.Components import BackupImageView
                from org.telegram.messenger import MediaDataController, ImageLocation
                avatar_view = BackupImageView(act)
                avatar_view.setRoundRadius(AndroidUtilities.dp(45))
                root_layout.addView(avatar_view, LayoutHelper.createLinear(130, 130, Gravity.CENTER_HORIZONTAL, 0, 0, 0, 12))
                self.load_sticker_with_fallback(avatar_view, "mr_vestr/11", 11, "90_90")
            except Exception:
                pass
            title_view = TextView(act)
            title_view.setTypeface(AndroidUtilities.bold())
            title_view.setGravity(Gravity.CENTER)
            title_view.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 24)
            title_view.setText(t('export_templates', lang=self.lang))
            try:
                title_view.setTextColor(Theme.getColor(Theme.key_dialogTextBlack))
            except Exception:
                title_view.setTextColor(Color.BLACK)
            try:
                title_view.setAlpha(0.0)
                title_view.setTranslationY(AndroidUtilities.dp(50))
                title_view.setScaleX(0.8)
                title_view.setScaleY(0.8)
            except Exception:
                pass
            root_layout.addView(title_view, LayoutHelper.createLinear(-1, -2, Gravity.CENTER, 0, 0, 0, 12))
            desc_view = TextView(act)
            desc_view.setText(t('export_question', lang=self.lang))
            desc_view.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 15)
            desc_view.setGravity(Gravity.CENTER)
            try:
                desc_view.setTextColor(Theme.getColor(Theme.key_dialogTextBlack))
            except Exception:
                desc_view.setTextColor(Color.BLACK)
            try:
                desc_view.setAlpha(0.0)
                desc_view.setTranslationY(AndroidUtilities.dp(30))
                desc_view.setScaleX(0.8)
                desc_view.setScaleY(0.8)
            except Exception:
                pass
            root_layout.addView(desc_view, LayoutHelper.createLinear(-1, -2, Gravity.CENTER, 0, 0, 0, 16))
            selected_text = TextView(act)
            selected_text.setText(f"{t('selected_templates', lang=self.lang)} ({max_templates})")
            selected_text.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 14)
            selected_text.setGravity(Gravity.CENTER)
            try:
                selected_text.setTextColor(Theme.getColor(Theme.key_featuredStickers_addButton))
            except Exception:
                selected_text.setTextColor(Color.BLUE)
            selected_text.setClickable(True)
            try:
                selected_text.setAlpha(0.0)
                selected_text.setTranslationY(AndroidUtilities.dp(30))
                selected_text.setScaleX(0.8)
                selected_text.setScaleY(0.8)
            except Exception:
                pass
            def show_export_selector(v):
                self._show_export_selector(templates[:max_templates], selected_indices, lambda indices: 
                    run_on_ui_thread(lambda: selected_text.setText(f"{t('selected_templates', lang=self.lang)} ({len(indices)})")))
            selected_text.setOnClickListener(OnClickListener(show_export_selector))
            root_layout.addView(selected_text, LayoutHelper.createLinear(-1, -2, Gravity.CENTER, 0, 0, 0, 16))
            divider = View(act)
            try:
                divider.setBackgroundColor(Theme.getColor(Theme.key_divider))
            except Exception:
                divider.setBackgroundColor(Color.GRAY)
            root_layout.addView(divider, LayoutHelper.createLinear(-1, 1, Gravity.FILL_HORIZONTAL, 0, 8, 0, 8))
            export_button = TextView(act)
            export_button.setText(t('export', lang=self.lang))
            export_button.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 16)
            export_button.setTypeface(AndroidUtilities.bold())
            export_button.setGravity(Gravity.CENTER)
            try:
                base_color = Theme.getColor(Theme.key_featuredStickers_addButton)
            except Exception:
                base_color = Theme.getColor(Theme.key_dialogTextBlue)
            try:
                pressed_color = Theme.getColor(Theme.key_featuredStickers_addButtonPressed)
            except Exception:
                pressed_color = base_color
            try:
                export_button.setBackground(Theme.createSimpleSelectorRoundRectDrawable(
                    AndroidUtilities.dp(28), 
                    base_color, 
                    pressed_color
                ))
                export_button.setTextColor(Theme.getColor(Theme.key_featuredStickers_buttonText))
            except Exception:
                export_button.setBackgroundColor(Color.BLUE)
                export_button.setTextColor(Color.WHITE)
            export_button.setPadding(0, AndroidUtilities.dp(14), 0, AndroidUtilities.dp(14))
            try:
                export_button.setAlpha(0.0)
                export_button.setTranslationY(AndroidUtilities.dp(40))
                export_button.setScaleX(0.8)
                export_button.setScaleY(0.8)
            except Exception:
                pass
            def export_templates(v):
                try:
                    sheet.dismiss()
                    export_items = []
                    for i in selected_indices:
                        if i < len(templates):
                            template = templates[i]
                            export_items.append({
                                "name": template["name"],
                                "text": template["text"]
                            })
                    def open_share():
                        try:
                            import json
                            from file_utils import get_cache_dir
                            from org.telegram.messenger import ApplicationLoader
                            from java.io import File, FileOutputStream
                            from android.content import Intent
                            from android.net import Uri
                            from org.telegram.ui import LaunchActivity
                            data_bytes = json.dumps({"templates": export_items}, ensure_ascii=False).encode("utf-8")
                            cache_dir = get_cache_dir()
                            filename = "export.templates"
                            file_path = os.path.join(cache_dir, filename)
                            temp_file = File(file_path)
                            if temp_file.exists():
                                temp_file.delete()
                            fos = FileOutputStream(temp_file)
                            fos.write(data_bytes)
                            fos.close()
                            context = ApplicationLoader.applicationContext
                            file_uri = Uri.fromFile(temp_file)
                            intent = Intent(context, LaunchActivity)
                            intent.setAction(Intent.ACTION_SEND)
                            intent.setType("application/octet-stream")
                            intent.putExtra(Intent.EXTRA_STREAM, file_uri)
                            intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
                            intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION)
                            context.startActivity(intent)
                            from ui.bulletin import BulletinHelper
                            run_on_ui_thread(lambda: BulletinHelper.show_success(t('export_success', lang=self.lang)))
                        except Exception as e:
                            from ui.bulletin import BulletinHelper
                            run_on_ui_thread(lambda: BulletinHelper.show_error(t('export_error', lang=self.lang, error=str(e))))
                    run_on_ui_thread(open_share)
                except Exception as export_error:
                    from ui.bulletin import BulletinHelper
                    error_msg = str(export_error)
                    run_on_ui_thread(lambda: BulletinHelper.show_error(t('export_error', lang=self.lang, error=error_msg)))
            export_button.setOnClickListener(OnClickListener(export_templates))
            self._apply_press_scale(export_button)
            root_layout.addView(export_button, LayoutHelper.createLinear(-1, -2, Gravity.START, 0, 8, 0, 0))
            sheet.setCustomView(root_layout)
            sheet.show()
            def animate_elements():
                try:
                    try:
                        root_layout.animate().alpha(0.8).scaleX(0.4).scaleY(0.4).translationY(AndroidUtilities.dp(50)).setDuration(200).start()
                    except Exception:
                        pass
                    def scale_up_menu():
                        try:
                            root_layout.animate().alpha(1.0).scaleX(1.0).scaleY(1.0).translationY(0).setDuration(400).start()
                        except Exception:
                            pass
                        def show_elements():
                            try:
                                title_view.animate().alpha(1.0).translationY(0).scaleX(1.0).scaleY(1.0).setDuration(350).start()
                            except Exception:
                                pass
                            try:
                                desc_view.animate().alpha(1.0).translationY(0).scaleX(1.0).scaleY(1.0).setDuration(350).setStartDelay(50).start()
                            except Exception:
                                pass
                            try:
                                selected_text.animate().alpha(1.0).translationY(0).scaleX(1.0).scaleY(1.0).setDuration(350).setStartDelay(100).start()
                            except Exception:
                                pass
                            try:
                                export_button.animate().alpha(1.0).translationY(0).scaleX(1.0).scaleY(1.0).setDuration(350).setStartDelay(150).start()
                            except Exception:
                                pass
                        try:
                            run_on_ui_thread(show_elements)
                        except Exception:
                            pass
                    try:
                        from org.telegram.messenger import AndroidUtilities
                        from java import dynamic_proxy
                        from java.lang import Runnable
                        class ScaleUpRunnable(dynamic_proxy(Runnable)):
                            def __init__(self, func):
                                super().__init__()
                                self.func = func
                            def run(self):
                                self.func()
                        AndroidUtilities.runOnUIThread(ScaleUpRunnable(lambda: run_on_ui_thread(scale_up_menu)), 200)
                    except Exception:
                        try:
                            run_on_ui_thread(scale_up_menu)
                        except Exception:
                            pass
                except Exception:
                    pass
            try:
                run_on_ui_thread(animate_elements)
            except Exception:
                pass
        except Exception as e:
            self._export_templates_via_dialogs(selected_indices)

    def _show_export_selector(self, templates, selected_indices, on_selection_complete):
        try:
            from client_utils import get_last_fragment
            from org.telegram.ui.ActionBar import BottomSheet, Theme
            from org.telegram.ui.Components import LayoutHelper
            from org.telegram.messenger import AndroidUtilities
            from android.widget import LinearLayout, TextView, FrameLayout
            from android.view import View, Gravity
            from android.util import TypedValue
            from androidx.core.widget import NestedScrollView
            from org.telegram.ui.Components import CheckBox2
            from android_utils import run_on_ui_thread, OnClickListener
            from hook_utils import find_class
            from java import dynamic_proxy
            OnClickInterface = find_class("android.view.View$OnClickListener")
            OnClick = dynamic_proxy(OnClickInterface)
            fragment = get_last_fragment()
            if not fragment:
                return
            context = fragment.getContext()
            bottom_sheet = BottomSheet(context, False, fragment.getResourceProvider())
            bottom_sheet.setApplyBottomPadding(False)
            bottom_sheet.setApplyTopPadding(False)
            bottom_sheet.fixNavigationBar(Theme.getColor(Theme.key_windowBackgroundWhite))
            scroll_content = LinearLayout(context)
            scroll_content.setOrientation(LinearLayout.VERTICAL)
            scroll_content.setClickable(True)
            try:
                scroll_content.setAlpha(0.0)
                scroll_content.setTranslationY(AndroidUtilities.dp(30))
                scroll_content.setScaleX(0.8)
                scroll_content.setScaleY(0.8)
            except Exception:
                pass
            content_frame = FrameLayout(context)
            content_frame.addView(scroll_content)
            scroll_view = NestedScrollView(context)
            scroll_view.addView(content_frame)
            bottom_sheet.setCustomView(scroll_view)
            title_text_view = TextView(context)
            title_text_view.setTypeface(AndroidUtilities.bold())
            title_text_view.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 20)
            title_text_view.setTextColor(Theme.getColor(Theme.key_dialogTextBlack))
            title_text_view.setText(t('select_templates', lang=self.lang))
            title_text_view.setGravity(Gravity.CENTER)
            try:
                title_text_view.setAlpha(0.0)
                title_text_view.setTranslationY(AndroidUtilities.dp(50))
                title_text_view.setScaleX(0.8)
                title_text_view.setScaleY(0.8)
            except Exception:
                pass
            scroll_content.addView(title_text_view, LayoutHelper.createLinear(-2, -2, Gravity.TOP | Gravity.CENTER_HORIZONTAL, 10, 20, 10, 16))
            selected_items = set(selected_indices)
            checkboxes = {}
            for i, template in enumerate(templates):
                if i > 0:
                    divider = View(context)
                    try:
                        divider.setBackgroundColor(Theme.getColor(Theme.key_divider))
                    except Exception:
                        divider.setBackgroundColor(0x33000000)
                    scroll_content.addView(divider, LayoutHelper.createLinear(-1, 1, Gravity.FILL_HORIZONTAL, 16, 0, 16, 0))
                item_container = FrameLayout(context)
                item_container.setBackground(None)
                checkbox = CheckBox2(context, 21, fragment.getResourceProvider())
                checkbox.setColor(Theme.key_dialogRoundCheckBox, Theme.key_checkboxDisabled, Theme.key_dialogRoundCheckBoxCheck)
                checkbox.setDrawUnchecked(True)
                checkbox.setDrawBackgroundAsArc(10)
                checkbox.setChecked(i in selected_items, False)
                checkbox.setVisibility(1)
                template_name = str(template.get("name", f"Template {i+1}"))
                lines = template_name.split('\n')
                while lines and lines[-1].strip() == '':
                    lines.pop()
                    if lines and not lines[-1].endswith('...'):
                        lines[-1] += '...'
                template_name = '\n'.join(lines)
                if len(template_name) > 25:
                    template_name = template_name[:25] + "..."
                text_view = TextView(context)
                text_view.setText(template_name)
                text_view.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 16)
                text_view.setTextColor(Theme.getColor(Theme.key_dialogTextBlack))
                text_view.setGravity(Gravity.CENTER_VERTICAL)
                text_view.setMaxLines(2)
                item_container.addView(checkbox, LayoutHelper.createFrame(24, 24, Gravity.CENTER_VERTICAL | Gravity.LEFT, 16, 0, 0, 0))
                item_container.addView(text_view, LayoutHelper.createFrame(-1, -1, Gravity.CENTER_VERTICAL | Gravity.LEFT, 56, 0, 16, 0))
                checkboxes[i] = checkbox
                class ItemClickImpl(OnClick):
                    def __init__(self, item_index):
                        super().__init__()
                        self.item_index = item_index
                    def onClick(self, v):
                        checkbox = checkboxes.get(self.item_index)
                        if checkbox:
                            if self.item_index in selected_items:
                                selected_items.remove(self.item_index)
                                checkbox.setChecked(False, True)
                            else:
                                selected_items.add(self.item_index)
                                checkbox.setChecked(True, True)
                item_container.setOnClickListener(ItemClickImpl(i))
                scroll_content.addView(item_container, LayoutHelper.createLinear(-1, 56, Gravity.TOP, 0, 0, 0, 0))
            action_button = TextView(context)
            try:
                base_color = Theme.getColor(Theme.key_featuredStickers_addButton)
            except Exception:
                base_color = Theme.getColor(Theme.key_dialogTextBlue)
            try:
                pressed_color = Theme.getColor(Theme.key_featuredStickers_addButtonPressed)
            except Exception:
                pressed_color = base_color
            action_button.setBackground(Theme.createSimpleSelectorRoundRectDrawable(
                AndroidUtilities.dp(28), 
                base_color, 
                pressed_color
            ))
            action_button.setGravity(Gravity.CENTER)
            action_button.setSingleLine(True)
            action_button.setText(t('select', lang=self.lang))
            action_button.setTextColor(Theme.getColor(Theme.key_featuredStickers_buttonText))
            action_button.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 16)
            action_button.setTypeface(AndroidUtilities.bold())
            action_button.setEnabled(True)
            action_button.setPadding(0, AndroidUtilities.dp(14), 0, AndroidUtilities.dp(14))
            class ActionClickImpl(OnClick):
                def onClick(self, v):
                    selected_indices[:] = list(selected_items)
                    if on_selection_complete:
                        on_selection_complete(selected_indices)
                    run_on_ui_thread(lambda: bottom_sheet.dismiss())
            action_button.setOnClickListener(ActionClickImpl())
            self._apply_press_scale(action_button)
            try:
                action_button.setAlpha(0.0)
                action_button.setTranslationY(AndroidUtilities.dp(40))
                action_button.setScaleX(0.8)
                action_button.setScaleY(0.8)
            except Exception:
                pass
            scroll_content.addView(action_button, LayoutHelper.createLinear(-1, -2, Gravity.START, 14, 8, 14, 20))
            bottom_sheet.setCanDismissWithSwipe(False)
            bottom_sheet.show()
            def animate_elements():
                try:
                    try:
                        title_text_view.animate().alpha(1.0).translationY(0).scaleX(1.0).scaleY(1.0).setDuration(350).start()
                    except Exception:
                        pass
                    try:
                        scroll_content.animate().alpha(1.0).translationY(0).scaleX(1.0).scaleY(1.0).setDuration(350).setStartDelay(50).start()
                    except Exception:
                        pass
                    try:
                        action_button.animate().alpha(1.0).translationY(0).scaleX(1.0).scaleY(1.0).setDuration(350).setStartDelay(100).start()
                    except Exception:
                        pass
                except Exception:
                    pass
            try:
                run_on_ui_thread(animate_elements)
            except Exception:
                pass
        except Exception as e:
            pass

    def _export_templates_via_dialogs(self, selected_indices=None):
        try:
            import json
            export_items = []
            if selected_indices is None:
                selected_indices = list(range(TEMPLATE_COUNT))
            for i in selected_indices:
                if i >= TEMPLATE_COUNT:
                    continue
                name = self.get_setting(f"template_name_{i}", "").strip()
                text = self.get_setting(f"template_text_{i}", "").strip()
                if name or text:
                    export_items.append({
                        "name": name,
                        "text": text
                    })
            args = Bundle()
            args.putBoolean("onlySelect", True)
            args.putBoolean("checkCanWrite", True)
            args.putInt("dialogsType", 0)
            args.putBoolean("allowGlobalSearch", True)
            activity = DialogsActivity(args)
            def after_select(fragment, dids, message, param, notify, scheduleDate, topicsFragment):
                try:
                    activity.finishFragment()
                    if dids.isEmpty():
                        return
                    selected_id = dids.get(0).dialogId
                    peer_id = int(str(selected_id))
                    try:
                        data_bytes = json.dumps({"templates": export_items}, ensure_ascii=False).encode("utf-8")
                    except Exception as e:
                        from ui.bulletin import BulletinHelper
                        BulletinHelper.show_error(t('export_error', lang=self.lang, error=str(e)))
                        return
                    path = _LocalFileSystem.write_temp_file("export.templates", data_bytes, delete_after=30)
                    self._send_file(peer_id, path, t('export_file_caption', lang=self.lang))
                    from android_utils import run_on_ui_thread
                    from ui.bulletin import BulletinHelper
                    try:
                        from org.telegram.messenger import R as R_tg
                        icon_attr = getattr(R_tg.raw, 'done', None)
                    except Exception:
                        icon_attr = None
                    def _open():
                        try:
                            self._open_chat_by_dialog_id(peer_id)
                        except Exception:
                            pass
                    run_on_ui_thread(lambda: BulletinHelper.show_with_button(t('templates_exported', lang=self.lang), icon_attr if icon_attr else 0, t('open', lang=self.lang), _open, None))
                except Exception as e:
                    from ui.bulletin import BulletinHelper
                    BulletinHelper.show_error(t('export_error', lang=self.lang, error=str(e)))
            delegate = TemplateDialogsDelegate(after_select)
            activity.setDelegate(delegate)
            last_fragment = LaunchActivity.getLastFragment()
            if last_fragment:
                last_fragment.presentFragment(activity)
        except Exception as e:
            from ui.bulletin import BulletinHelper
            BulletinHelper.show_error(t('export_error', lang=self.lang, error=str(e)))

    def _show_import_bottom_sheet(self, data, act=None):
        self._force_load_stickers()
        try:
            from org.telegram.ui.ActionBar import BottomSheet, Theme
            from android.widget import LinearLayout, TextView, ScrollView, FrameLayout, ImageView
            from android.view import Gravity, View
            from android.util import TypedValue
            from org.telegram.ui.Components import LayoutHelper, BackupImageView
            from org.telegram.messenger import AndroidUtilities, MediaDataController, ImageLocation
            from android.graphics.drawable import GradientDrawable
            from android.graphics import Color
            from android_utils import OnClickListener
            from client_utils import get_last_fragment
            from android_utils import run_on_ui_thread
            if act is None:
                frag = get_last_fragment()
                act = frag.getParentActivity() if frag else None
            if not act:
                return
            templates = data.get("templates", []) if isinstance(data, dict) else []
            if not isinstance(templates, list):
                templates = []
            max_templates = min(len(templates), 30)
            selected_indices = list(range(max_templates))
            sheet = BottomSheet(act, False)
            root_layout = LinearLayout(act)
            root_layout.setOrientation(LinearLayout.VERTICAL)
            root_layout.setPadding(AndroidUtilities.dp(20), AndroidUtilities.dp(16), AndroidUtilities.dp(20), AndroidUtilities.dp(8))
            try:
                root_layout.setAlpha(0.0)
                root_layout.setScaleX(0.3)
                root_layout.setScaleY(0.3)
                root_layout.setTranslationY(AndroidUtilities.dp(100))
            except Exception:
                pass
            try:
                root_layout.setBackgroundColor(Theme.getColor(Theme.key_dialogBackground))
            except Exception:
                pass
            try:
                avatar_view = BackupImageView(act)
                avatar_view.setRoundRadius(AndroidUtilities.dp(45))
                root_layout.addView(avatar_view, LayoutHelper.createLinear(130, 130, Gravity.CENTER_HORIZONTAL, 0, 0, 0, 12))
                self.load_sticker_with_fallback(avatar_view, "mr_vestr/10", 10, "90_90")
            except Exception:
                pass
            title_view = TextView(act)
            title_view.setTypeface(AndroidUtilities.bold())
            title_view.setGravity(Gravity.CENTER)
            title_view.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 24)
            title_view.setText(t('import_dialog_title', lang=self.lang))
            try:
                title_view.setTextColor(Theme.getColor(Theme.key_dialogTextBlack))
            except Exception:
                pass
            try:
                title_view.setAlpha(0.0)
                title_view.setTranslationY(AndroidUtilities.dp(50))
                title_view.setScaleX(0.8)
                title_view.setScaleY(0.8)
            except Exception:
                pass
            root_layout.addView(title_view, LayoutHelper.createLinear(-1, -2, Gravity.CENTER, 0, 0, 0, 12))
            desc_view = TextView(act)
            desc_view.setText(t('import_question', lang=self.lang))
            desc_view.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 15)
            desc_view.setGravity(Gravity.CENTER)
            try:
                desc_view.setTextColor(Theme.getColor(Theme.key_dialogTextBlack))
            except Exception:
                pass
            try:
                desc_view.setAlpha(0.0)
                desc_view.setTranslationY(AndroidUtilities.dp(30))
                desc_view.setScaleX(0.8)
                desc_view.setScaleY(0.8)
            except Exception:
                pass
            root_layout.addView(desc_view, LayoutHelper.createLinear(-1, -2, Gravity.CENTER, 0, 0, 0, 16))
            selected_text = TextView(act)
            selected_text.setText(f"{t('selected_templates', lang=self.lang)} ({max_templates})")
            selected_text.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 14)
            selected_text.setGravity(Gravity.CENTER)
            try:
                selected_text.setTextColor(Theme.getColor(Theme.key_featuredStickers_addButton))
            except Exception:
                selected_text.setTextColor(Color.BLUE)
            selected_text.setClickable(True)
            try:
                selected_text.setAlpha(0.0)
                selected_text.setTranslationY(AndroidUtilities.dp(30))
                selected_text.setScaleX(0.8)
                selected_text.setScaleY(0.8)
            except Exception:
                pass
                selected_text.setTextColor(Theme.getColor(Theme.key_featuredStickers_addButton))
            except Exception:
                selected_text.setTextColor(Color.BLUE)
            selected_text.setClickable(True)
            def show_template_selector(v):
                self._show_template_selector(templates[:max_templates], selected_indices, lambda indices: 
                    run_on_ui_thread(lambda: selected_text.setText(f"{t('selected_templates', lang=self.lang)} ({len(indices)})")))
            selected_text.setOnClickListener(OnClickListener(show_template_selector))
            root_layout.addView(selected_text, LayoutHelper.createLinear(-1, -2, Gravity.CENTER, 0, 0, 0, 12))
            from org.telegram.ui.Components import CheckBox2
            clear_checkbox = CheckBox2(act, 21, None)
            clear_checkbox.setColor(Theme.key_dialogRoundCheckBox, Theme.key_checkboxDisabled, Theme.key_dialogRoundCheckBoxCheck)
            clear_checkbox.setDrawUnchecked(True)
            clear_checkbox.setDrawBackgroundAsArc(10)
            clear_checkbox.setChecked(False, False)
            clear_checkbox.setVisibility(1)
            clear_container = FrameLayout(act)
            btn_bg = GradientDrawable()
            btn_bg.setCornerRadius(AndroidUtilities.dp(18))
            try:
                bg_color = Theme.getColor(Theme.key_chat_inLoader) & 0x20FFFFFF | 0x10000000
            except Exception:
                bg_color = Color.parseColor("#F0F0F0")
            btn_bg.setColor(bg_color)
            try:
                from android.graphics.drawable import RippleDrawable
                from android.content.res import ColorStateList
                ripple_color = ColorStateList.valueOf(Color.parseColor("#40000000"))
                ripple_drawable = RippleDrawable(ripple_color, btn_bg, None)
                clear_container.setBackground(ripple_drawable)
            except Exception:
                clear_container.setBackground(btn_bg)
            clear_inner_layout = LinearLayout(act)
            clear_inner_layout.setOrientation(LinearLayout.HORIZONTAL)
            clear_inner_layout.setGravity(Gravity.CENTER_VERTICAL)
            clear_inner_layout.setPadding(AndroidUtilities.dp(8), AndroidUtilities.dp(8), AndroidUtilities.dp(8), AndroidUtilities.dp(8))
            clear_inner_layout.setMinimumHeight(AndroidUtilities.dp(40))
            clear_inner_layout.addView(clear_checkbox, LayoutHelper.createLinear(24, 24, Gravity.CENTER_VERTICAL, 0, 0, 8, 0))
            clear_text = TextView(act)
            clear_text.setText(t('clear_all_templates', lang=self.lang))
            clear_text.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 14)
            clear_text.setGravity(Gravity.CENTER_VERTICAL)
            try:
                clear_text.setTextColor(Theme.getColor(Theme.key_dialogTextBlack))
            except Exception:
                clear_text.setTextColor(Color.BLACK)
            clear_inner_layout.addView(clear_text)
            clear_container.addView(clear_inner_layout)
            def toggle_clear_all(v):
                current_state = clear_checkbox.isChecked()
                clear_checkbox.setChecked(not current_state, True)
            clear_container.setOnClickListener(OnClickListener(toggle_clear_all))
            self._apply_press_scale(clear_container)
            root_layout.addView(clear_container, LayoutHelper.createLinear(-2, -2, Gravity.CENTER, 0, 0, 0, 16))
            divider = View(act)
            try:
                divider.setBackgroundColor(Theme.getColor(Theme.key_divider))
            except Exception:
                divider.setBackgroundColor(Color.GRAY)
            root_layout.addView(divider, LayoutHelper.createLinear(-1, 1, Gravity.FILL_HORIZONTAL, 0, 8, 0, 8))
            import_button = TextView(act)
            import_button.setText(t('import', lang=self.lang))
            import_button.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 16)
            import_button.setTypeface(AndroidUtilities.bold())
            import_button.setGravity(Gravity.CENTER)
            try:
                base_color = Theme.getColor(Theme.key_featuredStickers_addButton)
            except Exception:
                base_color = Theme.getColor(Theme.key_dialogTextBlue)
            try:
                pressed_color = Theme.getColor(Theme.key_featuredStickers_addButtonPressed)
            except Exception:
                pressed_color = base_color
            try:
                import_button.setBackground(Theme.createSimpleSelectorRoundRectDrawable(
                    AndroidUtilities.dp(28), 
                    base_color, 
                    pressed_color
                ))
                import_button.setTextColor(Theme.getColor(Theme.key_featuredStickers_buttonText))
            except Exception:
                import_button.setBackgroundColor(Color.BLUE)
                import_button.setTextColor(Color.WHITE)
            import_button.setPadding(0, AndroidUtilities.dp(14), 0, AndroidUtilities.dp(14))
            try:
                import_button.setAlpha(0.0)
                import_button.setTranslationY(AndroidUtilities.dp(40))
                import_button.setScaleX(0.8)
                import_button.setScaleY(0.8)
            except Exception:
                pass
            def do_import(v):
                try:
                    selected_templates = [templates[i] for i in selected_indices if i < len(templates)]
                    clear_all_enabled = clear_checkbox.isChecked()
                    if clear_all_enabled:
                        self.set_setting("templates_created_count", min(max(len(selected_templates), 1), TEMPLATE_COUNT), reload_settings=True)
                        self.templates = []
                        for i in range(TEMPLATE_COUNT):
                            if i < len(selected_templates):
                                item = selected_templates[i] or {}
                                name = str(item.get("name", ""))
                                text = str(item.get("text", ""))
                            else:
                                name = ""
                                text = ""
                            self.set_setting(f"template_name_{i}", name, reload_settings=True)
                            self.set_setting(f"template_text_{i}", text, reload_settings=True)
                            self.templates.append({"name": name, "text": text, "enabled": True if i == 0 else bool(name and text)})
                    else:
                        current_templates = self.get_setting("templates", [])
                        existing_count = 0
                        for i, template in enumerate(current_templates):
                            if template.get("name", "").strip() or template.get("text", "").strip():
                                existing_count = i + 1
                        total_count = existing_count + len(selected_templates)
                        if total_count > TEMPLATE_COUNT:
                            sheet.dismiss()
                            from ui.bulletin import BulletinHelper
                            try:
                                from org.telegram.messenger import R as R_tg
                                icon_attr = getattr(R_tg.raw, 'error', None)
                            except Exception:
                                icon_attr = None
                            run_on_ui_thread(lambda: BulletinHelper.show_error(
                                t('templates_limit_exceeded', lang=self.lang)
                            ))
                            return
                        updated_templates = current_templates[:] if current_templates else []
                        for i, template in enumerate(selected_templates):
                            index = existing_count + i
                            if index >= TEMPLATE_COUNT:
                                break
                            item = template or {}
                            name = str(item.get("name", ""))
                            text = str(item.get("text", ""))
                            self.set_setting(f"template_name_{index}", name, reload_settings=True)
                            self.set_setting(f"template_text_{index}", text, reload_settings=True)
                            if index < len(updated_templates):
                                updated_templates[index] = {"name": name, "text": text, "enabled": True if index == 0 else bool(name and text)}
                            else:
                                while len(updated_templates) <= index:
                                    updated_templates.append({"name": "", "text": "", "enabled": False})
                                updated_templates[index] = {"name": name, "text": text, "enabled": True if index == 0 else bool(name and text)}
                        self.templates = updated_templates
                        final_count = max(existing_count + len(selected_templates), existing_count)
                        self.set_setting("templates_created_count", min(final_count, TEMPLATE_COUNT), reload_settings=True)
                    self.set_setting("templates", self.templates, reload_settings=True)
                    from ui.bulletin import BulletinHelper
                    try:
                        from org.telegram.messenger import R as R_tg
                        icon_attr = getattr(R_tg.raw, 'settings', None)
                    except Exception:
                        icon_attr = None
                    def _open_settings():
                        try:
                            self.open_plugin_settings()
                        except Exception as e:
                            from ui.bulletin import BulletinHelper
                            BulletinHelper.show_error(t('open_settings_error', lang=self.lang, error=str(e)))
                    run_on_ui_thread(lambda: BulletinHelper.show_with_button(
                        t('import_success', lang=self.lang),
                        icon_attr if icon_attr else 0,
                        t('settings', lang=self.lang),
                        _open_settings,
                        None
                    ))
                    sheet.dismiss()
                except Exception as e:
                    from ui.bulletin import BulletinHelper
                    run_on_ui_thread(lambda: BulletinHelper.show_error(t('import_error', lang=self.lang, error=str(e))))
            import_button.setOnClickListener(OnClickListener(do_import))
            self._apply_press_scale(import_button)
            root_layout.addView(import_button, LayoutHelper.createLinear(-1, -2, Gravity.START, 0, 8, 0, 0))
            sheet.setCustomView(root_layout)
            sheet.show()
            def animate_elements():
                try:
                    try:
                        root_layout.animate().alpha(0.8).scaleX(0.4).scaleY(0.4).translationY(AndroidUtilities.dp(50)).setDuration(200).start()
                    except Exception:
                        pass
                    def scale_up_menu():
                        try:
                            root_layout.animate().alpha(1.0).scaleX(1.0).scaleY(1.0).translationY(0).setDuration(400).start()
                        except Exception:
                            pass
                        def show_elements():
                            try:
                                title_view.animate().alpha(1.0).translationY(0).scaleX(1.0).scaleY(1.0).setDuration(350).start()
                            except Exception:
                                pass
                            try:
                                desc_view.animate().alpha(1.0).translationY(0).scaleX(1.0).scaleY(1.0).setDuration(350).setStartDelay(50).start()
                            except Exception:
                                pass
                            try:
                                selected_text.animate().alpha(1.0).translationY(0).scaleX(1.0).scaleY(1.0).setDuration(350).setStartDelay(100).start()
                            except Exception:
                                pass
                            try:
                                import_button.animate().alpha(1.0).translationY(0).scaleX(1.0).scaleY(1.0).setDuration(350).setStartDelay(150).start()
                            except Exception:
                                pass
                        try:
                            run_on_ui_thread(show_elements)
                        except Exception:
                            pass
                    try:
                        from org.telegram.messenger import AndroidUtilities
                        from java import dynamic_proxy
                        from java.lang import Runnable
                        class ScaleUpRunnable(dynamic_proxy(Runnable)):
                            def __init__(self, func):
                                super().__init__()
                                self.func = func
                            def run(self):
                                self.func()
                        AndroidUtilities.runOnUIThread(ScaleUpRunnable(lambda: run_on_ui_thread(scale_up_menu)), 200)
                    except Exception:
                        try:
                            run_on_ui_thread(scale_up_menu)
                        except Exception:
                            pass
                except Exception:
                    pass
            try:
                run_on_ui_thread(animate_elements)
            except Exception:
                pass
        except Exception as e:
            self._show_import_templates_alert(data, act)

    def _show_template_selector(self, templates, selected_indices, on_selection_complete):
        try:
            from client_utils import get_last_fragment
            from org.telegram.ui.ActionBar import BottomSheet, Theme
            from org.telegram.ui.Components import LayoutHelper
            from org.telegram.messenger import AndroidUtilities
            from android.widget import LinearLayout, TextView, FrameLayout
            from android.view import View, Gravity
            from android.util import TypedValue
            from androidx.core.widget import NestedScrollView
            from org.telegram.ui.Components import CheckBox2
            from android_utils import run_on_ui_thread
            from hook_utils import find_class
            from java import dynamic_proxy
            OnClickInterface = find_class("android.view.View$OnClickListener")
            OnClick = dynamic_proxy(OnClickInterface)
            fragment = get_last_fragment()
            if not fragment:
                return
            context = fragment.getContext()
            bottom_sheet = BottomSheet(context, False, fragment.getResourceProvider())
            bottom_sheet.setApplyBottomPadding(False)
            bottom_sheet.setApplyTopPadding(False)
            bottom_sheet.fixNavigationBar(Theme.getColor(Theme.key_windowBackgroundWhite))
            scroll_content = LinearLayout(context)
            scroll_content.setOrientation(LinearLayout.VERTICAL)
            scroll_content.setClickable(True)
            try:
                scroll_content.setAlpha(0.0)
                scroll_content.setTranslationY(AndroidUtilities.dp(30))
                scroll_content.setScaleX(0.8)
                scroll_content.setScaleY(0.8)
            except Exception:
                pass
            content_frame = FrameLayout(context)
            content_frame.addView(scroll_content)
            scroll_view = NestedScrollView(context)
            scroll_view.addView(content_frame)
            bottom_sheet.setCustomView(scroll_view)
            title_text_view = TextView(context)
            title_text_view.setTypeface(AndroidUtilities.bold())
            title_text_view.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 20)
            title_text_view.setTextColor(Theme.getColor(Theme.key_dialogTextBlack))
            title_text_view.setText(t('select_templates', lang=self.lang))
            title_text_view.setGravity(Gravity.CENTER)
            try:
                title_text_view.setAlpha(0.0)
                title_text_view.setTranslationY(AndroidUtilities.dp(50))
                title_text_view.setScaleX(0.8)
                title_text_view.setScaleY(0.8)
            except Exception:
                pass
            scroll_content.addView(title_text_view, LayoutHelper.createLinear(-2, -2, Gravity.TOP | Gravity.CENTER_HORIZONTAL, 10, 20, 10, 16))
            selected_items = set(selected_indices)
            checkboxes = {}
            for i, template in enumerate(templates):
                if i > 0:
                    divider = View(context)
                    try:
                        divider.setBackgroundColor(Theme.getColor(Theme.key_divider))
                    except Exception:
                        divider.setBackgroundColor(0x33000000)
                    scroll_content.addView(divider, LayoutHelper.createLinear(-1, 1, Gravity.FILL_HORIZONTAL, 16, 0, 16, 0))
                item_container = FrameLayout(context)
                item_container.setBackground(None)
                checkbox = CheckBox2(context, 21, fragment.getResourceProvider())
                checkbox.setColor(Theme.key_dialogRoundCheckBox, Theme.key_checkboxDisabled, Theme.key_dialogRoundCheckBoxCheck)
                checkbox.setDrawUnchecked(True)
                checkbox.setDrawBackgroundAsArc(10)
                checkbox.setChecked(i in selected_items, False)
                checkbox.setVisibility(1)
                template_name = str(template.get("name", f"Template {i+1}"))
                lines = template_name.split('\n')
                while lines and lines[-1].strip() == '':
                    lines.pop()
                    if lines and not lines[-1].endswith('...'):
                        lines[-1] += '...'
                template_name = '\n'.join(lines)
                if len(template_name) > 25:
                    template_name = template_name[:25] + "..."
                text_view = TextView(context)
                text_view.setText(template_name)
                text_view.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 16)
                text_view.setTextColor(Theme.getColor(Theme.key_dialogTextBlack))
                text_view.setGravity(Gravity.CENTER_VERTICAL)
                text_view.setMaxLines(2)
                item_container.addView(checkbox, LayoutHelper.createFrame(24, 24, Gravity.CENTER_VERTICAL | Gravity.LEFT, 16, 0, 0, 0))
                item_container.addView(text_view, LayoutHelper.createFrame(-1, -1, Gravity.CENTER_VERTICAL | Gravity.LEFT, 56, 0, 16, 0))
                checkboxes[i] = checkbox
                class ItemClickImpl(OnClick):
                    def __init__(self, item_index):
                        super().__init__()
                        self.item_index = item_index
                    def onClick(self, v):
                        checkbox = checkboxes.get(self.item_index)
                        if checkbox:
                            if self.item_index in selected_items:
                                selected_items.remove(self.item_index)
                                checkbox.setChecked(False, True)
                            else:
                                selected_items.add(self.item_index)
                                checkbox.setChecked(True, True)
                item_container.setOnClickListener(ItemClickImpl(i))
                scroll_content.addView(item_container, LayoutHelper.createLinear(-1, 56, Gravity.TOP, 0, 0, 0, 0))
            action_button = TextView(context)
            try:
                base_color = Theme.getColor(Theme.key_featuredStickers_addButton)
            except Exception:
                base_color = Theme.getColor(Theme.key_dialogTextBlue)
            try:
                pressed_color = Theme.getColor(Theme.key_featuredStickers_addButtonPressed)
            except Exception:
                pressed_color = base_color
            action_button.setBackground(Theme.createSimpleSelectorRoundRectDrawable(
                AndroidUtilities.dp(28), 
                base_color, 
                pressed_color
            ))
            action_button.setGravity(Gravity.CENTER)
            action_button.setSingleLine(True)
            action_button.setText(t('select', lang=self.lang))
            action_button.setTextColor(Theme.getColor(Theme.key_featuredStickers_buttonText))
            action_button.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 16)
            action_button.setTypeface(AndroidUtilities.bold())
            action_button.setEnabled(True)
            action_button.setPadding(0, AndroidUtilities.dp(14), 0, AndroidUtilities.dp(14))
            class ActionClickImpl(OnClick):
                def onClick(self, v):
                    selected_indices[:] = list(selected_items)
                    if on_selection_complete:
                        on_selection_complete(selected_indices)
                    run_on_ui_thread(lambda: bottom_sheet.dismiss())
            action_button.setOnClickListener(ActionClickImpl())
            self._apply_press_scale(action_button)
            try:
                action_button.setAlpha(0.0)
                action_button.setTranslationY(AndroidUtilities.dp(40))
                action_button.setScaleX(0.8)
                action_button.setScaleY(0.8)
            except Exception:
                pass
            scroll_content.addView(action_button, LayoutHelper.createLinear(-1, -2, Gravity.START, 14, 8, 14, 20))
            bottom_sheet.setCanDismissWithSwipe(False)
            bottom_sheet.show()
            def animate_elements():
                try:
                    try:
                        title_text_view.animate().alpha(1.0).translationY(0).scaleX(1.0).scaleY(1.0).setDuration(350).start()
                    except Exception:
                        pass
                    try:
                        scroll_content.animate().alpha(1.0).translationY(0).scaleX(1.0).scaleY(1.0).setDuration(350).setStartDelay(50).start()
                    except Exception:
                        pass
                    try:
                        action_button.animate().alpha(1.0).translationY(0).scaleX(1.0).scaleY(1.0).setDuration(350).setStartDelay(100).start()
                    except Exception:
                        pass
                except Exception:
                    pass
            try:
                run_on_ui_thread(animate_elements)
            except Exception:
                pass
        except Exception as e:
            pass

    def _show_import_templates_alert(self, data, act=None):
        try:
            from ui.alert import AlertDialogBuilder
            from client_utils import get_last_fragment
            from android_utils import run_on_ui_thread
            if act is None:
                frag = get_last_fragment()
                act = frag.getParentActivity() if frag else None
            if not act:
                return
            def _show():
                builder = AlertDialogBuilder(act)
                builder.set_title(t('import_dialog_title', lang=self.lang))
                builder.set_message(t('import_question', lang=self.lang))
                def on_apply(b, w):
                    try:
                        templates = data.get("templates", []) if isinstance(data, dict) else []
                        if not isinstance(templates, list):
                            templates = []
                        self.set_setting("templates_created_count", min(max(len(templates), 1), TEMPLATE_COUNT), reload_settings=True)
                        self.templates = []
                        for i in range(TEMPLATE_COUNT):
                            if i < len(templates):
                                item = templates[i] or {}
                                name = str(item.get("name", ""))
                                text = str(item.get("text", ""))
                            else:
                                name = ""
                                text = ""
                            self.set_setting(f"template_name_{i}", name, reload_settings=True)
                            self.set_setting(f"template_text_{i}", text, reload_settings=True)
                            self.templates.append({"name": name, "text": text, "enabled": True if i == 0 else bool(name and text)})
                        self.set_setting("templates", self.templates, reload_settings=True)
                        from ui.bulletin import BulletinHelper
                        from android_utils import run_on_ui_thread
                        try:
                            from org.telegram.messenger import R as R_tg
                            icon_attr = getattr(R_tg.raw, 'settings', None)
                        except Exception:
                            icon_attr = None
                        def _open_settings():
                            try:
                                self.open_plugin_settings()
                            except Exception as e:
                                from ui.bulletin import BulletinHelper
                                BulletinHelper.show_error(t('open_settings_error', lang=self.lang, error=str(e)))
                        run_on_ui_thread(lambda: BulletinHelper.show_with_button(
                            t('import_success', lang=self.lang),
                            icon_attr if icon_attr else 0,
                            t('settings', lang=self.lang),
                            _open_settings,
                            None
                        ))
                    except Exception as e:
                        from ui.bulletin import BulletinHelper
                        run_on_ui_thread(lambda: BulletinHelper.show_error(t('import_error', lang=self.lang, error=str(e))))
                    finally:
                        b.dismiss()
                builder.set_positive_button(t('import', lang=self.lang), on_apply)
                builder.set_negative_button(t('cancel', lang=self.lang), lambda b, w: b.dismiss())
                builder.show()
            run_on_ui_thread(_show)
        except Exception as e:
            from ui.bulletin import BulletinHelper
            BulletinHelper.show_error(t('import_error', lang=self.lang, error=str(e)))

    def _send_file(self, peer_id, path, caption=None):
        try:
            from org.telegram.messenger import SendMessagesHelper
            from client_utils import get_account_instance
            from java import jarray, jint, jlong
            try:
                from java.lang import Integer
            except Exception:
                Integer = int
            try:
                from java.io import File as JFile
                size = JFile(path).length()
            except Exception:
                pass
            methods = SendMessagesHelper.getClass().getDeclaredMethods()
            target = None
            use_uri = False
            for m in methods:
                if m.getName() == "prepareSendingDocumentInternal":
                    try:
                        params = m.getParameterTypes()
                        if len(params) > 1 and "android.net.Uri" in str(params[1]):
                            use_uri = True
                        else:
                            pass
                    except Exception:
                        pass
                    target = m
                    break
            if target is None:
                try:
                    names = ", ".join([mm.getName() for mm in methods])
                except Exception:
                    pass
                raise Exception("prepareSendingDocumentInternal not found")
            target.setAccessible(True)
            mime = "application/json"
            if use_uri:
                try:
                    from android.net import Uri as AndroidUri
                    from java.io import File as JFile
                    fileUri = AndroidUri.fromFile(JFile(path))
                    arg1 = fileUri
                    arg2 = fileUri
                except Exception:
                    arg1 = path
                    arg2 = path
            else:
                arg1 = path
                arg2 = path
            params = target.getParameterTypes()
            try:
                types_str = ", ".join([p.getName() for p in params])
            except Exception:
                pass
            int_array_value = None
            try:
                types_names = [p.getName() for p in params]
                if any((n.startswith('[L') and 'java.lang.Integer' in n) or 'java.lang.Integer[]' in n for n in types_names):
                    int_array_value = jarray(Integer)([0])
                elif any(n == '[I' or 'int[]' in n for n in types_names):
                    int_array_value = jarray(jint)([0])
                else:
                    int_array_value = jarray(jint)([0])
            except Exception:
                int_array_value = jarray(jint)([0])
            args = [
                get_account_instance(), arg1, arg2, None, mime,
                peer_id, None, None,
                None, None, None,
                None, jarray(jlong)([0]), True, caption, True,
                jint(0), int_array_value, True,
                None, jint(0),
                0, False, 0,
                0
            ]
            if len(params) != len(args):
                def _def_for(t):
                    try:
                        name = t.getName()
                    except Exception:
                        name = str(t)
                    if name == 'boolean':
                        return False
                    if name == 'int':
                        return jint(0)
                    if name == 'java.lang.Integer':
                        try:
                            return Integer(0)
                        except Exception:
                            return jint(0)
                    if name == 'long':
                        return 0
                    if name == 'float' or name == 'double':
                        return 0.0
                    if name == 'int[]':
                        return jarray(jint)([0])
                    if name == 'long[]':
                        return jarray(jlong)([0])
                    return None
                if len(params) > len(args):
                    for k in range(len(args), len(params)):
                        args.append(_def_for(params[k]))
                else:
                    args = args[:len(params)]
            target.invoke(None, *args)
        except Exception as e:
            from ui.bulletin import BulletinHelper
            BulletinHelper.show_error(t('export_error', lang=self.lang, error=str(e)))
    def _show_filtered_template_menu(self, templates):
        from org.telegram.ui.ActionBar import BottomSheet
        from org.telegram.ui.Components import LayoutHelper
        from android.widget import LinearLayout, TextView, ScrollView, FrameLayout
        from android.view import Gravity, View
        from android.util import TypedValue
        from org.telegram.ui.ActionBar import Theme
        from org.telegram.messenger import AndroidUtilities
        from android_utils import OnClickListener
        from client_utils import get_last_fragment
        from android.graphics.drawable import GradientDrawable
        from android.graphics import Color
        frag = get_last_fragment()
        act = frag.getParentActivity() if frag else None
        if not act:
            return
        builder = BottomSheet.Builder(act)
        builder.setApplyTopPadding(False)
        builder.setApplyBottomPadding(False)
        linearLayout = LinearLayout(act)
        builder.setCustomView(linearLayout)
        linearLayout.setOrientation(LinearLayout.VERTICAL)
        titleTextView = TextView(act)
        titleTextView.setTextColor(Theme.getColor(Theme.key_dialogTextBlack))
        titleTextView.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 24)
        titleTextView.setGravity(Gravity.CENTER)
        titleTextView.setTypeface(AndroidUtilities.getTypeface("fonts/rmedium.ttf"))
        if templates:
            titleTextView.setText(t('select_template', lang=self.lang))
        else:
            titleTextView.setText(t('no_templates_available', lang=self.lang))
        linearLayout.addView(titleTextView, LayoutHelper.createFrame(-1, -2, Gravity.TOP, 0, 16, 0, 8))
        contentFrame = FrameLayout(act)
        linearLayout.addView(contentFrame, LayoutHelper.createLinear(-1, 0, 1.0))
        scrollView = ScrollView(act)
        scrollView.setFillViewport(True)
        try:
            scrollView.setNestedScrollingEnabled(True)
        except Exception:
            pass
        buttonsLayout = LinearLayout(act)
        buttonsLayout.setOrientation(LinearLayout.VERTICAL)
        def create_template_button(template):
            def send_template(v=None):
                try:
                    builder.getDismissRunnable().run()
                    self.menu_shown = False
                    self._send_template_to_current_chat(template['index'], template['name'], template['text'])
                except Exception as e:
                    from ui.bulletin import BulletinHelper
                    BulletinHelper.show_error(t('error_occurred_with_reason', lang=self.lang, error=str(e)))
            from android.widget import LinearLayout
            buttonContainer = LinearLayout(act)
            buttonContainer.setOrientation(LinearLayout.VERTICAL)
            buttonContainer.setPadding(AndroidUtilities.dp(16), AndroidUtilities.dp(12), AndroidUtilities.dp(16), AndroidUtilities.dp(12))
            buttonContainer.setBackground(Theme.createSimpleSelectorRoundRectDrawable(
                AndroidUtilities.dp(8),
                Theme.getColor(Theme.key_dialogBackground),
                Theme.getColor(Theme.key_dialogBackgroundGray)
            ))
            buttonContainer.setClickable(True)
            buttonContainer.setOnClickListener(OnClickListener(send_template))
            nameTextView = TextView(act)
            name = template['name']
            maxNameLength = 30
            name_lines = name.split('\n')
            if len(name_lines) > 3:
                name = '\n'.join(name_lines[:3]) + "\n..."
            elif len(name) > maxNameLength:
                name = name[:maxNameLength] + "..."
            nameTextView.setText(name)
            nameTextView.setTextColor(Theme.getColor(Theme.key_dialogTextBlack))
            nameTextView.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 16)
            nameTextView.setTypeface(AndroidUtilities.getTypeface("fonts/rmedium.ttf"))
            nameTextView.setGravity(Gravity.LEFT)
            nameTextView.setMaxLines(3)
            buttonContainer.addView(nameTextView)
            text = template['text']
            maxLength = 50
            text_lines = text.split('\n')
            if len(text_lines) > 3:
                text = '\n'.join(text_lines[:3]) + "\n..."
            elif len(text) > maxLength:
                text = text[:maxLength] + "..."
            textTextView = TextView(act)
            textTextView.setText(text)
            textTextView.setTextColor(Theme.getColor(Theme.key_dialogTextGray))
            textTextView.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 14)
            textTextView.setGravity(Gravity.LEFT)
            textTextView.setPadding(0, AndroidUtilities.dp(4), 0, 0)
            textTextView.setMaxLines(3)
            buttonContainer.addView(textTextView)
            return buttonContainer
        for i, template in enumerate(templates):
            btn = create_template_button(template)
            buttonsLayout.addView(btn, LayoutHelper.createFrame(-1, -2, Gravity.TOP, 16, 4, 16, 4))
            if i < len(templates) - 1:
                divider = View(act)
                try:
                    divider.setBackgroundColor(Theme.getColor(Theme.key_divider))
                except Exception:
                    divider.setBackgroundColor(0x33000000)
                buttonsLayout.addView(divider, LayoutHelper.createFrame(-1, 1, Gravity.TOP, 16, 0, 16, 0))
        scrollView.addView(buttonsLayout)
        contentFrame.addView(scrollView, FrameLayout.LayoutParams(-1, -1))
        settingsBtnContainer = LinearLayout(act)
        settingsBtnContainer.setOrientation(LinearLayout.HORIZONTAL)
        settingsBtnContainer.setGravity(Gravity.CENTER_HORIZONTAL)
        settingsBtn = FrameLayout(act)
        try:
            base_color = Theme.getColor(Theme.key_featuredStickers_addButton)
        except Exception:
            base_color = Theme.getColor(Theme.key_dialogTextBlue)
        try:
            pressed_color = Theme.getColor(Theme.key_featuredStickers_addButtonPressed)
        except Exception:
            pressed_color = base_color
        settingsBtn.setBackground(Theme.createSimpleSelectorRoundRectDrawable(
            AndroidUtilities.dp(28),
            base_color,
            pressed_color
        ))
        settingsBtn.setPadding(0, AndroidUtilities.dp(14), 0, AndroidUtilities.dp(14))
        settingsBtn.setClickable(True)
        settingsBtn.setFocusable(True)
        settingsBtnText = TextView(act)
        settingsBtnText.setText(t('settings', lang=self.lang))
        settingsBtnText.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 16)
        settingsBtnText.setTypeface(AndroidUtilities.bold())
        settingsBtnText.setGravity(Gravity.CENTER)
        settingsBtnText.setTextColor(Theme.getColor(Theme.key_featuredStickers_buttonText))
        settingsBtn.addView(settingsBtnText, FrameLayout.LayoutParams(-1, -2))
        def on_settings(v=None):
            builder.getDismissRunnable().run()
            self.menu_shown = False
            self.open_plugin_settings()
        settingsBtn.setOnClickListener(OnClickListener(on_settings))
        self._apply_press_scale(settingsBtn)
        settingsBtnContainer.addView(settingsBtn, LayoutHelper.createLinear(-1, -2, Gravity.CENTER_HORIZONTAL, 24, 0, 24, 0))
        linearLayout.addView(settingsBtnContainer, LayoutHelper.createLinear(-1, -2, 0, 8, 0, 16))
        sheet = builder.show()
        sheet.setCanDismissWithSwipe(False)
        def on_dismiss():
            self.menu_shown = False
        try:
            sheet.setOnDismissListener(dynamic_proxy(android.content.DialogInterface.OnDismissListener)(on_dismiss))
        except Exception:
            pass
        return sheet

    def _send_template_to_current_chat(self, template_index, template_name, template_text):
        import time
        try:
            from client_utils import get_last_fragment
            from org.telegram.ui import ChatActivity
            frag = get_last_fragment()
            if not frag:
                from ui.bulletin import BulletinHelper
                BulletinHelper.show_error(t('error_occurred', lang=self.lang))
                return
            if not isinstance(frag, ChatActivity):
                from ui.bulletin import BulletinHelper
                BulletinHelper.show_error(t('error_occurred', lang=self.lang))
                return
            chat_id = None
            try:
                dialog_id = frag.getDialogId()
                if dialog_id:
                    chat_id = dialog_id
            except Exception:
                pass
            if not chat_id:
                try:
                    current_chat = frag.getCurrentChat()
                    if current_chat and hasattr(current_chat, 'id'):
                        chat_id = current_chat.id
                except Exception:
                    pass
            if not chat_id:
                try:
                    current_user = frag.getCurrentUser()
                    if current_user and hasattr(current_user, 'id'):
                        chat_id = current_user.id
                except Exception:
                    pass
            if not chat_id:
                try:
                    current_peer = frag.getCurrentPeer()
                    if current_peer and hasattr(current_peer, 'id'):
                        chat_id = current_peer.id
                except Exception:
                    pass
            if not chat_id:
                try:
                    args = frag.getArguments()
                    if args:
                        dialog_id = args.getLong("dialog_id", 0)
                        if dialog_id:
                            chat_id = dialog_id
                except Exception:
                    pass
            if not chat_id:
                from ui.bulletin import BulletinHelper
                BulletinHelper.show_error(t('error_occurred', lang=self.lang))
                return
            preprocessed = preprocess_template_markdown(template_text)
            parsed = parse_markdown(preprocessed)
            try:
                from client_utils import send_message
                message_data = {
                    "peer": chat_id,
                    "message": parsed.text,
                    "entities": [ent.to_tlrpc_object() for ent in parsed.entities]
                }
                send_message(message_data)
            except Exception:
                try:
                    from org.telegram.messenger import SendMessagesHelper
                    from org.telegram.tgnet import TLRPC
                    message = TLRPC.TL_message()
                    message.message = parsed.text
                    message.dialog_id = chat_id
                    message.date = int(time.time())
                    message.out = True
                    if parsed.entities:
                        message.entities = [ent.to_tlrpc_object() for ent in parsed.entities]
                    SendMessagesHelper.getInstance().sendMessage(message)
                except Exception as e2:
                    raise e2
            from ui.bulletin import BulletinHelper
            from android_utils import run_on_ui_thread
            try:
                from org.telegram.messenger import R as R_tg
                icon_attr = getattr(R_tg.raw, 'done', None)
            except Exception:
                icon_attr = None
            def _open():
                try:
                    if chat_id:
                        self._open_chat_by_dialog_id(chat_id)
                except Exception:
                    pass
            run_on_ui_thread(lambda: BulletinHelper.show_success(t('template_n_sent', lang=self.lang, n=template_index+1)))
        except Exception as e:
            from ui.bulletin import BulletinHelper
            BulletinHelper.show_error(t('error_occurred_with_reason', lang=self.lang, error=str(e)))

class TemplateDialogsDelegate(dynamic_proxy(DialogsActivity.DialogsActivityDelegate)):
    def __init__(self, fn):
        super().__init__()
        self._fn = fn
    def didSelectDialogs(self, fragment, dids, message, param, notify, scheduleDate, topicsFragment):
        try:
            self._fn(fragment, dids, message, param, notify, scheduleDate, topicsFragment)
        except Exception as e:
            from ui.bulletin import BulletinHelper
            BulletinHelper.show_error(f"{t('error_prefix', lang=self.lang)} {e}")

class _LinkAliasEnterViewConstructorHook(MethodHook):
    def __init__(self, plugin):
        MethodHook.__init__(self)
        self._plugin_ref = weakref.ref(plugin)

    @property
    def plugin(self):
        return self._plugin_ref() if self._plugin_ref else None

    def after_hooked_method(self, param):
        try:
            plugin = self.plugin
            if not plugin:
                return
            enter_view = param.thisObject
            def attach_watcher():
                plugin._templates_view_attach_text_watcher(enter_view)
            run_on_ui_thread(attach_watcher, delay=500)
        except Exception as e:
            pass

def _setup_templates_view_search(self):
    try:
        self._templates_view_hook_enter_view_constructor()
    except Exception as e:
        pass

def _templates_view_get_class(self, class_name):
    if class_name not in self._templates_view_class_cache:
        self._templates_view_class_cache[class_name] = find_class(class_name)
    return self._templates_view_class_cache[class_name]

def _templates_view_hook_enter_view_constructor(self):
    try:
        ChatActivityEnterView = self._templates_view_get_class("org.telegram.ui.Components.ChatActivityEnterView")
        Activity = self._templates_view_get_class("android.app.Activity")
        SizeNotifierFrameLayout = self._templates_view_get_class("org.telegram.ui.Components.SizeNotifierFrameLayout")
        ChatActivity = self._templates_view_get_class("org.telegram.ui.ChatActivity")
        ResourcesProvider = self._templates_view_get_class("org.telegram.ui.ActionBar.Theme$ResourcesProvider")
        if not all([ChatActivityEnterView, Activity, SizeNotifierFrameLayout, ChatActivity]):
            return
        constructor = ChatActivityEnterView.getClass().getDeclaredConstructor(
            Activity,
            SizeNotifierFrameLayout,
            ChatActivity,
            jclass("java.lang.Boolean").TYPE,
            ResourcesProvider
        )
        constructor.setAccessible(True)
        self.templates_view_hook_constructor_ref = self.hook_method(constructor, _LinkAliasEnterViewConstructorHook(self))
    except Exception as e:
        pass

def _templates_view_attach_text_watcher(self, enter_view):
    try:
        view_id = id(enter_view)
        if view_id in self.templates_view_attached_views:
            return
        message_edit_text = get_private_field(enter_view, "messageEditText")
        if not message_edit_text:
            return
        self.templates_view_current_enter_view_ref = weakref.ref(enter_view)
        TextWatcherInterface = self._templates_view_get_class("android.text.TextWatcher")
        plugin_ref = weakref.ref(self)
        class CustomTextWatcher(dynamic_proxy(TextWatcherInterface)):
            def beforeTextChanged(self, s, start, count, after):
                pass
            def onTextChanged(self, s, start, before, count):
                pass
            def afterTextChanged(self, editable):
                plugin = plugin_ref()
                if not plugin:
                    return
                try:
                    text = str(editable.toString()) if editable else ""

                    if text.startswith("/"):
                        send_cmd = plugin.get_setting('send_cmd', '//').strip()
                        if not send_cmd:
                            send_cmd = '//'
                        if text.startswith(send_cmd):
                            cmd_len = len(send_cmd)
                            if len(text) > cmd_len:
                                search_key = text[cmd_len:].lower().strip()
                                plugin._templates_view_show_matching_settings(search_key)
                            else:
                                plugin._templates_view_hide_popup()
                        else:
                            plugin._templates_view_hide_popup()
                    else:
                        plugin._templates_view_hide_popup()
                except Exception as e:
                    pass
        watcher = CustomTextWatcher()
        message_edit_text.addTextChangedListener(watcher)
        self.templates_view_attached_views.add(view_id)
    except Exception as e:
        pass

def _templates_view_collect_settings_with_alias(self):
    settings_list = []
    try:
        for i, template in enumerate(self.templates):
            if template.get('enabled', False) and template.get('name', '') and template.get('text', ''):
                settings_list.append({
                    'plugin_id': 'templates',
                    'plugin_name': 'Templates',
                    'setting_name': template['name'],
                    'templates_view_alias': f'template_{i}',
                    'search_key': template['name'].lower(),
                    'template_index': i,
                    'template_text': template['text']
                })
        return settings_list
    except Exception as e:
        pass
    return settings_list

def _templates_view_show_matching_settings(self, search_key):
    try:
        all_settings = self._templates_view_collect_settings_with_alias()
        if not all_settings:
            self._templates_view_hide_popup()
            return
        matching = []
        for setting in all_settings:
            if setting['setting_name'].lower().startswith(search_key):
                matching.append(setting)
        if not matching:
            self._templates_view_hide_popup()
            return
        self._templates_view_show_bot_commands_popup(matching)
        self._update_popup_size()
    except Exception as e:
        pass

def _update_popup_size(self):
    try:
        if self.templates_view_custom_container:
            run_on_ui_thread(lambda: self.templates_view_custom_container.requestLayout())
    except:
        pass

def _templates_view_show_bot_commands_popup(self, settings):
    try:
        from org.telegram.ui.Components import RecyclerListView
        enter_view = self.templates_view_current_enter_view_ref() if self.templates_view_current_enter_view_ref else None
        if not enter_view:
            fragment = get_last_fragment()
            if fragment:
                enter_view = get_private_field(fragment, "chatActivityEnterView")
                if enter_view:
                    self.templates_view_current_enter_view_ref = weakref.ref(enter_view)
        if not enter_view:
            return
        bot_container = get_private_field(enter_view, "botCommandsMenuContainer")
        bot_adapter = get_private_field(enter_view, "botCommandsAdapter")
        if not bot_container:
            try:
                ChatActivityEnterView = self._templates_view_get_class("org.telegram.ui.Components.ChatActivityEnterView")
                create_method = ChatActivityEnterView.getClass().getDeclaredMethod("createBotCommandsMenuContainer")
                create_method.setAccessible(True)
                create_method.invoke(enter_view)
                bot_container = get_private_field(enter_view, "botCommandsMenuContainer")
                bot_adapter = get_private_field(enter_view, "botCommandsAdapter")
            except Exception as e:
                pass
        if not bot_container or not bot_adapter:
            return
        commands = []
        descriptions = []
        self.templates_view_current_settings = {}
        for setting in settings[:10]:
            cmd = setting['template_text'][:25] + "..." if len(setting['template_text']) > 25 else setting['template_text']
            desc = setting['setting_name'][:15] + "..." if len(setting['setting_name']) > 15 else setting['setting_name']
            commands.append(cmd)
            descriptions.append(desc)
            self.templates_view_current_settings[cmd] = setting
        new_result_field = bot_adapter.getClass().getDeclaredField("newResult")
        new_result_field.setAccessible(True)
        new_result = new_result_field.get(bot_adapter)
        new_result.clear()
        for cmd in commands:
            new_result.add(cmd)
        new_result_help_field = bot_adapter.getClass().getDeclaredField("newResultHelp")
        new_result_help_field.setAccessible(True)
        new_result_help = new_result_help_field.get(bot_adapter)
        new_result_help.clear()
        for desc in descriptions:
            new_result_help.add(desc)
        bot_adapter.notifyDataSetChanged()
        plugin_ref = weakref.ref(self)
        class ClickListener(dynamic_proxy(RecyclerListView.OnItemClickListener)):
            def onItemClick(self, view, position):
                plugin = plugin_ref()
                if not plugin:
                    return
                try:
                    if hasattr(view, 'getCommand'):
                        command = view.getCommand()
                        setting = plugin.templates_view_current_settings.get(str(command))
                        if setting:
                            template_name = setting['setting_name']
                            template_text = None
                            template_index = None
                            for i, template in enumerate(plugin.templates):
                                if template.get('name', '') == template_name:
                                    template_text = template.get('text', '')
                                    template_index = i
                                    break
                            
                            if template_text:
                                enter_view_ref = plugin.templates_view_current_enter_view_ref
                                ev = enter_view_ref() if enter_view_ref else None
                                def ui_actions():
                                    try:
                                        if ev:
                                            ev.setFieldText("")
                                        bot_container.dismiss()
                                    except Exception:
                                        pass
                                run_on_ui_thread(ui_actions)
                                plugin._send_template_to_current_chat(template_index, template_name, template_text)
                except Exception as e:
                    pass
        
        class LongClickListener(dynamic_proxy(RecyclerListView.OnItemLongClickListener)):
            def onItemClick(self, view, position):
                plugin = plugin_ref()
                if not plugin:
                    return False
                try:
                    if hasattr(view, 'getCommand'):
                        command = view.getCommand()
                        setting = plugin.templates_view_current_settings.get(str(command))
                        if setting:
                            template_name = setting['setting_name']
                            template_text = None
                            for template in plugin.templates:
                                if template.get('name', '') == template_name:
                                    template_text = template.get('text', '')
                                    break
                            
                            if template_text:
                                enter_view_ref = plugin.templates_view_current_enter_view_ref
                                ev = enter_view_ref() if enter_view_ref else None
                                def ui_actions():
                                    try:
                                        if ev:
                                            ev.setFieldText(template_text + " ")
                                        bot_container.dismiss()
                                    except Exception:
                                        pass
                                run_on_ui_thread(ui_actions)
                                return True
                except Exception as e:
                    pass
                return False
        bot_container.listView.setOnItemClickListener(ClickListener())
        bot_container.listView.setOnItemLongClickListener(LongClickListener())
        try:
            from android.widget import LinearLayout
            from android.view import ViewGroup
            from android.util import TypedValue
            parent = bot_container.listView.getParent()
            if parent and isinstance(parent, LinearLayout):
                parent.setPadding(0, 4, 0, 0)
            try:
                enter_view_rect = android.graphics.Rect()
                enter_view.getGlobalVisibleRect(enter_view_rect)
                enter_view_width = enter_view_rect.width()
                container_params = bot_container.getLayoutParams()
                if container_params:
                    container_params.width = enter_view_width
                    bot_container.setLayoutParams(container_params)
                    list_params = bot_container.listView.getLayoutParams()
                    if list_params:
                        list_params.width = enter_view_width
                        bot_container.listView.setLayoutParams(list_params)
            except:
                pass
            bot_container.requestLayout()
        except:
            pass
        self.templates_view_custom_container = bot_container
        bot_container.show()
    except Exception as e:
        pass

def _send_template_text(self, fragment, template_text):
    try:
        preprocessed = preprocess_template_markdown(template_text)
        parsed = parse_markdown(preprocessed)
        try:
            from client_utils import send_message
            message_data = {
                "peer": fragment.getCurrentDialogId(),
                "message": parsed.text,
                "entities": [ent.to_tlrpc_object() for ent in parsed.entities]
            }
            send_message(message_data)
        except Exception:
            try:
                from org.telegram.messenger import SendMessagesHelper
                from org.telegram.tgnet import TLRPC
                message = TLRPC.TL_message()
                message.message = parsed.text
                message.dialog_id = fragment.getCurrentDialogId()
                message.date = int(time.time())
                message.out = True
                if parsed.entities:
                    message.entities = [ent.to_tlrpc_object() for ent in parsed.entities]
                SendMessagesHelper.getInstance().sendMessage(message)
            except Exception as e2:
                pass
    except Exception as e:
        pass

def _templates_view_hide_popup(self):
    try:
        if self.templates_view_custom_container:
            self.templates_view_custom_container.dismiss()
    except Exception as e:
        pass

TemplatesPlugin._setup_templates_view_search = _setup_templates_view_search
TemplatesPlugin._templates_view_get_class = _templates_view_get_class
TemplatesPlugin._templates_view_hook_enter_view_constructor = _templates_view_hook_enter_view_constructor
TemplatesPlugin._templates_view_attach_text_watcher = _templates_view_attach_text_watcher
TemplatesPlugin._templates_view_collect_settings_with_alias = _templates_view_collect_settings_with_alias
TemplatesPlugin._templates_view_show_matching_settings = _templates_view_show_matching_settings
TemplatesPlugin._update_popup_size = _update_popup_size
TemplatesPlugin._templates_view_show_bot_commands_popup = _templates_view_show_bot_commands_popup
TemplatesPlugin._send_template_text = _send_template_text
TemplatesPlugin._templates_view_hide_popup = _templates_view_hide_popup


# Спасибо за некоторые части кода @QuantaPlugins и @mishabotov!

# Thanks for some code snippets to @QuantaPlugins and @mishabotov!