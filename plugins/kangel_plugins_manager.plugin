"""
                            –î–ò–°–ö–õ–ï–ô–ú–ï–†

–ö–æ—Ä–æ—á–µ , –µ—Å–ª–∏ —Ç–µ–±–µ –Ω—É–∂–µ–Ω –∫—É—Å–æ–∫ –∫–æ–¥–∞ –∏–∑ —ç—Ç–æ–≥–æ –ø–ª–∞–≥–∏–Ω–∞ , —Ç–æ –ø–∂
—É–∫–∞–∑—ã–≤–∞–π –≤ –æ–ø–∏—Å–∞–Ω–∏–∏ –∏–ª–∏ –≥–¥–µ-—Ç–æ –µ—â–µ , —á—Ç–æ –≤–∑—è–ª –∫–æ–¥ —Å @KangelPlugins
                              –°–ø–∞—Å–∏–±–æ
                        üôè –ë–õ–ê–ì–û–°–õ–ê–í–õ–ï–ù–ò–ï üôè

‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£Ä‚£Ä‚°§‚†§‚£Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚£§‚°§‚£§‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£†‚†û‚†â‚¢Ä‚£§‚†∂‚†Æ‚†∑‚£§‚£Ä‚°Ä‚†Ä‚†Ä‚¢Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚°º‚†ã‚†à‚£Ω‚£Ü‚†π‚£¶‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚£§‚†∂‚†∂‚†∂‚†∂‚£Ñ‚†Ä‚†Ä‚†Ä‚£û‚£Å‚£†‚†¥‚†Ø‚†∞‚†∂‚†∂‚†∂‚£æ‚†Å‚†ô‚£Ø‚£≥‚£•‚†û‚¢π‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚°æ‚†Ä‚¢†‚°æ‚†Å‚¢π‚†Ä‚¢ª‚£ß‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£†‚†è‚†Ä‚£ä‚£Ä‚£ê‚£Ä‚°à‚¢ì‚£¶‚°ñ‚†ã‚†Å‚†Ä‚°∞‚†Ç‚†Ä‚†Ä‚†Ä‚†Ä‚£π‚¢†‚£Ñ‚£Ω‚†¨‚£æ‚†â‚¢π‚†≥‚°Ñ‚†Ä‚†Ä‚†Ä‚¢∏‚†á‚†Ä‚¢∏‚†Ä‚¢Ä‚°º‚°á‚¢à‚°æ‚°¶‚£Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢∞‚°è‚£†‚°æ‚†â‚¢Ä‚†Ä‚£Ä‚°Ω‚†õ‚¢É‚°Ñ‚†Ä‚†Ä‚°ú‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ô‚†õ‚†õ‚¢ß‚°Ä‚†à‚†ª‚¢æ‚°Ñ‚†à‚¢ß‚°Ä‚†Ä‚¢∏‚†Ä‚†Ä‚¢∏‚°∞‚°ø‚†õ‚°ß‚†ä‚°Ñ‚£ø‚£Æ‚†≥‚£Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢∏‚°æ‚¢π‚°á‚†Ä‚†Ä‚£¥‚†õ‚†Ä‚¢Ä‚†é‚†Ä‚†Ä‚£º‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢∏‚°π‚£¶‚°Ä‚†Ä‚£≥‚†∂‚£æ‚£≥‚°Ñ‚£∏‚†Ä‚†Ä‚¢∏‚†É‚¢Ä‚£¥‚†É‚†Ä‚¢°‚£ß‚£Ω‚†Ä‚†π‚°Ñ‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢∏‚°á‚¢∏‚°á‚¢∞‚°æ‚†ì‚†Ä‚†Ä‚°é‚†Ä‚†Ä‚¢†‚£ø‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚°û‚°â‚¢∫‚£Ø‚£´‚°∑‚†¶‚°ø‚†ô‚¢∑‚°á‚†Ä‚¢Ä‚°è‚£†‚†ø‚°ü‚†Ä‚¢†‚£æ‚°ñ‚°ü‚°Ü‚†Ä‚°á‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ò‚¢ß‚†Ä‚£≥‚¢ø‚°æ‚†Ä‚†Ä‚£º‚†Å‚†Ä‚£Ä‚£æ‚£ø‚†Ä‚†Ä‚°Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢∞‚†Ä‚†∑‚¢ø‚°ü‚†Å‚†à‚†ª‚£ß‚°á‚£†‚¢æ‚£á‚£§‚†û‚£¥‚†É‚°æ‚†Å‚¢Ä‚°ø‚†â‚†í‚¢ª‚°á‚†Ä‚°á‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ò‚¢ª‚£ß‚°æ‚¢†‚†É‚¢Ä‚°á‚†Ä‚¢Ä‚°æ‚†Å‚†∏‚£º‚°Ä‚£á‚†Ä‚†Ä‚†Ä‚£Ü‚†Ä‚¢∏‚°Ü‚†Ä‚¢†‚¢ß‚°Ä‚†Ä‚†Ä‚°∑‚£û‚£°‚†é‚£á‚£§‚†û‚†Å‚°º‚†Å‚¢Ä‚°ø‚†Å‚†Ä‚†Ä‚¢π‚†Å‚¢†‚†á‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£Ä‚°†‚†Ä‚¢Ä‚£ø‚£è‚°á‚¢∏‚°Ä‚†Ä‚°á‚†Ä‚£æ‚†É‚†Ä‚†Ä‚†â‚†ª‚†è‚†ì‚†∂‚†∂‚†ø‚¢§‚£Ä‚°∑‚¢Ñ‚£∏‚¢Æ‚£ø‚°¶‚£§‚°ü‚†â‚£ø‚¢∏‚°è‚†Å‚†Ä‚£∏‚†Å‚¢Ä‚°û‚†É‚†Ä‚†Ä‚†î‚°ø‚†Ä‚°æ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†π‚°í‚†Ä‚†ò‚£ø‚£ø‚°á‚†∏‚£á‚¢∞‚°á‚¢∞‚£ß‚£∂‚£∂‚£∂‚°Ü‚†Ä‚†Ä‚†Ä‚†Ä‚£¥‚£ñ‚£Ñ‚£í‚£¶‚£º‚£è‚£∞‚£æ‚†ø‚¢æ‚£Ø‚£â‚£è‚£æ‚°á‚†Ä‚†Ä‚°á‚†Ä‚£º‚†Å‚†Ä‚†Ä‚†Ä‚£∞‚†É‚£º‚†Ö‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ô‚†≥‚†õ‚†∂‚£Ω‚°á‚†Ä‚£ø‚°Ñ‚¢ª‚£∏‚£é‚†â‚†â‚†Å‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†â‚†â‚†â‚†â‚†Å‚¢π‚°è‚†Å‚†Ä‚£∏‚°è‚†ô‚°ø‚£ª‚†ë‚¢Ñ‚†Ä‚£ß‚†Ä‚°ü‚°Ü‚†Ä‚†Ä‚¢®‚†è‚°¥‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£ø‚¢∑‚†Ä‚£ø‚¢π‚£Ñ‚£ø‚†ø‚°Ç‚†Ä‚†Ä‚†Ä‚†â‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢æ‚†Å‚†Ä‚†Ä‚°ø‚£ß‚†û‚£±‚†á‚†Ä‚°ò‚†¶‚°Ω‚£Ñ‚£ø‚†π‚£Ñ‚°¥‚¢â‚†î‚†Å‚¢≥‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚£Ä‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢∞‚°ø‚¢∏‚£ß‚†ò‚£ü‚†ô‚£ø‚°Ñ‚†Ä‚†Ä‚¢Ä‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢†‚£Ø‚†ñ‚†Ä‚¢∞‚£∑‚¢á‚°º‚†É‚¢Ä‚†û‚†Ä‚°Ü‚†Ä‚†ô‚£ø‚°¶‚†ô‚¢∂‚°Å‚†Ä‚†Ä‚†Ä‚†Å‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†≤‚¢ø‚†ã‚†â‚†â‚†ô‚¢¶‚£Ä‚†Ä‚†Ä‚£ø‚°á‚¢∏‚£ø‚°∑‚†º‚¢∂‚†Ω‚£ø‚£Ü‚†Ä‚†à‚†ª‚†§‚†§‚†§‚†û‚†Ä‚†Ä‚†Ä‚†Ä‚¢¥‚£ø‚†á‚†Ä‚†Ä‚£∏‚°ø‚†ã‚†Ä‚†Ä‚†é‚†Ä‚°û‚†Ä‚£†‚†û‚¢Å‚†Ω‚¢¶‚°Ä‚†ô‚¢¶‚£Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚¢Ä‚†Ä‚†Ä‚¢∏‚£Ö‚†Ä‚†Ä‚†à‚†â‚†õ‚†â‚†î‚£ª‚£∏‚¢∏‚£ø‚†ø‚£†‚°è‚£ß‚†ô‚¢ø‚£ß‚£Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£Ä‚£¥‚£æ‚†É‚†Ä‚†Ä‚¢∞‚†á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£†‚†û‚¢Å‚°î‚†É‚†Ä‚†Å‚†ã‚†ó‚¢¶‚£à‚†≥‚£Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚¢ø‚£ù‚¢¶‚£∏‚°ú‚£Ü‚†Ä‚†Ä‚†Ä‚†Ä‚°Ä‚†Ä‚£ß‚°á‚†Ä‚°ø‚†Ä‚†Ä‚†Ä‚†â‚†Å‚†Ä‚†â‚†õ‚¢∑‚£Ñ‚£Ä‚£†‚£¥‚†û‚†â‚¢Å‚°æ‚†Å‚†Ä‚†Ä‚£∞‚†è‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢†‚£æ‚†É‚¢∞‚†è‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†â‚†õ‚¢∑‚£µ‚£Ñ‚†Ä‚†Ä‚†Ä
‚¢ª‚£ü‚£ø‚°ª‚£é‚¢£‚£≥‚°ò‚£Ü‚†Ä‚¢†‚°û‚°è‚†Ä‚£æ‚£ß‚†Ä‚£ß‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢†‚°ü‚£ø‚†Ä‚£†‚¢Ç‚£ü‚£°‚†Ñ‚£†‚¢æ‚£ã‚£Ä‚£Ä‚£Ä‚°Ä‚†Ä‚¢∞‚£ø‚†É‚¢†‚°è‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ô‚£ø‚†ª‚£Ñ‚†Ä
‚°à‚¢ª‚£Ü‚†ª‚°ü‚£Ü‚¢ª‚£ß‚¢ª‚£Ñ‚°º‚¢∏‚°á‚£¶‚£ø‚°º‚£ß‚£Ω‚°Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚£¥‚£ã‚£§‚£ø‚¢à‚†ü‚¢π‚°ø‚£°‚°û‚†â‚†â‚†Ä‚†Ä‚£∞‚£∂‚£ô‚£∑‚£Ø‚°è‚†Ä‚£∏‚†Å‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚£∑‚†à‚¢ß
‚£ñ‚†¶‚£æ‚£∑‚°ô‚†ø‚†Ä‚†ô‚†Ä‚¢ª‚°á‚¢∏‚°á‚†ò‚¢ø‚£∑‚°å‚†ª‚£ø‚£§‚†Ä‚†Ä‚†Ä‚£†‚£∂‚°ø‚†ã‚£±‚£ø‚†ü‚†Å‚£†‚£ø‚¢†‚°è‚†Ä‚†Ä‚¢Ä‚°æ‚†ü‚†ã‚†Å‚†Ä‚£®‚¢ø‚°á‚†Ä‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚£ß‚†Ä
‚†ò‚¢ø‚£é‚°ô‚†õ‚†Ç‚†Ä‚†Ä‚†Ä‚°º‚†É‚¢∏‚†á‚†ò‚°Ñ‚†ô‚†õ‚†Ä‚†à‚†â‚†Ä‚£†‚£æ‚¢è‚°ú‚¢°‚°æ‚†õ‚†Ä‚£†‚°æ‚†â‚¢ª‚£ø‚£Ñ‚£Ä‚°æ‚†õ‚†Ä‚†Ä‚†Ä‚°†‚†ä‚†Ä‚†Ä‚¢≥‚†Ä‚¢≥‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ò‚°Ñ
‚†Ä‚†Ä‚†ô‚¢ø‚£¶‚°Ä‚†Ä‚†Ä‚†Ä‚†Å‚†Ä‚¢∏‚£á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚£æ‚£ø‚†É‚°é‚¢†‚°ø‚†•‚£§‚†û‚†â‚¢∞‚£¶‚£Ä‚°Ω‚†õ‚†õ‚†Ä‚†Ä‚†Ä‚¢†‚†é‚†Ä‚†Ä‚†Ä‚†Ä‚†∏‚£Ü‚†ò‚£á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£Ñ‚¢á‚†Ä‚†Ä‚†Ä‚¢≥
‚†Ä‚†Ä‚†Ä‚†Ä‚£ø‚¢π‚£Ü‚°Ä‚†Ä‚†Ä‚°Ä‚£à‚£ø‚¢ª‚°Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚£æ‚¢ø‚£á‚†ò‚¢†‚°ü‚¢Ä‚°¥‚†ã‚£Ä‚£∏‚£∑‚£ø‚†ã‚†Å‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢ª‚£∑‚£å‚†≥‚£Ñ‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚†â‚†Ä‚†Ä‚†Ä‚¢∏
‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚¢ª‚£ô‚†õ‚†õ‚†â‚†â‚†â‚†Ä‚£æ‚£æ‚°Ä‚†Ä‚¢Ä‚£æ‚¢è‚£æ‚°æ‚¢Ä‚°û‚¢†‚°æ‚£∑‚£ø‚£ø‚£ø‚†ã‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚°Ä‚¢Ä‚°û‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢ò‚°å‚†ô‚†∑‚£¨‚°ª‚£ó‚†í‚†í‚†¶‚†§‚†§‚†§‚¢§‚£Ñ‚£Ä‚†Ä‚†Ä‚¢∏
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†æ‚¢Ø‚°Å‚†Ä‚†Ä‚†Ä‚†Ä‚††‚¢û‚£ª‚¢∑‚£§‚£æ‚£è‚£∏‚¢π‚£ß‚£∏‚££‚¢ü‚£§‚£ø‚£ø‚°ø‚†•‚°Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£ß‚£∏‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢∏‚°á‚†Ä‚†Ä‚†Ä‚†â‚†ô‚†≥‚†§‚†§‚†§‚£Ñ‚£Ä‚£Ä‚†Ä‚†à‚†â‚†ì‚†ø
‚†Ä‚†Ä‚†Ä‚†Ä‚†ê‚†¶‚°º‚†•‚†§‚†§‚¢Ñ‚°§‚†ñ‚†ã‚†Å‚†ò‚°ü‚†Ä‚†à‚†≥‚£ú‚£ø‚£ø‚££‚£æ‚†ü‚†ã‚†Å‚†Ä‚¢∏‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢∏‚†á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢≥‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†â‚†π‚£≤‚£§‚°Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚°á‚†Ä‚†Ä‚†Ä‚¢Ä‚°¨‚£ù‚†Ç‚†Ä‚†Ä‚°á‚†Ä‚†Ä‚£§‚£ô‚°ü‚†â‚°Ø‚†§‚†§‚†Ä‚†Ä‚††‚°ø‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚£á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£∏‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£†‚†¥‚†õ‚†Å‚†Ä‚†ô‚£¶
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚°á‚†Ä‚†Ä‚†Ä‚†É‚†Ä‚£∏‚†Ä‚¢Ä‚£¥‚°ü‚†Ä‚††‚†î‚†í‚£ß‚£§‚£∑‚°¶‚°Ñ‚†Ä‚†Ä‚†Ä‚£ß‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢∏‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚£§‚†û‚†Å‚†Ä‚†Ä‚¢Ä‚°§‚†é‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢à‚£ø‚†Ä‚†Ä‚†Ä‚¢†‚†Ä‚†É‚¢†‚†è‚°º‚†Ä‚†Ä‚†Ä‚£†‚°º‚£ø‚£è‚°è‚¢ø‚¢Ñ‚†Ä‚†Ä‚†Ä‚°è‚¢ß‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢∏‚°Ü‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚°¥‚†ã‚†Ä‚¢Ä‚£§‚†¥‚†ü‚†â‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢õ‚°ª‚°á‚†Ä‚†Ä‚†à‚†Ü‚†Ä‚¢∏‚°Ñ‚†ß‚†§‚†¥‚†õ‚†â‚£∏‚£ß‚¢ª‚†Ä‚†ò‚†Ä‚†õ‚†¶‚†º‚†É‚£Ä‚£π‚†Ü‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢£‚†Ä‚†Ä‚†Ä‚¢Ä‚°¥‚†ã‚¢Ä‚£§‚†û‚†â‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†â‚†Ä‚†ò‚£ø‚°Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢ª‚°Ä‚†Ä‚†Ä‚¢Ä‚°º‚£ª‚°Ω‚¢∏‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚£†‚£è‚†Å‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£≥‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ò‚°Ü‚†Ä‚¢†‚°ü‚¢Ä‚°¥‚†ã‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä

                            DISCLAIMER

Anyway, if you need a piece of code from this plugin,
please mention in the description or somewhere else that you got it from @KangelPlugins
                             Thanks.
                            üôèBLESSüôè
"""
import base64
import hashlib
import json
import os
import shutil
import time
import traceback
import zlib
import requests
from android import R as android_R
from android.content import ClipboardManager, ClipData, Context, Intent
from android.net import Uri
from android.text import SpannableString, Spanned, TextWatcher, TextUtils
from android.text.style import StrikethroughSpan
from android.util import TypedValue
from android.view import Gravity, View, ViewGroup
from android.widget import (AbsListView, AdapterView, ArrayAdapter,
                            BaseAdapter, EditText, FrameLayout, ImageView,
                            LinearLayout, ListView)
from android.widget import TextView
from android.widget import TextView as AndroidTextView
from android_utils import log, run_on_ui_thread
from androidx.core.widget import NestedScrollView
from base_plugin import BasePlugin, MenuItemData, MenuItemType, MethodHook
from client_utils import (get_last_fragment, get_messages_controller,
                          run_on_queue, send_document)
from com.exteragram.messenger.plugins import Plugin, PluginsController
from com.exteragram.messenger.plugins.ui import PluginSettingsActivity
from com.exteragram.messenger.plugins.ui.components import PluginCellDelegate
from com.exteragram.messenger.plugins.ui.components.templates import \
    UniversalFragment
from hook_utils import find_class, get_private_field
from java import dynamic_proxy
from java.lang import String
from java.util import ArrayList, Locale
from org.telegram.messenger import (AndroidUtilities, ApplicationLoader,
                                    ImageLocation, MediaDataController,
                                    NotificationCenter)
from org.telegram.messenger import R as R_tg
from org.telegram.messenger import Utilities
from org.telegram.tgnet import TLRPC
from org.telegram.ui.ActionBar import (AlertDialog, BottomSheet,
                                       SimpleTextView, Theme)
from org.telegram.ui.Components import (BackupImageView, LayoutHelper, UItem,
                                        UniversalRecyclerView)
from ui.alert import AlertDialogBuilder
from ui.bulletin import BulletinHelper
from ui.settings import Divider, Header, Switch, Text

__id__ = "kangel_plugins_manager"
__name__ = "Kangel Plugins Manager"
__description__ = """üá∑üá∫ | –ü–µ—Ä–≤—ã–π –ø–ª–∞–≥–∏–Ω , –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ª–µ–≥–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–ª–∞–≥–∏–Ω–∞–º–∏ —á–µ—Ä–µ–∑ –ª–µ–≥–∫–∏–π GUI
–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:exteraGram/AyuGram 12.0.1 –∏–ª–∏ –≤—ã—à–µ

üá∫üá∏ | First plugin that provides easy management of plugins through a simple GUI
Requirements:exteraGram/AyuGram 12.0.1 or higher
"""
__author__ = "@ArThirtyFour | @KangelPlugins"
__min_version__ = "12.0.1"
__icon__ = "Kangelcons_by_fStikBot/5"
__version__ = "1.0.5 [PATCHED]"

PLUGINS_DIR = f'/data/user/0/{ApplicationLoader.applicationContext.getPackageName()}/files/plugins'

def _get_lang():
    lang = Locale.getDefault().getLanguage().lower()
    return "ru" if lang.startswith("ru") else "en"

def _tr(key):
    lang = _get_lang()
    strings = {
        "en": {
            "header": "Kangel Plugins Manager",
            "updates_header": "Updates",
            "actions_header": "Actions",
            "author_header": "Author",
            "auto_update": "Auto-update on start",
            "auto_update_sub": "Update plugins list when app starts",
            "auto_update_installed": "Auto-update installed plugins",
            "auto_update_installed_sub": "Update installed plugins on app start",
            "refresh_list": "Refresh plugins list",
            "install_plugin": "Install plugin",
            "update_plugins": "Update installed plugins",
            "delete_plugin": "Delete plugin",
            "send_to_bot": "Send plugin to bot",
            "open_author_channel": "Open author's channel",
            "open_forum": "Open forum",
            "install_title": "Install plugin",
            "delete_title": "Delete plugin",
            "cancel": "Cancel",
            "search_hint": "Search...",
            "list_empty": "List is empty",
            "no_installed": "No installed plugins from store",
            "file_not_found": "File not found",
            "installed": "Installed {}",
            "deleted": "Deleted {}",
            "error_download": "Download error: {}",
            "error_write": "Write error: {}",
            "error_delete": "Delete error: {}",
            "updated_stats": "Updated: {}, unchanged: {}, errors: {}",
            "installing_deps": "Installing dependencies...",
            "dep_installed": "Dependency installed: {}",
            "dep_error": "Dependency error: {}",
            "clear_cache": "Clear cache",
            "cache_cleared": "Cache cleared successfully",
            "error_window": "All plugins are cached, you can open install menu",
            "install_button": "Install",
            "delete_button": "Delete",
            "version": "Version",
            "author": "Author",
            "no_description": "Description not available",
            "show_drawer_menu": "Show in drawer menu",
            "show_drawer_menu_sub": "Display Plugin Manager in side menu",
            "show_add_button": "Show '+' button in plugins menu",
            "show_add_button_sub": "Display install button in PluginsActivity menu",
            "show_update_button": "Show update button in plugins menu",
            "show_update_button_sub": "Display update-installed button in PluginsActivity menu",
            "first_run_title": "First run detected",
            "first_run_desc": "Loading plugins for the first time may take a while. Please wait...",
            "first_run_hint": "The cache will be created automatically",
            "install_dependencies": "Install dependencies",
            "install_dependencies_sub": "Install required dependencies before installing the plugin",
            "plugin_management": "Plugin Management",
            "auto_updates": "Auto-Updates",
            "ui_settings": "UI Settings",
            "about_plugin": "About Plugin",
            "open_github": "GitHub repository",
            "status_plugin": "Plugin",
            "status_library": "Library",
        },
        "ru": {
            "header": "Kangel Plugins Manager",
            "updates_header": "–û–±–Ω–æ–≤–ª–µ–Ω–∏—è",
            "actions_header": "–î–µ–π—Å—Ç–≤–∏—è",
            "author_header": "–ê–≤—Ç–æ—Ä",
            "auto_update": "–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ",
            "auto_update_sub": "–û–±–Ω–æ–≤–ª—è—Ç—å —Å–ø–∏—Å–æ–∫ –ø–ª–∞–≥–∏–Ω–æ–≤ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è",
            "auto_update_installed": "–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö",
            "auto_update_installed_sub": "–û–±–Ω–æ–≤–ª—è—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø–ª–∞–≥–∏–Ω—ã –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ",
            "refresh_list": "–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–ª–∞–≥–∏–Ω–æ–≤",
            "install_plugin": "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–ª–∞–≥–∏–Ω",
            "update_plugins": "–û–±–Ω–æ–≤–∏—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø–ª–∞–≥–∏–Ω—ã",
            "delete_plugin": "–£–¥–∞–ª–∏—Ç—å –ø–ª–∞–≥–∏–Ω",
            "send_to_bot": "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–ª–∞–≥–∏–Ω –≤ –±–æ—Ç–∞",
            "open_author_channel": "–ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–∞–Ω–∞–ª –∞–≤—Ç–æ—Ä–∞",
            "open_forum": "–û—Ç–∫—Ä—ã—Ç—å —Ñ–æ—Ä—É–º",
            "install_title": "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–ª–∞–≥–∏–Ω–∞",
            "delete_title": "–£–¥–∞–ª–∏—Ç—å –ø–ª–∞–≥–∏–Ω",
            "cancel": "–û—Ç–º–µ–Ω–∞",
            "search_hint": "–ü–æ–∏—Å–∫...",
            "list_empty": "–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç",
            "no_installed": "–ù–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –ø–ª–∞–≥–∏–Ω–æ–≤ –∏–∑ —Å—Ç–æ—Ä–∞",
            "file_not_found": "–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω",
            "installed": "–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω {}",
            "deleted": "–£–¥–∞–ª—ë–Ω {}",
            "error_download": "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: {}",
            "error_write": "–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏: {}",
            "error_delete": "–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: {}",
            "updated_stats": "–û–±–Ω–æ–≤–ª–µ–Ω–æ: {}, –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π: {}, –æ—à–∏–±–æ–∫: {}",
            "installing_deps": "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...",
            "dep_installed": "–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: {}",
            "dep_error": "–û—à–∏–±–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: {}",
            "clear_cache": "–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à",
            "cache_cleared": "–ö—ç—à —É—Å–ø–µ—à–Ω–æ –æ—á–∏—â–µ–Ω",
            "error_window": "–í—Å–µ –ø–ª–∞–≥–∏–Ω—ã –∫—ç—à–∏—Ä–æ–≤–∞–Ω—ã , –º–æ–∂–µ—Ç–µ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –º–µ–Ω—é —É—Å—Ç–∞–Ω–æ–≤–∫–∏",
            "install_button": "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å",
            "delete_button": "–£–¥–∞–ª–∏—Ç—å",
            "version": "–í–µ—Ä—Å–∏—è",
            "author": "–ê–≤—Ç–æ—Ä",
            "no_description": "–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç",
            "show_drawer_menu": "–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤ –±–æ–∫–æ–≤–æ–º –º–µ–Ω—é",
            "show_drawer_menu_sub": "–û—Ç–æ–±—Ä–∞–∂–∞—Ç—å Plugin Manager –≤ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏",
            "show_add_button": "–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å '+' –≤ –º–µ–Ω—é –ø–ª–∞–≥–∏–Ω–æ–≤",
            "show_add_button_sub": "–û—Ç–æ–±—Ä–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤ –º–µ–Ω—é –ø–ª–∞–≥–∏–Ω–æ–≤",
            "show_update_button": "–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ –º–µ–Ω—é –ø–ª–∞–≥–∏–Ω–æ–≤",
            "show_update_button_sub": "–û—Ç–æ–±—Ä–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –≤ –º–µ–Ω—é –ø–ª–∞–≥–∏–Ω–æ–≤",
            "first_run_title": "–û–±–Ω–∞—Ä—É–∂–µ–Ω –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫",
            "first_run_desc": "–ó–∞–≥—Ä—É–∑–∫–∞ –ø–ª–∞–≥–∏–Ω–æ–≤ –≤ –ø–µ—Ä–≤—ã–π —Ä–∞–∑ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...",
            "first_run_hint": "–ö—ç—à –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏",
            "install_dependencies": "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏",
            "install_dependencies_sub": "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π –ø–ª–∞–≥–∏–Ω–∞",
            "plugin_management": "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–ª–∞–≥–∏–Ω–∞–º–∏",
            "auto_updates": "–ê–≤—Ç–æ-–û–±–Ω–æ–≤–ª–µ–Ω–∏—è",
            "ui_settings": "–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å",
            "about_plugin": "–û –ø–ª–∞–≥–∏–Ω–µ",
            "open_github": "–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π GitHub",
            "status_plugin": "–ü–ª–∞–≥–∏–Ω",
            "status_library": "–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞",
        }
    }
    return strings.get(lang, strings["en"]).get(key, key)

def open_link(url):
    fragment = get_last_fragment()
    if not fragment:
        return
    context = fragment.getParentActivity()
    if not context:
        return
    intent = Intent(Intent.ACTION_VIEW, Uri.parse(url))
    run_on_ui_thread(lambda: context.startActivity(intent))

def _get_current_account(fragment):
    try:
        return fragment.getCurrentAccount()
    except Exception:
        try:
            return fragment.currentAccount
        except Exception:
            return 0

def open_username(username):
    def go():
        try:
            fragment = get_last_fragment()
            if not fragment:
                return
            account = _get_current_account(fragment)
            ok = False
            try:
                ok = get_messages_controller().openByUserName(username, fragment, account)
            except Exception as e:
                log(f"[KPM] openByUserName error: {e}")
            if not ok:
                try:
                    context = fragment.getParentActivity()
                    if context:
                        intent = Intent(Intent.ACTION_VIEW, Uri.parse(f"tg://resolve?domain={username}"))
                        context.startActivity(intent)
                        return
                except Exception as e2:
                    log(f"[KPM] tg://resolve fallback error: {e2}")
                open_link(f"https://t.me/{username}")
        except Exception as e:
            log(f"[KPM] open_username error: {e}")
            open_link(f"https://t.me/{username}")
    run_on_ui_thread(go)

class KPMSettingsHeaderHook:
    def __init__(self, plugin):
        self.plugin = plugin
    
    def after_hooked_method(self, param):
        try:
            activity = param.thisObject
            items = param.args[0]
            if not items or items.size() == 0:
                return
            
            plugin_obj = get_private_field(activity, "plugin")
            if not plugin_obj or str(plugin_obj.getId()) != "kangel_plugins_manager":
                return
            
            if get_private_field(activity, "createSubFragmentCallback") is not None:
                return
            
            header = self.plugin._create_settings_header(activity.getContext())
            if header:
                from com.exteragram.messenger.plugins.models import \
                    HeaderSetting
                from org.telegram.ui.Components import UItem
                item = UItem.asCustom(header)
                item.settingItem = HeaderSetting("kpm_header")
                try: 
                    item.setTransparent(True)
                except: 
                    pass
                items.add(0, item)
                items.add(1, UItem.asShadow())
        except Exception as e:
            log(f"[KPM] Error in settings header hook: {e}")

class KangelPluginsManager(BasePlugin):
    def __init__(self):
        super().__init__()
        self.store_json_urls = [
            "https://raw.githubusercontent.com/KangelPlugins/Plugins-Store/refs/heads/main/store.json",
            "https://raw.githubusercontent.com/KangelPlugins/Plugins-Store/main/store.json",
        ]
        self.github_api_url = "https://api.github.com/repos/KangelPlugins/Plugins-Store/commits/main"
        self.cache_file = os.path.join(PLUGINS_DIR, ".kpm_cache.json")
        self.plugins_list = {}
        self.plugin_names_cache = {}
        # –ö—ç—à –¥–ª—è view —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–∏–∞–ª–æ–≥–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
        self._install_dialog_views_cache = {}
        self.auto_update = True
        self.load_cache()

    def has_settings(self):
        return True

    def create_settings(self):
        return [
            Header(text=_tr("header")),
            Text(
                text=_tr("plugin_management"),
                icon="msg_addbot",
                create_sub_fragment=self._create_plugin_management_settings
            ),
            Text(
                text=_tr("auto_updates"),
                icon="files_storage",
                create_sub_fragment=self._create_auto_updates_settings
            ),
            Text(
                text=_tr("ui_settings"),
                icon="msg_theme",
                create_sub_fragment=self._create_ui_settings
            ),
            Text(
                text=_tr("about_plugin"),
                icon="mentionbutton",
                create_sub_fragment=self._create_about_settings
            )
        ]
    
    def _create_plugin_management_settings(self):
        return [
            Header(text=_tr("actions_header")),
            Text(
                text=_tr("refresh_list"),
                icon="msg_download",
                on_click=lambda _: run_on_queue(lambda: self.refresh_store())
            ),
            Text(
                text=_tr("install_plugin"),
                icon="msg_addbot",
                on_click=lambda _: self.open_install_dialog()
            ),
            Text(
                text=_tr("update_plugins"),
                icon="menu_browser_refresh",
                on_click=lambda _: self.open_update_dialog()
            ),
            Text(
                text=_tr("delete_plugin"),
                icon="msg_delete",
                on_click=lambda _: self.open_delete_dialog()
            ),
            Text(
                text=_tr("clear_cache"),
                icon="msg_clear",
                on_click=lambda _: run_on_queue(lambda: self.clear_cache())
            )
        ]
    
    def _create_builds_settings(self):
        try:
            builds = self._list_builds()
            log(f"[KPM] Creating builds settings, found {len(builds)} builds")
            
            def safe_create_build_dialog(v):
                try:
                    log("[KPM] Create build dialog clicked, button pressed")
                    self._show_create_build_dialog()
                except Exception as e:
                    log(f"[KPM] Error in create build dialog: {e}")
                    import traceback
                    log(f"[KPM] Traceback: {traceback.format_exc()}")
                    try:
                        run_on_ui_thread(lambda: BulletinHelper.show_error(f"–û—à–∏–±–∫–∞: {e}"))
                    except:
                        pass
            
            settings = [
                Header(text=_tr("builds_header")),
                Text(
                    text=_tr("create_build"),
                    icon="msg_saved",
                    on_click=safe_create_build_dialog
                )
            ]
            
            if builds:
                settings.append(Divider())
                for build_name in sorted(builds):
                    def make_load_handler(name):
                        def handler(v):
                            try:
                                log(f"[KPM] Loading build: {name}")
                                self._load_build(name)
                            except Exception as e:
                                log(f"[KPM] Error loading build {name}: {e}")
                                import traceback
                                log(f"[KPM] Traceback: {traceback.format_exc()}")
                                run_on_ui_thread(lambda: BulletinHelper.show_error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: {e}"))
                        return handler
                    
                    def make_delete_handler(name):
                        def handler(v):
                            try:
                                log(f"[KPM] Delete build dialog for: {name}")
                                self._show_delete_build_dialog(name)
                            except Exception as e:
                                log(f"[KPM] Error showing delete dialog for {name}: {e}")
                                import traceback
                                log(f"[KPM] Traceback: {traceback.format_exc()}")
                                run_on_ui_thread(lambda: BulletinHelper.show_error(f"–û—à–∏–±–∫–∞: {e}"))
                        return handler
                    
                    settings.append(
                        Text(
                            text=f"üì¶ {build_name}",
                            on_click=make_load_handler(build_name),
                            on_long_click=make_delete_handler(build_name)
                        )
                    )
            else:
                settings.append(
                    Text(
                        text=_tr("no_builds"),
                        accent=False
                    )
                )
            
            return settings
        except Exception as e:
            log(f"[KPM] Error in _create_builds_settings: {e}")
            import traceback
            log(f"[KPM] Traceback: {traceback.format_exc()}")
            return [
                Header(text=_tr("builds_header")),
                Text(
                    text="–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏",
                    subtext=f"–û—à–∏–±–∫–∞: {e}",
                    on_click=lambda _: run_on_ui_thread(lambda: BulletinHelper.show_error(f"–û—à–∏–±–∫–∞: {e}"))
                )
            ]
    
    def _create_auto_updates_settings(self):
        return [
            Header(text=_tr("updates_header")),
            Switch(
                key="auto_update_on_start",
                text=_tr("auto_update"),
                default=False,
                icon="files_storage",
                subtext=_tr("auto_update_sub")
            ),
            Switch(
                key="auto_update_installed",
                text=_tr("auto_update_installed"),
                default=False,
                icon="avd_flip",
                subtext=_tr("auto_update_installed_sub")
            )
        ]
    
    def _create_ui_settings(self):
        return [
            Header(text=_tr("ui_settings")),
            Switch(
                key="show_drawer_menu",
                text=_tr("show_drawer_menu"),
                default=True,
                icon="msg_addbot",
                subtext=_tr("show_drawer_menu_sub"),
                on_change=lambda v: self._update_drawer_menu()
            ),
            Switch(
                key="show_add_button",
                text=_tr("show_add_button"),
                default=True,
                icon="msg_add",
                subtext=_tr("show_add_button_sub")
            ),
            Switch(
                key="show_update_button",
                text=_tr("show_update_button"),
                default=True,
                icon="menu_browser_refresh",
                subtext=_tr("show_update_button_sub")
            )
        ]
    
    def _update_drawer_menu(self):
        try:
            self.remove_menu_item(MenuItemType.DRAWER_MENU, "Plugin Manager")
            self.add_drawer_menu_item()
        except Exception as e:
            log(f"[KPM] Error updating drawer menu: {e}")
    
    def _create_about_settings(self):
        return [
            Header(text=_tr("author_header")),
            Text(
                text=_tr("open_author_channel"),
                icon="input_smile_solar",
                on_click=lambda _: open_username("KangelPlugins")
            ),
            Text(
                text=_tr("open_forum"),
                icon="msg_groups_solar",
                on_click=lambda _: open_username("KangelPluginsManager")
            ),
            Text(
                text=_tr("send_to_bot"),
                icon="msg_forward",
                on_click=lambda _: open_username("KPMAppealBot")
            ),
            Text(
                text=_tr("open_github"),
                icon="msg_link",
                on_click=lambda _: open_link("https://github.com/KangelPlugins/Plugins-Store")
            ),
            Divider(),
            Text(
                text=self._get_plugin_info_text(),
                icon="info",
                on_click=lambda _: self._show_about_dialog()
            )
        ]
    
    def _setup_settings_header_hook(self):
        try:
            PSA = find_class("com.exteragram.messenger.plugins.ui.PluginSettingsActivity")
            if not PSA:
                return
            method = PSA.getClass().getDeclaredMethod("fillItems", find_class("java.util.ArrayList"), find_class("org.telegram.ui.Components.UniversalAdapter"))
            method.setAccessible(True)
            self.hook_settings_header_ref = self.hook_method(method, KPMSettingsHeaderHook(self))
        except Exception as e:
            log(f"[KPM] Error setting up settings header hook: {e}")
    
    def _create_settings_header(self, context):
        try:
            from android.util import TypedValue
            from android.view import Gravity
            from android.widget import FrameLayout, LinearLayout, TextView
            from org.telegram.messenger import (AndroidUtilities,
                                                ImageLocation,
                                                MediaDataController)
            from org.telegram.ui.ActionBar import Theme
            from org.telegram.ui.Components import (BackupImageView,
                                                    LayoutHelper)
            
            container = FrameLayout(context)
            main_layout = LinearLayout(context)
            main_layout.setOrientation(LinearLayout.HORIZONTAL)
            main_layout.setGravity(Gravity.CENTER_VERTICAL)
            main_layout.setPadding(AndroidUtilities.dp(20), AndroidUtilities.dp(20), AndroidUtilities.dp(20), AndroidUtilities.dp(20))
            
            imageView = BackupImageView(context)
            imageView.setRoundRadius(0)
            
            def try_load_sticker(img):
                try:
                    icon_parts = __icon__.split("/")
                    if len(icon_parts) == 2:
                        sticker_set_name = icon_parts[0]
                        sticker_index = int(icon_parts[1])
                        ss = MediaDataController.getInstance(0).getStickerSetByName(sticker_set_name) or MediaDataController.getInstance(0).getStickerSetByEmojiOrName(sticker_set_name)
                        if ss and ss.documents and ss.documents.size() > sticker_index:
                            img.setImage(ImageLocation.getForDocument(ss.documents.get(sticker_index)), "72_72", None, None, 0, 1)
                            return True
                except:
                    pass
                return False
            
            if not try_load_sticker(imageView):
                try:
                    icon_parts = __icon__.split("/")
                    if len(icon_parts) == 2:
                        sticker_set_name = icon_parts[0]
                        MediaDataController.getInstance(0).loadStickersByEmojiOrName(sticker_set_name, False, False)
                        run_on_ui_thread(lambda: try_load_sticker(imageView), 1500)
                except:
                    pass
            
            main_layout.addView(imageView, LayoutHelper.createLinear(72, 72, 0, 0, 16, 0))
            
            text_container = LinearLayout(context)
            text_container.setOrientation(LinearLayout.VERTICAL)
            text_container.setGravity(Gravity.CENTER_VERTICAL)
            
            title = TextView(context)
            title.setTextColor(Theme.getColor(Theme.key_windowBackgroundWhiteBlackText))
            title.setTypeface(AndroidUtilities.getTypeface(AndroidUtilities.TYPEFACE_ROBOTO_MEDIUM))
            title.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 18)
            title.setText(f"{__name__} {__version__}")
            title.setSingleLine(True)
            title.setGravity(Gravity.START)
            text_container.addView(title, LayoutHelper.createLinear(-1, -2, 0, 0, 4, 0))
            
            lang = _get_lang()
            plugin_count = len(self.plugins_list) if self.plugins_list else 0
            if lang == "ru":
                subtitle_text = f"–ü–µ—Ä–≤—ã–π –ø–ª–∞–≥–∏–Ω –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–ª–∞–≥–∏–Ω–∞–º–∏ —á–µ—Ä–µ–∑ GUI ‚Ä¢  {plugin_count} –ø–ª–∞–≥–∏–Ω–æ–≤"
            else:
                subtitle_text = f"First plugin for managing plugins through GUI ‚Ä¢ {plugin_count} plugins"
            
            subtitle = TextView(context)
            subtitle.setTextColor(Theme.getColor(Theme.key_windowBackgroundWhiteGrayText))
            subtitle.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 14)
            subtitle.setText(subtitle_text)
            subtitle.setGravity(Gravity.START)
            text_container.addView(subtitle, LayoutHelper.createLinear(-1, -2))
            
            main_layout.addView(text_container, LayoutHelper.createLinear(0, -2, 1.0))
            container.addView(main_layout, LayoutHelper.createFrame(-1, -2, Gravity.TOP | Gravity.START, 0, 0, 0, 0))
            
            return container
        except Exception as e:
            log(f"[KPM] Error creating settings header: {e}")
            return None
    
    def _get_plugin_info_text(self):

        plugin_count = len(self.plugins_list) if self.plugins_list else 0
        lang = _get_lang()
        if lang == "ru":
            return f"KPM v{__version__} ‚Ä¢ {plugin_count} –ø–ª–∞–≥–∏–Ω–æ–≤"
        else:
            return f"KPM v{__version__} ‚Ä¢ {plugin_count} plugins"
    
    def _show_about_dialog(self):

        try:
            fragment = get_last_fragment()
            if not fragment:
                return
            
            context = fragment.getParentActivity()
            if not context:
                return
            
            plugin_count = len(self.plugins_list) if self.plugins_list else 0
            installed_count = len(self.list_installed_plugins())
            lang = _get_lang()
            
            bottom_sheet = BottomSheet(context, False, fragment.getResourceProvider())
            bottom_sheet.setApplyBottomPadding(False)
            bottom_sheet.setApplyTopPadding(False)
            bottom_sheet.fixNavigationBar(Theme.getColor(Theme.key_windowBackgroundWhite))
            
            linear_layout = LinearLayout(context)
            linear_layout.setOrientation(LinearLayout.VERTICAL)
            linear_layout.setClickable(True)
            
            frame_layout = FrameLayout(context)
            frame_layout.addView(linear_layout)
            
            scroll_view = NestedScrollView(context)
            scroll_view.addView(frame_layout)
            bottom_sheet.setCustomView(scroll_view)
            close_view = ImageView(context)
            close_view.setBackground(Theme.createSelectorDrawable(Theme.getColor(Theme.key_listSelector)))
            close_view.setColorFilter(Theme.getColor(Theme.key_sheet_other))
            close_view.setImageResource(R_tg.drawable.ic_layer_close)
            OnClickInterface = find_class("android.view.View$OnClickListener")
            OnClick = dynamic_proxy(OnClickInterface)
            class CloseClickImpl(OnClick):
                def __init__(self, bottom_sheet):
                    super().__init__()
                    self.bottom_sheet = bottom_sheet
                def onClick(self, v):
                    self.bottom_sheet.dismiss()
            close_view.setOnClickListener(CloseClickImpl(bottom_sheet))
            close_padding = AndroidUtilities.dp(8)
            close_view.setPadding(close_padding, close_padding, close_padding, close_padding)
            frame_layout.addView(close_view, LayoutHelper.createFrame(36, 36, Gravity.TOP | Gravity.END, 6, 8, 8, 0))

            sticker_image_view = BackupImageView(context)
            sticker_image_view.setRoundRadius(0)
            sticker_image_view.getImageReceiver().setCrossfadeWithOldImage(True)
            linear_layout.addView(sticker_image_view, LayoutHelper.createLinear(90, 90, Gravity.TOP | Gravity.CENTER_HORIZONTAL, 0, 27, 0, 0))

            try:
                current_account = 0
                try:
                    current_account = fragment.getCurrentAccount()
                except Exception:
                    current_account = 0

                media_controller = MediaDataController.getInstance(current_account)
                sticker_set = media_controller.getStickerSetByName("LostChocolateFlamingo_by_fStikBot")
                if sticker_set and sticker_set.documents and sticker_set.documents.size() > 80:
                    sticker_document = sticker_set.documents.get(12)
                    image_location = ImageLocation.getForDocument(sticker_document)
                    sticker_image_view.setImage(image_location, "90_90", None, 0, sticker_document)
                    log("[KPM] Sticker loaded from cache: LostChocolateFlamingo_by_fStikBot/74")
                else:
                    log("[KPM] Sticker cache miss, requesting set")
                    try:
                        input_set = TLRPC.TL_inputStickerSetShortName()
                        input_set.short_name = "LostChocolateFlamingo_by_fStikBot"

                        def _on_set_response(result):
                            try:
                                if result and result.documents and result.documents.size() > 80:
                                    doc = result.documents.get(12)
                                    img_loc = ImageLocation.getForDocument(doc)
                                    run_on_ui_thread(lambda: sticker_image_view.setImage(img_loc, "90_90", None, 0, doc))
                                    log("[KPM] Sticker loaded after fetch: LostChocolateFlamingo_by_fStikBot/74")
                            except Exception as _e_inner:
                                log(f"[KPM] Error applying fetched sticker: {_e_inner}")

                        class Callback1(dynamic_proxy(Utilities.Callback)):
                            def __init__(self, fn):
                                super().__init__()
                                self._fn = fn
                            def run(self, arg):
                                try:
                                    self._fn(arg)
                                except Exception as e:
                                    log(f"[KPM] Callback error: {str(e)}")

                        media_controller.getStickerSet(input_set, None, False, Callback1(_on_set_response))
                    except Exception as _e_fetch:
                        log(f"[KPM] Error requesting sticker set 'LostChocolateFlamingo_by_fStikBot': {_e_fetch}")
            except Exception as e:
                log(f"[KPM] Error loading sticker: {e}")
            

            title_text_view = SimpleTextView(context)
            title_text_view.setTypeface(AndroidUtilities.bold())
            title_text_view.setTextSize(20)
            title_text_view.setTextColor(Theme.getColor(Theme.key_dialogTextBlack))
            title_text = "Kangel Plugins Manager"
            
            title_text_view.setText(title_text)
            title_text_view.setGravity(Gravity.CENTER)
            linear_layout.addView(title_text_view, LayoutHelper.createLinear(-2, -2, Gravity.TOP | Gravity.CENTER_HORIZONTAL, 10, 27, 10, 0))

            version_text = TextView(context)
            version_text.setGravity(Gravity.CENTER)
            version_text.setText(f"{__version__} | 'Internet Overdose'")
            version_text.setTextColor(Theme.getColor(Theme.key_dialogTextGray3))
            version_text.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 14)
            linear_layout.addView(version_text, LayoutHelper.createLinear(-1, -2, Gravity.TOP, 24, 4, 24, 0))

            info_text = TextView(context)
            info_text.setGravity(Gravity.CENTER)
            if lang == "ru":
                info_lines = [
                    "–°—Ç–æ–ª—å–∫–æ, —Å–∫–æ–ª—å–∫–æ –∏ —Ç–µ–±–µ –ø–∏—Å–∞—Ç—å –≤—Å—è–∫–∏–π –±—Ä–µ–¥. –ó–∞—Ö–æ—Ç–µ–ª–∞ –∏ –ø–æ—Å—Ç–∞–≤–∏–ª–∞ –ö–∞–Ω–≥–µ–ª –Ω–∞ —Ñ–æ–Ω–µ –≠–ö–°–¢–ï–†–ê–ì–†–ê–ú ‚Äî –≤—Å—ë? \n–í–æ–ø—Ä–æ—Å—ã –∫–æ–Ω—á–∏–ª–∏—Å—å?"
                ]
            else:
                    info_lines = [
                    "As much as I'm writing all this nonsense to you. I just wanted to and installed OMGKawaiiAngelChan alongside EXTERAGRAM that's it?\n Are you out of questions?"
                ]
            info_text.setText("\n".join(info_lines))
            info_text.setTextColor(Theme.getColor(Theme.key_dialogTextBlack))
            info_text.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 15)
            linear_layout.addView(info_text, LayoutHelper.createLinear(-1, -2, Gravity.TOP, 24, 20, 24, 20))
            
            bottom_sheet.show()
            log("[KPM] About dialog shown (easter egg)")
        except Exception as e:
            log(f"[KPM] Error showing about dialog: {e}")
            log(traceback.format_exc())

    def on_plugin_load(self):
        self.add_on_send_message_hook()
        self.add_deeplink_hook()
        self.add_drawer_menu_item()
        self.add_install_sheet_hook()
        self.add_plugins_activity_hook()
        self._setup_settings_header_hook()
        if self.get_setting("auto_update_on_start", False): run_on_queue(self.refresh_store)
        if self.get_setting("auto_update_installed", False): run_on_queue(self.update_installed_from_store)
        self.search_listener_hooks = None

    def on_plugin_unload(self):
        self.remove_hook("on_send_message_hook")
    
    def add_drawer_menu_item(self):
        try:
            if self.get_setting("show_drawer_menu", True):
                self.add_menu_item(MenuItemData(
                    menu_type=MenuItemType.DRAWER_MENU,
                    text="Plugin Manager",
                    icon="msg_addbot",
                    on_click=lambda ctx: self.open_settings_page()
                ))
                log("[KPM] Drawer menu item added")
            else:
                log("[KPM] Drawer menu disabled in settings")
        except Exception as e:
            log(f"[KPM] Error adding drawer menu: {e}")
    
    def open_settings_page(self):
        try:
            
            java_plugin = PluginsController.getInstance().plugins.get(self.id)
            fragment = get_last_fragment()
            if java_plugin and fragment:
                run_on_ui_thread(lambda: fragment.presentFragment(PluginSettingsActivity(java_plugin)))
            else:
                log("[KPM] Could not open settings - plugin or fragment is None")
        except Exception as e:
            log(f"[KPM] Error opening settings: {e}")
    
    def add_deeplink_hook(self):
        try:
            
            class KPMDeeplinkHook:
                def __init__(self, plugin):
                    self.plugin = plugin
                
                def before_hooked_method(self, param):
                    try:
                        if len(param.args) < 1:
                            return
                        intent = param.args[0]
                        if not intent or intent.getAction() != "android.intent.action.VIEW":
                            return
                        data = intent.getData()
                        if not data:
                            return
                        url = str(data)
                        
                        if url.startswith("tg://kpm_install"):
                            uri = Uri.parse(url)
                            plugin_id = uri.getQueryParameter("plugin")
                            if plugin_id:
                                log(f"[KPM] Deep link install: {plugin_id}")
                                run_on_ui_thread(lambda: self.plugin.show_plugin_info_and_install(plugin_id))
                                param.setResult(None)
                        elif url.startswith("tg://kpm_list"):
                            log(f"[KPM] Deep link refresh list")
                            run_on_queue(lambda: self.plugin.refresh_store(force=True))
                            param.setResult(None)
                    except Exception as e:
                        log(f"[KPM] Error in deeplink hook: {e}")
                
                def after_hooked_method(self, param):
                    pass
            
            LaunchActivity = find_class("org.telegram.ui.LaunchActivity")
            if LaunchActivity:
                method = LaunchActivity.getClass().getDeclaredMethod("handleIntent",
                    find_class("android.content.Intent").getClass(),
                    find_class("java.lang.Boolean").TYPE,
                    find_class("java.lang.Boolean").TYPE,
                    find_class("java.lang.Boolean").TYPE,
                    find_class("org.telegram.messenger.browser.Browser$Progress").getClass(),
                    find_class("java.lang.Boolean").TYPE,
                    find_class("java.lang.Boolean").TYPE)
                method.setAccessible(True)
                self.hook_method(method, KPMDeeplinkHook(self))
                log("[KPM] Deeplink hook installed successfully")
        except Exception as e:
            log(f"[KPM] Error adding deeplink hook: {e}")
            log(traceback.format_exc())
    
    def add_install_sheet_hook(self):
        try:
            from base_plugin import MethodHook
            
            class InstallSheetHook(MethodHook):
                def __init__(self, plugin):
                    self.plugin = plugin
                
                def after_hooked_method(self, param):
                    def to_java_color(hex_val):
                        val = int(hex_val)
                        if val > 0x7FFFFFFF:
                            val -= 0x100000000
                        return val
                    
                    def modify_ui():
                        try:
                            sheet = param.thisObject
                            install_params = param.args[2]
                            
                            if not sheet or not install_params:
                                return
                            
                            file_path = None
                            try:
                                path_field = install_params.getClass().getDeclaredField("filePath")
                                path_field.setAccessible(True)
                                file_path = path_field.get(install_params)
                            except Exception as e:
                                log(f"[KPM] Error getting file path: {e}")
                                return
                            
                            if not file_path:
                                return
                            
                            file_path_str = str(file_path)

                            dependencies = self.plugin._get_dependencies_from_file(file_path_str)
                            if not dependencies:
                                filename = os.path.basename(file_path_str)
                                plugin_id_from_file = filename.replace('.plugin', '').replace('.py', '').strip()
                                if plugin_id_from_file.startswith('.temp_'):
                                    plugin_id_from_file = plugin_id_from_file.replace('.temp_', '')
                                if plugin_id_from_file:
                                    pid_lower = plugin_id_from_file.lower()
                                    matched = next((k for k in self.plugin.plugins_list if k.lower() == pid_lower), None)
                                    if matched:
                                        plugin_info = self.plugin.plugins_list[matched]
                                        if isinstance(plugin_info, dict):
                                            dependencies = plugin_info.get("dependencies", [])
                                        log(f"[KPM] Got dependencies from store for {matched}: {dependencies}")
                            if dependencies:
                                log(f"[KPM] Found dependencies: {dependencies}")

                            custom_view = None
                            try:
                                curr_cls = sheet.getClass()
                                while curr_cls is not None:
                                    try:
                                        f = curr_cls.getDeclaredField("customView")
                                        f.setAccessible(True)
                                        custom_view = f.get(sheet)
                                        if custom_view:
                                            break
                                    except:
                                        pass
                                    curr_cls = curr_cls.getSuperclass()
                            except:
                                pass
                            
                            if not custom_view:
                                try:
                                    f = sheet.getClass().getSuperclass().getDeclaredField("containerView")
                                    f.setAccessible(True)
                                    custom_view = f.get(sheet)
                                except:
                                    pass
                            
                            if not custom_view:
                                return

                            ButtonWithCounterView = find_class("org.telegram.ui.Stories.recorder.ButtonWithCounterView")
                            ViewGroup = find_class("android.view.ViewGroup")
                            LinearLayout = find_class("android.widget.LinearLayout")
                            Theme = find_class("org.telegram.ui.ActionBar.Theme")
                            AndroidUtilities = find_class("org.telegram.messenger.AndroidUtilities")
                            LayoutHelper = find_class("org.telegram.ui.Components.LayoutHelper")

                            install_btn = None
                            parent_layout = None
                            
                            def scan_view(view, depth=0):
                                nonlocal install_btn, parent_layout
                                if not view:
                                    return
                                
                                if isinstance(view, ButtonWithCounterView):
                                    try:
                                        btn_text = str(view.getText())
                                        if btn_text and ("Install" in btn_text or "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å" in btn_text or "Update" in btn_text or "–û–±–Ω–æ–≤–∏—Ç—å" in btn_text):
                                            if not install_btn:  
                                                install_btn = view
                                                parent_layout = view.getParent()
                                                log(f"[KPM] Found install button: {btn_text}")
                                    except:
                                        if not install_btn:
                                            install_btn = view
                                            parent_layout = view.getParent()
                                
                                if isinstance(view, ViewGroup):
                                    count = view.getChildCount()
                                    for i in range(count):
                                        scan_view(view.getChildAt(i), depth + 1)
                            
                            scan_view(custom_view)
                            
                            if not install_btn:
                                log("[KPM] Install button not found in dialog")
                                return
                            
                            if not parent_layout:
                                log("[KPM] Parent layout not found for install button")
                                return
                            
                            context = sheet.getContext()
                            resources_provider = None
                            try:
                                curr_cls = sheet.getClass()
                                while curr_cls is not None:
                                    try:
                                        m = curr_cls.getDeclaredMethod("getResourceProvider")
                                        m.setAccessible(True)
                                        resources_provider = m.invoke(sheet)
                                        if resources_provider:
                                            break
                                    except:
                                        pass
                                    curr_cls = curr_cls.getSuperclass()
                            except:
                                pass
                            
                            if dependencies:
                                log(f"[KPM] Adding dependencies button")
                                deps_btn = ButtonWithCounterView(context, True, resources_provider)
                                deps_btn.setText(_tr("install_dependencies"), False)
                                if resources_provider:
                                    deps_color = Theme.getColor(Theme.key_featuredStickers_addButton, resources_provider)
                                    deps_pressed = Theme.getColor(Theme.key_featuredStickers_addButtonPressed, resources_provider)
                                else:
                                    deps_color = to_java_color(0xFF4CAF50)
                                    deps_pressed = to_java_color(0xFF388E3C)
                                deps_bg = Theme.createSimpleSelectorRoundRectDrawable(
                                    AndroidUtilities.dp(8),
                                    deps_color,
                                    deps_pressed
                                )
                                deps_btn.setBackground(deps_bg)
                                OnClickListener = find_class("android.view.View$OnClickListener")
                                class DepsClickListener(dynamic_proxy(OnClickListener)):
                                    def __init__(self, plugin_instance, deps_list):
                                        super().__init__()
                                        self.plugin_instance = plugin_instance
                                        self.deps_list = deps_list
                                    def onClick(self, v):
                                        run_on_queue(lambda: self._install_dependencies())
                                    def _install_dependencies(self):
                                        def show_dialog(title, message):
                                            try:
                                                fragment = get_last_fragment()
                                                if not fragment:
                                                    return
                                                activity = fragment.getParentActivity()
                                                if not activity:
                                                    return
                                                builder = AlertDialogBuilder(activity)
                                                builder.set_title(title)
                                                builder.set_message(message)
                                                builder.set_positive_button("OK" if _get_lang() != "ru" else "–û–ö", lambda d, w: d.dismiss())
                                                builder.set_cancelable(True)
                                                builder.show()
                                            except Exception as e:
                                                log(f"[KPM] Error showing dialog: {e}")
                                        try:
                                            success_count = 0
                                            failed_count = 0
                                            failed_deps = []
                                            for dep_id in self.deps_list:
                                                try:
                                                    log(f"[KPM] Installing dependency: {dep_id}")
                                                    self.plugin_instance.install_plugin_by_id(dep_id)
                                                    log(f"[KPM] Successfully installed dependency: {dep_id}")
                                                    success_count += 1
                                                except Exception as e:
                                                    failed_count += 1
                                                    failed_deps.append(dep_id)
                                                    log(f"[KPM] ERROR installing dependency {dep_id}: {e}")
                                            lang = _get_lang()
                                            result_lines = []
                                            for dep_id in self.deps_list:
                                                dep_name = self.plugin_instance.get_plugin_display_name(dep_id)
                                                display_name = dep_name if dep_name != dep_id else dep_id
                                                if dep_id in failed_deps:
                                                    result_lines.append(f"‚ùå {display_name}")
                                                else:
                                                    result_lines.append(f"‚úÖ {display_name}")
                                            if lang == "ru":
                                                if failed_count == 0:
                                                    final_title = "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
                                                    final_msg = f"‚úÖ –í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã ({success_count}/{len(self.deps_list)})\n\n" + "\n".join(result_lines)
                                                else:
                                                    final_title = "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —Å –æ—à–∏–±–∫–∞–º–∏"
                                                    final_msg = f"–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: {success_count}/{len(self.deps_list)}\n–û—à–∏–±–æ–∫: {failed_count}\n\n" + "\n".join(result_lines)
                                            else:
                                                if failed_count == 0:
                                                    final_title = "Installation complete"
                                                    final_msg = f"‚úÖ All dependencies installed ({success_count}/{len(self.deps_list)})\n\n" + "\n".join(result_lines)
                                                else:
                                                    final_title = "Installation completed with errors"
                                                    final_msg = f"Installed: {success_count}/{len(self.deps_list)}\nErrors: {failed_count}\n\n" + "\n".join(result_lines)
                                            run_on_ui_thread(lambda t=final_title, m=final_msg: show_dialog(t, m))
                                        except Exception as e:
                                            log(f"[KPM] Error in _install_dependencies: {e}")
                                            lang = _get_lang()
                                            if lang == "ru":
                                                error_title = "–û—à–∏–±–∫–∞"
                                                error_msg = f"–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:\n{str(e)[:200]}"
                                            else:
                                                error_title = "Error"
                                                error_msg = f"Dependency installation error:\n{str(e)[:200]}"
                                            run_on_ui_thread(lambda t=error_title, m=error_msg: show_dialog(t, m))
                                deps_btn.setOnClickListener(DepsClickListener(self.plugin, dependencies))
                                try:
                                    install_btn.setText(_tr("install_button"), False)
                                except:
                                    pass
                                idx = -1
                                for i in range(parent_layout.getChildCount()):
                                    if parent_layout.getChildAt(i) == install_btn:
                                        idx = i
                                        break
                                if idx >= 0:
                                    try:
                                        old_lp = install_btn.getLayoutParams()
                                        if isinstance(old_lp, LinearLayout.LayoutParams):
                                            old_lp.topMargin = AndroidUtilities.dp(16)
                                            old_lp.bottomMargin = 0
                                            install_btn.setLayoutParams(old_lp)
                                            deps_lp = LinearLayout.LayoutParams(old_lp)
                                            deps_lp.topMargin = AndroidUtilities.dp(8)
                                            deps_lp.bottomMargin = AndroidUtilities.dp(8)
                                            parent_layout.addView(deps_btn, idx, deps_lp)
                                            log("[KPM] Dependencies button added to install dialog")
                                        else:
                                            parent_layout.addView(deps_btn, idx, LayoutHelper.createLinear(-1, 48, 0, 16, 28, 8, 0))
                                            log("[KPM] Dependencies button added to install dialog (fallback)")
                                    except Exception as e:
                                        log(f"[KPM] Error adding dependencies button: {e}")
                                        try:
                                            parent_layout.addView(deps_btn, idx, LayoutHelper.createLinear(-1, 48, 0, 16, 28, 8, 0))
                                            log("[KPM] Dependencies button added (simple fallback)")
                                        except Exception as e2:
                                            log(f"[KPM] Failed to add button: {e2}")
                            filename = os.path.basename(file_path_str)
                            plugin_id_raw = filename.replace(".plugin", "").replace(".py", "").strip()
                            if plugin_id_raw.startswith(".temp_"):
                                plugin_id_raw = plugin_id_raw.replace(".temp_", "")
                            status = "plugin"
                            if plugin_id_raw:
                                plugin_id_lower = plugin_id_raw.lower()
                                matched_key = next((k for k in self.plugin.plugins_list if k.lower() == plugin_id_lower), None)
                                if matched_key:
                                    plugin_info = self.plugin.plugins_list.get(matched_key)
                                    if isinstance(plugin_info, dict):
                                        status = plugin_info.get("status", "plugin")
                            status_label = _tr("status_library") if status == "library" else _tr("status_plugin")
                            try:
                                from android.util import TypedValue
                                from android.view import Gravity
                                TextView = find_class("android.widget.TextView")
                                status_container = None
                                trusted_insert_index = None
                                if isinstance(custom_view, ViewGroup) and custom_view.getChildCount() > 0:
                                    first_child = custom_view.getChildAt(0)
                                    if isinstance(first_child, ViewGroup):
                                        status_container = first_child
                                        def find_trusted_view(view, depth=0):
                                            nonlocal trusted_insert_index
                                            if not view or depth > 15:
                                                return
                                            try:
                                                if isinstance(view, TextView):
                                                    txt = str(view.getText() or "")
                                                    if "rust" in txt or "–æ–≤–µ—Ä–µ–Ω" in txt or "rust" in txt.lower() or "trusted" in txt.lower():
                                                        p = view.getParent()
                                                        if isinstance(p, ViewGroup):
                                                            for i in range(p.getChildCount()):
                                                                if p.getChildAt(i) == view:
                                                                    trusted_insert_index = (p, i)
                                                                    return
                                                            trusted_insert_index = (p, 0)
                                                        return
                                            except Exception:
                                                pass
                                            if isinstance(view, ViewGroup):
                                                for i in range(view.getChildCount()):
                                                    find_trusted_view(view.getChildAt(i), depth + 1)
                                                    if trusted_insert_index:
                                                        return
                                        find_trusted_view(status_container)
                                pill_bg_color = Theme.getColor(Theme.key_dialogSearchBackground, resources_provider) if resources_provider else Theme.getColor(Theme.key_dialogSearchBackground)
                                pill_drawable = Theme.createRoundRectDrawable(AndroidUtilities.dp(8), pill_bg_color)
                                pill_layout = LinearLayout(sheet.getContext())
                                pill_layout.setOrientation(LinearLayout.HORIZONTAL)
                                pill_layout.setGravity(Gravity.CENTER)
                                pill_layout.setBackground(pill_drawable)
                                pill_layout.setPadding(AndroidUtilities.dp(12), AndroidUtilities.dp(6), AndroidUtilities.dp(12), AndroidUtilities.dp(6))
                                status_tv = TextView(sheet.getContext())
                                if resources_provider:
                                    status_tv.setTextColor(Theme.getColor(Theme.key_dialogTextBlack, resources_provider))
                                else:
                                    status_tv.setTextColor(Theme.getColor(Theme.key_dialogTextBlack))
                                status_tv.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 13)
                                status_tv.setText(status_label)
                                status_tv.setGravity(Gravity.CENTER)
                                pill_layout.addView(status_tv, LayoutHelper.createLinear(-2, -2, Gravity.CENTER_VERTICAL))
                                pill_lp = LayoutHelper.createLinear(-2, -2, 0, 16, 8, 16, 8)
                                if status_container is not None and trusted_insert_index is not None:
                                    trusted_parent, idx = trusted_insert_index
                                    trusted_parent.addView(pill_layout, idx, pill_lp)
                                    log(f"[KPM] Status pill added before trusted: {status_label}")
                                elif status_container is not None:
                                    status_container.addView(pill_layout, 0, pill_lp)
                                    log(f"[KPM] Status pill added at top: {status_label}")
                                else:
                                    parent_layout.addView(pill_layout, pill_lp)
                                    log(f"[KPM] Status pill added: {status_label}")
                            except Exception as status_err:
                                log(f"[KPM] Could not add status pill: {status_err}")
                        
                        except Exception as e:
                            log(f"[KPM] Error modifying install sheet UI: {e}")
                            log(traceback.format_exc())
                    Handler = find_class("android.os.Handler")
                    Looper = find_class("android.os.Looper")
                    Runnable = find_class("java.lang.Runnable")
                    
                    class ModifyUIRunnable(dynamic_proxy(Runnable)):
                        def __init__(self):
                            super().__init__()
                        
                        def run(self):
                            modify_ui()
                    
                    handler = Handler(Looper.getMainLooper())
                    handler.postDelayed(ModifyUIRunnable(), 100)
            

            try:
                JavaClass = find_class("java.lang.Class")
                SheetClassJava = JavaClass.forName("com.exteragram.messenger.plugins.ui.components.InstallPluginBottomSheet")
            except Exception:
                SheetClassWrapper = find_class("com.exteragram.messenger.plugins.ui.components.InstallPluginBottomSheet")
                if SheetClassWrapper:
                    SheetClassJava = SheetClassWrapper.class_
                else:
                    log("[KPM] InstallPluginBottomSheet class not found")
                    return
            
            if not SheetClassJava:
                log("[KPM] InstallPluginBottomSheet class not found")
                return
            target_ctor = None
            constructors = SheetClassJava.getDeclaredConstructors()
            
            for ctor in constructors:
                params = ctor.getParameterTypes()
                if len(params) == 3:
                    p0 = params[0].getName()
                    p2 = params[2].getName()
                    if "BaseFragment" in p0 and "PluginInstallParams" in p2:
                        target_ctor = ctor
                        break
            
            if target_ctor:
                target_ctor.setAccessible(True)
                self.hook_method(target_ctor, InstallSheetHook(self))
                log("[KPM] Install sheet hook installed successfully")
            else:
                log("[KPM] InstallPluginBottomSheet constructor not found")
        
        except Exception as e:
            log(f"[KPM] Error adding install sheet hook: {e}")
            log(traceback.format_exc())
    
    def add_plugins_activity_hook(self):
        try:
            from base_plugin import MethodHook
            
            class PluginsActivityHook(MethodHook):
                def __init__(self, plugin):
                    self.plugin = plugin
                
                def after_hooked_method(self, param):
                    try:
                        if not self.plugin.get_setting("show_add_button", True):
                            return
                        
                        activity = param.thisObject
                        action_bar = activity.actionBar
                        if not action_bar:
                            log("[KPM] ActionBar is None")
                            return
                        
                        menu = action_bar.menu
                        if not menu:
                            log("[KPM] Menu is None")
                            return     
                        try:
                            if hasattr(menu, 'ids') and menu.ids:
                                if 2 in [int(x) for x in menu.ids]:
                                    log("[KPM] Button '+' already exists (checked via ids)")
                                    return
                        except Exception as check_error:
                            log(f"[KPM] Could not check existing items: {check_error}")
                        
                        from org.telegram.messenger import R
                        
                        class AddButtonClickListener(dynamic_proxy(View.OnClickListener)):
                            def __init__(self, plugin_instance):
                                super().__init__()
                                self.plugin_instance = plugin_instance
                            
                            def onClick(self, v):
                                self.plugin_instance.open_install_dialog()
                        
                        class UpdateButtonClickListener(dynamic_proxy(View.OnClickListener)):
                            def __init__(self, plugin_instance):
                                super().__init__()
                                self.plugin_instance = plugin_instance
                            
                            def onClick(self, v):
                                self.plugin_instance.open_update_dialog()
                        
                        add_item = menu.addItem(2, R.drawable.msg_add)
                        add_item.setOnClickListener(AddButtonClickListener(self.plugin))
                        if self.plugin.get_setting("show_update_button", True):
                            update_item = menu.addItem(3, R.drawable.menu_browser_refresh)
                            update_item.setOnClickListener(UpdateButtonClickListener(self.plugin))
                            log("[KPM] Added '+' and update buttons to PluginsActivity menu")
                        else:
                            log("[KPM] Added '+' button to PluginsActivity menu (update button hidden by settings)")
                    except Exception as e:
                        log(f"[KPM] Error in PluginsActivity hook: {e}")
                        log(traceback.format_exc())
            
            PluginsActivity = find_class("com.exteragram.messenger.plugins.ui.PluginsActivity")
            if PluginsActivity:
                method = PluginsActivity.getClass().getDeclaredMethod("createView", find_class("android.content.Context").getClass())
                method.setAccessible(True)
                self.hook_method(method, PluginsActivityHook(self))
                log("[KPM] PluginsActivity hook installed successfully")
            else:
                log("[KPM] PluginsActivity class not found")
        except Exception as e:
            log(f"[KPM] Error adding PluginsActivity hook: {e}")
            log(traceback.format_exc())
    
    def _get_dependencies_from_file(self, file_path):
        try:
            if not os.path.exists(file_path):
                return []

            with open(file_path, 'r', encoding='utf-8') as f:
                content = f.read()

            import re
            pattern = r'__dependencies__\s*=\s*\[(.*?)\]'
            match = re.search(pattern, content, re.DOTALL)
            
            if match:
                deps_str = match.group(1)

                deps = []
                for dep in deps_str.split(','):
                    dep = dep.strip().strip('"').strip("'")
                    if dep:
                        deps.append(dep)
                return deps
            
            return []
        
        except Exception as e:
            log(f"[KPM] Error getting dependencies from file: {e}")
            return []

    def load_cache(self):
        try:
            if os.path.exists(self.cache_file):
                with open(self.cache_file, "r", encoding="utf-8") as f:
                    cache_data = json.load(f)
                    self.plugins_list = cache_data.get("plugins_list", {})
                    self.plugin_names_cache = cache_data.get("plugin_names", {})
                    cached_commit = cache_data.get("commit_sha", "")
                    log(f"[KPM] Loaded cache with {len(self.plugins_list)} plugins, {len(self.plugin_names_cache)} names (commit: {cached_commit[:7]})")
        except Exception as e:
            log(f"[KPM] Error loading cache: {e}")

    def save_cache(self, commit_sha):
        try:
            cache_data = {
                "plugins_list": self.plugins_list,
                "plugin_names": self.plugin_names_cache,
                "commit_sha": commit_sha,
                "timestamp": int(time.time())
            }
            with open(self.cache_file, "w", encoding="utf-8") as f:
                json.dump(cache_data, f, ensure_ascii=False, indent=2)
            log(f"[KPM] Saved cache with {len(self.plugins_list)} plugins, {len(self.plugin_names_cache)} names (commit: {commit_sha[:7]})")
        except Exception as e:
            log(f"[KPM] Error saving cache: {e}")
    
    def clear_cache(self):
        try:
            if os.path.exists(self.cache_file):
                os.remove(self.cache_file)
                log("[KPM] Cache file deleted")
            
            self.plugins_list.clear()
            self.plugin_names_cache.clear()
            log("[KPM] Cache cleared from memory")
            
            run_on_ui_thread(lambda: BulletinHelper.show_error(_tr("cache_cleared")))
        except Exception as e:
            log(f"[KPM] Error clearing cache: {e}")
            run_on_ui_thread(lambda: BulletinHelper.show_error(f"–û—à–∏–±–∫–∞: {e}"))

    def get_latest_commit_sha(self):
        try:
            log(f"[KPM] Checking latest commit from GitHub API...")
            r = requests.get(self.github_api_url, timeout=10)
            if r.status_code == 200:
                commit_data = json.loads(r.text)
                sha = commit_data.get("sha", "")
                log(f"[KPM] Latest commit: {sha[:7]}")
                return sha
        except Exception as e:
            log(f"[KPM] Error getting commit SHA: {e}")
        return None

    def get_cached_commit_sha(self):
        try:
            if os.path.exists(self.cache_file):
                with open(self.cache_file, "r", encoding="utf-8") as f:
                    cache_data = json.load(f)
                    return cache_data.get("commit_sha", "")
        except Exception:
            pass
        return ""

    def is_cache_valid(self):
        cached_sha = self.get_cached_commit_sha()
        if not cached_sha:
            log("[KPM] No cached commit SHA, cache invalid")
            return False

        latest_sha = self.get_latest_commit_sha()
        if not latest_sha:
            log("[KPM] Could not get latest commit SHA, using cache")
            return True

        is_valid = cached_sha == latest_sha
        log(f"[KPM] Cache valid: {is_valid} (cached: {cached_sha[:7]}, latest: {latest_sha[:7]})")
        return is_valid

    def force_refresh_store(self):
        log("[KPM] Force refreshing store (clearing cache)...")
        self.plugins_list.clear()
        self.refresh_store(force=True)


    def refresh_store(self, force=False):
        if not force and self.is_cache_valid():
            log("[KPM] Cache is valid, skipping refresh")
            run_on_ui_thread(lambda: BulletinHelper.show_error(f"–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫—ç—à ({len(self.plugins_list)} –ø–ª–∞–≥–∏–Ω–æ–≤)"))
            return

        log("[KPM] Refreshing store from URLs...")

        for url in self.store_json_urls:
            try:
                log(f"[KPM] Trying JSON URL: {url}")
                r = requests.get(url, timeout=20)
                log(f"[KPM] Response status: {r.status_code}")
                if r.status_code == 200 and r.text:
                    try:
                        store_data = json.loads(r.text)
                    except Exception as e:
                        log(f"[KPM] JSON parse error: {e}")
                        continue
                    
                    if isinstance(store_data, dict):
                        normalized = {}
                        for pid, value in store_data.items():
                            if isinstance(value, str):
                                normalized[pid] = {"url": value}
                            elif isinstance(value, dict):
                                normalized[pid] = {
                                    "url": value.get("url", ""),
                                    "dependencies": value.get("dependencies", [])
                                }
                               
                                if value.get("name"):
                                    normalized[pid]["name"] = value.get("name")
                                if value.get("version"):
                                    normalized[pid]["version"] = value.get("version")
                                if value.get("icon"):
                                    normalized[pid]["icon"] = value.get("icon")
                                if value.get("author"):
                                    normalized[pid]["author"] = value.get("author")
                                if value.get("description"):
                                    normalized[pid]["description"] = value.get("description")
                                normalized[pid]["status"] = value.get("status", "plugin")
                        

                        all_deps = set()
                        for plugin_info in normalized.values():
                            if isinstance(plugin_info, dict):
                                deps = plugin_info.get("dependencies", [])
                                all_deps.update(deps)
                        
                        libs = []
                        plugins = []
                        
                        for pid, plugin_info in normalized.items():
                            is_lib = pid in all_deps or "lib" in pid.lower()
                            if is_lib:
                                libs.append((pid, plugin_info))
                            else:
                                plugins.append((pid, plugin_info))
                        
                    
                        sorted_plugins = {}
                        for pid, plugin_info in libs:
                            sorted_plugins[pid] = plugin_info
                        for pid, plugin_info in plugins:
                            sorted_plugins[pid] = plugin_info
                        
                        self.plugins_list = sorted_plugins
                        log(f"[KPM] Loaded {len(self.plugins_list)} plugins from JSON store ({len(libs)} libs, {len(plugins)} plugins)")
                        log(f"[KPM] Libraries: {[pid for pid, _ in libs]}")
                        log(f"[KPM] Plugins: {[pid for pid, _ in plugins]}")
                        
                        latest_sha = self.get_latest_commit_sha()
                        if latest_sha:
                            self.save_cache(latest_sha)
                        
                        run_on_ui_thread(lambda: BulletinHelper.show_error(f"–ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(self.plugins_list)} –ø–ª–∞–≥–∏–Ω–æ–≤ –∏–∑ JSON —Å—Ç–æ—Ä–∞"))
                        return
            except Exception as e:
                log(f"[KPM] JSON store fetch fail {url}: {e}")

        run_on_ui_thread(lambda: BulletinHelper.show_error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å store.json"))

    def list_available_ids(self):
        if not self.plugins_list:
            log("[KPM] plugins_list is empty, loading from cache...")
            self.load_cache()
        if not self.plugins_list:
            log("[KPM] Cache is empty, refreshing from network...")
            self.refresh_store()
        
        return list(self.plugins_list.keys())

    def parse_plugin_metadata(self, content):
        metadata = {
            "name": None,
            "description": None,
            "author": None,
            "version": None,
            "icon": None,
        }
        try:
            lines = content.decode('utf-8', errors='ignore').split('\n')
            in_multiline = False
            multiline_key = None
            multiline_value = []
            
            for line in lines:
                line_stripped = line.strip()
                if in_multiline:
                    if '"""' in line_stripped:
                        multiline_value.append(line_stripped.split('"""')[0])
                        metadata[multiline_key] = '\n'.join(multiline_value).strip()
                        in_multiline = False
                        multiline_key = None
                        multiline_value = []
                    else:
                        multiline_value.append(line_stripped)
                    continue
                
                for key in ['__name__', '__description__', '__author__', '__version__', '__icon__']:
                    if line_stripped.startswith(key):
                        parts = line_stripped.split('=', 1)
                        if len(parts) == 2:
                            value = parts[1].strip()
                            if value.startswith('"""'):
                                if value.count('"""') >= 2:
                                    metadata[key[2:-2]] = value.strip('"').strip()
                                else:
                                    in_multiline = True
                                    multiline_key = key[2:-2]
                                    multiline_value = [value[3:]]
                            else:
                                metadata[key[2:-2]] = value.strip('"').strip("'")
                        break
                
                if all(metadata.values()):
                    break
        except Exception as e:
            log(f"[KPM] Error parsing metadata: {e}")
        return metadata

    def get_plugin_display_name(self, plugin_id):
        if plugin_id in self.plugin_names_cache:
            return self.plugin_names_cache[plugin_id]
        
        if plugin_id not in self.plugins_list:
            return plugin_id
        
        try:
            plugin_info = self.plugins_list[plugin_id]

            if isinstance(plugin_info, dict) and plugin_info.get("name"):
                name = plugin_info.get("name")
                self.plugin_names_cache[plugin_id] = name
                return name

            url = plugin_info.get("url") if isinstance(plugin_info, dict) else plugin_info
            content = self.fetch_remote_bytes(url)
            metadata = self.parse_plugin_metadata(content)
            if metadata["name"]:
                self.plugin_names_cache[plugin_id] = metadata["name"]
                return metadata["name"]
        except Exception as e:
            log(f"[KPM] Error getting display name for {plugin_id}: {e}")
        
        self.plugin_names_cache[plugin_id] = plugin_id
        return plugin_id

    def open_update_dialog(self):
        installed = self.list_installed_plugins()
        if not installed:
            run_on_ui_thread(lambda: BulletinHelper.show_error(_tr("no_installed")))
            return
        
        fragment = get_last_fragment()
        if not fragment:
            return
        
        def load_names():
            try:
                display_names = {}
                updatable_plugins = []
                versions = {}
                icons = {}
                
                for pid in installed:
                    filename = f"{pid}.py"
                    local_path = os.path.join(PLUGINS_DIR, filename)
                    try:
                        if not os.path.exists(local_path):
                            display_names[pid] = pid
                            continue
                        with open(local_path, "rb") as f:
                            local_bytes = f.read()
                        if not local_bytes:
                            display_names[pid] = pid
                            continue
                        
                        metadata = self.parse_plugin_metadata(local_bytes)
                        local_version = metadata.get("version", "0")
                        
                        plugin_info = self.plugins_list.get(pid)
                        if not plugin_info:
                            continue
                        

                        if isinstance(plugin_info, dict):
                            display_names[pid] = plugin_info.get("name") or metadata.get("name") or pid
                            remote_version = plugin_info.get("version", "0")
                            icon_str = plugin_info.get("icon")
                            if icon_str:
                                icons[pid] = icon_str
                        else:
                            display_names[pid] = metadata.get("name") or pid
                            remote_version = "0"
                    
                        if remote_version == "0":
                            url = plugin_info.get("url") if isinstance(plugin_info, dict) else plugin_info
                            try:
                                remote_bytes = self.fetch_remote_bytes(url)
                                remote_metadata = self.parse_plugin_metadata(remote_bytes)
                                remote_version = remote_metadata.get("version", "0")
                            except Exception as e:
                                log(f"[KPM] Error checking {pid}: {e}")
                                continue
                        
                        if remote_version != local_version and remote_version != "0":
                            updatable_plugins.append(pid)
                            versions[pid] = (local_version or "0", remote_version or "0")
                            log(f"[KPM] Update available: {pid} ({local_version} -> {remote_version})")
                    except Exception as e:
                        log(f"[KPM] Error processing {pid}: {e}")
                        display_names[pid] = pid
                
                if not updatable_plugins:
                    run_on_ui_thread(lambda: BulletinHelper.show_error(_tr("list_empty")))
                    return
                
                def show_selection():
                    try:
                        self._show_plugin_list(_tr("update_plugins"), updatable_plugins, {"d": display_names, "vers": versions, "ic": icons}, KangelPluginsManager.UPDATE)
                    except Exception as e:
                        log(f"[KPM] Error showing update selection: {e}")
                
                run_on_ui_thread(show_selection)
            except Exception as e:
                log(f"[KPM] Error loading plugin names: {e}")
        
        run_on_queue(load_names)
    
    def update_selected_plugins(self, plugin_ids, fn):
        updated = 0
        failed = 0
        for pid in plugin_ids:
            try:
                plugin_info = self.plugins_list.get(pid)
                if not plugin_info:
                    failed += 1
                    continue
                
                url = plugin_info.get("url") if isinstance(plugin_info, dict) else plugin_info
                filename = f"{pid}.py"
                local_path = os.path.join(PLUGINS_DIR, filename)
                
                if not os.path.exists(local_path):
                    failed += 1
                    continue
                with open(local_path, "rb") as f:
                    local_bytes = f.read()
                if not local_bytes:
                    failed += 1
                    continue
                
                try:
                    remote = self.fetch_remote_bytes(url)
                    local_metadata = self.parse_plugin_metadata(local_bytes)
                    remote_metadata = self.parse_plugin_metadata(remote)
                    local_version = local_metadata.get("version", "0")
                    remote_version = remote_metadata.get("version", "0")
                except Exception:
                    failed += 1
                    continue
                
                if local_version != remote_version:
                    try:
                        tmp = local_path + ".tmp"
                        with open(tmp, "wb") as f:
                            f.write(remote)
                        if os.path.exists(local_path):
                            os.remove(local_path)
                        shutil.move(tmp, local_path)
                        updated += 1
                    except Exception:
                        failed += 1
                else:
                    log(f"[KPM] Plugin {pid} is already up to date")
            except Exception as e:
                log(f"[KPM] Error updating {pid}: {e}")
                failed += 1
        
        msg = f"–û–±–Ω–æ–≤–ª–µ–Ω–æ: {updated}, –æ—à–∏–±–æ–∫: {failed}" if _get_lang() == "ru" else f"Updated: {updated}, errors: {failed}"
        fn()
        run_on_ui_thread(lambda: BulletinHelper.show_error(msg))
    
    def show_plugin_info_and_install(self, plugin_id, enable_after=False):
        def load_info():
            try:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–ª–∞–≥–∏–Ω –µ—Å—Ç—å –≤ store.json
                if not self.plugins_list:
                    log(f"[KPM] plugins_list is empty, refreshing store...")
                    self.refresh_store()
                
                plugin_info = self.plugins_list.get(plugin_id)
                if not plugin_info:
                    error_msg = f"Plugin {plugin_id} not found in store.json"
                    log(f"[KPM] {error_msg}")
                    run_on_ui_thread(lambda: BulletinHelper.show_error(error_msg))
                    return
                
                # –í–°–ï–ì–î–ê –±–µ—Ä–µ–º URL –∏–∑ store.json
                url = plugin_info.get("url") if isinstance(plugin_info, dict) else plugin_info
                if not url:
                    error_msg = f"No URL found in store.json for plugin {plugin_id}"
                    log(f"[KPM] {error_msg}")
                    run_on_ui_thread(lambda: BulletinHelper.show_error(error_msg))
                    return
                
                log(f"[KPM] Installing {plugin_id} from store.json URL: {url}")
                
                info = self.get_plugin_full_info(plugin_id)
                if not info:
                    run_on_ui_thread(lambda: BulletinHelper.show_error(f"Failed to load {plugin_id}"))
                    return
                
                # –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ URL –≤ info —Ç–æ–∂–µ –∏–∑ store.json
                if not info.get('url') or info['url'] != url:
                    log(f"[KPM] Warning: URL mismatch, using store.json URL: {url}")
                    info['url'] = url
                
                dependencies = info.get("dependencies", [])
                
                def install_main_plugin():
                    try:
                        fragment = get_last_fragment()
                        if not fragment:
                            return
                        
                        temp_path = os.path.join(PLUGINS_DIR, f".temp_{plugin_id}.plugin")
                        error_msg = None
                        try:
                            plugin_url = info.get('url')
                            if not plugin_url:
                                raise Exception(f"No URL in info for {plugin_id}")
                            
                            log(f"[KPM] Downloading plugin from URL: {plugin_url}")
                            plugin_content = self.fetch_remote_bytes(plugin_url)
                            with open(temp_path, 'wb') as f:
                                f.write(plugin_content)
                            
                            PluginsController.getInstance().showInstallDialog(fragment, temp_path, True)
                            
                            log(f"[KPM] Opened Extera install dialog for {plugin_id}")
                        except Exception as download_error:
                            error_msg = str(download_error)
                            log(f"[KPM] Error downloading plugin for install dialog: {error_msg}")
                            if os.path.exists(temp_path):
                                try:
                                    os.remove(temp_path)
                                except:
                                    pass
                        
                        if error_msg:
                            run_on_ui_thread(lambda msg=error_msg: BulletinHelper.show_error(f"Error: {msg}"))
                    except Exception as e:
                        log(f"[KPM] Error showing Extera install dialog: {e}")
                        log(traceback.format_exc())
                
                if dependencies:
                    log(f"[KPM] Found {len(dependencies)} dependencies for {plugin_id}: {dependencies}")
                
                run_on_ui_thread(install_main_plugin)
            except Exception as e:
                log(f"[KPM] Error loading plugin info: {e}")
        
        run_on_queue(load_info)
    
    def show_plugin_info_and_delete(self, plugin_id, fn = None):
        log('taaakk')
        def load_info():
            try:
                log('getting')
                info = self.get_plugin_full_info(plugin_id)
                if not info:
                    run_on_ui_thread(lambda: BulletinHelper.show_error(f"Failed to load {plugin_id}"))
                    return
                
                def show_dialog():
                    try:
                        fragment = get_last_fragment()
                        if not fragment:
                            return
                        
                        lang = _get_lang()
                        if lang == "ru":
                            title = f"–£–¥–∞–ª–∏—Ç—å –ø–ª–∞–≥–∏–Ω?"
                            message = f"{info['name']}\n\n{_tr('version')}: {info['version']}\n{_tr('author')}: {info['author']}"
                        else:
                            title = f"Delete plugin?"
                            message = f"{info['name']}\n\n{_tr('version')}: {info['version']}\n{_tr('author')}: {info['author']}"
                        
                        builder = AlertDialogBuilder(fragment.getParentActivity())
                        builder.set_title(title)
                        builder.set_message(message)
                        builder.set_positive_button(_tr("delete_button"), lambda d, w: run_on_queue(
                            lambda: self.delete_plugin_by_id(plugin_id, fn)
                        ))
                        builder.set_negative_button(_tr("cancel"), lambda d, w: d.dismiss())
                        builder.show()
                    except Exception as e:
                        log(f"[KPM] Error showing delete dialog: {e}")
                        import traceback
                        log(traceback.format_exc())
                
                run_on_ui_thread(show_dialog)
            except Exception as e:
                log(f"[KPM] Error loading plugin info for delete: {e}")
        
        run_on_queue(load_info)
    
    def get_plugin_full_info(self, plugin_id):
        try:
            plugin_info = self.plugins_list.get(plugin_id)
            if not plugin_info:
                log(f"[KPM] Plugin {plugin_id} not found in plugins_list")
                return None
            url = plugin_info.get("url") if isinstance(plugin_info, dict) else plugin_info
            filename = f"{plugin_id}.py"
            local_path = os.path.join(PLUGINS_DIR, filename)
            
            if os.path.exists(local_path):
                with open(local_path, "rb") as f:
                    content = f.read()
            else:
                content = self.fetch_remote_bytes(url)
            
            metadata = self.parse_plugin_metadata(content)
            
            metadata["plugin_id"] = plugin_id
            metadata["url"] = url  # –í—Å–µ–≥–¥–∞ –∏–∑ store.json
            metadata["dependencies"] = plugin_info.get("dependencies", []) if isinstance(plugin_info, dict) else []
            
            if isinstance(plugin_info, dict):
                if plugin_info.get("name"):
                    metadata["name"] = plugin_info.get("name")
                if plugin_info.get("version"):
                    metadata["version"] = plugin_info.get("version")
                if plugin_info.get("author"):
                    metadata["author"] = plugin_info.get("author")
                if plugin_info.get("description"):
                    metadata["description"] = plugin_info.get("description")
            
            if not metadata["name"]:
                metadata["name"] = plugin_id
            if not metadata["description"]:
                metadata["description"] = _tr("no_description")
            if not metadata["author"]:
                metadata["author"] = "Unknown"
            if not metadata["version"]:
                metadata["version"] = "1.0"
            
            return metadata
        except Exception as e:
            log(f"[KPM] Error getting full info: {e}")
            return None
    
    def _show_searchable_dialog(self, fragment, title, plugin_ids, display_names, on_click_callback):
        try:
            log(f"[KPM] _show_searchable_dialog called: title={title}, plugin_ids count={len(plugin_ids)}")
            context = fragment.getParentActivity()
            if not context:
                log("[KPM] Error: context is None")
                return
            
            log(f"[KPM] Context obtained, getting icons for {len(plugin_ids)} plugins")
            icons = {}
            for pid in plugin_ids:
                plugin_info = self.plugins_list.get(pid)
                if isinstance(plugin_info, dict):
                    icon_str = plugin_info.get("icon")
                    if icon_str:
                        icons[pid] = icon_str
            log(f"[KPM] Found {len(icons)} icons")
            
            builder = AlertDialog.Builder(context)
            builder.setTitle(title)
            
            container = LinearLayout(context)
            container.setOrientation(LinearLayout.VERTICAL)
            container.setPadding(
                AndroidUtilities.dp(16),
                AndroidUtilities.dp(8),
                AndroidUtilities.dp(16),
                AndroidUtilities.dp(8)
            )
            
            search_edit = EditText(context)
            search_edit.setHint(_tr("search_hint"))
            search_edit.setSingleLine(True)
            search_edit.setTextSize(16)
            search_edit.setPadding(
                AndroidUtilities.dp(12),
                AndroidUtilities.dp(8),
                AndroidUtilities.dp(12),
                AndroidUtilities.dp(8)
            )
            
            try:
                search_edit.setTextColor(Theme.getColor(Theme.key_windowBackgroundWhiteBlackText))
                search_edit.setHintTextColor(Theme.getColor(Theme.key_windowBackgroundWhiteHintText))
                search_edit.setBackground(Theme.createRoundRectDrawable(
                    AndroidUtilities.dp(6),
                    Theme.getColor(Theme.key_windowBackgroundWhite)
                ))
            except Exception as e:
                log(f"[KPM] Error setting EditText colors: {e}")
            
            container.addView(search_edit, LinearLayout.LayoutParams(
                ViewGroup.LayoutParams.MATCH_PARENT,
                ViewGroup.LayoutParams.WRAP_CONTENT
            ))

            from android.view import Gravity
            from android.widget import ScrollView
            from org.telegram.messenger import MediaDataController
            from org.telegram.ui.Components import BackupImageView
            
            scroll_view = ScrollView(context)
            items_container = LinearLayout(context)
            items_container.setOrientation(LinearLayout.VERTICAL)
            scroll_view.addView(items_container)
            
            current_account = 0
            try:
                current_account = fragment.getCurrentAccount()
            except Exception:
                current_account = 0
            media_controller = MediaDataController.getInstance(current_account)
            icon_size_dp = 32
            
            log(f"[KPM] Creating items container with {len(plugin_ids)} plugins")
            
            plugins_info = {}
            for pid in plugin_ids:
                plugin_info = self.plugins_list.get(pid)
                if isinstance(plugin_info, dict):
                    author = plugin_info.get("author", "")
                    description = plugin_info.get("description", "")
                    plugins_info[pid] = {
                        "author": author,
                        "description": description
                    }
            
            def create_item_view(pid, display_name, icon_str):
                try:

                    item_layout = LinearLayout(context)
                    item_layout.setOrientation(LinearLayout.HORIZONTAL)
                    item_layout.setGravity(Gravity.TOP)
                    item_layout.setPadding(
                        AndroidUtilities.dp(16),
                        AndroidUtilities.dp(12),
                        AndroidUtilities.dp(16),
                        AndroidUtilities.dp(12)
                    )
                    item_layout.setBackground(Theme.getSelectorDrawable(False))
                    item_layout.setClickable(True)
                    item_layout.setFocusable(True)
                    
                    # –ò–∫–æ–Ω–∫–∞
                    if icon_str:
                        icon_view = BackupImageView(context)
                        icon_view.setRoundRadius(0)
                        icon_view.getImageReceiver().setCrossfadeWithOldImage(True)
                        icon_size_px = AndroidUtilities.dp(icon_size_dp)
                        icon_lp = LinearLayout.LayoutParams(icon_size_px, icon_size_px)
                        icon_lp.rightMargin = AndroidUtilities.dp(12)
                        icon_lp.topMargin = AndroidUtilities.dp(2)
                        item_layout.addView(icon_view, icon_lp)
                        
                        try:
                            if "/" in icon_str:
                                pack_name, index_str = icon_str.split("/", 1)
                                try:
                                    sticker_index = int(index_str)
                                    media_controller.setPlaceholderImageByIndex(icon_view, pack_name, sticker_index, f"{icon_size_dp}_{icon_size_dp}")
                                except ValueError:
                                    pass
                        except Exception as e:
                            log(f"[KPM] Error loading icon for {pid}: {e}")

                    text_container = LinearLayout(context)
                    text_container.setOrientation(LinearLayout.VERTICAL)
                    text_container.setLayoutParams(LinearLayout.LayoutParams(
                        ViewGroup.LayoutParams.MATCH_PARENT,
                        ViewGroup.LayoutParams.WRAP_CONTENT
                    ))
                    
                    name_view = AndroidTextView(context)
                    name_view.setText(display_name)
                    name_view.setTextSize(16)
                    name_view.setTypeface(AndroidUtilities.getTypeface(AndroidUtilities.TYPEFACE_ROBOTO_MEDIUM))
                    name_view.setTextColor(Theme.getColor(Theme.key_dialogTextBlack))
                    name_view.setGravity(Gravity.START)
                    name_view.setSingleLine(True)
                    text_container.addView(name_view, LinearLayout.LayoutParams(
                        ViewGroup.LayoutParams.MATCH_PARENT,
                        ViewGroup.LayoutParams.WRAP_CONTENT
                    ))
                    
                    plugin_data = plugins_info.get(pid, {})
                    author_text = plugin_data.get("author", "")
                    if author_text:
                        author_view = AndroidTextView(context)
                        author_view.setText(author_text)
                        author_view.setTextSize(13)
                        author_view.setTextColor(Theme.getColor(Theme.key_dialogTextGray3))
                        author_view.setGravity(Gravity.START)
                        author_view.setSingleLine(True)
                        author_view.setPadding(0, AndroidUtilities.dp(2), 0, 0)
                        text_container.addView(author_view, LinearLayout.LayoutParams(
                            ViewGroup.LayoutParams.MATCH_PARENT,
                            ViewGroup.LayoutParams.WRAP_CONTENT
                        ))
                    

                    description_text = plugin_data.get("description", "")
                    if description_text:
        
                        desc_view = AndroidTextView(context)
                        desc_view.setText(description_text)
                        desc_view.setTextSize(13)
                        desc_view.setTextColor(Theme.getColor(Theme.key_dialogTextGray2))
                        desc_view.setGravity(Gravity.START)
                        desc_view.setMaxLines(10 ** 8)
                        desc_view.setEllipsize(TextUtils.TruncateAt.END)
                        desc_view.setPadding(0, AndroidUtilities.dp(4), 0, 0)
                        text_container.addView(desc_view, LinearLayout.LayoutParams(
                            ViewGroup.LayoutParams.MATCH_PARENT,
                            ViewGroup.LayoutParams.WRAP_CONTENT
                        ))
                    
                    item_layout.addView(text_container)
                    
                    return item_layout
                except Exception as e:
                    log(f"[KPM] Error creating view for {pid}: {e}")
                    import traceback
                    log(f"[KPM] Traceback: {traceback.format_exc()}")
                    return None
            

            item_views = {}
            BATCH_SIZE = 30
            
            class ItemClickProxy(dynamic_proxy(View.OnClickListener)):
                def __init__(self, plugin_id, callback):
                    super().__init__()
                    self.plugin_id = plugin_id
                    self.callback = callback
                
                def onClick(self, v):
                    self.callback(self.plugin_id)
            
            class ItemLongClickProxy(dynamic_proxy(View.OnLongClickListener)):
                def __init__(self, plugin_id):
                    super().__init__()
                    self.plugin_id = plugin_id
                
                def onLongClick(self, v):
                    try:
                        link = f"tg://kpm_install?plugin={self.plugin_id}"
                        clipboard = context.getSystemService(Context.CLIPBOARD_SERVICE)
                        clip = ClipData.newPlainText("KPM Link", link)
                        clipboard.setPrimaryClip(clip)
                        lang = _get_lang()
                        msg = f"–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞: {link}" if lang == "ru" else f"Link copied: {link}"
                        run_on_ui_thread(lambda: BulletinHelper.show_error(msg))
                        return True
                    except Exception as e:
                        log(f"[KPM] Error copying link: {e}")
                    return False
            
            def add_batch(start_idx):
                try:
                    end_idx = min(start_idx + BATCH_SIZE, len(plugin_ids))
                    batch_pids = plugin_ids[start_idx:end_idx]
                    batch_views = []
                    
                    for pid in batch_pids:
                        display_name = display_names.get(pid, pid)
                        icon_str = icons.get(pid)
                        item_layout = create_item_view(pid, display_name, icon_str)
                        
                        if item_layout:
                            item_layout.setOnClickListener(ItemClickProxy(pid, on_click_callback))
                            item_layout.setOnLongClickListener(ItemLongClickProxy(pid))
                            item_views[pid] = item_layout
                            batch_views.append((pid, item_layout))
                    
                    def add_to_ui():
                        for pid, item_layout in batch_views:
                            items_container.addView(item_layout, LinearLayout.LayoutParams(
                                ViewGroup.LayoutParams.MATCH_PARENT,
                                ViewGroup.LayoutParams.WRAP_CONTENT
                            ))
                        log(f"[KPM] Added batch {start_idx}-{end_idx} ({len(batch_views)} items) to UI")
                    
                    run_on_ui_thread(add_to_ui)

                    if end_idx < len(plugin_ids):
                        Handler = find_class("android.os.Handler")
                        Looper = find_class("android.os.Looper")
                        Runnable = find_class("java.lang.Runnable")
                        
                        class BatchRunnable(dynamic_proxy(Runnable)):
                            def __init__(self, next_idx):
                                super().__init__()
                                self.next_idx = next_idx
                            
                            def run(self):
                                run_on_queue(lambda: add_batch(self.next_idx))
                        
                        handler = Handler(Looper.getMainLooper())
                        handler.postDelayed(BatchRunnable(end_idx), 50)
                    else:
                        log(f"[KPM] All {len(item_views)} item views created")
                except Exception as e:
                    log(f"[KPM] Error adding batch: {e}")
                    log(traceback.format_exc())

            log(f"[KPM] Starting async view creation in batches of {BATCH_SIZE}")
            run_on_queue(lambda: add_batch(0))
            
            scroll_params = LinearLayout.LayoutParams(
                ViewGroup.LayoutParams.MATCH_PARENT,
                AndroidUtilities.dp(400)
            )
            scroll_params.topMargin = AndroidUtilities.dp(8)
            container.addView(scroll_view, scroll_params)

            def filter_items(query):
                try:
                    query_lower = query.lower() if query else ""
                    visible_count = 0
                    for pid in plugin_ids:
                        item_view = item_views.get(pid)
                        if item_view:
                            display_name = display_names.get(pid, pid)
                            if not query_lower or query_lower in display_name.lower() or query_lower in pid.lower():
                                item_view.setVisibility(View.VISIBLE)
                                visible_count += 1
                            else:
                                item_view.setVisibility(View.GONE)
                    log(f"[KPM] Filtered items: {visible_count} visible out of {len(plugin_ids)}")
                except Exception as e:
                    log(f"[KPM] Error filtering items: {e}")
            
            filter_items("")
            
            builder.setView(container)
            builder.setNegativeButton(_tr("cancel"), None)
            
            dialog = builder.create()
            current_dialog = [dialog]
            log(f"[KPM] Dialog created, showing...")
            
            class SearchTextWatcher(dynamic_proxy(TextWatcher)):
                def __init__(self, filter_func):
                    super().__init__()
                    self.filter_func = filter_func
                
                def beforeTextChanged(self, s, start, count, after):
                    pass
                
                def onTextChanged(self, s, start, before, count):
                    pass
                
                def afterTextChanged(self, editable):
                    try:
                        query = str(editable)
                        self.filter_func(query)
                    except Exception as e:
                        log(f"[KPM] Search error: {e}")
            
            watcher = SearchTextWatcher(filter_items)
            search_edit.addTextChangedListener(watcher)
            
            log(f"[KPM] Showing dialog...")
            dialog.show()
            log(f"[KPM] Dialog shown")
        except Exception as e:
            log(f"[KPM] Error creating searchable dialog: {e}")
            log(traceback.format_exc())

    def open_install_dialog(self):
        fragment = get_last_fragment()
        if not fragment:
            return
        
        def load_and_show():
            try:
                ids = self.list_available_ids()
                if not ids:
                    run_on_ui_thread(lambda: BulletinHelper.show_error(_tr("list_empty")))
                    return
                
                log(f"[KPM] Loading display names for {len(ids)} plugins from cache...")
                display_names = {}
                
                for pid in ids:
                    if pid in self.plugin_names_cache:
                        display_names[pid] = self.plugin_names_cache[pid]
                    else:
                        display_names[pid] = pid
                
                log(f"[KPM] Loaded {len(display_names)} display names from cache")
                
                def create_dialog():
                    try:
                        current_fragment = get_last_fragment()
                        if not current_fragment:
                            log("[KPM] Fragment is None when creating install dialog")
                            return
                        self._show_plugin_list(_tr('install_title'), ids, display_names)
                    
                    except Exception as e:
                        log(f"[KPM] Error creating install dialog: {e}")
                
                run_on_ui_thread(create_dialog)
                
                def update_names_in_background():
                    try:
                        failed_pids = []
                        for pid in ids:
                            if pid not in self.plugin_names_cache:
                                try:
                                    name = self.get_plugin_display_name(pid)
                                    if name != pid:
                                        display_names[pid] = name
                                        log(f"[KPM] Updated name for {pid}: {name}")
                                except Exception as e:
                                    log(f"[KPM] Error updating name for {pid}: {e}")
                                    failed_pids.append(pid)
                    except Exception as e:
                        log(f"[KPM] Error in background name update: {e}")
                
                run_on_queue(update_names_in_background)
                
            except Exception as e:
                log(f"[KPM] Error loading plugins: {e}")
                run_on_ui_thread(lambda: BulletinHelper.show_error(f"–û—à–∏–±–∫–∞: {e}"))
        
        run_on_queue(load_and_show)
    
    def _show_plugin_list(self, title, ids, display_names, type = 0):
        current_fragment = get_last_fragment()
        delegate = self.PluginListFragment(self, title, ids, display_names, type)
        fragment = UniversalFragment(delegate)
        current_fragment.presentFragment(fragment)
        fragment.setTitle(title, False, 0)
        from java.lang import Boolean, Integer
        from org.telegram.ui.ActionBar import (ActionBar, ActionBarMenuItem,
                                               BackDrawable)
        
        if self.search_listener_hooks:
            for h in self.search_listener_hooks:
                self.unhook_method(h)
        self.search_listener_hooks = []
        id = 0
        def update_query(query):
            if query == delegate.search_query:
                return
            nonlocal id
            id += 1
            delegate.search_query = query
            def update(cid):
                nonlocal id
                if id != cid:
                    return
                delegate.adapter.update(True)
            
            run_on_ui_thread(lambda: update(id), 500)
            
        class SearchCollapseHook(MethodHook):
            def after_hooked_method(self, param):
                if param.thisObject != item or param.args[0] == True:
                    return
                param.setResult(None)
                update_query(None)
                
        hook = self.hook_method(ActionBarMenuItem.getClass().getDeclaredMethod("toggleSearch", Boolean.TYPE), SearchCollapseHook())
        self.search_listener_hooks.append(hook)

        class SearchTextChangedHook(MethodHook):
            def before_hooked_method(self, param):
                if param.thisObject != listener:
                    return
                search_query: str = search_field.getText().toString()
                if search_query.isspace():
                    search_query = None
                update_query(search_query)
        
        item = fragment.getActionBar().createMenu().addItem(0, R_tg.drawable.ic_ab_search).setIsSearchField(True)
        search_field = item.getSearchField()
        listener = get_private_field(search_field, "mListeners").get(0)
        from java.lang import CharSequence
        hook = self.hook_method(listener.getClass().getDeclaredMethod("onTextChanged", CharSequence, Integer.TYPE, Integer.TYPE, Integer.TYPE), SearchTextChangedHook())
        self.search_listener_hooks.append(hook)  
    
    INSTALL = 0
    DELETE = 1
    UPDATE = 2
     
    class PluginListFragment(dynamic_proxy(UniversalFragment.UniversalFragmentDelegate)):
        
        class Callback2(dynamic_proxy(Utilities.Callback2)):
            def __init__(self, fn):
                super().__init__()
                self.fn = fn
            
            def run(self, *args):
                self.fn(*args)
    
        class Callback5(dynamic_proxy(Utilities.Callback5)):
            def __init__(self, fn):
                super().__init__()
                self.fn = fn
            
            def run(self, *args):
                self.fn(*args)
        
        class Callback5Return(dynamic_proxy(Utilities.Callback5Return)):
            def __init__(self, fn):
                super().__init__()
                self.fn = fn
            
            def run(self, *args):
                return self.fn(*args)
        
        class PluginCellDelegate(dynamic_proxy(PluginCellDelegate)):
            def __init__(self, id, outer: "KangelPluginsManager.PluginListFragment"):
                super().__init__()
                self.id = id
                self.outer = outer
                
            def canOpenInExternalApp(self):
                return False

            def deletePlugin(self):
                try:
                    def on_delete(pid):
                        self.outer.plugin_ids.remove(self.id)
                        self.outer.adapter.update(True)
                    self.outer.pl.show_plugin_info_and_delete(self.id, on_delete)
                except Exception as e:
                    log(str(e))

            def openInExternalApp(self):
                pass

            def openPluginSettings(self):
                pass

            def pinPlugin(self,view):
                pass

            def sharePlugin(self):
                if not self.id:
                    return
                AndroidUtilities.addToClipboard(f'tg://kpm_install?plugin={self.id}')
                run_on_ui_thread(lambda: BulletinHelper.show_copied_to_clipboard())

            def togglePlugin(self, view):
                pass
        
        class PluginCellHook(MethodHook):
            def __init__(self, outer: "KangelPluginsManager.PluginListFragment"):
                self.create_button_method = None
                self.outer = outer
                
            def after_hooked_method(self, param):
                from android_utils import OnClickListener
                from java import jint
                from java.lang import Boolean, Integer
                try:
                    this = param.thisObject
                    p = param.args[0]
                    if not p or p.getEngine() != __id__:
                        return
                    
                    get_private_field(this, "pinButton").setVisibility(View.GONE)
                    get_private_field(this, "checkBox").setVisibility(View.GONE)
                    delete_button = get_private_field(this, "deleteButton")
                    if self.outer.type != KangelPluginsManager.DELETE:
                        delete_button.setVisibility(View.GONE)
                    plugin_id = p.getId()
                    plugin_info = self.outer.pl.plugins_list.get(plugin_id)
                    author = ""
                    description = ""
                    if isinstance(plugin_info, dict):
                        author = plugin_info.get("author", "")
                        description = plugin_info.get("description", "")
                        log(f"[KPM] PluginCellHook: {plugin_id} - author='{author[:30] if author else 'None'}', description='{description if description else 'None'}'")
                    
                    desc = get_private_field(this, "subtitleView")
                    if self.outer.type == KangelPluginsManager.UPDATE:
                        old, new = self.outer.display_names["vers"][plugin_id]
                        label = f'{old} -> {new}'
                        s = SpannableString(label)
                        try:
                            s.setSpan(StrikethroughSpan(), 0, len(old), Spanned.SPAN_EXCLUSIVE_EXCLUSIVE)
                        except Exception:
                            pass
                        desc.setText(s)
                    else:
                        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º author –∏ –≤–µ—Ä—Å–∏—é –≤ subtitle
                        version_text = p.getVersion() or ""
                        if author:
                            if version_text:
                                desc.setText(f"{author} ‚Ä¢ {version_text}")
                            else:
                                desc.setText(author)
                        else:
                            desc.setText(version_text)
                    
                    # –ò—Å–ø–æ–ª—å–∑—É–µ–º descriptionView –¥–ª—è –æ–ø–∏—Å–∞–Ω–∏—è
                    description_view = get_private_field(this, "descriptionView")
                    if description:
                        description_view.setVisibility(View.VISIBLE)
                        description_view.setText(description)
                        description_view.setMaxLines(10 ** 8)
                        description_view.setEllipsize(TextUtils.TruncateAt.END)
                    else:
                        description_view.setVisibility(View.GONE)
                    share_button = get_private_field(this, "shareButton")
                    if self.outer.type != KangelPluginsManager.INSTALL:
                        share_button.setVisibility(View.GONE)
                    parent = share_button.getParent()
                    parent.setVisibility(View.GONE)
                    
                    
                    if not self.create_button_method:
                        self.create_button_method = this.getClass().getDeclaredMethod("createButton", Context, Integer.TYPE, Boolean.TYPE, View.OnClickListener)
                        self.create_button_method.setAccessible(True)
                       
                    def create_button(icon, fn):
                        return self.create_button_method.invoke(
                            this,
                            get_last_fragment().getContext(), 
                            jint(icon), 
                            False, 
                            OnClickListener(lambda *_: fn()))
                        
                    button = None
                    if self.outer.type == KangelPluginsManager.INSTALL:
                        button = create_button(R_tg.drawable.msg_download, lambda: self.outer.pl.show_plugin_info_and_install(p.getId()))
                    elif self.outer.type == KangelPluginsManager.UPDATE:
                        def on_update():
                            self.outer.plugin_ids.remove(p.getId())
                            self.outer.adapter.update(True)
                        button = create_button(R_tg.drawable.menu_browser_refresh, lambda: self.outer.pl.update_selected_plugins([p.getId()], on_update)) 
                            
                    new_buttons_layout = LinearLayout(get_last_fragment().getContext())
                    new_buttons_layout.setOrientation(LinearLayout.VERTICAL)
                    gravity = Gravity.TOP
                    if self.outer.type == KangelPluginsManager.INSTALL:
                        gravity = Gravity.TOP
                        parent.removeView(share_button)
                        new_buttons_layout.addView(share_button, share_button.getLayoutParams())
                    elif self.outer.type == KangelPluginsManager.DELETE:
                        delete_button.getParent().removeView(delete_button)
                        new_buttons_layout.addView(delete_button, delete_button.getLayoutParams())
                    
                    if button is not None:
                        new_buttons_layout.addView(button, share_button.getLayoutParams())
                    
                    this.addView(new_buttons_layout, LayoutHelper.createFrame(-2, -2, gravity | Gravity.RIGHT))
                except Exception as e:
                    log(str(e))
        
        
        def __init__(self, pl: "KangelPluginsManager", title, plugin_ids, display_names, type = 0):
            super().__init__()
            self.title = title
            self.plugin_ids = plugin_ids
            self.display_names = display_names
            self.pl = pl
            self.search_query = None
            self.adapter = None
            self.type = type
            self.fill_id = 0
        
        def beforeCreateView(self):        
            self.content_view = FrameLayout(get_last_fragment().getContext())
            self.content_view.setBackgroundColor(Theme.getColor(Theme.key_windowBackgroundWhite))

            self.recycler = UniversalRecyclerView(
                get_last_fragment(),
                self.Callback2(self.fillItems),
                self.Callback5(self.onClick),
                self.Callback5Return(self.onLongClick)
            )
            self.content_view.addView(self.recycler, LayoutHelper.createFrame(-1, -1))

            if self.type == KangelPluginsManager.UPDATE and len(self.plugin_ids) > 0:
                from android_utils import OnClickListener
                updating = False
                def on_click(*_):
                    nonlocal updating
                    if updating:
                        return
                    updating = True
                    def on_update():
                        self.plugin_ids.clear()
                        self.adapter.update(True)
                    self.pl.update_selected_plugins(self.plugin_ids, on_update)
                    
                update_all_button = TextView(get_last_fragment().getContext())
                update_all_button.setPadding(AndroidUtilities.dp(34), 0, AndroidUtilities.dp(34), 0)
                update_all_button.setGravity(Gravity.CENTER)
                update_all_button.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 14)
                update_all_button.setTypeface(AndroidUtilities.bold())
                update_all_button.setText(_tr("update_plugins"))

                update_all_button.setTextColor(Theme.getColor(Theme.key_featuredStickers_buttonText))
                update_all_button.setBackground(Theme.AdaptiveRipple.filledRectByKey(Theme.key_featuredStickers_addButton, 4))
                update_all_button.setOnClickListener(OnClickListener(on_click))
                self.content_view.addView(update_all_button, LayoutHelper.createFrame(-1, 48, Gravity.BOTTOM, 7, 0, 7, 0))

            return self.content_view
        
        def getTitle(self):
            return self.title
        
        def onBackPressed(self):
            get_last_fragment().finishFragment()
            return None
        
        def fillItems(self, items, adapter):
            self.adapter = adapter
            self.items = items
            self.fill_id += 1
            if self.search_query:
                def match(pid):
                    name = self.display_names.get(pid)
                    if not name:
                        name = pid
                    elif not isinstance(name, str):
                        name = name.get("name", pid)

                    query_lower = self.search_query.lower()
                    return query_lower in name.lower() or query_lower in pid.lower()

                plugin_ids = [pid for pid in self.plugin_ids if match(pid)] 
            else:
                plugin_ids = self.plugin_ids
        
            self.addItems(0, plugin_ids, items, self.fill_id)
        
        chunk_size = 15
        def addItems(self, i, plugins_ids, items, fid):
            try:
                if fid != self.fill_id:
                    return
                from_ = i*self.chunk_size
                len_ = len(plugins_ids)
                get_ = min(self.chunk_size, len_ - from_)
                stop = from_ + get_
                for j in range(from_, stop):
                    pid = plugins_ids[j]
                    if self.type == KangelPluginsManager.DELETE:
                        name = self.display_names[pid]["name"]
                    elif self.type == KangelPluginsManager.UPDATE:
                        name = self.display_names["d"][pid]
                    else:
                        name = self.display_names[pid]
                        
                    p = Plugin(pid, name)
                    p.setEngine(__id__)
                    icon = None
                    ver = None
                    if self.type == KangelPluginsManager.INSTALL:
                        info = self.pl.plugins_list.get(pid)
                        if not info:
                            continue
                        icon = info.get("icon")
                        ver = info.get("version")  
                    elif self.type == KangelPluginsManager.DELETE:
                        mt = self.display_names.get(pid)
                        if isinstance(mt, dict):
                            icon = mt.get("icon")
                            ver = mt.get("version")
                        else: continue
                    else:
                        try:
                            icon = self.display_names["ic"][pid]
                        except Exception as e:
                            log(str(e))
                        
                    if isinstance(icon, str):
                        p.setIcon(icon) 
                    if isinstance(ver, str):
                        p.setVersion(ver)   
                        
                    from com.exteragram.messenger.plugins.ui.components import \
                        PluginCell
                    try:
                        items.add(PluginCell.Factory.asPlugin(p, self.PluginCellDelegate(pid, self)))
                    except Exception as e:
                        log(f"[KPM] PluginCell.Factory.asPlugin failed, trying UItem.asPlugin: {e}")
                        try:
                            items.add(UItem.asPlugin(1, p, self.PluginCellDelegate(pid, self)))
                        except Exception as e2:
                            log(f"[KPM] UItem.asPlugin also failed: {e2}")
                if stop >= len_ and self.type == KangelPluginsManager.UPDATE:
                    items.add(UItem.asSpace(AndroidUtilities.dp(48)))
                if i != 0:
                    self.adapter.notifyItemRangeInserted(from_, get_)
                if stop >= len_:
                    return
                run_on_ui_thread(lambda: self.addItems(i + 1, plugins_ids, items, fid), 250)
            except Exception as e:
                log(str(e))
        
        def onClick(self, item, view, position, x, y):
            return False
    
        def onLongClick(self, item, view, position, x, y):
            return False
        
        def afterCreateView(self, view):
            pass
        
        def onFragmentCreate(self, *_):
            from com.exteragram.messenger.plugins.ui.components import \
                PluginCell
            self.set_hook = self.pl.hook_method(PluginCell.getClass().getDeclaredMethod("set", Plugin, PluginCellDelegate), self.PluginCellHook(self))
        
        def onFragmentDestroy(self, *_):
            self.fill_id += 1
            self.content_view.getParent().removeView(self.content_view)
            if self.set_hook:
                self.pl.unhook_method(self.set_hook)
            if self.pl.search_listener_hooks:
                for h in self.pl.search_listener_hooks:
                    self.pl.unhook_method(h)
            self.set_hook = None
            self.pl.search_listener_hooks = None
            
        def onMenuItemClick(self, *_):
            pass

    def open_delete_dialog(self):
        installed = self.list_installed_plugins()
        if not installed:
            run_on_ui_thread(lambda: BulletinHelper.show_error(_tr("no_installed")))
            return
        fragment = get_last_fragment()
        if not fragment:
            return

        mt = {}
        for pid in installed:
            filename = f"{pid}.py"
            local_path = os.path.join(PLUGINS_DIR, filename)
            try:
                if os.path.exists(local_path):
                    with open(local_path, "rb") as f:
                        content = f.read()
                    if content:
                        metadata = self.parse_plugin_metadata(content)
                        metadata["name"] = metadata["name"] if metadata["name"] else pid
                        mt[pid] = metadata
                    else:
                        mt[pid] = pid
                else:
                    mt[pid] = pid
            except Exception:
                mt[pid] = pid
        
        def create_dialog():
            try:
                current_fragment = get_last_fragment()
                if not current_fragment:
                    log("[KPM] Fragment is None when creating delete dialog")
                    return
                self._show_plugin_list(_tr("delete_title"), installed, mt, KangelPluginsManager.DELETE)
            except Exception as e:
                log(f"[KPM] Error creating delete dialog: {e}")
        run_on_ui_thread(create_dialog)

    def list_installed_plugins(self):
        installed = []
        try:
            if not os.path.isdir(PLUGINS_DIR):
                return installed
            for name in os.listdir(PLUGINS_DIR):
                if not name.endswith(".py"):
                    continue
                path = os.path.join(PLUGINS_DIR, name)
                try:
                    with open(path, "rb") as f:
                        content = f.read()
                    plugin_id = None
                    for line in content.decode('utf-8', errors='ignore').split('\n'):
                        s = line.strip()
                        if s.startswith("__id__"):
                            parts = s.split('=', 1)
                            if len(parts) == 2:
                                plugin_id = parts[1].strip().strip('"').strip("'")
                            break
                    if plugin_id:
                        installed.append(plugin_id)
                except Exception:
                    continue
        except Exception:
            pass
        return installed

    def delete_plugin_by_id(self, plugin_id, fn = None):
        def on_delete_callback(error):
            def update_ui():
                if error:
                    BulletinHelper.show_error(_tr("error_delete").format(str(error)))
                else:
                    BulletinHelper.show_success(_tr("deleted").format(plugin_id))
                if fn:
                    fn(plugin_id)
            
            run_on_ui_thread(update_ui)
        
        try:
            class DeleteCallback(dynamic_proxy(Utilities.Callback)):
                def __init__(self, fn):
                    super().__init__()
                    self._fn = fn
                def run(self, arg):
                    try:
                        self._fn(arg)
                    except Exception as e:
                        log(f"[KPM] Error in delete callback: {e}")
            
            PluginsController.getInstance().deletePlugin(plugin_id, DeleteCallback(on_delete_callback))
            log(f"[KPM] Initiated deletion of plugin: {plugin_id}")
        except Exception as e:
            log(f"[KPM] Error deleting plugin {plugin_id}: {e}")
            run_on_ui_thread(lambda err=str(e): BulletinHelper.show_error(_tr("error_delete").format(err)))

    def get_local_plugin_path(self, plugin_id):
        return os.path.join(PLUGINS_DIR, f"{plugin_id}.plugin")

    def read_file_bytes(self, path):
        try:
            with open(path, "rb") as f:
                return f.read()
        except Exception:
            return None

    def sha256(self, data):
        h = hashlib.sha256()
        h.update(data)
        return h.hexdigest()

    def fetch_remote_bytes(self, url):
        r = requests.get(url, timeout=30)
        if r.status_code != 200:
            raise Exception(f"HTTP {r.status_code}")
        return r.content

    def install_plugin_by_id(self, plugin_id, _installing_deps=None, enable_after=False):
        log(f"[KPM] === install_plugin_by_id called for: {plugin_id} ===")
        
        if _installing_deps is None:
            _installing_deps = set()
        
        log(f"[KPM] Current installing_deps set: {_installing_deps}")
        
        if plugin_id in _installing_deps:
            log(f"[KPM] Circular dependency detected: {plugin_id}")
            return
        
        if not self.plugins_list:
            log(f"[KPM] plugins_list is empty, refreshing store...")
            self.refresh_store()
        
        if plugin_id not in self.plugins_list:
            log(f"[KPM] ERROR: {plugin_id} not found in plugins_list")
            log(f"[KPM] Available plugins: {list(self.plugins_list.keys())}")
            error_msg = f"Plugin {plugin_id} not found in store"
            run_on_ui_thread(lambda: BulletinHelper.show_error(error_msg))
            raise Exception(error_msg)
        
        plugin_info = self.plugins_list[plugin_id]
        log(f"[KPM] plugin_info for {plugin_id}: {plugin_info}")
        
        url = plugin_info.get("url") if isinstance(plugin_info, dict) else plugin_info
        dependencies = plugin_info.get("dependencies", []) if isinstance(plugin_info, dict) else []
        
        log(f"[KPM] URL: {url}")
        log(f"[KPM] Dependencies: {dependencies}")
        
        if dependencies:
            log(f"[KPM] Found {len(dependencies)} dependencies for {plugin_id}: {dependencies}")
        
        log(f"[KPM] Starting download for {plugin_id} from: {url}")
        try:
            remote = self.fetch_remote_bytes(url)
            log(f"[KPM] Downloaded {len(remote)} bytes for {plugin_id}")
        except Exception as e:
            log(f"[KPM] ERROR downloading {plugin_id}: {e}")
            log(f"[KPM] Traceback: {traceback.format_exc()}")
            run_on_ui_thread(lambda: BulletinHelper.show_error(_tr("error_download").format(e)))
            raise
        
        target = os.path.join(PLUGINS_DIR, f"{plugin_id}.py")
        log(f"[KPM] Target path: {target}")
        
        url_filename = url.split("/")[-1] if "/" in url else ""
        log(f"[KPM] URL filename: {url_filename}")
        
        if url_filename.endswith(".plugin"):
            old_name = url_filename[:-7]
            log(f"[KPM] Removing old files with name: {old_name}")
            for ext in [".plugin", ".py"]:
                old_file = os.path.join(PLUGINS_DIR, f"{old_name}{ext}")
                if old_file != target and os.path.exists(old_file):
                    try:
                        os.remove(old_file)
                        log(f"[KPM] Removed old file: {old_file}")
                    except Exception as e:
                        log(f"[KPM] Failed to remove old file {old_file}: {e}")
        
        try:
            tmp = target + ".tmp"
            log(f"[KPM] Writing to temp file: {tmp}")
            with open(tmp, "wb") as f:
                f.write(remote)
            log(f"[KPM] Wrote {len(remote)} bytes to temp file")
            
            if os.path.exists(target):
                log(f"[KPM] Removing existing file: {target}")
                os.remove(target)
            
            log(f"[KPM] Renaming {tmp} to {target}")
            shutil.move(tmp, target)
            log(f"[KPM] Successfully installed {plugin_id} to {target}")
            
            def notify_installed():
                try:
                    controller = PluginsController.getInstance()
                    if controller and hasattr(controller, 'engines'):
                        engine = controller.engines.get("python")
                        if engine:
                            engine.loadPlugins(None)
                    NotificationCenter.getGlobalInstance().postNotificationName(NotificationCenter.pluginsUpdated)
                    
                    if enable_after:
                        try:
                            controller.setPluginEnabled(plugin_id, True, None)
                            log(f"[KPM] Plugin {plugin_id} enabled after installation")
                        except Exception as e:
                            log(f"[KPM] Error enabling plugin after installation: {e}")
                except Exception as e:
                    log(f"[KPM] Error reloading plugins: {e}")
                BulletinHelper.show_error(_tr("installed").format(f"{plugin_id}.py"))
            run_on_ui_thread(notify_installed)
        except Exception as e:
            log(f"[KPM] ERROR writing file for {plugin_id}: {e}")
            log(f"[KPM] Traceback: {traceback.format_exc()}")
            run_on_ui_thread(lambda: BulletinHelper.show_error(_tr("error_write").format(e)))
            raise 

    def update_installed_from_store(self):
        if not self.plugins_list:
            self.refresh_store()
        if not self.plugins_list:
            return
        updated = 0
        skipped = 0
        failed = 0
        installed_ids = self.list_installed_plugins()
        for pid in installed_ids:
            plugin_info = self.plugins_list.get(pid)
            if not plugin_info:
                continue
            url = plugin_info.get("url") if isinstance(plugin_info, dict) else plugin_info
            local_path = os.path.join(PLUGINS_DIR, f"{pid}.py")
            if not os.path.exists(local_path):
                continue
            try:
                with open(local_path, "rb") as f:
                    local_bytes = f.read()
            except Exception:
                failed += 1
                continue
            local_hash = self.sha256(local_bytes)
            try:
                remote = self.fetch_remote_bytes(url)
                remote_hash = self.sha256(remote)
            except Exception:
                failed += 1
                continue
            if local_hash != remote_hash:
                try:
                    tmp = local_path + ".tmp"
                    with open(tmp, "wb") as f:
                        f.write(remote)
                    if os.path.exists(local_path):
                        os.remove(local_path)
                    shutil.move(tmp, local_path)
                    updated += 1
                except Exception:
                    failed += 1
            else:
                skipped += 1
        run_on_ui_thread(lambda: BulletinHelper.show_error(_tr("updated_stats").format(updated, skipped, failed)))