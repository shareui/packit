
# Library for Quanta Plugins
# Also a big thanks to @zwyPlugins, We took some code snippets from zwylib


import json
import time
import copy
import threading
import traceback
import os.path
import tempfile
import urllib.request
import weakref
from typing import List, Callable, Optional, Any
from dataclasses import dataclass, field

from base_plugin import BasePlugin, HookStrategy, MenuItemData, MenuItemType
from android_utils import log, run_on_ui_thread
from client_utils import get_last_fragment, run_on_queue, get_send_messages_helper
from ui.bulletin import BulletinHelper
from ui.settings import Divider, Header, Switch, Input, Text, Selector

from org.telegram.messenger import Utilities, AndroidUtilities, MediaDataController, ImageLocation
from com.exteragram.messenger.utils import ChatUtils
from java import dynamic_proxy, cast, jclass
from java.util import ArrayList
from java.lang import Integer
from org.telegram.messenger import MessageObject, R as R_tg
from org.telegram.ui import ChatActivity
from org.telegram.ui.ActionBar import BottomSheet, Theme, SimpleTextView
from android.view import HapticFeedbackConstants
from org.telegram.ui.Components import BackupImageView, LayoutHelper
from android.view import Gravity
from android.widget import LinearLayout, TextView, FrameLayout
from android.util import TypedValue
from hook_utils import find_class, get_private_field, set_private_field
from java.io import File

import hashlib
import uuid

__name__ = "QuantaHut"
__description__ = "Library for Quanta plugins"
__icon__ = "luvztroyIcons/14"
__id__ = "quantahut"
__type__ = "plugin"
__version__ = "1.5.2"
__author__ = "@luvztroy"
__min_version__ = "12.2.10"
__priority__ = 1

DEFAULT_SHOW_LOGS = False
DEFAULT_SHOW_RESTART_MENU = False
DEFAULT_BRANCH = 0
RunnableClass = jclass("java.lang.Runnable")
RunnableProxy = dynamic_proxy(RunnableClass)
MAX_HISTORY = 5  
setting_getter = None

MKSTATS_API_URL = os.getenv("MKSTATS_API_URL", "https://mkstats.mk69.su/api")
MKSTATS_PING_INTERVAL = int(os.getenv("MKSTATS_PING_INTERVAL", "1500"))
MKSTATS_POW_SOLVE_SECONDS = int(os.getenv("MKSTATS_POW_SOLVE_SECONDS", "6"))

def generate_user_hash(device_id: str, plugin_id: str) -> str:
    payload = f"{device_id}:{plugin_id}:mkstats:v1"
    return hashlib.sha256(payload.encode("utf-8")).hexdigest()

def generate_device_fingerprint(device_id: str) -> str:
    payload = f"{device_id}:mkstats:device:v1"
    return hashlib.sha256(payload.encode("utf-8")).hexdigest()

def _normalize_api_base(api_url: str) -> str:
    base = api_url.rstrip("/")
    if base.endswith("/api"):
        return f"{base}/v1"
    return base

def _post_json(url: str, payload: dict) -> dict:
    data = json.dumps(payload).encode("utf-8")
    request = urllib.request.Request(
        url, data=data, headers={"Content-Type": "application/json"}
    )
    with urllib.request.urlopen(request, timeout=10) as response:
        body = response.read().decode("utf-8")
    return json.loads(body)

def _pow_valid(challenge: str, nonce: str, difficulty: int) -> bool:
    if not challenge or not nonce or difficulty <= 0:
        return False
    prefix = "0" * max(1, int(difficulty))
    digest = hashlib.sha256(f"{challenge}:{nonce}".encode("utf-8")).hexdigest()
    return digest.startswith(prefix)

def _solve_pow(challenge: str, difficulty: int, max_seconds: int = MKSTATS_POW_SOLVE_SECONDS) -> str | None:
    difficulty = max(1, int(difficulty or 0))
    deadline = time.time() + max(1, int(max_seconds or 0))
    nonce = 0
    prefix = "0" * difficulty
    while time.time() < deadline:
        candidate = format(nonce, "x")
        digest = hashlib.sha256(f"{challenge}:{candidate}".encode("utf-8")).hexdigest()
        if digest.startswith(prefix):
            return candidate
        nonce += 1
    return None

class MkStatsCoreClient:
    def __init__(self, api_url: str, plugin_id: str, plugin_version: str, user_hash: str, device_fingerprint: str, client_version: str | None = None, client_name: str | None = None) -> None:
        self.api_base = _normalize_api_base(api_url)
        self.plugin_id = plugin_id
        self.plugin_version = plugin_version
        self.client_version = client_version
        self.client_name = client_name
        self.user_hash = user_hash
        self.device_fingerprint = device_fingerprint

    def handshake(self) -> dict:
        payload = {
            "plugin_id": self.plugin_id,
            "version": self.plugin_version,
            "client_name": self.client_name,
            "client_version": self.client_version,
            "user_hash": self.user_hash,
            "device_fingerprint": self.device_fingerprint,
        }
        response = _post_json(f"{self.api_base}/handshake", payload)
        token = (response or {}).get("install_token", "")
        if token:
            return response
        pow_required = bool((response or {}).get("pow_required"))
        pow_challenge = (response or {}).get("pow_challenge")
        if pow_required and pow_challenge:
            difficulty = int((response or {}).get("pow_difficulty") or 0)
            nonce = _solve_pow(pow_challenge, difficulty)
            if nonce and _pow_valid(pow_challenge, nonce, difficulty):
                payload["pow_challenge"] = pow_challenge
                payload["pow_nonce"] = nonce
                response = _post_json(f"{self.api_base}/handshake", payload)
        return response

    def send_ping(self, install_token: str, timestamp=None) -> dict:
        payload = {
            "plugin_id": self.plugin_id,
            "version": self.plugin_version,
            "client_name": self.client_name,
            "client_version": self.client_version,
            "user_hash": self.user_hash,
            "device_fingerprint": self.device_fingerprint,
            "install_token": install_token,
            "timestamp": timestamp or int(time.time()),
        }
        return _post_json(f"{self.api_base}/data", payload)

    def send_event(self, install_token: str, event: str, count: int = 1, timestamp=None) -> dict:
        payload = {
            "plugin_id": self.plugin_id,
            "version": self.plugin_version,
            "client_name": self.client_name,
            "client_version": self.client_version,
            "user_hash": self.user_hash,
            "device_fingerprint": self.device_fingerprint,
            "install_token": install_token,
            "event": event,
            "count": count,
            "timestamp": timestamp or int(time.time()),
        }
        return _post_json(f"{self.api_base}/event", payload)






@dataclass
class ExpandableSwitch:
    key: str
    text: str
    children: List[Any] = field(default_factory=list)
    collapsed: bool = True
    on_switch_click: Callable = field(default=None, compare=False, repr=False)
    link_alias: str = None
    type: str = field(default="expandable_switch", init=False)


class QuantaHut(BasePlugin):

    def _mkstats_get_setting(self, key: str, default):
        try:
            if hasattr(self, "get_setting"):
                return self.get_setting(key, default)
            if hasattr(self, "getsetting"):
                return self.getsetting(key, default)
        except Exception:
            pass
        return default

    def _mkstats_set_setting(self, key: str, value, reload_settings: bool = False):
        try:
            if hasattr(self, "set_setting"):
                return self.set_setting(key, value, reload_settings=reload_settings)
            if hasattr(self, "setsetting"):
                return self.setsetting(key, value, reloadsettings=reload_settings)
        except Exception:
            pass
        return None

    def _mkstats_get_device_id(self) -> str:
        device_id = self._mkstats_get_setting("mkstats_device_id", "")
        if not device_id:
            device_id = uuid.uuid4().hex
            self._mkstats_set_setting("mkstats_device_id", device_id, reload_settings=False)
        return device_id

    def _mkstats_get_client_version(self) -> str:
        try:
            from org.telegram.messenger import BuildVars
            version = getattr(BuildVars, "BUILD_VERSION_STRING", None) or getattr(BuildVars, "BUILD_VERSION", None)
            if version:
                return str(version)
        except Exception:
            pass
        try:
            from org.telegram.messenger import BuildConfig as TgBuildConfig
            version = getattr(TgBuildConfig, "VERSION_NAME", None)
            if version:
                return str(version)
        except Exception:
            pass
        try:
            from com.radolyn.ayugram import BuildConfig as AyuBuildConfig
            version = getattr(AyuBuildConfig, "VERSION_NAME", None)
            if version:
                return str(version)
        except Exception:
            pass
        try:
            from com.exteragram.messenger import BuildConfig as ExBuildConfig
            version = getattr(ExBuildConfig, "VERSION_NAME", None)
            if version:
                return str(version)
        except Exception:
            pass
        try:
            from org.telegram.messenger import ApplicationLoader
            ctx = ApplicationLoader.applicationContext
            if ctx:
                pm = ctx.getPackageManager()
                pkg = ctx.getPackageName()
                info = pm.getPackageInfo(pkg, 0)
                version = getattr(info, "versionName", None) or getattr(info, "versionCode", None)
                if version:
                    return str(version)
        except Exception:
            pass
        return "unknown"

    def _mkstats_get_client_name(self) -> str:
        try:
            from org.telegram.messenger import ApplicationLoader
            ctx = ApplicationLoader.applicationContext
            if ctx:
                pkg = ctx.getPackageName()
                if pkg == "com.radolyn.ayugram":
                    return "AyuGram"
                if pkg == "com.exteragram.messenger":
                    return "exteraGram"
                if pkg == "org.telegram.messenger":
                    return "Telegram"
                if pkg:
                    return str(pkg)
        except Exception:
            pass
        try:
            from com.radolyn.ayugram import BuildConfig as AyuBuildConfig
            _ = AyuBuildConfig.VERSION_NAME
            return "AyuGram"
        except Exception:
            pass
        try:
            from com.exteragram.messenger import BuildConfig as ExBuildConfig
            _ = ExBuildConfig.VERSION_NAME
            return "exteraGram"
        except Exception:
            pass
        return "unknown"



    def _mkstats_event(self, event: str, count: int = 1) -> None:
        if not event:
            return

        def _send():
            try:
                if not hasattr(self, "_mkstats_client"):
                    return
                if not getattr(self, "_mkstats_token", ""):
                    data = self._mkstats_client.handshake()
                    self._mkstats_token = data.get("install_token", "")
                    if self._mkstats_token:
                        self._mkstats_set_setting("mkstats_install_token", self._mkstats_token, reload_settings=False)
                if self._mkstats_token:
                    self._mkstats_client.send_event(self._mkstats_token, event, count=count)
            except Exception as exc:
                self.log(f"QuantaHut: event error {exc}")
                self._mkstats_token = ""
                self._mkstats_set_setting("mkstats_install_token", "", reload_settings=False)

        try:
            threading.Thread(target=_send, daemon=True).start()
        except Exception:
            pass

    def _mkstats_loop(self):
        while not self._mkstats_stop.is_set():
            try:
                if not self._mkstats_token:
                    data = self._mkstats_client.handshake()
                    self._mkstats_token = data.get("install_token", "")
                    if self._mkstats_token:
                        self._mkstats_set_setting("mkstats_install_token", self._mkstats_token, reload_settings=False)
                        self.log("QuantaHut: handshake ok, token stored")
                    else:
                        self.log("QuantaHut: handshake response missing token")

                if self._mkstats_token:
                    self._mkstats_client.send_ping(self._mkstats_token)
            except Exception as exc:
                self.log(f"QuantaHut: error {exc}")
                self._mkstats_token = ""
                self._mkstats_set_setting("mkstats_install_token", "", reload_settings=False)
            self._mkstats_stop.wait(MKSTATS_PING_INTERVAL)

    def _mkstats_start(self):
        try:
            device_id = self._mkstats_get_device_id()
            user_hash = generate_user_hash(device_id, __id__)
            device_fingerprint = generate_device_fingerprint(device_id)
            client_name = self._mkstats_get_client_name()
            client_version = self._mkstats_get_client_version()
            self._mkstats_client = MkStatsCoreClient(MKSTATS_API_URL, __id__, __version__, user_hash, device_fingerprint, client_version, client_name)
            self._mkstats_stop = threading.Event()
            self._mkstats_token = self._mkstats_get_setting("mkstats_install_token", "")
            self._mkstats_thread = threading.Thread(target=self._mkstats_loop, daemon=True)
            self._mkstats_thread.start()
            self.log(f"QuantaHut: client started ({self._mkstats_client.api_base})")
        except Exception:
            pass

    def __init__(self):
        super().__init__()
        self.hook_refs = []
        self.available_languages = []
        self.current_language = "en"
        self.localization_cache = github_localization.localization_cache
        self.restart_menu_item = None
        self.current_filter = 0
        self.filter_pills = []
        self.pills_container = None
        self.stored_context = None
        self.stored_activity = None

        self._search_state = {}
        self._all_items_cache = {}
        self._search_history = {}
        self._activity_refs = {}
        self.plugin_types_cache = {}
        self.settings_search_create_view_hook = None
        self.settings_search_fill_items_hook = None
        
        self._link_alias_class_cache = {}
        self.link_alias_hook_constructor_ref = None
        self.link_alias_current_enter_view_ref = None
        self.link_alias_settings_cache = None
        self.link_alias_attached_views = set()
        self.link_alias_custom_container = None
        self.link_alias_current_settings = {}

        self._es_expanded_states = {}
        self._es_children_map = {}
        self._es_children_defaults = {}
        self._es_children_callbacks = {}
        self._es_children_data = {}
        self._es_switch_callbacks = {}
        self._es_id_to_key = {}

    
    def log(self, message: str):
        if self.get_setting("show_logs", DEFAULT_SHOW_LOGS):
            log(f"[QuantaHut] {message}")
    
    def create_settings(self):
        return [
            Header(text=getString("uitweaks_settings", "Categories")),
            
            Text(
                text=getString("plugins_engine", "Plugin Engine"),
                icon="msg_plugins",
                link_alias="plugin_engine",
                create_sub_fragment=self._create_plugin_engine_settings
            ),
            
            Text(
                text=getString("localization", "Localization"),
                icon="msg_language",
                link_alias="localization",
                create_sub_fragment=self._create_localization_settings
            ),
            
            Text(
                text=getString("others", "Others"),
                icon="msg_fave",
                link_alias="others",
                create_sub_fragment=self._create_others_settings
            ),
        ]
    
    def _create_plugin_engine_settings(self):
        return [
            Header(text=getString("plugin_engine", "Plugin Engine Features")),
            Switch(key="enable_enhanced_plugin_search", text=getString("enhanced_plugin_search", "Enhanced Plugin Search"), default=True, icon="msg_search", link_alias="enhanced_plugin_search"),
            Switch(key="enable_plugin_filter_pills", text=getString("plugin_filter_pills", "Plugin Filter Pills"), default=True, icon="menu_tag_filter_solar", link_alias="plugin_filter_pills"),
            Switch(key="enable_plugin_settings_search", text=getString("plugin_settings_search", "Plugin Settings Search"), default=True, icon="msg_search", link_alias="plugin_settings_search"),
            Switch(key="enable_link_alias_search", text=getString("link_alias_search", "Link alias search"), default=True, icon="msg_link2_solar", link_alias="link_alias_search"),
            Switch(key="enable_safe_mode", text=getString("safe_mode", "Safe Mode"), default=False, icon="msg_secret", link_alias="enable_safe_mode"),
            Divider(text=getString("safe_mode_subtext", "Press volume down 5 times quickly to enable plugin safe mode ~ In Safe Mode, all plugins are inactive. This allows you to safely find and disable a problematic plugin.")),
            
            Header(text=getString("export", "Export")),
            Text(text=getString("export_all_settings", "Export All Plugin Settings"), icon="msg_photo_rotate_solar", on_click=self._export_all_settings, link_alias="export_all_settings"),
            Text(text=getString("export_all_plugins", "Export All Plugins"), icon="msg_photo_rotate_solar", on_click=self._export_all_plugins, link_alias="export_all_plugins"),
        ]
    
    def _create_localization_settings(self):
        show_branch_selector = self.get_setting("show_branch_selector", False)
        
        settings = [
            Header(text=getString("localization_settings", "Localization Settings")),
        ]
        
        if show_branch_selector:
            settings.append(
                Selector(key="language_fetch", text=getString("language_fetch", "Check Language Files"), items=[getString("branch_main", "Main"), getString("branch_beta", "Beta")], default=DEFAULT_BRANCH, icon="msg_folders", link_alias="language_fetch")
            )
        
        settings.extend([
            Text(text=getString("reset_language_preference", "Reset Language Preference"), red=True, on_click=self._reset_language_preference, on_long_click=self._toggle_branch_selector, icon="msg_delete"),
            Text(text=getString("clear_file_cache", "Clear File Cache"), red=True, on_click=self._clear_file_cache, icon="msg_delete", link_alias="clear_file_cache"),
            Divider(text=self._get_cache_info_text()),
        ])
        
        return settings
    
    def _create_others_settings(self):
        return [
            Header(text=getString("updates", "Updates")),
            Text(text=getString("check_update", "Check for Plugin Updates"), accent=True, icon="msg_download_solar", on_click=lambda v: check_quanta_updates(), link_alias="check_update"),
            
            Header(text=getString("general", "General")),
            Switch(key="enable_header_particles", text=getString("particles", "Particles"), default=True, icon="msg_settings_ny", link_alias="enable_header_particles"),
            Switch(key="show_logs", text=getString("enable_debug_logging_quantahut", "Enable Debug Logging"), default=DEFAULT_SHOW_LOGS, icon="menu_intro_solar", link_alias="show_logs"),
            Switch(key="show_restart_menu", text=getString("quantahut_show_restart", "Show Restart in Drawer"), default=DEFAULT_SHOW_RESTART_MENU, icon="msg_retry", on_change=self._on_restart_toggle_changed, link_alias="show_restart_menu"),
        ]

    def on_plugin_load(self):

        self._mkstats_start()

        self.log("Initializing QuantaHut...")
        global setting_getter
        setting_getter = self.get_setting
        QuantaHut.instance = self

        self.custom_badges = {}
        self.badge_hook_ref = None
        self.developer_hook_ref = None
        self.extera_hook_ref = None
        self.TLRPC_User = None
        self.TLRPC_Chat = None
        
        self.update_available = False
        self.latest_version = None
        self.changelog = None
        self.download_url = None
        self.checking_update = False

        self.safe_mode_hook_ref = None
        self.safe_mode_last_volume_down_time = 0
        self.safe_mode_volume_down_count = 0
        self.safe_mode_multi_tap_window = 2000
        self.safe_mode_required_taps = 5
        self.safe_mode_cooldown = 5000
        self.safe_mode_volume_down_press_time = 0
        self.safe_mode_is_holding = False
        
        self.setup_hooks()
        self._update_restart_menu_item()
        self._setup_quanta_file_hook()
        
        self._setup_deeplink_handling()
        self._setup_enhanced_plugin_search()
        self._setup_plugin_settings_search()
        self._setup_settings_header_hook()
        
        if self.get_setting("enable_link_alias_search", True):
            self._setup_link_alias_search()
        
        if self.get_setting("enable_safe_mode", False):
            self._hook_safe_mode()
        
        self._setup_expandable_switch()
        
        self.log("QuantaHut initialized")

    def _setup_settings_header_hook(self):
        try:
            from base_plugin import MethodHook
            
            class QuantaHutSettingsHeaderHook(MethodHook):
                def __init__(self, quantahut):
                    self._quantahut_ref = weakref.ref(quantahut)
                
                def after_hooked_method(self, param):
                    try:
                        quantahut = self._quantahut_ref()
                        if not quantahut:
                            return
                        activity = param.thisObject
                        items = param.args[0]
                        if not items or items.size() == 0:
                            return
                        
                        plugin_obj = get_private_field(activity, "plugin")
                        if not plugin_obj or str(plugin_obj.getId()) != "quantahut":
                            return
                        
                        if get_private_field(activity, "createSubFragmentCallback") is not None:
                            return
                        
                        searching = get_private_field(activity, "searching")
                        if searching:
                            return
                        
                        aid = id(activity)
                        search_state = quantahut._search_state.get(aid, {})
                        if search_state.get("active", False):
                            return
                        
                        header = quantahut._create_settings_header(activity.getContext())
                        if header:
                            from org.telegram.ui.Components import UItem
                            from com.exteragram.messenger.plugins.models import HeaderSetting
                            item = UItem.asCustom(header)
                            item.settingItem = HeaderSetting("quantahut_header")
                            try: item.setTransparent(True)
                            except: pass
                            items.add(0, item)
                            items.add(1, UItem.asShadow())
                    except:
                        pass
            
            PSA = find_class("com.exteragram.messenger.plugins.ui.PluginSettingsActivity")
            if PSA:
                method = PSA.getClass().getDeclaredMethod("fillItems", find_class("java.util.ArrayList"), find_class("org.telegram.ui.Components.UniversalAdapter"))
                method.setAccessible(True)
                self.hook_refs.append(self.hook_method(method, QuantaHutSettingsHeaderHook(self)))
        except Exception as e:
            self.log(f"Failed to setup settings header hook: {e}")

    def _create_settings_header(self, context):
        try:
            from android.widget import FrameLayout, TextView
            from android.view import Gravity
            from android.util import TypedValue
            from org.telegram.messenger import AndroidUtilities, MediaDataController, ImageLocation
            from org.telegram.ui.ActionBar import Theme
            from org.telegram.ui.Components import LayoutHelper, BackupImageView
            
            container = FrameLayout(context)
            
            if self.get_setting("enable_header_particles", True):
                try:
                    from org.telegram.ui.Components.Premium import StarParticlesView

                    particlesView = StarParticlesView(context)
                    particlesView.setClipWithGradient()
                    particlesView.drawable.colorKey = Theme.key_premiumStarGradient2
                    particlesView.drawable.isCircle = True
                    particlesView.drawable.centerOffsetY = AndroidUtilities.dp(0)
                    particlesView.drawable.minLifeTime = 2000
                    particlesView.drawable.randLifeTime = 3000
                    particlesView.drawable.useRotate = False
                    particlesView.drawable.updateColors()
                    container.addView(particlesView, LayoutHelper.createFrame(-1, 220, Gravity.CENTER_HORIZONTAL | Gravity.TOP, 0, 0, 0, 0))

                    run_on_ui_thread(lambda: particlesView.flingParticles(360), 200)
                except: pass
            
            imageView = BackupImageView(context)
            imageView.setRoundRadius(AndroidUtilities.dp(54))
            imageView.setClickable(True)
            
            def try_load_sticker(img):
                pack_name = "luvztroyIcons"
                sticker_index = 14
                
                ss = MediaDataController.getInstance(0).getStickerSetByName(pack_name) or MediaDataController.getInstance(0).getStickerSetByEmojiOrName(pack_name)
                if ss and ss.documents and ss.documents.size() > 0:
                    sticker_index = min(sticker_index, ss.documents.size() - 1)
                    img.setImage(ImageLocation.getForDocument(ss.documents.get(sticker_index)), "108_108", None, None, 0, 1)
                    return True
                return False
            
            if not try_load_sticker(imageView):
                MediaDataController.getInstance(0).loadStickersByEmojiOrName("luvztroyIcons", False, False)
                run_on_ui_thread(lambda: try_load_sticker(imageView), 1500)
            
            container.addView(imageView, LayoutHelper.createFrame(108, 108, Gravity.CENTER | Gravity.TOP, 0, 20, 0, 0))
            
            title = TextView(context)
            title.setTextColor(Theme.getColor(Theme.key_windowBackgroundWhiteBlackText))
            title.setTypeface(AndroidUtilities.getTypeface(AndroidUtilities.TYPEFACE_ROBOTO_MEDIUM))
            title.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 22)
            title.setText(f"QuantaHut {__version__}")
            title.setSingleLine(True)
            title.setGravity(Gravity.CENTER)
            container.addView(title, LayoutHelper.createFrame(-2, -2, Gravity.CENTER | Gravity.TOP, 50, 145, 50, 0))
            
            subtitle = TextView(context)
            subtitle.setTextColor(Theme.getColor(Theme.key_windowBackgroundWhiteGrayText))
            subtitle.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 14)
            subtitle.setText("Library for Quanta plugins")
            subtitle.setGravity(Gravity.CENTER)
            container.addView(subtitle, LayoutHelper.createFrame(-2, -2, Gravity.CENTER | Gravity.TOP, 60, 180, 60, 27))
            
            try:
                from android_utils import OnClickListener
                from java import dynamic_proxy
                from android.view import View, MotionEvent
                
                class BounceTouchListener(dynamic_proxy(View.OnTouchListener)):
                    def onTouch(self, v, event):
                        action = event.getAction()
                        if action == MotionEvent.ACTION_DOWN:
                            v.animate().scaleX(0.9).scaleY(0.9).setDuration(100).start()
                        elif action == MotionEvent.ACTION_UP or action == MotionEvent.ACTION_CANCEL:
                            v.animate().scaleX(1.0).scaleY(1.0).setDuration(100).start()
                        return False
                
                imageView.setOnTouchListener(BounceTouchListener())
            except: pass
            
            return container
        except Exception as e:
            self.log(f"Failed to create settings header: {e}")
            return None


    def _setup_deeplink_handling(self):
        try:
            LaunchActivity = find_class("org.telegram.ui.LaunchActivity")
            if LaunchActivity:
                method = LaunchActivity.getClass().getDeclaredMethod("handleIntent", 
                    find_class("android.content.Intent").getClass(),
                    find_class("java.lang.Boolean").TYPE,
                    find_class("java.lang.Boolean").TYPE,
                    find_class("java.lang.Boolean").TYPE,
                    find_class("org.telegram.messenger.browser.Browser$Progress").getClass(),
                    find_class("java.lang.Boolean").TYPE,
                    find_class("java.lang.Boolean").TYPE)
                method.setAccessible(True)
                self.hook_refs.append(self.hook_method(method, QuantaDeeplinkHook(self)))
        except Exception as e:
            self.log(f"Error setting up deeplink handling: {e}")

    def _setup_enhanced_plugin_search(self):
        if not self.get_setting("enable_enhanced_plugin_search", True):
            return
        try:
            from base_plugin import MethodHook
            from com.exteragram.messenger.plugins import PluginsController
            
            class PluginSearchHook(MethodHook):
                def __init__(self, quantahut):
                    self._quantahut_ref = weakref.ref(quantahut)
                    self.matched_plugins = []
                    
                def before_hooked_method(self, param):
                    try:
                        quantahut = self._quantahut_ref()
                        if not quantahut:
                            return
                        activity = param.thisObject
                        searching = get_private_field(activity, "searching")
                        query = get_private_field(activity, "query")
                        
                        if not searching or not query:
                            self.matched_plugins = []
                            return
                            
                        query_lower = str(query).lower()
                        
                        plugins_controller = PluginsController.getInstance()
                        all_plugins = plugins_controller.plugins
                        
                        self.matched_plugins = []
                        keys_array = all_plugins.keySet().toArray()
                        
                        for i in range(len(keys_array)):
                            key = keys_array[i]
                            plugin = all_plugins.get(key)
                            if quantahut._matches_plugin_search(plugin, query_lower):
                                self.matched_plugins.append(plugin)
                        
                        for plugin in self.matched_plugins:
                            try:
                                name_field = plugin.getClass().getDeclaredField("name")
                                name_field.setAccessible(True)
                                original_name = name_field.get(plugin)
                                name_field.set(plugin, f"{original_name} {query_lower}")
                            except:
                                break
                        
                    except Exception as e:
                        quantahut = self._quantahut_ref()
                        if quantahut:
                            quantahut.log(f"Plugin search error: {e}")
                
                def after_hooked_method(self, param):
                    try:
                        quantahut = self._quantahut_ref()
                        if not quantahut:
                            return
                        items = param.args[0]
                        activity = param.thisObject
                        
                        for plugin in self.matched_plugins:
                            try:
                                name_field = plugin.getClass().getDeclaredField("name")
                                name_field.setAccessible(True)
                                current_name = str(name_field.get(plugin))
                                if " " in current_name:
                                    original_name = current_name.rsplit(" ", 1)[0]
                                    name_field.set(plugin, original_name)
                            except:
                                pass
                        self.matched_plugins = []
                        
                        searching = get_private_field(activity, "searching")
                        if searching:
                            return
                        
                        items_to_remove = []
                        for i in range(items.size()):
                            item = items.get(i)
                            plugin = quantahut._get_plugin_from_item(item)
                            if plugin:
                                if quantahut.get_plugin_type(str(plugin.getId())) == "lib":
                                    items_to_remove.append(i)
                        
                        for i in reversed(items_to_remove):
                            items.remove(i)
                        
                        current_filter = quantahut.current_filter
                        if current_filter != 0:
                            plugins_controller = PluginsController.getInstance()
                            plugin_items = []
                            other_items = []
                            
                            for i in range(items.size()):
                                item = items.get(i)
                                plugin = quantahut._get_plugin_from_item(item)
                                if plugin:
                                    plugin_items.append(item)
                                else:
                                    other_items.append(item)
                            
                            filtered_items = []
                            for item in plugin_items:
                                plugin = quantahut._get_plugin_from_item(item)
                                if not plugin: continue
                                
                                if current_filter == 1 and plugin.isEnabled():
                                    filtered_items.append(item)
                                elif current_filter == 2 and not plugin.isEnabled():
                                    filtered_items.append(item)
                                elif current_filter == 3 and quantahut._is_recently_updated(plugin):
                                    filtered_items.append(item)
                                elif current_filter == 4 and plugins_controller.hasPluginSettings(plugin.getId()):
                                    filtered_items.append(item)
                                elif current_filter == 5 and plugin.hasError():
                                    filtered_items.append(item)
                                elif current_filter == 6 and quantahut._is_quanta_plugin(plugin):
                                    filtered_items.append(item)
                            
                            items.clear()
                            for item in other_items:
                                items.add(item)
                            for item in filtered_items:
                                items.add(item)
                        
                        if quantahut.pills_container and items.size() > 0 and quantahut.get_setting("enable_plugin_filter_pills", True):
                            from org.telegram.ui.Components import UItem
                            try:
                                pills_item = UItem.asFullyCustom(quantahut.pills_container)
                                insert_position = 1 if items.size() > 1 else items.size()
                                items.add(insert_position, pills_item)
                                quantahut._update_pill_counts()
                            except:
                                pass
                    except:
                        pass
            
            class CreateViewHook(MethodHook):
                def __init__(self, quantahut):
                    self._quantahut_ref = weakref.ref(quantahut)
                
                def after_hooked_method(self, param):
                    try:
                        quantahut = self._quantahut_ref()
                        if not quantahut:
                            return
                        activity = param.thisObject
                        context = param.args[0]
                        quantahut.stored_context = context
                        quantahut.stored_activity = activity
                        if quantahut.get_setting("enable_plugin_filter_pills", True):
                            quantahut._add_filter_pills(activity)
                            run_on_ui_thread(lambda q=quantahut, a=activity: q._refresh_plugins_list(a))
                    except:
                        pass
            
            PluginsActivityClass = find_class("com.exteragram.messenger.plugins.ui.PluginsActivity")
            if PluginsActivityClass:
                ContextClass = find_class("android.content.Context")
                create_view_method = PluginsActivityClass.getClass().getDeclaredMethod("createView", ContextClass)
                create_view_method.setAccessible(True)
                self.hook_refs.append(self.hook_method(create_view_method, CreateViewHook(self)))
                
                ArrayListClass = find_class("java.util.ArrayList")
                UniversalAdapterClass = find_class("org.telegram.ui.Components.UniversalAdapter")
                
                fill_items_method = PluginsActivityClass.getClass().getDeclaredMethod(
                    "fillItems", ArrayListClass, UniversalAdapterClass
                )
                fill_items_method.setAccessible(True)
                self.hook_refs.append(self.hook_method(fill_items_method, PluginSearchHook(self)))
                self.log("Enhanced plugin search enabled")
        except Exception as e:
            self.log(f"Failed to setup enhanced plugin search: {e}")
    
    def _get_plugin_from_item(self, item):
        try:
            if hasattr(item, 'object') and item.object:
                try:
                    class_name = item.object.getClass().getName()
                    if "com.exteragram.messenger.plugins.Plugin" in class_name:
                        return item.object
                except:
                    pass
            if hasattr(item, 'plugin') and item.plugin:
                return item.plugin
        except:
            pass
        return None
    
    def _matches_plugin_search(self, plugin, query):
        try:
            searchable = f"{plugin.getName()} {plugin.getAuthor()} {plugin.getDescription()} {plugin.getId()} {plugin.getVersion()}".lower()
            return query in searchable
        except:
            return False
    
    def get_plugin_type(self, plugin_id):
        if plugin_id in self.plugin_types_cache:
            return self.plugin_types_cache[plugin_id]
        
        try:
            import re
            from com.exteragram.messenger.plugins import PluginsController
            engine = PluginsController.getInstance().getPluginEngine(plugin_id)
            
            if not engine:
                return "plugin"
            
            plugin_path = engine.getPluginPath(plugin_id)
            if not plugin_path or not os.path.exists(plugin_path):
                return "plugin"
            
            with open(plugin_path, 'r', encoding='utf-8') as f:
                match = re.search(r'__type__\s*=\s*["\']([^"\']+)["\']', f.read())
            
            plugin_type = match.group(1) if match else "plugin"
            self.plugin_types_cache[plugin_id] = plugin_type
            return plugin_type
        except:
            return "plugin"
    
    def _get_selected_branch(self):
        branch_index = self.get_setting("language_fetch", DEFAULT_BRANCH)
        return "main" if branch_index == 0 else "Beta"
    
    def _on_restart_toggle_changed(self, enabled):
        try:
            self.set_setting("show_restart_menu", bool(enabled))
        except Exception:
            pass
        self._update_restart_menu_item()

    def _update_restart_menu_item(self):
        try:
            enabled = self.get_setting("show_restart_menu", DEFAULT_SHOW_RESTART_MENU)

            if self.restart_menu_item:
                self.remove_menu_item(self.restart_menu_item)
                self.restart_menu_item = None

            if enabled:
                self.restart_menu_item = self.add_menu_item(MenuItemData(
                    menu_type=MenuItemType.DRAWER_MENU,
                    text=getString("quantahut_restart_drawer", "Restart App"),
                    icon="msg_retry",
                    priority=150,
                    on_click=self._on_restart_menu_clicked,
                ))
        except:
            pass

    def _on_restart_menu_clicked(self, context):
        try:
            fragment = get_last_fragment()
            restart_app(fragment)
        except Exception as e:
            quantahut_log(f"Error restarting app: {e}")





    def setup_hooks(self):
        try:
            _ensure_message_menu_hooks(self)
            self._setup_custom_badges_hooks()
            self._setup_custom_badges_hooks()
            
        except Exception as e:
            self.log(f"setup_hooks error: {str(e)}")


    def _clear_file_cache(self, view):
        github_localization.localization_cache.wipe()
        run_on_ui_thread(lambda: BulletinHelper.show_success("Cache cleared successfully"))

    def _reset_language_preference(self, view):
        try:
            from base_plugin import PluginsController
            from hook_utils import get_private_field
            from ui.bulletin import BulletinHelper
            prefs = get_private_field(PluginsController.getInstance(), "preferences")
            prefs.edit().remove("plugin_setting_ui_tweaks_selected_language").apply()
            run_on_ui_thread(lambda: BulletinHelper.show_success(getString("language_pref_reset_success", "Language preference has been reset")))
        except Exception as e:
            try:
                from ui.bulletin import BulletinHelper
                run_on_ui_thread(lambda: BulletinHelper.show_error(getString("language_pref_reset_failed", "Failed to reset language preference")))
            except Exception:
                pass
            quantahut_log(f"Error resetting language preference: {e}")

    def _get_cache_info_text(self):
        try:
            cache_content = github_localization.localization_cache.content
            languages = set()
            string_count = 0
            for key in cache_content.keys():
                if key.endswith('_timestamp'):
                    parts = key.rsplit('_', 2)
                    if len(parts) >= 2:
                        languages.add(parts[-2])
                elif '_' in key and not key.endswith('_timestamp'):
                    string_count += 1
            
            info_parts = []
            
            if languages:
                formatted_langs = []
                for lang in sorted(languages):
                    try:
                        from java.util import Locale
                        locale = Locale(lang)
                        formatted_langs.append(locale.getDisplayLanguage(locale).title())
                    except:
                        formatted_langs.append(lang.upper())
                
                lang_text = ', '.join(formatted_langs)
                info_parts.append(getString("cache_info", "Cached {count} strings across languages: {languages}").format(count=string_count, languages=lang_text))
            
            if not info_parts:
                return getString("cache_info", "No cached data")
            
            return " | ".join(info_parts)
        except Exception as e:
            return getString("cache_info", "Cache status unavailable")

    def register_message_context_menu_item(self, *args, **kwargs):
        return utilities.register_message_menu_item(*args, **kwargs)

    def unregister_message_context_menu_item(self, handle):
        return utilities.unregister_message_menu_item(handle)

    def _hook_safe_mode(self):
        try:
            LaunchActivityClass = find_class("org.telegram.ui.LaunchActivity")
            if not LaunchActivityClass:
                return
            
            methods = LaunchActivityClass.getClass().getDeclaredMethods()
            dispatch_method = None
            for method in methods:
                if method.getName() == "dispatchKeyEvent":
                    dispatch_method = method
                    break
            
            if not dispatch_method:
                return
            
            dispatch_method.setAccessible(True)
            self.safe_mode_hook_ref = self.hook_method(dispatch_method, _SafeModeHook(self))
        except Exception:
            pass
    
    def _on_safe_mode_detected(self):
        try:
            run_on_ui_thread(self._enable_safe_mode)
        except Exception:
            pass
    
    def _enable_safe_mode(self):
        try:
            from com.exteragram.messenger import ExteraConfig
            from com.exteragram.messenger.plugins import PluginsController
            from android.content import Context
            from org.telegram.messenger import ApplicationLoader
            
            ExteraConfig.pluginsSafeMode = True
            editor = ExteraConfig.editor
            editor.putBoolean("pluginsSafeMode", True).apply()
            
            context = ApplicationLoader.applicationContext
            plugin_prefs = context.getSharedPreferences("plugin_settings", Context.MODE_PRIVATE)
            plugin_prefs.edit().putBoolean("had_crash", True).putString("crashed_plugin_id", "manual!").apply()
            
            PluginsController.getInstance().restart()
            
            try:
                SafeModeBottomSheet = find_class("com.exteragram.messenger.plugins.ui.components.SafeModeBottomSheet")
                fragment = get_last_fragment()
                if fragment and SafeModeBottomSheet:
                    SafeModeBottomSheet(fragment).show()
            except Exception:
                pass
        except Exception:
            pass


    def on_plugin_unload(self):

        if hasattr(self, "_mkstats_stop"):
            self._mkstats_stop.set()
            try:
                if hasattr(self, "_mkstats_thread") and self._mkstats_thread is not None:
                    self._mkstats_thread.join(timeout=1.0)
            except Exception:
                pass

        for ref in self.hook_refs:
            if ref:
                try:
                    self.unhook_method(ref)
                except:
                    pass
        self.hook_refs.clear()
        
        if self.badge_hook_ref:
            self.unhook_method(self.badge_hook_ref)
            self.badge_hook_ref = None
        if self.developer_hook_ref:
            self.unhook_method(self.developer_hook_ref)
            self.developer_hook_ref = None
        if self.extera_hook_ref:
            self.unhook_method(self.extera_hook_ref)
            self.extera_hook_ref = None
        
        if self.safe_mode_hook_ref:
            self.unhook_method(self.safe_mode_hook_ref)
            self.safe_mode_hook_ref = None
            
        if self.settings_search_create_view_hook:
            self.unhook_method(self.settings_search_create_view_hook)
            self.settings_search_create_view_hook = None
            
        if self.settings_search_fill_items_hook:
            self.unhook_method(self.settings_search_fill_items_hook)
            self.settings_search_fill_items_hook = None
        
        if self.link_alias_hook_constructor_ref:
            try:
                self.unhook_method(self.link_alias_hook_constructor_ref)
            except:
                pass
            self.link_alias_hook_constructor_ref = None
        self.link_alias_attached_views.clear()
        self._link_alias_hide_popup()
            
        self._search_state.clear()
        self._all_items_cache.clear()
        self._search_history.clear()
        self._activity_refs.clear()
        self.plugin_types_cache.clear()
        
        self.log("Plugin unloading...")


    def _setup_custom_badges_hooks(self):
        try:
            self._cache_classes()
            self._setup_badge_hook()
            self._load_custom_badges()
        except Exception as e:
            self.log(f"Error setting up custom badges hooks: {e}")
            
    def _cache_classes(self):
        try:
            self.TLRPC_User = find_class("org.telegram.tgnet.TLRPC$User")
            self.TLRPC_Chat = find_class("org.telegram.tgnet.TLRPC$Chat")
        except Exception as e:
            pass
            
    def _setup_badge_hook(self):
        try:
            BadgesController = find_class("com.exteragram.messenger.badges.BadgesController")
            if not BadgesController:
                return
                
            TLObject = find_class("org.telegram.tgnet.TLObject")
            method = BadgesController.getClass().getDeclaredMethod("getBadge", TLObject)
            method.setAccessible(True)
            
            self.badge_hook_ref = self.hook_method(method, CustomBadgeHook(self))
            
            TLRPC_User = find_class("org.telegram.tgnet.TLRPC$User")
            if TLRPC_User:
                is_developer_method = BadgesController.getClass().getDeclaredMethod("isDeveloper", TLRPC_User)
                is_developer_method.setAccessible(True)
                self.developer_hook_ref = self.hook_method(is_developer_method, CustomDeveloperHook(self))
            
            TLRPC_Chat = find_class("org.telegram.tgnet.TLRPC$Chat")
            if TLRPC_Chat:
                is_extera_method = BadgesController.getClass().getDeclaredMethod("isExtera", TLRPC_Chat)
                is_extera_method.setAccessible(True)
                self.extera_hook_ref = self.hook_method(is_extera_method, CustomExteraHook(self))
            
        except Exception as e:
            pass
            
    def _load_custom_badges(self):
        try:
            self.custom_badges.clear()
            import threading
            thread = threading.Thread(target=self._fetch_and_process_badges)
            thread.daemon = True
            thread.start()
        except Exception as e:
            pass
            
    def _fetch_and_process_badges(self):
        try:
            should_refresh = self._should_refresh_quantaconfig()
            badges_data = self._load_badges_from_config(force_refresh=should_refresh)
            if not badges_data:
                return
                
            BadgeDTO = find_class("com.exteragram.messenger.api.dto.BadgeDTO")
            if not BadgeDTO:
                return
                
            for badge_info in badges_data:
                chat_id = badge_info.get('chat_id')
                emoji_id = badge_info.get('emoji_id')
                text_template = badge_info.get('text_template')
                
                if chat_id and emoji_id and text_template:
                    chat_name = self._get_chat_name(chat_id)
                    custom_text = text_template.format(chat_name=chat_name)
                    badge_dto = BadgeDTO(emoji_id, custom_text)
                    self.custom_badges[chat_id] = badge_dto
                    
        except Exception as e:
            pass

    def _process_badges_from_data(self, badges_data):
        try:
            BadgeDTO = find_class("com.exteragram.messenger.api.dto.BadgeDTO")
            if not BadgeDTO:
                return

            for badge_info in badges_data:
                chat_id = badge_info.get('chat_id')
                emoji_id = badge_info.get('emoji_id')
                text_template = badge_info.get('text_template')
                
                if chat_id and emoji_id and text_template:
                    chat_name = self._get_chat_name(chat_id)
                    custom_text = text_template.format(chat_name=chat_name)
                    badge_dto = BadgeDTO(emoji_id, custom_text)
                    self.custom_badges[chat_id] = badge_dto
                    
        except Exception as e:
            pass
            
    def _load_badges_from_config(self, force_refresh=False):
        try:
            cache_key = "quantaconfig_badges"
            timestamp_key = "quantaconfig_timestamp"
            
            if not force_refresh:
                cached_badges = github_localization.getString_template(cache_key)
                if cached_badges:
                    return json.loads(cached_badges)
            
            quantahut_log("Downloading QuantaConfig from GitHub...")
            branch = self._get_selected_branch()
            github_url = f"https://raw.githubusercontent.com/luvztroy/UiTweaks/refs/heads/{branch}/QuantaConfig.json"
            
            with urllib.request.urlopen(github_url, timeout=10) as response:
                raw_data = response.read().decode('utf-8')
                data = json.loads(raw_data)
                badges = data.get('badges', [])
                
                github_localization.cache_text_template(cache_key, json.dumps(badges))
                github_localization.cache_text_template(timestamp_key, str(time.time()))
                return badges
                
        except urllib.error.URLError as e:
            return []
        except json.JSONDecodeError as e:
            return []
        except Exception as e:
            return []

    def _should_refresh_quantaconfig(self, max_age_hours=6):
        try:
            timestamp_key = "quantaconfig_timestamp"
            cached_timestamp = github_localization.getString_template(timestamp_key)
            
            if not cached_timestamp:
                return True
            
            cached_time = float(cached_timestamp)
            current_time = time.time()
            age_hours = (current_time - cached_time) / 3600
            
            if age_hours > max_age_hours:
                return True
            
            return False
            
        except Exception as e:
            quantahut_log(f"Error checking cache age: {e}")
            return True
            
    def _get_user_name(self, user_id):
        try:
            from client_utils import get_messages_controller
            from org.telegram.messenger import UserObject
            user_obj = get_messages_controller().getUser(user_id)
            return UserObject.getUserName(user_obj) if user_obj else 'this user'
        except Exception as e:
            return 'this user'
            
    def _get_chat_name(self, chat_id):
        try:
            from client_utils import get_messages_controller
            chat_obj = get_messages_controller().getChat(chat_id)
            return chat_obj.title if chat_obj and hasattr(chat_obj, 'title') else 'this chat'
        except Exception as e:
            return 'this chat'

    def _load_available_languages(self, language_msg_id=None):
        if getattr(self, '_languages_loading', False):
            return
        
        if not language_msg_id:
            return
            
        self._languages_loading = True
        CHANNEL_USERNAME = "QuantaConfig"
        
        def fetch_languages():
            try:
                from org.telegram.tgnet import TLRPC
                from client_utils import get_account_instance, send_request, RequestCallback
                from android_utils import run_on_ui_thread
                
                account = get_account_instance()
                
                def on_channel_resolved(chat):
                    if not chat:
                        self._languages_loading = False
                        return
                    
                    req = TLRPC.TL_messages_getHistory()
                    req.peer = TLRPC.TL_inputPeerChannel()
                    req.peer.channel_id = chat.id
                    req.peer.access_hash = chat.access_hash
                    req.offset_id = 0
                    req.limit = 50
                    
                    def handle_response(response, error):
                        if error or not response:
                            self._languages_loading = False
                            return
                        
                        try:
                            messages = response.messages
                            for i in range(messages.size()):
                                msg = messages.get(i)
                                if msg.id == language_msg_id:
                                    if hasattr(msg, 'message') and msg.message:
                                        langs = []
                                        for line in str(msg.message).split('\n'):
                                            if ':' in line:
                                                code, name = line.split(':', 1)
                                                langs.append({'code': code.strip(), 'display_name': name.strip()})
                                        
                                        def on_ui():
                                            self.available_languages = langs
                                            global available_languages
                                            available_languages = langs
                                            self._languages_loading = False
                                            quantahut_log(f"Loaded {len(langs)} languages from channel")
                                        run_on_ui_thread(on_ui)
                                        return
                                    break
                            self._languages_loading = False
                        except Exception as e:
                            quantahut_log(f"Error parsing languages: {e}")
                            self._languages_loading = False
                    
                    send_request(req, RequestCallback(handle_response))
                
                def resolve_channel():
                    from java import dynamic_proxy, jclass
                    Consumer = jclass("com.google.android.exoplayer2.util.Consumer")
                    
                    class ResolveCallback(dynamic_proxy(Consumer)):
                        def accept(self_cb, peer_id):
                            if peer_id and peer_id < 0:
                                run_on_ui_thread(lambda: on_channel_resolved(account.getMessagesController().getChat(-peer_id)))
                            else:
                                self._languages_loading = False
                    
                    account.getMessagesController().getUserNameResolver().resolve(CHANNEL_USERNAME, ResolveCallback())
                
                run_on_ui_thread(resolve_channel)
                
            except Exception as e:
                quantahut_log(f"Error loading languages: {e}")
                self._languages_loading = False
        
        import threading
        threading.Thread(target=fetch_languages, daemon=True).start()

    def _setup_quanta_file_hook(self):
        try:
            from java.lang import Class
            from java import jclass
            AndroidUtilitiesClass = Class.forName("org.telegram.messenger.AndroidUtilities")
            MessageObjectClass = Class.forName("org.telegram.messenger.MessageObject")
            ActivityClass = Class.forName("android.app.Activity")
            ResourcesProviderClass = Class.forName("org.telegram.ui.ActionBar.Theme$ResourcesProvider")
            open_for_view = AndroidUtilitiesClass.getDeclaredMethod(
                "openForView",
                MessageObjectClass,
                ActivityClass,
                ResourcesProviderClass,
                jclass("java.lang.Boolean").TYPE,
            )
            open_for_view.setAccessible(True)
            class OpenForViewHook:
                def __init__(hook_self):
                    hook_self._plugin_ref = weakref.ref(self)
                def before_hooked_method(hook_self, param):
                    try:
                        plugin = hook_self._plugin_ref()
                        if not plugin:
                            return
                        if len(param.args) >= 1:
                            msg = param.args[0]
                            if msg and hasattr(msg, "getDocumentName"):
                                name = msg.getDocumentName()
                                if name:
                                    name_lower = str(name).lower()
                                    if name_lower.endswith(".backup"):
                                        plugin.log(f"Detected .backup file click: {name}")
                                        plugin._show_import_bottom_sheet(msg)
                                        param.setResult(False)
                                    elif name_lower.endswith(".plugins"):
                                        plugin.log(f"Detected .plugins file click: {name}")
                                        plugin._show_import_plugins_bottom_sheet(msg)
                                        param.setResult(False)
                    except Exception as e:
                        pass
            self.hook_refs.append(self.hook_method(open_for_view, OpenForViewHook()))
        except Exception as e:
            pass

    def _show_import_bottom_sheet(self, message_object):
        def show_sheet():
            try:
                from com.exteragram.messenger.utils import ChatUtils
                from file_utils import read_file
                from com.exteragram.messenger.plugins import PluginsController
                
                changes_count = 0
                try:
                    file_path = ChatUtils.getInstance().getPathToMessage(message_object)
                    if file_path:
                        content = read_file(file_path)
                        if content:
                            backup_data = json.loads(content)
                            all_settings = backup_data.get("plugins", {})
                            controller = PluginsController.getInstance()
                            
                            for plugin_id, plugin_data in all_settings.items():
                                if controller.plugins.containsKey(plugin_id):
                                    settings = plugin_data.get("settings", {})
                                    engine = controller.getPluginEngine(plugin_id)
                                    if engine and settings:
                                        current_settings = engine.getAllPluginSettings(plugin_id)
                                        for key, value in settings.items():
                                            current_value = current_settings.get(key) if current_settings else None
                                            if current_value != value:
                                                changes_count += 1
                except Exception:
                    changes_count = 1
                
                if changes_count == 0:
                    BulletinHelper.show_error(getString("settings_same_as_current", "It looks like the settings are the same as the current ones."))
                    return
                
                subtitle = getString("changes_will_be_applied_singular", "{count} change will be applied to the current settings.").format(count=changes_count) if changes_count == 1 else getString("changes_will_be_applied_plural", "{count} changes will be applied to the current settings.").format(count=changes_count)
                
                def on_import_click():
                    self._import_from_message(message_object)
                
                BottomSheet(
                    title=getString("apply_settings_confirmation", "Are you sure you want to apply these settings?"),
                    subtitle=subtitle,
                    button_text=getString("yes_apply", "Yes, apply"),
                    button2_text=getString("no_leave_as_is", "No, leave as is"),
                    show_close_button=False,
                    raw_resource=R_tg.raw.email_check_inbox,
                    on_button_click=on_import_click,
                    on_button2_click=lambda: None
                )
                
            except Exception as e:
                pass
        
        run_on_ui_thread(show_sheet)

    def _import_from_message(self, message_object):
        try:
            from com.exteragram.messenger.utils import ChatUtils
            from file_utils import read_file
            from com.exteragram.messenger.plugins import PluginsController
            
            file_path = ChatUtils.getInstance().getPathToMessage(message_object)
            if not file_path:
                return
            
            content = read_file(file_path)
            if not content:
                return
            
            backup_data = json.loads(content)
            all_settings = backup_data.get("plugins", {})
            controller = PluginsController.getInstance()
            imported_count = 0
            
            for plugin_id, plugin_data in all_settings.items():
                if controller.plugins.containsKey(plugin_id):
                    settings = plugin_data.get("settings", {})
                    engine = controller.getPluginEngine(plugin_id)
                    
                    if engine and settings:
                        for key, value in settings.items():
                            try:
                                engine.setPluginSetting(plugin_id, key, value)
                                imported_count += 1
                            except Exception:
                                pass
                        
                        controller.loadPluginSettings(plugin_id)
            
            BulletinHelper.show_success(getString("imported_settings_from_plugins", "Imported settings from {count} plugins").format(count=len(all_settings)))
            
        except Exception as e:
            BulletinHelper.show_error(getString("failed_to_import_settings", "Failed to import settings"))

    def _export_all_settings(self, view):
        export_all_plugin_settings()
    
    def _toggle_branch_selector(self, view):
        current = self.get_setting("show_branch_selector", False)
        self.set_setting("show_branch_selector", not current, reload_settings=True)
        
        if not current:
            BulletinHelper.show_success(getString("branch_selector_enabled", "Branch selector enabled!"))
        else:
            BulletinHelper.show_info(getString("branch_selector_disabled", "Branch selector hidden"))
    
    def _export_all_plugins(self, view):
        try:
            from com.exteragram.messenger.plugins import PluginsController
            controller = PluginsController.getInstance()
            plugins_dir = controller.pluginsDir
            plugin_files = plugins_dir.listFiles()
            
            if not plugin_files or len(plugin_files) == 0:
                BulletinHelper.show_error(getString("no_plugins_to_export", "No plugins to export"))
                return
            
            plugin_ids = [str(f.getName()).replace(".py", "") for f in plugin_files if f.isFile() and str(f.getName()).endswith(".py")]
            self._export_plugins_by_ids(plugin_ids, "Plugins Backup")
        except Exception as e:
            self.log(f"Error exporting plugins: {e}")
            BulletinHelper.show_error(getString("failed_to_export_plugins", "Failed to export plugins"))
    
    def _export_plugins_by_ids(self, plugin_ids, prefix="Plugins"):
        try:
            from file_utils import get_cache_dir
            from com.exteragram.messenger.plugins import PluginsController
            from org.telegram.messenger import Utilities
            from java.io import File, FileOutputStream
            from java.util.zip import ZipOutputStream, ZipEntry
            from java.nio.file import Files
            from android.content import Intent
            from android.net import Uri
            from org.telegram.ui import LaunchActivity
            from java.text import SimpleDateFormat
            from java.util import Date
            
            controller = PluginsController.getInstance()
            cache_dir = get_cache_dir()
            random_str = Utilities.generateRandomString(4)
            formatter = SimpleDateFormat("yyyy-MM-dd_HH-mm")
            timestamp = formatter.format(Date())
            zip_filename = f"{prefix} {timestamp} {random_str}.plugins"
            zip_file_path = os.path.join(cache_dir, zip_filename)
            
            zip_file = File(zip_file_path)
            if zip_file.exists():
                zip_file.delete()
            
            fos = FileOutputStream(zip_file)
            zos = ZipOutputStream(fos)
            
            exported_count = 0
            for plugin_id in plugin_ids:
                try:
                    plugin_path = controller.getPluginPath(plugin_id)
                    if plugin_path:
                        plugin_file = File(plugin_path)
                        if plugin_file.exists():
                            entry = ZipEntry(plugin_file.getName())
                            zos.putNextEntry(entry)
                            file_bytes = Files.readAllBytes(plugin_file.toPath())
                            zos.write(file_bytes)
                            zos.closeEntry()
                            exported_count += 1
                except Exception as e:
                    self.log(f"Failed to export {plugin_id}: {e}")
            
            zos.close()
            fos.close()
            
            if exported_count == 0:
                BulletinHelper.show_error(getString("no_plugins_exported", "No plugins were exported"))
                return
            
            def open_share():
                try:
                    from org.telegram.messenger import ApplicationLoader
                    context = ApplicationLoader.applicationContext
                    file_uri = Uri.fromFile(zip_file)
                    
                    intent = Intent(context, LaunchActivity)
                    intent.setAction(Intent.ACTION_SEND)
                    intent.setType("application/octet-stream")
                    intent.putExtra(Intent.EXTRA_STREAM, file_uri)
                    intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
                    intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION)
                    
                    context.startActivity(intent)
                    BulletinHelper.show_success(getString("exported_plugins_count", "Exported {count} plugins").format(count=exported_count))
                except Exception as e:
                    self.log(f"Error sharing: {e}")
            
            run_on_ui_thread(open_share)
        except Exception as e:
            self.log(f"Error exporting plugins: {e}")
            BulletinHelper.show_error(getString("failed_to_export_plugins", "Failed to export plugins"))
    
    def _add_filter_pills(self, activity):
        try:
            if self.pills_container:
                return
            if not self.stored_context:
                return
            context = self.stored_context
            from android.widget import HorizontalScrollView
            from android.graphics.drawable import GradientDrawable
            from android.util import TypedValue
            from android_utils import OnClickListener
            scroll_view = HorizontalScrollView(context)
            scroll_view.setHorizontalScrollBarEnabled(False)
            scroll_view.setClipToPadding(False)
            pills_layout = LinearLayout(context)
            pills_layout.setOrientation(LinearLayout.HORIZONTAL)
            pills_layout.setPadding(int(AndroidUtilities.dp(12)), int(AndroidUtilities.dp(15)), int(AndroidUtilities.dp(12)), int(AndroidUtilities.dp(8)))
            filters = [
                (getString("filter_all", "All"), 0),
                (getString("filter_recently_updated", "Recently Updated"), 3),
                (getString("filter_quanta", "Quanta!"), 6),
                (getString("filter_enabled", "Enabled"), 1),
                (getString("filter_disabled", "Disabled"), 2),
                (getString("filter_has_settings", "Has Settings"), 4),
                (getString("filter_errors", "Errors"), 5)
            ]
            self.filter_pills = []
            self.filter_base_texts = {}
            for text, filter_id in filters:
                self.filter_base_texts[filter_id] = text
                pill = self._create_pill(text, filter_id, context)
                pills_layout.addView(pill)
                self.filter_pills.append((pill, filter_id))
            scroll_view.addView(pills_layout)
            self.pills_container = scroll_view
            self._update_pill_counts()
            self._update_pill_states()
        except:
            pass
    
    def _create_pill(self, text, filter_id, context):
        from android.graphics.drawable import GradientDrawable
        from android.util import TypedValue
        from android_utils import OnClickListener
        pill = TextView(context)
        pill.setText(text)
        pill.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 14)
        pill.setGravity(Gravity.CENTER)
        pill.setPadding(int(AndroidUtilities.dp(16)), int(AndroidUtilities.dp(6)), int(AndroidUtilities.dp(16)), int(AndroidUtilities.dp(6)))
        margin = int(AndroidUtilities.dp(4))
        lp = LinearLayout.LayoutParams(LinearLayout.LayoutParams.WRAP_CONTENT, LinearLayout.LayoutParams.WRAP_CONTENT)
        lp.setMargins(margin, 0, margin, 0)
        pill.setLayoutParams(lp)
        drawable = GradientDrawable()
        drawable.setCornerRadius(AndroidUtilities.dp(16))
        pill.setBackground(drawable)
        pill.setOnClickListener(self._create_pill_click_listener(filter_id))
        pill.setOnLongClickListener(self._create_pill_long_click_listener(filter_id, pill))
        
        return pill
    
    def _create_pill_click_listener(self, filter_id):
        plugin = self
        def on_click(view=None):
            try:
                plugin.current_filter = filter_id
                plugin._update_pill_states()
                plugin._refresh_plugins_list(plugin.stored_activity)
            except:
                pass
        from android_utils import OnClickListener
        return OnClickListener(on_click)
    
    def _create_pill_long_click_listener(self, filter_id, pill_view):
        plugin = self
        def on_long_click(view=None):
            try:
                perform_haptic()
                plugin._show_filter_menu(filter_id, pill_view)
                return True
            except Exception as e:
                plugin.log(f"Error in pill long click: {e}")
                return False
        from android_utils import OnLongClickListener
        return OnLongClickListener(on_long_click)
    
    def _show_filter_menu(self, filter_id, anchor_view):
        try:
            from org.telegram.ui.ActionBar import ActionBarPopupWindow, ActionBarMenuSubItem
            from org.telegram.messenger import R as R_tg
            from android_utils import OnClickListener
            from android.view import Gravity
            
            popup_layout = ActionBarPopupWindow.ActionBarPopupWindowLayout(self.stored_context, R_tg.drawable.popup_fixed_alert2, None)
            popup_window = [None]
            
            export_item = ActionBarMenuSubItem(self.stored_context, True, False, None)
            export_item.setTextAndIcon(getString("export_plugins_in_filter", "Export Plugins"), R_tg.drawable.msg_shareout)
            export_item.setOnClickListener(OnClickListener(lambda v=None: (popup_window[0].dismiss(), self._export_filter_plugins(filter_id))))
            popup_layout.addView(export_item)
            
            delete_item = ActionBarMenuSubItem(self.stored_context, False, True, None)
            delete_item.setTextAndIcon(getString("delete_plugins_in_filter", "Delete Plugins"), R_tg.drawable.msg_delete)
            delete_item.setColors(Theme.getColor(Theme.key_text_RedBold), Theme.getColor(Theme.key_text_RedRegular))
            delete_item.setOnClickListener(OnClickListener(lambda v=None: (popup_window[0].dismiss(), self._confirm_delete_filter_plugins(filter_id))))
            popup_layout.addView(delete_item)
            
            popup_window[0] = ActionBarPopupWindow(popup_layout, -2, -2)
            popup_window[0].setOutsideTouchable(True)
            popup_window[0].setClippingEnabled(True)
            popup_window[0].setAnimationStyle(R_tg.style.PopupContextAnimation)
            popup_window[0].setFocusable(True)
            
            location = [0, 0]
            anchor_view.getLocationInWindow(location)
            popup_window[0].showAtLocation(anchor_view, Gravity.LEFT | Gravity.TOP, location[0], location[1] + anchor_view.getHeight())
        except Exception as e:
            self.log(f"Error showing menu: {e}")
    
    def _export_filter_plugins(self, filter_id):
        try:
            from android_utils import run_on_ui_thread
            
            plugin_ids = self._get_plugins_in_filter(filter_id)
            if not plugin_ids:
                run_on_ui_thread(lambda: BulletinHelper.show_info(getString("no_plugins_in_filter", "No plugins in this filter")))
                return
            
            filter_name = self.filter_base_texts.get(filter_id, "")
            self._export_plugins_by_ids(plugin_ids, filter_name)
        except Exception as e:
            self.log(f"Error exporting filter plugins: {e}")
    
    def _confirm_delete_filter_plugins(self, filter_id):
        try:
            from com.exteragram.messenger.plugins import PluginsController
            from android_utils import run_on_ui_thread
            
            filter_name = self.filter_base_texts.get(filter_id, "")
            plugin_ids = self._get_plugins_in_filter(filter_id)
            
            if not plugin_ids:
                run_on_ui_thread(lambda: BulletinHelper.show_info(getString("no_plugins_in_filter", "No plugins in this filter")))
                return
            
            plugins_controller = PluginsController.getInstance()
            all_plugins = plugins_controller.plugins
            
            plugin_names = []
            plugin_id_map = {}
            
            for plugin_id in plugin_ids:
                plugin = all_plugins.get(plugin_id)
                if plugin:
                    name = str(plugin.getName())
                    plugin_names.append(name)
                    plugin_id_map[name] = plugin_id
            
            def on_delete_clicked(selected_keys):
                selected_ids = [plugin_id_map[key] for key in selected_keys if key in plugin_id_map]
                if selected_ids:
                    self._delete_filter_plugins(selected_ids)
            
            def show_selector():
                MultiSelector(
                    items=plugin_names,
                    title=getString("select_plugins_to_delete", "Select Plugins to Delete"),
                    subtitle=getString("select_plugins_subtitle", "Choose which plugins to remove from {filter}").format(filter=filter_name),
                    setting_keys=plugin_names,
                    plugin_instance=self,
                    on_action_click=on_delete_clicked,
                    action_text=getString("delete", "Delete"),
                    show_count=False,
                    show_select_all=True
                )
            
            run_on_ui_thread(show_selector)
        except Exception as e:
            self.log(f"Error showing delete selector: {e}")
    
    def _get_plugins_in_filter(self, filter_id):
        try:
            from com.exteragram.messenger.plugins import PluginsController
            plugins_controller = PluginsController.getInstance()
            all_plugins = plugins_controller.plugins
            filtered_plugins = []
            
            for key in all_plugins.keySet().toArray():
                plugin = all_plugins.get(key)
                if plugin and self._plugin_matches_filter(plugin, filter_id):
                    filtered_plugins.append(str(plugin.getId()))
            
            return filtered_plugins
        except Exception as e:
            self.log(f"Error getting plugins in filter: {e}")
            return []
    
    def _plugin_matches_filter(self, plugin, filter_id):
        try:
            from com.exteragram.messenger.plugins import PluginsController
            plugins_controller = PluginsController.getInstance()
            
            if filter_id == 0:
                return True
            elif filter_id == 1:
                return plugin.isEnabled()
            elif filter_id == 2:
                return not plugin.isEnabled()
            elif filter_id == 3:
                return self._is_recently_updated(plugin)
            elif filter_id == 4:
                return plugins_controller.hasPluginSettings(plugin.getId())
            elif filter_id == 5:
                return plugin.hasError()
            elif filter_id == 6:
                return self._is_quanta_plugin(plugin)
            return False
        except:
            return False
    
    def _delete_filter_plugins(self, plugin_ids):
        try:
            from com.exteragram.messenger.plugins import PluginsController
            from android_utils import run_on_ui_thread
            
            plugins_controller = PluginsController.getInstance()
            count = len(plugin_ids)
            
            def on_complete(error):
                def update_ui():
                    if self.stored_activity:
                        list_view = get_private_field(self.stored_activity, "listView")
                        if list_view and list_view.adapter:
                            list_view.adapter.update(True)
                    
                    if error:
                        BulletinHelper.show_error(str(error))
                    else:
                        msg = getString("deleted_plugins_count", "Deleted {count} plugins").format(count=count)
                        BulletinHelper.show_success(msg)
                
                run_on_ui_thread(update_ui)
            
            for i, plugin_id in enumerate(plugin_ids):
                is_last = (i == len(plugin_ids) - 1)
                plugins_controller.deletePlugin(plugin_id, Callback1(on_complete) if is_last else None)
        except Exception as e:
            self.log(f"Error deleting plugins: {e}")
            run_on_ui_thread(lambda: BulletinHelper.show_error(getString("failed_to_delete_plugins", "Failed to delete plugins")))
    
    def _get_plugin_counts(self):
        try:
            from com.exteragram.messenger.plugins import PluginsController
            plugins_controller = PluginsController.getInstance()
            all_plugins = plugins_controller.plugins
            counts = {0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0}
            
            for key in all_plugins.keySet().toArray():
                plugin = all_plugins.get(key)
                if plugin:
                    if self.get_plugin_type(str(plugin.getId())) == "lib":
                        continue
                    counts[0] += 1
                    if plugin.isEnabled():
                        counts[1] += 1
                    else:
                        counts[2] += 1
                    if self._is_recently_updated(plugin):
                        counts[3] += 1
                    if plugins_controller.hasPluginSettings(plugin.getId()):
                        counts[4] += 1
                    if plugin.hasError():
                        counts[5] += 1
                    if self._is_quanta_plugin(plugin):
                        counts[6] += 1
            return counts
        except:
            return {0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0}
    
    def _update_pill_counts(self):
        try:
            if not hasattr(self, 'filter_base_texts'):
                return
            
            counts = self._get_plugin_counts()
            
            for pill, filter_id in self.filter_pills:
                base_text = self.filter_base_texts.get(filter_id, "")
                count = counts.get(filter_id, 0)
                pill.setText(f"{base_text} - {count}")
        except:
            pass
    
    def _update_pill_states(self):
        try:
            from android.graphics.drawable import GradientDrawable
            from androidx.core.graphics import ColorUtils
            for pill, filter_id in self.filter_pills:
                is_selected = (filter_id == self.current_filter)
                if is_selected:
                    pill.setTextColor(Theme.getColor(Theme.key_actionBarTabActiveText))
                    drawable = pill.getBackground()
                    if isinstance(drawable, GradientDrawable):
                        base_color = Theme.getColor(Theme.key_actionBarTabLine)
                        drawable.setColor(ColorUtils.setAlphaComponent(base_color, 0x1F))
                else:
                    pill.setTextColor(Theme.getColor(Theme.key_actionBarTabUnactiveText))
                    drawable = pill.getBackground()
                    if isinstance(drawable, GradientDrawable):
                        drawable.setColor(Theme.getColor(Theme.key_windowBackgroundWhite))
                        drawable.setStroke(AndroidUtilities.dp(1), Theme.getColor(Theme.key_divider))
        except:
            pass
    
    def _refresh_plugins_list(self, activity):
        try:
            self._update_pill_counts()
            list_view = get_private_field(activity, "listView")
            if list_view and list_view.adapter:
                run_on_ui_thread(lambda: list_view.adapter.update(True))
        except:
            pass
    
    def _is_recently_updated(self, plugin):
        try:
            from com.exteragram.messenger.plugins import PluginsController
            plugins_controller = PluginsController.getInstance()
            plugin_path = plugins_controller.getPluginPath(plugin.getId())
            
            if not plugin_path:
                return False
            
            plugin_file = File(plugin_path)
            if not plugin_file.exists():
                return False
            
            last_modified = plugin_file.lastModified()
            current_time = int(time.time() * 1000)
            one_day_ms = 24 * 60 * 60 * 1000
            
            return (current_time - last_modified) <= one_day_ms
        except:
            return False
    
    def _is_quanta_plugin(self, plugin):
        try:
            author = str(plugin.getAuthor()).lower()
            return "@luvztroy" in author
        except:
            return False
    
    def _show_import_plugins_bottom_sheet(self, message_object):
        def show_sheet():
            try:
                from com.exteragram.messenger.utils import ChatUtils
                from com.exteragram.messenger.plugins import PluginsController
                
                file_path = ChatUtils.getInstance().getPathToMessage(message_object)
                if not file_path:
                    return
                
                from java.io import File
                from java.util.zip import ZipFile
                from java.util import Collections
                
                zip_file = ZipFile(File(file_path))
                entries_list = Collections.list(zip_file.entries())
                
                plugin_count = 0
                for i in range(entries_list.size()):
                    entry = entries_list.get(i)
                    if not entry.isDirectory() and str(entry.getName()).endswith(".py"):
                        plugin_count += 1
                
                zip_file.close()
                
                if plugin_count == 0:
                    BulletinHelper.show_error(getString("no_plugins_in_file", "No plugins found in file"))
                    return
                
                subtitle = getString("plugins_will_be_imported_singular", "{count} plugin will be imported.").format(count=plugin_count) if plugin_count == 1 else getString("plugins_will_be_imported_plural", "{count} plugins will be imported.").format(count=plugin_count)
                
                def on_import_click():
                    self._import_plugins_from_message(message_object)
                
                BottomSheet(
                    title=getString("import_plugins_confirmation", "Import Plugins?"),
                    subtitle=subtitle,
                    description=getString("import_plugins_description", "Existing plugins with the same name will be replaced."),
                    button_text=getString("yes_import", "Yes, import"),
                    button2_text=getString("cancel", "Cancel"),
                    show_close_button=False,
                    raw_resource=R_tg.raw.email_check_inbox,
                    on_button_click=on_import_click,
                    on_button2_click=lambda: None
                )
                
            except Exception as e:
                self.log(f"Error showing import sheet: {e}")
                BulletinHelper.show_error(getString("failed_to_read_plugins_file", "Failed to read plugins file"))
        
        run_on_ui_thread(show_sheet)
    
    def _import_plugins_from_message(self, message_object):
        loading_dialog = [None]
        loading_view = [None]
        done = [False]
        start_time = [-1]
        
        def show_loading_dialog():
            try:
                from ui.alert import AlertDialogBuilder
                from android_utils import run_on_ui_thread
                from client_utils import get_last_fragment
                from com.exteragram.messenger.speech.ui import LoadingModelView
                
                context = get_last_fragment().getParentActivity()
                loading_view[0] = LoadingModelView(context)
                
                try:
                    loading_view_class = loading_view[0].getClass()
                    
                    title_field = loading_view_class.getDeclaredField("title")
                    title_field.setAccessible(True)
                    title_view = title_field.get(loading_view[0])
                    title_view.setText(getString("importing_plugins", "Importing plugins..."))
                    
                    subtitle_field = loading_view_class.getDeclaredField("subtitle")
                    subtitle_field.setAccessible(True)
                    subtitle_view = subtitle_field.get(loading_view[0])
                    subtitle_view.setText(getString("importing_plugins_info", "Please keep this window open while plugins are importing."))
                except Exception as e:
                    quantahut_log(f"Could not change loading view text: {e}")
                
                from org.telegram.ui.ActionBar import AlertDialog
                builder = AlertDialog.Builder(context)
                builder.setView(loading_view[0])
                dialog = builder.create()
                dialog.setCanceledOnTouchOutside(False)
                dialog.setCancelable(False)
                loading_dialog[0] = dialog
                
                def delayed_show():
                    if not done[0]:
                        start_time[0] = int(time.time() * 1000)
                        dialog.show()
                
                run_on_ui_thread(delayed_show, 150)
            except Exception as e:
                quantahut_log(f"Error showing loading dialog: {e}")
        
        run_on_ui_thread(show_loading_dialog)
        
        def do_import():
            try:
                from com.exteragram.messenger.utils import ChatUtils
                from com.exteragram.messenger.plugins import PluginsController, PluginsConstants
                from java.io import File, FileOutputStream
                from java.util.zip import ZipFile
                from java.nio.file import Files
                
                file_path = ChatUtils.getInstance().getPathToMessage(message_object)
                if not file_path:
                    return
                
                controller = PluginsController.getInstance()
                plugins_dir = controller.pluginsDir
                
                from java.util import Collections
                
                zip_file = ZipFile(File(file_path))
                entries_list = Collections.list(zip_file.entries())
                total_plugins = sum(1 for i in range(entries_list.size()) if not entries_list.get(i).isDirectory() and str(entries_list.get(i).getName()).endswith(".py"))
                
                imported_count = 0
                skipped_count = 0
                processed_count = 0
                
                def update_import_progress():
                    if loading_view[0] and total_plugins > 0:
                        try:
                            progress = float(processed_count) / float(total_plugins)
                            def update_progress(prog=progress, view=loading_view[0]):
                                try:
                                    if view:
                                        view.setProgress(prog)
                                except:
                                    pass
                            run_on_ui_thread(update_progress)
                        except:
                            pass
                
                for i in range(entries_list.size()):
                    entry = entries_list.get(i)
                    if not entry.isDirectory() and str(entry.getName()).endswith(".py"):
                        try:
                            plugin_id = str(entry.getName()).replace(".plugin", "").replace(".py", "")
                            existing = controller.plugins.get(plugin_id)
         
                            if existing:
                                input_stream = zip_file.getInputStream(entry)
                                from java.io import BufferedReader, InputStreamReader
                                reader = BufferedReader(InputStreamReader(input_stream, "UTF-8"))
                                content = ""
                                line = reader.readLine()
                                while line is not None:
                                    content += line + "\n"
                                    line = reader.readLine()
                                reader.close()
                                
                                backup_ver = [line.split('=', 1)[1].strip(' "\'\n') for line in content.split('\n') if '__version__' in line and '=' in line and len(line.split('=', 1)) >= 2][:1]
                                
                                if backup_ver and existing.getVersion() >= backup_ver[0]:
                                    skipped_count += 1
                                    processed_count += 1
                                    self.log(f"Skipped {plugin_id} (same or newer version: installed={existing.getVersion()}, backup={backup_ver[0]})")
                                    update_import_progress()
                                    continue
                            
                            input_stream = zip_file.getInputStream(entry)
                            output_file = File(plugins_dir, entry.getName())
                            
                            from java.nio.file import Files as NIOFiles
                            from java.nio.file import StandardCopyOption
                            
                            NIOFiles.copy(input_stream, output_file.toPath(), StandardCopyOption.REPLACE_EXISTING)
                            input_stream.close()
                            imported_count += 1
                            self.log(f"Imported {plugin_id} successfully")
                        except Exception as e:
                            self.log(f"Error importing {entry.getName()}: {e}")
                        finally:
                            processed_count += 1
                            update_import_progress()
                
                zip_file.close()
                
                done[0] = True
                if loading_view[0]:
                    def set_complete(view=loading_view[0]):
                        try:
                            if view:
                                view.setProgress(1.0)
                        except:
                            pass
                    run_on_ui_thread(set_complete)
                
                def dismiss_dialog():
                    try:
                        dialog = loading_dialog[0]
                        start = start_time[0]
                        if dialog and hasattr(dialog, 'isShowing') and dialog.isShowing():
                            if start > 0:
                                delay = max(0, 1000 - (int(time.time() * 1000) - start))
                                def do_dismiss(d=dialog):
                                    try:
                                        d.dismiss()
                                    except:
                                        pass
                                run_on_ui_thread(do_dismiss, delay)
                            else:
                                dialog.dismiss()
                    except:
                        pass
                
                if imported_count > 0:
                    def reload_plugins():
                        try:
                            python_engine = PluginsController.engines.get(PluginsConstants.PYTHON)
                            if python_engine:
                                from android_utils import R
                                
                                def reload_callback():
                                    dismiss_dialog()
                                    msg = getString("imported_plugins_count_reloaded", "Imported {count} plugins successfully!").format(count=imported_count)
                                    if skipped_count > 0:
                                        msg += " " + getString("plugins_skipped_count", "({count} skipped)").format(count=skipped_count)
                                    run_on_ui_thread(lambda: BulletinHelper.show_success(msg))
                                
                                python_engine.loadPlugins(R(reload_callback))
                        except Exception as e:
                            self.log(f"Error reloading plugins: {e}")
                    
                    reload_plugins()
                else:
                    dismiss_dialog()
                    if skipped_count > 0:
                        run_on_ui_thread(lambda: BulletinHelper.show_info(getString("no_plugins_imported_skipped", "No plugins imported ({count} skipped - same or newer version)").format(count=skipped_count)))
                    else:
                        run_on_ui_thread(lambda: BulletinHelper.show_error(getString("no_plugins_imported", "No plugins were imported")))
                    
            except Exception as e:
                self.log(f"Error importing plugins: {e}")
                run_on_ui_thread(lambda: BulletinHelper.show_error(getString("failed_to_import_plugins", "Failed to import plugins")))
        
        run_on_queue(do_import)

    def _setup_plugin_settings_search(self):
        if not self.get_setting("enable_plugin_settings_search", True):
            return
        try:
            PluginSettingsActivity = find_class("com.exteragram.messenger.plugins.ui.PluginSettingsActivity")
            if not PluginSettingsActivity:
                return

            Context = jclass("android.content.Context")
            create_view_method = PluginSettingsActivity.getClass().getDeclaredMethod("createView", Context.getClass())
            create_view_method.setAccessible(True)
            self.settings_search_create_view_hook = self.hook_method(create_view_method, _PluginSettingsSearchCreateViewHook(self))

            ArrayList = jclass("java.util.ArrayList")
            UniversalAdapter = jclass("org.telegram.ui.Components.UniversalAdapter")
            fill_items_method = PluginSettingsActivity.getClass().getDeclaredMethod("fillItems", ArrayList, UniversalAdapter)
            fill_items_method.setAccessible(True)
            self.settings_search_fill_items_hook = self.hook_method(fill_items_method, _PluginSettingsSearchFillItemsHook(self))

        except Exception as e:
            pass

    def get_search_state(self, activity_id):
        if activity_id not in self._search_state:
            self._search_state[activity_id] = {"query": "", "active": False, "reset_hidden": False, "show_history": False}
        return self._search_state[activity_id]

    def get_search_history(self, plugin_id):
        if plugin_id not in self._search_history:
            history_str = self.get_setting(f"search_history_{plugin_id}", "")
            if history_str:
                try:
                    self._search_history[plugin_id] = json.loads(history_str)
                except:
                    self._search_history[plugin_id] = []
            else:
                self._search_history[plugin_id] = []
        return self._search_history[plugin_id]

    def add_to_history(self, plugin_id, query):
        query = query.strip()
        if not query or len(query) < 2:
            return
        
        history = self.get_search_history(plugin_id)
        if query in history:
            history.remove(query)
        history.insert(0, query)
        
        while len(history) > MAX_HISTORY:
            history.pop()
        
        self._search_history[plugin_id] = history
        self.set_setting(f"search_history_{plugin_id}", json.dumps(history))

    def _matches_query(self, item, query):
        if getattr(item, "viewType", -1) in (0, 7):
            return False

        if query in str(getattr(item, "object2", "") or "").lower():
            return True

        setting = getattr(item, "settingItem", None)
        if setting:
            for attr in ["text", "hint", "key"]:
                val = getattr(setting, attr, None)
                if val and query in str(val).lower():
                    return True

        for attr in ["text", "subtext", "textValue", "animatedText"]:
            val = getattr(item, attr, None)
            if val and query in str(val).lower():
                return True

        return False

    def _create_uitem_from_py_object(self, py_obj, plugin, parent_prefix=None):
        try:
            UItem = jclass("org.telegram.ui.Components.UItem")
            PC = jclass("com.exteragram.messenger.plugins.PluginsController")
            AppLoader = jclass("org.telegram.messenger.ApplicationLoader")
            
            TextSetting = jclass("com.exteragram.messenger.plugins.models.TextSetting")
            SwitchSetting = jclass("com.exteragram.messenger.plugins.models.SwitchSetting")
            SelectorSetting = jclass("com.exteragram.messenger.plugins.models.SelectorSetting")
            InputSetting = jclass("com.exteragram.messenger.plugins.models.InputSetting")
            HeaderSetting = jclass("com.exteragram.messenger.plugins.models.HeaderSetting")
            DividerSetting = jclass("com.exteragram.messenger.plugins.models.DividerSetting")
            EditTextSetting = jclass("com.exteragram.messenger.plugins.models.EditTextSetting")

            cls_name = py_obj.__class__.__name__
            key = getattr(py_obj, 'key', None)
            text = getattr(py_obj, 'text', None)
            
            icon = getattr(py_obj, 'icon', None)
            icon_res = 0
            if icon:
                ctx = AppLoader.applicationContext
                icon_res = ctx.getResources().getIdentifier(icon, "drawable", ctx.getPackageName())

            on_long_click = getattr(py_obj, 'on_long_click', None)
            raw_link_alias = getattr(py_obj, 'link_alias', None)
            link_alias = f"{parent_prefix}:{raw_link_alias}" if parent_prefix and raw_link_alias else raw_link_alias

            item = None
            setting = None

            if cls_name == 'Header':
                if text:
                    setting = HeaderSetting(text)
                    item = UItem.asHeader(text)

            elif cls_name == 'Switch':
                if key and text:
                    default = getattr(py_obj, 'default', False) or False
                    subtext = getattr(py_obj, 'subtext', None)
                    on_change = getattr(py_obj, 'on_change', None)
                    
                    setting = SwitchSetting(key, text, default, subtext, icon, on_change, on_long_click, link_alias)
                    
                    val = PC.getInstance().getPluginSettingBoolean(plugin.getId(), key, default)
                    if subtext:
                        item = UItem.asButtonCheck(0, text, subtext, icon_res) if icon_res else UItem.asButtonCheck(0, text, subtext)
                    else:
                        item = UItem.asCheck(0, text, icon_res)
                    
                    if item:
                        item.setChecked(val)

            elif cls_name == 'EditText':
                if key:
                    hint = getattr(py_obj, 'hint', "")
                    default = getattr(py_obj, 'default', "")
                    multiline = getattr(py_obj, 'multiline', False)
                    max_len = int(getattr(py_obj, 'max_length', 0) or 0)
                    mask = getattr(py_obj, 'mask', None)
                    on_change = getattr(py_obj, 'on_change', None)
                    
                    setting = EditTextSetting(key, hint, default, multiline, max_len, mask, on_change)
                    val = PC.getInstance().getPluginSettingString(plugin.getId(), key, default)

                    try:
                        EditTextCell = jclass("org.telegram.ui.Cells.EditTextCell")
                        Theme = jclass("org.telegram.ui.ActionBar.Theme")
                        TextWatcher = jclass("android.text.TextWatcher")
                        
                        cell = EditTextCell(AppLoader.applicationContext, hint, multiline, False, max_len, None)
                        cell.setBackgroundColor(Theme.getColor(Theme.key_windowBackgroundWhite))
                        cell.setText(val)
                        
                        class TextWatcherImpl(dynamic_proxy(TextWatcher)):
                            def __init__(self, cb, k, pid):
                                super().__init__()
                                self.cb = cb
                                self.key = k
                                self.pid = pid
                                self.old = ""
                                self.updating = False

                            def beforeTextChanged(self, s, start, count, after):
                                if self.updating: return
                                self.old = str(s)

                            def onTextChanged(self, s, start, before, count): pass

                            def afterTextChanged(self, s):
                                if self.updating: return
                                new_txt = str(s)
                                if new_txt == self.old: return
                                
                                PC.getInstance().setPluginSetting(self.pid, self.key, new_txt)
                                if self.cb:
                                    try: self.cb(new_txt)
                                    except: pass

                        watcher = TextWatcherImpl(on_change, key, plugin.getId())
                        cell.editText.addTextChangedListener(watcher)
                        item = UItem.asCustom(cell)
                            
                    except:
                        pass

            elif cls_name == 'Input':
                if key and text:
                    default = getattr(py_obj, 'default', "")
                    subtext = getattr(py_obj, 'subtext', None)
                    on_change = getattr(py_obj, 'on_change', None)
                    
                    setting = InputSetting(key, text, default, subtext, icon, on_change, on_long_click, link_alias)
                    val = PC.getInstance().getPluginSettingString(plugin.getId(), key, default)
                    
                    item = UItem.asButton(0, text, val)
                    if icon_res and item: item.iconResId = icon_res

            elif cls_name == 'Selector':
                if key and text:
                    items = getattr(py_obj, 'items', None)
                    if items:
                        default = getattr(py_obj, 'default', 0)
                        on_change = getattr(py_obj, 'on_change', None)
                        items_list = list(items)
                        
                        setting = SelectorSetting(key, text, default, items_list, icon, on_change, on_long_click, link_alias)
                        val = PC.getInstance().getPluginSettingInt(plugin.getId(), key, default)
                        
                        if val < 0 or val >= len(items): val = 0
                        item = UItem.asButton(0, text, items[val])
                        if icon_res and item: item.iconResId = icon_res

            elif cls_name == 'Text':
                if text:
                    accent = getattr(py_obj, 'accent', False) or False
                    red = getattr(py_obj, 'red', False) or False
                    on_click = getattr(py_obj, 'on_click', None)
                    create_sub = getattr(py_obj, 'create_sub_fragment', None)
                    
                    setting = TextSetting(text, icon, accent, red, on_click, create_sub, on_long_click, link_alias)
                    item = UItem.asButton(0, text)
                    if icon_res and item: item.iconResId = icon_res
                    if item:
                        if accent: item = item.accent()
                        if red: item = item.red()

            elif cls_name == 'Divider':
                txt = getattr(py_obj, 'text', "") or ""
                setting = DividerSetting(txt)
                item = UItem.asShadow(txt)

            if item and setting:
                item.settingItem = setting
                if key: item.object2 = key

            return item

        except Exception as e:
            return None

    def _collect_all_items(self, activity, plugin, items):
        all_items = []
        
        try:
            for i in range(items.size()):
                item = items.get(i)
                if item:
                    all_items.append(item)

            PC = jclass("com.exteragram.messenger.plugins.PluginsController")
            main_settings = PC.getInstance().getPluginSettingsList(plugin.getId())

            if main_settings:
                for idx in range(main_settings.size()):
                    setting = main_settings.get(idx)
                    if setting is None:
                        continue

                    if hasattr(setting, 'createSubFragmentCallback') and setting.createSubFragmentCallback:
                        parent_link_alias = getattr(setting, 'linkAlias', None)
                        sub_items = self._collect_sub_items(setting.createSubFragmentCallback, plugin, parent_link_alias)
                        all_items.extend(sub_items)

        except Exception as e:
            pass

        return all_items

    def _collect_sub_items(self, callback, plugin, parent_prefix=None):
        sub_items = []

        try:
            py_result = callback()
            if not py_result:
                return sub_items

            for py_item in py_result:
                if py_item is None:
                    continue

                try:
                    item = self._create_uitem_from_py_object(py_item, plugin, parent_prefix)
                    if item:
                        sub_items.append(item)

                    if hasattr(py_item, 'create_sub_fragment') and py_item.create_sub_fragment:
                        item_link_alias = getattr(py_item, 'link_alias', None)
                        nested_prefix = f"{parent_prefix}:{item_link_alias}" if parent_prefix and item_link_alias else (item_link_alias or parent_prefix)
                        nested_items = self._collect_sub_items(py_item.create_sub_fragment, plugin, nested_prefix)
                        sub_items.extend(nested_items)

                except Exception as e:
                    pass

        except Exception as e:
            pass

        return sub_items

class CustomBadgeHook:
    def __init__(self, plugin):
        self._plugin_ref = weakref.ref(plugin)
        
    def after_hooked_method(self, param):
        try:
            plugin = self._plugin_ref()
            if not plugin:
                return param.getResult()
            tl_object = param.args[0]
            
            if plugin.TLRPC_Chat and isinstance(tl_object, plugin.TLRPC_Chat) and tl_object.id in plugin.custom_badges:
                custom_badge = plugin.custom_badges[tl_object.id]
                param.setResult(custom_badge)
                return custom_badge
            
            return param.getResult()
        except:
            return param.getResult()


class CustomDeveloperHook:
    def __init__(self, plugin):
        self._plugin_ref = weakref.ref(plugin)
        
    def after_hooked_method(self, param):
        return param.getResult()


class CustomExteraHook:
    def __init__(self, plugin):
        self._plugin_ref = weakref.ref(plugin)
        
    def after_hooked_method(self, param):
        try:
            plugin = self._plugin_ref()
            if not plugin:
                return param.getResult()
            if param.getResult():
                return True
            
            chat = param.args[0]
            if chat and hasattr(chat, 'id') and chat.id in plugin.custom_badges:
                param.setResult(True)
                return True
            
            return param.getResult()
        except:
            return param.getResult()


class QuantaDeeplinkHook:
    def __init__(self, plugin):
        self._plugin_ref = weakref.ref(plugin)

    def before_hooked_method(self, param):
        try:
            if len(param.args) < 7:
                return
            intent = param.args[0]
            if not intent or intent.getAction() != "android.intent.action.VIEW":
                return
            data = intent.getData()
            if not data:
                return
            url = str(data)
            if url == "tg://ui/update":
                run_on_ui_thread(check_quanta_updates)
                param.setResult(None)
            elif url == "tg://restart":
                run_on_ui_thread(self._restart_app_direct)
                param.setResult(None)
            elif url == "tg://refresh":
                run_on_ui_thread(self._refresh_badges_direct)
                param.setResult(None)
        except Exception as e:
            plugin = self._plugin_ref()
            if plugin:
                plugin.log(f"Error in deeplink hook: {e}")

    def _restart_app_direct(self):
        restart_app()

    def _refresh_badges_direct(self):
        plugin_ref = self._plugin_ref
        def refresh_callback():
            try:
                plugin = plugin_ref()
                if not plugin:
                    return
                plugin.log("Force refreshing badges via tg://refresh")
                plugin.custom_badges.clear()
                badges_data = plugin._load_badges_from_config(force_refresh=True)
                if badges_data:
                    plugin._process_badges_from_data(badges_data)
                    plugin.log(f"Refreshed {len(plugin.custom_badges)} badges")
                    current_fragment = get_last_fragment()
                    BulletinHelper.show_success(getString("refreshed_badges", "Refreshed {count} badges from QuantaConfig").format(count=len(plugin.custom_badges)), current_fragment)
                else:
                    plugin.log("No badges data received")
            except Exception as e:
                plugin = plugin_ref()
                if plugin:
                    plugin.log(f"Error refreshing badges: {e}")
        
        import threading
        thread = threading.Thread(target=refresh_callback)
        thread.daemon = True
        thread.start()
    





class JsonCacheFile:
    cache_dir_name = os.path.join(os.path.dirname(os.path.realpath(__file__)), "cache")

    def __init__(self, filename: str, default: Any, read_on_init = True):
        self.filename = filename
        self.path = os.path.join(JsonCacheFile.cache_dir_name, filename)
        self.content = copy.copy(default)
        self.default = copy.copy(default)

        os.makedirs(JsonCacheFile.cache_dir_name, exist_ok=True)

        if read_on_init:
            self.read()

    def read(self) -> Any:
        try:
            with open(self.path) as file:
                self.content = json.load(file)
        except (json.JSONDecodeError, FileNotFoundError):
            self.wipe()
            return self.default
        else:
            return self.content

    def write(self):
        try:
            with open(self.path, "w") as file:
                json.dump(self.content, file)
        except PermissionError:
            quantahut_log("Permission error writing cache")
        except Exception as e:
            quantahut_log(f"Error writing cache: {str(e)}")

    def wipe(self):
        old_size = len(self.content)
        self.content = copy.copy(self.default)
        self.write()


class Callback1(dynamic_proxy(Utilities.Callback)):
    def __init__(self, fn: Callable[[Any], None]):
        super().__init__()
        self._fn = fn

    def run(self, arg):
        try:
            self._fn(arg)
        except Exception as e:
            quantahut_log(f"Callback error: {str(e)}")


class LocalizationDatabase:
    def __init__(self):
        import sqlite3
        
        cache_dir = os.path.join(os.path.dirname(os.path.realpath(__file__)), "cache")
        os.makedirs(cache_dir, exist_ok=True)
        
        self.db_path = os.path.join(cache_dir, "quantahut_localization.db")
        self.conn = sqlite3.connect(self.db_path, check_same_thread=False)
        self.conn.row_factory = sqlite3.Row
        self._create_tables()
        self._lock = threading.Lock()
    
    def _create_tables(self):
        cursor = self.conn.cursor()
        
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS localization (
                cache_key TEXT PRIMARY KEY,
                value TEXT,
                plugin_id TEXT,
                language TEXT,
                key TEXT,
                timestamp REAL
            )
        ''')
        
        cursor.execute('''
            CREATE INDEX IF NOT EXISTS idx_plugin_lang 
            ON localization(plugin_id, language)
        ''')
        
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS emoji_cache (
                emoji_name TEXT PRIMARY KEY,
                emoji_id TEXT
            )
        ''')
        
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS user_cache (
                username TEXT PRIMARY KEY,
                user_id TEXT
            )
        ''')
        
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS text_template_cache (
                template_name TEXT PRIMARY KEY,
                template_content TEXT
            )
        ''')
        
        self.conn.commit()
    
    def get_localized_string(self, cache_key: str) -> Optional[str]:
        try:
            with self._lock:
                cursor = self.conn.cursor()
                cursor.execute('SELECT value FROM localization WHERE cache_key = ?', (cache_key,))
                row = cursor.fetchone()
                return row['value'] if row else None
        except Exception as e:
            log(f"[QuantaHut] Error getting localized string: {e}")
            return None
    
    def set_localized_string(self, cache_key: str, value: str, plugin_id: str, language: str, key: str):
        try:
            with self._lock:
                cursor = self.conn.cursor()
                cursor.execute('''
                    INSERT OR REPLACE INTO localization 
                    (cache_key, value, plugin_id, language, key, timestamp)
                    VALUES (?, ?, ?, ?, ?, ?)
                ''', (cache_key, value, plugin_id, language, key, time.time()))
                self.conn.commit()
        except Exception as e:
            log(f"[QuantaHut] Error setting localized string: {e}")
    
    def clear_language_data(self, plugin_id: str, language: str):
        try:
            with self._lock:
                cursor = self.conn.cursor()
                cursor.execute('''
                    DELETE FROM localization 
                    WHERE plugin_id = ? AND language = ?
                ''', (plugin_id, language))
                self.conn.commit()
        except Exception as e:
            log(f"[QuantaHut] Error clearing language data: {e}")
    
    def get_emoji_id(self, emoji_name: str) -> Optional[str]:
        try:
            with self._lock:
                cursor = self.conn.cursor()
                cursor.execute('SELECT emoji_id FROM emoji_cache WHERE emoji_name = ?', (emoji_name,))
                row = cursor.fetchone()
                return row['emoji_id'] if row else None
        except Exception as e:
            log(f"[QuantaHut] Error getting emoji ID: {e}")
            return None
    
    def set_emoji_id(self, emoji_name: str, emoji_id: str):
        try:
            with self._lock:
                cursor = self.conn.cursor()
                cursor.execute('''
                    INSERT OR REPLACE INTO emoji_cache (emoji_name, emoji_id)
                    VALUES (?, ?)
                ''', (emoji_name, emoji_id))
                self.conn.commit()
        except Exception as e:
            log(f"[QuantaHut] Error setting emoji ID: {e}")
    
    def get_user_id(self, username: str) -> Optional[str]:
        try:
            with self._lock:
                cursor = self.conn.cursor()
                cursor.execute('SELECT user_id FROM user_cache WHERE username = ?', (username,))
                row = cursor.fetchone()
                return row['user_id'] if row else None
        except Exception as e:
            log(f"[QuantaHut] Error getting user ID: {e}")
            return None
    
    def set_user_id(self, username: str, user_id: str):
        try:
            with self._lock:
                cursor = self.conn.cursor()
                cursor.execute('''
                    INSERT OR REPLACE INTO user_cache (username, user_id)
                    VALUES (?, ?)
                ''', (username, user_id))
                self.conn.commit()
        except Exception as e:
            log(f"[QuantaHut] Error setting user ID: {e}")
    
    def get_text_template(self, template_name: str) -> Optional[str]:
        try:
            with self._lock:
                cursor = self.conn.cursor()
                cursor.execute('SELECT template_content FROM text_template_cache WHERE template_name = ?', (template_name,))
                row = cursor.fetchone()
                return row['template_content'] if row else None
        except Exception as e:
            log(f"[QuantaHut] Error getting text template: {e}")
            return None
    
    def set_text_template(self, template_name: str, template_content: str):
        try:
            with self._lock:
                cursor = self.conn.cursor()
                cursor.execute('''
                    INSERT OR REPLACE INTO text_template_cache (template_name, template_content)
                    VALUES (?, ?)
                ''', (template_name, template_content))
                self.conn.commit()
        except Exception as e:
            log(f"[QuantaHut] Error setting text template: {e}")
    
    def get_database_stats(self):
        try:
            with self._lock:
                cursor = self.conn.cursor()
                
                cursor.execute('SELECT COUNT(*) as count FROM localization')
                loc_count = cursor.fetchone()['count']
                
                cursor.execute('SELECT COUNT(*) as count FROM emoji_cache')
                emoji_count = cursor.fetchone()['count']
                
                cursor.execute('SELECT COUNT(*) as count FROM user_cache')
                user_count = cursor.fetchone()['count']
                
                cursor.execute('SELECT COUNT(*) as count FROM text_template_cache')
                template_count = cursor.fetchone()['count']
                
                cursor.execute('SELECT DISTINCT plugin_id, language FROM localization')
                plugins = cursor.fetchall()
                
                return {
                    'localization_count': loc_count,
                    'emoji_count': emoji_count,
                    'user_count': user_count,
                    'template_count': template_count,
                    'plugins': [(p['plugin_id'], p['language']) for p in plugins]
                }
        except Exception as e:
            log(f"[QuantaHut] Error getting database stats: {e}")
            return None
    
    def get_all_strings_for_language(self, plugin_id: str, language: str):
        try:
            with self._lock:
                cursor = self.conn.cursor()
                cursor.execute('''
                    SELECT key, value FROM localization 
                    WHERE plugin_id = ? AND language = ?
                    ORDER BY key
                ''', (plugin_id, language))
                return {row['key']: row['value'] for row in cursor.fetchall()}
        except Exception as e:
            log(f"[QuantaHut] Error getting strings: {e}")
            return {}
    
    def close(self):
        try:
            if self.conn:
                self.conn.close()
        except Exception as e:
            log(f"[QuantaHut] Error closing database: {e}")


class GitHubLocalization:
    def __init__(self):
        self.db = LocalizationDatabase()
        self.localization_cache = None
        self._migrate_from_json()
    
    def _migrate_from_json(self):
        try:
            cache_dir = os.path.join(os.path.dirname(os.path.realpath(__file__)), "cache")
            json_files = [
                ("quantahut_localization_cache", "localization"),
                ("quantahut_emoji_cache", "emoji"),
                ("quantahut_user_cache", "user"),
                ("quantahut_text_template_cache", "template")
            ]
            
            for json_filename, data_type in json_files:
                json_path = os.path.join(cache_dir, json_filename)
                migrated_path = f"{json_path}.migrated"
                if os.path.exists(migrated_path):
                    continue
                
                if not os.path.exists(json_path):
                    continue
                
                try:
                    with open(json_path, 'r') as f:
                        json_data = json.load(f)
                    
                    if not json_data:
                        os.rename(json_path, migrated_path)
                        continue
                    
                    if data_type == "localization":
                        migrated_count = 0
                        for key, value in json_data.items():
                            if key.endswith('_timestamp'):
                                continue
                            
                            parts = key.split('_', 2)
                            if len(parts) >= 3:
                                plugin_id, language, string_key = parts[0], parts[1], parts[2]
                                cache_key = f"{plugin_id}_{language}_{string_key}"
                                self.db.set_localized_string(cache_key, value, plugin_id, language, string_key)
                                migrated_count += 1
                        
                        if migrated_count > 0:
                            pass
                    
                    elif data_type == "emoji":
                        for emoji_name, emoji_id in json_data.items():
                            self.db.set_emoji_id(emoji_name, emoji_id)
                    
                    elif data_type == "user":
                        for username, user_id in json_data.items():
                            self.db.set_user_id(username, user_id)
                    
                    elif data_type == "template":
                        for template_name, template_content in json_data.items():
                            self.db.set_text_template(template_name, template_content)
                    
                    os.rename(json_path, migrated_path)
                    
                except Exception as e:
                    pass
        
        except Exception as e:
            pass
    
    def _get_base_url(self):
        try:
            branch_index = setting_getter("localization_branch", DEFAULT_BRANCH) if setting_getter else DEFAULT_BRANCH
            branch = "main" if branch_index == 0 else "Beta"
            return f"https://raw.githubusercontent.com/luvztroy/UiTweaks/refs/heads/{branch}"
        except:
            return "https://raw.githubusercontent.com/luvztroy/UiTweaks/refs/heads/main"


    def get_localized_string(self, plugin_id: str, key: str, default: str = None) -> str:
        try:
            try:
                if plugin_id == "UiTweaks":
                    from base_plugin import PluginsController
                    from hook_utils import get_private_field
                    prefs = get_private_field(PluginsController.getInstance(), "preferences")
                    pref_lang = prefs.getString("plugin_setting_ui_tweaks_selected_language", None)
                else:
                    pref_lang = None
            except Exception:
                pref_lang = None
            if pref_lang:
                current_language = pref_lang
            else:
                from org.telegram.messenger import LocaleController
                current_language = LocaleController.getInstance().getCurrentLocaleInfo().getLangCode()
        except:
            current_language = "en"
        cache_key = f"{plugin_id}_{current_language}_{key}"
        
        cached_value = self.db.get_localized_string(cache_key)
        if cached_value is not None:
            return cached_value
        
        return default or key
        
    def download_localization(self, plugin_id: str, language: str = "en", force_refresh: bool = False):
        try:
            import urllib.request
            import json
            base_url = self._get_base_url()
            with urllib.request.urlopen(f"{base_url}/{plugin_id}%20{language}.json") as response:
                data = json.loads(response.read().decode('utf-8'))
                
                if not data:
                    return "no_data"
                
                quantahut_log(f"Downloaded {len(data)} localization keys for {plugin_id} ({language})")
                self.db.clear_language_data(plugin_id, language)
                for trans_key, trans_value in data.items():
                    cache_key = f"{plugin_id}_{language}_{trans_key}"
                    self.db.set_localized_string(cache_key, trans_value, plugin_id, language, trans_key)
                
                quantahut_log(f"Cached {len(data)} strings for {plugin_id} ({language})")
                return "updated"
                
        except Exception as e:
            quantahut_log(f"Error downloading localization: {str(e)}")
            raise

    def get_emoji_id(self, emoji_name: str) -> str:
        return self.db.get_emoji_id(emoji_name)

    def cache_emoji_id(self, emoji_name: str, emoji_id: str):
        self.db.set_emoji_id(emoji_name, emoji_id)

    def get_user_id(self, username: str) -> str:
        return self.db.get_user_id(username)

    def cache_user_id(self, username: str, user_id: str):
        self.db.set_user_id(username, user_id)

    def getString_template(self, template_name: str) -> str:
        return self.db.get_text_template(template_name)

    def cache_text_template(self, template_name: str, template_content: str):
        self.db.set_text_template(template_name, template_content)

github_localization = GitHubLocalization()

def get_localized_string(plugin_id: str, key: str, default: str = None) -> str:
    return github_localization.get_localized_string(plugin_id, key, default)

def download_localization(plugin_id: str, language: str = "en", force_refresh: bool = False):
    github_localization.download_localization(plugin_id, language, force_refresh)

def show_database_info():
    stats = github_localization.db.get_database_stats()
    if stats:
        info_lines = [
            f"=== SQLite Database Info ===",
            f"Localization strings: {stats['localization_count']}",
            f"Emoji cache: {stats['emoji_count']}",
            f"User cache: {stats['user_count']}",
            f"Text templates: {stats['template_count']}",
            f"",
            f"Available plugins/languages:"
        ]
        for plugin_id, lang in stats['plugins']:
            strings = github_localization.db.get_all_strings_for_language(plugin_id, lang)
            info_lines.append(f"  - {plugin_id} ({lang}): {len(strings)} strings")
            if len(strings) <= 5:
                for key, value in list(strings.items())[:5]:
                    info_lines.append(f"      {key}: {value[:50]}...")
        
        message = "\n".join(info_lines)
        log(f"[QuantaHut] {message}")
        
        try:
            from ui.bulletin import BulletinHelper
            BulletinHelper.show_info("Check logs for database info")
        except:
            pass
        
        return message
    else:
        log("[QuantaHut] Failed to get database stats")
        return "Error getting database info"


def restart_app(fragment=None):
    try:
        from android.os import Process
        from android.content import Intent
        if fragment is None:
            fragment = get_last_fragment()
        if not fragment:
            return
        context = fragment.getContext()
        intent = context.getPackageManager().getLaunchIntentForPackage(context.getPackageName())
        intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_CLEAR_TASK)
        context.startActivity(intent)
        Process.killProcess(Process.myPid())
    except Exception as e:
        quantahut_log(f"Error restarting app: {e}")

def show_restart_bulletin(message=None, button_text=None):
    try:
        from org.telegram.messenger import R as R_tg
        from ui.bulletin import BulletinHelper
        
        fragment = get_last_fragment()
        if not fragment:
                            return

        def _on_restart():
            restart_app(fragment)
        
        default_message = getString("restart_to_apply_changes", "Restart app to apply changes")
        default_button = getString("restart", "Restart")
        
        BulletinHelper.show_with_button(
            message or default_message,
            R_tg.raw.chats_infotip,
            button_text or default_button,
            _on_restart,
            fragment,
            10000
        )
        
    except Exception as e:
        pass

def check_quanta_updates():
    def check_callback():
        try:
            import time
            from base_plugin import PluginsController
            
            controller = PluginsController.getInstance()
            engine = controller.getPluginEngine("ui_tweaks")
            
            if engine and hasattr(engine, 'pluginInstances'):
                py_instance = engine.pluginInstances.get("ui_tweaks")
                if py_instance:
                    py_instance._check_for_updates(show_on_load=True)
                    time.sleep(2)
                    if not (hasattr(py_instance, 'update_available') and py_instance.update_available):
                        run_on_ui_thread(lambda: BulletinHelper.show_success(getString("already_uptodate", "Already up to date")))
                else:
                    run_on_ui_thread(lambda: BulletinHelper.show_error(getString("uitweaks_not_found", "UiTweaks not found")))
            else:
                run_on_ui_thread(lambda: BulletinHelper.show_error(getString("uitweaks_not_found", "UiTweaks not found")))
                        
        except Exception as e:
            quantahut_log(f"Error in quanta_update: {e}")
    
    import threading
    thread = threading.Thread(target=check_callback)
    thread.daemon = True
    thread.start()

def export_plugin_settings(plugin_id, plugin_name="Plugin", version="1.0.0"):
    try:
        from file_utils import get_cache_dir
        from com.exteragram.messenger.plugins import PluginsController
        from org.telegram.messenger import Utilities, ApplicationLoader
        from java.io import File, FileOutputStream, OutputStreamWriter
        from java.nio.charset import StandardCharsets
        from android.content import Intent
        from android.net import Uri
        from org.telegram.ui import LaunchActivity
        from java.text import SimpleDateFormat
        from java.util import Date
        
        controller = PluginsController.getInstance()
        all_settings = {}
        
        if controller.plugins.containsKey(plugin_id):
            plugin = controller.plugins.get(plugin_id)
            engine = controller.getPluginEngine(plugin_id)
            if engine:
                settings = engine.getAllPluginSettings(plugin_id)
                if settings and not settings.isEmpty():
                    plugin_settings = {}
                    setting_keys = settings.keySet().toArray()
                    for key in setting_keys:
                        value = settings.get(key)
                        if value is not None:
                            plugin_settings[str(key)] = _convert_to_serializable(value)
                    
                    if plugin_settings:
                        all_settings[plugin_id] = {
                            "name": plugin.getName(),
                            "version": plugin.getVersion(),
                            "enabled": plugin.isEnabled(),
                            "settings": plugin_settings
                        }
        
        if not all_settings:
            return
        
        formatter = SimpleDateFormat("yyyy-MM-dd HH:mm:ss")
        backup_data = {
            "plugin": plugin_name,
            "version": version,
            "exported_at": formatter.format(Date()),
            "settings": all_settings.get(plugin_id, {}).get("settings", {})
        }
        
        cache_dir = get_cache_dir()
        random_str = Utilities.generateRandomString(4)
        backup_filename = f"backup-{random_str}.quanta"
        backup_file_path = os.path.join(cache_dir, backup_filename)
        
        backup_file = File(backup_file_path)
        if backup_file.exists():
            backup_file.delete()
        
        stream = FileOutputStream(backup_file)
        writer = OutputStreamWriter(stream, StandardCharsets.UTF_8)
        writer.write(json.dumps(backup_data, indent=2))
        writer.flush()
        writer.close()
        
        def open_telegram_share():
            try:
                context = ApplicationLoader.applicationContext
                file_uri = Uri.fromFile(backup_file)
                
                intent = Intent(context, LaunchActivity)
                intent.setAction(Intent.ACTION_SEND)
                intent.setType("application/octet-stream")
                intent.putExtra(Intent.EXTRA_STREAM, file_uri)
                intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
                intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION)
                
                context.startActivity(intent)
            except Exception:
                pass
        
        run_on_ui_thread(open_telegram_share)
        
    except Exception as e:
        quantahut_log(f"Error exporting plugin settings: {e}")

def _has_sensitive_keys(all_settings):
    sensitive_keywords = ['api', 'key', 'token', 'secret', 'password', 'auth', 'credential']
    for plugin_settings in all_settings.values():
        for key in plugin_settings.get("settings", {}).keys():
            if any(kw in str(key).lower() for kw in sensitive_keywords):
                return True
    return False

def export_all_plugin_settings(include_sensitive=None):
    try:
        from file_utils import get_cache_dir
        from com.exteragram.messenger.plugins import PluginsController
        from org.telegram.messenger import Utilities, ApplicationLoader
        from java.io import File, FileOutputStream, OutputStreamWriter
        from java.nio.charset import StandardCharsets
        from android.content import Intent
        from android.net import Uri
        from org.telegram.ui import LaunchActivity
        from java.text import SimpleDateFormat
        from java.util import Date
        
        controller = PluginsController.getInstance()
        all_settings = {}
        exported_count = 0
        
        plugin_ids = controller.plugins.keySet().toArray()
        for plugin_id in plugin_ids:
            plugin = controller.plugins.get(plugin_id)
            engine = controller.getPluginEngine(plugin_id)
            if engine:
                settings = engine.getAllPluginSettings(plugin_id)
                if settings and not settings.isEmpty():
                    plugin_settings = {}
                    setting_keys = settings.keySet().toArray()
                    sensitive_keywords = ['api', 'key', 'token', 'secret', 'password', 'auth', 'credential']
                    for key in setting_keys:
                        value = settings.get(key)
                        if value is not None:
                            if include_sensitive == False and any(kw in str(key).lower() for kw in sensitive_keywords):
                                continue
                            plugin_settings[str(key)] = _convert_to_serializable(value)
                    
                    if plugin_settings:
                        all_settings[str(plugin_id)] = {
                            "name": plugin.getName(),
                            "version": plugin.getVersion(),
                            "enabled": plugin.isEnabled(),
                            "settings": plugin_settings
                        }
                        exported_count += 1
        
        if include_sensitive is None and _has_sensitive_keys(all_settings):
            from org.telegram.ui.ActionBar import AlertDialog
            from org.telegram.ui.Cells import CheckBoxCell
            fragment = get_last_fragment()
            if fragment:
                context = fragment.getParentActivity()
                builder = AlertDialog.Builder(context)
                builder.setTitle(getString("export_warning_title", "Export Settings"))
                builder.setMessage(getString("export_warning_message", "Some plugins contain sensitive data.Would you like to Include them?"))
                
                checkbox_cell = CheckBoxCell(context, 1)
                checkbox_cell.setBackgroundDrawable(Theme.getSelectorDrawable(False))
                checkbox_cell.setText(getString("include_api_keys", "Include sensitive data"), "", False, False)
                
                OnClickInterface = find_class("android.view.View$OnClickListener")
                OnClick = dynamic_proxy(OnClickInterface)
                class CheckBoxClick(OnClick):
                    def onClick(self, v):
                        checkbox_cell.setChecked(not checkbox_cell.isChecked(), True)
                checkbox_cell.setOnClickListener(CheckBoxClick())
                
                frame = FrameLayout(context)
                frame.addView(checkbox_cell, LayoutHelper.createFrame(-1, 48, Gravity.BOTTOM | Gravity.LEFT, 0, 0, 0, 0))
                builder.setView(frame)
                
                OnButtonClickInterface = find_class("org.telegram.ui.ActionBar.AlertDialog$OnButtonClickListener")
                OnButtonClick = dynamic_proxy(OnButtonClickInterface)
                class ExportClick(OnButtonClick):
                    def onClick(self, dialog, which):
                        export_all_plugin_settings(include_sensitive=checkbox_cell.isChecked())
                
                builder.setPositiveButton(getString("export", "Export"), ExportClick())
                builder.setNegativeButton(getString("cancel", "Cancel"), None)
                run_on_ui_thread(lambda: builder.show())
            return
        
        formatter = SimpleDateFormat("yyyy-MM-dd HH:mm:ss")
        backup_data = {
            "exported_at": formatter.format(Date()),
            "plugin_count": exported_count,
            "plugins": all_settings
        }
        
        cache_dir = get_cache_dir()
        random_str = Utilities.generateRandomString(4)
        backup_filename = f"Plugin Settings-{random_str}.backup"
        backup_file_path = os.path.join(cache_dir, backup_filename)
        
        backup_file = File(backup_file_path)
        if backup_file.exists():
            backup_file.delete()
        
        stream = FileOutputStream(backup_file)
        writer = OutputStreamWriter(stream, StandardCharsets.UTF_8)
        writer.write(json.dumps(backup_data, indent=2))
        writer.flush()
        writer.close()
        
        def open_telegram_share():
            try:
                context = ApplicationLoader.applicationContext
                file_uri = Uri.fromFile(backup_file)
                
                intent = Intent(context, LaunchActivity)
                intent.setAction(Intent.ACTION_SEND)
                intent.setType("application/octet-stream")
                intent.putExtra(Intent.EXTRA_STREAM, file_uri)
                intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
                intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION)
                
                context.startActivity(intent)
            except Exception:
                pass
        
        run_on_ui_thread(open_telegram_share)
        
    except Exception as e:
        quantahut_log(f"Error exporting all plugin settings: {e}")

def _convert_to_serializable(value):
    if value is None:
        return None
    
    value_type = type(value).__name__
    
    if value_type in ['bool', 'int', 'float', 'str']:
        return value
    elif value_type == 'Boolean':
        return bool(value)
    elif value_type in ['Integer', 'Long']:
        return int(value)
    elif value_type == 'Float':
        return float(value)
    elif value_type == 'String':
        return str(value)
    else:
        try:
            return str(value)
        except:
            return None

def perform_haptic(host=None):
    try:
        from android.view import HapticFeedbackConstants
        root = None
        if host:
            get_pa = getattr(host, 'getParentActivity', None)
            if callable(get_pa):
                act = get_pa()
                if act:
                    root = act.getWindow().getDecorView()
            if root is None and hasattr(host, 'getWindow'):
                root = host.getWindow().getDecorView()
        if root is None:
            cf = get_last_fragment()
            if cf:
                act = cf.getParentActivity()
                if act:
                    root = act.getWindow().getDecorView()
        if root:
            flags = HapticFeedbackConstants.FLAG_IGNORE_VIEW_SETTING | HapticFeedbackConstants.FLAG_IGNORE_GLOBAL_SETTING
            root.performHapticFeedback(HapticFeedbackConstants.KEYBOARD_TAP, flags)
    except:
        pass

__all__ = ("get_localized_string", "download_localization", "JsonCacheFile", "utilities", "hut", "BottomSheet", "show_restart_bulletin", "MultiSelectorBottomSheet", "export_plugin_settings", "export_all_plugin_settings", "perform_haptic", "BottomSheetHelper")

class BottomSheetHelper:
    def __init__(self, context, activity, fragment):
        self.context = context
        self.activity = activity
        self.fragment = fragment
        self.bottom_sheet = None
        self.download_button = None
        self.current_language = "en"
        self.selected_github_url = None
        self.status_text_view = None

    def _load_sticker_avatar(self, avatar_view, pack_name, index):
        try:
            account = self.fragment.getCurrentAccount() if hasattr(self.fragment, 'getCurrentAccount') else 0
            media = MediaDataController.getInstance(account)
            if not media:
                return
            
            sticker_set = media.getStickerSetByName(pack_name)
            if sticker_set and sticker_set.documents and sticker_set.documents.size() > index:
                doc = sticker_set.documents.get(index)
                avatar_view.setImage(ImageLocation.getForDocument(doc), "90_90", None, 0, doc)
                return
            
            from org.telegram.tgnet import TLRPC
            input_set = TLRPC.TL_inputStickerSetShortName()
            input_set.short_name = pack_name
            
            def on_response(result):
                try:
                    if result and result.documents and result.documents.size() > index:
                        doc = result.documents.get(index)
                        run_on_ui_thread(lambda: avatar_view.setImage(ImageLocation.getForDocument(doc), "90_90", None, 0, doc))
                except:
                    pass
            
            media.getStickerSet(input_set, None, False, Callback1(on_response))
        except:
            pass

    def create_bottom_sheet(self, title, subtitle=None, description=None, description_entities=None, github_url=None, plugin_name=None, 
                           sticker_pack=None, sticker_index=None, raw_resource=None, button_text="Download", 
                           button2_text=None, bottom_text=None, show_close_button=True, show_user_avatar=False, 
                           sticker_circle=True, sticker_size=90, description_centered=False, 
                           on_button_click=None, on_button2_click=None, on_sticker_long_click=None,
                           title_subtitle_gap=15):
        from org.telegram.ui.ActionBar import BottomSheet, Theme
        from org.telegram.ui.Components import LayoutHelper, BackupImageView
        from org.telegram.messenger import AndroidUtilities
        from android.widget import LinearLayout, TextView, ImageView, FrameLayout
        from android.view import Gravity
        from android.util import TypedValue
        from androidx.core.widget import NestedScrollView
        
        try:
            from org.telegram.messenger import LocaleController
            self.current_language = LocaleController.getInstance().getCurrentLocaleInfo().getLangCode()
        except: pass
        
        self.bottom_sheet = BottomSheet(self.context, False, self.fragment.getResourceProvider())
        self.bottom_sheet.setApplyBottomPadding(False)
        self.bottom_sheet.setApplyTopPadding(False)
        self.bottom_sheet.fixNavigationBar(Theme.getColor(Theme.key_windowBackgroundWhite))
        self.bottom_sheet.setCanDismissWithSwipe(False)
        
        OnClick = dynamic_proxy(find_class("android.view.View$OnClickListener"))
        btn_height = (48 * (2 if button2_text and on_button2_click else 1)) + 28
        
        main_container = FrameLayout(self.context)
        
        linear_layout = LinearLayout(self.context)
        linear_layout.setOrientation(LinearLayout.VERTICAL)
        linear_layout.setClickable(True)
        
        frame_layout = FrameLayout(self.context)
        frame_layout.addView(linear_layout)
        
        scroll_view = NestedScrollView(self.context)
        scroll_view.addView(frame_layout)
        scroll_view.setClipToPadding(False)
        scroll_view.setPadding(0, 0, 0, AndroidUtilities.dp(btn_height))
        scroll_view.setFillViewport(False)
        
        max_scroll_px = int(AndroidUtilities.displaySize.y * 0.9 - AndroidUtilities.dp(btn_height))
        sv = scroll_view
        OnGlobalLayoutListener = dynamic_proxy(find_class("android.view.ViewTreeObserver$OnGlobalLayoutListener"))
        class MaxHeightEnforcer(OnGlobalLayoutListener):
            def onGlobalLayout(self):
                try:
                    if sv.getHeight() > max_scroll_px:
                        lp = sv.getLayoutParams()
                        lp.height = max_scroll_px
                        sv.setLayoutParams(lp)
                    sv.getViewTreeObserver().removeOnGlobalLayoutListener(self)
                except: pass
        scroll_view.getViewTreeObserver().addOnGlobalLayoutListener(MaxHeightEnforcer())
        
        main_container.addView(scroll_view, LayoutHelper.createFrame(-1, -2, Gravity.TOP))
        
        if show_close_button:
            close_view = ImageView(self.context)
            close_view.setBackground(Theme.createSelectorDrawable(Theme.getColor(Theme.key_listSelector)))
            close_view.setColorFilter(Theme.getColor(Theme.key_sheet_other))
            close_view.setImageResource(R_tg.drawable.ic_layer_close)
            bs = self.bottom_sheet
            class CloseClick(OnClick):
                def onClick(self, v): bs.dismiss()
            close_view.setOnClickListener(CloseClick())
            pad = AndroidUtilities.dp(8)
            close_view.setPadding(pad, pad, pad, pad)
            frame_layout.addView(close_view, LayoutHelper.createFrame(36, 36, Gravity.TOP | Gravity.END, 6, 8, 8, 0))
        
        avatar_view = BackupImageView(self.context)
        avatar_view.setRoundRadius(AndroidUtilities.dp(45 if sticker_circle else 0))
        
        if on_sticker_long_click:
            OnLongClick = dynamic_proxy(find_class("android.view.View$OnLongClickListener"))
            callback, sheet = on_sticker_long_click, self
            class StickerLongClick(OnLongClick):
                def onLongClick(self, v):
                    try:
                        perform_haptic(sheet.activity)
                        if callable(callback): callback(sheet)
                    except: pass
                    return True
            avatar_view.setOnLongClickListener(StickerLongClick())
        
        linear_layout.addView(avatar_view, LayoutHelper.createLinear(sticker_size, sticker_size, Gravity.TOP | Gravity.CENTER_HORIZONTAL, 17, 20, 17, 0))
        
        try:
            if show_user_avatar:
                from org.telegram.ui.Components import AvatarDrawable
                from org.telegram.messenger import UserConfig
                user = UserConfig.getInstance(0).getCurrentUser()
                avatar = AvatarDrawable()
                avatar.setInfo(user)
                avatar_view.setForUserOrChat(user, avatar)
            elif raw_resource:
                from org.telegram.ui.Components import RLottieImageView
                lottie = RLottieImageView(self.context)
                lottie.setAnimation(raw_resource, 144, 144)
                lottie.playAnimation()
                linear_layout.removeView(avatar_view)
                linear_layout.addView(lottie, LayoutHelper.createLinear(144, 144, Gravity.TOP | Gravity.CENTER_HORIZONTAL, 0, 16, 0, 0))
            elif sticker_pack:
                self._load_sticker_avatar(avatar_view, sticker_pack, sticker_index or 0)
        except: pass
        
        title_view = TextView(self.context)
        title_view.setTypeface(AndroidUtilities.bold())
        title_view.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 20)
        title_view.setTextColor(Theme.getColor(Theme.key_windowBackgroundWhiteBlackText))
        title_view.setText(title)
        title_view.setGravity(Gravity.CENTER_HORIZONTAL)
        linear_layout.addView(title_view, LayoutHelper.createLinear(-1, -2, 0, 40, 20, 40, 0))
        
        if subtitle:
            sub_view = TextView(self.context)
            sub_view.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 14)
            sub_view.setTextColor(Theme.getColor(Theme.key_windowBackgroundWhiteGrayText))
            sub_view.setText(subtitle)
            sub_view.setGravity(Gravity.CENTER_HORIZONTAL)
            linear_layout.addView(sub_view, LayoutHelper.createLinear(-1, -2, 0, 21, title_subtitle_gap, 21, 8))
        
        if description:
            from org.telegram.ui.Components.spoilers import SpoilersTextView
            from org.telegram.messenger import MessageObject
            desc_view = SpoilersTextView(self.context)
            desc_view.setGravity((Gravity.CENTER_HORIZONTAL if description_centered else Gravity.LEFT) | Gravity.TOP)
            try:
                from org.telegram.messenger import AndroidUtilities as AU
                if hasattr(description, 'toString'):
                    if description_entities and description_entities.size() > 0:
                        MessageObject.replaceAnimatedEmoji(description, description_entities, desc_view.getPaint().getFontMetricsInt())
                    desc_view.setText(description)
                else:
                    desc_view.setText(AU.replaceTags(str(description).replace("\\n", "\n")))
            except:
                desc_view.setText(str(description))
            desc_view.setTextColor(Theme.getColor(Theme.key_dialogTextBlack))
            desc_view.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 15)
            try: desc_view.setMovementMethod(AU.LinkMovementMethodMy())
            except: pass
            desc_view.setLinkTextColor(Theme.getColor(Theme.key_dialogTextLink))
            linear_layout.addView(desc_view, LayoutHelper.createLinear(-1, -2, Gravity.LEFT | Gravity.TOP, 23, 15, 23, 20))
        
        button_container = LinearLayout(self.context)
        button_container.setOrientation(LinearLayout.VERTICAL)
        button_container.setClickable(True)
        button_container.setBackgroundColor(Theme.getColor(Theme.key_dialogBackground))
        button_container.setPadding(AndroidUtilities.dp(14), AndroidUtilities.dp(14), AndroidUtilities.dp(14), AndroidUtilities.dp(14))
        
        self.download_button = TextView(self.context)
        self.download_button.setBackground(Theme.createSimpleSelectorRoundRectDrawable(
            AndroidUtilities.dp(8), Theme.getColor(Theme.key_featuredStickers_addButton), 
            Theme.getColor(Theme.key_featuredStickers_addButtonPressed)))
        self.download_button.setGravity(Gravity.CENTER)
        self.download_button.setSingleLine(True)
        
        lang_display = self.current_language.upper()
        try:
            for lang in (self.available_languages if isinstance(self.available_languages, list) else []):
                if isinstance(lang, dict) and lang.get('code') == self.current_language:
                    lang_display = lang.get('display_name', lang_display)
                    break
        except: pass
        
        self.download_button.setText(f"{button_text} {lang_display}" if github_url else button_text)
        self.download_button.setTextColor(Theme.getColor(Theme.key_featuredStickers_buttonText))
        self.download_button.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 14)
        self.download_button.setTypeface(AndroidUtilities.bold())
        
        sheet, url, name = self, github_url, plugin_name
        class DownloadClick(OnClick):
            def onClick(self, v):
                if on_button_click:
                    on_button_click()
                    if sheet.bottom_sheet: sheet.bottom_sheet.dismiss()
                else:
                    sheet._on_download_click(url, name)
        self.download_button.setOnClickListener(DownloadClick())
        button_container.addView(self.download_button, LayoutHelper.createLinear(-1, 48, Gravity.CENTER_HORIZONTAL, 0, 0, 0, 0))
        
        if button2_text and on_button2_click:
            from org.telegram.ui.Stories.recorder import ButtonWithCounterView
            btn2 = ButtonWithCounterView(self.context, False, self.fragment.getResourceProvider())
            btn2.setText(button2_text, False)
            class Btn2Click(OnClick):
                def onClick(self, v):
                    on_button2_click()
                    if sheet.bottom_sheet: sheet.bottom_sheet.dismiss()
            btn2.setOnClickListener(Btn2Click())
            button_container.addView(btn2, LayoutHelper.createLinear(-1, 48, Gravity.CENTER_HORIZONTAL, 0, 10, 0, 0))
        
        main_container.addView(button_container, LayoutHelper.createFrame(-1, -2, Gravity.BOTTOM))
        
        if bottom_text:
            bottom_view = TextView(self.context)
            bottom_view.setGravity(Gravity.CENTER)
            bottom_view.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 14)
            bottom_view.setText(bottom_text)
            bottom_view.setTextColor(Theme.getColor(Theme.key_dialogTextGray3))
            bottom_view.setBackgroundColor(Theme.getColor(Theme.key_dialogBackground))
            bottom_view.setPadding(AndroidUtilities.dp(24), AndroidUtilities.dp(8), AndroidUtilities.dp(24), 0)
            main_container.addView(bottom_view, 1, LayoutHelper.createFrame(-1, -2, Gravity.BOTTOM, 0, 0, 0, btn_height))
        
        self.bottom_sheet.setCustomView(main_container)
        self.bottom_sheet.nestedScrollChild = scroll_view
        
        self.status_text_view = TextView(self.context)
        self.status_text_view.setGravity(Gravity.CENTER)
        self.status_text_view.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 12)
        self.status_text_view.setTextColor(Theme.getColor(Theme.key_dialogTextGray3))
        self.status_text_view.setVisibility(8)
        linear_layout.addView(self.status_text_view, LayoutHelper.createLinear(-1, -2, Gravity.TOP, 0, 0, 0, 10))

    def _on_download_click(self, github_url, plugin_name):
        url = self.selected_github_url or github_url
        if not url:
            self._store_continue_english_choice(plugin_name)
            self.bottom_sheet.dismiss()
            return
        
        if self.download_button:
            self.download_button.setText("Downloading...")
            self.download_button.setEnabled(False)
        
        def download():
            try:
                result = github_localization.download_localization("UiTweaks", self.current_language)
                if result in ("no_update_needed", "no_changes_detected"):
                    run_on_ui_thread(lambda: self._set_button_state("Already Up to Date", dismiss=True))
                else:
                    run_on_ui_thread(lambda: self._set_button_state("Cached!", dismiss=True, show_restart=True))
            except Exception as e:
                run_on_ui_thread(lambda: self._set_button_state("Retry", enabled=True))
        
        import threading
        threading.Thread(target=download, daemon=True).start()

    def _set_button_state(self, text, enabled=False, dismiss=False, show_restart=False):
        if self.download_button:
            self.download_button.setText(text)
            self.download_button.setEnabled(enabled)
        
        if dismiss:
            def delayed():
                run_on_ui_thread(lambda: self.bottom_sheet.dismiss())
                if show_restart:
                    run_on_ui_thread(lambda: show_restart_bulletin(
                        message=getString("restart_to_apply_localization", "Restart app to apply localization changes"),
                        button_text=getString("restart", "Restart")))
            import threading
            threading.Timer(2.0, delayed).start()

    def _store_continue_english_choice(self, plugin_name):
        try:
            from java.util import Locale
            lang = Locale.getDefault().getLanguage()
            if plugin_name == "UiTweaks_Localization":
                from base_plugin import PluginsController
                prefs = get_private_field(PluginsController.getInstance(), "preferences")
                prefs.edit().putBoolean(f"plugin_setting_ui_tweaks_continue_english_{lang}", True).apply()
        except:
            pass

    def update_status(self, message):
        try:
            if self.status_text_view:
                self.status_text_view.setText(message)
                self.status_text_view.setVisibility(0)
        except:
            pass

    def show(self):
        if self.bottom_sheet:
            self.bottom_sheet.show()



def MultiSelector(items, title, subtitle, setting_keys, plugin_instance, max_selection=None, on_selection_change=None, item_subtexts=None, default=None, action_text=None, show_count=True, on_action_click=None, show_select_all=False):
    try:
        fragment = get_last_fragment()
        if not fragment:
            return
        
        context = fragment.getContext()
        
        if max_selection is None:
            max_selection = len(items)
        
        if not hasattr(plugin_instance, '_multi_selector_settings'):
            plugin_instance._multi_selector_settings = set()
        plugin_instance._multi_selector_settings.update(setting_keys)
        
        from org.telegram.ui.ActionBar import BottomSheet
        from org.telegram.ui.Components import LayoutHelper
        from org.telegram.messenger import AndroidUtilities
        from android.widget import LinearLayout, TextView, FrameLayout
        from android.view import Gravity
        from android.util import TypedValue
        from androidx.core.widget import NestedScrollView
        from org.telegram.ui.ActionBar import Theme
        from org.telegram.ui.Components import CheckBox2
        from android.widget import ImageView
        from org.telegram.ui.ActionBar import SimpleTextView
        
        bottom_sheet = BottomSheet(context, False, fragment.getResourceProvider())
        bottom_sheet.setApplyBottomPadding(False)
        bottom_sheet.setApplyTopPadding(False)
        bottom_sheet.fixNavigationBar(Theme.getColor(Theme.key_windowBackgroundWhite))
        
        linear_layout = LinearLayout(context)
        linear_layout.setOrientation(LinearLayout.VERTICAL)
        linear_layout.setClickable(True)
        
        frame_layout = FrameLayout(context)
        frame_layout.addView(linear_layout)
        
        scroll_view = NestedScrollView(context)
        scroll_view.addView(frame_layout)
        bottom_sheet.setCustomView(scroll_view)
        
        title_text_view = SimpleTextView(context)
        title_text_view.setTypeface(AndroidUtilities.bold())
        title_text_view.setTextSize(20)
        title_text_view.setTextColor(Theme.getColor(Theme.key_dialogTextBlack))
        title_text_view.setText(title)
        title_text_view.setGravity(Gravity.CENTER)
        linear_layout.addView(title_text_view, LayoutHelper.createLinear(-2, -2, Gravity.TOP | Gravity.CENTER_HORIZONTAL, 10, 20, 10, 0))
        
        subtitle_text_view = TextView(context)
        subtitle_text_view.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 13)
        subtitle_text_view.setTextColor(Theme.getColor(Theme.key_dialogTextGray3))
        subtitle_text_view.setSingleLine(True)
        subtitle_text_view.setText(subtitle)
        subtitle_text_view.setGravity(Gravity.CENTER)
        linear_layout.addView(subtitle_text_view, LayoutHelper.createLinear(-2, -2, Gravity.TOP | Gravity.CENTER_HORIZONTAL, 10, 0, 10, 0))
        
        selected_items = set()
        checkboxes = {}
        select_all_button = [None]
        
        def update_action_button_text():
            if action_text:
                count = len(selected_items)
                if show_count:
                    action_button.setText(f"{action_text} ({count})")
                else:
                    action_button.setText(action_text)
            action_button.setEnabled(True)
        
        def on_selection_changed(selected_indices):
            for i, key in enumerate(setting_keys):
                plugin_instance.set_setting(key, i in selected_indices)
            
            if hasattr(plugin_instance, 'setup_hooks'):
                plugin_instance.setup_hooks()
            
            if on_selection_change:
                selected_keys = [setting_keys[i] for i in selected_indices]
                should_restart = on_selection_change(selected_keys)
                if should_restart:
                    action_button.setText(getString("restart_to_apply_changes", "Restart to apply changes"))
                else:
                    update_action_button_text()
        
        OnClickInterface = find_class("android.view.View$OnClickListener")
        OnClick = dynamic_proxy(OnClickInterface)
        
        if show_select_all:
            select_all_text_view = TextView(context)
            select_all_text_view.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 14)
            select_all_text_view.setTextColor(Theme.getColor(Theme.key_featuredStickers_addButton))
            select_all_text_view.setText(getString("select_all", "Select All"))
            select_all_text_view.setGravity(Gravity.CENTER_VERTICAL | Gravity.LEFT)
            select_all_text_view.setPadding(AndroidUtilities.dp(24), AndroidUtilities.dp(10), AndroidUtilities.dp(10), AndroidUtilities.dp(10))
            select_all_button[0] = select_all_text_view
            
            class SelectAllClickImpl(OnClick):
                def onClick(self, v):
                    if len(selected_items) == len(items):
                        selected_items.clear()
                        for checkbox in checkboxes.values():
                            checkbox.setChecked(False, True)
                        select_all_text_view.setText(getString("select_all", "Select All"))
                    else:
                        selected_items.clear()
                        for i in range(len(items)):
                            selected_items.add(i)
                            checkboxes[i].setChecked(True, True)
                        select_all_text_view.setText(getString("deselect_all", "Deselect All"))
                    
                    update_action_button_text()
                    
                    if on_selection_changed:
                        on_selection_changed(list(selected_items))
            
            select_all_text_view.setOnClickListener(SelectAllClickImpl())
            linear_layout.addView(select_all_text_view, LayoutHelper.createLinear(-1, -2, Gravity.TOP | Gravity.LEFT, 0, 10, 0, 10))
        
        for i, item_text in enumerate(items):
            item_container = FrameLayout(context)
            item_container.setBackground(None)
            
            checkbox = CheckBox2(context, 21, fragment.getResourceProvider())
            checkbox.setColor(Theme.key_dialogRoundCheckBox, Theme.key_checkboxDisabled, Theme.key_dialogRoundCheckBoxCheck)
            checkbox.setDrawUnchecked(True)
            checkbox.setDrawBackgroundAsArc(10)
            checkbox.setChecked(False, False)
            checkbox.setVisibility(1)
            
            text_container = LinearLayout(context)
            text_container.setOrientation(LinearLayout.VERTICAL)
            text_container.setGravity(Gravity.CENTER_VERTICAL)
            
            text_view = TextView(context)
            text_view.setText(item_text)
            text_view.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 16)
            text_view.setTextColor(Theme.getColor(Theme.key_dialogTextBlack))
            text_view.setGravity(Gravity.CENTER_VERTICAL)
            text_container.addView(text_view, LayoutHelper.createLinear(-1, -2, Gravity.TOP, 0, 0, 0, 0))
            
            if item_subtexts and i < len(item_subtexts) and item_subtexts[i]:
                subtext_view = TextView(context)
                subtext_view.setText(item_subtexts[i])
                subtext_view.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 13)
                subtext_view.setTextColor(Theme.getColor(Theme.key_dialogTextGray3))
                subtext_view.setGravity(Gravity.CENTER_VERTICAL)
                text_container.addView(subtext_view, LayoutHelper.createLinear(-1, -2, Gravity.TOP, 0, 0, 0, 0))
            
            item_container.addView(checkbox, LayoutHelper.createFrame(24, 24, Gravity.CENTER_VERTICAL | Gravity.LEFT, 16, 0, 0, 0))
            item_container.addView(text_container, LayoutHelper.createFrame(-1, -1, Gravity.CENTER_VERTICAL | Gravity.LEFT, 56, 0, 16, 0))
            
            checkboxes[i] = checkbox
            
            class ItemClickImpl(OnClick):
                def __init__(self, item_index):
                    super().__init__()
                    self.item_index = item_index
                def onClick(self, v):
                    checkbox = checkboxes.get(self.item_index)
                    if checkbox:
                        if self.item_index in selected_items:
                            selected_items.remove(self.item_index)
                            checkbox.setChecked(False, True)
                        else:
                            if len(selected_items) >= max_selection:
                                from org.telegram.ui.Components import BulletinFactory
                                BulletinFactory.of(bottom_sheet.container, fragment.getResourceProvider()).createSimpleBulletin(
                                    R_tg.raw.chats_infotip, 
                                    f"Maximum {max_selection} items allowed"
                                ).show(True)
                                return
                            
                            selected_items.add(self.item_index)
                            checkbox.setChecked(True, True)
                        
                        update_action_button_text()
                        
                        if show_select_all and select_all_button[0]:
                            if len(selected_items) == len(items):
                                select_all_button[0].setText(getString("deselect_all", "Deselect All"))
                            else:
                                select_all_button[0].setText(getString("select_all", "Select All"))
                        
                        if on_selection_changed:
                            on_selection_changed(list(selected_items))
            
            item_container.setOnClickListener(ItemClickImpl(i))
            item_height = 72 if (item_subtexts and i < len(item_subtexts) and item_subtexts[i]) else 56
            linear_layout.addView(item_container, LayoutHelper.createLinear(-1, item_height, Gravity.TOP, 0, 0, 0, 0))
        
        action_button = TextView(context)
        action_button.setBackground(Theme.createSimpleSelectorRoundRectDrawable(
            AndroidUtilities.dp(8), 
            Theme.getColor(Theme.key_featuredStickers_addButton), 
            Theme.getColor(Theme.key_featuredStickers_addButtonPressed)
        ))
        action_button.setGravity(Gravity.CENTER)
        action_button.setSingleLine(True)
        update_action_button_text()
        action_button.setTextColor(Theme.getColor(Theme.key_featuredStickers_buttonText))
        action_button.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 14)
        action_button.setTypeface(AndroidUtilities.bold())
        action_button.setEnabled(True)
        
        class ActionClickImpl(OnClick):
            def onClick(self, v):
                if on_action_click:
                    selected_keys = [setting_keys[i] for i in selected_items]
                    on_action_click(selected_keys)
                    from android_utils import run_on_ui_thread
                    run_on_ui_thread(lambda: bottom_sheet.dismiss())
                    return
                
                for i, key in enumerate(setting_keys):
                    plugin_instance.set_setting(key, i in selected_items)
                
                if hasattr(plugin_instance, 'setup_hooks'):
                    plugin_instance.setup_hooks()
                
                if on_selection_change:
                    selected_keys = [setting_keys[i] for i in selected_items]
                    should_restart = on_selection_change(selected_keys)
                    if should_restart:
                        from quantahut import restart_app
                        from client_utils import get_last_fragment
                        fragment = get_last_fragment()
                        if fragment:
                            restart_app(fragment)
                        return

                from android_utils import run_on_ui_thread
                run_on_ui_thread(lambda: bottom_sheet.dismiss())
        
        action_button.setOnClickListener(ActionClickImpl())
        linear_layout.addView(action_button, LayoutHelper.createLinear(-1, 48, Gravity.START, 14, 20, 14, 14))
        
        current_selection = []
        for i, key in enumerate(setting_keys):
            is_selected = False
            
            setting_value = plugin_instance.get_setting(key)
            if setting_value is not None:
                is_selected = bool(setting_value)
            elif default and key in default:
                is_selected = True
                
            if is_selected:
                current_selection.append(i)
                selected_items.add(i)
                checkboxes[i].setChecked(True, False)
        
        update_action_button_text()
        
        bottom_sheet.show()
        
    except Exception as e:
        pass


class _MessageMenuRegistry:
    def __init__(self):
        self.items = []
        self._unhook_fill = None
        self._unhook_process = None

    def ensure_hooks(self, plugin: BasePlugin):
        try:
            if not self._unhook_fill:
                fill_method = ChatActivity.getClass().getDeclaredMethod(
                    "fillMessageMenu",
                    MessageObject,
                    ArrayList,
                    ArrayList,
                    ArrayList
                )
                self._unhook_fill = plugin.hook_method(fill_method, _QHFillMenuHook(self))
        except Exception as e:
            quantahut_log(f"fillMessageMenu hook error: {str(e)}")
        try:
            if not self._unhook_process:
                process_method = ChatActivity.getClass().getDeclaredMethod(
                    "processSelectedOption",
                    Integer.TYPE
                )
                self._unhook_process = plugin.hook_method(process_method, _QHProcessOptionHook(self))
        except Exception as e:
            quantahut_log(f"processSelectedOption hook error: {str(e)}")

    def register_item(self, *, text: str, option_id: int, icon_res: int, condition_predicate, on_click, insert_at_top: bool):

        # maybe this will fix memory leaks
        import weakref
        import types
        
        def wrap_callback(callback):
            if callback is None:
                return None
            if isinstance(callback, types.MethodType):
                weak_method = weakref.WeakMethod(callback)
                def weak_wrapper(*args, **kwargs):
                    method = weak_method()
                    if method is not None:
                        return method(*args, **kwargs)
                    return None
                return weak_wrapper
            else:
                return callback
        
        handle = {
            'text': text,
            'option_id': int(option_id),
            'icon_res': int(icon_res),
            'condition': wrap_callback(condition_predicate),
            'on_click': wrap_callback(on_click),
            'insert_top': bool(insert_at_top),
        }
        self.items.append(handle)
        return handle

    def unregister_item(self, handle):
        try:
            if handle in self.items:
                self.items.remove(handle)
        except Exception:
            pass

    def cleanup_hooks(self, plugin: BasePlugin):
        try:
            if self._unhook_fill:
                plugin.unhook_method(self._unhook_fill)
                self._unhook_fill = None
                quantahut_log("fillMessageMenu hook removed")
        except Exception:
            pass
        
        try:
            if self._unhook_process:
                plugin.unhook_method(self._unhook_process)
                self._unhook_process = None
                quantahut_log("processSelectedOption hook removed")
        except Exception:
            pass
        
        self.items.clear()
        quantahut_log("QuantaHut hooks cleaned up")


class _QHFillMenuHook:
    def __init__(self, registry: _MessageMenuRegistry):
        self.registry = registry

    def before_hooked_method(self, param):
        pass

    def after_hooked_method(self, param):
        try:
            primary = param.args[0]
            if primary is None:
                return
            try:
                self.registry.last_message = primary
            except Exception:
                pass
            icons = param.args[1]
            items = param.args[2]
            options = param.args[3]

            for entry in list(self.registry.items):
                try:
                    if entry.get('condition') and callable(entry['condition']):
                        if not entry['condition'](primary):
                            continue
                    if entry.get('insert_top'):
                        icons.add(0, Integer(entry['icon_res']))
                        options.add(0, Integer(entry['option_id']))
                        items.add(0, entry['text'])
                    else:
                        details_index = -1
                        try:
                            from org.telegram.messenger import LocaleController, R as R_extera
                            details_string = LocaleController.getString(R_extera.string.Details)
                            for i in range(items.size()):
                                if str(items.get(i)) == details_string:
                                    details_index = i
                                    break
                        except Exception:
                            pass
                        
                        if details_index >= 0:
                            icons.add(details_index, Integer(entry['icon_res']))
                            options.add(details_index, Integer(entry['option_id']))
                            items.add(details_index, entry['text'])
                        else:
                            icons.add(Integer(entry['icon_res']))
                            options.add(Integer(entry['option_id']))
                            items.add(entry['text'])
                except Exception:
                    continue
        except Exception:
            pass


class _QHProcessOptionHook:
    def __init__(self, registry: _MessageMenuRegistry):
        self.registry = registry

    def before_hooked_method(self, param):
        try:
            option = param.args[0]
            try:
                opt_val = int(option)
            except Exception:
                try:
                    opt_val = option.intValue()
                except Exception:
                    return

            for entry in list(self.registry.items):
                if opt_val == entry.get('option_id'):
                    try:
                        chat_activity = param.thisObject
                        message = getattr(chat_activity, 'selectedObject', None)
                        if message is None:
                            message = getattr(self.registry, 'last_message', None)
                        try:
                            chat_activity.closeMenu()
                        except Exception:
                            pass
                        if callable(entry.get('on_click')):
                            entry['on_click'](chat_activity, message)
                        param.setResult(None)
                    except Exception:
                        pass
                    finally:
                        return
        except Exception:
            pass

    def after_hooked_method(self, param):
        pass


_message_menu_registry = _MessageMenuRegistry()


def _ensure_message_menu_hooks(plugin: BasePlugin):
    _message_menu_registry.ensure_hooks(plugin)

def cleanup_quantahut_hooks(plugin: BasePlugin):
    _message_menu_registry.cleanup_hooks(plugin)


class HutUtilities:
    def register_message_menu_item(self, *, text: str, option_id: int, icon_res: int = R_tg.drawable.msg_message_s, condition_predicate=None, on_click=None, insert_at_top: bool = False):
        try:
            return _message_menu_registry.register_item(
                text=text,
                option_id=option_id,
                icon_res=icon_res,
                condition_predicate=condition_predicate,
                on_click=on_click,
                insert_at_top=insert_at_top,
            )
        except Exception as e:
            quantahut_log(f"utilities.register_message_menu_item error: {str(e)}")
            return None

    def unregister_message_menu_item(self, handle):
        try:
            if handle:
                _message_menu_registry.unregister_item(handle)
        except Exception as e:
            quantahut_log(f"utilities.unregister_message_menu_item error: {str(e)}")


utilities = HutUtilities()
hut = utilities

available_languages = []


def BottomSheet(title, subtitle=None, description=None, description_entities=None, github_url=None, plugin_name=None, sticker_pack=None, sticker_index=None, raw_resource=None, button_text="Download", button2_text=None, bottom_text=None, show_close_button=True, show_user_avatar=False, sticker_circle=True, sticker_size=90, description_centered=False, on_button_click=None, on_button2_click=None, on_sticker_long_click=None, title_subtitle_gap=15):
    try:
        from android_utils import run_on_ui_thread
        
        def create_and_show():
            try:
                current_fragment = get_last_fragment()
                if not current_fragment:
                    quantahut_log("Cannot show bottom sheet, no current fragment.")
                    return
                
                activity = current_fragment.getParentActivity()
                if not activity:
                    quantahut_log("Cannot show bottom sheet, no activity.")
                    return
                
                bottom_sheet = BottomSheetHelper(activity, activity, current_fragment)
                bottom_sheet.create_bottom_sheet(title, subtitle, description, description_entities, github_url, plugin_name, sticker_pack, sticker_index, raw_resource, button_text, button2_text, bottom_text, show_close_button, show_user_avatar, sticker_circle, sticker_size, description_centered, on_button_click, on_button2_click, on_sticker_long_click, title_subtitle_gap)
                bottom_sheet.show()
                
            except Exception as e:
                quantahut_log(f"Error showing bottom sheet: {str(e)}")
        
        run_on_ui_thread(create_and_show)
        
    except Exception as e:
        quantahut_log(f"Error in BottomSheet: {str(e)}")



def quantahut_log(string: str):
    if setting_getter and setting_getter("show_logs", DEFAULT_SHOW_LOGS):
        log(f"[QuantaHut] {string}")

def getString(key: str, default: str = None, plugin_id: str = "UiTweaks") -> str:
    fallback = default if default is not None else key
    try:
        result = get_localized_string(plugin_id, key, fallback)
        return result if result else fallback
    except:
        return fallback

__all__ = [
    'UpdateBottomSheet',
    'MultiSelector', 
    'showupdatebottomsheet',
    'utilities',
    'available_languages',
    'getString',
    'quantahut_log',
    'QuantaHutPlugin',
    'cleanup_quantahut_hooks'
]


class _SearchPollingRunnable(RunnableProxy):
    def __init__(self, plugin, activity, search_item, handler):
        super().__init__()
        self._plugin_ref = weakref.ref(plugin)
        self.activity = activity
        self.search_item = search_item
        self.handler = handler
        self.aid = id(activity)
        self.last_query = ""
        self.was_active = False

    def run(self):
        try:
            plugin = self._plugin_ref()
            if not plugin:
                return
            state = plugin.get_search_state(self.aid)
            
            if self.search_item.isSearchFieldVisible():
                if not state["reset_hidden"]:
                    reset_item = get_private_field(self.activity, "resetItem")
                    if reset_item:
                        reset_item.setVisibility(8)
                        state["reset_hidden"] = True

                state["active"] = True
                search_field = self.search_item.getSearchField()
                if search_field:
                    query = str(search_field.getText().toString())
                    
                    show_history = (query == "")
                    if show_history != state.get("show_history", False):
                        state["show_history"] = show_history
                        list_view = get_private_field(self.activity, "listView")
                        if list_view and list_view.adapter:
                            list_view.adapter.update(True)
                    
                    if query != self.last_query:
                        if self.last_query and len(self.last_query) >= 2 and query == "":
                            plugin_obj = get_private_field(self.activity, "plugin")
                            if plugin_obj:
                                plugin.add_to_history(plugin_obj.getId(), self.last_query)
                        
                        self.last_query = query
                        state["query"] = query
                        list_view = get_private_field(self.activity, "listView")
                        if list_view and list_view.adapter:
                            list_view.adapter.update(True)

                self.was_active = True
                self.handler.postDelayed(self, 200)
            else:
                if state["reset_hidden"]:
                    reset_item = get_private_field(self.activity, "resetItem")
                    if reset_item:
                        PC = jclass("com.exteragram.messenger.plugins.PluginsController")
                        plugin = get_private_field(self.activity, "plugin")
                        if plugin and PC.getInstance().hasPluginSettingsPreferences(plugin.getId()):
                            reset_item.setVisibility(0)
                    state["reset_hidden"] = False

                if state["active"]:
                    if self.last_query and len(self.last_query) >= 2:
                        plugin_obj = get_private_field(self.activity, "plugin")
                        if plugin_obj:
                            plugin.add_to_history(plugin_obj.getId(), self.last_query)
                    
                    state["active"] = False
                    state["query"] = ""
                    state["show_history"] = False
                    self.last_query = ""
                    list_view = get_private_field(self.activity, "listView")
                    if list_view and list_view.adapter:
                        list_view.adapter.update(True)

                self.was_active = False
                self.handler.postDelayed(self, 500)

        except Exception as e:
            pass


class _PluginSettingsSearchCreateViewHook:
    def __init__(self, plugin):
        self._plugin_ref = weakref.ref(plugin)

    def after_hooked_method(self, param):
        try:
            plugin = self._plugin_ref()
            if not plugin:
                return
            activity = param.thisObject
            aid = id(activity)

            action_bar = get_private_field(activity, "actionBar")
            if not action_bar:
                return

            menu = action_bar.menu if action_bar.menu else action_bar.createMenu()
            if not menu:
                return

            R = jclass("org.telegram.messenger.R")
            LocaleController = jclass("org.telegram.messenger.LocaleController")
            R_string = jclass("org.telegram.messenger.R$string")

            search_item = menu.addItem(0, R.drawable.ic_ab_search)
            search_item.setIsSearchField(True)
            search_item.setSearchFieldHint(LocaleController.getString(R_string.Search))
            set_private_field(activity, "searchItem", search_item)

            plugin._activity_refs[aid] = {"activity": activity, "search_item": search_item}

            from android.os import Handler, Looper
            handler = Handler(Looper.getMainLooper())
            runnable = _SearchPollingRunnable(plugin, activity, search_item, handler)
            handler.post(runnable)

        except Exception as e:
            pass


class _PluginSettingsSearchFillItemsHook:
    def __init__(self, plugin):
        self._plugin_ref = weakref.ref(plugin)

    def after_hooked_method(self, param):
        try:
            plugin = self._plugin_ref()
            if not plugin:
                return
            activity = param.thisObject
            aid = id(activity)
            items = param.args[0]

            if not items:
                return

            state = plugin.get_search_state(aid)
            if not state["active"]:
                return

            sub_callback = get_private_field(activity, "createSubFragmentCallback")
            if sub_callback is not None:
                query = state["query"].strip().lower()
                if query:
                    to_remove = []
                    for i in range(items.size()):
                        item = items.get(i)
                        if item is None:
                            continue
                        if not plugin._matches_query(item, query):
                            to_remove.append(i)
                    for i in reversed(to_remove):
                        items.remove(i)
                return

            plugin_obj = get_private_field(activity, "plugin")
            if not plugin_obj:
                return

            pid = plugin_obj.getId()

            query = state["query"].strip().lower()
            
            if not query and state.get("show_history", False):
                history = plugin.get_search_history(pid)
                if history:
                    items.clear()
                    
                    UItem = jclass("org.telegram.ui.Components.UItem")
                    TextSetting = jclass("com.exteragram.messenger.plugins.models.TextSetting")
                    items.add(UItem.asHeader(getString("recent_searches", "Recent searches")))
                    
                    for qt in history:
                        def make_cb(q, a, p_ref):
                            def cb(*args):
                                try:
                                    p = p_ref()
                                    if p and a in p._activity_refs:
                                        si = p._activity_refs[a].get("search_item")
                                        if si:
                                            sf = si.getSearchField()
                                            if sf:
                                                sf.setText(q)
                                                sf.setSelection(len(q))
                                except: pass
                            return cb
                        
                        callback = make_cb(qt, aid, self._plugin_ref)
                        setting = TextSetting(qt, None, False, False, callback, None, None, None)
                        
                        h_item = UItem.asButton(0, qt)
                        h_item.settingItem = setting
                        items.add(h_item)
                return
            
            if not query:
                return
            
            if pid not in plugin._all_items_cache:
                plugin._all_items_cache[pid] = plugin._collect_all_items(activity, plugin_obj, items)

            all_items = plugin._all_items_cache[pid]

            items.clear()

            for item in all_items:
                if plugin._matches_query(item, query):
                    items.add(item)

        except Exception as e:
            pass


from base_plugin import MethodHook

class _SafeModeHook(MethodHook):
    def __init__(self, plugin):
        self._plugin_ref = weakref.ref(plugin)
    
    def before_hooked_method(self, param):
        try:
            plugin = self._plugin_ref()
            if not plugin:
                return
            from android.view import KeyEvent
            from java.lang import System
            
            if not param.args or len(param.args) == 0:
                return
            
            key_event = param.args[0]
            if not key_event:
                return
            
            key_code = key_event.getKeyCode()
            action = key_event.getAction()
            
            if key_code == KeyEvent.KEYCODE_VOLUME_DOWN:
                current_time = System.currentTimeMillis()
                
                if action == KeyEvent.ACTION_DOWN:
                    plugin.safe_mode_volume_down_press_time = current_time
                    plugin.safe_mode_is_holding = False
                elif action == KeyEvent.ACTION_UP:
                    press_duration = current_time - plugin.safe_mode_volume_down_press_time
                    
                    if press_duration > 500:
                        plugin.safe_mode_is_holding = True
                        plugin.safe_mode_volume_down_count = 0
                        return
                    
                    if (current_time - plugin.safe_mode_last_volume_down_time) > plugin.safe_mode_cooldown:
                        plugin.safe_mode_volume_down_count = 1
                        plugin.safe_mode_last_volume_down_time = current_time
                    elif (current_time - plugin.safe_mode_last_volume_down_time) <= plugin.safe_mode_multi_tap_window:
                        plugin.safe_mode_volume_down_count += 1
                        plugin.safe_mode_last_volume_down_time = current_time
                        if plugin.safe_mode_volume_down_count >= plugin.safe_mode_required_taps:
                            plugin.safe_mode_volume_down_count = 0
                            plugin._on_safe_mode_detected()
                            param.setResult(True)
                            return
                        
                        param.setResult(True)
        except Exception:
            pass


DEEPLINK_BASE = "https://t.me/exteraSettings"
DEEPLINK_BASE_AYU = "https://t.me/ayuSettings"


class _LinkAliasEnterViewConstructorHook(MethodHook):
    def __init__(self, plugin):
        MethodHook.__init__(self)
        self._plugin_ref = weakref.ref(plugin)

    @property
    def plugin(self):
        return self._plugin_ref() if self._plugin_ref else None

    def after_hooked_method(self, param):
        try:
            plugin = self.plugin
            if not plugin:
                return

            enter_view = param.thisObject
            
            def attach_watcher():
                plugin._link_alias_attach_text_watcher(enter_view)
            
            run_on_ui_thread(attach_watcher, delay=500)

        except Exception as e:
            pass


def _setup_link_alias_search(self):
    try:
        self.log("Setting up link alias search...")
        self._link_alias_hook_enter_view_constructor()
    except Exception as e:
        self.log(f"Failed to setup link alias search: {e}")


def _link_alias_get_class(self, class_name):
    if class_name not in self._link_alias_class_cache:
        self._link_alias_class_cache[class_name] = find_class(class_name)
    return self._link_alias_class_cache[class_name]


def _link_alias_hook_enter_view_constructor(self):
    try:
        ChatActivityEnterView = self._link_alias_get_class("org.telegram.ui.Components.ChatActivityEnterView")
        Activity = self._link_alias_get_class("android.app.Activity")
        SizeNotifierFrameLayout = self._link_alias_get_class("org.telegram.ui.Components.SizeNotifierFrameLayout")
        ChatActivity = self._link_alias_get_class("org.telegram.ui.ChatActivity")
        ResourcesProvider = self._link_alias_get_class("org.telegram.ui.ActionBar.Theme$ResourcesProvider")
        
        if not all([ChatActivityEnterView, Activity, SizeNotifierFrameLayout, ChatActivity]):
            return

        constructor = ChatActivityEnterView.getClass().getDeclaredConstructor(
            Activity,
            SizeNotifierFrameLayout,
            ChatActivity,
            jclass("java.lang.Boolean").TYPE,
            ResourcesProvider
        )
        constructor.setAccessible(True)
        self.link_alias_hook_constructor_ref = self.hook_method(constructor, _LinkAliasEnterViewConstructorHook(self))

    except Exception as e:
        self.log(f"Failed to hook enter view constructor: {e}")


def _link_alias_attach_text_watcher(self, enter_view):
    try:
        view_id = id(enter_view)
        if view_id in self.link_alias_attached_views:
            return

        message_edit_text = get_private_field(enter_view, "messageEditText")
        if not message_edit_text:
            return

        self.link_alias_current_enter_view_ref = weakref.ref(enter_view)

        TextWatcherInterface = self._link_alias_get_class("android.text.TextWatcher")
        plugin_ref = weakref.ref(self)

        class CustomTextWatcher(dynamic_proxy(TextWatcherInterface)):
            def beforeTextChanged(self, s, start, count, after):
                pass

            def onTextChanged(self, s, start, before, count):
                pass

            def afterTextChanged(self, editable):
                plugin = plugin_ref()
                if not plugin:
                    return
                try:
                    text = str(editable.toString()) if editable else ""

                    if text.startswith("!") and len(text) > 1:
                        search_key = text[1:].lower().strip()
                        plugin._link_alias_show_matching_settings(search_key)
                    else:
                        plugin._link_alias_hide_popup()
                except Exception as e:
                    pass

        watcher = CustomTextWatcher()
        message_edit_text.addTextChangedListener(watcher)
        self.link_alias_attached_views.add(view_id)

    except Exception as e:
        self.log(f"Failed to attach text watcher: {e}")


def _link_alias_collect_settings_with_alias(self):
    if self.link_alias_settings_cache:
        return self.link_alias_settings_cache

    settings_list = []

    try:
        PluginsController = self._link_alias_get_class("com.exteragram.messenger.plugins.PluginsController")
        if not PluginsController:
            return settings_list

        controller = PluginsController.getInstance()
        if not controller:
            return settings_list

        settings_map = controller.settings
        if not settings_map:
            return settings_list

        plugins_map = controller.plugins

        key_set = settings_map.keySet()
        key_array = key_set.toArray()
        
        for i in range(len(key_array)):
            plugin_id = key_array[i]
            try:
                plugin_settings = settings_map.get(plugin_id)
                if not plugin_settings:
                    continue

                plugin = plugins_map.get(plugin_id) if plugins_map else None
                plugin_name = plugin.getName() if plugin else str(plugin_id)

                self._link_alias_collect_from_java_list(settings_list, plugin_id, plugin_name, plugin_settings, "")
            except:
                pass

        extera_settings = self._link_alias_collect_extera_settings_with_alias()
        settings_list.extend(extera_settings)

        self.link_alias_settings_cache = settings_list

    except Exception as e:
        self.log(f"Failed to collect settings: {e}")

    return settings_list


def _link_alias_collect_extera_settings_with_alias(self):
    settings_list = []
    try:
        SettingsRegistry = self._link_alias_get_class("com.exteragram.messenger.preferences.utils.SettingsRegistry")
        if not SettingsRegistry:
            return settings_list

        registry = SettingsRegistry.getInstance()
        if not registry:
            return settings_list

        try:
            create_entries_method = registry.getClass().getDeclaredMethod("createEntriesIfNeeded")
            create_entries_method.setAccessible(True)
            create_entries_method.invoke(registry)
        except:
            pass

        entries_field = registry.getClass().getDeclaredField("entriesStringAlias")
        entries_field.setAccessible(True)
        entries_map = entries_field.get(registry)

        prepared_field = registry.getClass().getDeclaredField("preparedEntries")
        prepared_field.setAccessible(True)
        prepared_map = prepared_field.get(registry)

        ayu_categories = None
        try:
            ayu_field = registry.getClass().getDeclaredField("ayuCategories")
            ayu_field.setAccessible(True)
            ayu_categories = ayu_field.get(None)
        except:
            pass

        if not entries_map:
            return settings_list

        key_set = entries_map.keySet()
        key_array = key_set.toArray()

        for i in range(len(key_array)):
            alias = str(key_array[i])
            try:
                entry = entries_map.get(alias)
                if not entry:
                    continue

                title = None
                subtext = None
                is_ayu = False
                try:
                    entry_class = entry.getClass()
                    guid_field = entry_class.getDeclaredField("guid")
                    guid_field.setAccessible(True)
                    guid = guid_field.getInt(entry)
                    
                    fragment_class_field = entry_class.getDeclaredField("fragmentClass")
                    fragment_class_field.setAccessible(True)
                    fragment_class = fragment_class_field.get(entry)
                    if ayu_categories and fragment_class:
                        is_ayu = ayu_categories.containsKey(fragment_class)
                    
                    prepared_entry = prepared_map.get(guid)
                    if prepared_entry:
                        title_field = entry_class.getDeclaredField("title")
                        title_field.setAccessible(True)
                        title = title_field.get(prepared_entry)
                        subtext_field = entry_class.getDeclaredField("subtext")
                        subtext_field.setAccessible(True)
                        subtext = subtext_field.get(prepared_entry)
                    if not title:
                        title_field = entry_class.getDeclaredField("title")
                        title_field.setAccessible(True)
                        title = title_field.get(entry)
                    if not subtext:
                        subtext_field = entry_class.getDeclaredField("subtext")
                        subtext_field.setAccessible(True)
                        subtext = subtext_field.get(entry)
                except:
                    pass

                if not title:
                    title = alias

                settings_list.append({
                    'plugin_id': None,
                    'plugin_name': str(subtext) if subtext else ('AyuGram' if is_ayu else 'exteraGram'),
                    'setting_name': str(title),
                    'link_alias': alias,
                    'search_key': alias.lower(),
                    'is_ayu': is_ayu
                })
            except:
                pass

    except:
        pass

    return settings_list


def _link_alias_collect_from_java_list(self, settings_list, plugin_id, plugin_name, items, prefix):
    try:
        for i in range(items.size()):
            item = items.get(i)
            if not item:
                continue

            link_alias = getattr(item, 'linkAlias', None)
            text = getattr(item, 'text', None) or getattr(item, 'key', None)

            if link_alias:
                str_alias = str(link_alias)
                full_alias = f"{prefix}:{str_alias}" if prefix else str_alias

                settings_list.append({
                    'plugin_id': str(plugin_id),
                    'plugin_name': str(plugin_name),
                    'setting_name': str(text) if text else str_alias,
                    'link_alias': str(full_alias),
                    'search_key': str_alias.lower()
                })

            sub_callback = getattr(item, 'createSubFragmentCallback', None)
            if sub_callback is not None:
                try:
                    child_prefix = f"{prefix}:{link_alias}" if prefix and link_alias else (str(link_alias) if link_alias else prefix)
                    self._link_alias_collect_from_callback(settings_list, plugin_id, plugin_name, sub_callback, child_prefix)
                except:
                    pass

    except:
        pass


def _link_alias_collect_from_callback(self, settings_list, plugin_id, plugin_name, callback, prefix):
    try:
        py_result = callback()
        if not py_result:
            return

        for py_item in py_result:
            if py_item is None:
                continue

            link_alias = getattr(py_item, 'link_alias', None)
            text = getattr(py_item, 'text', None) or getattr(py_item, 'key', None)

            if link_alias:
                str_alias = str(link_alias)
                full_alias = f"{prefix}:{str_alias}" if prefix else str_alias

                settings_list.append({
                    'plugin_id': str(plugin_id),
                    'plugin_name': str(plugin_name),
                    'setting_name': str(text) if text else str_alias,
                    'link_alias': str(full_alias),
                    'search_key': str_alias.lower()
                })

            sub_callback = getattr(py_item, 'create_sub_fragment', None)
            if sub_callback is not None and callable(sub_callback):
                child_prefix = f"{prefix}:{link_alias}" if prefix and link_alias else (str(link_alias) if link_alias else prefix)
                self._link_alias_collect_from_callback(settings_list, plugin_id, plugin_name, sub_callback, child_prefix)

    except:
        pass


def _link_alias_show_matching_settings(self, search_key):
    try:
        all_settings = self._link_alias_collect_settings_with_alias()
        if not all_settings:
            self._link_alias_hide_popup()
            return

        matching = []
        for setting in all_settings:
            alias_words = setting['search_key'].replace('_', ' ').split()
            name_words = setting['setting_name'].lower().replace('_', ' ').split()
            if any(word.startswith(search_key) for word in (alias_words + name_words)):
                matching.append(setting)

        if not matching:
            self._link_alias_hide_popup()
            return

        self._link_alias_show_bot_commands_popup(matching)

    except Exception as e:
        self.log(f"Failed to show matching settings: {e}")


def _link_alias_show_bot_commands_popup(self, settings):
    try:
        from org.telegram.ui.Components import RecyclerListView
        
        enter_view = self.link_alias_current_enter_view_ref() if self.link_alias_current_enter_view_ref else None
        
        if not enter_view:
            fragment = get_last_fragment()
            if fragment:
                enter_view = get_private_field(fragment, "chatActivityEnterView")
                if enter_view:
                    self.link_alias_current_enter_view_ref = weakref.ref(enter_view)
        
        if not enter_view:
            return

        bot_container = get_private_field(enter_view, "botCommandsMenuContainer")
        bot_adapter = get_private_field(enter_view, "botCommandsAdapter")
        
        if not bot_container:
            try:
                ChatActivityEnterView = self._link_alias_get_class("org.telegram.ui.Components.ChatActivityEnterView")
                create_method = ChatActivityEnterView.getClass().getDeclaredMethod("createBotCommandsMenuContainer")
                create_method.setAccessible(True)
                create_method.invoke(enter_view)
                bot_container = get_private_field(enter_view, "botCommandsMenuContainer")
                bot_adapter = get_private_field(enter_view, "botCommandsAdapter")
            except Exception as e:
                pass
        
        if not bot_container or not bot_adapter:
            return

        commands = []
        descriptions = []
        self.link_alias_current_settings = {}
        
        for setting in settings[:10]:
            display_alias = setting['link_alias'].split(':')[-1]
            cmd = display_alias
            commands.append(cmd)
            descriptions.append(setting['setting_name'])
            self.link_alias_current_settings[cmd] = setting

        new_result_field = bot_adapter.getClass().getDeclaredField("newResult")
        new_result_field.setAccessible(True)
        new_result = new_result_field.get(bot_adapter)
        new_result.clear()
        for cmd in commands:
            new_result.add(cmd)

        new_result_help_field = bot_adapter.getClass().getDeclaredField("newResultHelp")
        new_result_help_field.setAccessible(True)
        new_result_help = new_result_help_field.get(bot_adapter)
        new_result_help.clear()
        for desc in descriptions:
            new_result_help.add(desc)

        bot_adapter.notifyDataSetChanged()
        
        plugin_ref = weakref.ref(self)
        
        class ClickListener(dynamic_proxy(RecyclerListView.OnItemClickListener)):
            def onItemClick(self, view, position):
                plugin = plugin_ref()
                if not plugin:
                    return
                try:
                    if hasattr(view, 'getCommand'):
                        command = view.getCommand()
                        
                        setting = plugin.link_alias_current_settings.get(str(command))
                        if setting:
                            base = DEEPLINK_BASE_AYU if setting.get('is_ayu') else DEEPLINK_BASE
                            if setting['plugin_id']:
                                deep_link = f"{base}?p={setting['plugin_id']}&s={setting['link_alias']}"
                            else:
                                deep_link = f"{base}?s={setting['link_alias']}"
                            
                            enter_view_ref = plugin.link_alias_current_enter_view_ref
                            ev = enter_view_ref() if enter_view_ref else None
                            def ui_actions():
                                try:
                                    if ev:
                                        ev.setFieldText("")
                                    bot_container.dismiss()
                                except Exception:
                                    pass
                            run_on_ui_thread(ui_actions)
                            
                            fragment = get_last_fragment()
                            if fragment:
                                plugin._link_alias_send_message_to_current_chat(fragment, enter_view, deep_link)
                except Exception as e:
                    pass
        
        class LongClickListener(dynamic_proxy(RecyclerListView.OnItemLongClickListener)):
            def onItemClick(self, view, position):
                plugin = plugin_ref()
                if not plugin:
                    return False
                try:
                    if hasattr(view, 'getCommand'):
                        command = view.getCommand()
                        setting = plugin.link_alias_current_settings.get(str(command))
                        if setting:
                            base = DEEPLINK_BASE_AYU if setting.get('is_ayu') else DEEPLINK_BASE
                            if setting['plugin_id']:
                                deep_link = f"{base}?p={setting['plugin_id']}&s={setting['link_alias']}"
                            else:
                                deep_link = f"{base}?s={setting['link_alias']}"
                            
                            enter_view_ref = plugin.link_alias_current_enter_view_ref
                            ev = enter_view_ref() if enter_view_ref else None
                            def ui_actions():
                                try:
                                    if ev:
                                        ev.setFieldText(deep_link + " ")
                                    bot_container.dismiss()
                                except Exception:
                                    pass
                            run_on_ui_thread(ui_actions)
                            return True
                except Exception as e:
                    pass
                return False
        
        bot_container.listView.setOnItemClickListener(ClickListener())
        bot_container.listView.setOnItemLongClickListener(LongClickListener())
        
        self.link_alias_custom_container = bot_container
        bot_container.show()

    except Exception as e:
        self.log(f"Failed to show bot commands popup: {e}")


def _link_alias_send_message_to_current_chat(self, fragment, enter_view, text):
    try:
        from org.telegram.messenger import MessageObject, UserConfig, AccountInstance, SendMessagesHelper

        dialog_id = 0
        try:
            dialog_id_field = fragment.getClass().getDeclaredField("dialog_id")
            dialog_id_field.setAccessible(True)
            dialog_id = dialog_id_field.getLong(fragment)
        except:
            dialog_id = get_private_field(fragment, "dialog_id")

        if not dialog_id:
            return

        topic_id = 0
        user_reply_to_msg = None
        topic_reply_to_msg = None

        try:
            if hasattr(fragment, 'getTopicId'):
                topic_id = fragment.getTopicId()

            if topic_id == 0 and hasattr(fragment, 'getThreadMessage'):
                thread_msg = fragment.getThreadMessage()
                if thread_msg:
                    topic_id = thread_msg.getId()

            if topic_id == 0 and hasattr(fragment, 'threadMessageId'):
                topic_id = fragment.threadMessageId

            if enter_view and hasattr(enter_view, 'getReplyingMessageObject'):
                user_reply_to_msg = enter_view.getReplyingMessageObject()
        except:
            pass

        if topic_id != 0:
            try:
                current_account = UserConfig.selectedAccount
                account_instance = AccountInstance.getInstance(current_account)
                topic = account_instance.getMessagesController().getTopicsController().findTopic(-dialog_id, topic_id)
                if topic and topic.topicStartMessage:
                    topic_reply_to_msg = MessageObject(current_account, topic.topicStartMessage, False, False)
                    topic_reply_to_msg.isTopicMainMessage = True
            except:
                pass

        reply_msg = topic_reply_to_msg if topic_reply_to_msg else user_reply_to_msg

        params = SendMessagesHelper.SendMessageParams.of(
            text,
            dialog_id,
            user_reply_to_msg,
            reply_msg,
            None,
            True,
            None,
            None,
            None,
            True,
            0,
            0,
            None,
            False
        )

        send_helper = get_send_messages_helper()
        if send_helper and params:
            run_on_ui_thread(lambda: send_helper.sendMessage(params))
    except Exception as e:
        self.log(f"Failed to send message: {e}")


def _link_alias_hide_popup(self):
    try:
        if self.link_alias_custom_container:
            self.link_alias_custom_container.dismiss()
    except Exception as e:
        pass


def _link_alias_invalidate_settings_cache(self):
    self.link_alias_settings_cache = None


QuantaHut._setup_link_alias_search = _setup_link_alias_search
QuantaHut._link_alias_get_class = _link_alias_get_class
QuantaHut._link_alias_hook_enter_view_constructor = _link_alias_hook_enter_view_constructor
QuantaHut._link_alias_attach_text_watcher = _link_alias_attach_text_watcher
QuantaHut._link_alias_collect_settings_with_alias = _link_alias_collect_settings_with_alias
QuantaHut._link_alias_collect_extera_settings_with_alias = _link_alias_collect_extera_settings_with_alias
QuantaHut._link_alias_collect_from_java_list = _link_alias_collect_from_java_list
QuantaHut._link_alias_collect_from_callback = _link_alias_collect_from_callback
QuantaHut._link_alias_show_matching_settings = _link_alias_show_matching_settings
QuantaHut._link_alias_show_bot_commands_popup = _link_alias_show_bot_commands_popup
QuantaHut._link_alias_send_message_to_current_chat = _link_alias_send_message_to_current_chat
QuantaHut._link_alias_hide_popup = _link_alias_hide_popup
QuantaHut._link_alias_invalidate_settings_cache = _link_alias_invalidate_settings_cache


def _setup_expandable_switch(self):
    import sys
    import types
    
    if 'ui.quanta' not in sys.modules:
        quanta_module = types.ModuleType('ui.quanta')
        sys.modules['ui.quanta'] = quanta_module
    sys.modules['ui.quanta'].ExpandableSwitch = ExpandableSwitch
    sys.modules['ui.quanta'].MultiSelector = MultiSelector
    sys.modules['ui.quanta'].BottomSheet = BottomSheet
    
    try:
        from base_plugin import MethodHook
        PythonPluginsEngine = find_class("com.exteragram.messenger.plugins.PythonPluginsEngine")
        if PythonPluginsEngine:
            ListClass = jclass("java.util.List")
            method = PythonPluginsEngine.getClass().getDeclaredMethod("parsePySettingDefinitions", ListClass)
            method.setAccessible(True)
            self.hook_refs.append(self.hook_method(method, _ESParseHook(self)))
    except Exception:
        pass
    
    try:
        PluginSettingsActivity = find_class("com.exteragram.messenger.plugins.ui.PluginSettingsActivity")
        if PluginSettingsActivity:
            ArrayList = jclass("java.util.ArrayList")
            UniversalAdapter = jclass("org.telegram.ui.Components.UniversalAdapter")
            method = PluginSettingsActivity.getClass().getDeclaredMethod("fillItems", ArrayList, UniversalAdapter)
            method.setAccessible(True)
            self.hook_refs.append(self.hook_method(method, _ESFillItemsHook(self)))
    except Exception:
        pass
    
    try:
        PluginSettingsActivity = find_class("com.exteragram.messenger.plugins.ui.PluginSettingsActivity")
        if PluginSettingsActivity:
            UItem = jclass("org.telegram.ui.Components.UItem")
            ViewClass = jclass("android.view.View")
            IntType = jclass("java.lang.Integer").TYPE
            FloatType = jclass("java.lang.Float").TYPE
            method = PluginSettingsActivity.getClass().getDeclaredMethod("onClick", UItem, ViewClass, IntType, FloatType, FloatType)
            method.setAccessible(True)
            self.hook_refs.append(self.hook_method(method, _ESOnClickHook(self)))
    except Exception:
        pass


def _es_toggle_expanded(self, key):
    self._es_expanded_states[key] = not self._es_expanded_states.get(key, False)


def _es_is_expanded(self, key):
    return self._es_expanded_states.get(key, False)


class _ESParseHook:
    def __init__(self, plugin):
        self.plugin_ref = weakref.ref(plugin)

    def after_hooked_method(self, param):
        plugin = self.plugin_ref()
        if not plugin:
            return
        try:
            py_defs = param.args[0]
            result = param.getResult()
            if not py_defs or not result:
                return

            from com.exteragram.messenger.plugins.models import SwitchSetting

            expandable_indices = []
            for i in range(py_defs.size()):
                py_def = py_defs.get(i)
                if py_def and getattr(py_def, 'type', None) == "expandable_switch":
                    expandable_indices.append(i)

            if not expandable_indices:
                return

            new_items = []
            result_idx = 0

            for i in range(py_defs.size()):
                py_def = py_defs.get(i)
                if not py_def:
                    continue

                def_type = getattr(py_def, 'type', None)

                if def_type == "expandable_switch":
                    key = getattr(py_def, 'key', None)
                    text = getattr(py_def, 'text', None)
                    collapsed = getattr(py_def, 'collapsed', True)
                    children = getattr(py_def, 'children', [])
                    on_switch_click = getattr(py_def, 'on_switch_click', None)
                    link_alias = getattr(py_def, 'link_alias', None)

                    if not key or not text:
                        continue

                    if key not in plugin._es_expanded_states:
                        plugin._es_expanded_states[key] = not collapsed

                    child_list = []
                    child_data = []
                    for child in children:
                        child_key = getattr(child, 'key', None)
                        child_text = getattr(child, 'text', None)
                        child_default = getattr(child, 'default', False)
                        child_subtext = getattr(child, 'subtext', None)
                        child_icon = getattr(child, 'icon', None)
                        child_on_change = getattr(child, 'on_change', None)
                        child_link_alias = getattr(child, 'link_alias', None)
                        if child_key:
                            child_list.append((child_key, child_default))
                            plugin._es_children_defaults[child_key] = child_default
                            if child_on_change:
                                plugin._es_children_callbacks[child_key] = child_on_change
                            child_data.append({
                                'key': child_key,
                                'text': child_text,
                                'default': child_default,
                                'subtext': child_subtext,
                                'icon': child_icon,
                                'on_change': child_on_change,
                                'link_alias': child_link_alias
                            })

                    plugin._es_children_map[key] = child_list
                    plugin._es_children_data[key] = child_data
                    plugin._es_switch_callbacks[key] = on_switch_click

                    main_switch = SwitchSetting(key, text, False, None, None, None, None, link_alias)
                    new_items.append(main_switch)
                else:
                    if result_idx < result.size():
                        existing = result.get(result_idx)
                        new_items.append(existing)
                        result_idx += 1

            result.clear()
            for item in new_items:
                result.add(item)

        except Exception:
            pass


class _ESFillItemsHook:
    def __init__(self, plugin):
        self.plugin_ref = weakref.ref(plugin)

    def after_hooked_method(self, param):
        plugin = self.plugin_ref()
        if not plugin:
            return
        try:
            items = param.args[0]
            activity = param.thisObject

            plugin_obj = get_private_field(activity, 'plugin')
            if not plugin_obj:
                return
            plugin_id = plugin_obj.getId()

            from com.exteragram.messenger.plugins import PluginsController
            from com.exteragram.messenger.plugins.models import SwitchSetting
            from android_utils import OnClickListener
            UItem = jclass("org.telegram.ui.Components.UItem")

            i = 0
            while i < items.size():
                item = items.get(i)
                if not item or not hasattr(item, 'settingItem') or not item.settingItem:
                    i += 1
                    continue

                setting = item.settingItem
                if not isinstance(setting, SwitchSetting):
                    i += 1
                    continue

                key = str(setting.key) if hasattr(setting, 'key') else None
                if not key:
                    i += 1
                    continue

                if key in plugin._es_children_map:
                    children = plugin._es_children_map[key]
                    is_expanded = plugin._es_is_expanded(key)
                    checked_count = 0
                    total_count = len(children)

                    for child_key, child_default in children:
                        if PluginsController.getInstance().getPluginSettingBoolean(plugin_id, child_key, child_default):
                            checked_count += 1

                    subtext = f"{checked_count}/{total_count}"
                    is_checked = checked_count > 0

                    def make_switch_click_handler(pid, child_list, act, cb):
                        def handler(view):
                            currently_any_checked = False
                            for ck, cd in child_list:
                                if PluginsController.getInstance().getPluginSettingBoolean(pid, ck, cd):
                                    currently_any_checked = True
                                    break
                            new_val = not currently_any_checked
                            for ck, _ in child_list:
                                PluginsController.getInstance().setPluginSetting(pid, ck, new_val)
                            if cb:
                                try:
                                    cb(view)
                                except:
                                    pass
                            lv = get_private_field(act, 'listView')
                            if lv and hasattr(lv, 'adapter'):
                                lv.adapter.update(True)
                        return handler

                    callback = plugin._es_switch_callbacks.get(key)
                    click_handler = make_switch_click_handler(plugin_id, children, activity, callback)
                    click_listener = OnClickListener(click_handler)

                    new_item = UItem.asExteraExpandableSwitch(
                        item.id,
                        setting.text,
                        subtext,
                        click_listener
                    )
                    new_item.setChecked(is_checked)
                    new_item.setCollapsed(not is_expanded)
                    new_item.settingItem = setting

                    plugin._es_id_to_key[item.id] = key
                    items.set(i, new_item)

                    if is_expanded:
                        child_data_list = plugin._es_children_data.get(key, [])
                        insert_idx = i + 1
                        for cd in child_data_list:
                            child_key = cd['key']
                            child_text = cd['text']
                            child_default = cd['default']
                            child_link_alias = cd.get('link_alias')
                            child_icon = cd.get('icon')
                            child_on_change = cd.get('on_change')
                            if child_key and child_text:
                                child_checked = PluginsController.getInstance().getPluginSettingBoolean(plugin_id, child_key, child_default)
                                checkbox_item = UItem.asRoundCheckbox(hash(child_key) & 0x7FFFFFFF, child_text)
                                checkbox_item.setChecked(child_checked)
                                checkbox_item.pad()
                                checkbox_item.object2 = child_key
                                child_setting = SwitchSetting(child_key, child_text, child_default, None, child_icon, child_on_change, None, child_link_alias)
                                checkbox_item.settingItem = child_setting
                                items.add(insert_idx, checkbox_item)
                                insert_idx += 1
                        i = insert_idx
                    else:
                        i += 1
                else:
                    i += 1

        except Exception:
            pass


class _ESOnClickHook:
    def __init__(self, plugin):
        self.plugin_ref = weakref.ref(plugin)

    def before_hooked_method(self, param):
        plugin = self.plugin_ref()
        if not plugin:
            return
        try:
            item = param.args[0]
            view = param.args[1]
            if not item:
                return

            item_id = item.id
            if item_id in plugin._es_id_to_key:
                key = plugin._es_id_to_key[item_id]
                item.setCollapsed(not plugin._es_is_expanded(key))
                plugin._es_toggle_expanded(key)

                activity = param.thisObject
                listView = get_private_field(activity, 'listView')
                if listView and hasattr(listView, 'adapter'):
                    listView.adapter.update(True)
                param.setResult(None)
                return

            child_key = None
            if hasattr(item, 'object2') and item.object2:
                child_key = str(item.object2)

            if child_key and child_key in plugin._es_children_defaults:
                from com.exteragram.messenger.plugins import PluginsController
                from org.telegram.ui.Cells import CheckBoxCell
                activity = param.thisObject
                plugin_obj = get_private_field(activity, 'plugin')
                if plugin_obj:
                    plugin_id = plugin_obj.getId()
                    child_default = plugin._es_children_defaults.get(child_key, False)
                    current = PluginsController.getInstance().getPluginSettingBoolean(plugin_id, child_key, child_default)
                    new_val = not current
                    PluginsController.getInstance().setPluginSetting(plugin_id, child_key, new_val)
                    on_change = plugin._es_children_callbacks.get(child_key)
                    if on_change:
                        try:
                            on_change(new_val)
                        except:
                            pass
                    if isinstance(view, CheckBoxCell):
                        view.setChecked(new_val, True)
                    listView = get_private_field(activity, 'listView')
                    if listView and hasattr(listView, 'adapter'):
                        listView.adapter.update(True)
                    param.setResult(None)
                    return

        except Exception:
            pass


QuantaHut._setup_expandable_switch = _setup_expandable_switch
QuantaHut._es_toggle_expanded = _es_toggle_expanded
QuantaHut._es_is_expanded = _es_is_expanded
