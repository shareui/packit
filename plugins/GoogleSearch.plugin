import requests
from base_plugin import BasePlugin, HookResult, HookStrategy
from client_utils import run_on_queue, send_message, get_send_messages_helper
import os
import uuid
import re
from ui.settings import Switch, Selector, Input, Text, Header, Divider

__id__ = "google_search"
__name__ = "Google Search"
__description__ = "Searching for information via Google [.g], searching pic's via Google [.gi]"
__author__ = "ÑĞµĞ¼ÑÑ‚ĞµÑ‡"
__min_version__ = "11.12.0"
__version__ = "1.0"
__icon__ = "googleemojikaif/0"

#api ĞºĞ»ÑÑ‡Ğ¸
GOOGLE_API_KEY = "AIzaSyBIfmOC77W907oVKw9vMTLgdOgdM2kjQXE"
GOOGLE_CX = "65c56934c80f0453a"
API_BASE_URL = "https://www.googleapis.com/customsearch/v1"

class GoogleSearch:
    def __init__(self):
        self.history = []
        
    def search(self, query):
        try:
            params = {
                "key": GOOGLE_API_KEY,
                "cx": GOOGLE_CX,
                "q": query,
                "num": 5  
            }
            
            response = requests.get(API_BASE_URL, params=params)
            response.raise_for_status()
            
            data = response.json()
            
            if "items" in data:
                results = []
                for item in data["items"]:
                    title = item.get("title", "Ğ‘ĞµĞ· Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ")
                    snippet = item.get("snippet", "ĞĞµÑ‚ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ")
                    link = item.get("link", "")
                    
                    results.append(f"ğŸ“ {title}\nğŸ“ {snippet}\nğŸ”— {link}\n")
                
                result_text = "\n".join(results)
                self.history.append({"query": query, "results": result_text})
                return f"ğŸ” Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ğ¿Ğ¾Ğ¸ÑĞºĞ°:\n\n{result_text}"
            return "ĞŸĞ¾ Ğ²Ğ°ÑˆĞµĞ¼Ñƒ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑƒ Ğ½Ğ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾"
            
        except Exception as e:
            print(f"ĞÑˆĞ¸Ğ±ĞºĞ° Google API: {str(e)}")
            return None

    def search_images(self, query):
        try:
            params = {
                "key": GOOGLE_API_KEY,
                "cx": GOOGLE_CX,
                "q": query,
                "num": 5,
                "searchType": "image"
            }
            response = requests.get(API_BASE_URL, params=params)
            response.raise_for_status()
            data = response.json()
            if "items" in data:
                return data["items"]  # Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ ÑĞ¿Ğ¸ÑĞ¾Ğº ĞºĞ°Ñ€Ñ‚Ğ¸Ğ½Ğ¾Ğº
            return []
        except Exception as e:
            print(f"ĞÑˆĞ¸Ğ±ĞºĞ° Google Image API: {str(e)}")
            return []

    def download_image(self, url, save_dir):
        try:
            if not os.path.exists(save_dir):
                os.makedirs(save_dir)
            filename = f"google_img_{uuid.uuid4()}.jpg"
            save_path = os.path.join(save_dir, filename)
            response = requests.get(url, stream=True, timeout=15)
            if response.status_code != 200:
                error_msg = f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ: ĞºĞ¾Ğ´ {response.status_code}"
                print(error_msg)
                return None, error_msg
            content_type = response.headers.get('Content-Type', '')
            if not content_type.startswith('image/'):
                error_msg = "URL Ğ½Ğµ Ğ²ĞµÑ€Ğ½ÑƒĞ» Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ"
                print(error_msg)
                return None, error_msg
            with open(save_path, 'wb') as f:
                wrote = False
                for chunk in response.iter_content(chunk_size=8192):
                    if chunk:
                        f.write(chunk)
                        wrote = True
                if not wrote:
                    error_msg = "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ñ„Ğ°Ğ¹Ğ» Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ"
                    print(error_msg)
                    return None, error_msg
            if not os.path.exists(save_path) or os.path.getsize(save_path) == 0:
                error_msg = "Ğ¤Ğ°Ğ¹Ğ» Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ Ğ½Ğµ ÑĞ¾Ğ·Ğ´Ğ°Ğ½ Ğ¸Ğ»Ğ¸ Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹"
                print(error_msg)
                return None, error_msg
            return save_path, None
        except Exception as e:
            error_msg = f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑĞºĞ°Ñ‡Ğ¸Ğ²Ğ°Ğ½Ğ¸Ğ¸ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ: {e}"
            print(error_msg)
            return None, error_msg

class GoogleSearchPlugin(BasePlugin):
    priority = 1 # Ğ¸Ğ»Ğ¸ Ğ´Ñ€ÑƒĞ³Ğ¾Ğµ Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ

    def __init__(self):
        super().__init__()
        self.searcher = GoogleSearch()

    @classmethod
    def settings(cls):
        return [
            Switch(
                key="safe_search",
                text="Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ñ‹Ğ¹ Ğ¿Ğ¾Ğ¸ÑĞº (SafeSearch)",
                default=True,
                subtext="Ğ‘Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ½ĞµĞ¿Ñ€Ğ¸ÑÑ‚Ğ¾Ğ¹Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹"
            ),
            Selector(
                key="num_results",
                text="ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ²",
                default=5,
                items=[str(i) for i in range(1, 11)],
                icon=None
            ),
            Input(
                key="lang",
                text="Ğ¯Ğ·Ñ‹Ğº (lr)",
                default="lang_ru",
                subtext="ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: lang_ru, lang_en"
            ),
            Input(
                key="country",
                text="Ğ¡Ñ‚Ñ€Ğ°Ğ½Ğ° (cr)",
                default="countryRU",
                subtext="ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: countryRU, countryUS"
            ),
            Selector(
                key="sort",
                text="Ğ¡Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºĞ°",
                default=0,
                items=["", "date"],
                icon=None
            ),
            Input(
                key="file_type",
                text="Ğ¢Ğ¸Ğ¿ Ñ„Ğ°Ğ¹Ğ»Ğ° (fileType)",
                default="",
                subtext="ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: pdf, docx, txt"
            ),
            Input(
                key="site_search",
                text="ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾ ÑĞ°Ğ¹Ñ‚Ñƒ (siteSearch)",
                default="",
                subtext="ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: wikipedia.org"
            ),
            Input(
                key="exact_terms",
                text="Ğ¢Ğ¾Ñ‡Ğ½Ğ¾Ğµ ÑĞ¾Ğ²Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ğµ (exactTerms)",
                default="",
                subtext="ĞšĞ»ÑÑ‡ĞµĞ²Ğ¾Ğµ ÑĞ»Ğ¾Ğ²Ğ¾ Ğ´Ğ»Ñ Ñ‚Ğ¾Ñ‡Ğ½Ğ¾Ğ³Ğ¾ ÑĞ¾Ğ²Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ñ"
            )
        ]

    @classmethod
    def create_settings(cls):
        return cls.settings()

    def get_search_params(self, query, search_type=None):
        params = {
            "key": GOOGLE_API_KEY,
            "cx": GOOGLE_CX,
            "q": query,
            "num": int(self.get_setting("num_results", 5)),
        }
        lang = self.get_setting("lang", "lang_ru")
        if lang:
            params["lr"] = lang
        country = self.get_setting("country", "countryRU")
        if country:
            params["cr"] = country
        sort = ["", "date"][self.get_setting("sort", 0)]
        if sort:
            params["sort"] = sort
        file_type = self.get_setting("file_type", "")
        if file_type:
            params["fileType"] = file_type
        site_search = self.get_setting("site_search", "")
        if site_search:
            params["siteSearch"] = site_search
        exact_terms = self.get_setting("exact_terms", "")
        if exact_terms:
            params["exactTerms"] = exact_terms
        if search_type == "image":
            params["searchType"] = "image"
        return params

    def is_obscene(self, query):
        obscene_words = [
            "Ğ¿Ğ¾Ñ€Ğ½Ğ¾", "sex", "ÑĞµĞºÑ", "ÑÑ€Ğ¾Ñ‚Ğ¸ĞºĞ°", "porn", "xxx", "Ğ³ĞµĞ¹", "Ğ»ĞµÑĞ±Ğ¸", "anal", "Ğ°Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹", "oral", "Ğ¾Ñ€Ğ³Ğ°Ğ·Ğ¼", "ÑÑ€ĞµĞºÑ†Ğ¸Ñ", "ÑÑ€Ğ¾Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹", "ÑÑ€Ğ¾Ñ‚Ğ¸ĞºĞ°", "Ğ¶Ğ¾Ğ¿Ğ°", "ÑĞ¸ÑÑŒĞºĞ¸", "Ñ‡Ğ»ĞµĞ½", "Ğ¿ĞµĞ½Ğ¸Ñ", "Ğ²Ğ°Ğ³Ğ¸Ğ½Ğ°", "vagina", "dick", "pussy", "cum", "orgasm", "masturb", "masturbation", "masturbate"
        ]
        q = query.lower()
        return any(word in q for word in obscene_words)

    def process_query(self, query, peer):
        params = self.get_search_params(query)
        num_results = int(self.get_setting("num_results", 5))
        try:
            response = requests.get(API_BASE_URL, params=params)
            response.raise_for_status()
            data = response.json()
            if "items" in data:
                results = []
                for item in data["items"][:num_results]:
                    title = item.get("title", "Ğ‘ĞµĞ· Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ")
                    snippet = item.get("snippet", "ĞĞµÑ‚ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ")
                    link = item.get("link", "")
                    results.append(f"ğŸ“ {title}\nğŸ“ {snippet}\nğŸ”— {link}\n")
                result_text = "\n".join(results)
                self.searcher.history.append({"query": query, "results": result_text})
                message = f"ğŸ” Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ğ¿Ğ¾Ğ¸ÑĞºĞ°:\n\n{result_text}"
            else:
                message = "ĞŸĞ¾ Ğ²Ğ°ÑˆĞµĞ¼Ñƒ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑƒ Ğ½Ğ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾"
        except Exception as e:
            print(f"ĞÑˆĞ¸Ğ±ĞºĞ° Google API: {str(e)}")
            message = "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğ¸ Ğ¿Ğ¾Ğ¸ÑĞºĞ°"
        params = {
            "message": message,
            "peer": peer
        }
        send_message(params)

    def process_image_query(self, query, peer):
        params = self.get_search_params(query, search_type="image")
        try:
            response = requests.get(API_BASE_URL, params=params)
            response.raise_for_status()
            data = response.json()
            items = data.get("items", [])
        except Exception as e:
            print(f"ĞÑˆĞ¸Ğ±ĞºĞ° Google Image API: {str(e)}")
            items = []
        if not items:
            message = "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ğ¿Ğ¾Ğ¸ÑĞºĞ° ĞºĞ°Ñ€Ñ‚Ğ¸Ğ½Ğ¾Ğº"
            params = {
                "message": message,
                "peer": peer
            }
            send_message(params)
            return
        send_helper = get_send_messages_helper()
        save_dir = "/storage/emulated/0/Download/google_images"
        item = items[0]
        image_url = item.get("link")
        if image_url:
            image_path, error = self.searcher.download_image(image_url, save_dir)
            if image_path:
                generated_photo = send_helper.generatePhotoSizes(image_path, None)
                if generated_photo:
                    message = f"Ğ˜ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº: {image_url}"
                    params = {
                        "photos": [generated_photo],
                        "peer": peer,
                        "message": message
                    }
                    send_message(params)
                    return
        message = "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ½Ğ°Ğ¹Ñ‚Ğ¸ Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ ĞºĞ°Ñ€Ñ‚Ğ¸Ğ½ĞºÑƒ"
        params = {
            "message": message,
            "peer": peer
        }
        send_message(params)

    def on_send_message_hook(self, account, params) -> HookStrategy:
        if not isinstance(params.message, str):
            return HookResult()
        if params.message.startswith(".g ") or params.message.startswith(".gi "):
            try:
                parts = params.message.strip().split(" ", 1)
                if len(parts) < 2 or not parts[1].strip():
                    params.message = f"Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ: {parts[0]} [Ğ¿Ğ¾Ğ¸ÑĞºĞ¾Ğ²Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ]"
                    return HookResult(strategy=HookStrategy.MODIFY, params=params)
                query = parts[1].strip()
                safe_search = self.get_setting("safe_search", True)
                if safe_search and self.is_obscene(query):
                    params.message = "Ğ—Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ°Ğ¼Ğ¸ Ğ¿Ğ¾Ğ¸ÑĞºĞ°"
                    return HookResult(strategy=HookStrategy.MODIFY, params=params)
                if params.message.startswith(".g "):
                    run_on_queue(lambda: self.process_query(query, params.peer))
                else:
                    run_on_queue(lambda: self.process_image_query(query, params.peer))
                return HookResult(strategy=HookStrategy.CANCEL)
            except Exception as e:
                print(f"Google Search plugin error: {str(e)}")
                params.message = f"ĞÑˆĞ¸Ğ±ĞºĞ°: {str(e)}"
                return HookResult(strategy=HookStrategy.MODIFY, params=params)
        return HookResult()

    def on_plugin_load(self):
        self.add_on_send_message_hook(priority=self.priority)