__id__ = "all_mention"
__name__ = "all mention"
__author__ = "@pluginsnerex, @Nekn3n"
__version__ = "4.2.0"
__description__ = """–ü–ª–∞–≥–∏–Ω –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –∏ –≥–∏–±–∫–æ–≥–æ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –ü—Ä–æ—Å—Ç –≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏, –ª–µ–≥–∫–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è, –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∑–∞–π–¥–∏—Ç–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–æ–¥ —Å–µ–±—è, —É–ø–æ–º–∏–Ω–∞–π—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ –≤–µ–¥—å –º–æ–∂–µ—Ç –∑–∞–±–∞–≥–∞—Ç—å—Å—è –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π."""

# -*- coding: utf-8 -*-
# —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –≤ Plugin IDE - @PluginIDE

__icon__ = "SoLo_HaMiD/33"
__min_version__ = "11.12.0"

import threading
import time
import traceback
import re
import random
from typing import Any, Dict, List, Set, Optional, Tuple, Callable

from base_plugin import BasePlugin, HookResult, HookStrategy
from client_utils import send_message, send_request, get_messages_controller, get_user_config
from ui.settings import Header, Selector, Switch, Input, Divider
from ui.bulletin import BulletinHelper
from org.telegram.tgnet import TLRPC
from org.telegram.messenger import LocaleController, ChatObject
from markdown_utils import parse_markdown
from java.util import ArrayList

# –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–æ –∏–∑–±–µ–∂–∞–Ω–∏–µ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏
MAX_PARTICIPANTS_LIMIT = 10000
# –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Å–∏–º–≤–æ–ª–∞—Ö (UTF-16)
TELEGRAM_MESSAGE_LIMIT = 4096
# –ß–∞—Å—Ç–æ—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–±–æ—Ä–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (–∫–∞–∂–¥—ã–µ N —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤)
BULLETIN_UPDATE_FREQUENCY = 1000

class AllMentionUltimaPlugin(BasePlugin):
    """
    –ü–ª–∞–≥–∏–Ω –¥–ª—è —É–ø–æ–º–∏–Ω–∞–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —á–∞—Ç–∞ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏.
    """
    def __init__(self):
        super().__init__()
        self._stop_events_lock = threading.Lock()
        self._stop_events: Dict[int, threading.Event] = {}
        self._parsed_exceptions: Tuple[Set[str], Set[str]] = (set(), set())

        # –ö–∞—Ä—Ç–∞ —Ñ—É–Ω–∫—Ü–∏–π-—Ñ–∏–ª—å—Ç—Ä–æ–≤ –¥–ª—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        self.filter_functions: Dict[str, Callable[[TLRPC.User, Any, Set[int]], bool]] = {
            'a': self._is_admin_filter,
            'o': lambda user, p, c_ids: self._is_user_online(user),
            'f': lambda user, p, c_ids: not self._is_user_online(user),
            'c': self._is_contact_filter,
        }

    def on_plugin_load(self):
        """–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–ª–∞–≥–∏–Ω–∞."""
        self.add_on_send_message_hook()
        self._update_parsed_settings()
        self.log(f"[{__name__}] –ø–ª–∞–≥–∏–Ω –∑–∞–≥—Ä—É–∂–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ.")

    def on_plugin_unload(self):
        """–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –≤—ã–≥—Ä—É–∑–∫–µ –ø–ª–∞–≥–∏–Ω–∞, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏."""
        with self._stop_events_lock:
            for event in self._stop_events.values():
                event.set()
            self._stop_events.clear()
        self.log(f"[{__name__}] –ø–ª–∞–≥–∏–Ω –≤—ã–≥—Ä—É–∂–µ–Ω.")

    def _log_error(self, message: str, error: Exception):
        """–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –æ—à–∏–±–æ–∫."""
        self.log(f"{message}: {error}\n{traceback.format_exc()}")

    def _update_parsed_settings(self, value: Optional[str] = None):
        """–ü–∞—Ä—Å–∏—Ç –∏ –∫—ç—à–∏—Ä—É–µ—Ç —Å–ø–∏—Å–æ–∫ –∏—Å–∫–ª—é—á–µ–Ω–∏–π –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π."""
        exceptions_str = value if value is not None else self.get_setting("exceptions_list", "")
        usernames, user_ids = set(), set()
        username_regex_pi = re.compile(r"^[a-zA-Z0-9_]{5,32}$")
        for item in exceptions_str.split(','):
            cleaned_item_pi = item.strip().lower()
            if not cleaned_item_pi:
                continue
            if cleaned_item_pi.startswith('@'):
                username = cleaned_item_pi[1:]
                if username_regex_pi.match(username):
                    usernames.add(username)
            elif cleaned_item_pi.isdigit():
                user_ids.add(cleaned_item_pi)
        self._parsed_exceptions = (user_ids, usernames)

    def create_settings(self) -> List[Any]:
        """–°–æ–∑–¥–∞–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–ª–∞–≥–∏–Ω–∞."""
        lang = LocaleController.getInstance().getCurrentLocale().getLanguage()
        is_ru = lang.startswith("ru")

        cmds_pi = {k: self.get_setting(f"{k}_command", d) for k, d in [
            ("all", ".all"), ("admins", ".all admins"), ("random", ".all random"),
            ("silent", ".all night"), ("online", ".all online"), ("offline", ".all offline"),
            ("contacts", ".all contacts"), ("all_stop", ".all stop")
        ]}
        
        help_text_pi = (
            "–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:\n"
            "<–∫–æ–º–∞–Ω–¥–∞> [—Ç–µ–∫—Å—Ç] [—á–∏—Å–ª–æ-–ª–∏–º–∏—Ç]\n\n"
            "–ü—Ä–∏–º–µ—Ä—ã –∫–æ–º–∞–Ω–¥ (–º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –≤—ã—à–µ):\n\n"
            f"‚Ä¢ `{cmds_pi['all']}` - —É–ø–æ–º—è–Ω—É—Ç—å –≤—Å–µ—Ö\n"
            f"‚Ä¢ `{cmds_pi['admins']}` - —É–ø–æ–º—è–Ω—É—Ç—å –∞–¥–º–∏–Ω–æ–≤\n"
            f"‚Ä¢ `{cmds_pi['contacts']}` - —É–ø–æ–º—è–Ω—É—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤\n"
            f"‚Ä¢ `{cmds_pi['random']} 5` - —É–ø–æ–º—è–Ω—É—Ç—å 5 —Å–ª—É—á–∞–π–Ω—ã—Ö\n"
            f"‚Ä¢ `{cmds_pi['online']}` - —É–ø–æ–º—è–Ω—É—Ç—å —Ç–µ—Ö, –∫—Ç–æ –æ–Ω–ª–∞–π–Ω\n"
            f"‚Ä¢ `{cmds_pi['offline']}` - —É–ø–æ–º—è–Ω—É—Ç—å —Ç–µ—Ö, –∫—Ç–æ –æ—Ñ—Ñ–ª–∞–π–Ω\n"
            f"‚Ä¢ `{cmds_pi['silent']}` - —É–ø–æ–º—è–Ω—É—Ç—å –≤—Å–µ—Ö –±–µ–∑ @ (—Ç–∏—Ö–æ)\n"
            f"‚Ä¢ `{cmds_pi['all_stop']}` - –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ\n\n"
            "–¢–µ–∫—Å—Ç –∏ –ª–∏–º–∏—Ç –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –∫ –ª—é–±–æ–π –∫–æ–º–∞–Ω–¥–µ." if is_ru else
            "How to use:\n"
            "<command> [text] [number-limit]\n\n"
            "Command examples (editable above):\n\n"
            f"‚Ä¢ `{cmds_pi['all']}` - mention all\n"
            f"‚Ä¢ `{cmds_pi['admins']}` - mention admins\n"
            f"‚Ä¢ `{cmds_pi['contacts']}` - mention contacts\n"
            f"‚Ä¢ `{cmds_pi['random']} 5` - mention 5 random\n"
            f"‚Ä¢ `{cmds_pi['online']}` - mention online users\n"
            f"‚Ä¢ `{cmds_pi['offline']}` - mention offline users\n"
            f"‚Ä¢ `{cmds_pi['silent']}` - mention all without @ (silent)\n"
            f"‚Ä¢ `{cmds_pi['all_stop']}` - stop the mention\n\n"
            "Text and limit can be added to any command."
        )
        send_mode_items_pi = ["–ß–∞—Å—Ç—è–º–∏ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)", "–û–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º", "–¶–∏–∫–ª–∏—á–Ω–æ"] if is_ru else ["In parts (recommended)", "Single message", "Cyclic"]
        
        settings_list = [
            Header("–û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏" if is_ru else "Main Settings"),
            Input(key="all_command", text="–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –≤—Å–µ—Ö" if is_ru else "All command", default=".all", icon="msg_edit"),
            Input(key="admins_command", text="–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤" if is_ru else "Admins command", default=".all admins", icon="msg_admins"),
            Input(key="contacts_command", text="–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤" if is_ru else "Contacts command", default=".all contacts", icon="msg_contacts"),
            Input(key="random_command", text="–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —Å–ª—É—á–∞–π–Ω—ã—Ö" if is_ru else "Random command", default=".all random", icon="msg_rate_up"),
            Input(key="online_command", text="–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –æ–Ω–ª–∞–π–Ω" if is_ru else "Online command", default=".all online", icon="msg_online"),
            Input(key="offline_command", text="–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –æ—Ñ—Ñ–ª–∞–π–Ω" if is_ru else "Offline command", default=".all offline", icon="msg_contacts_time"),
            Input(key="silent_command", text="–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —Ç–∏—Ö–∏—Ö" if is_ru else "Silent command", default=".all night", icon="msg_bell_mute"),
            Input(key="all_stop_command", text="–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏" if is_ru else "Stop command", default=".all stop", icon="msg_pollstop"),
            Divider(), Header("–û–±—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã" if is_ru else "General Parameters"),
            Input(key="default_header", text="–ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é" if is_ru else "Default Header", default="üîî –û–±—â–∏–π —Å–±–æ—Ä!", icon="msg_topic_create"),
            Selector(key="send_mode", text="–†–µ–∂–∏–º –æ—Ç–ø—Ä–∞–≤–∫–∏" if is_ru else "Send Mode", items=send_mode_items_pi, default=0, icon="msg_share"),
            Input(key="message_delay", text="–ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ (—Å–µ–∫)" if is_ru else "Delay between messages (sec)", default="1.5", icon="msg_recent"),
        ]

        if self.get_setting("send_mode", 0) == 2:
            header_text_pi = "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¶–∏–∫–ª–∏—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞" if is_ru else "Cyclic Mode Settings"
            settings_list.extend([
                Divider(), Header(header_text_pi),
                Input(key="batch_mode_sequence", text="–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É–ø–æ–º–∏–Ω–∞–Ω–∏–π" if is_ru else "Mention sequence", subtext="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–ø–æ–º–∏–Ω–∞–Ω–∏–π –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏, —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é: 3,4,5" if is_ru else "Mentions per message, comma-separated: 3,4,5", default="3,4,5", icon="msg_stats"),
                Switch(key="batch_mode_repeat", text="–ü–æ–≤—Ç–æ—Ä—è—Ç—å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å" if is_ru else "Repeat sequence", subtext="–ï—Å–ª–∏ –≤—ã–∫–ª, –ø–æ—Å–ª–µ–¥–Ω—è—è —Ü–∏—Ñ—Ä–∞ –±—É–¥–µ—Ç –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö" if is_ru else "If off, the last number will be used for the rest", default=True, icon="msg_retry"),
            ])
        
        no_username_items_pi = [
            "–ü—Ä–æ–ø—É—Å–∫–∞—Ç—å",
            "–ò–º—è (–≤ –≤–∏–¥–µ —Å—Å—ã–ª–∫–∏)",
            "–ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ + –ò–º—è"
        ] if is_ru else [
            "Skip",
            "Name (as link)",
            "Direct link + Name"
        ]

        settings_list.extend([
            Divider(), Header("–°—Ç–∏–ª—å –∏ —Ñ–∏–ª—å—Ç—Ä—ã" if is_ru else "Style & Filters"),
            Switch(key="exclude_admins", text="–ò—Å–∫–ª—é—á–∏—Ç—å –∞–¥–º–∏–Ω–æ–≤" if is_ru else "Exclude admins", subtext="–ù–µ —É–ø–æ–º–∏–Ω–∞—Ç—å –∞–¥–º–∏–Ω–æ–≤ (–∫—Ä–æ–º–µ –∫–æ–º–∞–Ω–¥—ã –∞–¥–º–∏–Ω–æ–≤)" if is_ru else "Don't mention admins (except for admins command)", default=True, icon="msg_admin_add"),
            Input(key="exceptions_list", text="–ò—Å–∫–ª—é—á–µ–Ω–∏—è (ID/Username)" if is_ru else "Exceptions (ID/Username)", subtext="–ß–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é: 12345, @username, 67890" if is_ru else "Comma-separated: 12345, @username, 67890", on_change=self._update_parsed_settings, icon="msg_user_remove"),
            Selector(key="silent_name_style", text="–°—Ç–∏–ª—å '—Ç–∏—Ö–∏—Ö' —É–ø–æ–º–∏–Ω–∞–Ω–∏–π" if is_ru else "Silent mention style", items=["–ò–º—è –∏ —Ñ–∞–º–∏–ª–∏—è", "–¢–æ–ª—å–∫–æ –∏–º—è"] if is_ru else ["First and last name", "First name only"], default=0, icon="msg_contacts"),
            Divider(text="–ö–∞–∫ —É–ø–æ–º–∏–Ω–∞—Ç—å —Ç–µ—Ö, —É –∫–æ–≥–æ –Ω–µ—Ç —é–∑–µ—Ä–Ω–µ–π–º–∞" if is_ru else "How to mention users with no username"),
            Selector(
                key="no_username_mode", 
                text="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–µ–∑ @username" if is_ru else "Users without @username",
                items=no_username_items_pi,
                default=1,
                icon="msg_filled_menu_users"
            ),
            Switch(key="mention_deleted", text="–£–ø–æ–º–∏–Ω–∞—Ç—å —É–¥–∞–ª–µ–Ω–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã" if is_ru else "Mention deleted accounts", default=False, icon="msg_delete"),
            Switch(key="include_bots", text="–£–ø–æ–º–∏–Ω–∞—Ç—å –±–æ—Ç–æ–≤" if is_ru else "Mention bots", default=False, icon="input_bot1"),
            Divider(text=help_text_pi)
        ])
        return settings_list

    def _escape_link_text(self, text: str) -> str:
        """–≠–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã Markdown ('_', '[', ']') –≤ —Ç–µ–∫—Å—Ç–µ."""
        if not text:
            return ""
        # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Å–∏–º–≤–æ–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ–≤–µ—Ä–Ω–æ –∏—Å—Ç–æ–ª–∫–æ–≤–∞–Ω—ã –ø–∞—Ä—Å–µ—Ä–æ–º
        return text.replace('_', '\\_').replace('[', '\\[').replace(']', '\\]')

    def _send_markdown_message(self, peer_id: int, text: str):
        """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å Markdown —Ä–∞–∑–º–µ—Ç–∫–æ–π, —Å —Ñ–æ–ª–±—ç–∫–æ–º –Ω–∞ –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç."""
        if not text or not text.strip(): return
        try:
            parsed_pi = parse_markdown(text)
            # –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—ã—á–Ω—ã–π Python list –≤–º–µ—Å—Ç–æ Java ArrayList
            entities_list = []
            for ent in parsed_pi.entities:
                entities_list.append(ent.to_tlrpc_object())
            send_message({"peer": peer_id, "message": parsed_pi.text, "entities": entities_list})
        except Exception as e:
            self._log_error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ Markdown", e)
            BulletinHelper.show_error(f"–û—à–∏–±–∫–∞ Markdown: {e}")
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∫ –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç –≤ —Å–ª—É—á–∞–µ —Å–±–æ—è –ø–∞—Ä—Å–µ—Ä–∞
            send_message({"peer": peer_id, "message": text})

    def _parse_command_args(self, command_body: str) -> Dict[str, Any]:
        """–ü–∞—Ä—Å–∏—Ç –∞—Ä–≥—É–º–µ–Ω—Ç—ã –∫–æ–º–∞–Ω–¥—ã (–ª–∏–º–∏—Ç –∏ —Ç–µ–∫—Å—Ç)."""
        parts = command_body.split()
        limit = None
        if parts and parts[-1].isdigit():
            limit = int(parts.pop(-1))
        header = ' '.join(parts).strip()
        return {"limit": limit, "header": header}

    def on_send_message_hook(self, account: int, params: Any) -> HookResult:
        """–ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–º–∞–Ω–¥."""
        if not hasattr(params, 'message') or not isinstance(params.message, str): return HookResult()
        msg = params.message.strip()
        
        if msg.lower() == self.get_setting("all_stop_command", ".all stop").strip():
            with self._stop_events_lock:
                stop_event = self._stop_events.get(params.peer)
            if stop_event:
                stop_event.set()
                BulletinHelper.show_success("–û—Å—Ç–∞–Ω–æ–≤–∫–∞ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è...")
            else:
                BulletinHelper.show_info("–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —É–ø–æ–º–∏–Ω–∞–Ω–∏–π –≤ —ç—Ç–æ–º —á–∞—Ç–µ.")
            return HookResult(strategy=HookStrategy.CANCEL)

        commands_map = {
            self.get_setting(k, d).strip(): f for k, d, f in [
                ("admins_command", ".all admins", 'a'), ("random_command", ".all random", 'r'),
                ("online_command", ".all online", 'o'), ("offline_command", ".all offline", 'f'),
                ("silent_command", ".all night", 's'), ("contacts_command", ".all contacts", 'c'),
                ("all_command", ".all", None)
            ]
        }
        
        for cmd_prefix, filter_char in sorted(commands_map.items(), key=len, reverse=True):
            if msg.lower().startswith(cmd_prefix):
                with self._stop_events_lock:
                    if params.peer in self._stop_events:
                        BulletinHelper.show_error("–£–ø–æ–º–∏–Ω–∞–Ω–∏–µ —É–∂–µ –∑–∞–ø—É—â–µ–Ω–æ –≤ —ç—Ç–æ–º —á–∞—Ç–µ.")
                        return HookResult(strategy=HookStrategy.CANCEL)
                    stop_event = threading.Event()
                    self._stop_events[params.peer] = stop_event

                command_body_pi = msg[len(cmd_prefix):].strip()
                parsed_args = self._parse_command_args(command_body_pi)
                parsed_args['filters'] = {filter_char} if filter_char else set()
                
                threading.Thread(target=self._process_chat_command, args=(params.peer, parsed_args, stop_event), daemon=True).start()
                return HookResult(strategy=HookStrategy.CANCEL)
        
        return HookResult()
        
    def _process_chat_command(self, peer_id: int, parsed_args: Dict, stop_event: threading.Event):
        """–û—Å–Ω–æ–≤–Ω–æ–π —Ä–∞–±–æ—á–∏–π –ø—Ä–æ—Ü–µ—Å—Å, –∑–∞–ø—É—Å–∫–∞–µ–º—ã–π –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ."""
        try:
            if 'c' in parsed_args.get('filters', set()):
                self._fetch_contacts_then_participants(peer_id, parsed_args, stop_event)
            else:
                self._fetch_chat_participants_dispatcher(peer_id, parsed_args, stop_event, set())
        except Exception as e:
            self._log_error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ _process_chat_command", e)
            BulletinHelper.show_error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
        finally:
            with self._stop_events_lock:
                if peer_id in self._stop_events:
                    del self._stop_events[peer_id]

    def _fetch_contacts_then_participants(self, peer_id: int, parsed_args: Dict, stop_event: threading.Event):
        """–°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ—Ç ID –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤, –∑–∞—Ç–µ–º –≤—ã–∑—ã–≤–∞–µ—Ç —Å–±–æ—Ä —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —á–∞—Ç–∞."""
        BulletinHelper.show_info("–°–æ–±–∏—Ä–∞—é –∫–æ–Ω—Ç–∞–∫—Ç—ã...")
        def on_response(response, error):
            if stop_event.is_set(): return
            if error:
                self._log_error("–û—à–∏–±–∫–∞ API –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤", error)
                BulletinHelper.show_error(f"–û—à–∏–±–∫–∞ API –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤: {error.text}")
                return
            
            contact_ids_pi = {u.id for u in response.users.toArray()} if response and hasattr(response, 'users') else set()
            self._fetch_chat_participants_dispatcher(peer_id, parsed_args, stop_event, contact_ids_pi)
        send_request(TLRPC.TL_contacts_getContacts(), on_response)

    def _fetch_chat_participants_dispatcher(self, peer_id: int, parsed_args: Dict, stop_event: threading.Event, contact_ids: Set[int]):
        """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø —á–∞—Ç–∞ –∏ –≤—ã–∑—ã–≤–∞–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Å–±–æ—Ä—â–∏–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤."""
        chat = get_messages_controller().getChat(-peer_id)
        if not chat:
            BulletinHelper.show_error("–û—à–∏–±–∫–∞: –ß–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.")
            return

        fetcher = self._fetch_channel_participants if ChatObject.isChannel(chat) else self._fetch_group_participants
        fetcher(peer_id, chat, parsed_args, stop_event, contact_ids)

    def _fetch_channel_participants(self, peer_id: int, chat: TLRPC.Chat, *args):
        """–†–µ–∫—É—Ä—Å–∏–≤–Ω–æ —Å–æ–±–∏—Ä–∞–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∫–∞–Ω–∞–ª–∞ (—Å—É–ø–µ—Ä–≥—Ä—É–ø–ø—ã)."""
        input_channel_pi = get_messages_controller().getInputChannel(chat.id)
        if not input_channel_pi:
            BulletinHelper.show_error("–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å—É–ø–µ—Ä–≥—Ä—É–ø–ø—ã.")
            return
        
        self._fetch_channel_page_recursive(peer_id, input_channel_pi, *args, offset=0, all_users={}, all_participants=[])

    def _fetch_channel_page_recursive(self, peer_id: int, input_channel: TLRPC.InputChannel, parsed_args: Dict, stop_event: threading.Event, contact_ids: Set[int], offset: int, all_users: Dict, all_participants: List):
        """–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ–¥–Ω—É —Å—Ç—Ä–∞–Ω–∏—Ü—É —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∫–∞–Ω–∞–ª–∞."""
        if stop_event.is_set() or offset >= MAX_PARTICIPANTS_LIMIT:
            if offset >= MAX_PARTICIPANTS_LIMIT: BulletinHelper.show_info(f"–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –≤ {MAX_PARTICIPANTS_LIMIT} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.")
            self._process_and_send_mentions(peer_id, all_users, all_participants, parsed_args, stop_event, contact_ids)
            return
        
        req = TLRPC.TL_channels_getParticipants()
        req.channel, req.filter, req.offset, req.limit, req.hash = input_channel, TLRPC.TL_channelParticipantsSearch(), offset, 200, 0
        send_request(req, lambda r, e: self._on_channel_page_response(r, e, peer_id, input_channel, parsed_args, stop_event, contact_ids, offset, all_users, all_participants))

    def _on_channel_page_response(self, response: Any, error: Any, peer_id: int, input_channel: TLRPC.InputChannel, parsed_args: Dict, stop_event: threading.Event, contact_ids: Set[int], offset: int, all_users: Dict, all_participants: List):
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—Ç–≤–µ—Ç —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü–µ–π —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∫–∞–Ω–∞–ª–∞."""
        if stop_event.is_set(): return
        if error:
            self._log_error("–û—à–∏–±–∫–∞ API –∫–∞–Ω–∞–ª–∞", error)
            BulletinHelper.show_error(f"–û—à–∏–±–∫–∞ API –∫–∞–Ω–∞–ª–∞: {error.text}")
            return
        
        if response and hasattr(response, 'users'): all_users.update({u.id: u for u in response.users.toArray()})
        participants_page_pi = list(response.participants.toArray()) if response and hasattr(response, 'participants') else []
        
        old_total = len(all_participants)
        all_participants.extend(participants_page_pi)
        new_total = len(all_participants)
        
        if (new_total // BULLETIN_UPDATE_FREQUENCY) > (old_total // BULLETIN_UPDATE_FREQUENCY):
            BulletinHelper.show_info(f"–°–æ–±–∏—Ä–∞—é —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ ({new_total})...")
        
        if len(participants_page_pi) >= 199 and not stop_event.is_set():
            self._fetch_channel_page_recursive(peer_id, input_channel, parsed_args, stop_event, contact_ids, offset + len(participants_page_pi), all_users, all_participants)
        else:
            self._process_and_send_mentions(peer_id, all_users, all_participants, parsed_args, stop_event, contact_ids)

    def _fetch_group_participants(self, peer_id: int, chat: TLRPC.Chat, parsed_args: Dict, stop_event: threading.Event, contact_ids: Set[int]):
        """–°–æ–±–∏—Ä–∞–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –æ–±—ã—á–Ω–æ–π –≥—Ä—É–ø–ø—ã."""
        BulletinHelper.show_info("–°–æ–±–∏—Ä–∞—é —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≥—Ä—É–ø–ø—ã...")
        def on_response(response, error):
            if stop_event.is_set(): return
            if error:
                self._log_error("–û—à–∏–±–∫–∞ API –≥—Ä—É–ø–ø—ã", error)
                BulletinHelper.show_error(f"–û—à–∏–±–∫–∞ API –≥—Ä—É–ø–ø—ã: {error.text}")
                return
            
            all_users, all_participants = {}, []
            if response and hasattr(response, 'users'): all_users.update({u.id: u for u in response.users.toArray()})
            if response and hasattr(response, 'full_chat') and hasattr(response.full_chat, 'participants'):
                all_participants.extend(list(response.full_chat.participants.participants.toArray()))
            
            self._process_and_send_mentions(peer_id, all_users, all_participants, parsed_args, stop_event, contact_ids)
        send_request(TLRPC.TL_messages_getFullChat(chat_id=chat.id), on_response)

    def _is_admin_filter(self, user: TLRPC.User, participant: Any, contact_ids: Set[int]) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —É—á–∞—Å—Ç–Ω–∏–∫ –∞–¥–º–∏–Ω–æ–º –∏–ª–∏ —Å–æ–∑–¥–∞—Ç–µ–ª–µ–º."""
        return isinstance(participant, (
            TLRPC.TL_channelParticipantAdmin,
            TLRPC.TL_channelParticipantCreator,
            TLRPC.TL_chatParticipantAdmin,
            TLRPC.TL_chatParticipantCreator
        ))

    def _is_user_online(self, user: TLRPC.User) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–Ω–ª–∞–π–Ω –∏–ª–∏ –±—ã–ª –Ω–µ–¥–∞–≤–Ω–æ."""
        if user and user.status:
            return isinstance(user.status, (TLRPC.TL_userStatusOnline, TLRPC.TL_userStatusRecently))
        return False

    def _is_contact_filter(self, user: TLRPC.User, participant: Any, contact_ids: Set[int]) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–æ–Ω—Ç–∞–∫—Ç–æ–º."""
        return user is not None and user.id in contact_ids

    def _process_and_send_mentions(self, peer_id: int, all_users: Dict, all_participants: List, parsed_args: Dict, stop_event: threading.Event, contact_ids: Set[int]):
        """–§–∏–ª—å—Ç—Ä—É–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —Å —É–ø–æ–º–∏–Ω–∞–Ω–∏—è–º–∏."""
        try:
            filters, limit = parsed_args.get('filters', set()), parsed_args.get('limit')
            header_text = parsed_args.get('header') or self.get_setting("default_header", "üîî –û–±—â–∏–π —Å–±–æ—Ä!")
            
            is_silent_mode_pi = 's' in filters
            exclude_admins = self.get_setting("exclude_admins", True) and 'a' not in filters
            include_bots = self.get_setting("include_bots", False)
            mention_deleted = self.get_setting("mention_deleted", False)
            no_username_mode = self.get_setting("no_username_mode", 1)
            silent_name_style = self.get_setting("silent_name_style", 0)

            BulletinHelper.show_info("–§–∏–ª—å—Ç—Ä—É—é —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤...")
            
            my_id_pi = get_user_config().getCurrentUser().id
            filtered_participants_pi = []
            
            user_ids_except, usernames_except = self._parsed_exceptions

            for p in all_participants:
                user_id = getattr(p, 'user_id', None)
                if hasattr(p, 'peer') and hasattr(p.peer, 'user_id'):
                    user_id = p.peer.user_id

                if not user_id: continue

                user = all_users.get(user_id)
                if not user or user.id == my_id_pi: continue
                if user.deleted and not mention_deleted: continue
                if not include_bots and user.bot: continue
                if str(user.id) in user_ids_except: continue
                if user.username and user.username.lower() in usernames_except: continue
                if exclude_admins and self._is_admin_filter(user, p, contact_ids): continue
                
                active_filters = {f for f in filters if f in self.filter_functions}
                if active_filters:
                    if any(self.filter_functions[f_char](user, p, contact_ids) for f_char in active_filters):
                        filtered_participants_pi.append(user)
                else:
                    filtered_participants_pi.append(user)

            if 'r' in filters: random.shuffle(filtered_participants_pi)
            if limit is not None: filtered_participants_pi = filtered_participants_pi[:limit]

            if not filtered_participants_pi:
                BulletinHelper.show_info("–ù–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.")
                return

            mentions = []
            for user in filtered_participants_pi:
                if stop_event.is_set(): return
                
                # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–º—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                name_pi = ""
                if silent_name_style == 0:
                    name_pi = f"{user.first_name or ''} {user.last_name or ''}".strip()
                else:
                    name_pi = user.first_name or ""
                if not name_pi: name_pi = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"

                # –§–æ—Ä–º–∏—Ä—É–µ–º —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Å —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º
                if is_silent_mode_pi:
                    mentions.append(f"[{self._escape_link_text(name_pi)}](tg://user?id={user.id})")
                elif user.username:
                    safe_username = user.username.replace('_', '\\_')
                    mentions.append(f"@{safe_username}")
                elif no_username_mode != 0:
                    escaped_name = self._escape_link_text(name_pi)
                    if no_username_mode == 1: # –ò–º—è (–≤ –≤–∏–¥–µ —Å—Å—ã–ª–∫–∏)
                        mentions.append(f"[{escaped_name}](tg://user?id={user.id})")
                    elif no_username_mode == 2: # –ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ + –ò–º—è
                        mentions.append(f"tg://user?id={user.id} ({escaped_name})")

            if not mentions:
                BulletinHelper.show_info("–ù–µ–∫–æ–≥–æ —É–ø–æ–º–∏–Ω–∞—Ç—å –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏.")
                return

            send_mode = self.get_setting("send_mode", 0)
            delay_pi = float(self.get_setting("message_delay", "1.5"))
            chunks = []
            
            # ( =^.^= ) –º–∏–ª—ã–π –∫–æ—Ç–∏–∫
            if send_mode == 1:
                full_text_pi = " ".join(mentions)
                while len(full_text_pi.encode('utf-16-le')) / 2 > TELEGRAM_MESSAGE_LIMIT - 200:
                    split_point = full_text_pi.rfind(' ', 0, TELEGRAM_MESSAGE_LIMIT - 200)
                    if split_point == -1: split_point = TELEGRAM_MESSAGE_LIMIT - 200
                    chunks.append(full_text_pi[:split_point])
                    full_text_pi = full_text_pi[split_point:].strip()
                chunks.append(full_text_pi)
            elif send_mode == 2:
                seq_pi = [int(i) for i in self.get_setting("batch_mode_sequence", "3,4,5").split(',') if i.strip().isdigit()] or [5]
                repeat, idx, mentions_copy = self.get_setting("batch_mode_repeat", True), 0, list(mentions)
                while mentions_copy:
                    size = seq_pi[idx] if idx < len(seq_pi) else seq_pi[-1]
                    chunks.append(" ".join(mentions_copy[:size]))
                    mentions_copy = mentions_copy[size:]
                    if repeat: idx = (idx + 1) % len(seq_pi)
                    else: idx += 1
            else: # –†–µ–∂–∏–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: —á–∞—Å—Ç—è–º–∏
                chunks = [" ".join(mentions[i:i + 50]) for i in range(0, len(mentions), 50)]

            if header_text:
                self._send_markdown_message(peer_id, header_text)
                time.sleep(delay_pi)

            total_pi = len(chunks)
            for i, chunk in enumerate(chunks):
                if stop_event.is_set():
                    BulletinHelper.show_info("–£–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ.")
                    return
                self._send_markdown_message(peer_id, chunk)
                if i < total_pi - 1: time.sleep(delay_pi)
            
            BulletinHelper.show_success(f"–£–ø–æ–º—è–Ω—É—Ç–æ {len(filtered_participants_pi)} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.")
        except Exception as e:
            self._log_error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∏ –æ—Ç–ø—Ä–∞–≤–∫–µ", e)
            BulletinHelper.show_error(f"–û—à–∏–±–∫–∞: {e}")

