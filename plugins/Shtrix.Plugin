from base_plugin import BasePlugin, HookStrategy, MenuItemData, MenuItemType, HookResult
from android_utils import run_on_ui_thread
from client_utils import get_last_fragment
from ui.bulletin import BulletinHelper
from ui.settings import Header, Switch
from org.telegram.ui import ChatActivity

__id__ = "BarcodeLang"
__name__ = "–®—Ç—Ä–∏—Ö–∫–æ–¥–æ–≤—ã–π —è–∑—ã–∫"
__description__ = "|lIl|IlIl|IlI|lIl|IlIl|IlI üò≠üôèüôè"
__author__ = "@RoflPlugins"
__version__ = "1.4.88"
__icon__ = "Shtrix4/0"
__min_version__ = "11.12.0"

# –ê–ª—Ñ–∞–≤–∏—Ç (—Ä—É—Å—Å–∫–∏–π + –∞–Ω–≥–ª–∏–π—Å–∫–∏–π, —Ç–æ–ª—å–∫–æ I –∏ l)
# –†—É—Å—Å–∫–∏–π –∞–ª—Ñ–∞–≤–∏—Ç (—à—Ç—Ä–∏—Ö–∫–æ–¥)
MK_LANG_RU = {
    "–∞": "I",
    "–±": "l",
    "–≤": "Il",
    "–≥": "lI",
    "–¥": "II",
    "–µ": "ll",
    "—ë": "IIl",
    "–∂": "lIl",
    "–∑": "IIll",
    "–∏": "Ill",
    "–π": "lII",
    "–∫": "lIlI",
    "–ª": "IIlI",
    "–º": "IllI",
    "–Ω": "lIIl",
    "–æ": "lll",
    "–ø": "IIIl",
    "—Ä": "IlIl",
    "—Å": "IIlIl",
    "—Ç": "lIIlI",
    "—É": "IllII",
    "—Ñ": "IIIll",
    "—Ö": "lIll",
    "—Ü": "IIlII",
    "—á": "IlII",
    "—à": "llll",
    "—â": "IIlIIl",
    "—ä": "llIl",
    "—ã": "Illl",
    "—å": "lIIIl",
    "—ç": "IlIll",
    "—é": "IIlIll",
    "—è": "IllIIl",
}

# –ê–Ω–≥–ª–∏–π—Å–∫–∏–π –∞–ª—Ñ–∞–≤–∏—Ç (–Ω–µ –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç—Å—è —Å —Ä—É—Å—Å–∫–∏–º)
MK_LANG_EN = {
    "a": "Illll",
    "b": "IIIII",
    "c": "lIIII",
    "d": "IlIII",
    "e": "IIlIIlII",
    "f": "IIIllI",
    "g": "IlllI",
    "h": "lIllI",
    "i": "lllIl",
    "j": "IIIlI",
    "k": "lIIll",
    "l": "IllIl",
    "m": "IlIllI",
    "n": "lIlII",
    "o": "IIlIII",
    "p": "IllIII",
    "q": "lllII",
    "r": "IIIlll",
    "s": "IlIIl",
    "t": "lIIIlI",
    "u": "IllIIlI",
    "v": "IIlIllI",
    "w": "llIIlI",
    "x": "IlllIl",
    "y": "IIIlII",
    "z": "lIllII",
}

# –û–±—ä–µ–¥–∏–Ω—è–µ–º —Å–ª–æ–≤–∞—Ä–∏
MK_LANG = {}
MK_LANG.update(MK_LANG_RU)
MK_LANG.update(MK_LANG_EN)


# –û–±—Ä–∞—Ç–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å
REV_LANG = {v: k for k, v in MK_LANG.items()}


def to_barcode(text: str) -> str:
    result = []
    words = text.split(" ")
    for word in words:
        if word.startswith(("/", "@", ".")) and len(word) > 1:
            result.append(word)
        else:
            encoded = [MK_LANG.get(ch.lower(), ch) for ch in word]
            result.append("|".join(encoded))
    return " ".join(result)




def from_barcode(text: str) -> str:
    words = text.split(" ")
    result = []
    for word in words:
        if word.startswith(("/", "@", ".")) and len(word) > 1:
            result.append(word)
        else:
            letters = word.split("|")
            decoded = [REV_LANG.get(letter, letter) for letter in letters]
            result.append("".join(decoded))
    return " ".join(result)



class MyPlugin(BasePlugin):
    def create_settings(self):
        from org.telegram.messenger import LocaleController
        lang = LocaleController.getInstance().getCurrentLocale().getLanguage()

        strings = {
            "ru": {
                "title": "–®—Ç—Ä–∏—Ö–∫–æ–¥ –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫",
                "barcode_on": "–í–∫–ª—é—á–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥ (—Ä—É—Å/–∞–Ω–≥–ª ‚Üí —à—Ç—Ä–∏—Ö–∫–æ–¥)"
            },
            "en": {
                "title": "Barcode translator",
                "barcode_on": "Enable translation (ru/en ‚Üí barcode)"
            }
        }
        s = strings["ru" if lang.startswith("ru") else "en"]

        return [Header(text=s["title"]), Switch(key="barcode_on", text=s["barcode_on"], default=True, icon="msg_qr")]

    def handle_translate_click(self, context):
        message = context.get("message")
        if message is None:
            return
        msg_id = message.getId()
        text = message.messageText.toString()
        if not text:
            return

        if msg_id in self.orig_storage and get_last_fragment() == self.orig_storage[msg_id][1]:
            new_text = self.orig_storage[msg_id][0]
            del self.orig_storage[msg_id]
        else:
            new_text = from_barcode(text)
            self.orig_storage[msg_id] = (text, get_last_fragment())

        run_on_ui_thread(lambda: self.update_message_text_locally(message, new_text))

    def update_message_text_locally(self, message, text):
        msg_id = message.getId()

        if not text or not isinstance(text, str) or not text.strip():
            BulletinHelper.show_error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ.")
        message.applyNewText(text)
        message.forceUpdate = True

        fragment = get_last_fragment()
        if isinstance(fragment, ChatActivity):
            cell = fragment.findMessageCell(msg_id, False)
            if cell:
                cell.getMessageObject().applyNewText(text)
                cell.getMessageObject().forceUpdate = True
                cell.invalidate()
                BulletinHelper.show_success("–ü–µ—Ä–µ–≤–æ–¥ —É—Å–ø–µ—à–µ–Ω!")

    def on_plugin_load(self):
        self.orig_storage = {}
        self.add_menu_item(
            MenuItemData(
                menu_type=MenuItemType.MESSAGE_CONTEXT_MENU,
                text="–ü–µ—Ä–µ–≤–µ—Å—Ç–∏ / –≤–µ—Ä–Ω—É—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª",
                on_click=self.handle_translate_click,
                icon="msg_translate"
            )
        )
        self.add_on_send_message_hook()

    def on_send_message_hook(self, account: int, params):
        if not self.get_setting("barcode_on", True):
            return HookResult(strategy=HookStrategy.DEFAULT)

        if not params.message:
            return

        params.message = to_barcode(params.message)
        return HookResult(strategy=HookStrategy.MODIFY, params=params)
