from base_plugin import BasePlugin, HookResult, HookStrategy
from android_utils import log
import random

__id__ = "emoji_master"
__name__ = "AutoSmile"
__description__ = "–°—Ç–∞–≤–∏—Ç —Ä–∞–Ω–¥–æ–º–Ω–æ–µ —ç–º–æ–¥–∑–∏ –≤ –∫–æ–Ω—Ü–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è"
__author__ = "@DataNestUser"
__version__ = "Release 1.0"
__min_version__ = "11.12.0"

class EmojiMasterPlugin(BasePlugin):
    def on_plugin_load(self):
        log("EXTERAMSG EmojiMaster –∑–∞–≥—Ä—É–∂–µ–Ω")
        self.add_on_send_message_hook()
        
        self.emoji_packs = {
            "basic": ["üòä","üòé","üòÇ","‚ù§Ô∏è","‚ú®","üî•","‚≠ê","üéØ","üíØ","üöÄ"],
            "fun": ["ü§£","üòç","ü•∞","üòú","ü§™","üéâ","üí•","üåà","üçÄ","üéä"],
            "cool": ["üòè","ü§ë","üòà","üí™","üèÜ","üéÆ","üï∂Ô∏è","‚ö°","üîÆ","üíé"],
            "flags": ["üá∫üá¶","üá∑üá∫","üá∞üáø","üá∫üá∏","üá©üá™","üá´üá∑","üáØüáµ","üá®üá≥","üá¨üáß","üáÆüáπ"],
            "symbols": ["‚úÖ","‚ùå","‚ö†Ô∏è","‚≠ê","üí´","üî¥","üü¢","üîµ","üü°","üü£"],
            "hands": ["üëç","üëé","üëå","ü§ô","ü§ü","ü§ò","‚úåÔ∏è","ü§ù","üôè","üñï"],
            "animals": ["üê∂","üê±","üêª","üêº","ü¶ä","üêØ","ü¶Å","üêÆ","üê∑","üêí"],
            "food": ["üçé","üçï","üçî","üç¶","üç©","üçª","‚òï","üç∑","üç™","üçì"],
            "nature": ["üåû","üåô","‚≠ê","üåà","‚ö°","üî•","üíß","üåä","üçÉ","üå∫"],
            "objects": ["üì±","üíª","üéß","üìö","üéÆ","üí∞","üîë","üéÅ","üí°","üìå"],
            "sports": ["‚öΩ","üèÄ","üéæ","üèà","‚öæ","üéØ","üèÜ","üé≥","ü•ä","üéø"],
            "travel": ["üöó","‚úàÔ∏è","üöÄ","‚õµ","üèçÔ∏è","üö≤","üèïÔ∏è","üó∫Ô∏è","üé°","üèñÔ∏è"],
            "weather": ["‚òÄÔ∏è","üåßÔ∏è","‚õàÔ∏è","üå™Ô∏è","‚ùÑÔ∏è","üí®","üåà","‚òî","üå§Ô∏è","üåô"],
            "holiday": ["üéÑ","üéÉ","üéÖ","ü§∂","üéÅ","üéâ","üéä","üéÇ","üçæ","üéÜ"],
            "tech": ["ü§ñ","üëæ","üíæ","üì°","üîã","üíø","üì±","üíª","‚åö","üì∏"],
            "music": ["üéµ","üé∂","üé∏","üéπ","üé∫","üéª","ü•Å","üé§","üéß","üìª"],
            "science": ["üî¨","üíâ","üß™","üî≠","üì°","üß¨","‚öóÔ∏è","üß´","üîç","üíä"],
            "office": ["üìÅ","üìä","üìà","üìâ","üìã","üìå","‚úÇÔ∏è","üìé","üñäÔ∏è","üìè"],
            "signs": ["‚¨ÜÔ∏è","‚¨áÔ∏è","‚¨ÖÔ∏è","‚û°Ô∏è","‚ÜóÔ∏è","‚ÜòÔ∏è","‚ÜôÔ∏è","‚ÜñÔ∏è","‚§¥Ô∏è","‚§µÔ∏è"],
            "people": ["üë∂","üëß","üë¶","üë©","üë®","üëµ","üë¥","üëÆ","üë∑","üíÇ"]
        }
        
        
        self.all_emojis = []
        for pack in self.emoji_packs.values():
            self.all_emojis.extend(pack)
        
        self.enabled = True
        self.mode = "random"
        self.current_emoji = "üòä"
        self.current_pack = "basic"
        self.emoji_count = 1
        
    def on_plugin_unload(self):
        log("EXTERAMSG EmojiMaster –≤—ã–≥—Ä—É–∂–µ–Ω")

    def on_send_message_hook(self, account, params):
        try:
            if not self.enabled:
                return HookResult()
                
            if not hasattr(params, "message"):
                return HookResult()

            message_text = str(params.message).strip()
            if not message_text:
                return HookResult()

            if message_text.startswith('.e '):
                self.process_command(message_text[3:])
                return HookResult(strategy=HookStrategy.CANCEL)

            if len(message_text) > 4000:
                return HookResult()

            emojis = self.get_emojis()
            total_length = len(message_text) + len(emojis) + 1
            
            if total_length > 4096:
                max_emojis = 4096 - len(message_text) - 1
                if max_emojis > 0:
                    emojis = emojis[:max_emojis]
                else:
                    return HookResult()

            if emojis and not message_text.endswith(emojis):
                params.message = message_text + " " + emojis
                return HookResult(strategy=HookStrategy.MODIFY, params=params)

        except Exception as e:
            log(f"EXTERAMSG –û—à–∏–±–∫–∞: {e}")
            
        return HookResult()
    
    def get_emojis(self):
        if self.mode == "single":
            return self.current_emoji * min(self.emoji_count, 10)
        elif self.mode == "pack":
            pack = self.emoji_packs.get(self.current_pack, self.emoji_packs["basic"])
            count = min(self.emoji_count, 5, len(pack))
            return ' '.join(random.sample(pack, count))
        else:
            count = min(self.emoji_count, 5, len(self.all_emojis))
            return ' '.join(random.sample(self.all_emojis, count))
            
    def process_command(self, command):
        parts = command.lower().split()
        if not parts:
            self.show_help()
            return
            
        cmd = parts[0]
        
        if cmd == "on":
            self.enabled = True
            log("EXTERAMSG ‚úÖ –í–∫–ª")
            
        elif cmd == "off":
            self.enabled = False
            log("EXTERAMSG ‚ùå –í—ã–∫–ª")
            
        elif cmd == "mode":
            if len(parts) > 1:
                new_mode = parts[1]
                if new_mode in ["random", "single", "pack"]:
                    self.mode = new_mode
                    log(f"EXTERAMSG üéõÔ∏è {new_mode}")
            else:
                log(f"EXTERAMSG üìä {self.mode}")
                
        elif cmd == "set":
            if len(parts) > 1:
                
                arg = parts[1]
                
                
                if arg.isdigit():
                    index = int(arg)
                    if 0 <= index < len(self.all_emojis):
                        self.current_emoji = self.all_emojis[index]
                        self.mode = "single"
                        log(f"EXTERAMSG ‚úÖ #{index} {self.current_emoji}")
                    else:
                        log(f"EXTERAMSG ‚ùå –ù–æ–º–µ—Ä 0-{len(self.all_emojis)-1}")
                else:
                    
                    if arg in self.all_emojis:
                        self.current_emoji = arg
                        self.mode = "single"
                        log(f"EXTERAMSG ‚úÖ {arg}")
                    else:
                        log("EXTERAMSG ‚ùå –≠–º–æ–¥–∑–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω")
            else:
                log(f"EXTERAMSG ‚ú® –¢–µ–∫—É—â–∏–π: {self.current_emoji}")
                
        elif cmd == "pack":
            if len(parts) > 1:
                pack_name = parts[1]
                if pack_name in self.emoji_packs:
                    self.current_pack = pack_name
                    self.mode = "pack"
                    log(f"EXTERAMSG üéí {pack_name}")
                else:
                    packs = "/".join(list(self.emoji_packs.keys())[:8])
                    log(f"EXTERAMSG üì¶ {packs}")
            else:
                log(f"EXTERAMSG üéí {self.current_pack}")
                
        elif cmd == "count":
            if len(parts) > 1:
                try:
                    count = int(parts[1])
                    if 1 <= count <= 5:
                        self.emoji_count = count
                        log(f"EXTERAMSG üî¢ {count}")
                except:
                    pass
            else:
                log(f"EXTERAMSG üî¢ {self.emoji_count}")
                
        elif cmd == "list":
            if len(parts) > 1:
                pack_name = parts[1]
                if pack_name in self.emoji_packs:
                    emojis = self.emoji_packs[pack_name]
                    result = f"EXTERAMSG üìã {pack_name}:\n"
                    for i, emoji in enumerate(emojis):
                        result += f"{i}:{emoji} "
                        if (i + 1) % 5 == 0:
                            result += "\n"
                    log(result)
                else:
                    packs = " ".join(self.emoji_packs.keys())
                    log(f"EXTERAMSG üì¶ –ü–∞–∫–µ—Ç—ã: {packs}")
            else:
                result = "EXTERAMSG üìã –í—Å–µ —ç–º–æ–¥–∑–∏ (0-49):\n"
                for i in range(min(50, len(self.all_emojis))):
                    result += f"{i}:{self.all_emojis[i]} "
                    if (i + 1) % 5 == 0:
                        result += "\n"
                log(result)
                if len(self.all_emojis) > 50:
                    log(f"EXTERAMSG ... –∏ –µ—â–µ {len(self.all_emojis)-50} —ç–º–æ–¥–∑–∏")
                
        elif cmd == "find":
            if len(parts) > 1:
                search = parts[1]
                found = []
                for i, emoji in enumerate(self.all_emojis):
                    if search in emoji:
                        found.append((i, emoji))
                
                if found:
                    result = "EXTERAMSG üîç –ù–∞–π–¥–µ–Ω–æ:\n"
                    for i, (index, emoji) in enumerate(found[:10]): 
                        result += f"{index}:{emoji} "
                        if (i + 1) % 5 == 0:
                            result += "\n"
                    log(result)
                    if len(found) > 10:
                        log(f"EXTERAMSG ... –∏ –µ—â–µ {len(found)-10}")
                else:
                    log("EXTERAMSG ‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ")
                
        elif cmd == "status":
            status = "‚úÖ" if self.enabled else "‚ùå"
            log(f"EXTERAMSG üìä {status} {self.mode} x{self.emoji_count}")
            if self.mode == "single":
                log(f"EXTERAMSG ‚ú® {self.current_emoji}")
            elif self.mode == "pack":
                log(f"EXTERAMSG üéí {self.current_pack}")
            
        else:
            self.show_help()
            
    def show_help(self):
        help_text = """EXTERAMSG üé≠ .e –∫–æ–º–∞–Ω–¥—ã:
on/off - –≤–∫–ª/–≤—ã–∫–ª
status - —Å—Ç–∞—Ç—É—Å
mode random/single/pack - —Ä–µ–∂–∏–º
set [–Ω–æ–º–µ—Ä/—ç–º–æ–¥–∑–∏] - –≤—ã–±—Ä–∞—Ç—å
pack [–Ω–∞–∑–≤–∞–Ω–∏–µ] - –ø–∞–∫–µ—Ç
count 1-5 - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
list - –≤—Å–µ —ç–º–æ–¥–∑–∏
list [–ø–∞–∫–µ—Ç] - —ç–º–æ–¥–∑–∏ –ø–∞–∫–µ—Ç–∞
find [—Ç–µ–∫—Å—Ç] - –ø–æ–∏—Å–∫
"""
        log(help_text)