from base_plugin import BasePlugin, MethodReplacement, HookResult, HookStrategy
from hook_utils import find_class
from ui.settings import Input, Header, Divider, Switch
from ui.bulletin import BulletinHelper
from android_utils import run_on_ui_thread
from java.lang import Boolean, Runnable
from org.telegram.tgnet.tl import TL_stars

__id__ = "fake_stars"
__name__ = "Fake Stars Payment"
__description__ = "Simulate Stars balance and payments."
__author__ = "tg://support"
__min_version__ = "12.1.0"
__icon__ = "FinanceEmoji/0"
__version__ = "0.4"

StarsController = find_class("org.telegram.ui.Stars.StarsController").getClass()
ArrayList = find_class("java.util.ArrayList")

class FakeStarsPlugin(BasePlugin):
    DEFAULT_BALANCE = 999999
    SETTINGS_INFINITE = "infinite_mode"
    SETTINGS_BALANCE = "balance"
    
    def __init__(self):
        super().__init__()
        self._load_settings()

    def _load_settings(self):
        """Load settings from plugin storage"""
        try:
            self.infinite_mode = self.get_setting(self.SETTINGS_INFINITE, "true") == "true"
            self.balance = int(self.get_setting(self.SETTINGS_BALANCE, str(self.DEFAULT_BALANCE)))
        except Exception as e:
            self.log(f"Error loading settings: {e}")
            self.infinite_mode = True
            self.balance = self.DEFAULT_BALANCE
            self._save_settings()

    def _save_settings(self):
        """Save settings to plugin storage"""
        self.set_setting(self.SETTINGS_INFINITE, "true" if self.infinite_mode else "false")
        self.set_setting(self.SETTINGS_BALANCE, str(self.balance))

    def create_settings(self):
        """Create settings UI"""
        self.log("Creating settings UI...")
        return [
            Header("Balance Settings"),
            Switch(
                self.SETTINGS_INFINITE,
                "Infinite Balance",
                default=self.infinite_mode,
                description="Balance restores after payment",
                icon="msg_premium"
            ),
            Divider(),
            Input(
                self.SETTINGS_BALANCE,
                "Stars Amount",
                default=str(self.balance),
                hint="Enter stars amount",
                icon="filled_giveaway_stars"
            ),
        ]

    def on_settings_changed(self, key, value):
        """Called when user changes settings"""
        self.log(f"Setting changed: {key} = {value}")
        
        if key == self.SETTINGS_INFINITE:
            self.infinite_mode = value == "true" or value is True
            self._save_settings()
            status = "enabled" if self.infinite_mode else "disabled"
            run_on_ui_thread(lambda: BulletinHelper.show_success(f"Infinite mode {status}"))
            
        elif key == self.SETTINGS_BALANCE:
            try:
                new_balance = int(str(value).strip())
                if new_balance < 0:
                    raise ValueError("Negative balance")
                
                self.balance = new_balance
                self._save_settings()
                run_on_ui_thread(lambda: BulletinHelper.show_success(f"Balance: {new_balance:,} â­"))
            except Exception as e:
                self.log(f"Invalid balance: {e}")
                run_on_ui_thread(lambda: BulletinHelper.show_error("Invalid amount"))

    def on_plugin_load(self):
        """Initialize plugin when loaded"""
        self.log("=== Fake Stars Plugin Loading ===")
        
        # Hook balance methods
        self._hook_balance_methods()
        
        # Register payment hook - CORRECT METHOD
        self.add_hook("TL_payments_sendStarsForm", match_substring=True, priority=100)
        
        self.log(f"Loaded - Balance: {self.balance}, Infinite: {self.infinite_mode}")

    def _hook_balance_methods(self):
        """Hook all balance-related methods"""
        try:
            methods = StarsController.getDeclaredMethods()
            hooked_count = 0
            
            for method in methods:
                method_name = method.getName()
                
                if method_name == "getBalance":
                    self.hook_method(method, _GetBalanceHook(self))
                    hooked_count += 1
                    self.log(f"âœ“ Hooked: getBalance")
                    
                elif method_name == "getCachedBalance":
                    self.hook_method(method, _GetCachedBalanceHook(self))
                    hooked_count += 1
                    self.log(f"âœ“ Hooked: getCachedBalance")
                    
                elif method_name == "balanceAvailable":
                    self.hook_method(method, _ReturnTrueHook())
                    hooked_count += 1
                    self.log(f"âœ“ Hooked: balanceAvailable")
            
            self.log(f"Successfully hooked {hooked_count} methods")
        except Exception as e:
            self.log(f"âŒ Error hooking: {e}")

    def post_request_hook(self, request_name, account, response, error):
        """Hook called automatically after API requests"""
        try:
            # Check if this is a Stars payment request
            if "sendStarsForm" in request_name or "TL_payments_sendStarsForm" in request_name:
                self.log(f"ðŸ’³ Payment intercepted: {request_name}")
                return self._handle_payment(response, error)
        except Exception as e:
            self.log(f"âŒ Hook error: {e}")
        
        # Return default for non-payment requests
        return HookResult(strategy=HookStrategy.DEFAULT)

    def _handle_payment(self, response, error):
        """Process payment and create fake success"""
        try:
            # Restore balance in infinite mode
            if self.infinite_mode:
                self.log(f"â™»ï¸ Restoring balance to {self.balance}")
            
            # Create fake success response
            TL_payments_paymentResult = find_class("org.telegram.tgnet.TLRPC$TL_payments_paymentResult")
            TL_updates = find_class("org.telegram.tgnet.TLRPC$TL_updates")
            
            fake_result = TL_payments_paymentResult()
            updates = TL_updates()
            updates.updates = ArrayList()
            updates.users = ArrayList()
            updates.chats = ArrayList()
            updates.date = 0
            updates.seq = 0
            fake_result.updates = updates
            
            self.log("âœ… Payment success (fake)")
            run_on_ui_thread(lambda: BulletinHelper.show_success("Payment processed"))
            
            return HookResult(strategy=HookStrategy.MODIFY_FINAL, response=fake_result)
            
        except Exception as e:
            self.log(f"âŒ Payment handler error: {e}")
            return HookResult(strategy=HookStrategy.DEFAULT)


# ----- Hook Classes -----

class _GetBalanceHook(MethodReplacement):
    """Hook for getBalance methods"""
    def __init__(self, plugin):
        self.plugin = plugin

    def replace_hooked_method(self, param):
        try:
            # Execute callback if provided (for async operations)
            args = getattr(param, "args", None)
            if args and len(args) >= 2 and args[1] is not None:
                try:
                    run_on_ui_thread(args[1])
                except Exception:
                    pass
        except Exception:
            pass

        # Return fake balance
        return self._create_stars_amount(self.plugin.balance)

    @staticmethod
    def _create_stars_amount(amount):
        """Create StarsAmount object"""
        try:
            return TL_stars.StarsAmount.ofStars(int(amount))
        except Exception:
            # Fallback if ofStars() doesn't exist
            stars_amount = TL_stars.StarsAmount()
            stars_amount.amount = int(amount)
            return stars_amount


class _GetCachedBalanceHook(MethodReplacement):
    """Hook for getCachedBalance"""
    def __init__(self, plugin):
        self.plugin = plugin

    def replace_hooked_method(self, param):
        return _GetBalanceHook._create_stars_amount(self.plugin.balance)


class _ReturnTrueHook(MethodReplacement):
    """Hook for balanceAvailable"""
    def replace_hooked_method(self, param):
        return True
