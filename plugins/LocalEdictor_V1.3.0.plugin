# -*- coding: utf-8 -*-

import traceback

from base_plugin import BasePlugin, MenuItemData, MenuItemType, MethodHook, HookResult, HookStrategy
from android_utils import run_on_ui_thread, log
from client_utils import get_last_fragment, get_messages_controller
from ui.alert import AlertDialogBuilder
from ui.bulletin import BulletinHelper

from org.telegram.messenger import AndroidUtilities, MessagesController
from org.telegram.ui.ActionBar import Theme
from org.telegram.ui.Cells import ChatMessageCell

from hook_utils import find_class
from hook_utils import set_private_field

try:
    import zwylib
except ImportError:
    zwylib = None


__id__ = "LocalEdictor"
__name__ = "Local Edictor"
__description__ = (
    "–ü–æ–∑–≤–æ–ª—è–µ—Ç –∏–∑–º–µ–Ω—è—Ç—å —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –ª–æ–∫–∞–ª—å–Ω–æ! \n–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –º–µ–∂–¥—É –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–º–∏, —Ç–∞–∫–∂–µ –µ—Å—Ç—å –∫–Ω–æ–ø–∫–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π. \n\n\n–ß—Ç–æ –¥–æ–±–∞–≤–∏–ª–∏ –≤ 1.3.0?\n–î–æ–±–∞–≤–∏–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∫—É –º–µ–¥–∏–∞. –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–∂–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –≤–ª–æ–∂–µ–Ω–∏—è–º–∏!\n\n*–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:\n–ï—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ –ø—Ä–∏–º–µ–Ω–∏–ª–∏—Å—å —Ç–æ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–π–¥–∏—Ç–µ –≤ —á–∞—Ç. –ü–æ—Å—Ç–∞—Ä–∞—é—Å—å —ç—Ç–æ –≤ –±—É–¥—É—â–µ–º –∏—Å–ø—Ä–∞–≤–∏—Ç—å.\n\n\n‚õîÔ∏è‚õîÔ∏è‚õî –ë–ï–ó –ë–ò–ë–õ–ò–û–¢–ï–ö–ò zwyLib –ù–ï –ë–£–î–ï–¢ –†–ê–ë–û–¢–ê–¢–¨!‚õîÔ∏è‚õîÔ∏è‚õîÔ∏è")
__author__ = "@Nikita218000"
__version__ = "1.3.0"
__min_version__ = "12.1.1"
__icon__ = "IconForPlugins_by_TgEmodziBot/2"

HOOK_PRIORITY = 30

# –í—Å–µ –≤ try –ø–æ—Ç–æ–º—É —á—Ç–æ –∑–∞–¥–æ–ª–±–∞–ª–∏ –∫—Ä–∞—à–∏ –∏ —è —Ö–∑ —á—Ç–æ —Å –Ω–∏–º–∏ –¥–µ–ª–∞—Ç—å
try:
    class SetMessageContentHook(MethodHook):
        def __init__(self, plugin):
            self.plugin = plugin

        def before_hooked_method(self, param):
            try:
                cache = self.plugin.edited_messages_cache
                if not cache or not cache.content:
                    return

                message_object = param.args[0]
                if not message_object:
                    return

                key = f"{message_object.getId()}_{message_object.getDialogId()}"
                new_text = cache.content.get(key)
                if not new_text:
                    return

                if hasattr(message_object, "caption") and message_object.caption is not None:
                    message_object.caption = new_text
                    if set_private_field:
                        set_private_field(message_object, "captionLayout", None)
                else:
                    try:
                        message_object.applyNewText(new_text)
                    except Exception:
                        message_object.messageText = new_text
                    if set_private_field:
                        set_private_field(message_object, "textLayout", None)

                cell = param.thisObject
                if isinstance(cell, ChatMessageCell):
                    run_on_ui_thread(lambda: cell.invalidate())

            except Exception as e:
                log(f"[{__name__}] Hook error: {e}")


    class LocalEditPlugin(BasePlugin):
        def __init__(self):
            super().__init__()
            self.edited_messages_cache = None
            self.unhooks = []

        def on_plugin_load(self):
            if zwylib is None:
                run_on_ui_thread(lambda: BulletinHelper.show_error("zwylib –Ω–µ –Ω–∞–π–¥–µ–Ω!"))
                return

            try:
                self.edited_messages_cache = zwylib.JsonCacheFile("LocalEdictor_data", {})

                self.add_menu_item(MenuItemData(
                    menu_type=MenuItemType.MESSAGE_CONTEXT_MENU,
                    text="–ò–∑–º–µ–Ω–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ",
                    on_click=self.handle_edit_click,
                    icon="msg_edit"
                ))

                self.add_menu_item(MenuItemData(
                    menu_type=MenuItemType.CHAT_ACTION_MENU,
                    text="–°–±—Ä–æ—Å–∏—Ç—å –ª–æ–∫. –∏–∑–º–µ–Ω–µ–Ω–∏—è",
                    on_click=self.handle_reset_click,
                    icon="msg_delete"
                ))

                self._install_hooks()
            except Exception as e:
                log(f"[{__name__}] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–ª–∞–≥–∏–Ω–∞: {str(e)}")
                traceback.print_exc()

        def _install_hooks(self):
            try:
                ChatMessageCellClass = find_class("org.telegram.ui.Cells.ChatMessageCell")
                if not ChatMessageCellClass:
                    return

                for method in ChatMessageCellClass.getClass().getDeclaredMethods():
                    if method.getName() == "setMessageContent":
                        unhook = self.hook_method(method, SetMessageContentHook(self), priority=HOOK_PRIORITY)
                        if unhook:
                            self.unhooks.append(unhook)
            except Exception as e:
                log(f"[{__name__}] Hook error: {e}")

        def handle_edit_click(self, context):
            if not self.edited_messages_cache:
                return

            message_object = context.get("message")
            if not message_object:
                return

            fragment = get_last_fragment()
            if not fragment or not fragment.getParentActivity():
                return

            activity = fragment.getParentActivity()
            LinearLayout = find_class("android.widget.LinearLayout")
            EditText = find_class("android.widget.EditText")

            layout = LinearLayout(activity)
            layout.setOrientation(LinearLayout.VERTICAL)
            layout.setPadding(AndroidUtilities.dp(20), AndroidUtilities.dp(10), AndroidUtilities.dp(20), AndroidUtilities.dp(10))

            edit_text = EditText(activity)
            key = f"{message_object.getId()}_{message_object.getDialogId()}"

            original = ""
            if hasattr(message_object, "caption") and message_object.caption:
                original = str(message_object.caption)
            elif message_object.messageText:
                original = str(message_object.messageText)

            current = self.edited_messages_cache.content.get(key, original)
            edit_text.setText(current)
            edit_text.setHint("–ù–æ–≤—ã–π —Ç–µ–∫—Å—Ç")
            edit_text.setTextColor(Theme.getColor(Theme.key_dialogTextBlack))
            edit_text.setHintTextColor(Theme.getColor(Theme.key_dialogTextHint))
            layout.addView(edit_text)

            builder = AlertDialogBuilder(activity)
            builder.set_title("–õ–æ–∫–∞–ª—å–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ")
            builder.set_view(layout)
            builder.set_positive_button("–°–æ—Ö—Ä–∞–Ω–∏—Ç—å", lambda d, w: (
                self._apply_edit(message_object, edit_text.getText().toString(), fragment),
                d.dismiss()
            ))
            builder.set_negative_button("–û—Ç–º–µ–Ω–∞", lambda d, w: d.dismiss())
            run_on_ui_thread(builder.show)

        def _apply_edit(self, message_object, new_text, fragment):
            key = f"{message_object.getId()}_{message_object.getDialogId()}"

            if not new_text or not new_text.strip():
                self.edited_messages_cache.content.pop(key, None)
                BulletinHelper.show_success("–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å–±—Ä–æ—à–µ–Ω–æ! üò∏") # –î–∞–∂–µ —Å–º–∞–π–ª–∏–∫ –Ω–∞—à–µ–ª!
            else:
                self.edited_messages_cache.content[key] = new_text.strip()
                BulletinHelper.show_success("–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ! üò∏")

            self.edited_messages_cache.write()

            # –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ MessagesController
            run_on_ui_thread(lambda: self._force_update_via_controller(message_object, fragment))

        def _force_update_via_controller(self, message_object, fragment):
            try:
                controller = get_messages_controller()
                if not controller:
                    return

                dialog_id = message_object.getDialogId()
                msg_id = message_object.getId()

                # –ò—â–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫—ç—à–µ - 1
                messages = controller.getMessagesStorage().getMessages(dialog_id, False)
                if not messages:
                    return

                target = None
                for msg in messages:
                    if msg.getId() == msg_id:
                        target = msg
                        break

                if not target:
                    return

                # –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—ä–µ–∫—Ç - 2
                new_text = self.edited_messages_cache.content.get(f"{msg_id}_{dialog_id}")
                if new_text:
                    if hasattr(target, "caption") and target.caption is not None:
                        target.caption = new_text
                    else:
                        try:
                            target.applyNewText(new_text)
                        except Exception:
                            target.messageText = new_text

                # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫—ç—à —Ä–∞–∑–º–µ—Ç–∫–∏ - 3
                if set_private_field:
                    for field in ("captionLayout", "textLayout"):
                        try:
                            set_private_field(target, field, None)
                        except Exception:
                            pass

                # –û–±–Ω–æ–≤–ª—è–µ–º –∞–¥–∞–ø—Ç–µ—Ä -4
                list_view = fragment.getChatListView()
                if not list_view:
                    return
                adapter = list_view.getAdapter()
                if adapter:
                    position = -1
                    for i in range(adapter.getItemCount()):
                        item = adapter.getItem(i)
                        if item and item.getId() == msg_id:
                            position = i
                            break
                    if position != -1:
                        adapter.notifyItemChanged(position)
                    # –ù–∞–∫–æ–Ω–µ—Ü —Ç–æ –∑–∞–∫–æ–Ω—á–∏–ª–∏

            except Exception as e:
                log(f"[{__name__}] Bruh: update error: {e}")

        def handle_reset_click(self, context):
            self.edited_messages_cache.content.clear()
            self.edited_messages_cache.write()
            run_on_ui_thread(lambda: BulletinHelper.show_success("–í—Å–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∫–∏ —Å–±—Ä–æ—à–µ–Ω—ã! üò∏"))

        def on_plugin_unload(self):
            for unhook in self.unhooks:
                try:
                    unhook()
                except Exception:
                    pass
            self.unhooks.clear()

except Exception as e:
    log(f"CRITICAL: {e}")
    run_on_ui_thread(lambda: BulletinHelper.show_error("Local Editor: –æ—à–∏–±–∫–∞"))