import os
import time
import json
import requests
import threading
import traceback
import ast
from typing import Any, Dict, Optional, Tuple, List

from base_plugin import BasePlugin, HookResult, HookStrategy, MenuItemData, MenuItemType
from client_utils import (
    get_file_loader, run_on_queue, send_message, get_last_fragment,
    get_messages_controller, get_user_config
)
from markdown_utils import parse_markdown
from ui.settings import Header, Input, Divider, Switch, Selector, Text
from ui.bulletin import BulletinHelper
from ui.alert import AlertDialogBuilder
from android_utils import run_on_ui_thread, log

from java.util import Locale
from org.telegram.tgnet import TLRPC
from org.telegram.messenger import MessageObject, FileLoader, AndroidUtilities, ChatObject

__id__ = "gemini_plugin_security"
__name__ = "Gemini Plugin Security"
__description__ = "Checks Extera plugin code for security risks using Google Gemini API."
__author__ = "@mihailkotovski & @mishabotov"
__version__ = "4.0.0 [release]"
__min_version__ = "11.12.1"
__icon__ = "DateRegBot_by_MoiStikiBot/8"

AUTOUPDATE_CHANNEL_ID = 2349438816
AUTOUPDATE_CHANNEL_USERNAME = "mishabotov"
AUTOUPDATE_MESSAGE_ID = 96

zwylib: Optional[Any] = None

GEMINI_BASE_URL = "https://generativelanguage.googleapis.com/v1beta/models/"
MODEL_DISPLAY_NAMES = [
    "Gemini 2.5 Pro",
    "Gemini 2.5 Flash",
    "Gemini 2.5 Flash Lite"
]
MODEL_API_NAMES = [
    "gemini-2.5-pro",
    "gemini-2.5-flash",
    "gemini-2.5-flash-lite-preview-06-17"
]
DEFAULT_COMMAND = ".gpa"

PREMIUM_EMOJI_MAP = {
    "âŒ": "[âŒ](5210952531676504517)",
    "ðŸ“›": "[â—ï¸](5834951734358707402)",
    "âš ï¸": "[âš ï¸](5447644880824181073)",
    "â”": "[â”](5467461928647399673)",
    "âœ…": "[âœ…](5219899949281453881)",
    "ðŸ›¡ï¸": "[â„¹ï¸](5404366668635865453)",
    "â—ˆ": "[âŒ](5258453452631056344)",
    "â˜¶": "[ðŸ“](5256230583717079814)",
    "â": "[âœï¸](5337063551854999885)",
    "â€¢": "[ðŸŸ¦](5404724576850573443)"
}

def replace_with_premium_emoji(text: str) -> str:
    result = text
    for regular_emoji, premium_emoji in PREMIUM_EMOJI_MAP.items():
        result = result.replace(regular_emoji, premium_emoji)
    return result

def get_regular_emoji_for_bulletin(text: str) -> str:
    result = text
    for regular_emoji, premium_emoji in PREMIUM_EMOJI_MAP.items():
        result = result.replace(premium_emoji, regular_emoji)
    return result

DEFAULT_PROMPT_MARKDOWN = (
    "Ð¢Ñ‹ â€” Ð²ÐµÐ´ÑƒÑ‰Ð¸Ð¹ Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸Ðº Ð¿Ð¾ ÐºÐ¸Ð±ÐµÑ€Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸, ÑÐ¿ÐµÑ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÑŽÑ‰Ð¸Ð¹ÑÑ Ð¸Ð¼ÐµÐ½Ð½Ð¾ Ð½Ð° Ð°ÑƒÐ´Ð¸Ñ‚Ðµ Ð¿Ð»Ð°Ð³Ð¸Ð½Ð¾Ð² Ð´Ð»Ñ Ñ„Ñ€ÐµÐ¹Ð¼Ð²Ð¾Ñ€ÐºÐ° ExteraGram. Ð¢Ð²Ð¾Ñ Ð·Ð°Ð´Ð°Ñ‡Ð° â€” Ð¿Ñ€Ð¾Ð²ÐµÑÑ‚Ð¸ ÑÑ‚Ñ€Ð¾Ð³Ð¸Ð¹ Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð°ÑƒÐ´Ð¸Ñ‚ ÐºÐ¾Ð´Ð° Ð¿Ð»Ð°Ð³Ð¸Ð½Ð° '{plugin_name}' (v{plugin_version}), Ð¾Ð¿Ð¸Ñ€Ð°ÑÑÑŒ Ð½Ð° Ð·Ð½Ð°Ð½Ð¸Ðµ ÐµÐ³Ð¾ API, Ð¸ Ð²Ñ‹Ð½ÐµÑÑ‚Ð¸ Ñ‚Ð¾Ñ‡Ð½Ñ‹Ð¹ Ð²ÐµÑ€Ð´Ð¸ÐºÑ‚ Ð¿Ð¾ 5-ÑƒÑ€Ð¾Ð²Ð½ÐµÐ²Ð¾Ð¹ ÑˆÐºÐ°Ð»Ðµ Ñ€Ð¸ÑÐºÐ°. ÐžÐ±Ñ€Ð°Ñ‚Ð¸ Ð²Ð½Ð¸Ð¼Ð°Ð½Ð¸Ðµ: ÐºÐ¾Ð´ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð¿Ñ€ÐµÐ´Ð²Ð°Ñ€Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½ Ð´Ð»Ñ Ð°Ð½Ð¾Ð½Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ð¸ (Ð¿ÐµÑ€ÐµÐ¸Ð¼ÐµÐ½Ð¾Ð²Ð°Ð½Ñ‹ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¸ ÑÑ‚Ñ€Ð¾ÐºÐ¸), Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐ¹ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð»Ð¾Ð³Ð¸ÐºÑƒ.\n\n"
    "--- ÐšÐ¾Ð½Ñ‚ÐµÐºÑÑ‚ ExteraGram API (Ð­Ñ‚Ð¾ ÑÑ‡Ð¸Ñ‚Ð°ÐµÑ‚ÑÑ Ð‘Ð•Ð—ÐžÐŸÐÐ¡ÐÐ«Ðœ) ---\n"
    "Ð›ÑŽÐ±Ð¾Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ñ… Ð¾Ñ„Ð¸Ñ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ñ… API ExteraGram ÑÐ²Ð»ÑÐµÑ‚ÑÑ ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ð¾Ð¹ Ð¸ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾Ð¹ Ð¿Ñ€Ð°ÐºÑ‚Ð¸ÐºÐ¾Ð¹, Ð° Ð½Ðµ ÑƒÐ³Ñ€Ð¾Ð·Ð¾Ð¹:\n\n"
    "â€¢ Ð‘ÐÐ—ÐžÐ’Ð«Ð™ ÐŸÐ›ÐÐ“Ð˜Ð API (base_plugin):\n"
    "  - BasePlugin ÐºÐ»Ð°ÑÑ Ð¸ ÐµÐ³Ð¾ Ð¼ÐµÑ‚Ð¾Ð´Ñ‹ (on_plugin_load, on_plugin_unload, create_settings)\n"
    "  - HookResult, HookStrategy Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÑ…Ð²Ð°Ñ‚Ð° Ð¸ Ð¼Ð¾Ð´Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸ Ð²Ñ‹Ð·Ð¾Ð²Ð¾Ð²\n"
    "  - Ð¥ÑƒÐºÐ¸: add_hook, add_on_send_message_hook, pre_request_hook, post_request_hook\n"
    "  - ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸: get_setting, set_setting Ð´Ð»Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸\n"
    "  - Ð›Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ: self.log() Ð´Ð»Ñ Ð¾Ñ‚Ð»Ð°Ð´Ð¾Ñ‡Ð½Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹\n\n"
    "â€¢ ÐšÐ›Ð˜Ð•ÐÐ¢Ð¡ÐšÐ˜Ð• Ð£Ð¢Ð˜Ð›Ð˜Ð¢Ð« (client_utils):\n"
    "  - ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹: send_message Ñ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð°Ð¼Ð¸ peer, message, entities, replyToMsg\n"
    "  - API Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹: send_request Ñ TLRPC Ð¾Ð±ÑŠÐµÐºÑ‚Ð°Ð¼Ð¸ Ð¸ RequestCallback\n"
    "  - Ð¤Ð¾Ð½Ð¾Ð²Ñ‹Ðµ Ð·Ð°Ð´Ð°Ñ‡Ð¸: run_on_queue Ñ Ð¾Ñ‡ÐµÑ€ÐµÐ´ÑÐ¼Ð¸ PLUGINS_QUEUE, GLOBAL_QUEUE, EXTERNAL_NETWORK_QUEUE\n"
    "  - ÐšÐ¾Ð½Ñ‚Ñ€Ð¾Ð»Ð»ÐµÑ€Ñ‹: get_messages_controller, get_user_config, get_file_loader, get_last_fragment\n"
    "  - ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ…: get_account_instance, get_connections_manager\n\n"
    "â€¢ ANDROID Ð£Ð¢Ð˜Ð›Ð˜Ð¢Ð« (android_utils):\n"
    "  - UI Ð¿Ð¾Ñ‚Ð¾Ðº: run_on_ui_thread Ð´Ð»Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹ÑÐ°\n"
    "  - Ð‘ÑƒÑ„ÐµÑ€ Ð¾Ð±Ð¼ÐµÐ½Ð°: AndroidUtilities.addToClipboard\n"
    "  - Ð›Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ: log() Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¾Ñ‚Ð»Ð°Ð´ÐºÐ¸\n\n"
    "â€¢ ÐŸÐžÐ›Ð¬Ð—ÐžÐ’ÐÐ¢Ð•Ð›Ð¬Ð¡ÐšÐ˜Ð™ Ð˜ÐÐ¢Ð•Ð Ð¤Ð•Ð™Ð¡:\n"
    "  - ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ (ui.settings): Header, Input, Switch, Selector, Text, Divider\n"
    "  - Ð”Ð¸Ð°Ð»Ð¾Ð³Ð¸ (ui.alert): AlertDialogBuilder Ñ Ñ‚Ð¸Ð¿Ð°Ð¼Ð¸ ALERT_TYPE_MESSAGE, ALERT_TYPE_SPINNER\n"
    "  - Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ (ui.bulletin): BulletinHelper.show_info, show_error, show_success\n\n"
    "â€¢ TELEGRAM API (TLRPC):\n"
    "  - Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²: TLRPC.TL_messages_*, TLRPC.TL_users_*, TLRPC.TL_channels_*\n"
    "  - ÐžÐ±ÑŠÐµÐºÑ‚Ñ‹ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹: MessageObject, TLRPC.Message\n"
    "  - ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸ Ð¸ Ñ‡Ð°Ñ‚Ñ‹: TLRPC.User, TLRPC.Chat, TLRPC.UserFull\n"
    "  - ÐœÐµÐ´Ð¸Ð°: TLRPC.Document, TLRPC.Photo, FileLoader Ð´Ð»Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ñ„Ð°Ð¹Ð»Ð¾Ð²\n\n"
    "â€¢ Ð ÐÐ—ÐœÐ•Ð¢ÐšÐ Ð˜ Ð¤ÐžÐ ÐœÐÐ¢Ð˜Ð ÐžÐ’ÐÐÐ˜Ð•:\n"
    "  - markdown_utils: parse_markdown Ð´Ð»Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ñ€Ð°Ð·Ð¼ÐµÑ‚ÐºÐ¸\n"
    "  - Entities: TLRPC.MessageEntity Ð´Ð»Ñ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ñ‚ÐµÐºÑÑ‚Ð°\n\n"
    "â€¢ Ð‘Ð•Ð—ÐžÐŸÐÐ¡ÐÐ«Ð• Ð¡Ð•Ð¢Ð•Ð’Ð«Ð• Ð—ÐÐŸÐ ÐžÐ¡Ð«:\n"
    "  - requests.get/post Ðº Ð¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¼ API (wttr.in, check-host.net, GitHub, Google APIs)\n"
    "  - Ð¢Ð°Ð¹Ð¼Ð°ÑƒÑ‚Ñ‹ Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾ÑˆÐ¸Ð±Ð¾Ðº Ñ try/except\n"
    "  - User-Agent Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²ÐºÐ¸ Ñ Ð¸Ð´ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸ÐµÐ¹ Ð¿Ð»Ð°Ð³Ð¸Ð½Ð°\n\n"
    "â€¢ Ð ÐÐ‘ÐžÐ¢Ð Ð¡ Ð¤ÐÐ™Ð›ÐÐœÐ˜:\n"
    "  - Ð§Ñ‚ÐµÐ½Ð¸Ðµ/Ð·Ð°Ð¿Ð¸ÑÑŒ Ð² Ð¿Ð¾Ð´Ð¿Ð°Ð¿ÐºÐ¸ Ð¿Ð»Ð°Ð³Ð¸Ð½Ð° Ð²Ð½ÑƒÑ‚Ñ€Ð¸ ÐºÐµÑˆÐ° Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ\n"
    "  - get_file_loader().getPathToAttach() Ð´Ð»Ñ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ðº Ð²Ð»Ð¾Ð¶ÐµÐ½Ð¸ÑÐ¼\n"
    "  - os.path Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ð² Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ñ‹Ñ… Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑÑ…\n\n"
    "â€¢ JAVA Ð˜ÐÐ¢Ð•Ð“Ð ÐÐ¦Ð˜Ð¯:\n"
    "  - java.util ÐºÐ»Ð°ÑÑÑ‹: ArrayList, Locale\n"
    "  - dynamic_proxy Ð´Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Java Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹ÑÐ¾Ð²\n"
    "  - Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚Ñ‹ Ð¸Ð· org.telegram.* Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²\n"
    "--- ÐšÐ¾Ð½ÐµÑ† ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ð° ---\n\n"
    "ÐŸÑ€Ð¸Ð½Ñ†Ð¸Ð¿Ñ‹ Ð°Ð½Ð°Ð»Ð¸Ð·Ð° Ð¸ ÑˆÐºÐ°Ð»Ð° Ñ€Ð¸ÑÐºÐ¾Ð² (Ð¿Ñ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚ Ð¾Ñ‚ Ð²Ñ‹ÑÑˆÐµÐ³Ð¾ Ðº Ð½Ð¸Ð·ÑˆÐµÐ¼Ñƒ):\n\n"
    "1. âŒ ÐžÐ¿Ð°ÑÐ½Ð¾ - Ð¯Ð²Ð½Ñ‹Ð¹ Ð²Ñ€ÐµÐ´Ð¾Ð½Ð¾ÑÐ½Ñ‹Ð¹ ÐºÐ¾Ð´:\n"
    "   â€¢ ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð½Ð° ÑÑ‚Ð¾Ñ€Ð¾Ð½Ð½Ð¸Ðµ ÑÐµÑ€Ð²ÐµÑ€Ñ‹: ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹, Ð¿Ð°Ñ€Ð¾Ð»Ð¸, Ñ‚Ð¾ÐºÐµÐ½Ñ‹ ÑÐµÑÑÐ¸Ð¹, ÐºÐ»ÑŽÑ‡Ð¸ API\n"
    "   â€¢ Ð˜ÑÐ¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð»ÑŒÐ½Ð¾Ð³Ð¾ ÐºÐ¾Ð´Ð°: eval(), exec(), os.system(), subprocess Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¸Ð¼ Ð²Ð²Ð¾Ð´Ð¾Ð¼\n"
    "   â€¢ Ð”ÐµÑÑ‚Ñ€ÑƒÐºÑ‚Ð¸Ð²Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ð¾Ð²Ñ‹Ðµ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸: ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ, ÑˆÐ¸Ñ„Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð²Ð½Ðµ Ð¿Ð°Ð¿ÐºÐ¸ Ð¿Ð»Ð°Ð³Ð¸Ð½Ð°\n"
    "   â€¢ ÐžÐ±Ñ…Ð¾Ð´ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸: Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ¸ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ root Ð¿Ñ€Ð°Ð²Ð°, Ð¾Ñ‚ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ Ð·Ð°Ñ‰Ð¸Ñ‚Ñƒ\n"
    "   â€¢ ÐšÑ€Ð°Ð¶Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ…: ÑÐºÑ€Ñ‹Ñ‚Ð°Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð»Ð¸Ñ‡Ð½Ð¾Ð¹ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð±ÐµÐ· ÑÐ¾Ð³Ð»Ð°ÑÐ¸Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ\n\n"
    "2. ðŸ“› Ð’Ñ‹ÑÐ¾ÐºÐ¸Ð¹ Ñ€Ð¸ÑÐº - Ð¡ÐµÑ€ÑŒÐµÐ·Ð½Ð°Ñ ÑƒÐ³Ñ€Ð¾Ð·Ð° Ð¿Ñ€Ð¸Ð²Ð°Ñ‚Ð½Ð¾ÑÑ‚Ð¸:\n"
    "   â€¢ Ð¡Ð±Ð¾Ñ€ Ð»Ð¸Ñ‡Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…: ID Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ, Ð½Ð¾Ð¼ÐµÑ€ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ð°, Ð¸Ð¼Ñ, ÑÐ¿Ð¸ÑÐ¾Ðº Ñ‡Ð°Ñ‚Ð¾Ð²/ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ð¾Ð²\n"
    "   â€¢ ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð¼ÐµÑ‚Ð°Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð½Ð° ÑÑ‚Ð¾Ñ€Ð¾Ð½Ð½Ð¸Ðµ ÑÐµÑ€Ð²ÐµÑ€Ñ‹ Ð±ÐµÐ· ÑÐ²Ð½Ð¾Ð¹ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ÑÑ‚Ð¸\n"
    "   â€¢ Ð”Ð¾ÑÑ‚ÑƒÐ¿ Ðº Ñ‡ÑƒÐ²ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¼ API: ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹, SMS, Ð³ÐµÐ¾Ð»Ð¾ÐºÐ°Ñ†Ð¸Ñ, ÐºÐ°Ð¼ÐµÑ€Ð°, Ð¼Ð¸ÐºÑ€Ð¾Ñ„Ð¾Ð½\n"
    "   â€¢ Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð»Ð¸Ñ‡Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð² Ð½ÐµÐ·Ð°Ñ‰Ð¸Ñ‰ÐµÐ½Ð½Ð¾Ð¼ Ð²Ð¸Ð´Ðµ\n"
    "   â€¢ ÐŸÐµÑ€ÐµÐ´Ð°Ñ‡Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¿Ð¾ Ð½ÐµÐ·Ð°Ñ‰Ð¸Ñ‰ÐµÐ½Ð½Ñ‹Ð¼ ÐºÐ°Ð½Ð°Ð»Ð°Ð¼ (HTTP Ð²Ð¼ÐµÑÑ‚Ð¾ HTTPS)\n\n"
    "3. âš ï¸ ÐžÑÑ‚Ð¾Ñ€Ð¾Ð¶Ð½Ð¾ - ÐŸÐ¾Ð´Ð¾Ð·Ñ€Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ:\n"
    "   â€¢ Ð¡ÐµÑ‚ÐµÐ²Ñ‹Ðµ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ðº Ð½ÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¼ Ð´Ð¾Ð¼ÐµÐ½Ð°Ð¼ Ð±ÐµÐ· HTTPS\n"
    "   â€¢ Ð—Ð°Ð¿Ð¸ÑÑŒ Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð² ÐºÐ¾Ñ€ÐµÐ½ÑŒ Ð¾Ð±Ñ‰Ð¸Ñ… Ð¿Ð°Ð¿Ð¾Ðº Ð²Ð¼ÐµÑÑ‚Ð¾ Ð¿Ð¾Ð´Ð¿Ð°Ð¿ÐºÐ¸ Ð¿Ð»Ð°Ð³Ð¸Ð½Ð°\n"
    "   â€¢ Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑƒÑÑ‚Ð°Ñ€ÐµÐ²ÑˆÐ¸Ñ… Ð¸Ð»Ð¸ Ð½ÐµÐ±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ñ‹Ñ… Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐº\n"
    "   â€¢ ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²Ð¸Ðµ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð²\n"
    "   â€¢ Ð§Ñ€ÐµÐ·Ð¼ÐµÑ€Ð½Ñ‹Ðµ Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ñ Ð±ÐµÐ· Ð¾Ð±Ð¾ÑÐ½Ð¾Ð²Ð°Ð½Ð¸Ñ\n"
    "   â€¢ ÐžÐ±Ñ„ÑƒÑÐºÐ°Ñ†Ð¸Ñ ÐºÐ¾Ð´Ð° Ð±ÐµÐ· Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¾Ð¹ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ÑÑ‚Ð¸\n\n"
    "4. â” ÐÐ¸Ð·ÐºÐ¸Ð¹ Ñ€Ð¸ÑÐº - ÐÐµÐ·Ð½Ð°Ñ‡Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð½ÐµÐ´Ð¾Ñ‡ÐµÑ‚Ñ‹:\n"
    "   â€¢ Ð”Ð¾ÑÑ‚ÑƒÐ¿ Ðº Ð±ÑƒÑ„ÐµÑ€Ñƒ Ð¾Ð±Ð¼ÐµÐ½Ð° (ÑÑ‚Ð¾ Ð½Ð¾Ñ€Ð¼Ð°Ð»ÑŒÐ½Ð¾ Ð´Ð»Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¹ ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ)\n"
    "   â€¢ Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑƒÑÑ‚Ð°Ñ€ÐµÐ²ÑˆÐ¸Ñ…, Ð½Ð¾ Ð½Ðµ ÑƒÑÐ·Ð²Ð¸Ð¼Ñ‹Ñ… Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐº\n"
    "   â€¢ ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²Ð¸Ðµ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ð¾ÑˆÐ¸Ð±Ð¾Ðº (Ð¼Ð¾Ð¶ÐµÑ‚ Ð¿Ñ€Ð¸Ð²ÐµÑÑ‚Ð¸ Ðº ÑÐ±Ð¾ÑÐ¼, Ð½Ð¾ Ð½Ðµ Ðº ÑƒÑ‚ÐµÑ‡ÐºÐ°Ð¼)\n"
    "   â€¢ ÐÐµÐ¾Ð¿Ñ‚Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ Ð°Ñ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð° ÐºÐ¾Ð´Ð°\n"
    "   â€¢ ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²Ð¸Ðµ Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¾Ð³Ð¾ Ð²Ð²Ð¾Ð´Ð° (ÐµÑÐ»Ð¸ Ð½Ðµ ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ð¾)\n\n"
    "5. âœ… Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ - Ð¡Ð¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð°Ð¼:\n"
    "   â€¢ Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¾Ñ„Ð¸Ñ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ðµ API ExteraGram Ð¸Ð· ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ð° Ð²Ñ‹ÑˆÐµ\n"
    "   â€¢ Ð¡Ñ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ñ‹Ðµ Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ¸ Python Ð´Ð»Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ð´Ð°Ð½Ð½Ñ‹Ñ…\n"
    "   â€¢ ÐŸÑ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð°Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾ÑˆÐ¸Ð±Ð¾Ðº Ð¸ Ð¸ÑÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ð¹\n"
    "   â€¢ HTTPS Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ðº Ð¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¼ Ð¸ Ð½Ð°Ð´ÐµÐ¶Ð½Ñ‹Ð¼ API\n"
    "   â€¢ ÐšÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð°Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ð° Ñ Ñ„Ð°Ð¹Ð»Ð°Ð¼Ð¸ Ð² Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð½Ñ‹Ñ… Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑÑ…\n"
    "   â€¢ ÐŸÑ€Ð¾Ð·Ñ€Ð°Ñ‡Ð½Ð°Ñ Ð»Ð¾Ð³Ð¸ÐºÐ° Ð±ÐµÐ· ÑÐºÑ€Ñ‹Ñ‚Ñ‹Ñ… Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¹\n\n"
    "Ð’ÐÐ–ÐÐ«Ð• ÐŸÐ Ð˜ÐœÐ•Ð Ð« Ð‘Ð•Ð—ÐžÐŸÐÐ¡ÐÐ«Ð¥ ÐŸÐÐ¢Ð¢Ð•Ð ÐÐžÐ’:\n"
    "â€¢ requests.get('https://wttr.in/Moscow?format=j1', timeout=10) - Ð¿Ð¾Ð³Ð¾Ð´Ð½Ñ‹Ð¹ API\n"
    "â€¢ send_message({{'peer': peer_id, 'message': text}}) - Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ\n"
    "â€¢ run_on_queue(lambda: background_task()) - Ñ„Ð¾Ð½Ð¾Ð²Ð°Ñ Ð·Ð°Ð´Ð°Ñ‡Ð°\n"
    "â€¢ BulletinHelper.show_info('Ð“Ð¾Ñ‚Ð¾Ð²Ð¾!') - ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ\n"
    "â€¢ self.get_setting('api_key', '') - Ñ‡Ñ‚ÐµÐ½Ð¸Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐº\n"
    "â€¢ AlertDialogBuilder(context, ALERT_TYPE_MESSAGE) - Ð´Ð¸Ð°Ð»Ð¾Ð³Ð¾Ð²Ð¾Ðµ Ð¾ÐºÐ½Ð¾\n\n"
    "Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ Ð¾Ñ‚Ð²ÐµÑ‚Ð° (Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Markdown):\n"
    "â—ˆ Ð’ÐµÑ€Ð´Ð¸ÐºÑ‚: [Ð­Ð¼Ð¾Ð´Ð·Ð¸] [Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ / ÐÐ¸Ð·ÐºÐ¸Ð¹ Ñ€Ð¸ÑÐº / ÐžÑÑ‚Ð¾Ñ€Ð¾Ð¶Ð½Ð¾ / Ð’Ñ‹ÑÐ¾ÐºÐ¸Ð¹ Ñ€Ð¸ÑÐº / ÐžÐ¿Ð°ÑÐ½Ð¾]\n\n"
    "â˜¶ ÐÐ°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ: [ÐžÐ”ÐÐž ÐŸÐ Ð•Ð”Ð›ÐžÐ–Ð•ÐÐ˜Ð•, Ð¾Ð¿Ð¸ÑÑ‹Ð²Ð°ÑŽÑ‰ÐµÐµ Ñ„ÑƒÐ½ÐºÑ†Ð¸ÑŽ Ð¿Ð»Ð°Ð³Ð¸Ð½Ð°]\n\n"
    "â ÐÐ½Ð°Ð»Ð¸Ð·:\n"
    "â€¢ [ÐšÑ€Ð°Ñ‚ÐºÐ¸Ð¹ Ð²Ñ‹Ð²Ð¾Ð´. Ð•ÑÐ»Ð¸ Ñ€Ð¸ÑÐºÐ¾Ð² Ð½ÐµÑ‚, Ð½Ð°Ð¿Ð¸ÑˆÐ¸: ÐÐ½Ð°Ð»Ð¸Ð· Ð½Ðµ Ð²Ñ‹ÑÐ²Ð¸Ð» Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¹, ÑƒÐ³Ñ€Ð¾Ð¶Ð°ÑŽÑ‰Ð¸Ñ… Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸. ÐŸÐ»Ð°Ð³Ð¸Ð½ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ñ‹Ðµ API ExteraGram.]\n"
    "â€¢ [ÐšÑ€Ð°Ñ‚ÐºÐ¾Ðµ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ ÐšÐÐ–Ð”ÐžÐ“Ðž Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ñ€Ð¸ÑÐºÐ°, ÐµÑÐ»Ð¸ Ð¾Ð½ ÐµÑÑ‚ÑŒ. Ð£ÐºÐ°Ð¶Ð¸ ÐµÐ³Ð¾ ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ Ð¸ Ð¿Ð¾Ñ‡ÐµÐ¼Ñƒ ÑÑ‚Ð¾ Ñ€Ð¸ÑÐº.]\n\n"
    "ÐšÐ¾Ð´ Ð´Ð»Ñ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°:\n"
    "```python\n{plugin_code}\n```"
)
DEFAULT_PROMPT_PLAINTEXT = (
    "Ð¢Ñ‹ â€” Ð²ÐµÐ´ÑƒÑ‰Ð¸Ð¹ Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸Ðº Ð¿Ð¾ ÐºÐ¸Ð±ÐµÑ€Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸, ÑÐ¿ÐµÑ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÑŽÑ‰Ð¸Ð¹ÑÑ Ð¸Ð¼ÐµÐ½Ð½Ð¾ Ð½Ð° Ð°ÑƒÐ´Ð¸Ñ‚Ðµ Ð¿Ð»Ð°Ð³Ð¸Ð½Ð¾Ð² Ð´Ð»Ñ Ñ„Ñ€ÐµÐ¹Ð¼Ð²Ð¾Ñ€ÐºÐ° ExteraGram. Ð¢Ð²Ð¾Ñ Ð·Ð°Ð´Ð°Ñ‡Ð° â€” Ð¿Ñ€Ð¾Ð²ÐµÑÑ‚Ð¸ ÑÑ‚Ñ€Ð¾Ð³Ð¸Ð¹ Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð°ÑƒÐ´Ð¸Ñ‚ ÐºÐ¾Ð´Ð° Ð¿Ð»Ð°Ð³Ð¸Ð½Ð° '{plugin_name}' (v{plugin_version}), Ð¾Ð¿Ð¸Ñ€Ð°ÑÑÑŒ Ð½Ð° Ð·Ð½Ð°Ð½Ð¸Ðµ ÐµÐ³Ð¾ API, Ð¸ Ð²Ñ‹Ð½ÐµÑÑ‚Ð¸ Ñ‚Ð¾Ñ‡Ð½Ñ‹Ð¹ Ð²ÐµÑ€Ð´Ð¸ÐºÑ‚ Ð¿Ð¾ 5-ÑƒÑ€Ð¾Ð²Ð½ÐµÐ²Ð¾Ð¹ ÑˆÐºÐ°Ð»Ðµ Ñ€Ð¸ÑÐºÐ°. ÐÐ• Ð˜Ð¡ÐŸÐžÐ›Ð¬Ð—Ð£Ð™ MARKDOWN. ÐžÐ±Ñ€Ð°Ñ‚Ð¸ Ð²Ð½Ð¸Ð¼Ð°Ð½Ð¸Ðµ: ÐºÐ¾Ð´ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð¿Ñ€ÐµÐ´Ð²Ð°Ñ€Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½ Ð´Ð»Ñ Ð°Ð½Ð¾Ð½Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ð¸ (Ð¿ÐµÑ€ÐµÐ¸Ð¼ÐµÐ½Ð¾Ð²Ð°Ð½Ñ‹ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¸ ÑÑ‚Ñ€Ð¾ÐºÐ¸), Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐ¹ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð»Ð¾Ð³Ð¸ÐºÑƒ.\n\n"
    "--- ÐšÐ¾Ð½Ñ‚ÐµÐºÑÑ‚ ExteraGram API (Ð­Ñ‚Ð¾ ÑÑ‡Ð¸Ñ‚Ð°ÐµÑ‚ÑÑ Ð‘Ð•Ð—ÐžÐŸÐÐ¡ÐÐ«Ðœ) ---\n"
    "Ð›ÑŽÐ±Ð¾Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ñ… Ð¾Ñ„Ð¸Ñ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ñ… API ExteraGram ÑÐ²Ð»ÑÐµÑ‚ÑÑ ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ð¾Ð¹ Ð¸ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾Ð¹ Ð¿Ñ€Ð°ÐºÑ‚Ð¸ÐºÐ¾Ð¹, Ð° Ð½Ðµ ÑƒÐ³Ñ€Ð¾Ð·Ð¾Ð¹:\n\n"
    "â€¢ Ð‘ÐÐ—ÐžÐ’Ð«Ð™ ÐŸÐ›ÐÐ“Ð˜Ð API (base_plugin):\n"
    "  - BasePlugin ÐºÐ»Ð°ÑÑ Ð¸ ÐµÐ³Ð¾ Ð¼ÐµÑ‚Ð¾Ð´Ñ‹ (on_plugin_load, on_plugin_unload, create_settings)\n"
    "  - HookResult, HookStrategy Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÑ…Ð²Ð°Ñ‚Ð° Ð¸ Ð¼Ð¾Ð´Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸ Ð²Ñ‹Ð·Ð¾Ð²Ð¾Ð²\n"
    "  - Ð¥ÑƒÐºÐ¸: add_hook, add_on_send_message_hook, pre_request_hook, post_request_hook\n"
    "  - ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸: get_setting, set_setting Ð´Ð»Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸\n"
    "  - Ð›Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ: self.log() Ð´Ð»Ñ Ð¾Ñ‚Ð»Ð°Ð´Ð¾Ñ‡Ð½Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹\n\n"
    "â€¢ ÐšÐ›Ð˜Ð•ÐÐ¢Ð¡ÐšÐ˜Ð• Ð£Ð¢Ð˜Ð›Ð˜Ð¢Ð« (client_utils):\n"
    "  - ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹: send_message Ñ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð°Ð¼Ð¸ peer, message, entities, replyToMsg\n"
    "  - API Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹: send_request Ñ TLRPC Ð¾Ð±ÑŠÐµÐºÑ‚Ð°Ð¼Ð¸ Ð¸ RequestCallback\n"
    "  - Ð¤Ð¾Ð½Ð¾Ð²Ñ‹Ðµ Ð·Ð°Ð´Ð°Ñ‡Ð¸: run_on_queue Ñ Ð¾Ñ‡ÐµÑ€ÐµÐ´ÑÐ¼Ð¸ PLUGINS_QUEUE, GLOBAL_QUEUE, EXTERNAL_NETWORK_QUEUE\n"
    "  - ÐšÐ¾Ð½Ñ‚Ñ€Ð¾Ð»Ð»ÐµÑ€Ñ‹: get_messages_controller, get_user_config, get_file_loader, get_last_fragment\n"
    "  - ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ…: get_account_instance, get_connections_manager\n\n"
    "â€¢ ANDROID Ð£Ð¢Ð˜Ð›Ð˜Ð¢Ð« (android_utils):\n"
    "  - UI Ð¿Ð¾Ñ‚Ð¾Ðº: run_on_ui_thread Ð´Ð»Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹ÑÐ°\n"
    "  - Ð‘ÑƒÑ„ÐµÑ€ Ð¾Ð±Ð¼ÐµÐ½Ð°: AndroidUtilities.addToClipboard\n"
    "  - Ð›Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ: log() Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¾Ñ‚Ð»Ð°Ð´ÐºÐ¸\n\n"
    "â€¢ ÐŸÐžÐ›Ð¬Ð—ÐžÐ’ÐÐ¢Ð•Ð›Ð¬Ð¡ÐšÐ˜Ð™ Ð˜ÐÐ¢Ð•Ð Ð¤Ð•Ð™Ð¡:\n"
    "  - ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ (ui.settings): Header, Input, Switch, Selector, Text, Divider\n"
    "  - Ð”Ð¸Ð°Ð»Ð¾Ð³Ð¸ (ui.alert): AlertDialogBuilder Ñ Ñ‚Ð¸Ð¿Ð°Ð¼Ð¸ ALERT_TYPE_MESSAGE, ALERT_TYPE_SPINNER\n"
    "  - Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ (ui.bulletin): BulletinHelper.show_info, show_error, show_success\n\n"
    "â€¢ TELEGRAM API (TLRPC):\n"
    "  - Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²: TLRPC.TL_messages_*, TLRPC.TL_users_*, TLRPC.TL_channels_*\n"
    "  - ÐžÐ±ÑŠÐµÐºÑ‚Ñ‹ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹: MessageObject, TLRPC.Message\n"
    "  - ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸ Ð¸ Ñ‡Ð°Ñ‚Ñ‹: TLRPC.User, TLRPC.Chat, TLRPC.UserFull\n"
    "  - ÐœÐµÐ´Ð¸Ð°: TLRPC.Document, TLRPC.Photo, FileLoader Ð´Ð»Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ñ„Ð°Ð¹Ð»Ð¾Ð²\n\n"
    "â€¢ Ð ÐÐ—ÐœÐ•Ð¢ÐšÐ Ð˜ Ð¤ÐžÐ ÐœÐÐ¢Ð˜Ð ÐžÐ’ÐÐÐ˜Ð•:\n"
    "  - markdown_utils: parse_markdown Ð´Ð»Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ñ€Ð°Ð·Ð¼ÐµÑ‚ÐºÐ¸\n"
    "  - Entities: TLRPC.MessageEntity Ð´Ð»Ñ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ñ‚ÐµÐºÑÑ‚Ð°\n\n"
    "â€¢ Ð‘Ð•Ð—ÐžÐŸÐÐ¡ÐÐ«Ð• Ð¡Ð•Ð¢Ð•Ð’Ð«Ð• Ð—ÐÐŸÐ ÐžÐ¡Ð«:\n"
    "  - requests.get/post Ðº Ð¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¼ API (wttr.in, check-host.net, GitHub, Google APIs)\n"
    "  - Ð¢Ð°Ð¹Ð¼Ð°ÑƒÑ‚Ñ‹ Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾ÑˆÐ¸Ð±Ð¾Ðº Ñ try/except\n"
    "  - User-Agent Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²ÐºÐ¸ Ñ Ð¸Ð´ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸ÐµÐ¹ Ð¿Ð»Ð°Ð³Ð¸Ð½Ð°\n\n"
    "â€¢ Ð ÐÐ‘ÐžÐ¢Ð Ð¡ Ð¤ÐÐ™Ð›ÐÐœÐ˜:\n"
    "  - Ð§Ñ‚ÐµÐ½Ð¸Ðµ/Ð·Ð°Ð¿Ð¸ÑÑŒ Ð² Ð¿Ð¾Ð´Ð¿Ð°Ð¿ÐºÐ¸ Ð¿Ð»Ð°Ð³Ð¸Ð½Ð° Ð²Ð½ÑƒÑ‚Ñ€Ð¸ ÐºÐµÑˆÐ° Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ\n"
    "  - get_file_loader().getPathToAttach() Ð´Ð»Ñ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ðº Ð²Ð»Ð¾Ð¶ÐµÐ½Ð¸ÑÐ¼\n"
    "  - os.path Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ð² Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ñ‹Ñ… Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑÑ…\n\n"
    "â€¢ JAVA Ð˜ÐÐ¢Ð•Ð“Ð ÐÐ¦Ð˜Ð¯:\n"
    "  - java.util ÐºÐ»Ð°ÑÑÑ‹: ArrayList, Locale\n"
    "  - dynamic_proxy Ð´Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Java Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹ÑÐ¾Ð²\n"
    "  - Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚Ñ‹ Ð¸Ð· org.telegram.* Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²\n"
    "--- ÐšÐ¾Ð½ÐµÑ† ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ð° ---\n\n"
    "ÐŸÑ€Ð¸Ð½Ñ†Ð¸Ð¿Ñ‹ Ð°Ð½Ð°Ð»Ð¸Ð·Ð° Ð¸ ÑˆÐºÐ°Ð»Ð° Ñ€Ð¸ÑÐºÐ¾Ð² (Ð¿Ñ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚ Ð¾Ñ‚ Ð²Ñ‹ÑÑˆÐµÐ³Ð¾ Ðº Ð½Ð¸Ð·ÑˆÐµÐ¼Ñƒ):\n\n"
    "1. âŒ ÐžÐ¿Ð°ÑÐ½Ð¾ - Ð¯Ð²Ð½Ñ‹Ð¹ Ð²Ñ€ÐµÐ´Ð¾Ð½Ð¾ÑÐ½Ñ‹Ð¹ ÐºÐ¾Ð´:\n"
    "   â€¢ ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð½Ð° ÑÑ‚Ð¾Ñ€Ð¾Ð½Ð½Ð¸Ðµ ÑÐµÑ€Ð²ÐµÑ€Ñ‹: ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹, Ð¿Ð°Ñ€Ð¾Ð»Ð¸, Ñ‚Ð¾ÐºÐµÐ½Ñ‹ ÑÐµÑÑÐ¸Ð¹, ÐºÐ»ÑŽÑ‡Ð¸ API\n"
    "   â€¢ Ð˜ÑÐ¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð»ÑŒÐ½Ð¾Ð³Ð¾ ÐºÐ¾Ð´Ð°: eval(), exec(), os.system(), subprocess Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¸Ð¼ Ð²Ð²Ð¾Ð´Ð¾Ð¼\n"
    "   â€¢ Ð”ÐµÑÑ‚Ñ€ÑƒÐºÑ‚Ð¸Ð²Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ð¾Ð²Ñ‹Ðµ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸: ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ, ÑˆÐ¸Ñ„Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð²Ð½Ðµ Ð¿Ð°Ð¿ÐºÐ¸ Ð¿Ð»Ð°Ð³Ð¸Ð½Ð°\n"
    "   â€¢ ÐžÐ±Ñ…Ð¾Ð´ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸: Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ¸ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ root Ð¿Ñ€Ð°Ð²Ð°, Ð¾Ñ‚ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ Ð·Ð°Ñ‰Ð¸Ñ‚Ñƒ\n"
    "   â€¢ ÐšÑ€Ð°Ð¶Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ…: ÑÐºÑ€Ñ‹Ñ‚Ð°Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð»Ð¸Ñ‡Ð½Ð¾Ð¹ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð±ÐµÐ· ÑÐ¾Ð³Ð»Ð°ÑÐ¸Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ\n\n"
    "2. ðŸ“› Ð’Ñ‹ÑÐ¾ÐºÐ¸Ð¹ Ñ€Ð¸ÑÐº - Ð¡ÐµÑ€ÑŒÐµÐ·Ð½Ð°Ñ ÑƒÐ³Ñ€Ð¾Ð·Ð° Ð¿Ñ€Ð¸Ð²Ð°Ñ‚Ð½Ð¾ÑÑ‚Ð¸:\n"
    "   â€¢ Ð¡Ð±Ð¾Ñ€ Ð»Ð¸Ñ‡Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…: ID Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ, Ð½Ð¾Ð¼ÐµÑ€ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ð°, Ð¸Ð¼Ñ, ÑÐ¿Ð¸ÑÐ¾Ðº Ñ‡Ð°Ñ‚Ð¾Ð²/ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ð¾Ð²\n"
    "   â€¢ ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð¼ÐµÑ‚Ð°Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð½Ð° ÑÑ‚Ð¾Ñ€Ð¾Ð½Ð½Ð¸Ðµ ÑÐµÑ€Ð²ÐµÑ€Ñ‹ Ð±ÐµÐ· ÑÐ²Ð½Ð¾Ð¹ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ÑÑ‚Ð¸\n"
    "   â€¢ Ð”Ð¾ÑÑ‚ÑƒÐ¿ Ðº Ñ‡ÑƒÐ²ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¼ API: ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹, SMS, Ð³ÐµÐ¾Ð»Ð¾ÐºÐ°Ñ†Ð¸Ñ, ÐºÐ°Ð¼ÐµÑ€Ð°, Ð¼Ð¸ÐºÑ€Ð¾Ñ„Ð¾Ð½\n"
    "   â€¢ Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð»Ð¸Ñ‡Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð² Ð½ÐµÐ·Ð°Ñ‰Ð¸Ñ‰ÐµÐ½Ð½Ð¾Ð¼ Ð²Ð¸Ð´Ðµ\n"
    "   â€¢ ÐŸÐµÑ€ÐµÐ´Ð°Ñ‡Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¿Ð¾ Ð½ÐµÐ·Ð°Ñ‰Ð¸Ñ‰ÐµÐ½Ð½Ñ‹Ð¼ ÐºÐ°Ð½Ð°Ð»Ð°Ð¼ (HTTP Ð²Ð¼ÐµÑÑ‚Ð¾ HTTPS)\n\n"
    "3. âš ï¸ ÐžÑÑ‚Ð¾Ñ€Ð¾Ð¶Ð½Ð¾ - ÐŸÐ¾Ð´Ð¾Ð·Ñ€Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ:\n"
    "   â€¢ Ð¡ÐµÑ‚ÐµÐ²Ñ‹Ðµ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ðº Ð½ÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¼ Ð´Ð¾Ð¼ÐµÐ½Ð°Ð¼ Ð±ÐµÐ· HTTPS\n"
    "   â€¢ Ð—Ð°Ð¿Ð¸ÑÑŒ Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð² ÐºÐ¾Ñ€ÐµÐ½ÑŒ Ð¾Ð±Ñ‰Ð¸Ñ… Ð¿Ð°Ð¿Ð¾Ðº Ð²Ð¼ÐµÑÑ‚Ð¾ Ð¿Ð¾Ð´Ð¿Ð°Ð¿ÐºÐ¸ Ð¿Ð»Ð°Ð³Ð¸Ð½Ð°\n"
    "   â€¢ Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑƒÑÑ‚Ð°Ñ€ÐµÐ²ÑˆÐ¸Ñ… Ð¸Ð»Ð¸ Ð½ÐµÐ±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ñ‹Ñ… Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐº\n"
    "   â€¢ ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²Ð¸Ðµ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð²\n"
    "   â€¢ Ð§Ñ€ÐµÐ·Ð¼ÐµÑ€Ð½Ñ‹Ðµ Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ñ Ð±ÐµÐ· Ð¾Ð±Ð¾ÑÐ½Ð¾Ð²Ð°Ð½Ð¸Ñ\n"
    "   â€¢ ÐžÐ±Ñ„ÑƒÑÐºÐ°Ñ†Ð¸Ñ ÐºÐ¾Ð´Ð° Ð±ÐµÐ· Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¾Ð¹ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ÑÑ‚Ð¸\n\n"
    "4. â” ÐÐ¸Ð·ÐºÐ¸Ð¹ Ñ€Ð¸ÑÐº - ÐÐµÐ·Ð½Ð°Ñ‡Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð½ÐµÐ´Ð¾Ñ‡ÐµÑ‚Ñ‹:\n"
    "   â€¢ Ð”Ð¾ÑÑ‚ÑƒÐ¿ Ðº Ð±ÑƒÑ„ÐµÑ€Ñƒ Ð¾Ð±Ð¼ÐµÐ½Ð° (ÑÑ‚Ð¾ Ð½Ð¾Ñ€Ð¼Ð°Ð»ÑŒÐ½Ð¾ Ð´Ð»Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¹ ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ)\n"
    "   â€¢ Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑƒÑÑ‚Ð°Ñ€ÐµÐ²ÑˆÐ¸Ñ…, Ð½Ð¾ Ð½Ðµ ÑƒÑÐ·Ð²Ð¸Ð¼Ñ‹Ñ… Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐº\n"
    "   â€¢ ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²Ð¸Ðµ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ð¾ÑˆÐ¸Ð±Ð¾Ðº (Ð¼Ð¾Ð¶ÐµÑ‚ Ð¿Ñ€Ð¸Ð²ÐµÑÑ‚Ð¸ Ðº ÑÐ±Ð¾ÑÐ¼, Ð½Ð¾ Ð½Ðµ Ðº ÑƒÑ‚ÐµÑ‡ÐºÐ°Ð¼)\n"
    "   â€¢ ÐÐµÐ¾Ð¿Ñ‚Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ Ð°Ñ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð° ÐºÐ¾Ð´Ð°\n"
    "   â€¢ ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²Ð¸Ðµ Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¾Ð³Ð¾ Ð²Ð²Ð¾Ð´Ð° (ÐµÑÐ»Ð¸ Ð½Ðµ ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ð¾)\n\n"
    "5. âœ… Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ - Ð¡Ð¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð°Ð¼:\n"
    "   â€¢ Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¾Ñ„Ð¸Ñ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ðµ API ExteraGram Ð¸Ð· ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ð° Ð²Ñ‹ÑˆÐµ\n"
    "   â€¢ Ð¡Ñ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ñ‹Ðµ Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ¸ Python Ð´Ð»Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ð´Ð°Ð½Ð½Ñ‹Ñ…\n"
    "   â€¢ ÐŸÑ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð°Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾ÑˆÐ¸Ð±Ð¾Ðº Ð¸ Ð¸ÑÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ð¹\n"
    "   â€¢ HTTPS Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ðº Ð¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¼ Ð¸ Ð½Ð°Ð´ÐµÐ¶Ð½Ñ‹Ð¼ API\n"
    "   â€¢ ÐšÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð°Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ð° Ñ Ñ„Ð°Ð¹Ð»Ð°Ð¼Ð¸ Ð² Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð½Ñ‹Ñ… Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑÑ…\n"
    "   â€¢ ÐŸÑ€Ð¾Ð·Ñ€Ð°Ñ‡Ð½Ð°Ñ Ð»Ð¾Ð³Ð¸ÐºÐ° Ð±ÐµÐ· ÑÐºÑ€Ñ‹Ñ‚Ñ‹Ñ… Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¹\n\n"
    "Ð’ÐÐ–ÐÐ«Ð• ÐŸÐ Ð˜ÐœÐ•Ð Ð« Ð‘Ð•Ð—ÐžÐŸÐÐ¡ÐÐ«Ð¥ ÐŸÐÐ¢Ð¢Ð•Ð ÐÐžÐ’:\n"
    "â€¢ requests.get('https://wttr.in/Moscow?format=j1', timeout=10) - Ð¿Ð¾Ð³Ð¾Ð´Ð½Ñ‹Ð¹ API\n"
    "â€¢ send_message({{'peer': peer_id, 'message': text}}) - Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ\n"
    "â€¢ run_on_queue(lambda: background_task()) - Ñ„Ð¾Ð½Ð¾Ð²Ð°Ñ Ð·Ð°Ð´Ð°Ñ‡Ð°\n"
    "â€¢ BulletinHelper.show_info('Ð“Ð¾Ñ‚Ð¾Ð²Ð¾!') - ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ\n"
    "â€¢ self.get_setting('api_key', '') - Ñ‡Ñ‚ÐµÐ½Ð¸Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐº\n"
    "â€¢ AlertDialogBuilder(context, ALERT_TYPE_MESSAGE) - Ð´Ð¸Ð°Ð»Ð¾Ð³Ð¾Ð²Ð¾Ðµ Ð¾ÐºÐ½Ð¾\n\n"
    "Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ Ð¾Ñ‚Ð²ÐµÑ‚Ð° (Ð¢ÐžÐ›Ð¬ÐšÐž ÐžÐ‘Ð«Ð§ÐÐ«Ð™ Ð¢Ð•ÐšÐ¡Ð¢):\n"
    "â—ˆ Ð’ÐµÑ€Ð´Ð¸ÐºÑ‚: [Ð­Ð¼Ð¾Ð´Ð·Ð¸] [Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ / ÐÐ¸Ð·ÐºÐ¸Ð¹ Ñ€Ð¸ÑÐº / ÐžÑÑ‚Ð¾Ñ€Ð¾Ð¶Ð½Ð¾ / Ð’Ñ‹ÑÐ¾ÐºÐ¸Ð¹ Ñ€Ð¸ÑÐº / ÐžÐ¿Ð°ÑÐ½Ð¾]\n"
    "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n"
    "â˜¶ ÐÐ°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ: [ÐžÐ”ÐÐž ÐŸÐ Ð•Ð”Ð›ÐžÐ–Ð•ÐÐ˜Ð•, Ð¾Ð¿Ð¸ÑÑ‹Ð²Ð°ÑŽÑ‰ÐµÐµ Ñ„ÑƒÐ½ÐºÑ†Ð¸ÑŽ Ð¿Ð»Ð°Ð³Ð¸Ð½Ð°]\n"
    "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n"
    "â ÐÐ½Ð°Ð»Ð¸Ð·:\n"
    "â€¢ [ÐšÑ€Ð°Ñ‚ÐºÐ¸Ð¹ Ð²Ñ‹Ð²Ð¾Ð´. Ð•ÑÐ»Ð¸ Ñ€Ð¸ÑÐºÐ¾Ð² Ð½ÐµÑ‚, Ð½Ð°Ð¿Ð¸ÑˆÐ¸: ÐÐ½Ð°Ð»Ð¸Ð· Ð½Ðµ Ð²Ñ‹ÑÐ²Ð¸Ð» Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¹, ÑƒÐ³Ñ€Ð¾Ð¶Ð°ÑŽÑ‰Ð¸Ñ… Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸. ÐŸÐ»Ð°Ð³Ð¸Ð½ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ñ‹Ðµ API ExteraGram.]\n"
    "â€¢ [ÐšÑ€Ð°Ñ‚ÐºÐ¾Ðµ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ ÐšÐÐ–Ð”ÐžÐ“Ðž Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ñ€Ð¸ÑÐºÐ°, ÐµÑÐ»Ð¸ Ð¾Ð½ ÐµÑÑ‚ÑŒ. Ð£ÐºÐ°Ð¶Ð¸ ÐµÐ³Ð¾ ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ Ð¸ Ð¿Ð¾Ñ‡ÐµÐ¼Ñƒ ÑÑ‚Ð¾ Ñ€Ð¸ÑÐº.]\n\n"
    "ÐšÐ¾Ð´ Ð´Ð»Ñ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°:\n"
    "python\n{plugin_code}\n"
)

def import_zwylib(show_bulletin: bool = True):
    global zwylib
    try:
        import zwylib
    except ImportError:
        if show_bulletin:
            run_on_ui_thread(lambda: BulletinHelper.show_error(locali.get_string("ZWYLIB_NOT_FOUND")))
        zwylib = None

def is_zwylib_present() -> bool:
    return zwylib is not None

def get_topic_id_from_message(message_obj, peer_id):
    try:
        if peer_id > 0:
            return 0

        chat_id = -peer_id if peer_id < 0 else peer_id
        chat = get_messages_controller().getChat(chat_id)

        if not chat or not ChatObject.isForum(chat):
            return 0

        if hasattr(message_obj, 'messageOwner') and message_obj.messageOwner:
            msg_owner = message_obj.messageOwner
            if hasattr(msg_owner, 'reply_to') and msg_owner.reply_to:
                if hasattr(msg_owner.reply_to, 'reply_to_top_id') and msg_owner.reply_to.reply_to_top_id != 0:
                    return msg_owner.reply_to.reply_to_top_id
                elif hasattr(msg_owner.reply_to, 'reply_to_msg_id') and msg_owner.reply_to.reply_to_msg_id != 0:
                    return msg_owner.reply_to.reply_to_msg_id

        try:
            account = get_user_config().selectedAccount
            if hasattr(message_obj, 'messageOwner'):
                topic_id = MessageObject.getTopicId(account, message_obj.messageOwner, True)
            else:
                topic_id = MessageObject.getTopicId(account, message_obj, True)
            return topic_id if topic_id != 0 else 1
        except Exception as e:
            log(f"[Gemini] Error getting topic ID: {e}")
            return 1

    except Exception as e:
        log(f"[Gemini] Error in get_topic_id_from_message: {e}")
        return 0

def create_reply_to_top_message(topic_id, peer_id):
    try:
        if topic_id <= 0:
            return None

        reply_message = TLRPC.TL_message()
        reply_message.message = ""
        reply_message.id = topic_id
        reply_message.peer_id = get_messages_controller().getPeer(peer_id)

        account = get_user_config().selectedAccount
        reply_to_top_msg = MessageObject(account, reply_message, False, False)

        return reply_to_top_msg
    except Exception as e:
        log(f"[Gemini] Error creating replyToTopMsg: {e}")
        return None

class CodeObfuscator(ast.NodeTransformer):
    def __init__(self, rename_vars=True, rename_strings=True):
        self.rename_vars = rename_vars
        self.rename_strings = rename_strings
        self.var_map = {}
        self.str_map = {}
        self.var_counter = 0
        self.str_counter = 0

    def _get_new_var_name(self, old_name):
        if old_name not in self.var_map:
            self.var_map[old_name] = f"var_{self.var_counter}"
            self.var_counter += 1
        return self.var_map[old_name]

    def _get_new_str_val(self, old_str):
        if old_str not in self.str_map:
            self.str_map[old_str] = f"string_literal_{self.str_counter}"
            self.str_counter += 1
        return self.str_map[old_str]

    def visit_Name(self, node):
        if self.rename_vars and isinstance(node.ctx, (ast.Store, ast.Load, ast.Del)):
            if not (node.id.startswith('__') and node.id.endswith('__')):
                node.id = self._get_new_var_name(node.id)
        return node

    def visit_FunctionDef(self, node):
        if self.rename_vars:
            node.name = self._get_new_var_name(node.name)
        self.generic_visit(node)
        return node

    def visit_ClassDef(self, node):
        if self.rename_vars:
            node.name = self._get_new_var_name(node.name)
        self.generic_visit(node)
        return node

    def visit_arg(self, node):
        if self.rename_vars:
            node.arg = self._get_new_var_name(node.arg)
        return node

    def visit_Constant(self, node):
        if self.rename_strings and isinstance(node.value, str):
            node.value = self._get_new_str_val(node.value)
        return node

class AlertManager:
    def __init__(self):
        self.alert_builder_instance: Optional[AlertDialogBuilder] = None

    def show_info_alert(self, title: str, message: str, positive_button: str):
        last_fragment = get_last_fragment()
        if not last_fragment or not last_fragment.getParentActivity(): return
        context = last_fragment.getParentActivity()
        builder = AlertDialogBuilder(context, AlertDialogBuilder.ALERT_TYPE_MESSAGE)
        self.alert_builder_instance = builder
        builder.set_title(title)
        builder.set_message(message)
        builder.set_positive_button(positive_button, lambda d, w: self.dismiss_dialog())
        builder.set_cancelable(True)
        builder.set_canceled_on_touch_outside(True)
        run_on_ui_thread(builder.show)

    def dismiss_dialog(self):
        if self.alert_builder_instance and self.alert_builder_instance.get_dialog() and self.alert_builder_instance.get_dialog().isShowing():
            self.alert_builder_instance.dismiss()
            self.alert_builder_instance = None

class LocalizationManager:
    strings = {
        "ru": {
            "SETTINGS_HEADER": "ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Gemini Security",
            "API_KEY_INPUT": "API Key",
            "API_KEY_SUBTEXT": "ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚Ðµ ÐºÐ»ÑŽÑ‡ Ð² Google AI Studio.",
            "GET_API_KEY_BUTTON": "Ð¡ÑÑ‹Ð»ÐºÐ° Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÐºÐ»ÑŽÑ‡Ð°",
            "MODEL_SELECTOR": "ÐœÐ¾Ð´ÐµÐ»ÑŒ",
            "PROMPT_INPUT_MD": "ÐŸÑ€Ð¾Ð¼Ð¿Ñ‚ (Markdown)",
            "PROMPT_INPUT_PLAIN": "ÐŸÑ€Ð¾Ð¼Ð¿Ñ‚ (Ð¦Ð¸Ñ‚Ð°Ñ‚Ð°)",
            "ENABLE_SWITCH": "Ð’ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ ÑÐºÐ°Ð½ÐµÑ€",
            "USAGE_INFO_TITLE": "FAQ",
            "USAGE_INFO_TEXT": (
                "Ð­Ñ‚Ð¾Ñ‚ Ð¿Ð»Ð°Ð³Ð¸Ð½ Ð¿Ð¾Ð¼Ð¾Ð³Ð°ÐµÑ‚ Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ ÐºÐ¾Ð´ Ð´Ñ€ÑƒÐ³Ð¸Ñ… Ð¿Ð»Ð°Ð³Ð¸Ð½Ð¾Ð² Ð½Ð° Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð¿Ð¾Ð´Ð¾Ð·Ñ€Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ñ… Ð¸Ð»Ð¸ Ð²Ñ€ÐµÐ´Ð¾Ð½Ð¾ÑÐ½Ñ‹Ñ… Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¹ Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ Ð½ÐµÐ¹Ñ€Ð¾ÑÐµÑ‚Ð¸ Google Gemini.\n\n"
                "Ð¨Ð°Ð³ 1: ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°\n"
                "1. ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚Ðµ Ð²Ð°Ñˆ API-ÐºÐ»ÑŽÑ‡ Ð² Google AI Studio.\n"
                "2. Ð’ÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ ÐºÐ»ÑŽÑ‡ Ð² ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‰ÐµÐµ Ð¿Ð¾Ð»Ðµ Ð² Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°Ñ… Ð¿Ð»Ð°Ð³Ð¸Ð½Ð°.\n\n"
                "Ð¨Ð°Ð³ 2: Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ\n"
                "1. ÐÐ°Ð¹Ð´Ð¸Ñ‚Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ñ Ñ„Ð°Ð¹Ð»Ð¾Ð¼ Ð¿Ð»Ð°Ð³Ð¸Ð½Ð°, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð²Ñ‹ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ (Ñ„Ð°Ð¹Ð» Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð¸Ð¼ÐµÑ‚ÑŒ Ñ€Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð¸Ðµ .plugin Ð¸Ð»Ð¸ .py).\n"
                f"2. ÐžÑ‚Ð²ÐµÑ‚ÑŒÑ‚Ðµ Ð½Ð° ÑÑ‚Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð¾Ð¹: {DEFAULT_COMMAND}\n\n"
                "ÐŸÐ»Ð°Ð³Ð¸Ð½ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ ÐºÐ¾Ð´ Ð½Ð° Ð°Ð½Ð°Ð»Ð¸Ð· Ð¸ Ð¿Ñ€Ð¸ÑˆÐ»ÐµÑ‚ Ð²Ð°Ð¼ Ð¾Ñ‚Ñ‡ÐµÑ‚ Ð¾ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸ Ð² ÑÑ‚Ð¾Ñ‚ Ð¶Ðµ Ñ‡Ð°Ñ‚."
            ),
            "API_KEY_MISSING": "âŒ API ÐºÐ»ÑŽÑ‡ Ð´Ð»Ñ Gemini Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½. Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ ÐµÐ³Ð¾ Ð² Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°Ñ… Ð¿Ð»Ð°Ð³Ð¸Ð½Ð°.",
            "NO_REPLY": "âŒ ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¾Ñ‚Ð²ÐµÑ‚ÑŒÑ‚Ðµ Ð½Ð° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ñ Ñ„Ð°Ð¹Ð»Ð¾Ð¼ Ð¿Ð»Ð°Ð³Ð¸Ð½Ð°.",
            "NOT_A_PLUGIN": "âŒ Ð¤Ð°Ð¹Ð» Ð² Ð¾Ñ‚Ð²ÐµÑ‡ÐµÐ½Ð½Ð¾Ð¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¸ Ð½Ðµ ÑÐ²Ð»ÑÐµÑ‚ÑÑ Ð¿Ð»Ð°Ð³Ð¸Ð½Ð¾Ð¼ (.plugin Ð¸Ð»Ð¸ .py).",
            "ANALYZING_MESSAGE": "ðŸ›¡ï¸ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÑŽ Ð¿Ð»Ð°Ð³Ð¸Ð½ Ð½Ð° Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ...",
            "API_ERROR": "âš ï¸ ÐžÑˆÐ¸Ð±ÐºÐ° API Gemini: {error}",
            "FILE_DOWNLOAD_ERROR": "âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ñ„Ð°Ð¹Ð» Ð¿Ð»Ð°Ð³Ð¸Ð½Ð°.",
            "FILE_READ_ERROR": "âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ñ‚ÑŒ Ñ„Ð°Ð¹Ð» Ð¿Ð»Ð°Ð³Ð¸Ð½Ð°.",
            "UNEXPECTED_ERROR": "â— ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð½ÐµÐ¾Ð¶Ð¸Ð´Ð°Ð½Ð½Ð°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ°: {error}",
            "SUCCESS_HEADER_MD": "ðŸ›¡ï¸ ÐžÑ‚Ñ‡ÐµÑ‚ Ð¿Ð¾ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸: {plugin_name} v{plugin_version}\n\n",
            "SUCCESS_HEADER_PLAIN": "ðŸ›¡ï¸ ÐžÑ‚Ñ‡ÐµÑ‚ Ð¿Ð¾ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸: {plugin_name} v{plugin_version}\n\n",
            "ALERT_CLOSE_BUTTON": "Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ",
            "USE_BLOCKQUOTE_TITLE": "Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ñ†Ð¸Ñ‚Ð°Ñ‚Ñƒ",
            "USE_BLOCKQUOTE_SUBTEXT": "ÐžÑ‚Ð¾Ð±Ñ€Ð°Ð¶Ð°Ñ‚ÑŒ Ð¾Ñ‚Ñ‡ÐµÑ‚ Ð² Ð²Ð¸Ð´Ðµ ÑÐ²Ð¾Ñ€Ð°Ñ‡Ð¸Ð²Ð°ÐµÐ¼Ð¾Ð¹ Ñ†Ð¸Ñ‚Ð°Ñ‚Ñ‹ Ð´Ð»Ñ ÐºÐ¾Ð¼Ð¿Ð°ÐºÑ‚Ð½Ð¾ÑÑ‚Ð¸.",
            "USE_PREMIUM_EMOJI_TITLE": "ÐŸÑ€ÐµÐ¼Ð¸ÑƒÐ¼ ÑÐ¼Ð¾Ð´Ð·Ð¸",
            "USE_PREMIUM_EMOJI_SUBTEXT": "Ð—Ð°Ð¼ÐµÐ½ÑÑ‚ÑŒ Ð¾Ð±Ñ‹Ñ‡Ð½Ñ‹Ðµ ÑÐ¼Ð¾Ð´Ð·Ð¸ Ð½Ð° Ð°Ð½Ð¸Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ñ€ÐµÐ¼Ð¸ÑƒÐ¼ ÑÐ¼Ð¾Ð´Ð·Ð¸ Ð² Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ð°Ñ….",
            "APPEARANCE_HEADER": "Ð’Ð½ÐµÑˆÐ½Ð¸Ð¹ Ð²Ð¸Ð´",
            "ADVANCED_HEADER": "Ð Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð½Ñ‹Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸",
            "GENERATION_HEADER": "ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸",
            "TEMPERATURE_INPUT": "Ð¢ÐµÐ¼Ð¿ÐµÑ€Ð°Ñ‚ÑƒÑ€Ð°",
            "TEMPERATURE_SUBTEXT": "0.0-2.0. ÐšÐ¾Ð½Ñ‚Ñ€Ð¾Ð»Ð¸Ñ€ÑƒÐµÑ‚ ÑÐ»ÑƒÑ‡Ð°Ð¹Ð½Ð¾ÑÑ‚ÑŒ. Ð‘Ð¾Ð»ÐµÐµ Ð½Ð¸Ð·ÐºÐ¸Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ Ð´ÐµÐ»Ð°ÑŽÑ‚ Ð¾Ñ‚Ð²ÐµÑ‚ Ð±Ð¾Ð»ÐµÐµ Ð¿Ñ€ÐµÐ´ÑÐºÐ°Ð·ÑƒÐµÐ¼Ñ‹Ð¼.",
            "MAX_TOKENS_INPUT": "ÐœÐ°ÐºÑÐ¸Ð¼ÑƒÐ¼ Ñ‚Ð¾ÐºÐµÐ½Ð¾Ð²",
            "MAX_TOKENS_SUBTEXT": "ÐœÐ°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ Ð´Ð»Ð¸Ð½Ð° Ð¾Ñ‚Ð²ÐµÑ‚Ð° Ð² Ñ‚Ð¾ÐºÐµÐ½Ð°Ñ….",
            "RENAME_VARS_TITLE": "ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ",
            "RENAME_VARS_SUBTEXT": "Ð—Ð°Ð¼ÐµÐ½ÑÐµÑ‚ Ð¸Ð¼ÐµÐ½Ð° Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¸ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¹ Ð½Ð° Ð¾Ð±Ñ‰Ð¸Ðµ (var_0, func_1).",
            "RENAME_STRINGS_TITLE": "Ð¡Ñ‚Ñ€Ð¾ÐºÐ¸",
            "RENAME_STRINGS_SUBTEXT": "Ð—Ð°Ð¼ÐµÐ½ÑÐµÑ‚ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ ÑÑ‚Ñ€Ð¾ÐºÐ¾Ð²Ñ‹Ñ… Ð»Ð¸Ñ‚ÐµÑ€Ð°Ð»Ð¾Ð² Ð½Ð° Ð¼ÐµÑ‚ÐºÐ¸ (string_0).",
            "DONATE_HEADER": "ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÑƒ",
            "DONATE_CRYPTO": "ÐšÑ€Ð¸Ð¿Ñ‚Ð¾ ÐºÐ¾ÑˆÐµÐ»ÐµÐº",
            "DONATE_INFO": "Ð”Ñ€ÑƒÐ³Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¸ Ñ€ÐµÐºÐ²Ð¸Ð·Ð¸Ñ‚Ñ‹",
            "ZWYLIB_NOT_FOUND": "Ð”Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ Ð¿Ð»Ð°Ð³Ð¸Ð½ ZwyLib, Ð½Ð¾ Ð¾Ð½ Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½."
        },
        "en": {
            "SETTINGS_HEADER": "Gemini Security Settings",
            "API_KEY_INPUT": "API Key",
            "API_KEY_SUBTEXT": "Get your key from Google AI Studio.",
            "GET_API_KEY_BUTTON": "Link to get API Key",
            "MODEL_SELECTOR": "Model",
            "PROMPT_INPUT_MD": "Prompt (Markdown)",
            "PROMPT_INPUT_PLAIN": "Prompt (Blockquote)",
            "ENABLE_SWITCH": "Enable Scanner",
            "USAGE_INFO_TITLE": "FAQ",
            "USAGE_INFO_TEXT": (
                "This plugin helps you check the code of other plugins for suspicious or malicious activity using the Google Gemini neural network.\n\n"
                "Step 1: Setup\n"
                "1. Get your API key from Google AI Studio.\n"
                "2. Paste the key into the corresponding field in the plugin settings.\n\n"
                "Step 2: Usage\n"
                "1. Find a message with the plugin file you want to scan (the file must have a .plugin or .py extension).\n"
                f"2. Reply to this message with the command: {DEFAULT_COMMAND}\n\n"
                "The plugin will send the code for analysis and send you a security report in the same chat."
            ),
            "API_KEY_MISSING": "âŒ Gemini API key not found. Please set it in the plugin settings.",
            "NO_REPLY": "âŒ Please reply to a message containing a plugin file.",
            "NOT_A_PLUGIN": "âŒ The replied message does not contain a plugin file (.plugin or .py).",
            "ANALYZING_MESSAGE": "ðŸ›¡ï¸ Scanning plugin for safety...",
            "API_ERROR": "âš ï¸ Gemini API Error: {error}",
            "FILE_DOWNLOAD_ERROR": "âŒ Failed to download the plugin file.",
            "FILE_READ_ERROR": "âŒ Failed to read the plugin file.",
            "UNEXPECTED_ERROR": "â— An unexpected error occurred: {error}",
            "SUCCESS_HEADER_MD": "ðŸ›¡ï¸ Security Report: {plugin_name} v{plugin_version}\n\n",
            "SUCCESS_HEADER_PLAIN": "ðŸ›¡ï¸ Security Report: {plugin_name} v{plugin_version}\n\n",
            "ALERT_CLOSE_BUTTON": "Close",
            "USE_BLOCKQUOTE_TITLE": "Use blockquote",
            "USE_BLOCKQUOTE_SUBTEXT": "Display the report as a collapsible blockquote for compactness.",
            "USE_PREMIUM_EMOJI_TITLE": "Premium emoji",
            "USE_PREMIUM_EMOJI_SUBTEXT": "Replace regular emoji with animated premium emoji in reports.",
            "APPEARANCE_HEADER": "Appearance",
            "ADVANCED_HEADER": "Advanced Settings",
            "GENERATION_HEADER": "Generation Parameters",
            "TEMPERATURE_INPUT": "Temperature",
            "TEMPERATURE_SUBTEXT": "0.0-2.0. Controls randomness. Lower values are less random.",
            "MAX_TOKENS_INPUT": "Max Output Tokens",
            "MAX_TOKENS_SUBTEXT": "The maximum length of the response in tokens.",
            "RENAME_VARS_TITLE": "Variables",
            "RENAME_VARS_SUBTEXT": "Replaces variable and function names with generic ones (var_0, func_1).",
            "RENAME_STRINGS_TITLE": "Strings",
            "RENAME_STRINGS_SUBTEXT": "Replaces string literal content with labels (string_0).",
            "DONATE_HEADER": "Support Development",
            "DONATE_CRYPTO": "CRYPTO Wallet",
            "DONATE_INFO": "Other info and requisites",
            "ZWYLIB_NOT_FOUND": "The ZwyLib plugin is required for auto-updates but is not installed."
        }
    }

    def __init__(self):
        self.language = Locale.getDefault().getLanguage()
        self.language = self.language if self.language in self.strings else "en"

    def get_string(self, key: str) -> str:
        return self.strings[self.language].get(key, self.strings["en"].get(key, key))

locali = LocalizationManager()

class GeminiAPIHandler:
    def __init__(self):
        self.session = requests.Session()
        self.session.headers.update({
            "Content-Type": "application/json",
            "User-Agent": f"ExteraPlugin/{__id__}/{__version__}"
        })

    def analyze_plugin_code(self, api_key: str, model_name: str, prompt: str, temperature: float, max_tokens: int) -> Dict[str, Any]:
        url = f"{GEMINI_BASE_URL}{model_name}:generateContent?key={api_key}"
        payload = {
            "contents": [{"parts": [{"text": prompt}]}],
            "generationConfig": {
                "temperature": temperature,
                "maxOutputTokens": max_tokens,
            }
        }
        try:
            response = self.session.post(url, json=payload, timeout=90)
            response.raise_for_status()
            data = response.json()
            if "candidates" in data and data["candidates"][0].get("content", {}).get("parts", [{}])[0].get("text"):
                return {"success": True, "text": data["candidates"][0]["content"]["parts"][0]["text"]}
            else:
                error_details = data.get("error", {}).get("message", "Invalid API response format.")
                return {"success": False, "error": error_details}
        except requests.exceptions.HTTPError as e:
            error_text = f"HTTP {e.response.status_code}"
            try: error_text += f": {e.response.json().get('error',{}).get('message', e.response.text)}"
            except: error_text += f": {e.response.text}"
            return {"success": False, "error": error_text}
        except requests.exceptions.RequestException as e: return {"success": False, "error": f"Network error: {str(e)}"}
        except Exception as e: return {"success": False, "error": f"Unexpected error: {str(e)}"}

class GeminiPluginAnalyzer(BasePlugin):
    def __init__(self):
        super().__init__()
        self.api_handler = GeminiAPIHandler()
        self.alert_manager = AlertManager()

    def on_plugin_load(self):
        self.add_on_send_message_hook()
        self._add_menu_items()
        import_zwylib()
        if is_zwylib_present():
            zwylib.add_autoupdater_task(__id__, AUTOUPDATE_CHANNEL_ID, AUTOUPDATE_CHANNEL_USERNAME, AUTOUPDATE_MESSAGE_ID)

    def on_plugin_unload(self):
        self.alert_manager.dismiss_dialog()
        if is_zwylib_present():
            zwylib.remove_autoupdater_task(__id__)

    def _add_menu_items(self):
        try:
            log("[Gemini] Adding menu items...")

            self.add_menu_item(
                MenuItemData(
                    menu_type=MenuItemType.MESSAGE_CONTEXT_MENU,
                    text="ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð¿Ð»Ð°Ð³Ð¸Ð½",
                    on_click=self._handle_menu_plugin_check,
                    icon="menu_privacy_policy",
                    item_id="gemini_plugin_check",
                    condition="message != null && message.getDocument() != null && (message.getDocument().file_name_fixed.endsWith('.plugin') || message.getDocument().file_name_fixed.endsWith('.py'))"
                )
            )
            log("[Gemini] Added plugin check menu item")

        except Exception as e:
            log(f"[Gemini] Error adding menu items: {str(e)}")
            log(f"[Gemini] Traceback: {traceback.format_exc()}")

    def _handle_menu_plugin_check(self, context):
        try:
            log("[Gemini] Plugin check menu item clicked")

            try:
                context_keys = []
                key_set = context.keySet()
                iterator = key_set.iterator()
                while iterator.hasNext():
                    key = iterator.next()
                    context_keys.append(str(key))
                log(f"[Gemini] Available context keys: {context_keys}")
            except Exception as e:
                log(f"[Gemini] Error getting context keys: {e}")

            if not self.get_setting("enabled", True):
                self._show_error_bulletin("API_KEY_MISSING")
                return

            api_key = self.get_setting("gemini_api_key", "")
            if not api_key:
                self._show_error_bulletin("API_KEY_MISSING")
                return

            message = None
            possible_keys = ["message", "messageObject", "selectedMessage", "currentMessage"]

            for key in possible_keys:
                try:
                    if context.containsKey(key):
                        message = context.get(key)
                        log(f"[Gemini] Found message using key: {key}")
                        break
                except Exception as e:
                    log(f"[Gemini] Error checking key {key}: {e}")
                    continue

            if not message:
                log("[Gemini] No message found in context with any known key")
                self._show_error_bulletin("NO_REPLY")
                return

            try:
                log(f"[Gemini] Message type: {type(message)}")
                if hasattr(message, 'messageOwner'):
                    log("[Gemini] Message has messageOwner")
                    document = MessageObject.getDocument(message.messageOwner)
                elif hasattr(message, 'messageText'):
                    log("[Gemini] Message has messageText, trying direct document access")
                    document = MessageObject.getDocument(message)
                else:
                    log("[Gemini] Trying direct document access")
                    document = MessageObject.getDocument(message)

                log(f"[Gemini] Document: {document}")
                if document:
                    log(f"[Gemini] Document filename: {document.file_name_fixed}")

            except Exception as e:
                log(f"[Gemini] Error getting document: {e}")
                document = None

            if not document or not any(str(document.file_name_fixed).endswith(ext) for ext in [".plugin", ".py"]):
                log(f"[Gemini] Invalid document or filename: {document}")
                self._show_error_bulletin("NOT_A_PLUGIN")
                return

            log(f"[Gemini] Starting analysis of plugin file from menu: {document.file_name_fixed}")
            BulletinHelper.show_info(locali.get_string("ANALYZING_MESSAGE"))

            class MenuParams:
                def __init__(self, message_obj, context_data):
                    self.message = DEFAULT_COMMAND
                    self.replyToMsg = message_obj

                    try:
                        self.peer = context_data.get("dialog_id") if context_data.containsKey("dialog_id") else 0
                    except:
                        self.peer = 0

                    if self.peer == 0:
                        try:
                            last_fragment = get_last_fragment()
                            if last_fragment and hasattr(last_fragment, "getDialogId"):
                                self.peer = last_fragment.getDialogId()
                        except:
                            pass

                    self.replyToTopMsg = None
                    try:
                        if context_data.containsKey("replyToTopMsg"):
                            self.replyToTopMsg = context_data.get("replyToTopMsg")
                        else:
                            topic_id = get_topic_id_from_message(message_obj, self.peer)
                            if topic_id > 0:
                                self.replyToTopMsg = create_reply_to_top_message(topic_id, self.peer)
                                log(f"[Gemini] Created replyToTopMsg for topic {topic_id}")
                    except Exception as e:
                        log(f"[Gemini] Error setting up replyToTopMsg: {e}")
                        self.replyToTopMsg = None

            params = MenuParams(message, context)
            run_on_queue(lambda: self._process_analysis_in_background(params, document))

        except Exception as e:
            log(f"[Gemini] Error in menu plugin check: {str(e)}")
            log(f"[Gemini] Traceback: {traceback.format_exc()}")
            self._show_error_bulletin("UNEXPECTED_ERROR", error=str(e))

    def _open_link(self, url: str):
        from android.content import Intent
        from android.net import Uri
        last_fragment = get_last_fragment()
        if not last_fragment: return
        context = last_fragment.getParentActivity()
        if not context: return
        intent = Intent(Intent.ACTION_VIEW, Uri.parse(url))
        context.startActivity(intent)

    def _copy_to_clipboard(self, label, text):
        if AndroidUtilities.addToClipboard(text):
            BulletinHelper.show_info(f"Copied {label} to clipboard")
    
    def _show_error_bulletin(self, key: str, **kwargs):
        message = locali.get_string(key).format(**kwargs)
        run_on_ui_thread(lambda: BulletinHelper.show_error(message))

    def _handle_show_info_alert_click(self, view):
        title = locali.get_string("USAGE_INFO_TITLE")
        text = locali.get_string("USAGE_INFO_TEXT")
        close_button = locali.get_string("ALERT_CLOSE_BUTTON")
        parsed_text = parse_markdown(text)
        self.alert_manager.show_info_alert(title, parsed_text.text, close_button)

    def create_settings(self) -> List[Any]:
        return [
            Header(text=locali.get_string("SETTINGS_HEADER")),
            Switch(key="enabled", text=locali.get_string("ENABLE_SWITCH"), icon="menu_privacy_policy", default=True),
            Input(key="gemini_api_key", text=locali.get_string("API_KEY_INPUT"), icon="msg_limit_links", default="", subtext=locali.get_string("API_KEY_SUBTEXT")),
            Text(
                text=locali.get_string("GET_API_KEY_BUTTON"),
                icon="msg_link",
                accent=True,
                on_click=lambda view: self._open_link("https://aistudio.google.com/app/apikey")
            ),
            Divider(),
            Header(text="Model and Prompt"),
            Selector(key="model_selection", text=locali.get_string("MODEL_SELECTOR"), icon="msg_media", default=0, items=MODEL_DISPLAY_NAMES),
            Input(key="custom_prompt_md", text=locali.get_string("PROMPT_INPUT_MD"), icon="filled_unknown", default=DEFAULT_PROMPT_MARKDOWN),
            Input(key="custom_prompt_plain", text=locali.get_string("PROMPT_INPUT_PLAIN"), icon="filled_unknown", default=DEFAULT_PROMPT_PLAINTEXT),
            Divider(),
            Header(text=locali.get_string("GENERATION_HEADER")),
            Input(key="gemini_temperature", text=locali.get_string("TEMPERATURE_INPUT"), icon="msg_photo_settings", default="0.7", subtext=locali.get_string("TEMPERATURE_SUBTEXT")),
            Input(key="gemini_max_tokens", text=locali.get_string("MAX_TOKENS_INPUT"), icon="msg_photo_settings", default="4096", subtext=locali.get_string("MAX_TOKENS_SUBTEXT")),
            Divider(),
            Header(text=locali.get_string("APPEARANCE_HEADER")),
            Switch(
                key="use_blockquote",
                text=locali.get_string("USE_BLOCKQUOTE_TITLE"),
                subtext=locali.get_string("USE_BLOCKQUOTE_SUBTEXT"),
                icon="header_goinline_solar",
                default=True
            ),
            Switch(
                key="use_premium_emoji",
                text=locali.get_string("USE_PREMIUM_EMOJI_TITLE"),
                subtext=locali.get_string("USE_PREMIUM_EMOJI_SUBTEXT"),
                icon="menu_feature_reactions_remix",
                default=False
            ),
            Divider(),
            Header(text=locali.get_string("ADVANCED_HEADER")),
            Switch(key="rename_variables", text=locali.get_string("RENAME_VARS_TITLE"), subtext=locali.get_string("RENAME_VARS_SUBTEXT"), icon="large_hidden", default=True),
            Switch(key="rename_strings", text=locali.get_string("RENAME_STRINGS_TITLE"), subtext=locali.get_string("RENAME_STRINGS_SUBTEXT"), icon="large_hidden", default=True),
            Divider(),
            Text(text=locali.get_string("USAGE_INFO_TITLE"), icon="msg_info", on_click=self._handle_show_info_alert_click),
            Divider(),
            Header(text=locali.get_string("DONATE_HEADER")),
            Text(
                text=locali.get_string("DONATE_CRYPTO"),
                icon="menu_cashtag",
                accent=True,
                on_click=lambda view: run_on_ui_thread(lambda: self._copy_to_clipboard("CRYPTO", "http://t.me/send?start=IVaZsLfW7aSn"))
            ),
            Text(
                text=locali.get_string("DONATE_INFO"),
                icon="msg_info",
                accent=True,
                on_click=lambda view: run_on_ui_thread(lambda: get_messages_controller().openByUserName("mishabotov", get_last_fragment(), 1))
            )
        ]

    def _get_plugin_metadata(self, code: str) -> Tuple[str, str]:
        name = "Unknown Plugin"; version = "Unknown Version"
        try:
            tree = ast.parse(code)
            for node in ast.walk(tree):
                if isinstance(node, ast.Assign):
                    for target in node.targets:
                        if isinstance(target, ast.Name):
                            if target.id == "__name__": name = ast.literal_eval(node.value)
                            elif target.id == "__version__": version = ast.literal_eval(node.value)
        except Exception:
            pass
        return name, version

    def _get_chat_id_from_params(self, params: Any) -> int:
        peer = getattr(params, 'peer', None)
        if not peer:
            log("[Gemini] No peer found in params")
            return 0

        if hasattr(peer, 'channel_id') and peer.channel_id != 0:
            chat_id = -peer.channel_id
            log(f"[Gemini] Found channel_id: {chat_id}")
            return chat_id
        if hasattr(peer, 'chat_id') and peer.chat_id != 0:
            chat_id = -peer.chat_id
            log(f"[Gemini] Found chat_id: {chat_id}")
            return chat_id
        if hasattr(peer, 'user_id') and peer.user_id != 0:
            chat_id = peer.user_id
            log(f"[Gemini] Found user_id: {chat_id}")
            return chat_id

        log(f"[Gemini] Peer object has no recognizable ID fields: {peer}")
        return 0

    def _wait_for_file(self, file_path: str, document: Any) -> bool:
        if os.path.exists(file_path): return True
        get_file_loader().loadFile(document, "gemini_analyzer", FileLoader.PRIORITY_HIGH, 1)
        for _ in range(30):
            if os.path.exists(file_path): return True
            time.sleep(1)
        return False
    
    def _get_obfuscated_code(self, code: str) -> str:
        lines = []
        for line in code.split('\n'):
            stripped_line = line.split('#', 1)[0]
            lines.append(stripped_line)
        clean_code = '\n'.join(lines)

        rename_vars = self.get_setting("rename_variables", True)
        rename_strings = self.get_setting("rename_strings", True)

        if not rename_vars and not rename_strings:
            return '\n'.join(line for line in clean_code.split('\n') if line.strip())

        try:
            tree = ast.parse(clean_code)
            transformer = CodeObfuscator(rename_vars, rename_strings)
            new_tree = transformer.visit(tree)
            ast.fix_missing_locations(new_tree)
            return ast.unparse(new_tree)
        except Exception:
            return '\n'.join(line for line in clean_code.split('\n') if line.strip())

    def _process_analysis_in_background(self, params: Any, document: Any):
        try:
            file_path_obj = get_file_loader().getPathToAttach(document, True)
            if not self._wait_for_file(file_path_obj.getAbsolutePath(), document):
                self._show_error_bulletin("FILE_DOWNLOAD_ERROR")
                return

            try:
                with open(file_path_obj.getAbsolutePath(), "r", encoding="utf-8", errors="ignore") as f:
                    plugin_code = f.read()
                plugin_name, plugin_version = self._get_plugin_metadata(plugin_code)
            except Exception as e:
                self._show_error_bulletin("FILE_READ_ERROR", e=str(e))
                return

            processed_code = self._get_obfuscated_code(plugin_code)

            api_key = self.get_setting("gemini_api_key", "")
            model_idx = self.get_setting("model_selection", 0)
            model_name = MODEL_API_NAMES[model_idx]
            use_blockquote = self.get_setting("use_blockquote", True)
            
            try:
                temperature = float(self.get_setting("gemini_temperature", "0.5"))
            except (ValueError, TypeError):
                temperature = 0.5

            try:
                max_tokens = int(self.get_setting("gemini_max_tokens", "8192"))
            except (ValueError, TypeError):
                max_tokens = 8192
            
            prompt_template = self.get_setting("custom_prompt_plain" if use_blockquote else "custom_prompt_md", 
                                             DEFAULT_PROMPT_PLAINTEXT if use_blockquote else DEFAULT_PROMPT_MARKDOWN)

            full_prompt = prompt_template.format(plugin_code=processed_code, plugin_name=plugin_name, plugin_version=plugin_version)
            result = self.api_handler.analyze_plugin_code(api_key, model_name, full_prompt, temperature, max_tokens)
            
            if result.get("success"):
                self._send_report(params, result["text"], plugin_name, plugin_version, use_blockquote)
            else: 
                self._show_error_bulletin("API_ERROR", error=result.get("error", "Unknown"))

        except Exception as e:
            log(f"[Gemini] Exception in _process_analysis_in_background: {e}")
            log(f"[Gemini] Exception type: {type(e)}")
            log(f"[Gemini] Traceback: {traceback.format_exc()}")
            self._show_error_bulletin("UNEXPECTED_ERROR", error=str(e))
            traceback.print_exc()

    def _send_report(self, params: Any, response_text: str, plugin_name: str, plugin_version: str, use_blockquote: bool):
        try:
            header_key = "SUCCESS_HEADER_PLAIN" if use_blockquote else "SUCCESS_HEADER_MD"
            header = locali.get_string(header_key).format(plugin_name=plugin_name, plugin_version=plugin_version)

            use_premium_emoji = self.get_setting("use_premium_emoji", False)
            if use_premium_emoji:
                enhanced_header = replace_with_premium_emoji(header)
                enhanced_response_text = replace_with_premium_emoji(response_text)
                report_text = enhanced_header + enhanced_response_text
            else:
                report_text = header + response_text

            log(f"[Gemini] Sending report with blockquote={use_blockquote}, text_length={len(report_text)}")

        except Exception as e:
            log(f"[Gemini] Error preparing report text: {e}")
            fallback_text = f"ðŸ›¡ï¸ Security Report: {plugin_name} v{plugin_version}\n\n{response_text}"
            use_premium_emoji = self.get_setting("use_premium_emoji", False)
            if use_premium_emoji:
                report_text = replace_with_premium_emoji(fallback_text)
            else:
                report_text = fallback_text
        
        try:
            peer_id = getattr(params, "peer", None)
            reply_to_msg = getattr(params, "replyToMsg", None)
            reply_to_top_msg = getattr(params, "replyToTopMsg", None)

            log(f"[Gemini] Raw peer from params: {peer_id}")
            log(f"[Gemini] replyToMsg: {reply_to_msg}")
            log(f"[Gemini] replyToTopMsg: {reply_to_top_msg}")

            message_payload = {
                "peer": peer_id,
                "replyToMsg": reply_to_msg,
                "replyToTopMsg": reply_to_top_msg
            }
            log(f"[Gemini] Created message_payload successfully")
        except Exception as e:
            log(f"[Gemini] Error in simple peer approach: {e}")
            try:
                last_fragment = get_last_fragment()
                if last_fragment and hasattr(last_fragment, "getDialogId"):
                    peer_id = last_fragment.getDialogId()
                    log(f"[Gemini] Fallback: got peer from fragment: {peer_id}")
                else:
                    peer_id = 0
                    log("[Gemini] Fallback: using peer_id = 0")

                message_payload = {
                    "peer": peer_id,
                    "message": "Fallback message"
                }
            except Exception as e2:
                log(f"[Gemini] Fallback also failed: {e2}")
                return

        try:
            parsed = parse_markdown(report_text)
            entities = []

            if use_blockquote and parsed.text and len(parsed.text.strip()) > 0:
                blockquote_entity = TLRPC.TL_messageEntityBlockquote()
                blockquote_entity.collapsed = True
                blockquote_entity.offset = 0
                try:
                    blockquote_entity.length = len(parsed.text.encode('utf-16le')) // 2
                except:
                    blockquote_entity.length = len(parsed.text)
                entities.append(blockquote_entity)
                log(f"[Gemini] Added blockquote entity with length {blockquote_entity.length}")
            if parsed.entities:
                for entity in parsed.entities:
                    try:
                        tlrpc_entity = entity.to_tlrpc_object()
                        if tlrpc_entity is not None:
                            entities.append(tlrpc_entity)
                    except Exception as e:
                        log(f"[Gemini] Entity error: {e}")

            message_payload["message"] = parsed.text
            message_payload["entities"] = entities if entities else None
            send_message(message_payload)
            log(f"[Gemini] Report sent with {len(entities)} entities")

        except Exception as e:
            log(f"[Gemini] Send failed, using fallback: {e}")
            try:
                clean_text = report_text.replace('**', '').replace('__', '').replace('`', '')
                clean_text = get_regular_emoji_for_bulletin(clean_text)

                fallback_entities = []
                if use_blockquote and clean_text and len(clean_text.strip()) > 0:
                    blockquote_entity = TLRPC.TL_messageEntityBlockquote()
                    blockquote_entity.collapsed = True
                    blockquote_entity.offset = 0
                    try:
                        blockquote_entity.length = len(clean_text.encode('utf-16le')) // 2
                    except:
                        blockquote_entity.length = len(clean_text)
                    fallback_entities.append(blockquote_entity)
                    log(f"[Gemini] Added fallback blockquote entity with length {blockquote_entity.length} for text length {len(clean_text)}")

                message_payload["message"] = clean_text
                message_payload["entities"] = fallback_entities if fallback_entities else None
                send_message(message_payload)
                log(f"[Gemini] Fallback send successful with {len(fallback_entities)} entities")
            except Exception as e2:
                log(f"[Gemini] Fallback failed: {e2}")
                self._show_error_bulletin("UNEXPECTED_ERROR", error="Failed to send report")

        verdict_line = response_text.split('\n', 1)[0].strip()
        clean_verdict = verdict_line.replace("â—ˆ Ð’ÐµÑ€Ð´Ð¸ÐºÑ‚:", "").strip()

        bulletin_verdict = get_regular_emoji_for_bulletin(clean_verdict)

        def show_verdict_bulletin():
            if "âœ…" in verdict_line:
                BulletinHelper.show_success(bulletin_verdict)
            elif "âŒ" in verdict_line or "ðŸ“›" in verdict_line:
                BulletinHelper.show_error(bulletin_verdict)
            else:
                BulletinHelper.show_info(bulletin_verdict)
        run_on_ui_thread(show_verdict_bulletin)

    def on_send_message_hook(self, account: int, params: Any) -> HookResult:
        if not hasattr(params, "message") or not isinstance(params.message, str): return HookResult()

        message_text = params.message.strip()
        if message_text.lower() != DEFAULT_COMMAND or not self.get_setting("enabled", True): return HookResult()

        log(f"[Gemini] Processing command {DEFAULT_COMMAND}")

        try:
            params_attrs = [attr for attr in dir(params) if not attr.startswith('_')]
            log(f"[Gemini] Available params attributes: {params_attrs}")

            if hasattr(params, 'peer'):
                log(f"[Gemini] params.peer exists: {params.peer}")
            if hasattr(params, 'dialog_id'):
                log(f"[Gemini] params.dialog_id exists: {params.dialog_id}")
            if hasattr(params, 'chat_id'):
                log(f"[Gemini] params.chat_id exists: {params.chat_id}")
        except Exception as e:
            log(f"[Gemini] Error inspecting params: {e}")

        api_key = self.get_setting("gemini_api_key", "")
        if not api_key:
            self._show_error_bulletin("API_KEY_MISSING")
            return HookResult(strategy=HookStrategy.CANCEL)

        if not hasattr(params, "replyToMsg") or not params.replyToMsg:
            self._show_error_bulletin("NO_REPLY")
            return HookResult(strategy=HookStrategy.CANCEL)

        try:
            log(f"[Gemini] Command params.replyToMsg: {params.replyToMsg}")
            log(f"[Gemini] Command params.replyToTopMsg: {getattr(params, 'replyToTopMsg', None)}")

            if not hasattr(params, 'replyToTopMsg') or not params.replyToTopMsg:
                topic_id = get_topic_id_from_message(params.replyToMsg, params.peer)
                if topic_id > 0:
                    params.replyToTopMsg = create_reply_to_top_message(topic_id, params.peer)
                    log(f"[Gemini] Created replyToTopMsg for command, topic {topic_id}")
        except Exception as e:
            log(f"[Gemini] Error setting up topic for command: {e}")

        document = MessageObject.getDocument(params.replyToMsg.messageOwner)
        if not document or not any(str(document.file_name_fixed).endswith(ext) for ext in [".plugin", ".py"]):
            self._show_error_bulletin("NOT_A_PLUGIN")
            return HookResult(strategy=HookStrategy.CANCEL)

        log(f"[Gemini] Starting analysis of plugin file: {document.file_name_fixed}")
        BulletinHelper.show_info(locali.get_string("ANALYZING_MESSAGE"))
        run_on_queue(lambda: self._process_analysis_in_background(params, document))
        return HookResult(strategy=HookStrategy.CANCEL)