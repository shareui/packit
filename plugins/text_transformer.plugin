import random
from ui.settings import Header, Divider, Selector
from base_plugin import BasePlugin, HookResult, HookStrategy
from android_utils import log
from java.util import Locale

__id__ = "text_transformer"
__name__ = "Text Transformer"
__description__ = "Transform your message to various formats using the .rp command"
__author__ = "@exteraDev"
__min_version__ = "11.9.0"
__icon__ = "exteraDevPlugins/6"

LANGS = {
    "en": {
        "transform_modes": ["Emoji", "Morse Code", "Binary", "Bubble Text", "Upside Down", "Vaporwave"],
        "emoji_categories": ["Happy", "Sad", "Love", "Animals", "Food", "Activities", "Mixed"],
        "usage": "Usage: .rp [your message]",
        "settings_header": "Text Transformer Settings",
        "category_key": "Emoji Category (for emoji mode)",
        "mode_key": "Transform Mode",
        "no_text": "Please provide text after the .rp command",
        "error": "Error transforming text: "
    },
    "pt-br": {
        "transform_modes": ["Emoji", "CÃ³digo Morse", "BinÃ¡rio", "Texto Bolha", "De CabeÃ§a pra Baixo", "Vaporwave"],
        "emoji_categories": ["Feliz", "Triste", "Amor", "Animais", "Comida", "Atividades", "Misto"],
        "usage": "Uso: .rp [sua mensagem]",
        "settings_header": "ConfiguraÃ§Ãµes do Transformador de Texto",
        "category_key": "Categoria de Emoji (para modo emoji)",
        "mode_key": "Modo de TransformaÃ§Ã£o",
        "no_text": "Por favor, forneÃ§a texto apÃ³s o comando .rp",
        "error": "Erro ao transformar texto: "
    },
    "ru": {
        "transform_modes": ["Ğ­Ğ¼Ğ¾Ğ´Ğ·Ğ¸", "ĞĞ·Ğ±ÑƒĞºĞ° ĞœĞ¾Ñ€Ğ·Ğµ", "Ğ‘Ğ¸Ğ½Ğ°Ñ€Ğ½Ñ‹Ğ¹", "ĞŸÑƒĞ·Ñ‹Ñ€ÑŒĞºĞ¾Ğ²Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚", "Ğ’Ğ²ĞµÑ€Ñ… Ğ½Ğ¾Ğ³Ğ°Ğ¼Ğ¸", "Ğ’Ğ°Ğ¿Ğ¾Ñ€Ğ²ĞµĞ¹Ğ²"],
        "emoji_categories": ["Ğ¡Ñ‡Ğ°ÑÑ‚Ğ»Ğ¸Ğ²Ñ‹Ğ¹", "Ğ“Ñ€ÑƒÑÑ‚Ğ½Ñ‹Ğ¹", "Ğ›ÑĞ±Ğ¾Ğ²ÑŒ", "Ğ–Ğ¸Ğ²Ğ¾Ñ‚Ğ½Ñ‹Ğµ", "Ğ•Ğ´Ğ°", "ĞĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸", "Ğ¡Ğ¼ĞµÑˆĞ°Ğ½Ğ½Ñ‹Ğ¹"],
        "usage": "Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ: .rp [Ğ²Ğ°ÑˆĞµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ]",
        "settings_header": "ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ¿Ñ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ñ‚ĞµĞºÑÑ‚Ğ°",
        "category_key": "ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ñ ÑĞ¼Ğ¾Ğ´Ğ·Ğ¸ (Ğ´Ğ»Ñ Ñ€ĞµĞ¶Ğ¸Ğ¼Ğ° ÑĞ¼Ğ¾Ğ´Ğ·Ğ¸)",
        "mode_key": "Ğ ĞµĞ¶Ğ¸Ğ¼ Ğ¿Ñ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ",
        "no_text": "ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ²Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ñ‚ĞµĞºÑÑ‚ Ğ¿Ğ¾ÑĞ»Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ .rp",
        "error": "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ñ‚ĞµĞºÑÑ‚Ğ°: "
    }
}

EMOJI_CATEGORIES = {
    "happy": ["ğŸ˜€", "ğŸ˜", "ğŸ˜‚", "ğŸ¤£", "ğŸ˜ƒ", "ğŸ˜„", "ğŸ˜…", "ğŸ˜†", "ğŸ˜‰", "ğŸ˜Š", "ğŸ˜‹", "ğŸ˜"],
    "sad": ["â˜¹ï¸", "ğŸ˜£", "ğŸ˜–", "ğŸ˜«", "ğŸ˜©", "ğŸ˜¢", "ğŸ˜­", "ğŸ˜¤", "ğŸ˜ ", "ğŸ˜¡", "ğŸ¤¬", "ğŸ˜"],
    "love": ["â¤ï¸", "ğŸ§¡", "ğŸ’›", "ğŸ’š", "ğŸ’™", "ğŸ’œ", "ğŸ–¤", "â£ï¸", "ğŸ’•", "ğŸ’", "ğŸ’“", "ğŸ’—"],
    "animals": ["ğŸ¶", "ğŸ±", "ğŸ¦Š", "ğŸ»", "ğŸ¼", "ğŸ¨", "ğŸ¯", "ğŸ¦", "ğŸ®", "ğŸ·", "ğŸ¸", "ğŸµ"],
    "food": ["ğŸ", "ğŸ•", "ğŸ”", "ğŸŸ", "ğŸŒ®", "ğŸ—", "ğŸ–", "ğŸ™", "ğŸ£", "ğŸ©", "ğŸª", "ğŸ«"],
    "activities": ["âš½", "ğŸ€", "ğŸˆ", "âš¾", "ğŸ¾", "ğŸ", "ğŸ‰", "ğŸ±", "ğŸ“", "ğŸ¸", "ğŸ¥Š", "ğŸ®"],
    "mixed": ["ğŸ’¯", "ğŸ”¥", "âœ¨", "ğŸ‰", "ğŸŠ", "ğŸ", "ğŸ‘", "ğŸ‘Œ", "ğŸ‘", "ğŸ™", "ğŸ¤", "ğŸŒˆ"]
}

MORSE_CODE = {
    'A': '.-', 'B': '-...', 'C': '-.-.', 'D': '-..', 'E': '.', 'F': '..-.',
    'G': '--.', 'H': '....', 'I': '..', 'J': '.---', 'K': '-.-', 'L': '.-..',
    'M': '--', 'N': '-.', 'O': '---', 'P': '.--.', 'Q': '--.-', 'R': '.-.',
    'S': '...', 'T': '-', 'U': '..-', 'V': '...-', 'W': '.--', 'X': '-..-',
    'Y': '-.--', 'Z': '--..',
    '0': '-----', '1': '.----', '2': '..---', '3': '...--', '4': '....-',
    '5': '.....', '6': '-....', '7': '--...', '8': '---..', '9': '----.',
    '.': '.-.-.-', ',': '--..--', '?': '..--..', "'": '.----.', '!': '-.-.--',
    '/': '-..-.', '(': '-.--.', ')': '-.--.-', '&': '.-...', ':': '---...',
    ';': '-.-.-.', '=': '-...-', '+': '.-.-.', '-': '-....-', '_': '..--.-',
    '"': '.-..-.', '$': '...-..-', '@': '.--.-.',
    'Ğ': '.-', 'Ğ‘': '-...', 'Ğ’': '.--', 'Ğ“': '--.', 'Ğ”': '-..', 'Ğ•': '.', 'Ğ': '.',
    'Ğ–': '...-', 'Ğ—': '--..', 'Ğ˜': '..', 'Ğ™': '.---', 'Ğš': '-.-', 'Ğ›': '.-..',
    'Ğœ': '--', 'Ğ': '-.', 'Ğ': '---', 'ĞŸ': '.--.', 'Ğ ': '.-.', 'Ğ¡': '...',
    'Ğ¢': '-', 'Ğ£': '..-', 'Ğ¤': '..-.', 'Ğ¥': '....', 'Ğ¦': '-.-.', 'Ğ§': '---.',
    'Ğ¨': '----', 'Ğ©': '--.-', 'Ğª': '.--.-.', 'Ğ«': '-.--', 'Ğ¬': '-..-',
    'Ğ­': '..-..', 'Ğ®': '..--', 'Ğ¯': '.-.-'
}

def to_binary(text):
    return ' '.join(format(ord(char), '08b') for char in text)

BUBBLE_CHARS = {
    'a': 'â“', 'b': 'â“‘', 'c': 'â“’', 'd': 'â““', 'e': 'â“”', 'f': 'â“•', 'g': 'â“–',
    'h': 'â“—', 'i': 'â“˜', 'j': 'â“™', 'k': 'â“š', 'l': 'â“›', 'm': 'â“œ', 'n': 'â“',
    'o': 'â“', 'p': 'â“Ÿ', 'q': 'â“ ', 'r': 'â“¡', 's': 'â“¢', 't': 'â“£', 'u': 'â“¤',
    'v': 'â“¥', 'w': 'â“¦', 'x': 'â“§', 'y': 'â“¨', 'z': 'â“©',
    'A': 'â’¶', 'B': 'â’·', 'C': 'â’¸', 'D': 'â’¹', 'E': 'â’º', 'F': 'â’»', 'G': 'â’¼',
    'H': 'â’½', 'I': 'â’¾', 'J': 'â’¿', 'K': 'â“€', 'L': 'â“', 'M': 'â“‚', 'N': 'â“ƒ',
    'O': 'â“„', 'P': 'â“…', 'Q': 'â“†', 'R': 'â“‡', 'S': 'â“ˆ', 'T': 'â“‰', 'U': 'â“Š',
    'V': 'â“‹', 'W': 'â“Œ', 'X': 'â“', 'Y': 'â“', 'Z': 'â“',
    '0': 'â“ª', '1': 'â‘ ', '2': 'â‘¡', '3': 'â‘¢', '4': 'â‘£',
    '5': 'â‘¤', '6': 'â‘¥', '7': 'â‘¦', '8': 'â‘§', '9': 'â‘¨'
}

FLIP_CHARS = {
    'a': 'É', 'b': 'q', 'c': 'É”', 'd': 'p', 'e': 'Ç', 'f': 'ÉŸ', 'g': 'Æƒ',
    'h': 'É¥', 'i': 'á´‰', 'j': 'É¾', 'k': 'Ê', 'l': 'l', 'm': 'É¯', 'n': 'u',
    'o': 'o', 'p': 'p', 'q': 'b', 'r': 'É¹', 's': 's', 't': 'Ê‡', 'u': 'n',
    'v': 'ÊŒ', 'w': 'Ê', 'x': 'x', 'y': 'Ê', 'z': 'z',
    'A': 'âˆ€', 'B': 'B', 'C': 'Æ†', 'D': 'D', 'E': 'Æ', 'F': 'â„²', 'G': '×¤',
    'H': 'H', 'I': 'I', 'J': 'Å¿', 'K': 'K', 'L': 'Ë¥', 'M': 'W', 'N': 'N',
    'O': 'O', 'P': 'Ô€', 'Q': 'Q', 'R': 'R', 'S': 'S', 'T': 'â”´', 'U': 'âˆ©',
    'V': 'Î›', 'W': 'M', 'X': 'X', 'Y': 'â…„', 'Z': 'Z',
    '0': '0', '1': 'Æ–', '2': 'á„…', '3': 'Æ', '4': 'ã„£',
    '5': 'Ï›', '6': '9', '7': 'ã„¥', '8': '8', '9': '6',
    '.': 'Ë™', ',': '\'', '?': 'Â¿', '!': 'Â¡', "'": ',',
    '"': ',,', '(': ')', ')': '(', '[': ']', ']': '[',
    '{': '}', '}': '{', '<': '>', '>': '<', '&': 'â…‹'
}

FLIP_CHARS_CYRILLIC = {
    'Ğ': 'âˆ€', 'Ğ‘': 'Ô', 'Ğ’': 'ê“­', 'Ğ“': 'â…', 'Ğ”': 'á—¡', 'Ğ•': 'Æ', 'Ğ': 'Æ', 'Ğ–': 'Óœ', 'Ğ—': 'Æ',
    'Ğ˜': 'Ğ˜', 'Ğ™': 'Ğ˜', 'Ğš': 'Ê', 'Ğ›': 'Ë¥', 'Ğœ': 'W', 'Ğ': 'H', 'Ğ': 'O', 'ĞŸ': 'ĞŸ', 'Ğ ': 'ê“¤',
    'Ğ¡': 'Æ†', 'Ğ¢': 'â”´', 'Ğ£': 'Ê', 'Ğ¤': 'Ğ¤', 'Ğ¥': 'X', 'Ğ¦': 'Ğ¦', 'Ğ§': 'Ğ§', 'Ğ¨': 'Ğ¨', 'Ğ©': 'Ğ©',
    'Ğª': 'Ğª', 'Ğ«': 'Ğ«', 'Ğ¬': 'Ğ¬', 'Ğ­': 'Ğ­', 'Ğ®': 'Ğ®', 'Ğ¯': 'Ê',
    'Ğ°': 'É', 'Ğ±': 'Æ', 'Ğ²': 'Êš', 'Ğ³': 'É¹', 'Ğ´': 'É“', 'Ğµ': 'Ç', 'Ñ‘': 'Ç', 'Ğ¶': 'Ğ¶', 'Ğ·': 'Îµ',
    'Ğ¸': 'Ğ¸', 'Ğ¹': 'Ğ¸', 'Ğº': 'Ê', 'Ğ»': 'Êƒ', 'Ğ¼': 'w', 'Ğ½': 'Ğ½', 'Ğ¾': 'o', 'Ğ¿': 'u', 'Ñ€': 'd',
    'Ñ': 'É”', 'Ñ‚': 'Ê‡', 'Ñƒ': 'Ê', 'Ñ„': 'Ñ„', 'Ñ…': 'Ñ…', 'Ñ†': 'Ñ†', 'Ñ‡': 'Ñ‡', 'Ñˆ': 'Ñˆ', 'Ñ‰': 'Ñ‰',
    'ÑŠ': 'ÑŠ', 'Ñ‹': 'Ñ‹', 'ÑŒ': 'ÑŒ', 'Ñ': 'Ñ', 'Ñ': 'Ñ', 'Ñ': 'Ê'
}

def _apply_mapping(text, *mappings, reverse=False):
    result = ""
    for char in text:
        mapped = None
        for mapping in mappings:
            if char in mapping:
                mapped = mapping[char]
                break
        if mapped is not None:
            if reverse:
                result = mapped + result
            else:
                result += mapped
        else:
            if reverse:
                result = char + result
            else:
                result += char
    return result

def to_vaporwave(text):
    result = ""
    for char in text:
        if ord(char) >= 33 and ord(char) <= 126:
            result += chr(ord(char) + 0xFEE0)
        elif char == " ":
            result += "ã€€"
        elif 'Ğ' <= char <= 'Ñ' or char == 'Ğ' or char == 'Ñ‘':
            result += char
        else:
            result += char
    return result

class TextTransformerPlugin(BasePlugin):
    def __init__(self):
        super().__init__()
        self.all_emojis = []
        for category in EMOJI_CATEGORIES.values():
            self.all_emojis.extend(category)

    def on_plugin_load(self):
        self.add_on_send_message_hook()
        log("Text Transformer Plugin loaded")

    def on_plugin_unload(self):
        pass

    def _get_lang(self):
        lang = Locale.getDefault().getLanguage().lower()
        if lang.startswith("pt"):
            return "pt-br"
        if lang.startswith("ru"):
            return "ru"
        return "en"

    def create_settings(self):
        lang_key = self._get_lang()
        l10n = LANGS.get(lang_key, LANGS["en"])
        return [
            Header(text=l10n["settings_header"]),
            Selector(
                key="transform_mode",
                text=l10n["mode_key"],
                default=0,
                items=l10n["transform_modes"]
            ),
            Selector(
                key="emoji_category",
                text=l10n["category_key"],
                default=6,
                items=l10n["emoji_categories"]
            ),
            Divider(text=l10n["usage"]),
        ]

    def _transform_text(self, text):
        lang = self._get_lang()
        mode = self.get_setting("transform_mode", 0)
        if mode == 0:
            return self._to_emoji(text)
        elif mode == 1:
            return self._to_morse(text)
        elif mode == 2:
            return to_binary(text)
        elif mode == 3:
            return self._to_bubble(text)
        elif mode == 4:
            return self._to_upside_down(text)
        elif mode == 5:
            return to_vaporwave(text)
        return text

    def _to_emoji(self, text):
        category_index = self.get_setting("emoji_category", 6)
        categories = list(EMOJI_CATEGORIES.keys())
        if 0 <= category_index < len(categories):
            emoji_list = EMOJI_CATEGORIES[categories[category_index]]
        else:
            emoji_list = self.all_emojis
        if not emoji_list:
            emoji_list = ["ğŸ™‚"]
        result = ""
        for char in text:
            if char.isspace():
                result += char
            else:
                result += random.choice(emoji_list)
        return result

    def _to_morse(self, text):
        result = []
        for char in text:
            upper = char.upper()
            if char == ' ':
                result.append('/')
            elif upper in MORSE_CODE:
                result.append(MORSE_CODE[upper])
            else:
                result.append(char)
        return ' '.join(result)

    def _to_bubble(self, text):
        return _apply_mapping(text, BUBBLE_CHARS)

    def _to_upside_down(self, text):
        result = ""
        for char in text:
            if char in FLIP_CHARS:
                result = FLIP_CHARS[char] + result
            elif char in FLIP_CHARS_CYRILLIC:
                result = FLIP_CHARS_CYRILLIC[char] + result
            else:
                result = char + result
        return result

    def on_send_message_hook(self, account: int, params):
        lang_key = self._get_lang()
        l10n = LANGS.get(lang_key, LANGS["en"])
        if not hasattr(params, 'message') or not isinstance(params.message, str):
            return HookResult()
        message = params.message.strip()
        if not message.startswith(".rp "):
            return HookResult()
        original_text = message[4:].strip()
        if not original_text:
            params.message = l10n["no_text"]
            return HookResult(strategy=HookStrategy.MODIFY, params=params)
        try:
            result = self._transform_text(original_text)
            params.message = result
            if not hasattr(params, "entities") or params.entities is None:
                params.entities = []
            return HookResult(strategy=HookStrategy.MODIFY, params=params)
        except Exception as e:
            log(f"{l10n['error']}{e}")
            params.message = f"{l10n['error']}{str(e)}"
            return HookResult(strategy=HookStrategy.MODIFY, params=params)