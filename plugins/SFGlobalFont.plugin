"""


                            Ð”Ð˜Ð¡ÐšÐ›Ð•Ð™ÐœÐ•Ð 

ÐšÐ¾Ñ€Ð¾Ñ‡Ðµ , ÐµÑÐ»Ð¸ Ñ‚ÐµÐ±Ðµ Ð½ÑƒÐ¶ÐµÐ½ ÐºÑƒÑÐ¾Ðº ÐºÐ¾Ð´Ð° Ð¸Ð· ÑÑ‚Ð¾Ð³Ð¾ Ð¿Ð»Ð°Ð³Ð¸Ð½Ð° , Ñ‚Ð¾ Ð¿Ð¶
ÑƒÐºÐ°Ð·Ñ‹Ð²Ð°Ð¹ Ð² Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ð¸ Ð¸Ð»Ð¸ Ð³Ð´Ðµ-Ñ‚Ð¾ ÐµÑ‰Ðµ , Ñ‡Ñ‚Ð¾ Ð²Ð·ÑÐ» ÐºÐ¾Ð´ Ñ @KangelPlugins & @SwagNonHer
                              Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾
                        ðŸ™ Ð‘Ð›ÐÐ“ÐžÐ¡Ð›ÐÐ’Ð›Ð•ÐÐ˜Ð• ðŸ™

â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â£€â£€â¡¤â ¤â£„â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â¢€â£¤â¡¤â£¤â¡€â €â €â €â €â €â €â €â €â €â €â €
â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â£ â žâ ‰â¢€â£¤â ¶â ®â ·â£¤â£€â¡€â €â €â¢€â €â €â €â €â €â €â €â €â¢€â¡¼â ‹â ˆâ£½â£†â ¹â£¦â¡€â €â €â €â €â €â €â €â €â €
â €â €â €â €â €â €â €â €â €â €â €â €â €â €â¢€â£¤â ¶â ¶â ¶â ¶â£„â €â €â €â£žâ£â£ â ´â ¯â °â ¶â ¶â ¶â£¾â â ™â£¯â£³â£¥â žâ¢¹â €â €â €â €â €â €â¡¾â €â¢ â¡¾â â¢¹â €â¢»â£§â €â €â €â €â €â €â €â €â €
â €â €â €â €â €â €â €â €â €â €â €â €â €â£ â â €â£Šâ£€â£â£€â¡ˆâ¢“â£¦â¡–â ‹â â €â¡°â ‚â €â €â €â €â£¹â¢ â£„â£½â ¬â£¾â ‰â¢¹â ³â¡„â €â €â €â¢¸â ‡â €â¢¸â €â¢€â¡¼â¡‡â¢ˆâ¡¾â¡¦â£„â €â €â €â €â €â €â €
â €â €â €â €â €â €â €â €â €â €â €â €â¢°â¡â£ â¡¾â ‰â¢€â €â£€â¡½â ›â¢ƒâ¡„â €â €â¡œâ €â €â €â €â €â €â ™â ›â ›â¢§â¡€â ˆâ »â¢¾â¡„â ˆâ¢§â¡€â €â¢¸â €â €â¢¸â¡°â¡¿â ›â¡§â Šâ¡„â£¿â£®â ³â£„â €â €â €â €â €
â €â €â €â €â €â €â €â €â €â €â €â €â¢¸â¡¾â¢¹â¡‡â €â €â£´â ›â €â¢€â Žâ €â €â£¼â €â €â €â €â €â €â €â €â €â €â¢¸â¡¹â£¦â¡€â €â£³â ¶â£¾â£³â¡„â£¸â €â €â¢¸â ƒâ¢€â£´â ƒâ €â¢¡â£§â£½â €â ¹â¡„â €â €â €â €
â €â €â €â €â €â €â €â €â €â €â €â €â¢¸â¡‡â¢¸â¡‡â¢°â¡¾â “â €â €â¡Žâ €â €â¢ â£¿â €â €â €â €â €â €â €â €â €â €â¡žâ¡‰â¢ºâ£¯â£«â¡·â ¦â¡¿â ™â¢·â¡‡â €â¢€â¡â£ â ¿â¡Ÿâ €â¢ â£¾â¡–â¡Ÿâ¡†â €â¡‡â €â €â €â €
â €â €â €â €â €â €â €â €â €â €â €â €â ˜â¢§â €â£³â¢¿â¡¾â €â €â£¼â â €â£€â£¾â£¿â €â €â¡„â €â €â €â €â €â¢°â €â ·â¢¿â¡Ÿâ â ˆâ »â£§â¡‡â£ â¢¾â£‡â£¤â žâ£´â ƒâ¡¾â â¢€â¡¿â ‰â ’â¢»â¡‡â €â¡‡â €â €â €â €
â €â €â €â €â €â €â €â €â €â €â €â €â €â ˜â¢»â£§â¡¾â¢ â ƒâ¢€â¡‡â €â¢€â¡¾â â ¸â£¼â¡€â£‡â €â €â €â£†â €â¢¸â¡†â €â¢ â¢§â¡€â €â €â¡·â£žâ£¡â Žâ£‡â£¤â žâ â¡¼â â¢€â¡¿â â €â €â¢¹â â¢ â ‡â €â €â €â €
â €â €â €â €â €â €â €â €â €â €â£€â¡ â €â¢€â£¿â£â¡‡â¢¸â¡€â €â¡‡â €â£¾â ƒâ €â €â ‰â »â â “â ¶â ¶â ¿â¢¤â£€â¡·â¢„â£¸â¢®â£¿â¡¦â£¤â¡Ÿâ ‰â£¿â¢¸â¡â â €â£¸â â¢€â¡žâ ƒâ €â €â ”â¡¿â €â¡¾â €â €â €â €â €
â €â €â €â €â €â €â €â €â €â €â ¹â¡’â €â ˜â£¿â£¿â¡‡â ¸â£‡â¢°â¡‡â¢°â£§â£¶â£¶â£¶â¡†â €â €â €â €â£´â£–â£„â£’â£¦â£¼â£â£°â£¾â ¿â¢¾â£¯â£‰â£â£¾â¡‡â €â €â¡‡â €â£¼â â €â €â €â£°â ƒâ£¼â …â €â €â €â €â €
â €â €â €â €â €â €â €â €â €â €â €â ™â ³â ›â ¶â£½â¡‡â €â£¿â¡„â¢»â£¸â£Žâ ‰â ‰â â €â €â €â €â €â €â ‰â ‰â ‰â ‰â â¢¹â¡â â €â£¸â¡â ™â¡¿â£»â ‘â¢„â €â£§â €â¡Ÿâ¡†â €â €â¢¨â â¡´â¡‡â €â €â €â €â €â €
â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â£¿â¢·â €â£¿â¢¹â£„â£¿â ¿â¡‚â €â €â €â ‰â €â €â €â €â €â €â €â €â €â¢¾â â €â €â¡¿â£§â žâ£±â ‡â €â¡˜â ¦â¡½â£„â£¿â ¹â£„â¡´â¢‰â ”â â¢³â €â €â €â €â €â €
â €â €â €â €â €â €â €â¢€â£€â¡€â €â €â €â €â¢°â¡¿â¢¸â£§â ˜â£Ÿâ ™â£¿â¡„â €â €â¢€â¡€â €â €â €â €â €â €â €â €â €â¢ â£¯â –â €â¢°â£·â¢‡â¡¼â ƒâ¢€â žâ €â¡†â €â ™â£¿â¡¦â ™â¢¶â¡â €â €â €â â €â €â €â €â €
â €â €â €â €â ²â¢¿â ‹â ‰â ‰â ™â¢¦â£€â €â €â£¿â¡‡â¢¸â£¿â¡·â ¼â¢¶â ½â£¿â£†â €â ˆâ »â ¤â ¤â ¤â žâ €â €â €â €â¢´â£¿â ‡â €â €â£¸â¡¿â ‹â €â €â Žâ €â¡žâ €â£ â žâ¢â ½â¢¦â¡€â ™â¢¦â£€â €â €â €â €â €â €â €
â €â €â¢€â €â €â¢¸â£…â €â €â ˆâ ‰â ›â ‰â ”â£»â£¸â¢¸â£¿â ¿â£ â¡â£§â ™â¢¿â£§â£„â €â €â €â €â €â €â €â£€â£´â£¾â ƒâ €â €â¢°â ‡â €â €â €â €â €â €â£ â žâ¢â¡”â ƒâ €â â ‹â —â¢¦â£ˆâ ³â£„â €â €â €â €â €
â €â €â¢¿â£â¢¦â£¸â¡œâ£†â €â €â €â €â¡€â €â£§â¡‡â €â¡¿â €â €â €â ‰â â €â ‰â ›â¢·â£„â£€â£ â£´â žâ ‰â¢â¡¾â â €â €â£°â â €â €â €â €â €â¢ â£¾â ƒâ¢°â â €â €â €â €â €â €â €â ‰â ›â¢·â£µâ£„â €â €â €
â¢»â£Ÿâ£¿â¡»â£Žâ¢£â£³â¡˜â£†â €â¢ â¡žâ¡â €â£¾â£§â €â£§â €â €â €â €â €â €â €â €â €â¢ â¡Ÿâ£¿â €â£ â¢‚â£Ÿâ£¡â „â£ â¢¾â£‹â£€â£€â£€â¡€â €â¢°â£¿â ƒâ¢ â¡â €â €â €â €â €â €â €â €â €â €â €â ™â£¿â »â£„â €
â¡ˆâ¢»â£†â »â¡Ÿâ£†â¢»â£§â¢»â£„â¡¼â¢¸â¡‡â£¦â£¿â¡¼â£§â£½â¡„â €â €â €â €â €â €â¢€â£´â£‹â£¤â£¿â¢ˆâ Ÿâ¢¹â¡¿â£¡â¡žâ ‰â ‰â €â €â£°â£¶â£™â£·â£¯â¡â €â£¸â â €â €â €â €â €â €â €â €â €â €â €â €â ˆâ£·â ˆâ¢§
â£–â ¦â£¾â£·â¡™â ¿â €â ™â €â¢»â¡‡â¢¸â¡‡â ˜â¢¿â£·â¡Œâ »â£¿â£¤â €â €â €â£ â£¶â¡¿â ‹â£±â£¿â Ÿâ â£ â£¿â¢ â¡â €â €â¢€â¡¾â Ÿâ ‹â â €â£¨â¢¿â¡‡â €â¡‡â €â €â €â €â €â €â €â €â €â €â €â €â €â €â ˆâ£§â €
â ˜â¢¿â£Žâ¡™â ›â ‚â €â €â €â¡¼â ƒâ¢¸â ‡â ˜â¡„â ™â ›â €â ˆâ ‰â €â£ â£¾â¢â¡œâ¢¡â¡¾â ›â €â£ â¡¾â ‰â¢»â£¿â£„â£€â¡¾â ›â €â €â €â¡ â Šâ €â €â¢³â €â¢³â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â ˜â¡„
â €â €â ™â¢¿â£¦â¡€â €â €â €â â €â¢¸â£‡â €â €â €â €â €â €â¢€â£¾â£¿â ƒâ¡Žâ¢ â¡¿â ¥â£¤â žâ ‰â¢°â£¦â£€â¡½â ›â ›â €â €â €â¢ â Žâ €â €â €â €â ¸â£†â ˜â£‡â €â €â €â €â €â €â €â €â €â €â£„â¢‡â €â €â €â¢³
â €â €â €â €â£¿â¢¹â£†â¡€â €â €â¡€â£ˆâ£¿â¢»â¡€â €â €â €â¢€â£¾â¢¿â£‡â ˜â¢ â¡Ÿâ¢€â¡´â ‹â£€â£¸â£·â£¿â ‹â â €â €â €â €â¢€â¡‡â €â €â €â €â €â €â¢»â£·â£Œâ ³â£„â¡€â €â €â €â €â €â €â €â ˆâ ‰â €â €â €â¢¸
â €â €â €â €â ˆâ¢»â£™â ›â ›â ‰â ‰â ‰â €â£¾â£¾â¡€â €â¢€â£¾â¢â£¾â¡¾â¢€â¡žâ¢ â¡¾â£·â£¿â£¿â£¿â ‹â €â €â €â €â €â¡€â¢€â¡žâ €â €â €â €â €â €â €â¢˜â¡Œâ ™â ·â£¬â¡»â£—â ’â ’â ¦â ¤â ¤â ¤â¢¤â£„â£€â €â €â¢¸
â €â €â €â €â €â ¾â¢¯â¡â €â €â €â €â  â¢žâ£»â¢·â£¤â£¾â£â£¸â¢¹â£§â£¸â££â¢Ÿâ£¤â£¿â£¿â¡¿â ¥â¡„â €â €â €â €â €â£§â£¸â €â €â €â €â €â €â €â €â¢¸â¡‡â €â €â €â ‰â ™â ³â ¤â ¤â ¤â£„â£€â£€â €â ˆâ ‰â “â ¿
â €â €â €â €â â ¦â¡¼â ¥â ¤â ¤â¢„â¡¤â –â ‹â â ˜â¡Ÿâ €â ˆâ ³â£œâ£¿â£¿â££â£¾â Ÿâ ‹â â €â¢¸â¡‡â €â €â €â €â €â¢¸â ‡â €â €â €â €â €â €â €â €â €â¢³â €â €â €â €â €â €â €â €â €â €â €â ‰â ¹â£²â£¤â¡€â €
â €â €â €â €â €â €â¡‡â €â €â €â¢€â¡¬â£â ‚â €â €â¡‡â €â €â£¤â£™â¡Ÿâ ‰â¡¯â ¤â ¤â €â €â  â¡¿â €â €â €â €â €â €â ˆâ£‡â €â €â €â €â €â €â €â €â €â£¸â €â €â €â €â €â €â €â €â €â €â£ â ´â ›â â €â ™â£¦
â €â €â €â €â €â €â¡‡â €â €â €â ƒâ €â£¸â €â¢€â£´â¡Ÿâ €â  â ”â ’â£§â£¤â£·â¡¦â¡„â €â €â €â£§â €â €â €â €â €â €â €â¢¸â €â €â €â €â €â €â €â €â €â¡‡â €â €â €â €â €â €â €â¢€â£¤â žâ â €â €â¢€â¡¤â Žâ €
â €â €â €â €â €â¢ˆâ£¿â €â €â €â¢ â €â ƒâ¢ â â¡¼â €â €â €â£ â¡¼â£¿â£â¡â¢¿â¢„â €â €â €â¡â¢§â¡€â €â €â €â €â €â¢¸â¡†â €â €â €â €â €â €â €â €â¡‡â €â €â €â €â €â¢€â¡´â ‹â €â¢€â£¤â ´â Ÿâ ‰â €â €â €
â €â €â €â €â €â¢›â¡»â¡‡â €â €â ˆâ †â €â¢¸â¡„â §â ¤â ´â ›â ‰â£¸â£§â¢»â €â ˜â €â ›â ¦â ¼â ƒâ£€â£¹â †â €â €â €â €â ˆâ¡‡â €â €â €â €â €â €â €â €â¢£â €â €â €â¢€â¡´â ‹â¢€â£¤â žâ ‰â €â €â €â €â €â €â €
â €â €â €â €â ‰â €â ˜â£¿â¡„â €â €â €â €â €â¢»â¡€â €â €â¢€â¡¼â£»â¡½â¢¸â €â €â €â €â¢€â£ â£â â €â €â €â €â €â €â €â£³â €â €â €â €â €â €â €â €â ˜â¡†â €â¢ â¡Ÿâ¢€â¡´â ‹â €â €â €â €â €â €â €â €â €â €

                            DISCLAIMER

Anyway, if you need a piece of code from this plugin, 
please mention in the description or somewhere else that you got it from @KangelPlugins & @SwagNonHer
                             Thanks.
                            ðŸ™BLESSðŸ™

"""



import traceback
import os
import requests
import json
import threading
import time

from base_plugin import BasePlugin, MethodHook, MethodReplacement
from hook_utils import find_class
from android_utils import log, run_on_ui_thread, OnClickListener
from java import jclass, dynamic_proxy
from java.util import Locale
from ui.settings import Header, Switch, Selector, Input, Divider, Text
from ui.bulletin import BulletinHelper
from client_utils import get_last_fragment, run_on_queue
from ui.alert import AlertDialogBuilder


try:
    Typeface = find_class("android.graphics.Typeface")
    Paint = find_class("android.graphics.Paint")
    TextView = find_class("android.widget.TextView")
    SimpleTextView = find_class("org.telegram.ui.ActionBar.SimpleTextView")
    TextPaint = find_class("android.text.TextPaint")
    ViewGroup = find_class("android.view.ViewGroup")
    Context = find_class("android.content.Context")
    AttributeSet = find_class("android.util.AttributeSet")
    Integer = find_class("java.lang.Integer")
    Long = find_class("java.lang.Long")
    View = find_class("android.view.View")
    File = jclass("java.io.File")
    URL = jclass("java.net.URL")
    Channels = jclass("java.nio.channels.Channels")
    FileOutputStream = jclass("java.io.FileOutputStream")
    ApplicationLoader = find_class("org.telegram.messenger.ApplicationLoader")
    AndroidUtilities = find_class("org.telegram.messenger.AndroidUtilities")
    R = find_class("org.telegram.messenger.R")
    Theme = find_class("org.telegram.ui.ActionBar.Theme")
    FrameLayout = find_class("android.widget.FrameLayout")
    LinearLayout = find_class("android.widget.LinearLayout")
    Gravity = find_class("android.view.Gravity")
    Handler = find_class("android.os.Handler")
    Looper = find_class("android.os.Looper")
    Runnable = jclass("java.lang.Runnable")
    AnimatedTextView = find_class("org.telegram.ui.Components.AnimatedTextView")
    
    JAVA_IMPORTS_OK = True
except Exception as e:
    log(f"[SFGlobalFont] Critical error importing Java classes: {e}")
    JAVA_IMPORTS_OK = False

try:
    EditTextBoldCursor = find_class("org.telegram.ui.Components.EditTextBoldCursor")
except Exception:
    EditTextBoldCursor = None
try:
    NumberTextView = find_class("org.telegram.ui.Components.NumberTextView")
except Exception:
    NumberTextView = None

__id__ = "mnd_global_sf_font"
__name__ = "Global Fonts"
__description__ = """ÐŸÑ€Ð¸Ð¼ÐµÐ½ÑÐµÑ‚ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ñ‹Ð¹ ÑˆÑ€Ð¸Ñ„Ñ‚ ÐºÐ¾ Ð²ÑÐµÐ¼Ñƒ Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹ÑÑƒ Telegram. Ð’ÐºÐ»ÑŽÑ‡Ð°ÐµÑ‚ Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½ ÑˆÑ€Ð¸Ñ„Ñ‚Ð¾Ð² Google Fonts.
Ð¢Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸Ñ: exteraGram/AyuGram 12.0.1 Ð¸Ð»Ð¸ Ð²Ñ‹ÑˆÐµ

Applies the selected font to the entire Telegram interface. Includes the Google Fonts store.
Requirements: exteraGram/AyuGram 12.0.1 or higher
"""
__author__ = "@swagnonher & @KangelPlugins"
__version__ = "1.1.1"
__min_version__ = "12.0.1"
__icon__ = "OMGKAWAIIANGELGOD/11"


class Locales:
    default = {
        "settings_header": "ðŸ…µ Global Font",
        "settings_enable": "Enable plugin",
        "settings_source": "Font source",
        "settings_source_items": [
            "Built-in (Zpix)",
            "Custom URL",
            "System default",
        ],
        "settings_custom_url": "Link to .ttf/.otf",
        "settings_custom_url_sub": "Direct link to a font file",
        "bulletin_url_invalid": "Invalid font URL",
        "bulletin_ready": "Font is ready and applied!",
        "bulletin_downloading": "Downloading fontâ€¦",
        "bulletin_failed": "Font download error",
        "font_store_button": "Font store",
        "font_store_title": "Font store",
        "font_store_search_hint": "Search by name...",
        "font_store_loading": "Loading font list...",
        "gfonts_pick_family": "Choose family",
        "gfonts_pick_variant": "Choose style",
        "gfonts_no_results": "Nothing found",
        "gfonts_only_ttf": "Only .ttf/.otf variants are available",
        "gfonts_api_error": "Google Fonts API error",
        "requests_missing": "requests not available",
    }
    en = default
    ru = {
        "settings_header": "ðŸ…µ Ð“Ð»Ð¾Ð±Ð°Ð»ÑŒÐ½Ñ‹Ð¹ ÑˆÑ€Ð¸Ñ„Ñ‚",
        "settings_enable": "Ð’ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ Ð¿Ð»Ð°Ð³Ð¸Ð½",
        "settings_source": "Ð˜ÑÑ‚Ð¾Ñ‡Ð½Ð¸Ðº ÑˆÑ€Ð¸Ñ„Ñ‚Ð°",
        "settings_source_items": [
            "Ð’ÑÑ‚Ñ€Ð¾ÐµÐ½Ð½Ñ‹Ð¹ (Zpix)",
            "ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¸Ð¹ URL",
            "Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ð¹ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ",
        ],
        "settings_custom_url": "Ð¡ÑÑ‹Ð»ÐºÐ° Ð½Ð° .ttf/.otf",
        "settings_custom_url_sub": "ÐŸÑ€ÑÐ¼Ð°Ñ ÑÑÑ‹Ð»ÐºÐ° Ð½Ð° Ñ„Ð°Ð¹Ð» ÑˆÑ€Ð¸Ñ„Ñ‚Ð°",
        "bulletin_url_invalid": "ÐÐµÐ²ÐµÑ€Ð½Ð°Ñ ÑÑÑ‹Ð»ÐºÐ° ÑˆÑ€Ð¸Ñ„Ñ‚Ð°",
        "bulletin_ready": "Ð¨Ñ€Ð¸Ñ„Ñ‚ Ð³Ð¾Ñ‚Ð¾Ð² Ð¸ Ð¿Ñ€Ð¸Ð¼ÐµÐ½Ñ‘Ð½!",
        "bulletin_downloading": "Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° ÑˆÑ€Ð¸Ñ„Ñ‚Ð°â€¦",
        "bulletin_failed": "ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ ÑˆÑ€Ð¸Ñ„Ñ‚Ð°",
        "font_store_button": "ÐœÐ°Ð³Ð°Ð·Ð¸Ð½ ÑˆÑ€Ð¸Ñ„Ñ‚Ð¾Ð²",
        "font_store_title": "ÐœÐ°Ð³Ð°Ð·Ð¸Ð½ ÑˆÑ€Ð¸Ñ„Ñ‚Ð¾Ð²",
        "font_store_search_hint": "ÐŸÐ¾Ð¸ÑÐº Ð¿Ð¾ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸ÑŽ...",
        "font_store_loading": "Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° ÑÐ¿Ð¸ÑÐºÐ° ÑˆÑ€Ð¸Ñ„Ñ‚Ð¾Ð²...",
        "gfonts_pick_family": "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑÐµÐ¼ÐµÐ¹ÑÑ‚Ð²Ð¾",
        "gfonts_pick_variant": "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð½Ð°Ñ‡ÐµÑ€Ñ‚Ð°Ð½Ð¸Ðµ",
        "gfonts_no_results": "ÐÐ¸Ñ‡ÐµÐ³Ð¾ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾",
        "gfonts_only_ttf": "Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ñ‹ .ttf/.otf",
        "gfonts_api_error": "ÐžÑˆÐ¸Ð±ÐºÐ° API Google Fonts",
        "requests_missing": "Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ° requests Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð°",
    }


def t(key: str) -> str:
    lang = Locale.getDefault().getLanguage()
    loc = getattr(Locales, lang, Locales.default)
    return loc.get(key, key)



class _Invalid_FontStoreFragment_Removed(object):
    def __init__(self, plugin_instance):
        super().__init__()
        self.plugin = plugin_instance
        self.all_fonts = []
        self.filtered_fonts = []
        self.adapter = None
        self.listView = None
        self.searchField = None
        self.loadingView = None
        self.search_handler = Handler(Looper.getMainLooper())
        self.search_runnable = None

    def createView(self, context):
        self.actionBar.setBackButtonImage(R.drawable.ic_ab_back)
        self.actionBar.setTitle(t("font_store_title"))
        self.actionBar.setAllowOverlayTitle(True)
        self.actionBar.setActionBarMenuOnItemClick(
            dynamic_proxy(ActionBar.ActionBarMenuOnItemClick)(
                lambda id: (id == -1 and self.finishFragment())
            )
        )
        
        self.fragmentView = FrameLayout(context)
        self.fragmentView.setBackgroundDrawable(Theme.createServiceShaderDrawable(
            Theme.getThemeDrawableDesc(self.fragmentView, Theme.key_windowBackgroundGray),
            True
        ))
        
        self.fragmentView.setClickable(True)

        main_layout = LinearLayout(context)
        main_layout.setOrientation(LinearLayout.VERTICAL)
        self.fragmentView.addView(main_layout, FrameLayout.LayoutParams(-1, -1))

        search_container = FrameLayout(context)
        search_container.setBackgroundColor(Theme.getColor(Theme.key_dialogBackground))
        self.searchField = EditText(context)
        self.searchField.setHint(t("font_store_search_hint"))
        self.searchField.setHintTextColor(Theme.getColor(Theme.key_dialogTextHint))
        self.searchField.setTextColor(Theme.getColor(Theme.key_dialogTextBlack))
        self.searchField.setBackground(None)
        self.searchField.setPadding(AndroidUtilities.dp(16), AndroidUtilities.dp(10), AndroidUtilities.dp(16), AndroidUtilities.dp(10))
        self.searchField.addTextChangedListener(dynamic_proxy(TextWatcher)(
            afterTextChanged=self._on_search_text_changed
        ))
        search_container.addView(self.searchField, FrameLayout.LayoutParams(-1, -2))
        main_layout.addView(search_container)
        
        divider_view = View(context)
        divider_view.setBackgroundColor(Theme.getColor(Theme.key_divider))
        main_layout.addView(divider_view, LinearLayout.LayoutParams(-1, 1))

        list_container = FrameLayout(context)
        list_container.setBackgroundColor(Theme.getColor(Theme.key_dialogBackground))
        main_layout.addView(list_container, LinearLayout.LayoutParams(-1, -1))

        self.listView = RecyclerListView(context)
        self.listView.setLayoutManager(LinearLayoutManager(context, LinearLayoutManager.VERTICAL, False))
        self.adapter = self.ListAdapter(context, self.plugin, self)
        self.listView.setAdapter(self.adapter)
        list_container.addView(self.listView, FrameLayout.LayoutParams(-1, -1))

        self.loadingView = ProgressBar(context)
        self.loadingView.setVisibility(View.VISIBLE)
        params = FrameLayout.LayoutParams(-2, -2, Gravity.CENTER)
        list_container.addView(self.loadingView, params)

        return self.fragmentView

    def onFragmentCreate(self):
        super().onFragmentCreate()
        self.setHasOwnBackground(True) 
        self._fetch_fonts()
        return True

    def _on_search_text_changed(self, s):
        if self.search_runnable:
            self.search_handler.removeCallbacks(self.search_runnable)
        
        query = str(s.toString())
        
        class SearchRunnable(dynamic_proxy(Runnable)):
            _fragment_ref = self
            _query = query
            def run(self):
                self._fragment_ref._filter_fonts(self._query)

        self.search_runnable = SearchRunnable()
        self.search_handler.postDelayed(self.search_runnable, 300)

    def _fetch_fonts(self):
        def task():
            try:
                api_key = "AIzaSyBZBi89KDR77uodfz4y14M69ZOI9vQwn3E"
                url = f"https://www.googleapis.com/webfonts/v1/webfonts?key={api_key}&sort=popularity"
                response = requests.get(url, timeout=30)
                response.raise_for_status()
                data = response.json()
                self.all_fonts = data.get("items", [])
                run_on_ui_thread(lambda: self._update_font_list(self.all_fonts))
            except Exception as e:
                log(f"[SFGlobalFont] Google Fonts API error: {e}")
                run_on_ui_thread(lambda: self.loadingView and self.loadingView.setVisibility(View.GONE))
                BulletinHelper.show_error(t("gfonts_api_error"))

        run_on_queue(task)

    def _update_font_list(self, fonts):
        self.filtered_fonts = fonts
        if self.adapter:
            self.adapter.set_fonts(fonts)
            self.adapter.notifyDataSetChanged()
        if self.loadingView:
            self.loadingView.setVisibility(View.GONE)
        if self.listView:
            self.listView.setVisibility(View.VISIBLE)
    
    def _filter_fonts(self, query):
        if not query:
            self.filtered_fonts = self.all_fonts
        else:
            query_lower = query.lower()
            self.filtered_fonts = [
                font for font in self.all_fonts
                if query_lower in font.get("family", "").lower()
            ]
        
        if self.adapter:
            self.adapter.set_fonts(self.filtered_fonts)
            self.adapter.notifyDataSetChanged()

    class ListAdapter(object):
        def __init__(self, context, plugin, fragment):
            super().__init__()
            self.mContext = context
            self.plugin = plugin
            self.fragment = fragment
            self.fonts = []

        def set_fonts(self, fonts):
            self.fonts = fonts

        def getItemCount(self):
            return len(self.fonts)

        def isEnabled(self, holder):
            return True

        def onCreateViewHolder(self, parent, viewType):
            view = TextView(self.mContext)
            view.setTextColor(Theme.getColor(Theme.key_dialogTextBlack))
            view.setTextSize(16)
            view.setPadding(AndroidUtilities.dp(16), AndroidUtilities.dp(12), AndroidUtilities.dp(16), AndroidUtilities.dp(12))
            view.setLines(1)
            view.setGravity(Gravity.CENTER_VERTICAL | Gravity.LEFT)
            view.setBackground(Theme.createSelectorDrawable(Theme.getColor(Theme.key_listSelector), 2))
            return type("_Holder", (), {"itemView": view})()

        def onBindViewHolder(self, holder, position):
            font_data = self.fonts[position]
            view = holder.itemView
            view.setText(font_data.get("family"))
            
            def on_click():
                self.fragment.finishFragment()
                run_on_ui_thread(lambda: self.plugin._pick_gfont_variant(font_data))
                
            view.setOnClickListener(OnClickListener(on_click))

class SFGlobalFontPlugin(BasePlugin):
    FONT_URL = "https://github.com/Ar4ikTrirtyFour/windose20/raw/refs/heads/main/fonts/zpix.ttf"
    FONT_FILENAME = "global_font.ttf"

    def __init__(self):
        super().__init__()
        self._typeface = None
        self._hooks = []
        self._hooks_applied = False
        self._typeface_hijacked = False
        self._store_overlay = None
        self._store_items = []
        self._store_filtered_items = []
        self._store_grid_container = None
        self._store_is_loading = False
        self._store_last_append_time = 0.0
        self._fonts_cache_ttl_sec = 3600
        self._store_search_query = ""
        self._store_category = ""
        self._store_search_seq = 0
        self._store_loaded_index = 0

    def on_plugin_load(self):
        if not JAVA_IMPORTS_OK:
            log("[SFGlobalFont] Plugin disabled due to missing Java classes.")
            return
        try:
            if not self.get_setting("enabled", True):
                log("[SFGlobalFont] Disabled by settings")
                return
            log("[SFGlobalFont] Loading plugin...")
            self._ensure_typeface_downloaded()
            if not self._typeface:
                log("[SFGlobalFont] Typeface not initialized; aborting hooks.")
                return
            log("[SFGlobalFont] Typeface loaded successfully")
            self._apply_global_hooks()
            self._hooks_applied = True
            log("[SFGlobalFont] Global hooks applied")
            self._hijack_system_typefaces()
            self._typeface_hijacked = True
            try:
                self._apply_typeface_to_theme_paints()
            except Exception:
                pass
            try:
                self._reload_theme_resources_and_refresh_ui()
            except Exception:
                pass
            log("[SFGlobalFont] âœ“ Plugin loaded successfully; global font active.")
        except Exception:
            log(f"[SFGlobalFont] âœ— Failed to load plugin: {traceback.format_exc()}")

    def on_plugin_unload(self):
        try:
            for h in self._hooks:
                try:
                    self.unhook_method(h)
                except Exception:
                    pass
            self._hooks.clear()
            log("[SFGlobalFont] Unloaded and unhooked.")
        except Exception:
            pass

    def _get_persistent_font_path(self) -> str:
        try:
            files_dir = ApplicationLoader.applicationContext.getFilesDir()
            dir_path = File(files_dir, f"plugins/{__id__}")
            if not dir_path.exists():
                dir_path.mkdirs()
            return File(dir_path, self.FONT_FILENAME).getAbsolutePath()
        except Exception:
            return os.path.join(os.getcwd(), self.FONT_FILENAME)

    def _ensure_typeface_downloaded(self):
        source = self.get_setting("font_source", 0)
        custom_url = (self.get_setting("custom_url", "") or "").strip()

        if source == 2:
            try:
                self._typeface = getattr(Typeface, "SANS_SERIF", Typeface.DEFAULT)
                log("[SFGlobalFont] Using system default typeface")
            except Exception:
                log(f"[SFGlobalFont] Fallback to system default failed: {traceback.format_exc()}")
            return

        path = self._get_persistent_font_path()
        if not path:
            log("[SFGlobalFont] Invalid persistent path")
            return
        need_download = True
        try:
            if os.path.exists(path) and os.path.getsize(path) > 0:
                need_download = False
        except Exception:
            need_download = True

        if need_download:
            url = self.FONT_URL if source == 0 else custom_url
            if source == 1 and not (url.startswith("http://") or url.startswith("https://")):
                log("[SFGlobalFont] Invalid custom URL")
                return
            run_on_ui_thread(lambda: BulletinHelper.show_info(t("bulletin_downloading")))
            log(f"[SFGlobalFont] Downloading font from {url}")

            def _download_task():
                ok = False
                try:
                    try:
                        import requests as _rq
                        resp = _rq.get(url, timeout=30, stream=True)
                        if resp.status_code == 200:
                            with open(path, "wb") as f:
                                for chunk in resp.iter_content(8192):
                                    if chunk:
                                        f.write(chunk)
                            ok = True
                    except Exception:
                        try:
                            ReadableByteChannel = Channels.newChannel(URL(url).openStream())
                            fos = FileOutputStream(path)
                            fos.getChannel().transferFrom(ReadableByteChannel, 0, Long.MAX_VALUE)
                            fos.close()
                            ok = True
                        except Exception:
                            pass

                    if ok and os.path.exists(path) and os.path.getsize(path) > 0:
                        try:
                            self._typeface = Typeface.createFromFile(path)
                            run_on_ui_thread(lambda: BulletinHelper.show_success(t("bulletin_ready")))
                            if not self._hooks_applied:
                                try:
                                    self._apply_global_hooks()
                                    self._hooks_applied = True
                                except Exception:
                                    pass
                            try:
                                self._hijack_system_typefaces()
                            except Exception:
                                pass
                            run_on_ui_thread(self._refresh_visible_text_views)
                        except Exception:
                            run_on_ui_thread(lambda: BulletinHelper.show_error(t("bulletin_failed")))
                    else:
                        run_on_ui_thread(lambda: BulletinHelper.show_error(t("bulletin_failed")))
                except Exception:
                    log(f"[SFGlobalFont] Font download failed: {traceback.format_exc()}")
                    run_on_ui_thread(lambda: BulletinHelper.show_error(t("bulletin_failed")))

            threading.Thread(target=_download_task, daemon=True).start()


        try:
            if os.path.exists(path) and os.path.getsize(path) > 0:
                self._typeface = Typeface.createFromFile(path)
                if self._typeface is None:
                    log("[SFGlobalFont] Failed to create Typeface from file")
        except Exception:
            log(f"[SFGlobalFont] Typeface init error: {traceback.format_exc()}")
        try:
            self._hijack_system_typefaces()
        except Exception:
            pass

    def _delete_cached_font(self):
        try:
            path = self._get_persistent_font_path()
            if path and os.path.exists(path):
                os.remove(path)
                log(f"[SFGlobalFont] Deleted cached font: {path}")
        except Exception:
            pass

    def _refresh_visible_text_views(self):
        def _apply_on_view(view):
            try:
                if TextView.isInstance(view):
                    try:
                        paint = view.getPaint()
                        if paint is not None and hasattr(paint, "setTypeface") and self._typeface is not None:
                            paint.setTypeface(self._typeface)
                            view.invalidate()
                    except Exception: pass
                if SimpleTextView.isInstance(view):
                    try:
                        tp = view.getTextPaint()
                        if tp is not None and hasattr(tp, "setTypeface") and self._typeface is not None:
                            tp.setTypeface(self._typeface)
                            view.invalidate()
                    except Exception: pass

                if ViewGroup.isInstance(view):
                    try:
                        count = view.getChildCount()
                        for i in range(count):
                            _apply_on_view(view.getChildAt(i))
                    except Exception: pass
            except Exception: pass

        def run():
            try:
                fragment = get_last_fragment()
                if not fragment: return
                activity = fragment.getParentActivity()
                if not activity: return
                decor = activity.getWindow().getDecorView()
                if decor: _apply_on_view(decor)
            except Exception: pass
        run_on_ui_thread(run)


    def _on_font_settings_changed(self):
        try:
            log("[SFGlobalFont] Font settings changed")
            if not self.get_setting("enabled", True):
                log("[SFGlobalFont] Plugin disabled by user")
                self.on_plugin_unload() 
                return
            
            if not self._hooks:
                log("[SFGlobalFont] No hooks found, reloading plugin")
                self.on_plugin_load()
                return

            source = self.get_setting("font_source", 0)
            source_name = ["Built-in (Zpix)", "Custom URL", "System default"][source]
            log(f"[SFGlobalFont] Font source changed to: {source_name}")
            if source in (0, 1):
                self._delete_cached_font()
                self._typeface_hijacked = False
            self._ensure_typeface_downloaded()
            if not self._typeface:
                log("[SFGlobalFont] âœ— Failed to load typeface")
                BulletinHelper.show_error(t("bulletin_failed"))
                return
            log("[SFGlobalFont] âœ“ Typeface loaded")
            try:
                if not self._typeface_hijacked:
                    log("[SFGlobalFont] Hijacking system typefaces...")
                    self._hijack_system_typefaces()
                    self._typeface_hijacked = True
                else:
                    log("[SFGlobalFont] System typefaces already hijacked")
            except Exception as e:
                log(f"[SFGlobalFont] âœ— Error hijacking typefaces: {e}")
            try:
                self._apply_typeface_to_theme_paints()
            except Exception as e:
                log(f"[SFGlobalFont] âœ— Error applying typeface to theme paints: {e}")
            try:
                self._reload_theme_resources_and_refresh_ui()
            except Exception as e:
                log(f"[SFGlobalFont] âœ— Error reloading theme: {e}")
            self._refresh_visible_text_views()
            log("[SFGlobalFont] âœ“ Font settings applied successfully")
            BulletinHelper.show_success(t("bulletin_ready"))
        except Exception as e:
            log(f"[SFGlobalFont] âœ— Error in _on_font_settings_changed: {e}")
            BulletinHelper.show_error(t("bulletin_failed"))

    def _hijack_system_typefaces(self):
        try:
            if not self._typeface:
                log("[SFGlobalFont] _hijack_system_typefaces: typeface not loaded")
                return
            TFClass = Typeface.getClass() if hasattr(Typeface, 'getClass') else Typeface
            hijacked_count = 0
            for fname in ("DEFAULT", "DEFAULT_BOLD", "SANS_SERIF", "SERIF", "MONOSPACE"):
                try:
                    f = TFClass.getDeclaredField(fname)
                    f.setAccessible(True)
                    f.set(None, self._typeface)
                    hijacked_count += 1
                except Exception:
                    pass
            log(f"[SFGlobalFont] âœ“ Hijacked {hijacked_count} Typeface static fields")
            try:
                f = TFClass.getDeclaredField("sSystemFontMap")
                f.setAccessible(True)
                m = f.get(None)
                if m is not None:
                    keys = ["sans-serif", "sans-serif-medium", "sans-serif-light", "sans-serif-condensed",
                            "serif", "monospace", "google-sans", "roboto", "roboto-medium", "system"]
                    for k in keys:
                        try:
                            m.put(k, self._typeface)
                        except Exception:
                            pass
                    log(f"[SFGlobalFont] âœ“ Updated sSystemFontMap with {len(keys)} font families")
            except Exception as e:
                log(f"[SFGlobalFont] âœ— Failed to hijack sSystemFontMap: {e}")
        except Exception as e:
            log(f"[SFGlobalFont] Error in _hijack_system_typefaces: {e}")

    def _apply_typeface_to_theme_paints(self):
        try:
            if not self._typeface:
                return
            ThemeClass = find_class("org.telegram.ui.ActionBar.Theme")
            if ThemeClass is None:
                log("[SFGlobalFont] âœ— Theme class not found")
                return
            TClass = ThemeClass.getClass() if hasattr(ThemeClass, "getClass") else ThemeClass
            applied_count = 0

            def _set_tp(obj):
                try:
                    if obj is None:
                        return
                    try:
                        length = len(obj)
                        for i in range(length):
                            p = obj[i]
                            try:
                                if hasattr(p, 'setTypeface'):
                                    p.setTypeface(self._typeface)
                            except Exception:
                                pass
                        return
                    except Exception:
                        pass
                    try:
                        if hasattr(obj, 'setTypeface'):
                            obj.setTypeface(self._typeface)
                    except Exception:
                        pass
                except Exception:
                    pass

            fields = [
                "dialogs_namePaint",
                "dialogs_nameEncryptedPaint",
                "dialogs_messagePaint",
                "dialogs_messagePrintingPaint",
                "dialogs_messageNamePaint",
                "dialogs_searchNamePaint",
                "dialogs_searchNameEncryptedPaint",
                "dialogs_timePaint",
                "dialogs_archiveTextPaint",
                "dialogs_archiveTextPaintSmall",
                "dialogs_countTextPaint",
                "dialogs_onlinePaint",
                "dialogs_offlinePaint",
                "dialogs_tagTextPaint",
                "chat_namePaint",
                "chat_replyNamePaint",
                "chat_replyTextPaint",
                "chat_docNamePaint",
                "chat_contextResult_titleTextPaint",
                "chat_contextResult_descriptionTextPaint",
                "chat_locationTitlePaint",
                "chat_locationAddressPaint",
                "chat_titleLabelTextPaint",
                "chat_topicTextPaint",
                "chat_quoteTextPaint",
                "chat_forwardNamePaint",
                "chat_timePaint",
                "chat_audioTimePaint",
                "chat_audioTitlePaint",
                "chat_audioPerformerPaint",
                "chat_adminPaint",
                "chat_gamePaint",
                "chat_shipmentPaint",
                "chat_durationPaint",
                "chat_contactNamePaint",
                "chat_contactPhonePaint",
                "chat_infoPaint",
                "chat_infoBoldPaint",
                "chat_stickerCommentCountPaint",
                "chat_botButtonPaint",
                "chat_msgTextPaint",
                "chat_msgGameTextPaint",
                "chat_msgBotButtonPaint",
                "chat_msgTextCodePaint",
                "chat_msgTextCode2Paint",
                "chat_msgTextCode3Paint",
                "chat_msgTextPaintOneEmoji",
                "chat_msgTextPaintTwoEmoji",
                "chat_msgTextPaintThreeEmoji",
                "chat_livePaint",
                "chat_instantViewPaint",
                "chat_commentTextPaint",
                "chat_actionTextPaint",
                "chat_actionTextPaint2",
                "chat_actionTextPaint3",
                "chat_unlockExtendedMediaTextPaint",
                "profile_aboutTextPaint",
            ]

            found_count = 0
            null_count = 0
            for fname in fields:
                try:
                    f = TClass.getDeclaredField(fname)
                    f.setAccessible(True)
                    obj = f.get(None)
                    found_count += 1
                    if obj is not None:
                        _set_tp(obj)
                        applied_count += 1
                    else:
                        null_count += 1
                except Exception as e:
                    pass
            
            log(f"[SFGlobalFont] Theme paint fields: found={found_count}, applied={applied_count}, null={null_count}")

            if applied_count > 0:
                log(f"[SFGlobalFont] âœ“ Applied typeface to {applied_count} Theme paint fields")
            else:
                log(f"[SFGlobalFont] âš  No Theme paint fields were applied (all may be null or not found)")

            try:
                WebActionBarClass = find_class("org.telegram.ui.web.WebActionBar")
                if WebActionBarClass is not None:
                    try:
                        wf = WebActionBarClass.getDeclaredField("titlePaint")
                        wf.setAccessible(True)
                        obj = wf.get(None)
                        if obj is not None:
                            _set_tp(obj)
                            log("[SFGlobalFont] âœ“ Applied typeface to WebActionBar titlePaint")
                    except Exception:
                        pass
            except Exception:
                pass
        except Exception as e:
            log(f"[SFGlobalFont] Error in _apply_typeface_to_theme_paints: {e}")

    def _reload_theme_resources_and_refresh_ui(self):
        try:
            Theme.reloadAllResources(ApplicationLoader.applicationContext)
        except Exception:
            pass
        try:
            self._apply_typeface_to_theme_paints()
        except Exception:
            pass
    
    def create_settings(self):
        lang = Locale.getDefault().getLanguage()
        return [
            Header(
                text=t("settings_header")
            ),
            Switch(key="enabled", 
                text=t("settings_enable"), 
                default=self.get_setting("enabled", True),
                icon="device_web_safari", 
                on_change=lambda v: self._on_font_settings_changed()),
            Selector(
                key="font_source",
                text=t("settings_source"),
                default=self.get_setting("font_source", 0),
                items=t("settings_source_items"),
                icon="msg_photo_text_regular",
                on_change=lambda v: self._on_font_settings_changed(),
            ),
            Input(
                key="custom_url",
                text=t("settings_custom_url"),
                default=self.get_setting("custom_url", ""),
                icon="input_attach",
                subtext=t("settings_custom_url_sub"),
                on_change=lambda v: self._on_font_settings_changed(),
            ),
            Divider(),
            Text(
                text=t("font_store_button"),
                icon="menu_shop_solar",
                on_click=lambda v: self._open_font_store(),
                accent=True,
            ),
            Divider()
        ]

    def _open_font_store(self):
        self._open_google_fonts_store()

    def _apply_global_hooks(self):
        try:
            hooks_count = 0
            
            class BoldReplacement(MethodReplacement):
                _plugin_ref = self
                def replace_hooked_method(self, param):
                    return self._plugin_ref._typeface

            try:
                bold_method = AndroidUtilities.getClass().getDeclaredMethod("bold")
                self._hooks.append(self.hook_method(bold_method, BoldReplacement()))
                hooks_count += 1
                log("[SFGlobalFont] âœ“ Hooked AndroidUtilities.bold()")
            except Exception as e:
                log(f"[SFGlobalFont] âœ— Failed to hook AndroidUtilities.bold(): {e}")
            
            class GetTypefaceReplacement(MethodReplacement):
                _plugin_ref = self
                def replace_hooked_method(self, param):
                    return self._plugin_ref._typeface

            try:
                get_typeface_method = AndroidUtilities.getClass().getDeclaredMethod("getTypeface", jclass("java.lang.String"))
                self._hooks.append(self.hook_method(get_typeface_method, GetTypefaceReplacement()))
                hooks_count += 1
                log("[SFGlobalFont] âœ“ Hooked AndroidUtilities.getTypeface(String)")
            except Exception as e:
                log(f"[SFGlobalFont] âœ— Failed to hook AndroidUtilities.getTypeface(): {e}")

            class TextViewCtorHook(MethodHook):
                _plugin_ref = self
                def after_hooked_method(self, param):
                    try:
                        tv = param.thisObject
                        if tv and hasattr(tv, "setTypeface"):
                            tv.setTypeface(self._plugin_ref._typeface)
                    except Exception: pass
            
            tv_ctor_count = 0
            TVClass = TextView.getClass() if hasattr(TextView, "getClass") else TextView
            for ctor_args in [[Context], [Context, AttributeSet], [Context, AttributeSet, Integer.TYPE], [Context, AttributeSet, Integer.TYPE, Integer.TYPE]]:
                try:
                    ctor = TVClass.getDeclaredConstructor(*ctor_args)
                    self._hooks.append(self.hook_method(ctor, TextViewCtorHook()))
                    tv_ctor_count += 1
                except Exception: pass
            if tv_ctor_count > 0:
                log(f"[SFGlobalFont] âœ“ Hooked TextView constructors ({tv_ctor_count})")
            else:
                log("[SFGlobalFont] âœ— Failed to hook any TextView constructors")
            
            class SimpleTextViewCtorHook(MethodHook):
                _plugin_ref = self
                def after_hooked_method(self, param):
                    try:
                        v = param.thisObject
                        if v and hasattr(v, "setTypeface"):
                            v.setTypeface(self._plugin_ref._typeface)
                    except Exception: pass
            stv_ctor_count = 0
            try:
                SimpleTextViewClass = SimpleTextView.getClass() if hasattr(SimpleTextView, "getClass") else SimpleTextView
                try:
                    ctor = SimpleTextViewClass.getDeclaredConstructor(Context)
                    self._hooks.append(self.hook_method(ctor, SimpleTextViewCtorHook()))
                    stv_ctor_count += 1
                except Exception:
                    pass
                try:
                    ctor2 = SimpleTextViewClass.getDeclaredConstructor(Context, AttributeSet)
                    self._hooks.append(self.hook_method(ctor2, SimpleTextViewCtorHook()))
                    stv_ctor_count += 1
                except Exception:
                    pass
            except Exception:
                pass
            if stv_ctor_count > 0:
                log(f"[SFGlobalFont] âœ“ Hooked SimpleTextView constructors ({stv_ctor_count})")
            else:
                log("[SFGlobalFont] âœ— Failed to hook SimpleTextView constructors")

            class SimpleTextViewSetTypefaceReplacement(MethodReplacement):
                _plugin_ref = self
                def replace_hooked_method(self, param):
                    try:
                        v = param.thisObject
                        if v is not None and hasattr(v, 'getTextPaint') and self._plugin_ref._typeface is not None:
                            tp = v.getTextPaint()
                            if tp is not None:
                                tp.setTypeface(self._plugin_ref._typeface)
                        if hasattr(v, 'invalidate'):
                            v.invalidate()
                    except Exception:
                        pass
                    return None
            
            try:
                SimpleTextViewClass = SimpleTextView.getClass() if hasattr(SimpleTextView, "getClass") else SimpleTextView
                set_m = SimpleTextViewClass.getDeclaredMethod("setTypeface", Typeface)
                self._hooks.append(self.hook_method(set_m, SimpleTextViewSetTypefaceReplacement()))
            except Exception:
                pass

            try:
                ATVClass = AnimatedTextView.getClass() if hasattr(AnimatedTextView, "getClass") else AnimatedTextView
                class AnimatedTextViewCtorHook(MethodHook):
                    _plugin_ref = self
                    def after_hooked_method(self, param):
                        try:
                            v = param.thisObject
                            if v and hasattr(v, "setTypeface"):
                                v.setTypeface(self._plugin_ref._typeface)
                        except Exception:
                            pass
                for ctor_sig in ([Context], [Context, AttributeSet]):
                    try:
                        ctor = ATVClass.getDeclaredConstructor(*ctor_sig)
                        self._hooks.append(self.hook_method(ctor, AnimatedTextViewCtorHook()))
                    except Exception:
                        pass
            except Exception:
                pass

            try:
                ATVClass2 = AnimatedTextView.getClass() if hasattr(AnimatedTextView, "getClass") else AnimatedTextView
                class AnimatedTextViewSetTypefaceReplacement(MethodReplacement):
                    _plugin_ref = self
                    def replace_hooked_method(self, param):
                        try:
                            v = param.thisObject
                            if v is not None and hasattr(v, 'setTypeface') and self._plugin_ref._typeface is not None:
                                v.setTypeface(self._plugin_ref._typeface)
                        except Exception:
                            pass
                        return None
                try:
                    set_m = ATVClass2.getDeclaredMethod("setTypeface", Typeface)
                    self._hooks.append(self.hook_method(set_m, AnimatedTextViewSetTypefaceReplacement()))
                except Exception:
                    pass
            except Exception:
                pass

            try:
                set_tp = TextPaint.getClass().getDeclaredMethod("setTypeface", Typeface)
                class TextPaintSetTypefaceReplacement(MethodReplacement):
                    _plugin_ref = self
                    def replace_hooked_method(self, param):
                        try:
                            tp_obj = param.thisObject
                            if tp_obj is not None and self._plugin_ref._typeface is not None:
                                tp_obj.setTypeface(self._plugin_ref._typeface)
                        except Exception:
                            pass
                        return None
                self._hooks.append(self.hook_method(set_tp, TextPaintSetTypefaceReplacement()))
            except Exception:
                pass

            try:
                set_tp2 = TextPaint.getClass().getDeclaredMethod("setTypeface", Typeface, Integer.TYPE)
                class TextPaintSetTypefaceWithStyleReplacement(MethodReplacement):
                    _plugin_ref = self
                    def replace_hooked_method(self, param):
                        try:
                            tp_obj = param.thisObject
                            if tp_obj is not None and self._plugin_ref._typeface is not None:
                                tp_obj.setTypeface(self._plugin_ref._typeface)
                        except Exception:
                            pass
                        return None
                self._hooks.append(self.hook_method(set_tp2, TextPaintSetTypefaceWithStyleReplacement()))
            except Exception:
                pass


            try:
                TVClass = TextView.getClass() if hasattr(TextView, "getClass") else TextView
                class TextViewSetTypefaceReplacement(MethodReplacement):
                    _plugin_ref = self
                    def replace_hooked_method(self, param):
                        try:
                            tv = param.thisObject
                            if tv is not None and self._plugin_ref._typeface is not None:
                                p = tv.getPaint()
                                if p is not None:
                                    p.setTypeface(self._plugin_ref._typeface)
                                tv.invalidate()
                        except Exception:
                            pass
                        return None
                try:
                    set_m1 = TVClass.getDeclaredMethod("setTypeface", Typeface)
                    self._hooks.append(self.hook_method(set_m1, TextViewSetTypefaceReplacement()))
                except Exception:
                    pass
                try:
                    set_m2 = TVClass.getDeclaredMethod("setTypeface", Typeface, Integer.TYPE)
                    self._hooks.append(self.hook_method(set_m2, TextViewSetTypefaceReplacement()))
                except Exception:
                    pass
            except Exception:
                pass

            try:
                AppCompatTextView = find_class("androidx.appcompat.widget.AppCompatTextView")
            except Exception:
                AppCompatTextView = None
            try:
                if AppCompatTextView is not None:
                    ACClass = AppCompatTextView.getClass() if hasattr(AppCompatTextView, "getClass") else AppCompatTextView
                    class AppCompatTextViewCtorHook(MethodHook):
                        _plugin_ref = self
                        def after_hooked_method(self, param):
                            try:
                                v = param.thisObject
                                if v and hasattr(v, "setTypeface") and self._plugin_ref._typeface is not None:
                                    v.setTypeface(self._plugin_ref._typeface)
                            except Exception:
                                pass
                    for ctor_sig in ([Context], [Context, AttributeSet], [Context, AttributeSet, Integer.TYPE], [Context, AttributeSet, Integer.TYPE, Integer.TYPE]):
                        try:
                            ctor = ACClass.getDeclaredConstructor(*ctor_sig)
                            self._hooks.append(self.hook_method(ctor, AppCompatTextViewCtorHook()))
                        except Exception:
                            pass
                    try:
                        set_m = ACClass.getDeclaredMethod("setTypeface", Typeface)
                        self._hooks.append(self.hook_method(set_m, TextViewSetTypefaceReplacement()))
                    except Exception:
                        pass
            except Exception:
                pass

            try:
                if EditTextBoldCursor is not None:
                    EBCClass = EditTextBoldCursor.getClass() if hasattr(EditTextBoldCursor, 'getClass') else EditTextBoldCursor
                    class EditTextBoldCursorCtorHook(MethodHook):
                        _plugin_ref = self
                        def after_hooked_method(self, param):
                            try:
                                v = param.thisObject
                                if v and hasattr(v, 'setTypeface') and self._plugin_ref._typeface is not None:
                                    v.setTypeface(self._plugin_ref._typeface)
                            except Exception:
                                pass
                    for ctor_sig in ([Context], [Context, AttributeSet]):
                        try:
                            ctor = EBCClass.getDeclaredConstructor(*ctor_sig)
                            self._hooks.append(self.hook_method(ctor, EditTextBoldCursorCtorHook()))
                        except Exception:
                            pass
            except Exception:
                pass

            try:
                if NumberTextView is not None:
                    NVClass = NumberTextView.getClass() if hasattr(NumberTextView, 'getClass') else NumberTextView
                    class NumberTextViewCtorHook(MethodHook):
                        _plugin_ref = self
                        def after_hooked_method(self, param):
                            try:
                                v = param.thisObject
                                if v and hasattr(v, 'setTypeface') and self._plugin_ref._typeface is not None:
                                    v.setTypeface(self._plugin_ref._typeface)
                            except Exception:
                                pass
                    for ctor_sig in ([Context], [Context, AttributeSet]):
                        try:
                            ctor = NVClass.getDeclaredConstructor(*ctor_sig)
                            self._hooks.append(self.hook_method(ctor, NumberTextViewCtorHook()))
                        except Exception:
                            pass
            except Exception:
                pass

            try:
                TFClass = Typeface.getClass() if hasattr(Typeface, "getClass") else Typeface
                class TypefaceStaticReplacement(MethodReplacement):
                    _plugin_ref = self
                    def replace_hooked_method(self, param):
                        return self._plugin_ref._typeface
                try:
                    m = TFClass.getDeclaredMethod("create", TFClass, Integer.TYPE)
                    self._hooks.append(self.hook_method(m, TypefaceStaticReplacement()))
                except Exception:
                    pass
                try:
                    jString = jclass("java.lang.String")
                    m = TFClass.getDeclaredMethod("create", jString, Integer.TYPE)
                    self._hooks.append(self.hook_method(m, TypefaceStaticReplacement()))
                except Exception:
                    pass
                try:
                    m = TFClass.getDeclaredMethod("defaultFromStyle", Integer.TYPE)
                    self._hooks.append(self.hook_method(m, TypefaceStaticReplacement()))
                except Exception:
                    pass
            except Exception:
                pass

            tp_ctor_count = 0
            try:
                TPClass = TextPaint.getClass() if hasattr(TextPaint, "getClass") else TextPaint
                class TextPaintCtorHook(MethodHook):
                    _plugin_ref = self
                    def after_hooked_method(self, param):
                        try:
                            tp = param.thisObject
                            if tp is not None and self._plugin_ref._typeface is not None:
                                tp.setTypeface(self._plugin_ref._typeface)
                        except Exception:
                            pass
                for ctor_sig in ([Integer.TYPE], []):
                    try:
                        ctor = TPClass.getDeclaredConstructor(*ctor_sig)
                        self._hooks.append(self.hook_method(ctor, TextPaintCtorHook()))
                        tp_ctor_count += 1
                    except Exception:
                        pass
            except Exception:
                pass
            if tp_ctor_count > 0:
                log(f"[SFGlobalFont] âœ“ Hooked TextPaint constructors ({tp_ctor_count})")
            else:
                log("[SFGlobalFont] âœ— Failed to hook TextPaint constructors")

            p_ctor_count = 0
            try:
                PClass = Paint.getClass() if hasattr(Paint, "getClass") else Paint
                class PaintCtorHook(MethodHook):
                    _plugin_ref = self
                    def after_hooked_method(self, param):
                        try:
                            p = param.thisObject
                            if p is not None and self._plugin_ref._typeface is not None:
                                p.setTypeface(self._plugin_ref._typeface)
                        except Exception:
                            pass
                for ctor_sig in ([Integer.TYPE], []):
                    try:
                        ctor = PClass.getDeclaredConstructor(*ctor_sig)
                        self._hooks.append(self.hook_method(ctor, PaintCtorHook()))
                        p_ctor_count += 1
                    except Exception:
                        pass
            except Exception:
                pass
            if p_ctor_count > 0:
                log(f"[SFGlobalFont] âœ“ Hooked Paint constructors ({p_ctor_count})")
            else:
                log("[SFGlobalFont] âœ— Failed to hook Paint constructors")

            total_hooks = len(self._hooks)
            log(f"[SFGlobalFont] âœ“ Total hooks applied: {total_hooks}")

        except Exception:
            log(f"[SFGlobalFont] Error applying hooks: {traceback.format_exc()}")

    def _open_google_fonts_store(self):
        try:
            import requests as _rq
        except Exception:
            BulletinHelper.show_error(t("requests_missing"))
            return

        def build_loading_overlay():
            try:
                fragment = get_last_fragment()
                activity = fragment.getParentActivity() if fragment else None
                if not activity:
                    return
                FrameLayoutClass = find_class("android.widget.FrameLayout")
                ThemeClass = find_class("org.telegram.ui.ActionBar.Theme")
                ProgressBarClass = find_class("android.widget.ProgressBar")
                overlay = FrameLayoutClass(activity)
                overlay.setClickable(True)
                overlay.setBackgroundColor(ThemeClass.getColor(ThemeClass.key_windowBackgroundWhite))
                params_full = jclass("android.widget.FrameLayout$LayoutParams")(-1, -1)
                activity.getWindow().getDecorView().addView(overlay, params_full)
                pb = ProgressBarClass(activity)
                lp = jclass("android.widget.FrameLayout$LayoutParams")(-2, -2)
                try:
                    GravityClass = find_class("android.view.Gravity")
                    setattr(lp, "gravity", GravityClass.CENTER)
                except Exception:
                    pass
                overlay.addView(pb, lp)
                self._store_overlay = overlay
            except Exception:
                pass

        run_on_ui_thread(build_loading_overlay)

        def fetch_and_show():
            items = []
            try:
                api_key = "AIzaSyBZBi89KDR77uodfz4y14M69ZOI9vQwn3E"
                url = f"https://www.googleapis.com/webfonts/v1/webfonts?key={api_key}&sort=popularity"
                resp = _rq.get(url, timeout=10)
                if resp.status_code == 200:
                    data = resp.json()
                    items = data.get("items", []) if isinstance(data, dict) else []
                    try:
                        self._save_fonts_cache(items)
                    except Exception:
                        pass
            except Exception:
                pass
            run_on_ui_thread(lambda: self._show_fonts_store_overlay(items))

        threading.Thread(target=fetch_and_show, daemon=True).start()

        try:
            cached = self._load_fonts_cache()
            if isinstance(cached, list) and cached:
                run_on_ui_thread(lambda: self._show_fonts_store_overlay(cached))
        except Exception:
            pass

    def _remove_store_overlay(self):
        try:
            if self._store_overlay is not None:
                parent = self._store_overlay.getParent()
                if parent is not None:
                    parent.removeView(self._store_overlay)
            self._store_overlay = None
        except Exception:
            self._store_overlay = None

    def _show_fonts_store_overlay(self, items):
        try:
            fragment = get_last_fragment()
            activity = fragment.getParentActivity() if fragment else None
            if not activity:
                return

            FrameLayoutClass = find_class("android.widget.FrameLayout")
            LinearLayoutClass = find_class("android.widget.LinearLayout")
            ScrollViewClass = find_class("android.widget.ScrollView")
            ThemeClass = find_class("org.telegram.ui.ActionBar.Theme")
            AndroidUtilitiesClass = find_class("org.telegram.messenger.AndroidUtilities")

            overlay = self._store_overlay or FrameLayoutClass(activity)
            overlay.removeAllViews()
            overlay.setClickable(True)
            overlay.setBackgroundColor(ThemeClass.getColor(ThemeClass.key_windowBackgroundWhite))

            pad = AndroidUtilitiesClass.dp(12)
            root = LinearLayoutClass(activity)
            root.setOrientation(LinearLayoutClass.VERTICAL)
            root.setPadding(pad, pad, pad, pad)
            overlay.addView(root, jclass("android.widget.FrameLayout$LayoutParams")(-1, -1))

            header = LinearLayoutClass(activity)
            header.setOrientation(LinearLayoutClass.HORIZONTAL)
            title = TextView(activity)
            title.setText(t("font_store_title"))
            try:
                ColorClass = find_class("android.graphics.Color")
                title.setTextColor(ColorClass.BLACK)
            except Exception:
                title.setTextColor(ThemeClass.getColor(ThemeClass.key_dialogTextBlack))
            title.setTextSize(20)
            header.addView(title, jclass("android.widget.LinearLayout$LayoutParams")(0, -2, 1.0))
            close = TextView(activity)
            close.setText("âœ•")
            close.setTextSize(18)
            try:
                close.setTextColor(ColorClass.BLACK)
            except Exception:
                pass
            close.setPadding(pad, 0, pad, 0)
            close.setOnClickListener(OnClickListener(lambda: self._remove_store_overlay()))
            header.addView(close, jclass("android.widget.LinearLayout$LayoutParams")(-2, -2))
            root.addView(header, jclass("android.widget.LinearLayout$LayoutParams")(-1, -2))
            try:
                HSV = find_class("android.widget.HorizontalScrollView")
                chipsScroll = HSV(activity)
                chipsScroll.setHorizontalScrollBarEnabled(False)
                chipsRow = LinearLayoutClass(activity)
                chipsRow.setOrientation(LinearLayoutClass.HORIZONTAL)
                chipsScroll.addView(chipsRow, jclass("android.widget.LinearLayout$LayoutParams")(-2, -2))

                def add_chip(label, value):
                    chip = TextView(activity)
                    chip.setText(label)
                    chip.setTextSize(13)
                    chip.setPadding(pad, pad//2, pad, pad//2)
                    chip_lp = jclass("android.widget.LinearLayout$LayoutParams")(-2, -2)
                    chip_lp.setMargins(0, pad//2, pad//2, pad//2)
                    try:
                        gd = find_class("android.graphics.drawable.GradientDrawable")()
                        gd.setCornerRadius(AndroidUtilitiesClass.dp(12))
                        ColorClass = find_class("android.graphics.Color")
                        gd.setColor(ColorClass.rgb(240, 240, 240))
                        gd.setStroke(AndroidUtilitiesClass.dp(1), ThemeClass.getColor(ThemeClass.key_divider))
                        chip.setBackground(gd)
                        chip.setTextColor(ColorClass.BLACK)
                    except Exception:
                        pass
                    chip.setOnClickListener(OnClickListener(lambda v=None, val=value: (setattr(self, '_store_category', val), self._filter_fonts_store(self._store_search_query))))
                    chipsRow.addView(chip, chip_lp)

                add_chip("Ð’ÑÐµ", "")
                add_chip("Sans", "sans-serif")
                add_chip("Serif", "serif")
                add_chip("Mono", "monospace")
                add_chip("Display", "display")
                add_chip("Handwriting", "handwriting")

                root.addView(chipsScroll, jclass("android.widget.LinearLayout$LayoutParams")(-1, -2))
            except Exception:
                pass
            search = jclass("org.telegram.ui.Components.EditTextBoldCursor")(activity)
            search.setHint(t("font_store_search_hint"))
            search.setTextColor(ThemeClass.getColor(ThemeClass.key_windowBackgroundWhiteBlackText))
            search.setHintTextColor(ThemeClass.getColor(ThemeClass.key_dialogTextHint))
            root.addView(search, jclass("android.widget.LinearLayout$LayoutParams")(-1, -2))
            try:
                TextWatcherClass = find_class("android.text.TextWatcher")
                plugin_ref = self
                class _Watcher(dynamic_proxy(TextWatcherClass)):
                    def afterTextChanged(self, s):
                        try:
                            q = str(s.toString())
                            plugin_ref._store_search_query = q
                            seq = getattr(plugin_ref, '_store_search_seq', 0) + 1
                            plugin_ref._store_search_seq = seq
                            def delayed():
                                import time as _t
                                _t.sleep(0.18)
                                if getattr(plugin_ref, '_store_search_seq', 0) == seq:
                                    run_on_ui_thread(lambda: plugin_ref._filter_fonts_store(q))
                            threading.Thread(target=delayed, daemon=True).start()
                        except Exception:
                            pass
                    def beforeTextChanged(self, s, start, count, after):
                        return None
                    def onTextChanged(self, s, start, before, count):
                        return None
                search.addTextChangedListener(_Watcher())
            except Exception:
                pass

            scroll = ScrollViewClass(activity)
            grid_container = LinearLayoutClass(activity)
            grid_container.setOrientation(LinearLayoutClass.VERTICAL)
            scroll.addView(grid_container, jclass("android.widget.LinearLayout$LayoutParams")(-1, -1))
            root.addView(scroll, jclass("android.widget.LinearLayout$LayoutParams")(-1, -1))

            self._store_grid_container = grid_container
            self._store_items = items or []
            self._store_filtered_items = list(self._store_items)

            self._store_loaded_index = 0
            self._append_next_batch(activity, ThemeClass, AndroidUtilitiesClass, FrameLayoutClass, LinearLayoutClass, 16)

            try:
                OnScrollChangeListener = find_class("android.view.View$OnScrollChangeListener")
                plugin_ref = self
                class _SCL(dynamic_proxy(OnScrollChangeListener)):
                    def onScrollChange(self, v, scrollX, scrollY, oldScrollX, oldScrollY):
                        try:
                            child = scroll.getChildAt(0)
                            if child is not None:
                                bottom = scroll.getScrollY() + scroll.getHeight()
                                maxY = child.getHeight()
                                if bottom >= maxY - AndroidUtilitiesClass.dp(4):
                                    if not plugin_ref._store_is_loading:
                                        run_on_ui_thread(lambda: plugin_ref._append_next_batch(activity, ThemeClass, AndroidUtilitiesClass, FrameLayoutClass, LinearLayoutClass, 16))
                        except Exception:
                            pass
                scroll.setOnScrollChangeListener(_SCL())
            except Exception:
                pass

            if self._store_overlay is None:
                activity.getWindow().getDecorView().addView(overlay, jclass("android.widget.FrameLayout$LayoutParams")(-1, -1))
                self._store_overlay = overlay
        except Exception:
            BulletinHelper.show_error("UI error")

    def _render_fonts_grid(self, activity, ThemeClass, AndroidUtilitiesClass, FrameLayoutClass, LinearLayoutClass, items):
        try:
            if not self._store_grid_container:
                return
            pad = AndroidUtilitiesClass.dp(12)
            sample_text = "ÐŸÑ€Ð¸Ð²ÐµÑ‚, Ð¼Ð¸Ñ€! 12345 ÐÐ‘Ð’Ð“Ð” Ð°Ð±Ð²Ð³Ð´"
            i = 0
            while i < len(items):
                row = LinearLayoutClass(activity)
                row.setOrientation(LinearLayoutClass.HORIZONTAL)
                try:
                    row.setAlpha(0.0)
                except Exception:
                    pass
                for c in range(2):
                    idx = i + c
                    card = FrameLayoutClass(activity)
                    lp = jclass("android.widget.LinearLayout$LayoutParams")(0, -2, 1.0)
                    if c == 0:
                        lp.setMargins(0, pad//2, pad//2, pad//2)
                    else:
                        lp.setMargins(pad//2, pad//2, 0, pad//2)
                    if idx < len(items):
                        it = items[idx]
                        fam = it.get("family", "?")
                        variants = it.get("variants", [])
                        files = it.get("files", {})
                        author = it.get("category", "Unknown")

                        card_bg = LinearLayoutClass(activity)
                        card_bg.setOrientation(LinearLayoutClass.VERTICAL)
                        card_bg.setPadding(pad, pad, pad, pad)
                        card.addView(card_bg, jclass("android.widget.FrameLayout$LayoutParams")(-1, -2))
                        try:
                            GradientDrawable = find_class("android.graphics.drawable.GradientDrawable")
                            ColorClass = find_class("android.graphics.Color")
                            gd = GradientDrawable()
                            gd.setColor(ColorClass.rgb(245, 245, 245))
                            gd.setCornerRadius(AndroidUtilitiesClass.dp(10))
                            gd.setStroke(AndroidUtilitiesClass.dp(2), ThemeClass.getColor(ThemeClass.key_divider))
                            card.setBackground(gd)
                        except Exception:
                            pass

                        name_tv = TextView(activity)
                        name_tv.setText(fam)
                        name_tv.setTextSize(16)
                        try:
                            ColorClass = find_class("android.graphics.Color")
                            name_tv.setTextColor(ColorClass.BLACK)
                        except Exception:
                            name_tv.setTextColor(ThemeClass.getColor(ThemeClass.key_dialogTextBlack))
                        card_bg.addView(name_tv, jclass("android.widget.LinearLayout$LayoutParams")(-1, -2))

                        meta_tv = TextView(activity)
                        meta_tv.setText(f"Ð’Ð°Ñ€Ð¸Ð°Ñ†Ð¸Ð¹: {len(variants)} â€¢ ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ñ: {author}")
                        meta_tv.setTextSize(12)
                        meta_tv.setTextColor(ThemeClass.getColor(ThemeClass.key_dialogTextHint))
                        card_bg.addView(meta_tv, jclass("android.widget.LinearLayout$LayoutParams")(-1, -2))

                        preview_tv = TextView(activity)
                        preview_tv.setText(sample_text)
                        preview_tv.setTextSize(14)
                        try:
                            ColorClass = find_class("android.graphics.Color")
                            preview_tv.setTextColor(ColorClass.BLACK)
                        except Exception:
                            preview_tv.setTextColor(ThemeClass.getColor(ThemeClass.key_dialogTextBlack))
                        try:
                            if self.plugin._typeface is not None:
                                preview_tv.setTypeface(self.plugin._typeface)
                        except Exception:
                            pass
                        card_bg.addView(preview_tv, jclass("android.widget.LinearLayout$LayoutParams")(-1, -2))
                        preview_url = None
                        try:
                            if isinstance(files, dict):
                                url_reg = files.get("regular")
                                if isinstance(url_reg, str) and (url_reg.endswith('.ttf') or url_reg.endswith('.otf')):
                                    preview_url = url_reg
                                else:
                                    for (_v, u) in files.items():
                                        if isinstance(u, str) and (u.endswith('.ttf') or u.endswith('.otf')):
                                            preview_url = u
                                            break
                        except Exception:
                            preview_url = None
                        if preview_url and (preview_url.startswith("http://") or preview_url.startswith("https://")):
                            def load_preview(url=preview_url, tv=preview_tv, family=fam):
                                try:
                                    import requests as _rq2
                                    resp = _rq2.get(url, timeout=6, stream=True)
                                    if resp.status_code == 200:
                                        preview_path = os.path.join(os.path.dirname(self._get_persistent_font_path()), f"preview_{family}.ttf")
                                        with open(preview_path, "wb") as f:
                                            for chunk in resp.iter_content(8192):
                                                if chunk:
                                                    f.write(chunk)
                                        def apply_tp():
                                            try:
                                                tp = Typeface.createFromFile(preview_path)
                                                if tp:
                                                    tv.setTypeface(tp)
                                            except Exception:
                                                pass
                                        run_on_ui_thread(apply_tp)
                                except Exception:
                                    pass
                            threading.Thread(target=load_preview, daemon=True).start()

                        def on_click_card(view=None, urls=files):
                            target_url = urls.get("regular")
                            if not (isinstance(target_url, str) and (target_url.startswith("http://") or target_url.startswith("https://"))):
                                target_url = None
                                for v, u in urls.items():
                                    if isinstance(u, str) and (u.endswith('.ttf') or u.endswith('.otf')):
                                        target_url = u
                                        break
                            if target_url:
                                self.set_setting("custom_url", target_url)
                                self.set_setting("font_source", 1)
                                self._on_font_settings_changed()
                                self._remove_store_overlay()

                        card.setOnClickListener(OnClickListener(on_click_card))
                    row.addView(card, lp)
                self._store_grid_container.addView(row, jclass("android.widget.LinearLayout$LayoutParams")(-1, -2))
                try:
                    row.animate().alpha(1.0).setDuration(220)
                except Exception:
                    pass
                i += 2
        except Exception:
            pass

    def _filter_fonts_store(self, query):
        try:
            q = (query or "").strip().lower()
            def _worker():
                try:
                    if not q:
                        filtered = list(self._store_items)
                    else:
                        filtered = [it for it in self._store_items if q in (it.get("family", "").lower())]
                    def _apply():
                        try:
                            self._store_filtered_items = filtered
                            if self._store_grid_container:
                                self._store_grid_container.removeAllViews()
                                fragment = get_last_fragment()
                                activity = fragment.getParentActivity() if fragment else None
                                if activity:
                                    ThemeClass = find_class("org.telegram.ui.ActionBar.Theme")
                                    AndroidUtilitiesClass = find_class("org.telegram.messenger.AndroidUtilities")
                                    FrameLayoutClass = find_class("android.widget.FrameLayout")
                                    LinearLayoutClass = find_class("android.widget.LinearLayout")
                                    self._store_loaded_index = 0
                                    self._append_next_batch(activity, ThemeClass, AndroidUtilitiesClass, FrameLayoutClass, LinearLayoutClass, 16)
                        except Exception:
                            pass
                    run_on_ui_thread(_apply)
                except Exception:
                    pass
            threading.Thread(target=_worker, daemon=True).start()
        except Exception:
            pass

    def _get_cache_file(self) -> str:
        try:
            base_dir = os.path.dirname(self._get_persistent_font_path())
            return os.path.join(base_dir, 'webfonts_cache.json')
        except Exception:
            return os.path.join(os.getcwd(), 'webfonts_cache.json')

    def _load_fonts_cache(self):
        try:
            path = self._get_cache_file()
            if not os.path.exists(path):
                return None
            stat = os.stat(path)
            age = int(time.time()) - int(stat.st_mtime)
            if age > 3600:
                return None
            with open(path, 'r', encoding='utf-8') as f:
                data = json.load(f)
                return data if isinstance(data, list) else None
        except Exception:
            return None

    def _save_fonts_cache(self, items):
        try:
            path = self._get_cache_file()
            with open(path, 'w', encoding='utf-8') as f:
                json.dump(items, f)
        except Exception:
            pass

    def _append_next_batch(self, activity, ThemeClass, AndroidUtilitiesClass, FrameLayoutClass, LinearLayoutClass, count):
        try:
            if not self._store_filtered_items or self._store_is_loading:
                return
            now = time.time() if 'time' in globals() else 0.0
            if (now - getattr(self, '_store_last_append_time', 0.0)) < 0.2:
                return
            self._store_is_loading = True
            start = self._store_loaded_index
            end = min(start + count, len(self._store_filtered_items))
            if end <= start:
                self._store_is_loading = False
                return
            batch = self._store_filtered_items[start:end]
            self._render_fonts_grid(activity, ThemeClass, AndroidUtilitiesClass, FrameLayoutClass, LinearLayoutClass, batch)
            self._store_loaded_index = end
            self._store_last_append_time = time.time() if 'time' in globals() else 0.0
        except Exception:
            pass
        finally:
            self._store_is_loading = False

    def _pick_gfont_variant(self, item):
        try:
            files = item.get("files", {}) if isinstance(item, dict) else {}
            candidates = [(variant, url) for variant, url in files.items() if isinstance(url, str) and (url.endswith('.ttf') or url.endswith('.otf'))]
            if not candidates:
                BulletinHelper.show_info(t("gfonts_only_ttf"))
                return

            def show_variant_picker():
                try:
                    fragment = get_last_fragment()
                    ctx = fragment.getParentActivity() if fragment else None
                    if not ctx: return
                    builder = AlertDialogBuilder(ctx)
                    builder.set_title(t("gfonts_pick_variant"))
                    items = [v for (v, _) in candidates]

                    def on_variant(bld, index):
                        try:
                            _, url = candidates[index]
                            self.set_setting("custom_url", url)
                            self.set_setting("font_source", 1)
                            self._on_font_settings_changed()
                            bld.dismiss()
                        except Exception:
                            bld.dismiss()

                    builder.set_items(items, on_variant)
                    builder.set_negative_button("OK", lambda d, w: d.dismiss())
                    builder.show()
                except Exception: pass

            run_on_ui_thread(show_variant_picker)
        except Exception:
            BulletinHelper.show_error("Variant pick error")
