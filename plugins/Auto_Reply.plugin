__id__ = "Auto_Reply"
__name__ = "AutoReply"
__author__ = "@MorePlugins"
__version__ = "1.0.0"
__description__ = """–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∫–∞–∂–¥–æ–µ –≤—Ö–æ–¥—è—â–µ–µ –ª–∏—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∫–æ–≥–¥–∞ –≤—ã –Ω–µ –≤ —Å–µ—Ç–∏. –í—ã –º–æ–∂–µ—Ç–µ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç–≤–µ—Ç—ã –±–µ–∑ –∑–∞–¥–µ—Ä–∂–∫–∏."""

__icon__ = "TextAnimated/2"
__min_version__ = "11.12.0"

from typing import Any
from collections import deque
from base_plugin import BasePlugin, HookResult
from client_utils import send_message, get_messages_controller, run_on_queue, get_last_fragment
from android_utils import log, run_on_ui_thread
from org.telegram.messenger import MessageObject, LocaleController
from ui.settings import Header, Input, Switch, Text, Divider
from ui.bulletin import BulletinHelper
from ui.alert import AlertDialogBuilder

def _tr():
    pi_lang = LocaleController.getInstance().getCurrentLocale().getLanguage()
    
    strings = {
        'ru': {
            'settings_header': "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç—á–∏–∫–∞",
            'enable_autoresponder': "–í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç—á–∏–∫",
            'enable_autoresponder_sub': "–ö–æ–≥–¥–∞ –≤–∫–ª—é—á–µ–Ω–æ, –ø–ª–∞–≥–∏–Ω –±—É–¥–µ—Ç –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –∫–∞–∂–¥–æ–µ –≤—Ö–æ–¥—è—â–µ–µ –ª–∏—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.",
            'auto_reply_message': "–¢–µ–∫—Å—Ç –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç–∞",
            'auto_reply_message_sub': "–≠—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –∫–∞—á–µ—Å—Ç–≤–µ –æ—Ç–≤–µ—Ç–∞.",
            'plugin_loaded': "–ê–≤—Ç–æ–æ—Ç–≤–µ—Ç—á–∏–∫: –ü–ª–∞–≥–∏–Ω –∑–∞–≥—Ä—É–∂–µ–Ω –∏ –∞–∫—Ç–∏–≤–µ–Ω.",
            'plugin_unloaded': "–ê–≤—Ç–æ–æ—Ç–≤–µ—Ç—á–∏–∫: –ü–ª–∞–≥–∏–Ω –≤—ã–≥—Ä—É–∂–µ–Ω.",
            'error_hook': "–ê–≤—Ç–æ–æ—Ç–≤–µ—Ç—á–∏–∫: –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –≤ on_update_hook: {error}",
            'error_send': "–ê–≤—Ç–æ–æ—Ç–≤–µ—Ç—á–∏–∫: –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è peer {peer_id}: {error}",
            'bot_skipped': "–ê–≤—Ç–æ–æ—Ç–≤–µ—Ç—á–∏–∫: –ü—Ä–æ–ø—É—Å–∫–∞—é —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –±–æ—Ç–∞ (ID: {peer_id}).",
            'reply_sent': "–ê–≤—Ç–æ–æ—Ç–≤–µ—Ç—á–∏–∫: –û—Ç–ø—Ä–∞–≤–ª–µ–Ω –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {peer_id}.",
            'msg_sent_success': "–ê–≤—Ç–æ–æ—Ç–≤–µ—Ç—á–∏–∫: –°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –¥–ª—è peer {peer_id}.",
            'error_main_bulletin': "–û—à–∏–±–∫–∞ –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç—á–∏–∫–∞: {error}",
            'enabled_bulletin': "–ê–≤—Ç–æ–æ—Ç–≤–µ—Ç—á–∏–∫ –≤–∫–ª—é—á–µ–Ω.",
            'disabled_bulletin': "–ê–≤—Ç–æ–æ—Ç–≤–µ—Ç—á–∏–∫ –≤—ã–∫–ª—é—á–µ–Ω.",
            'info_button_text': "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–ª–∞–≥–∏–Ω–µ",
            'info_dialog_title': "–û –ø–ª–∞–≥–∏–Ω–µ",
            'info_dialog_message': "–ê–≤—Ç–æ–æ—Ç–≤–µ—Ç—á–∏–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ –ª–∏—á–Ω—ã—Ö —á–∞—Ç–∞—Ö –∏ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –±–æ—Ç–∞–º. –°–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –≥—Ä—É–ø–ø –∏ –∫–∞–Ω–∞–ª–æ–≤ –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è.",
            'info_dialog_ok': "OK",
            'default_reply': "üëã –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –í –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç —è –Ω–µ –º–æ–≥—É –æ—Ç–≤–µ—Ç–∏—Ç—å, –Ω–æ —è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–≤—è–∂—É—Å—å —Å –≤–∞–º–∏, –∫–∞–∫ —Ç–æ–ª—å–∫–æ –æ—Å–≤–æ–±–æ–∂—É—Å—å. –°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!",
            'plugin_info_header': "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–ª–∞–≥–∏–Ω–µ"
        },
        'en': {
            'settings_header': "Autoresponder Settings",
            'enable_autoresponder': "Enable Autoresponder",
            'enable_autoresponder_sub': "When enabled, the plugin will reply to every incoming private message.",
            'auto_reply_message': "Auto-reply Text",
            'auto_reply_message_sub': "This message will be automatically sent as a reply.",
            'plugin_loaded': "Autoresponder: Plugin loaded and active.",
            'plugin_unloaded': "Autoresponder: Plugin unloaded.",
            'error_hook': "Autoresponder: An error occurred in on_update_hook: {error}",
            'error_send': "Autoresponder: Failed to send message for peer {peer_id}: {error}",
            'bot_skipped': "Autoresponder: Skipping message from bot (ID: {peer_id}).",
            'reply_sent': "Autoresponder: Auto-reply sent to user {peer_id}.",
            'msg_sent_success': "Autoresponder: Message successfully sent for peer {peer_id}.",
            'error_main_bulletin': "Autoresponder Error: {error}",
            'enabled_bulletin': "Autoresponder enabled.",
            'disabled_bulletin': "Autoresponder disabled.",
            'info_button_text': "About Plugin",
            'info_dialog_title': "About",
            'info_dialog_message': "Autoresponder works only in private chats and does not reply to bots. Messages from groups and channels are ignored.",
            'info_dialog_ok': "OK",
            'default_reply': "üëã Hello! I'm currently unavailable to reply, but I'll get back to you as soon as I can. Thank you for your message!",
            'plugin_info_header': "Plugin Information"
        }
    }
    return strings.get(pi_lang, strings['en'])

class AutoReplyPlugin(BasePlugin):
    def __init__(self):
        super().__init__()
        self.processed_message_ids = deque(maxlen=200)

    def on_plugin_load(self):
        self.add_hook("TL_updateNewMessage")
        self.log(_tr()['plugin_loaded'])

    def on_plugin_unload(self):
        self.processed_message_ids.clear()
        self.log(_tr()['plugin_unloaded'])
        
    def _show_info_dialog(self, view=None):
        def action():
            s = _tr()
            fragment = get_last_fragment()
            if not fragment or not fragment.getParentActivity():
                return
            
            activity = fragment.getParentActivity()
            builder = AlertDialogBuilder(activity)
            builder.set_title(s['info_dialog_title'])
            builder.set_message(s['info_dialog_message'])
            builder.set_positive_button(s['info_dialog_ok'], lambda b, w: b.dismiss())
            builder.show()
            
        run_on_ui_thread(action)

    def create_settings(self):
        s = _tr()

        def on_switch_change(pi_is_enabled: bool):
            if pi_is_enabled:
                BulletinHelper.show_success(s['enabled_bulletin'])
            else:
                BulletinHelper.show_info(s['disabled_bulletin'])

        return [
            Header(text=s['settings_header']),
            Switch(
                key="enable_autoresponder",
                text=s['enable_autoresponder'],
                default=False,
                icon="msg_check",
                subtext=s['enable_autoresponder_sub'],
                on_change=on_switch_change
            ),
            Input(
                key="auto_reply_message",
                text=s['auto_reply_message'],
                default=s['default_reply'],
                icon="msg_message2",
                subtext=s['auto_reply_message_sub']
            ),
            Divider(),
            Header(text=s['plugin_info_header']),
            Text(
                text=s['info_button_text'],
                icon="msg_info",
                accent=True,
                on_click=self._show_info_dialog
            ),
            Divider(text="–°–¥–µ–ª–∞–Ω–æ –≤ —Ç–µ–ª–µ–≥—Ä–∞–º –∫–∞–Ω–∞–ª–µ: @MorePlugins")
        ]
        
    def on_update_hook(self, update_name: str, account: int, update: Any) -> HookResult:
        s = _tr()
        if update_name == "TL_updateNewMessage":
            pi_is_enabled = self.get_setting("enable_autoresponder", False)
            if not pi_is_enabled:
                return HookResult()
            try:
                message_obj = MessageObject(account, update.message, False, True)

                if (not message_obj.isOut() and
                    message_obj.getDialogId() > 0 and
                    message_obj.getId() not in self.processed_message_ids):

                    peer_id = message_obj.getDialogId()
                    user = get_messages_controller().getUser(peer_id)
                    if user and user.bot:
                        self.log(s['bot_skipped'].format(peer_id=peer_id))
                        return HookResult()

                    self.processed_message_ids.append(message_obj.getId())
                    reply_text = self.get_setting("auto_reply_message", s['default_reply'])
                    run_on_queue(lambda: self._send_auto_reply(peer_id, reply_text, account))
                    self.log(s['reply_sent'].format(peer_id=peer_id))

            except Exception as e:
                self.log(s['error_hook'].format(error=str(e)))
                run_on_ui_thread(lambda: BulletinHelper.show_error(s['error_main_bulletin'].format(error=str(e))))

        return HookResult()
    
    def _send_auto_reply(self, peer_id: int, message_content: str, account: int):
        s = _tr()
        try:
            params = {
                "message": message_content,
                "peer": peer_id,
                "account": account
            }
            send_message(params)
            self.log(s['msg_sent_success'].format(peer_id=peer_id))
        except Exception as e:
            self.log(s['error_send'].format(peer_id=peer_id, error=str(e)))
            run_on_ui_thread(lambda: BulletinHelper.show_error(
                s['error_main_bulletin'].format(error=f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç –¥–ª—è {peer_id}.")
            ))
