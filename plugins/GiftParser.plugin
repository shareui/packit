from base_plugin import BasePlugin, HookResult, HookStrategy
from cactuslib import CactusUtils
import requests, time, socket
from ui.settings import Header, Input, Text, Switch

__id__ = "gift_parser"
__name__ = "Gift Parser"
__description__ = "ÐŸÑ€Ð¾Ð¿Ð¸ÑˆÐ¸ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ .gift Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸ Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½ÑƒÑŽ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ñ‚ÐµÐ»ÐµÐ³Ñ€Ð°Ð¼ Ð¿Ð¾Ð´Ð°Ñ€ÐºÐ°Ñ…."
__author__ = "@urlEncoder & @wv_dev"
__version__ = "1.1.0"
__icon__ = "SuicideCode/0"

PREMIUM_EMOJI_MAP = {
    "ðŸ’": "5192879906295397710",
    "ðŸ§¸": "5206502842478638898",
    "ðŸŽ": "5203996991054432397",
    "ðŸŒ¹": "5440911110838425969",
    "ðŸŽ‚": "5370999492914976897",
    "ðŸ’": "5190661263629243818",
    "ðŸš€": "5445284980978621387",
    "ðŸ¾": "5370900768796711127",
    "ðŸ†": "5409008750893734809",
    "ðŸ’": "5402100905883488232",
    "ðŸ’Ž": "5471952986970267163",
    "â­": "5463289097336405244",
    "ðŸ“¥": "5443127283898405358",
    "ðŸ“¶": "5980965624396910678"
}

SERVERS = {
    "1": "149.154.175.53",
    "2": "149.154.167.51",
    "3": "149.154.175.100",
    "4": "149.154.167.91",
    "5": "91.108.56.130"
}

class GiftParser(CactusUtils.Plugin):
    def on_plugin_load(self):
        self.add_on_send_message_hook()
    
    def create_settings(self):
        return [
            Header(text="ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸"),
            Input(
                key="bot_token",
                text="Bot Token",
                default="7126649166:AAFbs7hXJOXMLiTsyxRhbcnDWDxPT9SRN-U",
                subtext="Ð¢Ð¾ÐºÐµÐ½ Ð±Ð¾Ñ‚Ð° Ð´Ð»Ñ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ° Ð¿Ð¾Ð´Ð°Ñ€ÐºÐ¾Ð²",
                icon="msg_bot"
            ),
            Input(
                key="dc_number",
                text="DC [1-5]",
                default="2",
                subtext="ÐÐ¾Ð¼ÐµÑ€ DC",
                icon="msg_calendar2"
            ),
            Input(
                key="command",
                text="ÐšÐ¾Ð¼Ð°Ð½Ð´Ð°",
                default=".gift",
                subtext="ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð° Ð¿Ð»Ð°Ð³Ð¸Ð½Ð°",
                icon="msg_edit_solar"
            ),
            Switch(
                key="use_premium_emoji",
                text="Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð¿Ñ€ÐµÐ¼Ð¸ÑƒÐ¼ ÑÐ¼Ð¾Ð´Ð·Ð¸",
                default=False,
                icon="filled_giveaway_premium"
            )
        ]
    
    def get_gifts(self):
        try:
            bot_token = self.get_setting("bot_token")
            if not bot_token:
                return None, "Ð¢Ð¾ÐºÐµÐ½ Ð±Ð¾Ñ‚Ð° Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½, Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚Ðµ ÐµÐ³Ð¾ Ð² @BotFather Ð¸ ÑƒÐºÐ°Ð¶Ð¸Ñ‚Ðµ ÐµÐ³Ð¾ Ð² Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°Ñ… Ð¿Ð»Ð°Ð³Ð¸Ð½Ð° "
            
            response = requests.get(
                f"https://api.telegram.org/bot{bot_token}/getAvailableGifts",
                timeout=10
            )
            data = response.json()
            return data['result']['gifts'], None
            
        except Exception as e:
            return None, f"ÐžÑˆÐ¸Ð±ÐºÐ°: {str(e)}"
    
    def replace_with_premium(self, emoji):
        if not self.get_setting("use_premium_emoji", True):
            return emoji
        return f"![{emoji}]({PREMIUM_EMOJI_MAP.get(emoji, emoji)})"
    
    def ping_server(self, server_ip):
        try:
            start = time.time()
            with socket.create_connection((server_ip, 443), timeout=1):
                return round((time.time() - start) * 1000)
        except:
            return "N/A"
    
    def format_message(self, gifts):
        grouped = {}
        for gift in gifts:
            stars = gift['star_count']
            emoji = gift['sticker']['emoji']
            premium_emoji = self.replace_with_premium(emoji)
            grouped.setdefault(stars, []).append(premium_emoji)
        
        message = f"{self.replace_with_premium('ðŸ“¥')} *Available gifts:*\n"
        
        gift_lines = []
        for stars, emojis in sorted(grouped.items()):
            star_emoji = self.replace_with_premium("â­")
            gift_lines.append(f"{' '.join(emojis)} | *{stars}* [stars](tg://stars) {star_emoji}")
        
        message += "> " + "\n> ".join(gift_lines) + "\n\n"
        
        dc_number = self.get_setting("dc_number", "2")
        server_ip = SERVERS.get(dc_number, "149.154.167.51")
        ping = self.ping_server(server_ip)
        
        message += f"> {self.replace_with_premium('ðŸ“¶')} *Ping: {ping} ms*"
        message += f"\n>ðŸ“  *[Gift Parser](http://t.me/SuicideCode) {__version__}*"
        
        return message
    
    def on_send_message_hook(self, account, params):
        if not hasattr(params, 'message') or not isinstance(params.message, str):
            return HookResult()

        cmd = self.get_setting("command", ".gift").strip()
        if not params.message.strip().lower().startswith(cmd.lower()):
            return HookResult()

        gifts, error = self.get_gifts()
        if error:
            self.utils.send_message(peer=params.peer, text=error)
            return HookResult(strategy=HookStrategy.CANCEL)
        
        text = self.format_message(gifts)
        self.utils.send_message(
            peer=params.peer,
            text=text,
            parse_message=True,
            parse_mode="MARKDOWN"
        )
        return HookResult(strategy=HookStrategy.CANCEL)