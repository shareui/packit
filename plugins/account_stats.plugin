# -*- coding: @gemeguardian -*-

from base_plugin import BasePlugin, HookResult, HookStrategy
from client_utils import run_on_queue, send_message, get_last_fragment, send_request, RequestCallback
from android_utils import run_on_ui_thread
from markdown_utils import parse_markdown
from ui.bulletin import BulletinHelper
from ui.settings import Header, Switch, Divider
from java.util import ArrayList
from org.telegram.tgnet import TLRPC, TLObject

__id__ = "account_stats"
__name__ = "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–∞"
__description__ = "–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –≤—Å–µ–º —á–∞—Ç–∞–º –∞–∫–∫–∞—É–Ω—Ç–∞. –ö–æ–º–∞–Ω–¥–∞: .stats"
__version__ = "1.2"
__author__ = "@gemeguardian"
__icon__ = "sGemeGuardian/0"
__min_version__ = "11.12.0"

class AccountStatsPlugin(BasePlugin):
    """
    –ü–ª–∞–≥–∏–Ω –¥–ª—è exteraGram –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–¥—Å—á–µ—Ç–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –≤—Å–µ–º —á–∞—Ç–∞–º.
    """

    def __init__(self):
        super().__init__()
        self.stats_counters = {}
        self.processed_dialog_ids = set()
        self.archived_count = 0
        self.original_params = None
        self.deleted_users = 0
        self.deleted_bots = 0
        self.total_dialogs = 0
        self.pg_error_occurred = False
        self.blocked_processed = False
        self.dialogs_fetched_count = 0
        self.only_blocked = False

    def on_plugin_load(self):
        self.add_on_send_message_hook()

    def create_settings(self):
        """–°–æ–∑–¥–∞—ë—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—É–Ω–∫—Ç–æ–≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏."""
        settings = [
            Header("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è"),
            Switch(key="show_header", text="–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫", default=True, on_change=lambda v: self._on_setting_change("show_header", v)),
            Switch(key="show_total", text="–í—Å–µ–≥–æ —á–∞—Ç–æ–≤", default=True, on_change=lambda v: self._on_setting_change("show_total", v)),
            Switch(key="show_personal", text="–õ–∏—á–Ω—ã–µ —á–∞—Ç—ã", default=True, on_change=lambda v: self._on_setting_change("show_personal", v)),
            Switch(key="show_groups", text="–ì—Ä—É–ø–ø—ã", default=True, on_change=lambda v: self._on_setting_change("show_groups", v)),
            Switch(key="show_channels", text="–ö–∞–Ω–∞–ª—ã", default=True, on_change=lambda v: self._on_setting_change("show_channels", v)),
            Switch(key="show_deleted", text="–£–¥–∞–ª–µ–Ω–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã", default=True, on_change=lambda v: self._on_setting_change("show_deleted", v)),
            Switch(key="show_archived", text="–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∏–∞–ª–æ–≥–∏", default=True, on_change=lambda v: self._on_setting_change("show_archived", v)),
            Switch(key="show_blocked", text="–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ", default=True, on_change=lambda v: self._on_setting_change("show_blocked", v)),
            Switch(key="show_subcategories", text="–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–ª—é–¥–∏/–±–æ—Ç—ã)", default=True, on_change=lambda v: self._on_setting_change("show_subcategories", v)),
            Divider("–°–¥–µ–ª–∞–Ω–æ @gemeguardian")
        ]
        return settings

    def _on_setting_change(self, key: str, value: bool):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫."""
        self.set_setting(key, value)

    def _check_settings_valid(self):
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –≤—ã–±—Ä–∞–Ω –ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø—É–Ω–∫—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (–∏—Å–∫–ª—é—á–∞—è –∑–∞–≥–æ–ª–æ–≤–æ–∫)."""
        content_keys = ["show_total", "show_personal", "show_groups", "show_channels", "show_deleted", "show_archived", "show_blocked"]
        enabled_count = sum(1 for key in content_keys if self.get_setting(key, True))
        return enabled_count >= 1

    def _is_only_blocked_requested(self):
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∑–∞–ø—Ä–æ—à–µ–Ω–∞ –ª–∏ —Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)."""
        content_keys = ["show_total", "show_personal", "show_groups", "show_channels", "show_deleted", "show_archived", "show_blocked"]
        enabled_content = [key for key in content_keys if self.get_setting(key, True)]
        return len(enabled_content) == 1 and enabled_content[0] == "show_blocked"

    def on_send_message_hook(self, account: int, params: any) -> HookResult:
        if hasattr(params, 'message') and isinstance(params.message, str):
            if params.message.strip().lower() == ".stats":
                fragment = get_last_fragment()
                if fragment:
                    if not self._check_settings_valid():
                        run_on_ui_thread(lambda: BulletinHelper.show_error("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —á—Ç–æ —Å–æ–±–∏—Ä–∞—Ç—å –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø–ª–∞–≥–∏–Ω–∞", fragment))
                        return HookResult(strategy=HookStrategy.CANCEL)
                    run_on_ui_thread(lambda: BulletinHelper.show_info("–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...", fragment))
                    
                    # –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –µ—Å–ª–∏ —Ç–æ–ª—å–∫–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ, —Ç–æ —Å—Ä–∞–∑—É –∏—Ö –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º
                    self.only_blocked = self._is_only_blocked_requested()
                    self.original_params = params  # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º params –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ
                    if self.only_blocked:
                        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—á—ë—Ç—á–∏–∫–æ–≤ –¥–ª—è —Å–ª—É—á–∞—è only_blocked
                        self.stats_counters = {'u': 0, 'b': 0, 'c': 0, 'ch': 0}
                        self.deleted_users = 0
                        self.deleted_bots = 0
                        self.archived_count = 0
                        self.total_dialogs = 0
                        self.pg_error_occurred = False
                        self.blocked_processed = False
                        run_on_queue(lambda: self._fetch_blocked())
                    else:
                        run_on_queue(lambda: self._start_stats_calculation(params))
                else:
                    return HookResult(strategy=HookStrategy.CANCEL)
                return HookResult(strategy=HookStrategy.CANCEL)
        return HookResult()

    def _start_stats_calculation(self, params: any):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–æ–≤."""
        if self.pg_error_occurred:
            return  # –ù–µ –∑–∞–ø—É—Å–∫–∞—Ç—å, –µ—Å–ª–∏ —É–∂–µ –±—ã–ª–∞ –æ—à–∏–±–∫–∞
        self.stats_counters = {'u': 0, 'b': 0, 'c': 0, 'ch': 0}
        self.processed_dialog_ids = set()
        self.archived_count = 0
        self.deleted_users = 0
        self.deleted_bots = 0
        self.total_dialogs = 0
        self.dialogs_fetched_count = 0
        self.pg_error_occurred = False
        self.blocked_processed = False
        self.original_params = params
        
        self._fetch_dialog_batch(0, 0, TLRPC.TL_inputPeerEmpty())

    def _fetch_dialog_batch(self, offset_date: int, offset_id: int, offset_peer: TLRPC.InputPeer):
        """–°–æ–∑–¥–∞–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Ä—Ü–∏–∏ –¥–∏–∞–ª–æ–≥–æ–≤."""
        if self.pg_error_occurred:
            return
        try:
            req = TLRPC.TL_messages_getDialogs()
            req.flags = 0; req.offset_date = offset_date; req.offset_id = offset_id
            req.offset_peer = offset_peer; req.limit = 100; req.hash = 0
            
            callback = RequestCallback(self._on_dialogs_received)
            send_request(req, callback)
            self.dialogs_fetched_count += 1
        except Exception as e:
            self.pg_error_occurred = True
            self._handle_error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∏–∞–ª–æ–≥–æ–≤.")

    def _on_dialogs_received(self, response: TLObject, error: TLRPC.TL_error):
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ —Å–æ —Å–ø–∏—Å–∫–æ–º –¥–∏–∞–ª–æ–≥–æ–≤."""
        if self.pg_error_occurred:
            return
        if error:
            self.pg_error_occurred = True
            self._handle_error(f"API –û—à–∏–±–∫–∞: {error.text}")
            return

        try:
            local_user_map = {}; local_chat_map = {}; messages_map = {}

            if hasattr(response, 'users'):
                for i in range(response.users.size()):
                    user = response.users.get(i)
                    local_user_map[user.id] = user
            if hasattr(response, 'chats'):
                for i in range(response.chats.size()):
                    chat = response.chats.get(i)
                    local_chat_map[chat.id] = chat
            if hasattr(response, 'messages'):
                for i in range(response.messages.size()):
                    msg = response.messages.get(i)
                    messages_map[msg.id] = msg

            dialogs = response.dialogs
            if not dialogs or dialogs.isEmpty():
                self._finalize_dialogs_and_fetch_blocked()
                return

            dialogs_added_this_batch = 0
            for i in range(dialogs.size()):
                dialog = dialogs.get(i)
                dialog_id = dialog.peer.user_id or dialog.peer.chat_id or dialog.peer.channel_id
                
                if dialog_id in self.processed_dialog_ids:
                    continue
                self.processed_dialog_ids.add(dialog_id)
                self.total_dialogs += 1  # –ü–æ–¥—Å—á–µ—Ç –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
                dialogs_added_this_batch += 1

                # –ü–æ–¥—Å—á–µ—Ç –∞—Ä—Ö–∏–≤–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤
                if hasattr(dialog, 'folder_id') and dialog.folder_id == 1:
                    self.archived_count += 1

                if isinstance(dialog.peer, TLRPC.TL_peerUser):
                    user = local_user_map.get(dialog.peer.user_id)
                    if user:
                        if user.deleted:
                            if hasattr(user, 'bot') and user.bot:
                                self.deleted_bots += 1
                            else:
                                self.deleted_users += 1
                        else:
                            if hasattr(user, 'bot') and user.bot:
                                self.stats_counters['b'] += 1
                            else:
                                self.stats_counters['u'] += 1
                elif isinstance(dialog.peer, (TLRPC.TL_peerChat, TLRPC.TL_peerChannel)):
                    chat_id = dialog.peer.chat_id or dialog.peer.channel_id
                    chat = local_chat_map.get(chat_id)
                    if chat:
                        if isinstance(chat, TLRPC.TL_channel) and (hasattr(chat, 'megagroup') and chat.megagroup or hasattr(chat, 'gigagroup') and chat.gigagroup):
                            self.stats_counters['c'] += 1
                        elif isinstance(chat, TLRPC.TL_channel):
                             self.stats_counters['ch'] += 1
                        else:
                            self.stats_counters['c'] += 1

            is_slice = False
            try:
                is_slice = isinstance(response, TLRPC.TL_messages_dialogsSlice)
            except:
                # –§–æ–ª–ª–±—ç–∫ —á–µ—Ä–µ–∑ –∞—Ç—Ä–∏–±—É—Ç—ã
                is_slice = hasattr(response, 'count') and hasattr(response, 'users') and hasattr(response, 'chats')

            if is_slice:
                last_dialog = dialogs.get(dialogs.size() - 1)
                last_peer = last_dialog.peer
                top_message_id = last_dialog.top_message
                last_message = messages_map.get(top_message_id)

                if not last_message:
                    self._finalize_dialogs_and_fetch_blocked()
                    return

                next_offset_date = last_message.date
                next_offset_id = last_message.id
                
                next_offset_peer = TLRPC.TL_inputPeerEmpty()
                if isinstance(last_peer, TLRPC.TL_peerUser):
                    entity = local_user_map.get(last_peer.user_id)
                    if entity and hasattr(entity, 'access_hash'):
                        next_offset_peer = TLRPC.TL_inputPeerUser()
                        next_offset_peer.user_id = entity.id
                        next_offset_peer.access_hash = entity.access_hash
                    else:
                        self._finalize_dialogs_and_fetch_blocked()
                        return
                elif isinstance(last_peer, TLRPC.TL_peerChannel):
                    entity = local_chat_map.get(last_peer.channel_id)
                    if entity and hasattr(entity, 'access_hash'):
                        next_offset_peer = TLRPC.TL_inputPeerChannel()
                        next_offset_peer.channel_id = entity.id
                        next_offset_peer.access_hash = entity.access_hash
                    else:
                        self._finalize_dialogs_and_fetch_blocked()
                        return
                elif isinstance(last_peer, TLRPC.TL_peerChat):
                    next_offset_peer = TLRPC.TL_inputPeerChat()
                    next_offset_peer.chat_id = last_peer.chat_id
                else:
                    self._finalize_dialogs_and_fetch_blocked()
                    return

                if next_offset_peer != TLRPC.TL_inputPeerEmpty():
                    self._fetch_dialog_batch(next_offset_date, next_offset_id, next_offset_peer)
                else:
                    self._finalize_dialogs_and_fetch_blocked()
            else:
                self._finalize_dialogs_and_fetch_blocked()
        except Exception as e:
            self.pg_error_occurred = True
            self._handle_error("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤.")

    def _finalize_dialogs_and_fetch_blocked(self):
        """–ó–∞–≤–µ—Ä—à–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∏–∞–ª–æ–≥–æ–≤ –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö."""
        if self.pg_error_occurred:
            return
        self._fetch_blocked()

    def _fetch_blocked(self):
        """–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö."""
        if self.pg_error_occurred:
            return
        try:
            req = TLRPC.TL_contacts_getBlocked()
            req.offset = 0
            req.limit = 200  # –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            callback = RequestCallback(self._on_blocked_received)
            send_request(req, callback)
        except Exception as e:
            self.blocked_processed = True  # –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ —Å –æ—à–∏–±–∫–æ–π
            self.pg_error_occurred = True
            self._generate_stats_text(0, 0)  # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –±–µ–∑ blocked

    def _on_blocked_received(self, response: TLObject, error: TLRPC.TL_error):
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—Ç–≤–µ—Ç —Å–æ —Å–ø–∏—Å–∫–æ–º –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –∏—Ç–æ–≥–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ."""
        if self.blocked_processed or self.pg_error_occurred:
            return
        self.blocked_processed = True
        if error:
            blocked_users = 0
            blocked_bots = 0
        else:
            blocked_users = 0
            blocked_bots = 0
            try:
                # –£–ª—É—á—à–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –ø–æ –∞—Ç—Ä–∏–±—É—Ç–∞–º, –∞ –Ω–µ CONSTRUCTOR_ID
                # –î–ª—è TL_contacts_blocked –∏–ª–∏ TL_contacts_blockedSlice
                if hasattr(response, 'users') and response.users:
                    for i in range(response.users.size()):
                        user = response.users.get(i)
                        if hasattr(user, 'bot') and user.bot:
                            blocked_bots += 1
                        else:
                            blocked_users += 1
                if hasattr(response, 'chats') and response.chats:
                    for i in range(response.chats.size()):
                        chat = response.chats.get(i)
                        # –ß–∞—Ç—ã/–∫–∞–Ω–∞–ª—ã —Ä–µ–¥–∫–∏, –Ω–æ —Å—á–∏—Ç–∞–µ–º –∫–∞–∫ –±–æ—Ç–æ–≤
                        blocked_bots += 1
            except Exception as e:
                blocked_users = 0
                blocked_bots = 0

        self._generate_stats_text(blocked_users, blocked_bots)

    def _generate_stats_text(self, blocked_users: int, blocked_bots: int):
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫."""
        if self.pg_error_occurred:
            return
        blocked_total = blocked_users + blocked_bots
        show_subcats = self.get_setting("show_subcategories", True)

        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—á—ë—Ç—á–∏–∫–æ–≤ —Å –±–µ–∑–æ–ø–∞—Å–Ω—ã–º –¥–æ—Å—Ç—É–ø–æ–º (get —Å –¥–µ—Ñ–æ–ª—Ç–æ–º 0)
        u = self.stats_counters.get('u', 0)
        b = self.stats_counters.get('b', 0)
        c = self.stats_counters.get('c', 0)
        ch = self.stats_counters.get('ch', 0)
        deleted_total = getattr(self, 'deleted_users', 0) + getattr(self, 'deleted_bots', 0)
        archived = getattr(self, 'archived_count', 0)
        total = getattr(self, 'total_dialogs', 0)
        personal_live = u + b

        # –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ —Å—á—ë—Ç—á–∏–∫–∏
        if self.only_blocked:
            u = b = c = ch = deleted_total = archived = total = personal_live = 0

        lines = []
        if self.get_setting("show_header", True):
            lines.append("[üìä](5431577498364158238) *–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–∞*\n\n")

        if self.get_setting("show_total", True) and not self.only_blocked:
            lines.append(f"[üî¢](5884510167986343350) *–í—Å–µ–≥–æ —á–∞—Ç–æ–≤:* `{total}`\n\n")

        if self.get_setting("show_personal", True) and not self.only_blocked:
            if show_subcats:
                personal_line = f"[üë•](5258513401784573443) *–õ–∏—á–Ω—ã–µ —á–∞—Ç—ã:* `{personal_live}`\n"
                personal_line += f"‚Ä¢ [üë§](5258011929993026890) *–õ—é–¥–∏:* `{u}`\n‚Ä¢ [ü§ñ](5258093637450866522) *–ë–æ—Ç—ã:* `{b}`"
            else:
                personal_line = f"[üë•](5258513401784573443) *–õ–∏—á–Ω—ã–µ —á–∞—Ç—ã:* `{personal_live}`"
            lines.append(personal_line)
            lines.append("\n")

        # –ì—Ä—É–ø–ø—ã –∏ –∫–∞–Ω–∞–ª—ã –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Å—Ç—Ä–æ–∫–∞—Ö
        if self.get_setting("show_groups", True) and not self.only_blocked:
            lines.append(f"[üë•](5258513401784573443) *–ì—Ä—É–ø–ø—ã:* `{c}`")
            lines.append("\n")
        if self.get_setting("show_channels", True) and not self.only_blocked:
            lines.append(f"[‚û°Ô∏è](5260450573768990626) *–ö–∞–Ω–∞–ª—ã:* `{ch}`")
            lines.append("\n\n")

        lower_lines = []
        if self.get_setting("show_deleted", True) and not self.only_blocked:
            # –î–ª—è —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –≤—Å–µ–≥–¥–∞ —Ç–æ–ª—å–∫–æ –æ–±—â–∞—è —Ü–∏—Ñ—Ä–∞, –±–µ–∑ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π
            lower_lines.append(f"[üóëÔ∏è](5258430848218176413) *–£–¥–∞–ª–µ–Ω–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã:* `{deleted_total}`")
        if self.get_setting("show_archived", True) and not self.only_blocked:
            lower_lines.append(f"[üìÇ](5258389041006518073) *–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∏–∞–ª–æ–≥–∏:* `{archived}`")
        if self.get_setting("show_blocked", True):
            if show_subcats:
                blocked_line = f"[‚ùå](5260342697075416641) *–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ:* `{blocked_total}`\n"
                blocked_line += f"‚Ä¢ [üë§](5258011929993026890) *–õ—é–¥–∏:* `{blocked_users}`\n‚Ä¢ [ü§ñ](5258093637450866522) *–ë–æ—Ç—ã:* `{blocked_bots}`"
                lower_lines.append(blocked_line)
            else:
                lower_lines.append(f"[‚ùå](5260342697075416641) *–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ:* `{blocked_total}`")
        
        if lower_lines:
            lines.append("\n".join(lower_lines))

        result_text = "".join(lines).strip()
        if not result_text.endswith("\n"):
            result_text += "\n"

        self._send_result(self.original_params, result_text)

    def _handle_error(self, error_msg: str):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ —Å –æ—Ç–ø—Ä–∞–≤–∫–æ–π —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è."""
        self.pg_error_occurred = True
        fragment = get_last_fragment()
        if fragment:
            run_on_ui_thread(lambda: BulletinHelper.show_error(error_msg, fragment))
        # –ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –±–∞–∑–æ–≤—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É, –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
        if self.total_dialogs > 0 and self._check_settings_valid() and not self.only_blocked:
            if self.get_setting("show_header", True):
                basic_text = "[üìä](5431577498364158238) *–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (—á–∞—Å—Ç–∏—á–Ω–æ)*\n\n"
            else:
                basic_text = ""
            if self.get_setting("show_total", True):
                basic_text += f"[üî¢](5884510167986343350) –í—Å–µ–≥–æ —á–∞—Ç–æ–≤: `{self.total_dialogs}`\n\n"
            if self.get_setting("show_archived", True):
                basic_text += f"[üìÇ](5258389041006518073) –ê—Ä—Ö–∏–≤: `{self.archived_count}`"
            if basic_text.strip():
                self._send_result(self.original_params, basic_text)
    
    def _send_result(self, original_params: any, text: str):
        """–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞."""
        try:
            parsed = parse_markdown(text)
            send_params = { "peer": original_params.peer, "message": parsed.text, "entities": [entity.to_tlrpc_object() for entity in parsed.entities] }
            if hasattr(original_params, 'replyToMsg') and original_params.replyToMsg:
                send_params["replyToMsg"] = original_params.replyToMsg
            run_on_ui_thread(lambda: send_message(send_params))
        except Exception as e:
            import re
            plain_text = re.sub(r'\[(.*?)\]\(.*?\)', r'\1', text.replace("*", "").replace("`", ""))
            send_params = {"peer": original_params.peer, "message": plain_text}
            if hasattr(original_params, 'replyToMsg') and original_params.replyToMsg:
                send_params["replyToMsg"] = original_params.replyToMsg
            run_on_ui_thread(lambda: send_message(send_params))